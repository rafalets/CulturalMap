import{A as T,C as X,P as Y,T as I,s as S}from"./chunk-UNRRVLTB.js";import{a as D}from"./chunk-6DVIB4O4.js";import{b as P,d as v,g as G,i as w,na as E,o as z,s as C,tb as d,va as R,y as b}from"./chunk-JLMESEWM.js";import{d as y,e as x}from"./chunk-QGVBCWUY.js";var N=class{getOperatorType(){return 10204}supportsCurves(){return!0}accelerateGeometry(t,e,r){return!1}canAccelerateGeometry(t){return!1}executeMany(t,e,r,n){return new k(t,e,r,n)}execute(t,e,r,n){return t||z("null param is not allowed."),new k(null,e,r,n).generalize(t)}},k=class extends D{constructor(t,e,r,n){super(),this.m_pline=null,this.m_point=new S,this.m_stack=[],this.m_resultstack=[],this.m_callCount=0,this.m_progressTracker=n,this.m_geoms=t,this.m_maxDeviation=e,this.m_bRemoveDegenerateParts=r}tock(){return!0}getRank(){return 1}next(){let t=this.m_geoms.next();return t===null?null:(b(t),this.generalize(t))}getGeometryID(){return this.m_geoms.getGeometryID()}generalize(t){let e=t.getGeometryType();if(v(e))return t;if(e===P.enumEnvelope){let s=new X({vd:t.getDescription()});return s.addEnvelope(t,!1),this.generalize(s)}if(G(e)){let s=new T({vd:t.getDescription()});return s.addSegment(t,!0),this.generalize(s)}if(w(e)||C(""),t.isEmpty()||this.m_maxDeviation<=0)return t;let r=new I().execute(t,0,.05*this.m_maxDeviation,0,this.m_progressTracker);t.hasNonLinearSegments()&&(this.m_maxDeviation*=.95);let n=r,m=t.createInstance();m.getGeometryType()===P.enumPolygon&&m.setFillRule(t.getFillRule()),this.m_xy=n.getAttributeStreamRef(0);{let s={stack:[],error:void 0,hasError:!1};try{let l=new Y;this.m_pline=l,y(s,R(()=>{this.m_pline=null},!1),!1);for(let a=0,h=n.getPathCount();a<h;a++)this.generalizePath(n.getImpl(),a,m.getImpl())}catch(l){s.error=l,s.hasError=!0}finally{x(s)}}return this.m_resultstack.length=0,this.m_stack.length=0,m}generalizePath(t,e,r){if(t.getPathSize(e)<2)return;this.m_resultstack.length=0,this.m_stack.length=0;let n=t.getPathStart(e),m=t.getPathEnd(e)-1,s=t.isClosedPath(e),l=t.isClosedPathInXYPlane(e),a=0,h=-1;this.m_stack.push(s?n:m),this.m_stack.push(n);let o=!1,c=!1;for(!this.m_bRemoveDegenerateParts&&l&&(o=!0,c=!0);this.m_stack.length>1;){let i=this.m_stack.at(-1);this.m_stack.pop();let g=this.m_stack.at(-1),f=t.getXY(i);this.m_pline.setStartXY(f),f=t.getXY(g),this.m_pline.setEndXY(f);let p=[Number.NaN],u=this.findGreatestDistance(i,g,m,p);u>=0&&(o?o=!1:(c&&p[0]>a&&(a=p[0],h=u),p[0]<=this.m_maxDeviation&&(u=-1))),u>=0?(this.m_stack.push(u),this.m_stack.push(i)):this.m_resultstack.push(i)}s||this.m_resultstack.push(this.m_stack[0]);let _=this.m_resultstack.length;if(_===t.getPathSize(e)&&_===this.m_stack.length)r.addPath(t,e,!0);else if(this.m_resultstack.length>0){if(this.m_bRemoveDegenerateParts&&this.m_resultstack.length<=2&&(s||this.m_resultstack.length===1||d.distance(t.getXY(this.m_resultstack[0]),t.getXY(this.m_resultstack[1]))<=this.m_maxDeviation))return;if(c&&h>=0&&a<=this.m_maxDeviation){let i=this.m_resultstack.at(-1)>h;this.m_resultstack.push(h),i&&(this.m_resultstack[this.m_resultstack.length-2]=E(this.m_resultstack[this.m_resultstack.length-1],this.m_resultstack[this.m_resultstack.length-1]=this.m_resultstack[this.m_resultstack.length-2]))}for(let i=0,g=this.m_resultstack.length;i<g;i++)t.getPointByVal(this.m_resultstack[i],this.m_point),i===0?r.startPathPoint(this.m_point):r.lineToPoint(this.m_point);if(s){for(let i=this.m_resultstack.length;i<3;i++)r.lineToPoint(this.m_point);r.closePathWithLine()}}}findGreatestDistance(t,e,r,n){let m=e-1;e<=t&&(m=r);let s=-1,l=0,a=new d;for(let h=t+1;h<=m;h++){this.m_xy.queryPoint2D(2*h,a);let o=a.x,c=a.y,_=this.m_pline.getClosestCoordinate(a,!1);a.assign(this.m_pline.getCoord2D(_)),a.x-=o,a.y-=c;let i=a.length();i>l&&(s=h,l=i),this.m_callCount++}return n[0]=l,s}};export{N as a};
