import{a as y,b as A}from"./chunk-XAHD7XBV.js";import{b as J,c as N,d as T}from"./chunk-4AOOZ5SW.js";import{a as B,b as C,c as V,d as k}from"./chunk-D45JG62Z.js";import{c as U}from"./chunk-TBHSFWI7.js";import"./chunk-RWCIDBNQ.js";import"./chunk-EDAGF7R6.js";import"./chunk-6EWMYOA7.js";import"./chunk-3Q427ME6.js";import"./chunk-KDF3RZ2K.js";import"./chunk-AFSNSPOG.js";import"./chunk-SKMO433W.js";import"./chunk-2FO7ARYZ.js";import"./chunk-DJW5LMRG.js";import{e as R}from"./chunk-QMKRRCM3.js";import{a as O}from"./chunk-TCGGI7DC.js";import"./chunk-ALWV3RJ2.js";import"./chunk-7C6Z24SS.js";import{z as F}from"./chunk-5WKDXHVH.js";import"./chunk-PTZYZULI.js";import"./chunk-KZKWOEFD.js";import"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-OGS2SUK5.js";import"./chunk-WNSGKHQ6.js";import"./chunk-J5MXC6AL.js";import"./chunk-RJWOVI3M.js";import"./chunk-NHSDW26F.js";import{g as x}from"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import{a as g}from"./chunk-WMQNRNIU.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import"./chunk-C7INQGWT.js";import"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import"./chunk-QGVBCWUY.js";import"./chunk-HHDFN2GK.js";import{t as S,v as D}from"./chunk-47GHT6OF.js";import"./chunk-VTHXE323.js";function G(s,t,n,a){let{rendererJSON:c,isRGBRenderer:b}=s,r=null,i=null;if(t&&b)r=t;else if(t&&c?.type==="pointCloudUniqueValueRenderer"){i=T.fromJSON(c);let e=i.colorUniqueValueInfos;r=new Uint8Array(3*a);let u=v(i.fieldTransformType);for(let o=0;o<a;o++){let l=(u?u(t[o]):t[o])+"";for(let f=0;f<e.length;f++)if(e[f].values.includes(l)){r[3*o]=e[f].color.r,r[3*o+1]=e[f].color.g,r[3*o+2]=e[f].color.b;break}}}else if(t&&c?.type==="pointCloudStretchRenderer"){i=N.fromJSON(c);let e=i.stops;r=new Uint8Array(3*a);let u=v(i.fieldTransformType);for(let o=0;o<a;o++){let l=u?u(t[o]):t[o],f=e.length-1;if(l<e[0].value)r[3*o]=e[0].color.r,r[3*o+1]=e[0].color.g,r[3*o+2]=e[0].color.b;else if(l>=e[f].value)r[3*o]=e[f].color.r,r[3*o+1]=e[f].color.g,r[3*o+2]=e[f].color.b;else for(let m=1;m<e.length;m++)if(l<e[m].value){let p=(l-e[m-1].value)/(e[m].value-e[m-1].value);r[3*o]=e[m].color.r*p+e[m-1].color.r*(1-p),r[3*o+1]=e[m].color.g*p+e[m-1].color.g*(1-p),r[3*o+2]=e[m].color.b*p+e[m-1].color.b*(1-p);break}}}else if(t&&c?.type==="pointCloudClassBreaksRenderer"){i=J.fromJSON(c);let e=i.colorClassBreakInfos;r=new Uint8Array(3*a);let u=v(i.fieldTransformType);for(let o=0;o<a;o++){let l=u?u(t[o]):t[o];for(let f=0;f<e.length;f++)if(l>=e[f].minValue&&l<=e[f].maxValue){r[3*o]=e[f].color.r,r[3*o+1]=e[f].color.g,r[3*o+2]=e[f].color.b;break}}}else r=new Uint8Array(3*a).fill(255);if(n&&i?.colorModulation){let e=i.colorModulation.minValue,u=i.colorModulation.maxValue,o=.3;for(let l=0;l<a;l++){let f=n[l],m=f>=u?1:f<=e?o:o+(1-o)*(f-e)/(u-e);r[3*l]=m*r[3*l],r[3*l+1]=m*r[3*l+1],r[3*l+2]=m*r[3*l+2]}}return r}function P(s,t){if(s.encoding==null||s.encoding===""){let n=V(t,s);if(n.vertexAttributes.position==null)return;let a=C(t,n.vertexAttributes.position),c=n.header.fields,b=[c.offsetX,c.offsetY,c.offsetZ],r=[c.scaleX,c.scaleY,c.scaleZ],i=a.length/3,e=new Float64Array(3*i);for(let u=0;u<i;u++)e[3*u]=a[3*u]*r[0]+b[0],e[3*u+1]=a[3*u+1]*r[1]+b[1],e[3*u+2]=a[3*u+2]*r[2]+b[2];return e}if(s.encoding==="lepcc-xyz")return B(t).result}function d(s,t,n){return s?.attributeInfo.useElevation?t?Y(t,n):null:s?.attributeInfo.storageInfo?k(s.attributeInfo.storageInfo,s.buffer,n):null}function Y(s,t){let n=new Float64Array(t);for(let a=0;a<t;a++)n[a]=s[3*a+2];return n}function j(s,t,n,a,c){let b=s.length/3,r=0;for(let i=0;i<b;i++){let e=!0;for(let u=0;u<a.length&&e;u++){let{filterJSON:o}=a[u],l=c[u].values[i];switch(o.type){case"pointCloudValueFilter":{let f=o.mode==="exclude";o.values.includes(l)===f&&(e=!1);break}case"pointCloudBitfieldFilter":{let f=q(o.requiredSetBits),m=q(o.requiredClearBits);((l&f)!==f||l&m)&&(e=!1);break}case"pointCloudReturnFilter":{let f=15&l,m=l>>>4&15,p=m>1,X=f===1,w=f===m,M=!1;for(let h of o.includedReturns)if(h==="last"&&w||h==="firstOfMany"&&X&&p||h==="lastOfMany"&&w&&p||h==="single"&&!p){M=!0;break}M||(e=!1);break}}}e&&(n[r]=i,s[3*r]=s[3*i],s[3*r+1]=s[3*i+1],s[3*r+2]=s[3*i+2],t[3*r]=t[3*i],t[3*r+1]=t[3*i+1],t[3*r+2]=t[3*i+2],r++)}return r}function v(s){switch(s){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function q(s){let t=0;for(let n of s||[])t|=1<<n;return t}var I=class{transform(t){let n=this._transform(t),a=[n.points.buffer,n.rgb.buffer];n.pointIdFilterMap!=null&&a.push(n.pointIdFilterMap.buffer);for(let c of n.attributes)"buffer"in c.values&&D(c.values.buffer)&&c.values.buffer!==n.rgb.buffer&&a.push(c.values.buffer);return Promise.resolve({result:n,transferList:a})}_transform(t){let n=P(t.schema,t.geometryBuffer),a=n.length/3,c=null,b=new Array,r=d(t.primaryAttributeData,n,a);t.primaryAttributeData!=null&&r&&b.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:r});let i=d(t.modulationAttributeData,n,a);t.modulationAttributeData!=null&&i&&b.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:i});let e=G(t.rendererInfo,r,i,a);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){let o=t.filterAttributesData.filter(S).map(l=>{let f=d(l,n,a),m={attributeInfo:l.attributeInfo,values:f};return b.push(m),m});c=new Uint32Array(a),a=j(n,e,c,t.filterInfo,o)}for(let o of t.userAttributesData){let l=d(o,n,a);b.push({attributeInfo:o.attributeInfo,values:l})}3*a<e.length&&(e=new Uint8Array(e.buffer.slice(0,3*a))),E(n,a,t.elevationOffset);let u=Z(n,a,U.fromData(t.obbData),g.fromJSON(t.inSR),g.fromJSON(t.outSR));return{obbData:t.obbData,points:u,rgb:e,attributes:b,pointIdFilterMap:c}}};function Z(s,t,n,a,c){if(!x(s,a,0,s,c,0,t))throw new Error("Can't reproject");let b=A(n.center),r=y(),i=y(),e=A(n.halfSize);R(z,n.quaternion);let u=new Float32Array(3*t);for(let o=0;o<t;o++){let l=3*o;r[0]=s[l]-b[0],r[1]=s[l+1]-b[1],r[2]=s[l+2]-b[2],F(i,r,z),e[0]=Math.max(e[0],Math.abs(i[0])),e[1]=Math.max(e[1],Math.abs(i[1])),e[2]=Math.max(e[2],Math.abs(i[2])),u[l++]=r[0],u[l++]=r[1],u[l]=r[2]}return n.halfSize=e,u}function E(s,t,n){if(n!==0)for(let a=0;a<t;a++)s[3*a+2]+=n}var z=O();function ut(){return new I}export{ut as default};
