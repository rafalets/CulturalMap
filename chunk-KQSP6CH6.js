import{a as He}from"./chunk-VZWPFXBV.js";import{a as Ge}from"./chunk-DHLVTH5U.js";import{d as A}from"./chunk-7HLFOT25.js";import{i as qe,k as Le}from"./chunk-BUZBVNOM.js";import{a as m}from"./chunk-QGVBCWUY.js";import{h as Ae,n as je,r as ee,t as ze}from"./chunk-HHDFN2GK.js";import{a as O,b as ge}from"./chunk-VTHXE323.js";function rt(n){return n.split(" ").map((e,t)=>t>0?e.charAt(0).toUpperCase()+e.slice(1):e).join("")}function Re(n,e){let t=[];for(t.push(e);t.length;){let r=t.pop();if(typeof r=="object"&&!n.has(r.uid)){n.add(r.uid);for(let s of r.children)t.push(s)}}}var $=class n{constructor(){this.uid=n.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(e){return e=rt(e),this._debugName=e,this.isImplicit&&this.children[0]instanceof n&&this.children[0].setDebugName(e),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(e){e._debugName=this._debugName,e._isMutable=this._isMutable,e.isImplicit=this.isImplicit,e.uid=this.uid}};function a(n){return typeof n=="object"?n.clone():n}$.NodeCount=0;var f=class extends ${constructor(){super(...arguments),this.shaderType="primitive-node"}},te=class n extends ${constructor(e){super(),this.child=e,this.shaderType="scope-node"}get children(){return[this.child]}clone(){let e=new n(a(this.child));return this.cloneInto(e),e}};var ne=class n extends ${constructor(e,t,r){super(),this.property=e,this.target=t,this.returnType=r,this.shaderType="property-access-node"}get children(){let e=[this.target];return typeof this.property!="string"&&e.push(this.property),e}clone(){let e=new n(this.property,a(this.target),this.returnType);return this.cloneInto(e),e}},re=class n extends ${constructor(e,t,r,s){super(),this.x=e,this.y=t,this.target=r,this.returnType=s,this.shaderType="property-access-2d-node"}get children(){return[this.target,this.x,this.y]}clone(){let e=new n(this.x,this.y,a(this.target),this.returnType);return this.cloneInto(e),e}},se=class n extends ${constructor(e,t,r){super(),this.condition=e,this.ifTrue=t,this.ifFalse=r,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){let e=a(this.ifTrue),t=this.ifFalse?a(this.ifFalse):null,r=new n(this.condition,e,t);return this.cloneInto(r),r}},oe=class n extends ${constructor(e,t,r,s){super(),this.captureList=e,this.returnType=t,this.generator=s,this.shaderType="block-node",r&&(this.subgraph=new te(r))}get children(){return Object.keys(this.captureList).map(e=>this.captureList[e]).concat(this.subgraph??[])}clone(){let e={};for(let r in this.captureList)e[r]=a(this.captureList[r]);let t=new n(e,this.returnType,this.subgraph?a(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(t),t}},N=class n extends ${constructor(e,t,r,s,o,i=!1){super(),this.token=e,this._children=t,this.isInfix=r,this.isPropertyAccess=s,this.returnType=o,this.isTernary=i,this.shaderType="function-node"}get children(){return this._children}clone(){let e=new n(this.token,this._children.map(a),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(e),e}};var j,be,ve,xe,Ie,_e,Te,$e,Ne,Se,Ee,Fe,Me,ke;function st(n){switch(n.type){case"bool":case"bvec2":case"bvec3":case"bvec4":return T;case"float":case"vec2":case"vec3":case"vec4":return h;case"int":case"ivec2":case"ivec3":case"ivec4":return b;case"uint":case"uvec2":case"uvec3":case"uvec4":return q;default:throw new Error("Unable to handle type")}}function ot(n){let e=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(let t of e)if(t.includes(n))return t.map(r=>ut[r]);throw new Error("Unable to find type family")}function Xe(n){return new Proxy(n,{get(e,t){if(t==="constructor")return new Proxy(e.constructor,{construct:(r,s,o)=>Xe(new r(...s))});if(t in e)return e[t];if(typeof t=="string"){let r=ot(n.type);return _(n,t,r[t.length-1])}}})}function I(n){return new Proxy(n,{construct:(e,t,r)=>Xe(new e(...t))})}function it(n){return new Proxy(n,{get(e,t){if(t in e)return e[t];if(typeof t=="string"){let r=parseInt(t,10);if(!isNaN(r))return _(n,`[${r}]`,n.elementType.constructor)}}})}function at(n){return new Proxy(n,{construct:(e,t,r)=>it(new e(...t))})}var L=class extends Error{},we=j=class extends f{constructor(n,e){super(),this.elementType=n,this.size=e,this.children=[],this.type="array"}clone(){let n=new j(this.elementType,this.size);return super.cloneInto(n),n}get(n,e){let t=new b(n),r=e!=null?new b(e):null;return r!=null?me(this,t,r,st(this.elementType.constructor)):_(this,t,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(n,e,t){return ht(this,n,e,t)}glslFindIndex(n,e,t){return lt(this,n,e,t)}static ofType(n,e){let t={construct:(r,s)=>new j(new n,e)};return new Proxy(j,t)}};we.type="array",we=j=m([at],we);var Nt=(()=>{class n extends f{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){let t=new n;return t.children=this.children.map(a),super.cloneInto(t),t}}return n.type="sampler2D",n})(),h=(()=>{class n extends f{constructor(t){super(),this.type="float",this.children=[t]}clone(){let t=new n(a(this.children[0]));return super.cloneInto(t),t}multiply(t){return E(this,typeof t=="number"?y(t,n):t)}divide(t){return G(this,typeof t=="number"?y(t,n):t)}add(t){return U(this,typeof t=="number"?y(t,n):t)}subtract(t){return H(this,typeof t=="number"?y(t,n):t)}}return n.type="float",n})(),C=be=class extends f{constructor(n,e){super(),this.type="vec2",this.children=[n,e].filter(t=>t!=null)}clone(){let n=new be(a(this.children[0]),a(this.children[1]));return super.cloneInto(n),n}get 0(){return _(this,"[0]",h)}get 1(){return _(this,"[1]",h)}get 2(){throw new L}get 3(){throw new L}multiply(n){return E(this,typeof n=="number"?y(n,h):n)}divide(n){return G(this,typeof n=="number"?y(n,h):n)}add(n){return U(this,typeof n=="number"?y(n,h):n)}subtract(n){return H(this,typeof n=="number"?y(n,h):n)}};C.type="vec2",C=be=m([I],C);var z=ve=class extends f{constructor(n,e,t){super(),this.type="vec3",this.children=[n,e,t].filter(r=>r!=null)}get 0(){return _(this,"[0]",h)}get 1(){return _(this,"[1]",h)}get 2(){return _(this,"[2]",h)}get 3(){throw new L}clone(){let n=new ve(a(this.children[0]),a(this.children[1]),a(this.children[2]));return super.cloneInto(n),n}multiply(n){return E(this,typeof n=="number"?y(n,h):n)}divide(n){return G(this,typeof n=="number"?y(n,h):n)}add(n){return U(this,typeof n=="number"?y(n,h):n)}subtract(n){return H(this,typeof n=="number"?y(n,h):n)}};z.type="vec3",z=ve=m([I],z);var F=xe=class extends f{constructor(n,e,t,r){super(),this.type="vec4",this.children=[n,e,t,r].filter(s=>s!=null)}clone(){let n=new xe(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]));return super.cloneInto(n),n}get 0(){return _(this,"[0]",h)}get 1(){return _(this,"[1]",h)}get 2(){return _(this,"[2]",h)}get 3(){return _(this,"[3]",h)}multiply(n){return E(this,typeof n=="number"?y(n,h):n)}divide(n){return G(this,typeof n=="number"?y(n,h):n)}add(n){return U(this,typeof n=="number"?y(n,h):n)}subtract(n){return H(this,typeof n=="number"?y(n,h):n)}};F.type="vec4",F=xe=m([I],F);var q=Ie=class extends f{constructor(n){super(),this.type="uint",this.children=[n]}clone(){let n=new Ie(a(this.children[0]));return super.cloneInto(n),n}};q.type="uint",q=Ie=m([I],q);var ie=_e=class extends f{constructor(n,e){super(),this.type="uvec2",this.children=[n,e].filter(t=>t!=null)}clone(){let n=new _e(a(this.children[0]),a(this.children[1]));return super.cloneInto(n),n}};ie.type="uvec2",ie=_e=m([I],ie);var ae=Te=class extends f{constructor(n,e,t){super(),this.type="uvec3",this.children=[n,e,t].filter(r=>r!=null)}clone(){let n=new Te(a(this.children[0]),a(this.children[1]),a(this.children[2]));return super.cloneInto(n),n}};ae.type="uvec3",ae=Te=m([I],ae);var ce=$e=class extends f{constructor(n,e,t,r){super(),this.type="uvec4",this.children=[n,e,t,r].filter(s=>s!=null)}clone(){let n=new $e(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]));return super.cloneInto(n),n}};ce.type="uvec4",ce=$e=m([I],ce);var T=(()=>{class n extends f{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return gt(this,t)}or(t){return mt(this,t)}clone(){let t=new n(a(this.children[0]));return super.cloneInto(t),t}}return n.type="bool",n})(),ue=Ne=class extends f{constructor(n,e){super(),this.type="bvec2",this.children=[n,e].filter(t=>t!=null)}all(){return Ce(this)}any(){return Ue(this)}clone(){let n=new Ne(a(this.children[0]),a(this.children[1]));return super.cloneInto(n),n}};ue.type="bvec2",ue=Ne=m([I],ue);var de=Se=class extends f{constructor(n,e,t){super(),this.type="bvec3",this.children=[n,e,t].filter(r=>r!=null)}all(){return Ce(this)}any(){return Ue(this)}clone(){let n=new Se(a(this.children[0]),a(this.children[1]),a(this.children[2]));return super.cloneInto(n),n}};function y(n,e){return typeof n=="number"?new e(n):n}de.type="bvec3",de=Se=m([I],de);var pe=Ee=class extends f{constructor(n,e,t,r){super(),this.type="bvec4",this.children=[n,e,t,r].filter(s=>s!=null)}all(){return Ce(this)}any(){return Ue(this)}clone(){let n=new Ee(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]));return super.cloneInto(n),n}};pe.type="bvec4",pe=Ee=m([I],pe);var b=(()=>{class n extends f{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return E(this,y(t,n))}add(t){return U(this,y(t,n))}subtract(t){return H(this,y(t,n))}divide(t){return G(this,y(t,n))}clone(){let t=new n(a(this.children[0]));return super.cloneInto(t),t}}return n.type="int",n})(),he=Fe=class extends f{constructor(n,e){super(),this.type="ivec2",this.children=[n,e].filter(t=>t!=null)}clone(){let n=new Fe(a(this.children[0]),a(this.children[1]));return super.cloneInto(n),n}};he.type="ivec2",he=Fe=m([I],he);var le=Me=class extends f{constructor(n,e,t){super(),this.type="ivec3",this.children=[n,e,t].filter(r=>r!=null)}clone(){let n=new Me(a(this.children[0]),a(this.children[1]),a(this.children[2]));return super.cloneInto(n),n}};le.type="ivec3",le=Me=m([I],le);var fe=ke=class extends f{constructor(n,e,t,r){super(),this.type="ivec4",this.children=[n,e,t,r].filter(s=>s!=null)}clone(){let n=new ke(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]));return super.cloneInto(n),n}};fe.type="ivec4",fe=ke=m([I],fe);var St=(()=>{class n extends f{constructor(t,r,s,o){super(),this.type="mat2",this.children=[t,r,s,o]}clone(){let t=new n(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]));return super.cloneInto(t),t}get(t,r){return me(this,new b(t),new b(r),h)}multiply(t){return E(this,t)}}return n.type="mat2",n})(),ct=(()=>{class n extends f{static identity(){return new n(1,0,0,0,1,0,0,0,1)}static fromRotation(t){let r=vt(t),s=bt(t);return new n(s,r,0,pt(r),s,0,0,0,1)}constructor(t,r,s,o,i,d,u,c,p){super(),this.type="mat3",this.children=[t,r,s,o,i,d,u,c,p]}add(t){return U(this,t)}multiply(t){return E(this,t)}get(t,r){return me(this,new b(t),new b(r),h)}clone(){let t=new n(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]),a(this.children[4]),a(this.children[5]),a(this.children[6]),a(this.children[7]),a(this.children[8]));return super.cloneInto(t),t}}return n.type="mat3",n})(),Et=(()=>{class n extends f{static identity(){return new n(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,r,s,o,i,d,u,c,p,l,w,P,K,D,Z,W){super(),this.type="mat4",this.children=[t,r,s,o,i,d,u,c,p,l,w,P,K,D,Z,W]}static fromColumns(t,r,s,o){return new n(t.x,t.y,t.z,t.w,r.x,r.y,r.z,r.w,s.x,s.y,s.z,s.w,o.x,o.y,o.z,o.w)}multiply(t){return E(this,t)}get(t,r){return me(this,new b(t),new b(r),h)}clone(){let t=new n(a(this.children[0]),a(this.children[1]),a(this.children[2]),a(this.children[3]),a(this.children[4]),a(this.children[5]),a(this.children[6]),a(this.children[7]),a(this.children[8]),a(this.children[9]),a(this.children[10]),a(this.children[11]),a(this.children[12]),a(this.children[13]),a(this.children[14]),a(this.children[15]));return super.cloneInto(t),t}}return n.type="mat4",n})(),ut={float:h,vec2:C,vec3:z,vec4:F,int:b,ivec2:he,ivec3:le,ivec4:fe,uint:q,uvec2:ie,uvec3:ae,uvec4:ce,bool:T,bvec2:ue,bvec3:de,bvec4:pe},Ft=(...n)=>new b(...n),dt=(...n)=>new h(...n),Mt=(...n)=>new C(...n),kt=(...n)=>new z(...n),Pt=(...n)=>new F(...n);var Ct=(...n)=>new ct(...n);function _(n,e,t){let r=new t(new ne(e,n,t));return r.isImplicit=!0,r}function me(n,e,t,r){let s=new r(new re(e,t,n,r));return s.isImplicit=!0,s}function x(n,e,t,r=null){if(r){let o=new r,i=new r(new N(n,[e,t],!0,!1,o));return i.isImplicit=!0,i}if(e.type==="float"||e.type==="int"){let o=new t.constructor(new N(n,[e,t],!0,!1,t.constructor));return o.isImplicit=!0,o}if((e.type==="mat2"||e.type==="mat3"||e.type==="mat4")&&t.type!=="float"){let o=new t.constructor(new N(n,[e,t],!0,!1,t.constructor));return o.isImplicit=!0,o}let s=new e.constructor(new N(n,[e,t],!0,!1,e.constructor));return s.isImplicit=!0,s}function v(n,e,t=e.constructor){let r=new t(new N(n,[e],!1,!1,t));return r.isImplicit=!0,r}function S(n,e,t,r=e.constructor){let s=new r(new N(n,[e,t],!1,!1,r));return s.isImplicit=!0,s}function Pe(n,e,t,r,s=e.constructor){let o=new s(new N(n,[e,t,r],!1,!1,s));return o.isImplicit=!0,o}function pt(n){return E(n,dt(-1))}function Ye(n,e,t,r){return new e(new oe(n,e,t,r))}function ht(n,e,t=0,r=n.size){let s=new b(t).setMutable().setDebugName("FindIndexIterator"),o=e(n.get(s)).setDebugName("FindIndexPredicate");return Ye({iter:s},b,o,({out:d,iter:u,subgraph:c})=>`
${d} = -1;

for (; ${u} < ${r}; ${u}++) {

${c.body}

  if (${c.varName}) {
    ${d} = ${u};
    break;
  }

}
`).setDebugName("FindIndexBlock")}function lt(n,e,t=0,r=n.size){return Ye({array:n},b,null,({out:o,array:i})=>`
${o} = -1;
for (int i = ${t}; i < ${r}; i++) {
  bool condition;
  ${e({array:i,i:"i",out:"condition"})}
  if (condition) {
    ${o} = i;
    break;
  }
}
`).setDebugName("GlslFindIndexBlock")}function ft(n,e,t){let r=typeof e=="function"?e():e,s=typeof t=="function"?t():t,o=new r.constructor(new se(n,r,s));return o.isImplicit=!0,o}function Ut(...n){let e=n.map(([d,u])=>typeof u=="function"?[d,u()]:[d,u]),t=e[0][1].constructor,r=e.findIndex(d=>d[0]===!0);if(r===-1)throw new Error("A cond must have a fallthrough case with `true`/; ");let s=e.slice(0,r),o=e[r][1],i=new t(s.reduceRight((d,u)=>ft(u[0],u[1],d),o));return i.isImplicit=!0,i}function E(n,e){return x("*",n,e)}function G(n,e){return x("/",n,e)}function U(n,e){return x("+",n,e)}function H(n,e){return x("-",n,e)}function Vt(n,e){return x("%",n,e)}function Bt(n,e){return x(">>",n,e)}function Kt(n,e){return x("&",n,e)}function Dt(n,e){return x("==",n,e,T)}function Ot(n,e){return x("<",n,e,T)}function At(n,e){return x("<=",n,e,T)}function jt(n,e){return x(">",n,e,T)}function zt(n,e){return x(">=",n,e,T)}function mt(...n){return n.length<=1?n[0]:n.slice(1).reduce((e,t)=>yt(e,t),n[0])}function yt(n,e){return x("||",n,e,T)}function gt(...n){return n.length<=1?n[0]:n.slice(1).reduce((e,t)=>wt(e,t),n[0])}function wt(n,e){return x("&&",n,e,T)}function qt(n){return v("abs",n)}function Ce(n){return v("all",n,T)}function Ue(n){return v("any",n,T)}function Lt(n,e){return e==null?v("atan",n):S("atan",n,e,n.constructor)}function Gt(n){return v("ceil",n)}function Ht(n,e,t){return Pe("clamp",n,e,t,n.constructor)}function bt(n){return v("cos",n)}function Rt(n,e){return S("distance",n,e,h)}function Xt(n,e){return S("dot",n,e,h)}function Yt(n){return v("floor",n)}function Jt(n){return v("fract",n)}function Qt(n){return v("length",n,h)}function Zt(n,e){return S("max",n,e)}function Wt(n,e){return S("min",n,e)}function en(n,e,t){return Pe("mix",n,e,t)}function tn(n,e){return S("mod",n,e)}function nn(n){return v("normalize",n)}function rn(n){return n.type==="bool"?v("!",n):v("not",n)}function sn(n,e){return S("pow",n,e)}function on(n){return v("round",n)}function vt(n){return v("sin",n)}function an(n,e,t){return Pe("smoothstep",n,e,t)}function cn(n){return v("sqrt",n)}function un(n,e){return S("step",n,e,e.constructor)}function dn(n,e){return S("texture",n,e,F)}function g(n,e,t){let r=e.split(`
`);for(let s of r)if(s.trim().length){{let o="";t!=null&&(o+=`/*id:${t??"000"}*/   `),n.body+=o.padEnd(14)}n.body+=" ".repeat(n.indent)+s+`
`}}var R=class{write(e){for(let t of e.rootOutputNodes())e.shouldPruneOutputNode(t)||(t.variableName=this._write(e,t.node));return e}_createVarName(e,t){let r="";return typeof t!="boolean"&&typeof t!="number"&&t.debugInfo.name&&(r=`${t.debugInfo.name}_`),`${r}v${e.varCount++}`}_write(e,t,r=!1){if(typeof t=="number"||typeof t=="boolean")return t.toString();let s=e.getEmit(t);if(s)return s;switch(t.shaderType){case"scope-node":s=this._writeScopeNode(e,t);break;case"primitive-node":s=this._writePrimitiveNode(e,t,r);break;case"function-node":s=this._writeFunctionNode(e,t);break;case"property-access-node":s=this._writePropertyAccessNode(e,t);break;case"property-access-2d-node":s=this._writePropertyAccess2DNode(e,t);break;case"text-node":s=t.text;break;case"block-node":s=this._writeBlockNode(e,t);break;case"condition-node":s=this._writeConditionNode(e,t)}return e.setEmit(t,s),s}_writeScopeNode(e,t){let r=new t.child.constructor;r.setDebugName(t.debugInfo.name);let s=this._write(e,r,!0);return g(e,`{ /*ScopeStart: ${t.uid} ${t.debugInfo.name}*/`),e.indent+=2,g(e,`${s} = ${this._write(e,t.child)};`),e.indent-=2,g(e,`} /*ScopeEnd: ${t.uid} ${t.debugInfo.name}*/`),s}_writeConditionNode(e,t){let r=new t.ifTrue.constructor,s=this._write(e,r,!0);g(e,`if (${this._write(e,t.condition)}) {`),e.indent+=2;let o=e.createSubgraphContext(),i=this._write(o,t.ifTrue);if(e.body+=o.body,i&&g(e,`${s} = ${i};`),e.indent-=2,g(e,"}"),t.ifFalse){g(e,"else {"),e.indent+=2;let d=e.createSubgraphContext(),u=this._write(d,t.ifFalse);e.body+=d.body,u&&g(e,`${s} = ${u};`),e.indent-=2,g(e,"}")}return s}_writeBlockNode(e,t){let{captureList:r,generator:s,returnType:o}=t,i={};for(let p in r){if(!r[p])continue;let l=this._write(e,r[p]);i[p]=l}let d=new o,u=this._write(e,d,!0);if(i.out=u,t.subgraph){let p=e.createSubgraphContext(),l=this._write(p,t.subgraph.child),w=p.body;i.subgraph={varName:l,body:w}}let c=s(i);return g(e,`{
`),e.indent+=2,g(e,c),e.indent-=2,g(e,`}
`),u}_writePropertyAccessNode(e,t){let r=this._write(e,t.target);return typeof t.property=="string"&&t.property.includes("[")?`${r}${t.property}`:typeof t.property!="string"?`${r}[${this._write(e,t.property)}]`:`${r}.${t.property}`}_writePropertyAccess2DNode(e,t){return`${this._write(e,t.target)}[${this._write(e,t.x)}][${this._write(e,t.y)}]`}_writeFunctionNode(e,t){let r=t.returnType.type;if(t.isInfix){let[i,d]=t.children.map(c=>this._write(e,c)),u=this._createVarName(e,t);return g(e,`${r.padEnd(5)} ${u} = ${i} ${t.token} ${d};`,t.uid),u}let s=t.children.map(i=>this._write(e,i)).join(", "),o=this._createVarName(e,t);return g(e,`${r.padEnd(5)} ${o} = ${t.token}(${s});`,t.uid),o}_writePrimitiveNode(e,t,r=!1){let s=e.getInput(t);if(s)return s.isUsed=!0,s.variableName;let o=t.children.length===1&&t.children[0]?.type===t.type;if(!t.isMutable&&(t.isImplicit||o))return this._write(e,t.children[0]);let i=this._createVarName(e,t);if(r)return g(e,`${t.type.padEnd(5)} ${i};`,t.uid),i;let d=!t.debugInfo.name&&!t.isMutable;if(d&&t.type==="float"&&typeof t.children[0]=="number")return Number.isInteger(t.children[0])?t.children[0].toFixed(1):t.children[0].toString();if(d&&t.type==="int"&&typeof t.children[0]=="number"&&Number.isInteger(t.children[0]))return t.children[0].toString();let u=t.children.map(c=>this._write(e,c)).join(", ");return t.type==="array"?(g(e,`${t.type.padEnd(5)} ${i} = [${u}];`,t.uid),i):d?`${t.type}(${u})`:(g(e,`${t.type.padEnd(5)} ${i} = ${t.type}(${u});`,t.uid),i)}};var M=class n{constructor(e,t,r){this.variableName=e,this.variableInputType=t,this.node=r,this.type="shader-input",this.isUsed=!1}clone(){return new n(this.variableName,this.variableInputType,a(this.node))}},k=class n{constructor(e,t,r){this.outVariableName=e,this.outVariableType=t,this.node=r,this.type="shader-output"}clone(){let e=new n(this.outVariableName,this.outVariableType,a(this.node));return e.variableName=this.variableName,e}},X=class n{static createVertex(e,t,r,s,o,i){let d=[];for(let c in e){let p=e[c],l=r.get(c);l?d.push(new M(l,"builtin",p)):d.push(new M("a_"+c,"in",p))}for(let c of s){let p=c.uniformHydrated;d.push(new M(c.uniformName,"uniform",p))}let u=[];for(let c in t){let p=t[c];c==="glPosition"?u.push(new k("gl_Position","builtin",p)):c==="glPointSize"?u.push(new k("gl_PointSize","builtin",p)):u.push(new k("v_"+c,"out",p))}return new n(d,u,o,i)}static createFragment(e,t,r,s,o,i){let d=[],u=Array.from(o.rootOutputNodes());for(let p in e){let l=e[p],w=r.get(p);if(w){d.push(new M(w,"builtin",l));continue}let P=u.find(K=>K.node===l);P&&d.push(new M(P.outVariableName,"in",l))}for(let p of s){let l=p.uniformHydrated;d.push(new M(p.uniformName,"uniform",l))}let c=[];for(let p in t){let l=t[p],w=r.get(p);p==="discard"?c.push(new k(null,"discard",l)):w?c.push(new k(w,"builtin",l)):c.push(new k(p,"out",l))}return new n(d,c,i)}constructor(e,t,r,s){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(let o of e)this._inputShaderTypesByNodeUid.set(o.node.uid,o);this._outputShaderTypes=t,this._transformFeedbackBindings=r,this._transformFeedbackNames=new Set(r.map(o=>"v_"+o.propertyKey)),this._usedInFragmentShader=s}shouldPruneOutputNode(e){return!!this._usedInFragmentShader&&e.outVariableType!=="builtin"&&!this._transformFeedbackNames.has(e.outVariableName)&&!this._usedInFragmentShader.has(e.node.uid)}setEmit(e,t){this._nodeEmitMap.set(e.uid,t)}getEmit(e){return this._nodeEmitMap.get(e.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(e){return this._inputShaderTypesByNodeUid.get(e.uid)}*rootOutputNodes(){for(let e of this._outputShaderTypes)yield e}*nodes(){let e=[];for(let t of this._outputShaderTypes.values())e.push(t.node);for(;e.length;){let t=e.pop();typeof t!="number"&&typeof t!="boolean"&&e.push(...t.children.filter(Boolean)),yield t}}*nodesOfTypeOrFunction(){for(let e of this.nodes())typeof e!="number"&&typeof e!="boolean"&&(yield e)}createSubgraphContext(){let e=this.clone();return e.body="",e.indent=this.indent+2,e._nodeEmitMap=new Map(this._nodeEmitMap),e}clone(){let e=new n([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return e._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,e.indent=this.indent,e.body=this.body,e.varCount=this.varCount,e._nodeEmitMap=this._nodeEmitMap,e}insertVertexShader(e){e.vertex.code.add(""),this._insertInputs(e,"vertex"),e.vertex.code.add(""),e.vertex.code.add("// OUTPUTS: "),e.vertex.code.add("// --------------------------------------------------------- ");for(let t of this.rootOutputNodes()){let r=t.outVariableType==="builtin";this.shouldPruneOutputNode(t)||(r?e.vertex.code.add(`// ${t.outVariableType.padEnd(7)} ${t.node.type.padEnd(9)} ${t.outVariableName};`):e.vertex.code.add(`${t.outVariableType.padEnd(10)} ${t.node.type.padEnd(9)} ${t.outVariableName};`))}e.vertex.code.add(""),e.vertex.code.add("void main() {"),e.vertex.code.add("  "+this.body.split(`
`).join(`
  `));for(let t of this.rootOutputNodes())this.shouldPruneOutputNode(t)||e.vertex.code.add(`  ${t.outVariableName} = ${t.variableName};`);e.vertex.code.add("}")}insertFragmentShader(e){this._insertInputs(e,"fragment"),e.fragment.code.add(""),e.fragment.code.add("// OUTPUTS: "),e.fragment.code.add("// --------------------------------------------------------- ");let t=0;for(let r of this.rootOutputNodes())r.outVariableType==="builtin"?e.fragment.code.add(`// ${r.outVariableType.padEnd(7)} ${r.node.type.padEnd(9)} ${r.outVariableName};`):e.outputs.add(r.outVariableName,r.node.type,t++);e.fragment.code.add(""),e.fragment.code.add("void main() {"),e.fragment.code.add("  "+this.body.split(`
`).join(`
  `));for(let r of this.rootOutputNodes())r.outVariableType==="discard"?(e.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),e.fragment.code.add(`  if (${r.variableName}) {`),e.fragment.code.add("    discard;"),e.fragment.code.add("  }"),e.fragment.code.add("  ")):e.fragment.code.add(`  ${r.outVariableName} = ${r.variableName};`);e.fragment.code.add("}")}_insertInputs(e,t){e[t].code.add("// INPUTS: "),e[t].code.add("// --------------------------------------------------------- ");for(let r of this.inputs())r.isUsed&&r.variableInputType!=="builtin"&&(r.node.type==="array"?e[t].code.add(`${r.variableInputType.padEnd(10)} ${r.node.elementType.type.padEnd(9)} ${r.variableName}[${r.node.size}];`):r.node.type==="array-2d"?e[t].code.add(`${r.variableInputType.padEnd(10)} ${r.node.elementType.type.padEnd(9)} ${r.variableName}[${r.node.size}]; // Emulated 2D Array. Not supported by ES3.0`):e[t].code.add(`${r.variableInputType.padEnd(10)} ${r.node.type.padEnd(9)} ${r.variableName};`))}};function Je(n,e,t){let r=new qe(e.width,e.height);return r.dataType=e.dataType,e.depth&&(r.depth=e.depth),e.flipped&&(r.flipped=e.flipped),e.hasMipmap&&(r.hasMipmap=e.hasMipmap),r.internalFormat=e.internalFormat,e.isImmutable&&(r.isImmutable=e.isImmutable),e.isOpaque&&(r.isOpaque=e.isOpaque),e.maxAnisotropy&&(r.maxAnisotropy=e.maxAnisotropy),r.pixelFormat=e.pixelFormat,e.preMultiplyAlpha&&(r.preMultiplyAlpha=e.preMultiplyAlpha),e.samplingMode&&(r.samplingMode=e.samplingMode),e.target&&(r.target=e.target),r.uniform=e.uniform,e.unpackAlignment&&(r.unpackAlignment=e.unpackAlignment),e.wrapMode&&(r.wrapMode=e.wrapMode),new Le(n,r,t)}var xt=()=>ee.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram");function Y(n,e,t){let r=e.length;if(r!==t){let s=new ze("Invalid Uniform",`Invalid length, expected ${t} but got ${r}`,{uniformName:n,values:e});xt().errorOnce(s)}}var J=class{constructor(e,t,r,s,o,i){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=e,this.fragmentShader=t,this._locations=r,this._locationInfo=s,this._uniformBindings=o,this._transformFeedbackBindings=i}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(e){this._uniforms=e}cleanupTemporaryTextures(){for(let e of this._temporaryTextures)e.dispose();this._temporaryTextures=[]}bind(e){let t=this._uniforms;if(!this._program){let s=new Map;for(let[i,d]of this._locations)s.set(i,d);let o=[];for(let i of this._transformFeedbackBindings??[]){let{index:d,propertyKey:u}=i;o[d]=`v_${u}`}this._program=new He(e,this.vertexShader,this.fragmentShader,s,new Map,o)}let r=this._program;e.useProgram(r);for(let s of this._uniformBindings){let{shaderModulePath:o,uniformName:i,uniformType:d,uniformArrayLength:u}=s,c=Ae(o,t);if(c==null){if(d==="sampler2D")continue;throw new Error(`Failed to find uniform value for ${o}`)}switch(d==="array"||d==="array-2d"?s.uniformArrayElementType:d){case"sampler2D":{let{unit:p,texture:l}=c;if(r.setUniform1i(i,p),"type"in l)e.bindTexture(l,p);else{let w=Je(e,l.descriptor,l.data);e.bindTexture(w,p)}break}case"int":if(!u){r.setUniform1i(i,c);break}Y(s.uniformName,c,u),r.setUniform1iv(i,c);break;case"float":if(!u){r.setUniform1f(i,c);break}Y(s.uniformName,c,u),r.setUniform1fv(i,c);break;case"vec2":if(!u){r.setUniform2f(i,c[0],c[1]);break}Y(s.uniformName,c,u),r.setUniform2fv(i,c.flat());break;case"vec3":if(!u){r.setUniform3f(i,c[0],c[1],c[2]);break}Y(s.uniformName,c,u),r.setUniform3fv(i,c.flat());break;case"vec4":if(!u){r.setUniform4f(i,c[0],c[1],c[2],c[3]);break}Y(s.uniformName,c,u),r.setUniform4fv(i,c.flat());break;case"mat3":r.setUniformMatrix3fv(i,c);break;case"mat4":r.setUniformMatrix4fv(i,c);break;default:throw new Error(`Unable to set uniform for type ${d}`)}}}};function Q(n){return new n}function B(n,e,t){let r=n.constructor[e]??[];n.constructor.hasOwnProperty(e)||Object.defineProperty(n.constructor,e,{value:r.slice()}),n.constructor[e].push(t)}function cr(n,e){return(t,r)=>{B(t,"locations",{typeCtor:e,propertyKey:r,parameterIndex:null,index:n})}}var It=n=>(e,t)=>{B(e,"builtins",{builtin:n,propertyKey:t})},ur=n=>(e,t,r)=>{B(e,"inputs",{inputCtor:n,propertyKey:t,parameterIndex:r})},dr=n=>(e,t)=>{B(e,"uniforms",{typeCtor:n,propertyKey:t})},pr=n=>(e,t)=>{B(e,"options",{typeCtor:n,propertyKey:t})},hr=(n,e)=>{B(n,"defines",{propertyKey:e})};var Ve=(n,e)=>(t,r)=>{t.constructor.builtins.push({builtin:n,propertyKey:r,typeCtor:e})},ye=class{};ye.builtins=[],m([Ve("gl_VertexID",b)],ye.prototype,"glVertexID",void 0);var Qe=class{},V=class{};V.builtins=[],m([Ve("gl_FragCoord",F)],V.prototype,"glFragCoord",void 0),m([Ve("gl_PointCoord",C)],V.prototype,"glPointCoord",void 0);var Be=class{};m([It("gl_FragDepth")],Be.prototype,"glFragDepth",void 0);var Ze=class{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}},We=class{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){let e=this._shaderModuleClass.inputs.findLast(t=>t.propertyKey==="vertex"&&t.parameterIndex===0);if(!e)throw new Error("Unable to find vertex input parameter");return e}get computeInput(){return this._shaderModuleClass.inputs.findLast(e=>e.propertyKey==="vertex"&&e.parameterIndex===1)}get fragmentInput(){let e=this._shaderModuleClass.inputs.findLast(t=>t.propertyKey==="fragment");if(!e)throw new Error("Unable to find fragment input parameter");return e}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){let e=new Map,t=new Set;for(let r of this.locations)t.has(r.index)?ee.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${r.propertyKey} to ${r.index}. Index already in use`,{locationsMap:e}):(e.set(r.propertyKey,r.index),t.add(r.index));return e}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([o,i])=>`${o}.${i}`).join("."),r=je(t),s=this.computeAttributes;this._locationInfo={hash:r,stringHash:t,locations:e,computeAttributeMap:s}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let t of this.locations)e.set("a_"+t.propertyKey,t.index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set;for(let t of this._options)e.add(t.propertyKey);this._optionPropertyKeys=e}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(e,t,r,s){try{let{vertex:o,fragment:i,uniformBindings:d}=this._generateShaders(e,t,r,s);return new J(o,i,this.renamedLocationsMap,this.locationInfo,d,this.transformFeedbackBindings)}catch{return new J("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(e){let t=this._options.find(s=>s.propertyKey===e);if(t)return{type:"option",className:t.typeCtor};let r=this._uniforms.find(s=>s.propertyKey===e);if(!r)throw new Error(`Unable to find uniform class type for property: ${e}`);return{type:"required",className:r.typeCtor}}getShaderKey(e,t,r,s){let o=Object.keys(e).map(c=>`${c}.${e[c]}`).join("."),i=Object.keys(r).map(c=>`${c}.${r[c]}`).join("."),d=Object.keys(s).map(c=>`${c}.${s[c]}`).join("."),u=Object.keys(t).filter(c=>this.optionPropertyKeys.has(c)&&t[c]).join(".");return`${this.type}.${o}.${i}.${d}.${u}`}_generateShaders(e,t,r,s){let o=[];this._setDefines(r),this._setOptionalUniforms(o,t),this._setRequiredUniforms(o);let i=this._hydrateVertexInput(s),d=this._injectPackPrecisionFactor(i,e),u=this._hydrateComputeInput(),c=u&&this._injectComputePackPrecisionFactor(u,e),p=this.vertex(d,c),l=this._hydrateFragmentInput(p),w=this.fragment(l),P=new Set;for(let tt in w){let nt=w[tt];Re(P,nt)}let K=this._getVertexInputBuiltins(),D=X.createVertex(O(O({},i),u),p,K,o,this.transformFeedbackBindings,P);new R().write(D);let Z=this._getFragmentInputBuiltins(w);Z.set("glPointCoord","gl_PointCoord");let W=X.createFragment(l,w,Z,o,D,this.transformFeedbackBindings);new R().write(W);let Ke=this._createShaderBuilder(D,W),De=Ke.generate("vertex"),Oe=Ke.generate("fragment");return this.logShader&&(console.log(De),console.log(Oe)),{vertex:De,fragment:Oe,uniformBindings:o}}_setDefines(e){for(let t in e)this[t]=e[t]}_setOptionalUniforms(e,t){for(let r of this._options)t[r.propertyKey]?this[r.propertyKey]=this._hydrateUniformGroup(e,r):this[r.propertyKey]=null}_setRequiredUniforms(e){for(let t of this._uniforms)this[t.propertyKey]=this._hydrateUniformGroup(e,t)}_hydrateUniformGroup(e,t){let r=new t.typeCtor;for(let s of r._uniforms??[]){let o=Q(s.typeCtor),i=`u_${t.propertyKey}_${s.propertyKey}`,d=o.type,u=[t.propertyKey,s.propertyKey].join(".");if("type"in s.typeCtor&&s.typeCtor.type==="array"){let c=o;e.push({shaderModulePath:u,uniformName:i,uniformType:d,uniformArrayLength:c.size,uniformArrayElementType:c.elementType.type,uniformHydrated:o})}else if("type"in s.typeCtor&&s.typeCtor.type==="array-2d"){let c=o;e.push({shaderModulePath:u,uniformName:i,uniformType:d,uniformArrayLength:c.size,uniformArrayElementType:c.elementType.type,uniformHydrated:o})}else e.push({shaderModulePath:u,uniformName:i,uniformType:d,uniformHydrated:o});r[s.propertyKey]=o}return r}_hydrateVertexInput(e){let t=this.vertexInput.inputCtor,r=t.locations.reduce((s,o)=>e[o.propertyKey]===!1?s:ge(O({},s),{[o.propertyKey]:Q(o.typeCtor)}),{});for(let{propertyKey:s,typeCtor:o}of t.builtins){let i=Q(o);r[s]=i}return r}_hydrateComputeInput(){return this.computeInput==null?null:this.computeInput.inputCtor.locations.reduce((e,t)=>ge(O({},e),{[t.propertyKey]:Q(t.typeCtor)}),{})}_injectPackPrecisionFactor(e,t){let r={};for(let s in e){let o=e[s],i=t[s];if(i){if(o.type!=="float"&&o.type!=="vec2"&&o.type!=="vec3"&&o.type!=="vec4")throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${o.type}`);r[s]=o.divide(new h(i))}else r[s]=o}return r}_injectComputePackPrecisionFactor(e,t){let r={},s=new Map;for(let o in this.computeAttributes)for(let i of this.computeAttributes[o]??[])s.set(i,o);for(let o in e){let i=e[o],d=s.get(o);if(!d)continue;let u=t[d];if(u){if(i.type!=="float"&&i.type!=="vec2"&&i.type!=="vec3"&&i.type!=="vec4")throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${i.type}`);r[o]=i.divide(new h(u))}else r[o]=i}return r}_hydrateFragmentInput(e){let t={};for(let r in e)t[r]=e[r];for(let{propertyKey:r,typeCtor:s}of V.builtins){let o=Q(s);t[r]=o}return t}_getVertexInputBuiltins(){let e=this.vertexInput.inputCtor,t=new Map;for(let{builtin:r,propertyKey:s}of e.builtins)t.set(s,r);return t}_getFragmentInputBuiltins(e){let t=e.constructor,r=new Map;for(let s of t.builtins??[])r.set(s.propertyKey,s.builtin);return r}_createShaderBuilder(e,t){let r=new Ge;return this._insertDebugInfo(r),e.insertVertexShader(r),t.insertFragmentShader(r),r}_insertDebugInfo(e){e.vertex.code.add("// DEFINES: "),e.vertex.code.add("// --------------------------------------------------------- ");for(let t of this._defines)this[t.propertyKey]?e.vertex.code.add(`//   ${t.propertyKey}: true`):e.vertex.code.add(`//   ${t.propertyKey}: false`);e.vertex.code.add(""),e.vertex.code.add("// OPTIONS: "),e.vertex.code.add("// --------------------------------------------------------- ");for(let t of this._options)this[t.propertyKey]?e.vertex.code.add(`//   ${t.propertyKey}: true`):e.vertex.code.add(`//   ${t.propertyKey}: false`)}};var et=class{constructor(){this.drawPhase=A.MAP|A.HITTEST|A.HIGHLIGHT|A.DEBUG}startup(){}shutdown(e){}};export{et as a,we as b,Nt as c,h as d,C as e,z as f,F as g,T as h,b as i,St as j,ct as k,Et as l,Ft as m,dt as n,Mt as o,kt as p,Pt as q,Ct as r,pt as s,Ye as t,ft as u,Ut as v,E as w,Vt as x,Bt as y,Kt as z,Dt as A,Ot as B,At as C,jt as D,zt as E,mt as F,gt as G,qt as H,Lt as I,Gt as J,Ht as K,bt as L,Rt as M,Xt as N,Yt as O,Jt as P,Qt as Q,Zt as R,Wt as S,en as T,tn as U,nn as V,rn as W,sn as X,on as Y,vt as Z,an as _,cn as $,un as aa,dn as ba,J as ca,cr as da,ur as ea,dr as fa,pr as ga,hr as ha,ye as ia,Qe as ja,V as ka,Be as la,Ze as ma,We as na};
