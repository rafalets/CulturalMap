import{c as K,h as Y,i as Z}from"./chunk-FZ5X7HOK.js";import{c as J}from"./chunk-3D4Y6BLC.js";import{c as X}from"./chunk-ONYJLWAD.js";import{a as $}from"./chunk-BUZBVNOM.js";import{b as Q}from"./chunk-HM5RIVQC.js";import{b as h,c as z,d as k,m as F,r as W,w as j}from"./chunk-5WKDXHVH.js";import{a as m,c as y,f as P}from"./chunk-NHSDW26F.js";import{b as q,d as c}from"./chunk-VOFKUGRY.js";import{a as G,h as V}from"./chunk-LB5YQINJ.js";import{L as D,d as b}from"./chunk-C7INQGWT.js";import{H as B}from"./chunk-WMHJC7XF.js";import{a as O}from"./chunk-3TQOUBNU.js";import{j as R}from"./chunk-D2LVMNOU.js";import{a as d}from"./chunk-QGVBCWUY.js";import{r as N,t as I}from"./chunk-HHDFN2GK.js";import{f as L}from"./chunk-VTHXE323.js";var v=class{constructor(t=P()){this.intensity=t}},w=class{constructor(t=P(),e=y(.57735,.57735,.57735)){this.intensity=t,this.direction=e}},g=class{constructor(t=P(),e=y(.57735,.57735,.57735),i=!0,s=1,a=1){this.intensity=t,this.direction=e,this.castShadows=i,this.specularStrength=s,this.environmentStrength=a}},p=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function tt(r,t,e){(e=e||r).length=r.length;for(let i=0;i<r.length;i++)e[i]=r[i]*t[i];return e}function S(r,t,e){(e=e||r).length=r.length;for(let i=0;i<r.length;i++)e[i]=r[i]*t;return e}function u(r,t,e){(e=e||r).length=r.length;for(let i=0;i<r.length;i++)e[i]=r[i]+t[i];return e}function et(r){return(r+1)*(r+1)}function ct(r){return q(Math.floor(Math.sqrt(r)-1),0,2)}function rt(r,t,e){let i=r[0],s=r[1],a=r[2],o=e||[];return o.length=et(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*i,o[2]=.4886025119*a,o[3]=.4886025119*s),t>=2&&(o[4]=1.09254843059*i*s,o[5]=1.09254843059*s*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*i*a,o[8]=.54627421529*(i*i-s*s)),o}function mt(r,t){let e=et(r),i=t||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=e;for(let s=0;s<e;s++)i.r[s]=i.g[s]=i.b[s]=0;return i}function gt(r,t){let e=ct(t.r.length);for(let i of r)W(H,i.direction),rt(H,e,l),tt(l,T),S(l,i.intensity[0],_),u(t.r,_),S(l,i.intensity[1],_),u(t.g,_),S(l,i.intensity[2],_),u(t.b,_);return t}function ut(r,t){rt(H,0,l);for(let e of r)t.r[0]+=l[0]*T[0]*e.intensity[0]*4*Math.PI,t.g[0]+=l[0]*T[0]*e.intensity[1]*4*Math.PI,t.b[0]+=l[0]*T[0]*e.intensity[2]*4*Math.PI;return t}function it(r,t,e,i){mt(t,i),z(e.intensity,0,0,0);let s=!1,a=ft,o=dt,E=pt;a.length=0,o.length=0,E.length=0;for(let n of r)n instanceof g&&!s?(h(e.direction,n.direction),h(e.intensity,n.intensity),e.specularStrength=n.specularStrength,e.environmentStrength=n.environmentStrength,e.castShadows=n.castShadows,s=!0):n instanceof g||n instanceof w?a.push(n):n instanceof v?o.push(n):n instanceof p&&E.push(n);gt(a,i),ut(o,i);for(let n of E)u(i.r,n.r),u(i.g,n.g),u(i.b,n.b)}var ft=[],dt=[],pt=[],l=[0],_=[0],H=m(),T=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];var A=class{constructor(){this.color=m(),this.intensity=1}},M=class{constructor(){this.direction=m(),this.ambient=new A,this.diffuse=new A}},_t=.4,st=class{constructor(){this._shOrder=2,this._legacy=new M,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new p,this._mainLight=new g(m(),y(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){it(t,this._shOrder,this._mainLight,this._sphericalHarmonics),h(this._legacy.direction,this._mainLight.direction);let e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,F(this._legacy.diffuse.color,this._mainLight.intensity,e),h(U,this._legacy.diffuse.color),F(U,U,_t*this.globalFactor),k(this._legacy.ambient.color,this._legacy.ambient.color,U)}copyFrom(t){this._sphericalHarmonics.r=Array.from(t.sh.r),this._sphericalHarmonics.g=Array.from(t.sh.g),this._sphericalHarmonics.b=Array.from(t.sh.b),h(this._mainLight.direction,t.mainLight.direction),h(this._mainLight.intensity,t.mainLight.intensity),this._mainLight.castShadows=t.mainLight.castShadows,this._mainLight.specularStrength=t.mainLight.specularStrength,this._mainLight.environmentStrength=t.mainLight.environmentStrength,this.globalFactor=t.globalFactor,this.noonFactor=t.noonFactor}lerpLighting(t,e,i){if(j(this._mainLight.intensity,t.mainLight.intensity,e.mainLight.intensity,i),this._mainLight.environmentStrength=c(t.mainLight.environmentStrength,e.mainLight.environmentStrength,i),this._mainLight.specularStrength=c(t.mainLight.specularStrength,e.mainLight.specularStrength,i),h(this._mainLight.direction,e.mainLight.direction),this._mainLight.castShadows=e.mainLight.castShadows,this.globalFactor=c(t.globalFactor,e.globalFactor,i),this.noonFactor=c(t.noonFactor,e.noonFactor,i),t.sh.r.length===e.sh.r.length)for(let s=0;s<e.sh.r.length;s++)this._sphericalHarmonics.r[s]=c(t.sh.r[s],e.sh.r[s],i),this._sphericalHarmonics.g[s]=c(t.sh.g[s],e.sh.g[s],i),this._sphericalHarmonics.b[s]=c(t.sh.b[s],e.sh.b[s],i);else for(let s=0;s<e.sh.r.length;s++)this._sphericalHarmonics.r[s]=e.sh.r[s],this._sphericalHarmonics.g[s]=e.sh.g[s],this._sphericalHarmonics.b[s]=e.sh.b[s]}},U=m();var nt=class{constructor(t,e){this._module=t,this._load=e}get(){return this._module}reload(){return L(this,null,function*(){return this._module=yield this._load(),this._module})}};var x=class{constructor(t,e,i){this._context=t,this._locations=i,this._textures=new Map,this._freeTextureUnits=new O({deallocator:null}),this._glProgram=t.programCache.acquire(e.generate("vertex",!0),e.generate("fragment",!0),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=e.generateBind(this),this.bindPass=e.generateBindPass(this),this.bindDraw=e.generateBindDraw(this),this._fragmentUniforms=$()?e.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(t,e){this._glProgram.setUniform1i(t,e?1:0)}setUniform1i(t,e){this._glProgram.setUniform1i(t,e)}setUniform1f(t,e){this._glProgram.setUniform1f(t,e)}setUniform2fv(t,e){this._glProgram.setUniform2fv(t,e)}setUniform3fv(t,e){this._glProgram.setUniform3fv(t,e)}setUniform4fv(t,e){this._glProgram.setUniform4fv(t,e)}setUniformMatrix3fv(t,e){this._glProgram.setUniformMatrix3fv(t,e)}setUniformMatrix4fv(t,e){this._glProgram.setUniformMatrix4fv(t,e)}setUniform1fv(t,e){this._glProgram.setUniform1fv(t,e)}setUniform1iv(t,e){this._glProgram.setUniform1iv(t,e)}setUniform2iv(t,e){this._glProgram.setUniform2iv(t,e)}setUniform3iv(t,e){this._glProgram.setUniform3iv(t,e)}setUniform4iv(t,e){this._glProgram.setUniform4iv(t,e)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,e){if(e?.glName==null){let s=this._textures.get(t);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(t)),null}let i=this._textures.get(t);return i==null?(i=this._allocTextureUnit(e),this._textures.set(t,i)):i.texture=e,this._context.useProgram(this),this.setUniform1i(t,i.unit),this._context.bindTexture(e,i.unit),i.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((t,e)=>{this._context.bindTexture(t.texture,t.unit),this.setUniform1i(e,t.unit)}),this._fragmentUniforms?.forEach(t=>{t.type!=="sampler2D"&&t.type!=="samplerCube"||this._textures.has(t.name)||console.error(`Texture sampler ${t.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}};var bt=()=>N.getLogger("esri.views.3d.webgl.ShaderTechnique"),ot=class{constructor(t,e,i,s=J){this.locations=s,this.primitiveType=Q.TRIANGLES,this.key=e.key,this._program=new x(t.rctx,i.get().build(e),s),this._pipeline=this.initializePipeline(e),this.reload=a=>L(this,null,function*(){a&&(yield i.reload()),this.key.equals(e.key)||bt().warn("Configuration was changed after construction, cannot reload shader.",i),R(this._program),this._program=new x(t.rctx,i.get().build(e),s),this._pipeline=this.initializePipeline(e)})}destroy(){this._program=R(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}getPipeline(t,e){return this._pipeline}initializePipeline(t){return Z({blending:K,colorWrite:Y})}};var C,at;(function(r){r.OPAQUE="opaque-color",r.TRANSPARENT="transparent-color",r.COMPOSITE="composite-color",r.FINAL="final-color"})(C||(C={})),function(r){r.SSAO="ssao",r.LASERLINES="laserline-color",r.ANTIALIASING="aa-color",r.HIGHLIGHTS="highlight-color",r.MAGNIFIER="magnifier-color",r.OCCLUDED="occluded-color",r.VIEWSHED="viewshed-color",r.OPAQUE_ENVIRONMENT="opaque-environment-color",r.TRANSPARENT_ENVIRONMENT="transparent-environment-color",r.FOCUSAREA="focus-area"}(at||(at={}));var ht,lt;(function(r){r[r.RED=0]="RED",r[r.RG=1]="RG",r[r.RGBA4=2]="RGBA4",r[r.RGBA=3]="RGBA",r[r.RGBA_MIPMAP=4]="RGBA_MIPMAP",r[r.R16F=5]="R16F",r[r.RGBA16F=6]="RGBA16F"})(ht||(ht={})),function(r){r[r.DEPTH_STENCIL_TEXTURE=0]="DEPTH_STENCIL_TEXTURE",r[r.DEPTH16_BUFFER=1]="DEPTH16_BUFFER"}(lt||(lt={}));var f=class extends D{constructor(r){super(r),this.view=null,this.consumes={required:[]},this.produces=C.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([G(()=>this.view.ready,r=>{r&&this.view._stage?.renderer.addRenderNode(this)},V)])}destroy(){this.view._stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new I("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view._stage.renderView.renderingContext.gl}get techniques(){return this.view._stage.renderView.techniques}acquireOutputFramebuffer(){let r=this._frameBuffer?.getTexture()?.descriptor,t=this.view._stage.renderer.fboCache.acquire(r?.width??640,r?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(r){r===X.UPDATE&&this.view._stage?.renderView.requestRender(r),this._dirty=!0}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view._stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view._stage.renderView.renderingContext}get renderContext(){return this.view._stage?.renderer.renderContext}updateAnimation(r){return!!this._dirty&&(this._dirty=!1,!0)}doRender(r){this._frameBuffer=r.find(({name:t})=>t===this.produces);try{return this.render(r)}finally{this._frameBuffer=null}}};d([b({constructOnly:!0})],f.prototype,"view",void 0),d([b({constructOnly:!0})],f.prototype,"consumes",void 0),d([b()],f.prototype,"produces",void 0),d([b({readOnly:!0})],f.prototype,"techniques",null),f=d([B("esri.views.3d.webgl.RenderNode")],f);var le=f;export{nt as a,ot as b,C as c,at as d,ht as e,lt as f,le as g,v as h,_t as i,st as j};
