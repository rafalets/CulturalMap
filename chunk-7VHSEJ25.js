import{b as bs}from"./chunk-M7JJUQ72.js";import{a as Ve,b as Ht,c as vs,d as Os,g as Cs,j as Ls,m as Hs}from"./chunk-TBX4IK4K.js";import{b as Is}from"./chunk-7N2BD2NB.js";import{a as As,c as Es}from"./chunk-RZVJEXV6.js";import{a as ws,c as Rs}from"./chunk-EJVEY5BL.js";import{a as ne,b as Fs,d as Vs}from"./chunk-45D2EG5D.js";import{b as Ns}from"./chunk-E5JLMNB6.js";import{b as Ms}from"./chunk-VZB227JA.js";import{b as Ps}from"./chunk-757YQ6CM.js";import{a as Ss,c as He,f as Ds}from"./chunk-WJ6C4VZW.js";import{a as _s,c as X,d as ys}from"./chunk-K57Y3IIR.js";import{a as Vt}from"./chunk-TTCWVZMG.js";import{d as Ts}from"./chunk-K2IZFVKY.js";import{a as Fe}from"./chunk-W5OI4BJ2.js";import{a as qr}from"./chunk-NOHUHVCW.js";import{D as as,G as os,I as ns,J as hs,e as Gr,g as Kr,h as $r,i as es,k as ts,l as rs,m as ss,o as is,r as b}from"./chunk-P64DWRJ7.js";import{a as Br,b as jr,d as ms}from"./chunk-4MYROXQR.js";import{a as ps,b as P}from"./chunk-L5JJXC3A.js";import{a as Nr,e as ae}from"./chunk-DBZKWPEX.js";import{a as Z,b as ie,d as Le,e as Wr}from"./chunk-AYSSTKZP.js";import{a as D,b as M,d as lt,e as q,f as cs,g as ds,h as us,j as ct}from"./chunk-WXB3UZNT.js";import{a as zr,d as kr,g as Yr}from"./chunk-7VWXQFPJ.js";import{d as fe,f as Jr,h as A,i as E}from"./chunk-FZ5X7HOK.js";import{b as Ur,c as Zr,j as Xr,k as ge,o as ht,v as Ft}from"./chunk-3D4Y6BLC.js";import{a as oe}from"./chunk-OTUHXNWB.js";import{b as ls}from"./chunk-NBT2WTKD.js";import{a as Qr}from"./chunk-L7NOU4T2.js";import{a as at}from"./chunk-B564E6X6.js";import{b as B}from"./chunk-TBHSFWI7.js";import{a as v,f as Hr,h as Ee,j as it,o as Lt}from"./chunk-3AS27HNO.js";import{a as y}from"./chunk-RWCIDBNQ.js";import{a as Ae,c as se}from"./chunk-ONYJLWAD.js";import{c as Pt,d as Ie}from"./chunk-7YU5I7BM.js";import{e as Sr}from"./chunk-TKZJUAKL.js";import{g as xs}from"./chunk-R3KYOH5H.js";import{e as gs,f as fs}from"./chunk-NFWLUI2Z.js";import{i as nt,k as j}from"./chunk-BUZBVNOM.js";import{a as ot}from"./chunk-3Q427ME6.js";import{f as Fr,g as Vr}from"./chunk-3BZAI7HK.js";import{a as G,b as Ar,h as re,k as rt,m as st,n as Er,r as Et,x as Lr}from"./chunk-HM5RIVQC.js";import{j as Dr}from"./chunk-SKMO433W.js";import{a as x}from"./chunk-2FO7ARYZ.js";import{a as Mr,b as U,c as Y,d as ee,g as te,j as It,m as Pr,n as At,o as C,q as me,z as Ir}from"./chunk-QXXXCEV5.js";import{a as V,d as pe}from"./chunk-ALWV3RJ2.js";import{a as Rr}from"./chunk-7C6Z24SS.js";import{C as wr,b as Cr,c as et,r as br,x as tt}from"./chunk-5WKDXHVH.js";import{a as ue,f as Pe,g as Or}from"./chunk-PTZYZULI.js";import{b as Mt,k as vr}from"./chunk-KZKWOEFD.js";import{A as Tr,a as fr,f as _r,g as Me,h as Dt,n as yr,z as xr}from"./chunk-7B2UKJ5N.js";import{a as $e,c as Rt}from"./chunk-TRZXSDYA.js";import{a as St,g as pr}from"./chunk-NHSDW26F.js";import{e as mr,g as gr}from"./chunk-NMAGYK3Q.js";import{a as De,b as ur,t as wt}from"./chunk-3SDSCSDJ.js";import{b as or,d as nr,i as hr}from"./chunk-VOFKUGRY.js";import{N as dr}from"./chunk-IG66NQHW.js";import{a as Q,c as cr,h as Se,i as bt}from"./chunk-LB5YQINJ.js";import{a as lr}from"./chunk-VACZNAP3.js";import{F as ar,d as F,v as Ke}from"./chunk-C7INQGWT.js";import{H as de,a as ce}from"./chunk-WMHJC7XF.js";import{a as ir}from"./chunk-3TQOUBNU.js";import{j as $,m as k}from"./chunk-D2LVMNOU.js";import{a as m}from"./chunk-QGVBCWUY.js";import{r as sr}from"./chunk-HHDFN2GK.js";import{a as rr}from"./chunk-47GHT6OF.js";import{a as er,b as tr}from"./chunk-VTHXE323.js";var Ne=class{constructor(){this._extent=De(),this.resolution=0,this.renderLocalOrigin=Cs(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Nt}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryView();let r=.001*e.range;if(this._extent[0]-r<=e.min){let s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];wt(this._extent,e.range,0,s)}if(this._extent[2]+r>=e.max){let s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];wt(this._extent,-e.range,0,s)}}setupGeometryView(){this.canvasGeometries.numViews=1,ur(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},Nt=class{constructor(){this.extents=[De(),De(),De()],this.numViews=0}};var T;(function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(T||(T={}));var dt=class{constructor(e,r,s){this._fbos=e,this._format=r,this._name=s}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=k(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,r,s){this._handle&&this._handle.fbo?.width===r&&this._handle.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(r,s,this._name,this._format)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}};var J=class{constructor(e,r,s,a,i=q.RGBA_MIPMAP){this.output=s,this.content=a,this.fbo=new dt(e,i,r)}get valid(){return this.fbo.valid}},ut=class{constructor(e){this.targets=[new J(e,"overlay color",v.Color,T.Color),new J(e,"overlay IM color",v.Color,T.ColorNoRasterImage),new J(e,"overlay highlight",v.Highlight,T.Highlight,q.RG),new J(e,"overlay water",v.Normal,T.WaterNormal),new J(e,"overlay occluded",v.Color,T.Occluded)],at()&&this.targets.push(new J(e,"overlay olid",v.ObjectAndLayerIdColor,T.ObjectAndLayerIdColor,q.RGBA))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(let e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,s)=>r.valid?e|=1<<s:e,0)}};var qt;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight",t[t.ViewshedShadowMap=3]="ViewshedShadowMap"})(qt||(qt={}));var he;(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(he||(he={}));var ga=ue();var qe=class extends M{constructor(e,r){super(e,r,new D(Ms,()=>import("./chunk-R7L5FVSV.js")))}initializePipeline(){return E({blending:fe,colorWrite:A})}};var We=class extends M{constructor(e,r){super(e,r,new D(Ds,()=>import("./chunk-JLHP6KY6.js")))}initializePipeline(){return E({colorWrite:A})}};var pt=class extends Qr{constructor(){super(...arguments),this.occludedFactor=xs,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};var Ue=class extends M{constructor(e,r){super(e,r,new D(Ps,()=>import("./chunk-KDQH7TNT.js")))}initializePipeline(){return E({colorWrite:A})}};var Ge=class extends M{constructor(e,r){super(e,r,new D(Is,()=>import("./chunk-M2LW5MSV.js")))}initializePipeline(){return E({blending:fe,colorWrite:A})}};var Be=class extends M{constructor(e,r){super(e,r,new D(Es,()=>import("./chunk-MWZJQZIF.js")))}initializePipeline(){return E({colorWrite:A})}};var qs=[],Ya=[new Fe(y.POSITION,3,re.FLOAT,0,12)],Za=[new Fe(y.POSITION,2,re.FLOAT,0,8)],Xa=[new Fe(y.POSITION,2,re.FLOAT,0,16),new Fe(y.UV0,2,re.FLOAT,8,16)];var mt=class extends ds{constructor(){super(...arguments),this.produces=lt.HIGHLIGHTS,this.consumes={required:[lt.HIGHLIGHTS,"highlights"]},this._useMultipleHighlights=!1,this._downsampleDrawParameters=new Ss,this._passParameters=new pt,this._singleHighlightBlurDrawParameters=new As,this._grid=new Wt}initialize(){this.addHandles([Q(()=>this._updateOptionsTexture(),()=>{},Se)])}destroy(){this._grid.coverage=k(this._grid.coverage),this._grid.vao=$(this._grid.vao),this._passParameters.highlightOptionsTexture=k(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){let t=new nt(16,2);t.internalFormat=Er.RGBA,t.samplingMode=rt.NEAREST,this._passParameters.highlightOptionsTexture=new j(this.renderingContext,t,null)}this._passParameters.highlightOptionsTexture.setData(ii(this.view.state.highlights)),this.requestRender(se.UPDATE)}precompile(){this.techniques.precompile(We),this._useMultipleHighlights?this.techniques.precompile(qe):(this.techniques.precompile(Ue),this.techniques.precompile(Be),this.techniques.precompile(Ge))}render(t){let e=t.find(({name:f})=>f===lt.HIGHLIGHTS),{techniques:r,bindParameters:s,_passParameters:a,renderingContext:i}=this;if(!s.decorations)return e;let o=r.get(We);if(!o.compiled)return this.requestRender(se.UPDATE),e;let n=t.find(({name:f})=>f==="highlights").getTexture(),h=()=>{this._gridUpdateResources(n);let f=this._gridComputeCoverage(o,n,s),{horizontalCellCount:p,verticalCellCount:S}=f;return a.horizontalCellCount=p,a.verticalCellCount=S,a.coverageTexture=f.coverage?.getTexture(),f},d=f=>{let p=f.verticalCellCount*f.horizontalCellCount;i.bindVAO(f.vao),i.drawElementsInstanced(Ar.TRIANGLES,6,re.UNSIGNED_BYTE,0,p)},{camera:u}=s,g=()=>{i.bindFramebuffer(e.fbo),i.setViewport4fv(u.fullViewport)};return this._useMultipleHighlights?this._renderMultiple(n,h,d,g):this._renderSingle(n,h,d,g),a.highlightTexture=null,a.coverageTexture=null,e}_renderMultiple(t,e,r,s){let{techniques:a,bindParameters:i,_passParameters:o,renderingContext:n}=this,h=a.get(qe);if(!h.compiled)return void this.requestRender(se.UPDATE);let d=e();o.highlightTexture=t,o.pixelRatio=i.camera.pixelRatio,n.bindTechnique(h,i,o),s(),r(d)}_renderSingle(t,e,r,s){let{fboCache:a,techniques:i,bindParameters:o,_passParameters:n,renderingContext:h}=this,d=i.get(Ue),u=i.get(Be),g=i.get(Ge);if(!g.compiled||!u.compiled||!d.compiled)return void this.requestRender(se.UPDATE);let f=e(),{width:p,height:S}=t.descriptor;n.highlightTexture=t;let{camera:Ce}=o,{fullWidth:be,fullHeight:Ot,pixelRatio:Ze}=Ce,we=Math.ceil(be/Ze),Re=Math.ceil(Ot/Ze),{_singleHighlightBlurDrawParameters:_}=this,I=this.view._stage.renderView.renderer,{highlights:$t}=o;for(let Xe=0;Xe<$t.length;++Xe){let{name:si}=$t[Xe];if(!I.hasHighlightOptions(si))continue;n.highlightLevel=Xe,h.setClearColor(0,0,0,0);let Ct=a.acquire(p,S,"single highlight",q.RG);h.bindFramebuffer(Ct.fbo),h.setViewport(0,0,p,S),h.clear(G.COLOR),h.bindTechnique(d,o,n),r(f),_.blurInput=Ct.getTexture(),U(_.blurSize,1/we,0);let Je=a.acquire(we,Re,"single highlight blur h",q.RG);h.unbindTexture(Je.fbo?.colorTexture),h.bindFramebuffer(Je.fbo),h.setViewport(0,0,we,Re),h.clear(G.COLOR),h.bindTechnique(u,o,n,_),r(f),Ct.release(),U(_.blurSize,0,1/Re),n.singleHighlightBlurTexture=Je.getTexture(),s(),h.bindTechnique(g,o,n,_),r(f),Je.release()}}_gridUpdateResources(t){let e=this._grid,{width:r,height:s}=t.descriptor;if(e.horizontalCellCount=Math.ceil(r/He),e.verticalCellCount=Math.ceil(s/He),e.vao)return;let a=this.renderingContext,i=Vt.createIndex(a,Et.STATIC_DRAW,oi);e.vao=new ys(a,Zr,new Map([["geometry",qs]]),new Map([["geometry",Vt.createVertex(a,Et.STATIC_DRAW)]]),i)}_gridComputeCoverage(t,e,r){let s=this.renderingContext,a=this._grid,i=e.descriptor,o=Math.ceil(i.width/He),n=Math.ceil(i.height/He);this._downsampleDrawParameters.input=e,a.coverage?.release();let h=this.fboCache.acquire(o,n,"highlight coverage",q.RG);return a.coverage=h,s.bindFramebuffer(h.fbo),s.bindTechnique(t,r,this._passParameters,this._downsampleDrawParameters),s.setViewport(0,0,o,n),s.screen.draw(),a}get test(){}};m([F()],mt.prototype,"produces",void 0),m([F()],mt.prototype,"consumes",void 0),mt=m([de("esri.views.3d.webgl-engine.effects.highlight.Highlight")],mt);var Wt=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function ii(t){let e=new Uint8Array(128),r=0;for(let s of t){let a=4*r,i=4*r+64;++r;let{color:o}=s,n=s.haloColor??o;e[a+0]=o.r,e[a+1]=o.g,e[a+2]=o.b,e[a+3]=s.fillOpacity*o.a*255,e[i+0]=n.r,e[i+1]=n.g,e[i+2]=n.b,e[i+3]=s.haloOpacity*n.a*255}return e}var ai=0;function Ws(t){let e=0;for(let s of t){let{name:a}=s;e+=a.length;let{color:i,fillOpacity:o,haloColor:n,haloOpacity:h}=s;e+=i.r+i.g+i.b+i.a+o,e+=n?n.r+n.g+n.b+n.a+h:0}let r=t.at(0);if(r){let{shadowOpacity:s,shadowDifference:a,shadowColor:i}=r;e+=s+a+i.r+i.g+i.b+i.a}return ai+++(e>=0?0:1)}var oi=new Uint8Array([0,1,2,2,1,3]);function Us(t,e,r,s,a,i=0){let o=s.highlights,n=o.length>1?e.acquire(r.width,r.height,"highlight mix",q.RG):null;if(n){let d=t.getBoundFramebufferObject();t.bindFramebuffer(n.fbo),t.clearFramebuffer(Pe),t.bindFramebuffer(d)}let h=n?.getTexture();s.highlightMixTexture=h,U(s.highlightMixOrigin,i,0),o.forEach((d,u)=>{u>0&&(t.bindTexture(h,j.TEXTURE_UNIT_FOR_UPDATES),t.gl.copyTexSubImage2D(st.TEXTURE_2D,0,0,0,i,0,r.width,r.height),t.bindTexture(null,j.TEXTURE_UNIT_FOR_UPDATES)),t.clear(G.DEPTH),s.highlightLevel=u,a()}),s.highlightLevel=null,s.highlightMixTexture=null,n?.release()}var gt=class{constructor(e,r,s,a){this._textures=e,this._techniques=r,this.materialChanged=s,this.requestRender=a,this._id2glMaterialRef=new qr}dispose(){this._textures.destroy()}acquire(e,r,s){if(this._ownMaterial(e),!e.produces.get(r)?.(s))return null;let i=this._id2glMaterialRef.get(s,e.id);if(i==null){let o=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:s});i=new Ut(o),this._id2glMaterialRef.set(s,e.id,i)}return i.ref(),i.glMaterial}release(e,r){let s=this._id2glMaterialRef.get(r,e.id);s!=null&&(s.unref(),s.referenced||($(s.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&sr.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Ut=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,Z(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var _e;(function(t){t[t.Immediate=0]="Immediate",t[t.FadeWithWeather=1]="FadeWithWeather"})(_e||(_e={}));var ft=class{constructor(e){this.shadowMap=e,this.slot=b.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=oe.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new X,this._inverseViewport=x(),this._oldLighting=new ct,this._newLighting=new ct,this._fadedLighting=new ct,this._lighting=this._newLighting,this.ssr=new Gt,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=x(),this.highlightMixTexture=null,this.hudRenderStyle=Ts.Occluded,this.hudOccludedFragmentOpacity=1,this.clouds=new bs,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,r,s,a){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=s,this._newLighting.set(e),a===_e.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Gt=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=V()}};var _t=class{constructor(e,r){this.rctx=e,this.lastFrameCamera=new X,this.output=v.Color,this.renderOccludedMask=je,this.bind=new ft(r),this.bind.alignPixelEnabled=!0}};var je=ge.Occlude|ge.OccludeAndTransparent|ge.OccludeAndTransparentStencil;var ye=class extends X{constructor(){super(...arguments),this._projectionMatrix=V()}get projectionMatrix(){return this._projectionMatrix}};m([F()],ye.prototype,"_projectionMatrix",void 0),m([F({readOnly:!0})],ye.prototype,"projectionMatrix",null),ye=m([de("esri.views.3d.webgl-engine.lib.CascadeCamera")],ye);var kt;(function(t){t[t.Highlight=0]="Highlight",t[t.ExcludeHighlight=1]="ExcludeHighlight"})(kt||(kt={}));var Oe=class{constructor(){this.camera=new ye,this.lightMat=V()}},Qt=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},xt=class{constructor(e,r){this._fbos=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Qt,this._projectionView=V(),this._projectionViewInverse=V(),this._modelViewLight=V(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=ue(),this._cascades=[new Oe,new Oe,new Oe,new Oe],this._lastOrigin=null,this._maxTextureWidth=Math.min(rr("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Mt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=k(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=or(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)jt[e]=this._cascades[e];return jt.length=this._numCascades,jt}start(e,r,s,a,i){Z(this.enabled);let{near:o,far:n}=ui(s);this._computeCascadeDistances(o,n,a),this._textureHeight=this._computeTextureHeight(e,i,a),this._setupMatrices(e,r);let{viewMatrix:h,projectionMatrix:d}=e;for(let u=0;u<this._numCascades;++u)this._constructCascade(u,d,h,r);this._lastOrigin=null,this.clear()}finish(){Z(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!wr(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||St(),Cr(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){Dt(Qs,this._cascades[r].lightMat,e);for(let s=0;s<16;++s)Ys[16*r+s]=Qs[s]}}return Ys}moveSnapshot(e){Z(this.enabled),this._handle?.detachDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){let r=this._handle?.getTexture()?.descriptor;if(!this.enabled||!r)return;this._snapshots[e]?.release();let{width:s,height:a}=r,i=e===kt.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(s,a,i,q.RGBA4);let o=this._fbos.rctx;this._bindFbo();let n=o.bindTexture(this._snapshots[e]?.getTexture(),j.TEXTURE_UNIT_FOR_UPDATES);o.gl.copyTexSubImage2D(st.TEXTURE_2D,0,0,0,0,0,s,a),o.bindTexture(n,j.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture():null}clear(){let e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clear(G.COLOR|G.DEPTH)}_computeTextureHeight(e,r,s){let a=Math.min(window.devicePixelRatio,r)/e.pixelRatio,i=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,o=Br(Math.floor(Math.max(e.fullWidth,e.fullHeight)*a*i)),n=Math.min(this._maxTextureWidth,this._numCascades*o);return jr(n/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",q.RGBA4)),this._handle?.acquireDepth(cs.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=k(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,r,s,a){let i=this._cascades[e],o=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],h=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),d=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]);Z(h<d);for(let p=0;p<8;++p){Mt(Gs,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?h:d,1);let S=W[p];vr(S,Gs,this._projectionViewInverse),S[0]/=S[3],S[1]/=S[3],S[2]/=S[3]}br(Bt,W[0]),i.camera.viewMatrix=Dt(ni,this._modelViewLight,Bt);for(let p=0;p<8;++p)tt(W[p],W[p],i.camera.viewMatrix);let u=W[0][2],g=W[0][2];for(let p=1;p<8;++p)u=Math.min(u,W[p][2]),g=Math.max(g,W[p][2]);u-=200,g+=200,i.camera.near=-g,i.camera.far=-u,di(s,a,u,g,i.camera),Me(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);let f=this._textureHeight;i.camera.viewport=[e*f,0,f,f]}_setupMatrices(e,r){Me(this._projectionView,e.projectionMatrix,e.viewMatrix),_r(this._projectionViewInverse,this._projectionView);let s=this._viewingMode===ot.Global?e.eye:et(Bt,0,0,1);Tr(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],s)}_computeCascadeDistances(e,r,s){let a=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Wr(r/e,4)),a);let i=(r-e)/this._numCascades,o=(r/e)**(1/this._numCascades),n=e,h=e;for(let d=0;d<this._numCascades+1;++d)this._cascadeDistances[d]=nr(n,h,this.settings.splitSchemeLambda),n*=o,h+=i}get test(){}},ni=V(),Gs=ue(),W=[];for(let t=0;t<8;++t)W.push(ue());var Bs=x(),js=x(),hi=x(),zs=x(),ks=x(),Bt=St(),jt=[],Qs=V(),Ys=pe.concat(pe,pe,pe,pe),N=x(),xe=x(),le=[x(),x(),x(),x()],O=x(),zt=x(),K=x(),ze=x(),Te=x(),ve=x(),yt=x();function li(t,e,r,s,a,i,o,n){U(N,0,0);for(let _=0;_<4;++_)Y(N,N,t[_]);te(N,N,.25),U(xe,0,0);for(let _=4;_<8;++_)Y(xe,xe,t[_]);te(xe,xe,.25),me(le[0],t[4],t[5],.5),me(le[1],t[5],t[6],.5),me(le[2],t[6],t[7],.5),me(le[3],t[7],t[4],.5);let h=0,d=It(le[0],N);for(let _=1;_<4;++_){let I=It(le[_],N);I<d&&(d=I,h=_)}ee(O,le[h],t[h+4]);let u=O[0],g,f;O[0]=-O[1],O[1]=u,ee(zt,xe,N),C(zt,O)<0&&Pr(O,O),me(O,O,zt,r),At(O,O),g=f=C(ee(K,t[0],N),O);for(let _=1;_<8;++_){let I=C(ee(K,t[_],N),O);I<g?g=I:I>f&&(f=I)}Mr(s,N),te(K,O,g-e),Y(s,s,K);let p=-1,S=1,Ce=0,be=0;for(let _=0;_<8;++_){ee(ze,t[_],s),At(ze,ze);let I=O[0]*ze[1]-O[1]*ze[0];I>0?I>p&&(p=I,Ce=_):I<S&&(S=I,be=_)}ie(p>0,"leftArea"),ie(S<0,"rightArea"),te(Te,O,g),Y(Te,Te,N),te(ve,O,f),Y(ve,ve,N),yt[0]=-O[1],yt[1]=O[0];let Ot=Le(s,t[be],ve,Y(K,ve,yt),1,a),Ze=Le(s,t[Ce],ve,K,1,i),we=Le(s,t[Ce],Te,Y(K,Te,yt),1,o),Re=Le(s,t[be],Te,K,1,n);ie(Ot,"rayRay"),ie(Ze,"rayRay"),ie(we,"rayRay"),ie(Re,"rayRay")}function c(t,e){return 3*e+t}var Zs=x();function H(t,e){return U(Zs,t[e],t[e+3]),Zs}var L=x(),l=Rr();function ci(t,e,r,s,a){ee(L,r,s),te(L,L,.5),l[0]=L[0],l[1]=L[1],l[2]=0,l[3]=L[1],l[4]=-L[0],l[5]=0,l[6]=L[0]*L[0]+L[1]*L[1],l[7]=L[0]*L[1]-L[1]*L[0],l[8]=1,l[c(0,2)]=-C(H(l,0),t),l[c(1,2)]=-C(H(l,1),t);let i=C(H(l,0),r)+l[c(0,2)],o=C(H(l,1),r)+l[c(1,2)],n=C(H(l,0),s)+l[c(0,2)],h=C(H(l,1),s)+l[c(1,2)];i=-(i+n)/(o+h),l[c(0,0)]+=l[c(1,0)]*i,l[c(0,1)]+=l[c(1,1)]*i,l[c(0,2)]+=l[c(1,2)]*i,i=1/(C(H(l,0),r)+l[c(0,2)]),o=1/(C(H(l,1),r)+l[c(1,2)]),l[c(0,0)]*=i,l[c(0,1)]*=i,l[c(0,2)]*=i,l[c(1,0)]*=o,l[c(1,1)]*=o,l[c(1,2)]*=o,l[c(2,0)]=l[c(1,0)],l[c(2,1)]=l[c(1,1)],l[c(2,2)]=l[c(1,2)],l[c(1,2)]+=1,i=C(H(l,1),e)+l[c(1,2)],o=C(H(l,2),e)+l[c(2,2)],n=C(H(l,1),r)+l[c(1,2)],h=C(H(l,2),r)+l[c(2,2)],i=-.5*(i/o+n/h),l[c(1,0)]+=l[c(2,0)]*i,l[c(1,1)]+=l[c(2,1)]*i,l[c(1,2)]+=l[c(2,2)]*i,i=C(H(l,1),e)+l[c(1,2)],o=C(H(l,2),e)+l[c(2,2)],n=-o/i,l[c(1,0)]*=n,l[c(1,1)]*=n,l[c(1,2)]*=n,a[0]=l[0],a[1]=l[1],a[2]=0,a[3]=l[2],a[4]=l[3],a[5]=l[4],a[6]=0,a[7]=l[5],a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=l[6],a[13]=l[7],a[14]=0,a[15]=l[8]}function di(t,e,r,s,a){let i=1/W[0][3],o=1/W[4][3];Z(i<o);let n=i+Math.sqrt(i*o),h=Math.sin(hr(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));n/=h,li(W,n,h,Bs,js,hi,zs,ks),ci(Bs,js,zs,ks,a.projectionMatrix),a.projectionMatrix[10]=2/(r-s),a.projectionMatrix[14]=-(r+s)/(r-s)}function ui(t){let{near:e,far:r}=t;return e<2&&(e=2),r<2&&(r=2),e>=r&&(e=2,r=4),{near:e,far:r}}var ke=class extends M{constructor(e,r){super(e,r,new D(Rs,()=>import("./chunk-YX4HIJB6.js")))}initializePipeline(e){return e.hasAlpha?E({blending:fe,colorWrite:A}):E({colorWrite:A})}};var Qe=class extends ps{constructor(){super(...arguments),this.hasAlpha=!1}};m([P()],Qe.prototype,"hasAlpha",void 0);var Ye=class extends M{constructor(e,r){super(e,r,new D(Vs,()=>import("./chunk-JJ3PZ7TC.js")))}};var z=class extends _s{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Fs,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new ir,this._passParameters=new ws,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new X,this.events=new lr,this.longitudeCyclical=null,this.produces=new Map([[b.DRAPED_MATERIAL,e=>e!==v.Highlight||this.hasHighlights],[b.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){let t=this._view,e=t._stage,r=e.renderer.fboCache,{waterTextures:s,textures:a}=e.renderView;this._renderContext=new _t(this._rctx,new xt(r,t.state.viewingMode)),this.addHandles([Q(()=>s.updating,()=>this.events.emit("content-changed"),bt),Q(()=>this.spatialReference,n=>this._localOriginFactory=new Ls(n),bt),cr(()=>t.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),Q(()=>Ws(t.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,Se),Q(()=>t.state.highlights,n=>{this._bindParameters.highlights=n,this._bindParameters.highlightOrderMap=t.state.highlightOrderMap,this._updateHighlights()},Se),t.resourceController.scheduler.registerTask(gs.STAGE,this)]),this._materials=new gt(a,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));let{_bindParameters:i,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,i.slot=b.DRAPED_MATERIAL,i.mainDepth=null,i.camera=o,i.oitPass=oe.NONE,i.updateLighting([new us(pr())],0,0,_e.Immediate)}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._passParameters.texture=$(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view._stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(t){this._pluginContext=t,this._techniques.precompile(Ye)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||ce(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(let e of this._renderers.values()){let r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t)}_updateHighlights(){let t=this._view.state;this._renderers.forEach(e=>e.updateHighlights(t.highlightOrderMap))}createDrapeSourceRenderer(t,e,r){let s=this._renderers.get(t);s?.destroy();let a=new e(tr(er({},r),{rendererContext:this,drapeSource:t}));return this._renderers.set(t,a),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(Q(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),a}removeDrapeSourceRenderer(t){if(t==null)return;let e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&Ke(t,e=>e.drapeTargetType===vs.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=Ke(t,e=>e.drapeSourceType===Ve.Features),this._hasDrapedRasterSource=Ke(t,e=>e.drapeSourceType===Ve.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new ut(this._stage.renderer.fboCache),this._overlays=[new Ne,new Ne]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=$(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){if(t!=null)return t===T.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(T.Color):this._renderTargets?.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(let[s,a]of this._renderers){if(t.done)break;(s.destroyed||e(s))&&a.commitChanges(this._view.state.highlightOrderMap)&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=ce(this._renderers,s=>s.hasHighlights),this.notifyChange("rendersOccludedDraped"))}hasHighlightOptions(t){return ce(this._renderers,e=>e.hasHighlightOptions(t))}processSyncDrapeSources(){this._processDrapeSources(fs,t=>t.updatePolicy===Os.SYNC)}get isEmpty(){return!ht.OVERLAY_DRAW_DEBUG_TEXTURE&&!ce(this._renderers,t=>!t.isEmpty)}get hasWater(){let t=ce(this._renderers,e=>e.hasWater);return t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){let t=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Yt,++this._techniques.precompiling;let e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=t,e}renders(t){if(ht.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==T.Occluded&&t!==T.Highlight)return!0;++this._techniques.precompiling;let e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,e}get mode(){return this.isEmpty?he.Disabled:this.hasWater&&this.renders(T.WaterNormal)?he.EnabledWithWater:this._renderTargets?.getTexture(T.Color)?he.Enabled:he.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e&&this.parent.requestRender(se.BACKGROUND),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(t){if(this._renderTargets){this._bindParameters.alignPixelEnabled=t.alignPixelEnabled,++this._techniques.precompiling;for(let e of this._renderTargets.targets){if(e.content===T.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=e.output;this._renderContext.output=r,this._bindParameters.slot=r===v.Normal?b.DRAPED_WATER:b.DRAPED_MATERIAL,e.content===T.Occluded&&(this._renderContext.renderOccludedMask=Yt),this._sortedRenderers.forAll(({drapeSource:s,renderer:a})=>{e.content===T.ColorNoRasterImage&&s.drapeSourceType===Ve.RasterImage||a.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=je}--this._techniques.precompiling}}drawOverlays(t){if(this._overlays&&this._renderTargets){for(let e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryView();this._bindParameters.alignPixelEnabled=t.alignPixelEnabled;for(let e of this._renderTargets.targets){if(e.content===T.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=this._drawTarget(ne.INNER,e),s=this._drawTarget(ne.OUTER,e);(r||s)&&e.fbo.generateMipMap()}}}_drawTarget(t,e){let r=this._overlays[t],s=r.canvasGeometries;if(s.numViews===0)return!1;let a=this._view.state.contentPixelRatio;this._screenToWorldRatio=a*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;let i=e.output;if(this.isEmpty||i===v.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;let{_rctx:o,_camera:n,_renderContext:h,_bindParameters:d}=this;if(n.pixelRatio=r.pixelRatio*a,h.output=i,d.screenToWorldRatio=this._screenToWorldRatio,d.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,d.slot=i===v.Normal?b.DRAPED_WATER:b.DRAPED_MATERIAL,e.content===T.Occluded&&(h.renderOccludedMask=Yt),!this.renders(e.content))return h.renderOccludedMask=je,!1;let{resolution:u}=r,g=t===ne.INNER?0:u;if(o.setViewport(g,0,u,u),this._bindTargetFBO(e),t===ne.INNER&&(o.setClearColor(0,0,0,0),o.clear(G.COLOR)),ht.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==T.Occluded&&e.content!==T.Highlight){this._techniques.precompile(ke,Xt);let f=this._techniques.get(ke,Xt);for(let p=0;p<s.numViews;p++)this._setViewParameters(s.extents[p],r),this._ensureDebugPatternResources(r.resolution,pi[t]),o.bindTechnique(f,d,this._passParameters),o.screen.draw()}if(e.output===v.Highlight){let{fboCache:f}=this._stage.renderer,p=this._resolution;this._bindTargetFBO(e),Us(o,f,{width:p,height:p},d,()=>this._renderAllGeometry(t,e),g)}else this._renderAllGeometry(t,e);return o.bindFramebuffer(null),h.renderOccludedMask=je,!0}_renderAllGeometry(t,e){let r=this._overlays[t],s=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:a,renderer:i})=>{if(e.content===T.ColorNoRasterImage&&a.drapeSourceType===Ve.RasterImage)return;let{fullOpacity:o}=a,n=o!=null&&o<1&&e.output===v.Color&&this._bindTemporaryFBO();for(let h=0;h<s.numViews;h++)this._setViewParameters(s.extents[h],r),i.render(this._renderContext);if(n){this._bindTargetFBO(e),this._overlayParameters.texture=n.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=t;let h=this._techniques.get(Ye);this._rctx.bindTechnique(h,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),n.release()}})}_bindTargetFBO(t){let e=this._resolution,r=2*e;t.fbo.bind(this._rctx,r,e)}_bindTemporaryFBO(){let t=this._resolution,e=2*t,r=this._stage.renderer.fboCache,s=r.acquire(e,t,"overlay tmp");return r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(G.COLOR),s}get _resolution(){return this._overlays?.[ne.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let a=0;for(let{renderer:i}of this._sortedRenderers)a=i.intersect?.(t,e,r,s,a)??a}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let t=this._view.map.allLayers,e=t.length;this._renderers.forEach((r,s)=>{let a=t.indexOf(s.layer),i=a>=0,o=s.renderGroup??(i?Ht.MapLayer:Ht.ViewLayer),n=e*o+(i?a:0);this._sortedRenderers.push(new Zt(s,r,n))}),this._sortedRenderers.sort((r,s)=>r.index-s.index)}_setViewParameters(t,e){let r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],xr(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),yr(r.viewMatrix,[-t[0],-t[1],0])}_ensureDebugPatternResources(t,e){if(et(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;let r=new Uint8Array(t*t*4),s=0;for(let i=0;i<t;i++)for(let o=0;o<t;o++){let n=Math.floor(o/10),h=Math.floor(i/10);n<2||h<2||10*n>t-20||10*h>t-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&n&&1&h?1&o^1&i?0:255:1&n^1&h?0:128)}let a=new nt(t);a.samplingMode=rt.NEAREST,this._passParameters.texture=new j(this._rctx,a,r)}get test(){}};m([F()],z.prototype,"hasHighlights",void 0),m([F()],z.prototype,"_sortedDrapeSourceRenderersDirty",void 0),m([F({constructOnly:!0})],z.prototype,"parent",void 0),m([F({readOnly:!0})],z.prototype,"_techniques",null),m([F({type:Boolean,readOnly:!0})],z.prototype,"updating",null),m([F()],z.prototype,"isEmpty",null),m([F({readOnly:!0})],z.prototype,"rendersOccludedDraped",null),z=m([de("esri.views.3d.terrain.OverlayRenderer")],z);var Zt=class{constructor(e,r,s){this.drapeSource=e,this.renderer=r,this.index=s}},pi=[[1,.5,.5],[.5,.5,1]],Xs=-2,Yt=ge.OccludeAndTransparent,Xt=new Qe;Xt.hasAlpha=!0;var Js=class{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=V(),this._shaderTransformation=null,this._boundingSphere=null,this.id=ar(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){fr(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=V(),Me(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=Vr(),tt(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*Dr(this.shaderTransformation)),this._boundingSphere):Fr}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};var Ks;(function(t){t[t.EnableFastUpdates=0]="EnableFastUpdates",t[t.DisableFastUpdates=1]="DisableFastUpdates",t[t.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"})(Ks||(Ks={}));var w={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},mi={dash:w.dash,"dash-dot":[...w.dash,...w.dot],dot:w.dot,"long-dash":w["long-dash"],"long-dash-dot":[...w["long-dash"],...w.dot],"long-dash-dot-dot":[...w["long-dash"],...w.dot,...w.dot],none:null,"short-dash":w["short-dash"],"short-dash-dot":[...w["short-dash"],...w["short-dot"]],"short-dash-dot-dot":[...w["short-dash"],...w["short-dot"],...w["short-dot"]],"short-dot":w["short-dot"],solid:null},gi=8;function fi(t,e){return t==null?t:{pattern:t.slice(),pixelRatio:e}}function kh(t){return{pattern:[t,t],pixelRatio:2}}function Qh(t){return t?.type==="style"?_i(t.style):null}function _i(t){return t!=null?fi(mi[t],gi):null}function hl(t,e,r=null){let s=[],a=e.mapPositions;yi(e,s);let i=s[0][1].data,o=s[0][1].indices.length,n=Sr(o);return xi(e,s,n),Oi(e,s,n),Ti(e,s,n),vi(e,s,n),Ci(e,s,n),bi(e,s,n),wi(e,s,i),new Gr(t,s,a,Ur.Line,r)}function yi(t,e){let{attributeData:{position:r},removeDuplicateStartEnd:s}=t,a=Ri(r)&&s,i=r.length/3-(a?1:0),o=new Array(2*(i-1)),n=a?r.slice(0,-3):r,h=0;for(let d=0;d<i-1;d++)o[h++]=d,o[h++]=d+1;e.push([y.POSITION,new B(n,o,3,a)])}function xi(t,e,r){if(t.attributeData.colorFeature!=null)return;let s=t.attributeData.color;e.push([y.COLOR,new B(s??Or,r,4)])}function Ti(t,e,r){t.attributeData.normal&&e.push([y.NORMAL,new B(t.attributeData.normal,r,3)])}function vi(t,e,r){t.attributeData.colorFeature!=null&&e.push([y.COLORFEATUREATTRIBUTE,new B([t.attributeData.colorFeature],r,1,!0)])}function Oi(t,e,r){t.attributeData.sizeFeature==null&&e.push([y.SIZE,new B([t.attributeData.size??1],r,1,!0)])}function Ci(t,e,r){t.attributeData.sizeFeature!=null&&e.push([y.SIZEFEATUREATTRIBUTE,new B([t.attributeData.sizeFeature],r,1,!0)])}function bi(t,e,r){t.attributeData.opacityFeature!=null&&e.push([y.OPACITYFEATUREATTRIBUTE,new B([t.attributeData.opacityFeature],r,1,!0)])}function wi(t,e,r){if(t.overlayInfo==null||t.overlayInfo.renderCoordsHelper.viewingMode!==ot.Global||!t.overlayInfo.spatialReference.isGeographic)return;let s=$e(r.length),a=dr(t.overlayInfo.spatialReference);for(let g=0;g<s.length;g+=3)mr(r,g,s,g,a);let i=r.length/3,o=Nr(i+1),n=Si,h=Di,d=0,u=0;U(n,s[u++],s[u++]),u++,o[0]=0;for(let g=1;g<i+1;++g)g===i&&(u=0),U(h,s[u++],s[u++]),u++,d+=Ir(n,h),o[g]=d,[n,h]=[h,n];e.push([y.DISTANCETOSTART,new B(o,e[0][1].indices,1,!0)])}function Ri(t){let e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}var Si=x(),Di=x();function gl(t,e,r,s){let a=t.type==="polygon"?Ie.CCW_IS_HOLE:Ie.NONE,i=t.type==="polygon"?t.rings:t.paths,{position:o,outlines:n}=Pt(i,!!t.hasZ,a,t.spatialReference),h=$e(o.length),d=Hs(o,t.spatialReference,0,h,0,o,0,o.length/3,e,r,s),u=d!=null;return{lines:u?$s(n,o,h):[],projectionSuccess:u,sampledElevation:d}}function fl(t,e){let r=t.type==="polygon"?Ie.CCW_IS_HOLE:Ie.NONE,s=t.type==="polygon"?t.rings:t.paths,{position:a,outlines:i}=Pt(s,!1,r),o=gr(a,t.spatialReference,0,a,e,0);for(let n=2;n<a.length;n+=3)a[n]=Xs;return{lines:o?$s(i,a):[],projectionSuccess:o}}function $s(t,e,r=null){let s=new Array;for(let{index:a,count:i}of t){if(i<=1)continue;let o=3*a,n=3*i;s.push({position:Rt(e,3*a,3*i),mapPositions:r!=null?Rt(r,o,n):void 0})}return s}var ei,ti;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(ei||(ei={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(ti||(ti={}));var Tt=class extends Xr{intersect(e,r,s,a,i,o){return is(e,s,a,i,void 0,o)}};var vt=class extends M{constructor(e,r){super(e,r,new D(Ns,()=>import("./chunk-MTYDWS75.js")))}_createPipeline(e,r){let{oitPass:s,output:a,transparent:i,cullFace:o,draped:n,hasOccludees:h,polygonOffset:d,enableOffset:u}=e,g=s===oe.NONE,f=s===oe.FrontFace;return E({blending:Ee(a)&&i?Kr(s):null,culling:Jr(o),depthTest:n?null:{func:rs(s)},depthWrite:$r(e),drawBuffers:a===v.Depth?{buffers:[Lr.NONE]}:ss(s,a),colorWrite:A,stencilWrite:h?os:null,stencilTest:h?r?hs:ns:null,polygonOffset:g||f?d?Mi:null:ts(u)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}},Mi={factor:1,units:1};var R=class extends ms{constructor(){super(...arguments),this.cullFace=Ae.None,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=zr.None,this.emissionSource=Yr.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.vvSize=!1,this.vvOpacity=!1}};m([P({count:Ae.COUNT})],R.prototype,"cullFace",void 0),m([P()],R.prototype,"hasVertexColors",void 0),m([P()],R.prototype,"transparent",void 0),m([P()],R.prototype,"discardInvisibleFragments",void 0),m([P()],R.prototype,"polygonOffset",void 0),m([P()],R.prototype,"enableOffset",void 0),m([P()],R.prototype,"writeDepth",void 0),m([P()],R.prototype,"hasOccludees",void 0),m([P()],R.prototype,"terrainDepthTest",void 0),m([P()],R.prototype,"cullAboveTerrain",void 0),m([P()],R.prototype,"objectAndLayerIdColorInstanced",void 0),m([P()],R.prototype,"vvColor",void 0),m([P()],R.prototype,"draped",void 0);var ri=class extends Tt{constructor(e){super(e,Kt),this._configuration=new R,this.supportsEdges=!0,this.produces=new Map([[b.OPAQUE_MATERIAL,r=>this._isOpaqueMaterialPass(r)],[b.OPAQUE_MATERIAL_WITHOUT_NORMALS,r=>this._isOpaqueNoSSAODepthPass(r)],[b.TRANSPARENT_MATERIAL,r=>it(r)&&this._transparent&&this.parameters.writeDepth],[b.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,r=>Lt(r)&&this._transparent&&this.parameters.writeDepth],[b.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,r=>it(r)&&this._transparent&&!this.parameters.writeDepth],[b.DRAPED_MATERIAL,r=>Hr(r)]])}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=r.hasOccludees,this._configuration.oitPass=r.oitPass,this._configuration.enableOffset=r.camera.relativeElevation<es,this._configuration.terrainDepthTest=r.terrainDepthTest&&Ee(e),this._configuration.cullAboveTerrain=r.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=ls}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===v.Highlight||it(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return Lt(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new Jt(e)}createBufferWriter(){let e=ae().vec3f(y.POSITION);return at()&&e.vec4u8(y.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(y.COLORFEATUREATTRIBUTE):e.vec4u8(y.COLOR),new as(e)}},Jt=class extends kr{beginSlot(e){return this.getTechnique(vt,e)}},Kt=class extends Ft{constructor(){super(...arguments),this.color=Pe,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ae.None,this.draped=!1,this.discardInvisibleFragments=!1}};var ac=ae().vec3f(y.POSITION),oc=ae().vec3f(y.POSITION).vec2f(y.UV0),nc=ae().vec3f(y.POSITION).vec4u8(y.COLOR),hc=ae().vec3f(y.POSITION).vec2f(y.UV0).vec4u8(y.OBJECTANDLAYERIDCOLOR);export{ei as a,ti as b,Ya as c,Xs as d,Js as e,Tt as f,ri as g,Ks as h,kh as i,Qh as j,hl as k,gl as l,fl as m,ac as n,oc as o,nc as p,hc as q};
