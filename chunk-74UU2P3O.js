import{b as he,c as le,d as ce}from"./chunk-K57Y3IIR.js";import{c as de}from"./chunk-G3YWARR2.js";import{a as it}from"./chunk-TTCWVZMG.js";import{j as U}from"./chunk-FWCA6KJ3.js";import{a as et}from"./chunk-S52JRLJC.js";import{a as oe}from"./chunk-ZWYEIB75.js";import{a as re}from"./chunk-4MCLOZGW.js";import{r as tt}from"./chunk-P64DWRJ7.js";import{e as Q}from"./chunk-DBZKWPEX.js";import{a as g}from"./chunk-AYSSTKZP.js";import{c as z,i as se,o as N}from"./chunk-3D4Y6BLC.js";import{a as E}from"./chunk-3AS27HNO.js";import{a as d}from"./chunk-RWCIDBNQ.js";import{d as Qt}from"./chunk-ONYJLWAD.js";import{b as $t,c as yt,d as K,e as F,h as It,k as Kt,l as Zt,m as xt,p as H}from"./chunk-B57IWIA2.js";import{h as st}from"./chunk-R3KYOH5H.js";import{e as ae,f as ne}from"./chunk-NFWLUI2Z.js";import{f as ee,g as ie}from"./chunk-BUZBVNOM.js";import{g as te}from"./chunk-3BZAI7HK.js";import{r as Z}from"./chunk-HM5RIVQC.js";import{j as kt,k as qt}from"./chunk-SKMO433W.js";import{c as A,e as Wt}from"./chunk-2FO7ARYZ.js";import{a as jt,d as Xt,e as Yt}from"./chunk-DJW5LMRG.js";import{a as Jt,b as pt}from"./chunk-QXXXCEV5.js";import{a as O}from"./chunk-ALWV3RJ2.js";import{a as Gt}from"./chunk-7C6Z24SS.js";import{c as Pt,e as $,u as gt,x as V}from"./chunk-5WKDXHVH.js";import{a as Ut,c as w}from"./chunk-PTZYZULI.js";import{g as zt}from"./chunk-7B2UKJ5N.js";import{D as Vt,l as ft,s as Nt,t as Bt}from"./chunk-TRZXSDYA.js";import{a as L}from"./chunk-NHSDW26F.js";import{b as Ft}from"./chunk-VOFKUGRY.js";import{a as Ht}from"./chunk-VACZNAP3.js";import{L as wt,d as I}from"./chunk-C7INQGWT.js";import{H as X,a as Mt,c as Ot}from"./chunk-WMHJC7XF.js";import{i as Dt,u as Y,w as J}from"./chunk-D2LVMNOU.js";import{a as y}from"./chunk-QGVBCWUY.js";import{t as mt}from"./chunk-HHDFN2GK.js";import{d as q,e as Et,f as Ct,t as j}from"./chunk-47GHT6OF.js";import{f as k}from"./chunk-VTHXE323.js";function P(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}function ue(e){let{size:t}=e.definition,i=e.fontString(t),s=_e.get(i);if(!s){let r=P(be,0,0).getContext("2d");e.setFontProperties(r,t);let a=r.measureText(Le);s=new Rt(a.actualBoundingBoxAscent,a.actualBoundingBoxDescent),_e.set(i,s)}return s}var _e=new Map,Rt=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,i){this.maxAscent=t,this.maxDescent=i}},be={canvas:null},Le=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})();var Tt=1,me=class{constructor(t,i,s,r){this.text=t,this._alignment=i,this._parameters=s,this._maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" ","\xA0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let i=0;i<this._lines.length-1;i++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){let t=P(fe,rt,rt).getContext("2d"),i=this._parameters.definition.pixelRatio,s=this._fontSize*i;this._parameters.setFontProperties(t,s);let r=2*this._haloSize,a=this._parameters.definition.font;a.style!=="italic"&&a.style!=="oblique"&&a.weight!=="bold"&&a.weight!=="bolder"||(r+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let n=0,l=0,o=0,h=0,_=0;this._lines.forEach((W,B)=>{let M=t.measureText(W),Lt=M.width/i,vt=Lt+r;this._textWidths.push(Lt),this._lineWidths.push(vt),n=Math.max(n,vt),h=Math.max(h,M.actualBoundingBoxAscent/i),_=Math.max(_,M.actualBoundingBoxDescent/i),B===0&&(l=M.actualBoundingBoxAscent/i),B===this._lines.length-1&&(o=M.actualBoundingBoxDescent/i)});let c=ue(this._parameters),p=Math.max(h,c.maxAscent),m=Math.max(_,c.maxDescent),f=l,R=this._parameters.definition.font.decoration==="underline"?m:o,ut=n;this._metricsCached=new St(f,R,p,m,ut)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*ve}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,Tt)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){let t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case v.Left:return this._horizontalPadding;case v.Center:return(this.displayWidth-this._lineWidths[t])/2;case v.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,i,s){t.save();let r=i/=this.renderPixelRatio,a=s/=this.renderPixelRatio,n=this._haloSize,l=this._firstLineYOffset+this._metrics.firstLineAscent;i+=n,s+=l;let o=this._haloSize>0;o&&this._renderHalo(t,r,a,n,l),this._parameters.setFontProperties(t,this._renderedFontSize);for(let h=0;h<this._lines.length;++h){let _=this._lines[h],c=this._getLineXOffset(h);o&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,_,i+c,s),this._renderLineDecoration(t,i+c,s,this._textWidths[h])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,_,i+this._getLineXOffset(h),s),this._renderLineDecoration(t,i+c,s,this._textWidths[h]),s+=this._lineSpacing}if(N.TEXT_SHOW_BASELINE){t.strokeStyle=ge,t.setLineDash([2,2]),t.lineWidth=1;let h=a+l;for(let _=0;_<this._lines.length;++_)this._drawLine(t,[r,h],[r+this.displayWidth,h]),h+=this._lineSpacing}if(N.TEXT_SHOW_BORDER&&(t.strokeStyle=ge,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[r,a],[this.displayWidth,this.displayHeight])),this._hasBackground){let h=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,r,a,h),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,i,s,r,a=!1){if(this._parameters.definition.font.decoration==="none"||r===0)return;let n=1,l=Math.max(this._parameters.definition.size/16,n);switch(this._parameters.definition.font.decoration){case"underline":s+=2*l;break;case"line-through":s-=.33*this._midLineAscent}let o=a?this._haloSize:0;t.strokeStyle=a?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(l+2*o),t.beginPath(),t.moveTo(this._toRenderUnit(i-o),this._toRenderUnit(s)),t.lineTo(this._toRenderUnit(i+r+o),this._toRenderUnit(s)),t.stroke()}_roundedRect(t,i,s,r){i=this._toRenderUnit(i),s=this._toRenderUnit(s);let a=this.renderedWidth,n=this.renderedHeight;r!==0?(r=Ft(r,0,Math.floor(n/2)),t.beginPath(),t.moveTo(i,s+r),t.arcTo(i,s,i+r,s,r),t.lineTo(i+a-r,s),t.arcTo(i+a,s,i+a,s+r,r),t.lineTo(i+a,s+n-r),t.arcTo(i+a,s+n,i+a-r,s+n,r),t.lineTo(i+r,s+n),t.arcTo(i,s+n,i,s+n-r,r),t.closePath()):t.rect(i,s,a,n)}_renderHalo(t,i,s,r,a){let n=this.renderedWidth,l=this.renderedHeight,o=P(fe,Math.max(n,rt),Math.max(l,rt)),h=o.getContext("2d");h.clearRect(0,0,n,l),this._parameters.setFontProperties(h,this._renderedFontSize),h.fillStyle=this._parameters.haloStyle,h.strokeStyle=this._parameters.haloStyle;let _=this._renderedHaloSize<3;h.lineJoin=_?"miter":"round",_?this._renderHaloEmulated(h,r,a):this._renderHaloNative(h,r,a);let c=a;for(let p=0;p<this._lines.length;++p){let m=this._getLineXOffset(p);this._renderLineDecoration(h,r+m,c,this._textWidths[p],!0),c+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(o,0,0,n,l,this._toRenderUnit(i),this._toRenderUnit(s),n,l),t.globalAlpha=1}_renderHaloEmulated(t,i,s){for(let r=0;r<this._lines.length;++r){let a=this._lines[r],n=this._getLineXOffset(r);for(let[l,o]of pe)this._fillText(t,a,i+n+this._haloSize*l,s+this._haloSize*o);s+=this._lineSpacing}}_renderHaloNative(t,i,s){let r=2*this._haloSize;for(let a=0;a<this._lines.length;++a){let n=this._lines[a],l=this._getLineXOffset(a),o=5,h=.1;for(let _=0;_<o;_++){let c=1-(o-1)*h+_*h;t.lineWidth=this._toRenderUnit(c*r),this._strokeText(t,n,i+l,s)}s+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,i,s,r){t.fillText(i,this._toRenderUnit(s),this._toRenderUnit(r))}_strokeText(t,i,s,r){t.strokeText(i,this._toRenderUnit(s),this._toRenderUnit(r))}_drawLine(t,i,s){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.lineTo(this._toRoundedRenderUnit(s[0])+.5,this._toRoundedRenderUnit(s[1])+.5),t.stroke()}_drawBox(t,i,s){let r=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),n=this._toRenderUnit(s[0]),l=this._toRenderUnit(s[1]),o=Math.floor(r)+.5,h=Math.ceil(r+n)-.5,_=Math.floor(a)+.5,c=Math.ceil(a+l)-.5;t.beginPath(),t.moveTo(o,_),t.lineTo(h,_),t.lineTo(h,c),t.lineTo(o,c),t.lineTo(o,_),t.stroke()}},pe=[];for(let t=0;t<360;t+=360/16)pe.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);var v;(function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"})(v||(v={}));var fe={canvas:null},ve=.2,rt=512,ge="rgb(255, 0, 255, 0.5)",St=class{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,i,s,r,a){this.firstLineAscent=t,this.lastLineDescent=i,this.maxLineAscent=s,this.maxLineDescent=r,this.displayWidth=a}};var qe=Object.freeze({left:0,center:.5,right:1}),je=Object.freeze({"bottom-left":A(0,0),bottom:A(.5,0),"bottom-right":A(1,0),left:A(0,.5),center:A(.5,.5),right:A(1,.5),"top-left":A(0,1),top:A(.5,1),"top-right":A(1,1)});function Xe(e){switch(e){case"left":return v.Left;case"right":return v.Right;default:return v.Center}}function Ye(e,t){switch(t){case"bottom":return e==="left"?"bottom-left":e==="right"?"bottom-right":"bottom";case"center":return e;case"top":return e==="left"?"top-left":e==="right"?"top-right":"top"}}function Je(e){return e==="middle"?"center":e}function $e(e,t){switch(e){case"top":return pt(t,0,Tt);case"bottom":return pt(t,0,-1);default:return Jt(t,Wt)}}var C=class{constructor(t=1/0,i=-1/0){this.near=t,this.far=i}set(t,i){this.near=t,this.far=i}union(t){t!=null&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}};C.zero=new C(0,0);var at=class{constructor(t,i,s){this._elementSize=i,this._buffer=it.createVertex(t,Z.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(t,i,s,r=0){let a=new Uint8Array(this.array,t*this.elementSize,(i-t)*this.elementSize);new Uint8Array(s.array,r*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(t,i){let s=t*this._elementSize,r=i*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),s,s,r)}resize(t){let i=t*this._elementSize,s=new ArrayBuffer(i);this._array&&(t>=this._capacity?new Uint8Array(s).set(new Uint8Array(this._array)):new Uint8Array(s).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=s,this._buffer.setSize(i),this._capacity=t}};var At=class{constructor(t){this.modelOriginHi=t.getField(d.INSTANCEMODELORIGINHI,yt),this.modelOriginLo=t.getField(d.INSTANCEMODELORIGINLO,yt),this.model=t.getField(d.INSTANCEMODEL,F),this.modelNormal=t.getField(d.INSTANCEMODELNORMAL,F),this.featureAttribute=t.getField(d.INSTANCEFEATUREATTRIBUTE,K),this.color=t.getField(d.INSTANCECOLOR,H),this.objectAndLayerIdColor=t.getField(d.INSTANCEOBJECTANDLAYERIDCOLOR,H)}},nt=class{constructor(t,i){this._rctx=t,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){let t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){g(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){g(this._updating,"not updating"),this.size<Ct*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){g(this._updating,"not updating"),this.isFull&&this._grow();let t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),g(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){g(this._updating,"not updating"),g(this.size>0,"invalid size");let t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){let t=Math.max(G,Math.floor(this._capacity*q));this._resize(t)}_shrink(){let t=Math.max(G,Math.floor(this._capacity*Et));this._resize(t)}_resize(t){if(g(this._updating,"not updating"),t===this._capacity)return;let i=new at(this._rctx,this._instanceBufferLayout.stride,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);let s=this.size,r=this._compactInstances(i);g(r===s,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=r,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new At(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){let i=this._headIndex,s=this._tailIndex;return s<i?(this._buffer.copyRange(s,i,t),i-s):s>i?(this._buffer.copyRange(s,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-s),i+(this._capacity-s)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}},G=64;var u;function Ee(e){let t=Q().mat4f64(d.LOCALTRANSFORM).mat4f64(d.GLOBALTRANSFORM).vec4f64(d.BOUNDINGSPHERE).vec3f64(d.MODELORIGIN).mat3f(d.INSTANCEMODEL).mat3f(d.INSTANCEMODELNORMAL).vec2f(d.MODELSCALEFACTORS);return e.includes(d.FEATUREATTRIBUTE)&&(t=t.vec4f(d.FEATUREATTRIBUTE)),e.includes(d.COLOR)&&(t=t.vec4u8(d.COLOR)),e.includes(d.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(d.OBJECTANDLAYERIDCOLOR)),t=t.u8(d.STATE).u8(d.LODLEVEL),t}(function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"})(u||(u={}));var ot=class{constructor(t){this.localTransform=t.getField(d.LOCALTRANSFORM,It),this.globalTransform=t.getField(d.GLOBALTRANSFORM,It),this.modelOrigin=t.getField(d.MODELORIGIN,Kt),this.model=t.getField(d.INSTANCEMODEL,F),this.modelNormal=t.getField(d.INSTANCEMODELNORMAL,F),this.modelScaleFactors=t.getField(d.MODELSCALEFACTORS,$t),this.boundingSphere=t.getField(d.BOUNDINGSPHERE,Zt),this.featureAttribute=t.getField(d.FEATUREATTRIBUTE,K),this.color=t.getField(d.COLOR,H),this.objectAndLayerIdColor=t.getField(d.OBJECTANDLAYERIDCOLOR,H),this.state=t.getField(d.STATE,xt),this.lodLevel=t.getField(d.LODLEVEL,xt)}},D=class extends wt{constructor(e,t){super(e),this.events=new Ht,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=Ee(t),this._capacity=G,this._buffer=this._layout.createBuffer(this._capacity),this._view=new ot(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();let e=this._findSlot();return this._view.state.set(e,u.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){let t=this._view.state;g(e>=0&&e<this._capacity&&!!(t.get(e)&u.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,u.ACTIVE)?this._setStateFlags(e,u.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){let t=this._view.state;g(e>=0&&e<this._capacity&&!!(t.get(e)&u.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){let t=this._view,i=x,s=S;t.localTransform.getMat(e,ye),t.globalTransform.getMat(e,bt);let r=zt(bt,bt,ye);Pt(i,r[12],r[13],r[14]),t.modelOrigin.setVec(e,i),jt(s,r),t.model.setMat(e,s);let a=qt(x,r);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),Yt(s,s),Xt(s,s),t.modelNormal.setMat(e,s),this._setStateFlags(e,u.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){let i=this._view;i.model.getMat(e,S),i.modelOrigin.getVec(e,x),t[0]=S[0],t[1]=S[1],t[2]=S[2],t[3]=0,t[4]=S[3],t[5]=S[4],t[6]=S[5],t[7]=0,t[8]=S[6],t[9]=S[7],t[10]=S[8],t[11]=0,t[12]=x[0],t[13]=x[1],t[14]=x[2],t[15]=1}applyShaderTransformation(e,t){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(x,this,e),t*=Math.max(x[0],x[1],x[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(x,this,e),t*=Ce(x[0],x[1],x[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,u.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,u.VISIBLE)}setHighlight(e,t){let{_highlightOptionsMap:i}=this,s=i.get(e);t?t!==s&&(i.set(e,t),this._setStateFlag(e,u.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):s&&(i.delete(e),this._setStateFlag(e,u.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,u.HIGHLIGHT)}geHighlightOptionsPrev(e){let t=this._highlightOptionsMapPrev.get(e)??null;return this._highlightOptionsMapPrev.delete(e),t}getHighlightName(e){let t=this.highlightOptionsMap.get(e)??null;return t?this._highlightOptionsMapPrev.set(e,t):this._highlightOptionsMapPrev.delete(e),t}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){let i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){let i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(G,Math.floor(this._capacity*q)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new ot(this._buffer)}_findSlot(){let e=this._view.state,t=this._next;for(;e.get(t)&u.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};function Ce(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}y([I({constructOnly:!0})],D.prototype,"shaderTransformation",void 0),y([I()],D.prototype,"_size",void 0),y([I({readOnly:!0})],D.prototype,"size",null),D=y([X("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],D);var x=L(),S=Gt(),ye=O(),bt=O();var ht=class extends U{constructor(t,i){super(s=>this._instanceData.view.boundingSphere.getVec(s,this._tmpSphere),{maximumDepth:25}),this._instanceData=t,this._boundingSphere=i,this._tmpSphere=te(),this._tmpMat4=O()}addInstance(t){let i=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);V(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*kt(s),i.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}};var lt=class{constructor(t,i){this._worldSpaceRadius=t,this._minScreenSpaceRadii=i}selectLevel(t,i,s){let r=s.computeScreenPixelSizeAt(t),a=this._worldSpaceRadius*i/r,n=0;for(let l=1;l<this._minScreenSpaceRadii.length;++l)a>=this._minScreenSpaceRadii[l]&&(n=l);return n}};var ct=class{constructor(t,i){this._material=t,this._repository=i,this._map=new Map}dispose(){this._map.forEach((t,i)=>{t!=null&&this._repository.release(this._material,i)})}load(t,i,s){if(!this._material.produces.get(i)?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,i,s));let a=this._map.get(s);if(a!=null){if(a.ensureResources(t)===Qt.LOADED)return a;this._repository.requestRender()}return null}};var dt=class{constructor(t,i){let s=t.renderContext.rctx,r=i.geometry,a=i.geometry.getRenderGeometry(),n=a.material;this._materials=t.materials,n.setParameters({instancedDoublePrecision:!0}),this.geometry=r,this.material=n,this.glMaterials=new ct(n,this._materials),this.vertexBufferLayout=a.vertexBufferLayout,this.vbo=it.createVertex(s,Z.STATIC_DRAW,a.buffer),this.vao=new ce(s,z,new Map([["geometry",et(a.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=a.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(t,i,s,r,a,n,l,o){return this.geometry.intersect(t,i,s,r,a,n,l,o)}};var _t=class e{static create(t,i,s){return k(this,null,function*(){let r=yield Promise.allSettled(i.components.map(n=>t.controller.schedule(()=>new dt(t,n),s))),a=r.map(n=>n.status==="fulfilled"?n.value:null).filter(j);if(J(s)||a.length!==r.length){a.forEach(n=>n.destroy()),Y(s);for(let n of r)if(n.status==="rejected")throw n.reason}return new e(i.minScreenSpaceRadius,a)})}constructor(t,i){this.minScreenSpaceRadius=t,this.components=i}destroy(){this.components.forEach(t=>t.destroy())}intersect(t,i,s,r,a,n,l){this.components.forEach(o=>o.intersect(t,i,s,r,a,n,this.boundingSphere,l))}get boundingBox(){if(this._boundingBox==null){let t=Vt();this.components.forEach(i=>{i.boundingInfo!=null&&(ft(t,i.boundingInfo.bbMin),ft(t,i.boundingInfo.bbMax))}),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let t=this.boundingBox,i=L();Bt(t,i),this._boundingSphere={center:i,radius:.5*Nt(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((t,i)=>t+i.triangleCount,0)}};var Me=e=>{let t=e.baseBoundingSphere.radius,i=e.levels.map(s=>s.minScreenSpaceRadius);return new lt(t,i)},T=class extends he{constructor(e,t){super(e),this.type=oe.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new le,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[tt.OPAQUE_MATERIAL,i=>this._produces(i)],[tt.TRANSPARENT_MATERIAL,i=>!!this._hasTransparentLevels()&&this._produces(i)]]),this._instanceData=new D({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(ae.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=De(this.optionalFields),this._glInstanceBufferLayout=et(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){let e=[this._defaultRenderInstanceData];for(let t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}get _allRenderInstanceDataExceptHighlightShadow(){let e=[this._defaultRenderInstanceData];for(let t of this._highlightRenderInstanceDataMap)t[0]!==st&&e.push(t[1]);return e}hasHighlightOptions(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(e=>e.components.some(t=>t.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((i,s)=>i+s.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((i,s)=>i+s.usedMemory,0),0))}get renderStats(){let e=this._instanceData.size,t=[];return this._levels.forEach((i,s)=>{let r=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,a=i.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*a,trianglesPerInstance:a})}),{totalInstances:e,renderedInstances:t.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:t.reduce((i,s)=>i+s.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(e=[]){let{rctx:t}=this._context.renderContext;return this.symbol.levels.map(i=>{e.push(new nt(t,this._instanceBufferLayout))}),e}initializeRenderContext(e,t){return k(this,null,function*(){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);let i=yield Promise.allSettled(this.symbol.levels.map(r=>_t.create(e,r,t))),s=i.map(r=>r.status==="fulfilled"?r.value:null).filter(j);if(J(t)||s.length!==i.length){s.forEach(r=>r.destroy()),Y(t);for(let r of i)if(r.status==="rejected")throw r.reason}this._levels=s,this._levelSelector=Me(this)})}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDataMap.forEach(e=>e.forEach(t=>t.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(t=>t.material.produces.get(tt.TRANSPARENT_MATERIAL)?.(E.Color)))}hasHighlights(){return Mt(this._highlightRenderInstanceDataMap,e=>e.some(t=>t.size>0))}_produces(e){return(e!==E.Highlight||this.hasHighlights())&&(e!==E.ShadowHighlight||this.hasHighlightOptions(st))}prepareRender(e){if(!N.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(ne),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;let t=this._getInstanceDatas(e);if(!t)return null;let i=new Array,s=this.levels;return t.forEach(r=>s.forEach(({components:a},n)=>a.forEach(l=>i.push(this._beginComponent(e,r[n],l))))),i}render(e,t){let i=this._getInstanceDatas(e);if(!i||t==null)return;let s=0;e.rctx.bindVAO();let r=this.levels;i.forEach(a=>r.forEach(({components:n},l)=>n.forEach(o=>this._renderComponent(e,t[s++],a[l],o,l))))}_getInstanceDatas(e){let{output:t,bind:i}=e,s=t===E.Highlight,r=t===E.ShadowHighlight,a=!s&&!r,n=t!==E.ShadowExcludeHighlight;if(a)return n?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(n){if(s){let o=i.highlight?.name;if(!o)return null;let h=this._highlightRenderInstanceDataMap.get(o);return h?[h]:null}let l=this._highlightRenderInstanceDataMap.get(st);return r?l?[l]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(e,t,i,s){if(!this.baseMaterial.visible||this._octree==null)return;let r=L();$(r,s,i);let a=n=>{this._instanceData.getCombinedModelTransform(n,Re),e.transform.set(Re),V(Se,i,e.transform.inverse),V(Te,s,e.transform.inverse);let l=this._instanceData.getState(n),o=this._instanceData.getLodLevel(n),h=this._levels.length;g(!!(l&u.ACTIVE),"invalid instance state"),g(o>=0&&o<h,"invaid lod level"),this._levels[o].intersect(e,t,Se,Te,n,this.metadata,h)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(i,r,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new ht(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)t.get(i)&u.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Dt(this._octreeCached)}queryDepthRange(e){if(this._octree==null)return new C;let t=e.viewForward,i=this._octree.findClosest(t,U.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(t,U.DepthOrder.BACK_TO_FRONT,e.frustum);if(i==null||s==null)return new C;let r=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(i,b),$(b,b,r);let n=gt(b,t)-b[3];a.boundingSphere.getVec(s,b),$(b,b,r);let l=gt(b,t)+b[3];return new C(n,l)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(t=>t.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){let{_enableLevelSelection:t,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(_=>_.forEach(c=>c.beginUpdate()));let r=this._instanceData,a=r.view,n=r.size,l=r.capacity,o=this._instanceIndex,h=Math.ceil(l/500);for(let _=0;_<n&&!e.done;++_){o===this._cycleStartIndex&&this._startUpdateCycle();let c=a.state.get(o),p=0;if(!(c&u.ALLOCATED)){o=o+1===l?0:o+1,n++;continue}let m=a.lodLevel.get(o);if(c&u.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),c&u.HIGHLIGHT_ACTIVE){let f=r.geHighlightOptionsPrev(o);if(f){let R=this._highlightRenderInstanceDataMap.get(f);if(!R)throw new mt("Internal error in lodRenderer");R[m].freeTail()}}if(c&u.REMOVE)r.freeInstance(o);else if(c&u.VISIBLE){let f=0;if(t&&(a.modelOrigin.getVec(o,xe),f=s.selectLevel(xe,r.getCombinedMedianScaleFactor(o),i)),p=c&~(u.ACTIVE|u.TRANSFORM_CHANGED),f>=0)if(c&u.HIGHLIGHT){let R=r.getHighlightName(o);if(R){let ut=()=>{let B=this._createRenderInstanceDataArray();return B.forEach(M=>M.beginUpdate()),B},W=Ot(this._highlightRenderInstanceDataMap,R,ut);if(f>=W.length)throw new mt(`LodRenderer internal error - missing lodLevel ${f}`);Ie(W[f],a,o)}p|=u.HIGHLIGHT_ACTIVE}else Ie(this._defaultRenderInstanceData[f],a,o),p|=u.DEFAULT_ACTIVE;a.state.set(o,p),a.lodLevel.set(o,f)}else p=c&~(u.ACTIVE|u.TRANSFORM_CHANGED),a.state.set(o,p);if(this._octreeCached!=null){let f=!!(c&u.ACTIVE),R=!!(p&u.ACTIVE);!f&&R?this._octreeCached.addInstance(o):f&&!R?this._octreeCached.removeInstance(o):f&&R&&c&u.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(o),this._octreeCached.addInstance(o))}o=o+1===l?0:o+1,o%h==0&&e.madeProgress()}this._instanceIndex=o,this._allRenderInstanceData.forEach(_=>_.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(e,t,i){return t.size===0?null:i.glMaterials.load(e.rctx,e.bind.slot,e.output)?.beginSlot(e.bind)}_renderComponent(e,t,i,s,r){if(!t)return;let{bind:a,rctx:n}=e;n.runAppleAmdDriverHelper();let l=n.bindTechnique(t,a,s.material.parameters,we);n.bindVAO(s.vao),t.ensureAttributeLocations(s.vao),N.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===E.Color&&(l.setUniform4fv("externalColor",Ae[Math.min(r,Ae.length-1)]),l.setUniform1i("colorMixMode",se.replace));let o=i.capacity,h=i.headIndex,_=i.tailIndex,c=i.firstIndex,p=this._glInstanceBufferLayout,m=(f,R)=>{ee(n,z,i.buffer,p,f),n.drawArraysInstanced(t.primitiveType,0,s.vertexCount,R-f),ie(n,z,i.buffer,p)};s.material.parameters.transparent&&c!=null?h>_?(g(c>=_&&c<=h,"invalid firstIndex"),m(c,h),m(_,c)):h<_&&(c<=h?(g(c>=0&&c<=h,"invalid firstIndex"),m(c,h),m(_,o),m(0,c)):(g(c>=_&&c<=o,"invalid firstIndex"),m(c,o),m(0,h),m(_,c))):h>_?m(_,h):h<_&&(m(0,h),m(_,o)),n.bindVAO(null)}};function Ie(e,t,i){let s=e.allocateHead();Oe(t,i,e.view,s)}function Oe(e,t,i,s){de(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,e.model,t),i.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(s,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(s,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,e.featureAttribute,t)}function De(e){let t=Q().vec3f(d.INSTANCEMODELORIGINHI).vec3f(d.INSTANCEMODELORIGINLO).mat3f(d.INSTANCEMODEL).mat3f(d.INSTANCEMODELNORMAL);return e!=null&&e.includes("featureAttribute")&&(t=t.vec4f(d.INSTANCEFEATUREATTRIBUTE)),e!=null&&e.includes("color")&&(t=t.vec4u8(d.INSTANCECOLOR)),e!=null&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(d.INSTANCEOBJECTANDLAYERIDCOLOR)),t}y([I({constructOnly:!0})],T.prototype,"symbol",void 0),y([I({constructOnly:!0})],T.prototype,"optionalFields",void 0),y([I({constructOnly:!0})],T.prototype,"metadata",void 0),y([I({constructOnly:!0})],T.prototype,"shaderTransformation",void 0),y([I()],T.prototype,"_instanceData",void 0),y([I()],T.prototype,"_cycleStartIndex",void 0),y([I({readOnly:!0})],T.prototype,"_enableLevelSelection",null),y([I()],T.prototype,"_updateCyclesWithStaticCamera",void 0),y([I({readOnly:!0})],T.prototype,"running",null),T=y([X("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],T);var xe=L(),b=Ut(),Re=O(),Se=L(),Te=L(),Ae=[w(1,0,1,1),w(0,0,1,1),w(0,1,0,1),w(1,1,0,1),w(1,0,0,1)],we=new re;export{P as a,ue as b,me as c,qe as d,je as e,Xe as f,Ye as g,Je as h,$e as i,ct as j,T as k};
