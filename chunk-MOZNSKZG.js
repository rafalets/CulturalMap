import{a as Ge}from"./chunk-RCUBR556.js";import{a as Ee}from"./chunk-SSNXGR3A.js";import{a as Le}from"./chunk-DXESEXTD.js";import{a as ke}from"./chunk-XE6PIB3P.js";import{a as A,d as Ne}from"./chunk-XA3H5C5C.js";import{a as Z}from"./chunk-6AT6XDV7.js";import{a as ue}from"./chunk-VGCEVKYN.js";import{c as Fe}from"./chunk-6T37AWU6.js";import{a as ae,f as ie,g as X,h as Ae,i as Ce,j as ne,m as le}from"./chunk-ZQFOJVRP.js";import{a as Q}from"./chunk-PWU2QHPV.js";import{f as Se}from"./chunk-LNVVFNTC.js";import{a as ve}from"./chunk-S7QYPX7J.js";import{a as Y}from"./chunk-WNSGKHQ6.js";import{b as be,h as $}from"./chunk-MDL4XPLR.js";import{a as se}from"./chunk-HVKMTRIC.js";import{a as K}from"./chunk-QEBUS3TL.js";import{j as we}from"./chunk-I4M2OT5W.js";import{a as oe}from"./chunk-WMQNRNIU.js";import{a as ge,b as W}from"./chunk-WUA6PW3I.js";import{F,s as re}from"./chunk-E57FTRWF.js";import{h as Ie}from"./chunk-U4J5SECU.js";import{f as M}from"./chunk-7EG726PT.js";import{L as Te,d as l}from"./chunk-C7INQGWT.js";import{H as w}from"./chunk-WMHJC7XF.js";import{C as he,t as H}from"./chunk-D2LVMNOU.js";import{a as i}from"./chunk-QGVBCWUY.js";import{r as fe,t as V}from"./chunk-HHDFN2GK.js";import{a as b,b as _,e as ye,f}from"./chunk-VTHXE323.js";var $e=W()({Pending:"job-waiting",InProgress:"job-executing",Completed:"job-succeeded"}),U=class extends Ee{constructor(e){super(e),this.statusUrl=null,this.status=null,this.submissionTime=null,this.lastUpdatedTime=null,this._timer=void 0}destroy(){clearInterval(this._timer)}checkJobStatus(e){return f(this,null,function*(){let t=_(b({},e),{query:{f:"json"}}),{data:o}=yield F(this.statusUrl,t);return this.read(o),this.editsResolver&&this.editsResolver.resolve({edits:null,addedFeatures:[],updatedFeatures:[],deletedFeatures:[],addedAttachments:[],updatedAttachments:[],deletedAttachments:[],exceededTransferLimit:!0,historicMoment:null}),this})}waitForJobCompletion(){return f(this,arguments,function*(e={}){let{interval:t=1e3,statusCallback:o}=e;return new Promise((r,s)=>{this._clearTimer();let a=setInterval(()=>{this._timer||s(H()),this.checkJobStatus().then(u=>{let{status:c}=u;switch(this.status=c,c){case"job-succeeded":this._clearTimer(),r(this);break;case"job-waiting":case"job-executing":o&&o(this)}},u=>{this._clearTimer(),s(u)})},t);this._timer=a})})}_clearTimer(){clearInterval(this._timer),this._timer=void 0}};i([l()],U.prototype,"editsResolver",void 0),i([l({type:String,json:{write:!0}})],U.prototype,"statusUrl",void 0),i([Y($e)],U.prototype,"status",void 0),i([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.submissionTime=e?e.getTime():null}}}})],U.prototype,"submissionTime",void 0),i([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.lastUpdatedTime=e?e.getTime():null}}}})],U.prototype,"lastUpdatedTime",void 0),U=i([w("esri.networks.support.TopologyValidationJobInfo")],U);var _e=U;function Ue(e,t){return f(this,null,function*(){if(e==="Utility Network Layer"){let{default:o}=yield import("./chunk-H5S3VY6M.js");return new o({layerUrl:t})}return null})}function Re(e){return f(this,null,function*(){let t="portalItem"in e?e:{portalItem:e};!t.portalItem||t.portalItem instanceof se||(t=_(b({},t),{portalItem:new se(t.portalItem)}));let o=t.portalItem;if(yield o.load(),o.type!=="Feature Service")throw new V("portal:unknown-item-type","Unknown item type '${type}'",{type:o.type});let r=o.url,s=yield F(r,{responseType:"json",query:{f:"json"}}),a="Network Layer";if(s.data.type?.includes(a))return Ue(s.data.type,r);if(s.data.layers){let u=s.data.layers.find(c=>c.type.includes(a));if(u){let c=`${r}/${u.id}`;return Ue(u.type,c)}}return null})}var T=class extends ve(K){static fromPortalItem(e){return Re(e)}constructor(e){super(e),this.id=null,this.title=null,this.layerUrl=null,this.dataElement=null,this.fullExtent=null,this.spatialReference=null,this.type=null,this.sourceJSON=null,this.gdbVersion=null,this.historicMoment=null,this._sourceIdByLayerId=new Map,this._layerIdBySourceId=new Map,this._applyEditsHandler=t=>{let{serviceUrl:o,gdbVersion:r,result:s}=t,a=o===this.featureServiceUrl,u=le(o,r,this.gdbVersion);a&&u&&s.then(c=>{X(o,r)&&(this.historicMoment=c.historicMoment)})},this._updateMomentHandler=t=>{let{serviceUrl:o,gdbVersion:r,moment:s}=t,a=o===this.featureServiceUrl,u=le(o,r,this.gdbVersion);a&&u&&(this.historicMoment=s)},this.when().then(()=>{this.addHandles([Ae(this._applyEditsHandler),Ce(this._updateMomentHandler)])},()=>{})}initialize(){this.when().catch(e=>{he(e)||fe.getLogger(this).error("#load()",`Failed to load layer (title: '${this.title??"no title"}', id: '${this.id??"no id"}')`,{error:e})})}get datasetName(){return this.dataElement?.name??null}get owner(){return this.dataElement?.userIdentity??null}get schemaGeneration(){return this.dataElement?.schemaGeneration??null}get parsedUrl(){return Ie(this.layerUrl)}get featureServiceUrl(){return re(this.parsedUrl.path).url.path}get networkServiceUrl(){return this.featureServiceUrl.replace(/\/FeatureServer/i,"/UtilityNetworkServer")}get layerId(){return re(this.parsedUrl.path).sublayer}get networkSystemLayers(){return null}load(e){return f(this,null,function*(){return this.addResolvingPromise(this._fetchDataElement(this.featureServiceUrl,this.layerId.toString(),e)),this.addResolvingPromise(this._fetchLayerMetaData(this.layerUrl,e)),this})}getLayerIdBySourceId(e){if(!this.dataElement)return null;let t=this._layerIdBySourceId.get(e);if(t!=null)return t;let o=this.dataElement.domainNetworks,r=this._traverseNetworkSources(o,this._layerIdBySourceId,"sourceId","layerId",e);return r>=0?r:null}getSourceIdByLayerId(e){if(!this.dataElement)return null;let t=this._sourceIdByLayerId.get(e);if(t!=null)return t;let o=this.dataElement.domainNetworks,r=this._traverseNetworkSources(o,this._sourceIdByLayerId,"layerId","sourceId",e);return r>=0?r:null}getObjectIdsFromElements(e){let t=[],o=new Map;for(let s of e){let a=this.getLayerIdBySourceId(s.networkSourceId);if(a==null)continue;let u=o.get(a);u===void 0&&(u=[]),u.push(s.objectId),o.set(a,u)}let r=this.featureServiceUrl;return o.forEach((s,a)=>t.push({layerUrl:`${r}/${a}`,objectIds:s})),t}queryNamedTraceConfigurations(e,t){return f(this,null,function*(){let[{queryNamedTraceConfigurations:o},{default:r}]=yield Promise.all([import("./chunk-SVJ5UV5T.js"),import("./chunk-VR2I4EDN.js")]),s=this.networkServiceUrl,a=r.from(e);return(yield o(s,a,b({},t)))?.namedTraceConfigurations})}validateTopology(e,t){return f(this,null,function*(){if(!e.validateArea)throw new V("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");let[{validateNetworkTopology:o},{default:r}]=yield Promise.all([import("./chunk-IE37D6LZ.js"),import("./chunk-4VQR2M6H.js")]),s=r.from(e);X(this.featureServiceUrl,this.gdbVersion||null)?(s.sessionID=ae,yield ie(this.featureServiceUrl,this.gdbVersion,!0)):s.sessionID=null,s.gdbVersion=this.gdbVersion;let a=this.networkServiceUrl,u=this.featureServiceUrl,c=ne(u,null,this.gdbVersion,!0),h=yield o(a,s,b({},t));if(h?.serviceEdits){let n=[];for(let d of h.serviceEdits){let{editedFeatures:p}=d,y=p?.spatialReference?new oe(p.spatialReference):null;n.push({layerId:d.layerId,editedFeatures:{adds:p?.adds?.map(m=>ee(m,y))||[],updates:p?.updates?.map(m=>({original:ee(m[0],y),current:ee(m[1],y)}))||[],deletes:p?.deletes?.map(m=>ee(m,y))||[],spatialReference:y}})}c.resolve({edits:null,addedFeatures:[],updatedFeatures:[],deletedFeatures:[],addedAttachments:[],updatedAttachments:[],deletedAttachments:[],editedFeatures:n,exceededTransferLimit:!1,historicMoment:h.moment})}return h})}submitTopologyValidationJob(e,t){return f(this,null,function*(){let o=null;if(!e.validateArea)throw new V("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");if(!this.gdbVersion){let n=this.layerUrl.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");o=(yield F(n,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}let[{submitValidateNetworkTopologyJob:r},{default:s}]=yield Promise.all([import("./chunk-IE37D6LZ.js"),import("./chunk-4VQR2M6H.js")]),a=s.from(e);X(this.featureServiceUrl,this.gdbVersion||null)?(a.sessionID=ae,yield ie(this.featureServiceUrl,this.gdbVersion,!0)):a.sessionID=null,a.gdbVersion=this.gdbVersion||o;let u=this.networkServiceUrl,c=this.featureServiceUrl?ne(this.featureServiceUrl,null,this.gdbVersion,!0):void 0,h=yield r(u,a,b({},t));return new _e({statusUrl:h,editsResolver:c})})}getSourceTypeById(e){if(!this.dataElement)return null;for(let t of this.dataElement.domainNetworks)for(let o of[t.edgeSources??[],t.junctionSources??[]])for(let r of o)if(r.sourceId===e)return o===t.edgeSources?"edge":"junction";return null}_traverseNetworkSources(e,t,o,r,s){for(let a of e)for(let u of[a.edgeSources??[],a.junctionSources??[]])for(let c of u)if(c[o]===s)return t.set(s,c[r]),c[r];return-1}_fetchLayerMetaData(e,t){return f(this,null,function*(){let o=yield F(e,b({responseType:"json",query:{f:"json"}},t));this.sourceJSON=o.data,this.read(o.data,{origin:"service"})})}_fetchDataElement(e,t,o){return f(this,null,function*(){if(this.dataElement)return;let r=yield F(`${e}/queryDataElements`,b({responseType:"json",query:{layers:JSON.stringify([t]),f:"json"}},o)).then(s=>s.data.layerDataElements?.[0]);r&&this.read(r,{origin:"service"})})}};function ee(e,t){return new Q({attributes:e.attributes,geometry:Se(_(b({},e.geometry),{spatialReference:t}))})}i([l({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:!0}},read:!1}})],T.prototype,"id",void 0),i([l({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:{source:"name"}}},read:!1}})],T.prototype,"title",void 0),i([l({type:String,nonNullable:!0,json:{origins:{"web-map":{read:{source:"url"},write:{target:"url",isRequired:!0}}},read:!1}})],T.prototype,"layerUrl",void 0),i([l({type:Object,json:{origins:{service:{read:!0}},read:!1}})],T.prototype,"dataElement",void 0),i([l({type:we,json:{origins:{service:{read:{source:"extent"}}},read:!1}})],T.prototype,"fullExtent",void 0),i([l({type:oe,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:!1}})],T.prototype,"spatialReference",void 0),i([l({type:["utility","trace"],readOnly:!0,json:{read:!1,write:!1}})],T.prototype,"type",void 0),i([l({readOnly:!0})],T.prototype,"datasetName",null),i([l({readOnly:!0})],T.prototype,"owner",null),i([l({readOnly:!0})],T.prototype,"schemaGeneration",null),i([l({readOnly:!0})],T.prototype,"parsedUrl",null),i([l({readOnly:!0})],T.prototype,"featureServiceUrl",null),i([l({readOnly:!0})],T.prototype,"networkServiceUrl",null),i([l({readOnly:!0})],T.prototype,"layerId",null),i([l()],T.prototype,"sourceJSON",void 0),i([l({readOnly:!0})],T.prototype,"networkSystemLayers",null),i([l()],T.prototype,"gdbVersion",void 0),i([l({type:Date})],T.prototype,"historicMoment",void 0),T=i([w("esri.networks.Network")],T);var je=T;var R=class extends M.JSONSupportMixin(K){constructor(e){super(e),this.rulesCategorized={attachment:[],containment:[],connectivity:[]},this.request=F}initialize(){}load(e){return f(this,null,function*(){let t=this.rulesLayer.load(e).then(()=>this._initializeRulesTable());return this.addResolvingPromise(t),this})}getFeaturesCanAssociateWithClause(e,t,o){return this._getWhereClauseForCompatibleFeatures(e,t,o)}getFeaturesCanAssociateWith(e,t,o){return this._getFeatureSourceLayerId(e)==null?[]:t.filter(r=>this.canAssociateFeatures(e,r,o))}canAssociateFeatures(e,t,o){let[r,s]=this._getFeatureAssetCodes(e),a=this._getFeatureSourceLayerId(e),[u,c]=this._getFeatureAssetCodes(t),h=this._getFeatureSourceLayerId(t);return a!=null&&h!=null&&o.some(n=>{let{type:d,direction:p}=n;return this._getRulesForAssociationType(d).some(y=>this._getRuleFieldValuesForAssociation(y,d,p)?.some(g=>a===g?.ruleLayerIdForSource&&r===g?.ruleAssetGroupCodeForSource&&s===g?.ruleAssetTypeCodeForSource&&h===g?.ruleLayerIdForTarget&&u===g?.ruleAssetGroupCodeForTarget&&c===g?.ruleAssetTypeCodeForTarget))})}getLayersCanAssociateWith(e,t,o){return this._getFeatureSourceLayerId(e)==null?[]:t.filter(r=>this.canAssociateFeatureToLayer(e,r,o))}canAssociateFeatureToLayer(e,t,o){let r=$(t)?t.parent:t;if(!r)return!1;let s=r.layerId,a=$(t)?t.subtypeCode:null,[u,c]=this._getFeatureAssetCodes(e),h=this._getFeatureSourceLayerId(e);return h!=null&&o.some(n=>{let{type:d,direction:p}=n;return this._getRulesForAssociationType(d).some(y=>this._getRuleFieldValuesForAssociation(y,d,p)?.some(g=>h===g?.ruleLayerIdForSource&&u===g?.ruleAssetGroupCodeForSource&&c===g?.ruleAssetTypeCodeForSource&&s===g?.ruleLayerIdForTarget&&(a==null||a===g?.ruleAssetGroupCodeForTarget)))})}getFeatureSQL(e,t){let o=e.layerId.toString(),r=e.fieldsIndex?.normalizeFieldName("assetGroup"),s=e.fieldsIndex?.normalizeFieldName("assetType"),a=r?t.attributes[r]:null,u=s?t.attributes[s]:null,c=this.rulesHash[o];if(c){let h=c.assetGroupHash[a];if(h)return h.assetTypeHash[u]||null}return null}_initializeRulesTable(){return f(this,null,function*(){let e={},t;(function(r){r[r.from=0]="from",r[r.to=1]="to",r[r.via=2]="via"})(t||(t={}));let o=[{networkSourceId:"fromNetworkSource",assetGroupId:"fromAssetGroup",assetTypeId:"fromAssetType"},{networkSourceId:"toNetworkSource",assetGroupId:"toAssetGroup",assetTypeId:"toAssetType"},{networkSourceId:"viaNetworkSource",assetGroupId:"viaAssetGroup",assetTypeId:"viaAssetType"}];this.rulesCategorized={attachment:[],containment:[],connectivity:[]};for(let r of this.rules){if(r.ruleType===A.RTAttachment){this.rulesCategorized.attachment.push(r);continue}if(r.ruleType===A.RTContainment){this.rulesCategorized.containment.push(r);continue}if(r.ruleType===A.RTJunctionJunctionConnectivity){this.rulesCategorized.connectivity.push(r);continue}this.rulesCategorized.connectivity.push(r);let s=[[t.from,t.to],[t.to,t.from]];r.ruleType===A.RTEdgeJunctionEdgeConnectivity&&(s=[[t.from,t.via],[t.via,t.from],[t.to,t.via],[t.via,t.to]]);for(let a of s){let u=a.shift(),c=a.shift(),h=!1;switch(r.ruleType){case A.RTEdgeJunctionEdgeConnectivity:h=u===t.from||u===t.to;break;case A.RTJunctionEdgeConnectivity:h=u===t.to}let n=o[u],d=r[n.networkSourceId]?.layerId.toString()??"",p=r[n.assetGroupId]?.assetGroupCode?.toString(),y=r[n.assetTypeId],m=y?.assetTypeCode?.toString(),g=o[c],C=r[g.networkSourceId]?.layerId.toString()??"",S=r[g.assetGroupId]?.assetGroupCode?.toString(),G=r[g.assetTypeId],q=G?.assetTypeCode?.toString(),x=e[d]??{assetGroupHash:{}};if(!(p&&m&&S&&q))continue;let D=x.assetGroupHash[p]??{assetTypeHash:{}},I=D.assetTypeHash[m]??{};if(I[C]=I[C]??{},h){I[d]=I[d]??{};let L=`(assetgroup = ${p} AND assettype = ${m})`;G?.connectivityPolicy==="esriNECPEndVertex"?I[d].endVertex=I[d]?.endVertex?`${I[d].endVertex}`:`${L}`:I[d].anyVertex=I[d].anyVertex?`${I[d].anyVertex}`:`${L}`}let v=`(assetgroup = ${S} AND assettype = ${q})`;G?.connectivityPolicy==="esriNECPEndVertex"?I[C].endVertex=I[C]?.endVertex?`${I[C].endVertex} OR ${v}`:`${v}`:I[C].anyVertex=I[C]?.anyVertex?`${I[C].anyVertex} OR ${v}`:`${v}`,D.assetTypeHash[m]=I,x.assetGroupHash[p]=D,e[d]=x}}this._set("rulesHash",e)})}_getRuleFieldValuesForAssociation(e,t,o="from"){switch(t){case"attachment":case"containment":return o==="from"?[{ruleLayerIdForSource:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.fromAssetType?.assetTypeCode,ruleLayerIdForTarget:e.toNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.toAssetType?.assetTypeCode}]:[{ruleLayerIdForSource:e.toNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.toAssetType?.assetTypeCode,ruleLayerIdForTarget:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.fromAssetType?.assetTypeCode}];case"connectivity":case"junction-junction-connectivity":return[{ruleLayerIdForSource:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.fromAssetType?.assetTypeCode,ruleLayerIdForTarget:e.toNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.toAssetType?.assetTypeCode},{ruleLayerIdForSource:e.toNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.toAssetType?.assetTypeCode,ruleLayerIdForTarget:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.fromAssetType?.assetTypeCode}];case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":return e.ruleType===A.RTEdgeJunctionEdgeConnectivity?[{ruleLayerIdForSource:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.fromAssetType?.assetTypeCode,ruleLayerIdForTarget:e.viaNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.viaAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.viaAssetType?.assetTypeCode},{ruleLayerIdForSource:e.viaNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.viaAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.viaAssetType?.assetTypeCode,ruleLayerIdForTarget:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.fromAssetType?.assetTypeCode},{ruleLayerIdForSource:e.toNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.toAssetType?.assetTypeCode,ruleLayerIdForTarget:e.viaNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.viaAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.viaAssetType?.assetTypeCode},{ruleLayerIdForSource:e.viaNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.viaAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.viaAssetType?.assetTypeCode,ruleLayerIdForTarget:e.toNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.toAssetType?.assetTypeCode}]:[{ruleLayerIdForSource:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.fromAssetType?.assetTypeCode,ruleLayerIdForTarget:e.toNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.toAssetType?.assetTypeCode},{ruleLayerIdForSource:e.toNetworkSource?.layerId,ruleAssetGroupCodeForSource:e.toAssetGroup?.assetGroupCode,ruleAssetTypeCodeForSource:e.toAssetType?.assetTypeCode,ruleLayerIdForTarget:e.fromNetworkSource?.layerId,ruleAssetGroupCodeForTarget:e.fromAssetGroup?.assetGroupCode,ruleAssetTypeCodeForTarget:e.fromAssetType?.assetTypeCode}];default:return[]}}_getWhereClauseForCompatibleFeatures(e,t,o){let r=new Map,[s,a]=this._getAssetFieldNames(e.sourceLayer),[u,c]=this._getFeatureAssetCodes(e),h=this._getFeatureSourceLayerId(e),n=$(t)?t.parent:t,d=$(t)?t.subtypeCode:null;o.forEach(y=>{let{type:m,direction:g}=y;this._getRulesForAssociationType(m).forEach(C=>{this._getRuleFieldValuesForAssociation(C,m,g).forEach(S=>{if(S.ruleAssetGroupCodeForTarget!=null&&S.ruleAssetTypeCodeForTarget!=null&&h===S?.ruleLayerIdForSource&&u===S?.ruleAssetGroupCodeForSource&&c===S?.ruleAssetTypeCodeForSource&&n.layerId===S?.ruleLayerIdForTarget&&(d==null||d===S?.ruleAssetGroupCodeForTarget)){let G=r.get(S.ruleAssetGroupCodeForTarget)??new Set;G.add(S.ruleAssetTypeCodeForTarget),r.set(S.ruleAssetGroupCodeForTarget,G)}})})});let p=[];return this._mergeAssetCodes(r).forEach((y,m)=>p.push(`${s} IN (${m}) AND ${a} IN (${Array.from(y).sort().join(", ")})`)),p.length>1&&(p=p.map(y=>`(${y})`)),p.join(" OR ")}_getRulesForAssociationType(e){let{rulesCategorized:t}=this;switch(e){case"attachment":return t.attachment;case"containment":return t.containment;case"connectivity":case"junction-junction-connectivity":return t.connectivity.filter(o=>o.ruleType===A.RTJunctionJunctionConnectivity);case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":return t.connectivity.filter(o=>o.ruleType===A.RTJunctionEdgeConnectivity||o.ruleType===A.RTEdgeJunctionEdgeConnectivity);default:return[]}}_getFeatureSourceLayerId(e){let{sourceLayer:t}=e,o;return be(t)?o=t.layerId:$(t)&&(o=t.parent?.layerId),o??null}_getAssetFieldNames(e){return!e||!("fieldsIndex"in e)?[null,null]:[e.fieldsIndex.normalizeFieldName("assetGroup")??null,e.fieldsIndex.normalizeFieldName("assetType")??null]}_getFeatureAssetCodes(e){let[t,o]=this._getAssetFieldNames(e.sourceLayer);return[t?e.attributes[t]:null,o?e.attributes[o]:null]}_areSetsEqual(e,t){if(e.size!==t.size)return!1;for(let o of e)if(!t.has(o))return!1;return!0}_mergeAssetCodes(e){let t=new Map,o=new Set;for(let[r,s]of e){let a=new Set([r]);for(let[c,h]of e)r!==c&&!o.has(c)&&this._areSetsEqual(s,h)&&(a.add(c),o.add(c));let u=Array.from(a).sort().join(", ");t.set(u,s)}return t}};i([l({constructOnly:!0})],R.prototype,"rulesLayer",void 0),i([l({constructOnly:!0})],R.prototype,"rules",void 0),i([l({readOnly:!0})],R.prototype,"rulesHash",void 0),i([l()],R.prototype,"rulesCategorized",void 0),i([l({constructOnly:!0})],R.prototype,"request",void 0),R=i([w("esri.networks.RulesTable")],R);var Oe=R;var N=class extends Te{constructor(e){super(e),this.rulesTableId=null,this.rulesTableUrl=null,this.subnetworksTableId=null,this.subnetworksTableUrl=null,this.dirtyAreasLayerId=null,this.dirtyAreasLayerUrl=null,this.associationsTable=null,this.associationsTableId=null,this.associationsTableUrl=null}destroy(){this.associationsTable?.destroy()}loadAssociationsTable(){return f(this,null,function*(){if(!this.associationsTable){let{associationsTableUrl:e}=this;if(!e)throw new V("utility-network-system-layers:missing-associations-table-url","Unable to load the associations table, as the `associationsTableUrl` is not set.");this.associationsTable=new Z({url:e})}return yield this.associationsTable.load(),this.associationsTable})}};i([l({constructOnly:!0})],N.prototype,"rulesTableId",void 0),i([l({constructOnly:!0})],N.prototype,"rulesTableUrl",void 0),i([l({constructOnly:!0})],N.prototype,"subnetworksTableId",void 0),i([l({constructOnly:!0})],N.prototype,"subnetworksTableUrl",void 0),i([l({constructOnly:!0})],N.prototype,"dirtyAreasLayerId",void 0),i([l({constructOnly:!0})],N.prototype,"dirtyAreasLayerUrl",void 0),i([l()],N.prototype,"associationsTable",void 0),i([l({constructOnly:!0})],N.prototype,"associationsTableId",void 0),i([l({constructOnly:!0})],N.prototype,"associationsTableUrl",void 0),N=i([w("esri.networks.support.NetworkSystemLayers")],N);var Ve=N;var P=class extends M{constructor(e){super(e),this.id=null,this.name=null}};i([l({type:Number,json:{read:{source:"terminalId"},write:{target:"terminalId"}}})],P.prototype,"id",void 0),i([l({type:String,json:{read:{source:"terminalName"},write:{target:"terminalName"}}})],P.prototype,"name",void 0),i([l({type:Boolean,json:{write:!0}})],P.prototype,"isUpstreamTerminal",void 0),P=i([w("esri.networks.support.Terminal")],P);var Je=P;var te=new ge({esriUNTMBidirectional:"bidirectional",esriUNTMDirectional:"directional"}),j=class extends M{constructor(e){super(e),this.defaultConfiguration=null,this.id=null,this.name=null,this.terminals=[],this.traversabilityModel=null}};i([l({type:String,json:{write:!0}})],j.prototype,"defaultConfiguration",void 0),i([l({type:Number,json:{read:{source:"terminalConfigurationId"},write:{target:"terminalConfigurationId"}}})],j.prototype,"id",void 0),i([l({type:String,json:{read:{source:"terminalConfigurationName"},write:{target:"terminalConfigurationName"}}})],j.prototype,"name",void 0),i([l({type:[Je],json:{write:!0}})],j.prototype,"terminals",void 0),i([l({type:te.apiValues,json:{type:te.jsonValues,read:te.read,write:te.write}})],j.prototype,"traversabilityModel",void 0),j=i([w("esri.networks.support.TerminalConfiguration")],j);var de=j;var Pe=W()({Pending:"job-waiting",InProgress:"job-executing",Completed:"job-succeeded"}),J=class extends Le{constructor(e){super(e),this.statusUrl=null,this.status=null,this.submissionTime=null,this.lastUpdatedTime=null,this._timer=void 0}destroy(){clearInterval(this._timer)}checkJobStatus(e){return f(this,null,function*(){let t=_(b({},e),{query:{f:"json"}}),{data:o}=yield F(this.statusUrl,t),r=o.traceResults?b(b({},o.traceResults),o):o;return this.read(r),this})}waitForJobCompletion(){return f(this,arguments,function*(e={}){let{interval:t=1e3,statusCallback:o}=e;return new Promise((r,s)=>{this._clearTimer();let a=setInterval(()=>{this._timer||s(H()),this.checkJobStatus().then(u=>{let{status:c}=u;switch(this.status=c,c){case"job-succeeded":this._clearTimer(),r(this);break;case"job-waiting":case"job-executing":o&&o(this)}},u=>{this._clearTimer(),s(u)})},t);this._timer=a})})}_clearTimer(){clearInterval(this._timer),this._timer=void 0}};i([l({type:String,json:{write:!0}})],J.prototype,"statusUrl",void 0),i([Y(Pe)],J.prototype,"status",void 0),i([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.submissionTime=e?e.getTime():null}}}})],J.prototype,"submissionTime",void 0),i([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.lastUpdatedTime=e?e.getTime():null}}}})],J.prototype,"lastUpdatedTime",void 0),J=i([w("esri.networks.support.TraceJobInfo")],J);var xe=J;var E=class e extends je{constructor(t){super(t),this.sharedNamedTraceConfigurations=[],this.type="utility",this._terminalById=new Map}get serviceTerritoryFeatureLayerId(){return this.dataElement?.serviceTerritoryFeatureLayerId??null}get networkSystemLayers(){return new Ve({rulesTableId:this.sourceJSON?.systemLayers.rulesTableId,rulesTableUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.rulesTableId}`:null,subnetworksTableId:this.sourceJSON?.systemLayers.subnetworksTableId,subnetworksTableUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.subnetworksTableId}`:null,dirtyAreasLayerId:this.sourceJSON?.systemLayers.dirtyAreasLayerId,dirtyAreasLayerUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.dirtyAreasLayerId}`:null,associationsTableId:this.sourceJSON?.systemLayers.associationsTableId,associationsTableUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.associationsTableId}`:null})}get terminalConfigurations(){return this.dataElement?.terminalConfigurations.map(t=>de.fromJSON(t))||[]}get domainNetworkNames(){return this.dataElement?.domainNetworks.map(t=>t.domainNetworkName)||[]}get _utilityLayerList(){let t=new Set;return this.dataElement?.domainNetworks?.map(o=>{o?.edgeSources?.map(({layerId:r,sourceId:s})=>{this._layerIdBySourceId.set(s,r),this._sourceIdByLayerId.set(r,s),t.add(r)}),o?.junctionSources?.map(({layerId:r,sourceId:s})=>{this._layerIdBySourceId.set(s,r),this._sourceIdByLayerId.set(r,s),t.add(r)})}),t}load(t){return f(this,null,function*(){return this.addResolvingPromise(ye(e.prototype,this,"load").call(this,t)),this.addResolvingPromise(this._loadNamedTraceConfigurationsFromNetwork(t)),this})}getTerminalConfiguration(t){let o=null,r=null,s=t.layer,a=null;if(s?.type==="feature"){if(a=s.layerId,a===null)return null}else if(s?.type!=="subtype-sublayer"||(a=s?.parent?.layerId??null,a===null))return null;let u=t.attributes;if(u==null)return null;for(let n of Object.keys(u))n.toUpperCase()==="ASSETGROUP"&&(o=t.getAttribute(n)),n.toUpperCase()==="ASSETTYPE"&&(r=t.getAttribute(n));if(!this.dataElement)return null;let c=null,h=this.dataElement.domainNetworks;for(let n of h){let d=n.junctionSources?.find(p=>p.layerId===a);if(d){let p=d.assetGroups?.find(y=>y.assetGroupCode===o);if(p){let y=p.assetTypes?.find(m=>m.assetTypeCode===r);if(y?.isTerminalConfigurationSupported){c=y.terminalConfigurationId;break}}}}if(c!=null){let n=this.dataElement.terminalConfigurations,d=n?.find(p=>p.terminalConfigurationId===c);return d?de.fromJSON(d):null}return null}getTierNames(t){return this.dataElement?.domainNetworks.find(r=>r.domainNetworkName===t)?.tiers.map(r=>r.name)||[]}getRulesTable(){return f(this,null,function*(){return this._sharedRulesTable||(this._sharedRulesTable=this._createRulesTable()),yield this._sharedRulesTable})}getTerminalById(t){if(!this.dataElement||t==null)return null;let o=this._terminalById.get(t);return o??(this.terminalConfigurations.forEach(r=>{r.terminals.forEach(s=>{this._terminalById.set(s.id,s)})}),this._terminalById.get(t))}isUtilityLayer(t){return"layerId"in t?this._utilityLayerList.has(t?.layerId)&&(t.url?.startsWith(this.featureServiceUrl)??!1):!(t.type!=="subtype-sublayer"||!t.parent)&&this._utilityLayerList.has(t.parent.layerId)&&(t.parent.url?.startsWith(this.featureServiceUrl)??!1)}queryAssociations(t,o){return f(this,null,function*(){let[{queryAssociations:r},{default:s}]=yield Promise.all([import("./chunk-7VIISB4V.js"),import("./chunk-KGEEONBZ.js")]),a=s.from(t);return a.gdbVersion=this.gdbVersion,a.moment=this.historicMoment,(yield r(this.networkServiceUrl,a,o)).associations})}synthesizeAssociationGeometries(t){return f(this,null,function*(){let[{synthesizeAssociationGeometries:o},{default:r}]=yield Promise.all([import("./chunk-EVOTH4E3.js"),import("./chunk-LGZKGQF3.js")]),s=r.from(t);return s.gdbVersion=this.gdbVersion,s.moment=this.historicMoment,o(this.networkServiceUrl,s)})}trace(t){return f(this,null,function*(){let[{trace:o},{default:r}]=yield Promise.all([import("./chunk-DCV22VTG.js"),import("./chunk-MPAYKWJ2.js")]),s=r.from(t);return s.gdbVersion=this.gdbVersion,s.moment=this.historicMoment,o(this.networkServiceUrl,s)})}submitTraceJob(t){return f(this,null,function*(){let[{submitTraceJob:o},{default:r}]=yield Promise.all([import("./chunk-DCV22VTG.js"),import("./chunk-MPAYKWJ2.js")]),s=r.from(t);s.gdbVersion=this.gdbVersion,s.moment=this.historicMoment;let a=yield o(this.networkServiceUrl,s);return new xe({statusUrl:a})})}canAddAssociation(t){return f(this,null,function*(){let o=yield this.getRulesTable();if(!o)return!1;yield o.load();let r=(n,d)=>n?n.terminalId===1?!d?.terminalId||d?.terminalId===n.terminalId:n.terminalId===d?.terminalId:!d?.terminalId,s=n=>({fromRuleElement:{networkSource:n.fromNetworkSource,assetGroup:n.fromAssetGroup,assetType:n.fromAssetType,terminal:n.fromTerminal},viaRuleElement:n.viaNetworkSource?{networkSource:n.viaNetworkSource,assetGroup:n.viaAssetGroup,assetType:n.viaAssetType,terminal:n.viaTerminal}:void 0,toRuleElement:{networkSource:n.toNetworkSource,assetGroup:n.toAssetGroup,assetType:n.toAssetType,terminal:n.toTerminal}}),a=(n,d,p=!0)=>n.networkSource?.sourceId===d.networkSourceId&&n.assetGroup?.assetGroupCode===d.assetGroupCode&&n.assetType?.assetTypeCode===d.assetTypeCode&&(!p||r(n.terminal,d)),u=(n,d)=>{let{fromRuleElement:p,toRuleElement:y}=s(n);return a(p,d.fromNetworkElement,!1)&&a(y,d.toNetworkElement,!1)},c=(n,d)=>{let{fromRuleElement:p,toRuleElement:y}=s(n);return a(p,d.fromNetworkElement)&&a(y,d.toNetworkElement)||a(p,d.toNetworkElement)&&a(y,d.fromNetworkElement)},h=(n,d)=>{let{fromRuleElement:p,toRuleElement:y,viaRuleElement:m}=s(n);return a(p,d.fromNetworkElement)&&a(m,d.toNetworkElement)||a(p,d.toNetworkElement)&&a(m,d.fromNetworkElement)||a(m,d.fromNetworkElement)&&a(y,d.toNetworkElement)||a(m,d.toNetworkElement)&&a(y,d.fromNetworkElement)};return t.associationType==="containment"?o.rulesCategorized.containment.some(n=>u(n,t)):t.associationType==="attachment"?o.rulesCategorized.attachment.some(n=>u(n,t)):o.rulesCategorized.connectivity.some(n=>n.ruleType===A.RTEdgeJunctionEdgeConnectivity?h(n,t):c(n,t))})}generateAddAssociations(t){let{associationsTable:o}=this.networkSystemLayers,{fromNetworkSourceId:r,fromGlobalId:s,fromTerminalId:a,toNetworkSourceId:u,toGlobalId:c,toTerminalId:h,associationType:n,isContentVisible:d,percentAlong:p,globalId:y}=ke(o);return{addFeatures:t.map(m=>new Q({attributes:{[r]:m.fromNetworkElement?.networkSourceId,[s]:m.fromNetworkElement?.globalId,[a]:m.fromNetworkElement?.terminalId,[u]:m.toNetworkElement?.networkSourceId,[c]:m.toNetworkElement?.globalId,[h]:m.toNetworkElement?.terminalId,[n]:Ne[m.associationType],[d]:m.isContentVisible==null?void 0:m.isContentVisible?1:0,[p]:m.percentAlong,[y]:m.globalId}})),id:this.networkSystemLayers.associationsTableId,identifierFields:{globalIdField:o?.globalIdField??"globalid",objectIdField:o?.objectIdField??"objectid"}}}generateDeleteAssociations(t){let{associationsTable:o,associationsTableId:r}=this.networkSystemLayers;return{deleteFeatures:t.map(s=>({globalId:s.globalId})),id:r,identifierFields:{globalIdField:o?.globalIdField??"globalid",objectIdField:o?.objectIdField??"objectid"}}}loadAssociationsTable(){return f(this,null,function*(){return this.networkSystemLayers.loadAssociationsTable()})}_loadNamedTraceConfigurationsFromNetwork(t){return f(this,null,function*(){if(this.sharedNamedTraceConfigurations?.length===0)return;let o=this.sharedNamedTraceConfigurations.map(s=>s.globalId),r=yield this.queryNamedTraceConfigurations({globalIds:o},t);for(let s of this.sharedNamedTraceConfigurations){let a=r?.find(u=>u.globalId===s.globalId);if(a){let u=a.write({},{origin:"service"});s.read(u,{origin:"service"})}}})}_createRulesTable(){return f(this,null,function*(){let t=this.networkSystemLayers.rulesTableUrl,o=new Z({url:t});yield o.load();let r=this.dataElement?.domainNetworks;if(!r)return null;let s=r.flatMap(u=>[...u.edgeSources||[],...u.junctionSources||[]]),a=(yield De(o)).map(u=>this._hydrateRuleInfo(o,s,u));return new Oe({rulesLayer:o,rules:a})})}_hydrateRuleInfo(t,o,r){let s=t.fieldsIndex,a=s.get("RULETYPE"),u=s.get("CREATIONDATE"),c=s.get("FROMNETWORKSOURCEID"),h=s.get("FROMASSETGROUP"),n=s.get("FROMASSETTYPE"),d=s.get("FROMTERMINALID"),p=s.get("TONETWORKSOURCEID"),y=s.get("TOASSETGROUP"),m=s.get("TOASSETTYPE"),g=s.get("TOTERMINALID"),C=s.get("VIANETWORKSOURCEID"),S=s.get("VIAASSETGROUP"),G=s.get("VIAASSETTYPE"),q=s.get("VIATERMINALID"),x=r.attributes[a.name],D=new Date(r.attributes[u.name]),I=[{networkSourceId:r.attributes[c.name],assetGroupId:r.attributes[h.name],assetTypeId:r.attributes[n.name],terminalId:r.attributes[d.name]},{networkSourceId:r.attributes[p.name],assetGroupId:r.attributes[y.name],assetTypeId:r.attributes[m.name],terminalId:r.attributes[g.name]},{networkSourceId:r.attributes[C.name],assetGroupId:r.attributes[S.name],assetTypeId:r.attributes[G.name],terminalId:r.attributes[q.name]}],v;(function(k){k[k.from=0]="from",k[k.to=1]="to",k[k.via=2]="via"})(v||(v={}));let L={ruleType:x,creationDate:D};for(let k of[v.from,v.to,v.via]){if(x!==A.RTEdgeJunctionEdgeConnectivity&&k===v.via)continue;let B=I[k],ce=o.find(z=>z.sourceId===B.networkSourceId),pe=ce?.assetGroups.find(z=>z.assetGroupCode===B.assetGroupId),me=pe?.assetTypes.find(z=>z.assetTypeCode===B.assetTypeId),Me=this._getTerminal(me,B),O="";switch(k){case v.from:O="from";break;case v.to:O="to";break;case v.via:O="via"}L[`${O}NetworkSource`]=ce,L[`${O}AssetGroup`]=pe,L[`${O}AssetType`]=me,L[`${O}Terminal`]=Me?.toJSON()}return L}_getTerminal(t,o){let r=t?.terminalConfigurationId;return this.terminalConfigurations?.find(a=>a.id===r)?.terminals?.find(a=>a.id===o.terminalId)??null}};function De(e){return f(this,null,function*(){let t=new Fe({where:"1=1",outFields:["*"]});return(yield ue(e,t)).features})}i([l({type:[Ge],json:{origins:{"web-map":{read:{source:"traceConfigurations"},write:{target:"traceConfigurations"}},service:{read:{source:"traceConfigurations"}}},read:!1}})],E.prototype,"sharedNamedTraceConfigurations",void 0),i([l({type:["utility"],readOnly:!0,json:{read:!1,write:!1}})],E.prototype,"type",void 0),i([l({readOnly:!0})],E.prototype,"serviceTerritoryFeatureLayerId",null),i([l({readOnly:!0})],E.prototype,"networkSystemLayers",null),i([l({readOnly:!0})],E.prototype,"terminalConfigurations",null),i([l({readOnly:!0})],E.prototype,"domainNetworkNames",null),E=i([w("esri.networks.UtilityNetwork")],E);var io=E;export{io as a};
