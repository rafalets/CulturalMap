import{c as ce}from"./chunk-4NVXAHNZ.js";import{b as oe,c as se,d as le}from"./chunk-PNEA5KPJ.js";import{m as ne,n as ie,o as re}from"./chunk-3ZANJLLA.js";import{a as te}from"./chunk-7QY3BMVN.js";import{a as ae}from"./chunk-TJSLQWS6.js";import{a as Q}from"./chunk-EBK2L6ZQ.js";import{a as ee}from"./chunk-AESEF3B2.js";import{g as E}from"./chunk-NTVLK3P2.js";import{a as v}from"./chunk-WMQNRNIU.js";import{G as Y}from"./chunk-IG66NQHW.js";import{c as X}from"./chunk-VGD3XLDH.js";import{F as S}from"./chunk-E57FTRWF.js";import{S as H,h as z,t as q}from"./chunk-U4J5SECU.js";import{r as V,t as F}from"./chunk-HHDFN2GK.js";import{a as h,b as T,f as k}from"./chunk-VTHXE323.js";var L=()=>V.getLogger("esri.layers.ogc.ogcFeatureUtils"),ue="startindex",we=new Set([ue,"offset"]),de="http://www.opengis.net/def/crs/",Me=`${de}OGC/1.3/CRS84`,l;function Ze(a,s){return k(this,arguments,function*(e,t,i={},n=5){let{links:c}=e,g=y(c,"items",l.geojson)||y(c,"http://www.opengis.net/def/rel/ogc/1.0/items",l.geojson);if(g==null)throw new F("ogc-feature-layer:missing-items-page","Missing items url");let{apiKey:w,customParameters:f,signal:m}=i,O=q(g.href,e.landingPage.url),M=T(h({limit:n},f),{token:w}),W=H(O,M),C={accept:l.geojson},{data:G}=yield S(W,{signal:m,headers:C}),Z=ke(W,n,G.links)??ue;oe(G);let p=se(G,{geometryType:t.geometryType}),d=t.fields||p.fields||[],P=t.hasZ!=null?t.hasZ:p.hasZ,D=p.geometryType,x=t.objectIdField||p.objectIdFieldName||"OBJECTID",o=t.timeInfo,N=d.find(({name:r})=>r===x);if(N)N.editable=!1,N.nullable=!1;else{if(!p.objectIdFieldType)throw new F("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");d.unshift({name:x,alias:x,type:p.objectIdFieldType==="number"?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(x!==p.objectIdFieldName){let r=d.find(({name:u})=>u===p.objectIdFieldName);r&&(r.type="esriFieldTypeInteger")}d===p.fields&&p.unknownFields.length>0&&L().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:p.unknownFields}});for(let r of d){if(r.name==null&&(r.name=r.alias),r.alias==null&&(r.alias=r.name),r.type!=="esriFieldTypeOID"&&r.type!=="esriFieldTypeGlobalID"&&(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable),!r.name)throw new F("ogc-feature-layer:invalid-field-name","field name is missing",{field:r});if(!ee.jsonValues.includes(r.type))throw new F("ogc-feature-layer:invalid-field-type",`invalid type for field "${r.name}"`,{field:r})}if(o){let r=new Q(d);if(o.startTimeField){let u=r.get(o.startTimeField);u?(o.startTimeField=u.name,u.type="esriFieldTypeDate"):o.startTimeField=null}if(o.endTimeField){let u=r.get(o.endTimeField);u?(o.endTimeField=u.name,u.type="esriFieldTypeDate"):o.endTimeField=null}if(o.trackIdField){let u=r.get(o.trackIdField);u?o.trackIdField=u.name:(o.trackIdField=null,L().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:o}}))}o.timeReference||={timeZoneIANA:X},o.startTimeField||o.endTimeField||(L().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:o}}),o=void 0)}return{drawingInfo:D?ae(D):null,extent:Te(e),geometryType:D,fields:d,hasZ:!!P,objectIdField:x,paginationParameter:Z,timeInfo:o}})}function Je(i){return k(this,arguments,function*(e,t={}){let{links:n,url:a}=e,s=y(n,"data",l.json)||y(n,"http://www.opengis.net/def/rel/ogc/1.0/data",l.json);if(s==null)throw new F("ogc-feature-layer:missing-collections-page","Missing collections url");let{apiKey:c,customParameters:g,signal:w}=t,f=q(s.href,a),{data:m}=yield S(f,{signal:w,headers:{accept:l.json},query:T(h({},g),{token:c})});for(let O of m.collections)O.landingPage=e;return m})}function Ke(i){return k(this,arguments,function*(e,t={}){let{links:n,url:a}=e,s=y(n,"conformance",l.json)||y(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance",l.json);if(s==null)throw new F("ogc-feature-layer:missing-conformance-page","Missing conformance url");let{apiKey:c,customParameters:g,signal:w}=t,f=q(s.href,a),{data:m}=yield S(f,{signal:w,headers:{accept:l.json},query:T(h({},g),{token:c})});return m})}function ze(i){return k(this,arguments,function*(e,t={}){let{apiKey:n,customParameters:a,signal:s}=t,{data:c}=yield S(e,{signal:s,headers:{accept:l.json},query:T(h({},a),{token:n})});return c.url=e,c})}function Ee(i){return k(this,arguments,function*(e,t={}){let{links:n,url:a}=e,s=y(n,"service-desc",l.openapi);if(s==null)return L().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;let{apiKey:c,customParameters:g,signal:w}=t,f=q(s.href,a),{data:m}=yield S(f,{signal:w,headers:{accept:l.openapi},query:T(h({},g),{token:c})});return m})}function Qe(e){let t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),i=t?.groups;if(!i)return null;let{authority:n,code:a}=i;switch(n.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return v.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return v.WGS84.wkid;default:return null}case"esri":case"epsg":{let s=Number.parseInt(a,10);return Number.isNaN(s)?null:s}default:return null}}function _e(e,t,i){return k(this,null,function*(){let n=yield be(e,t,i);return re(n)})}function be(e,t,i){return k(this,null,function*(){let{collection:{links:n,landingPage:{url:a}},layerDefinition:s,maxRecordCount:c,queryParameters:{apiKey:g,customParameters:w},spatialReference:f,supportedCrs:m}=e,O=y(n,"items",l.geojson)||y(n,"http://www.opengis.net/def/rel/ogc/1.0/items",l.geojson);if(O==null)throw new F("ogc-feature-layer:missing-items-page","Missing items url");let{geometry:M,num:W,start:C,timeExtent:G,where:Z}=t;if(t.objectIds)throw new F("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");let p=v.fromJSON(f),d=t.outSpatialReference??p,P=d.isWGS84?null:fe(d,m),D=Ie(M,m),x=Fe(G),o=je(Z),N=W??(C==null?c:10),r=C===0?void 0:C,{fields:u,geometryType:A,hasZ:J,objectIdField:$,paginationParameter:me}=s,pe=q(O.href,a),{data:B}=yield S(pe,T(h({},i),{query:T(h(h({},w),D),{crs:P,datetime:x,query:o,limit:N,[me]:r,token:g}),headers:{accept:l.geojson}})),R=le(B,{geometryType:A,hasZ:J,objectIdField:$}),ge=R.length===N&&!!y(B.links??[],"next",l.geojson),U=new Q(u);for(let b of R){let I={};ce(U,I,b.attributes,!0);for(let K of U.fields)K.nullable&&!(K.name in I)&&(I[K.name]=null);I[$]=b.attributes[$],b.attributes=I}if(!P&&d.isWebMercator){for(let b of R)if(b.geometry!=null&&A!=null){let I=ie(b.geometry,A,J,!1);I.spatialReference=v.WGS84,b.geometry=ne(E(I,d))}}for(let b of R)b.objectId=b.attributes[$];let ye=P||!P&&d.isWebMercator?d.toJSON():Y,j=new te;return j.exceededTransferLimit=ge,j.features=R,j.fields=u,j.geometryType=A,j.hasZ=J,j.objectIdFieldName=$,j.spatialReference=ye,j})}function he(e){return e!=null&&e.type==="extent"}function fe(e,t){let{isWebMercator:i,wkid:n}=e;if(!n)return null;let a=i?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return a?`${de}${a}`:null}function _(e){if(e==null)return"";let{xmin:t,ymin:i,xmax:n,ymax:a}=e;return`${t},${i},${n},${a}`}function Fe(e){if(e==null)return null;let{start:t,end:i}=e;return`${t!=null?t.toISOString():".."}/${i!=null?i.toISOString():".."}`}function je(e){return e!=null&&e&&e!=="1=1"?e:null}function Ie(e,t){if(!he(e))return null;let{spatialReference:i}=e;if(!i||i.isWGS84)return{bbox:_(e)};let n=fe(i,t);return n!=null?{bbox:_(e),"bbox-crs":n}:i.isWebMercator?{bbox:_(E(e,v.WGS84))}:null}function Te(e){let t=e.extent?.spatial;if(!t)return null;let i=t.bbox[0],n=i.length===4,[a,s]=i,c=n?void 0:i[2];return{xmin:a,ymin:s,xmax:n?i[2]:i[3],ymax:n?i[3]:i[4],zmin:c,zmax:n?void 0:i[5],spatialReference:v.WGS84.toJSON()}}function y(e,t,i){return e.find(({rel:n,type:a})=>n===t&&a===i)??e.find(({rel:n,type:a})=>n===t&&!a)}function ke(e,t,i){if(!i)return;let n=y(i,"next",l.geojson),a=z(n?.href)?.query;if(!a)return;let s=z(e).query,c=Object.keys(s??{});return Object.entries(a).filter(([f])=>!c.includes(f)).find(([f,m])=>we.has(f.toLowerCase())&&Number.parseInt(m,10)===t)?.[0]}(function(e){e.json="application/json",e.geojson="application/geo+json",e.openapi="application/vnd.oai.openapi+json;version=3.0"})(l||(l={}));export{de as a,Me as b,Ze as c,Je as d,Ke as e,ze as f,Ee as g,Qe as h,_e as i,be as j};
