import{$ as ea,A as se,B as oi,C as qe,D as A,E as bt,F as ni,G as ar,H as tt,J as gs,K as de,L as Ze,M as qt,N as Fe,O as Yi,P as Ut,Q as it,R as ue,S as at,T as J,U as Ke,V as xs,W as vs,X as bs,Z as _e,_ as Ji,a as ps,aa as W,b as ee,ba as E,c as X,ca as Ss,d as s,da as g,e as y,ea as F,f as T,fa as c,g as v,ga as _,h as Et,ha as Ce,i as Qi,ia as li,j as ms,ja as St,k as R,ka as ta,l as si,la as Vt,m as Bt,ma as C,n as Y,na as ui,o as Pi,p as cs,q as ds,r as ir,s as le,t as fs,u as D,v as ye,y as hs,z as ys}from"./chunk-KQSP6CH6.js";import{b as tr}from"./chunk-423EPWZ2.js";import{a as Ki,b as ls,c as $i}from"./chunk-RME3N3WY.js";import{a as Ja,b as ns}from"./chunk-TTCWVZMG.js";import{B as zi,E as ss,F as os,a as Be,b as Ti,c as Ka,d as ri,e as ji,f as Wr,g as jr,h as $a,i as Xa,j as Zr,k as Kr,l as $r,m as Zi,n as Xr,o as Qr,p as Yr,q as Jr,r as es,s as ts,t as is,v as as,w as rs,x as Qa,y as Ya}from"./chunk-BKA6DT3N.js";import{a as H}from"./chunk-WH5SLVE3.js";import{y as Nr}from"./chunk-WQQ6B254.js";import{c as Ur,f as Ni}from"./chunk-R3ABULTC.js";import{a as Hr}from"./chunk-W5OI4BJ2.js";import{a as Or}from"./chunk-3V2UIH2D.js";import{b as er,d as xt,e as Mi,i as ce,j as us,k as Xi,l as L,m as K,n as U,o as B,p as N,q as vt}from"./chunk-7HLFOT25.js";import{b as ai}from"./chunk-HUWVQAJL.js";import{M as Za,e as kr,s as ja,t as Gr,v as Wi}from"./chunk-X7BNFUFQ.js";import{i as ii,k as Gi}from"./chunk-BUZBVNOM.js";import{a as Rt,b as Hi,h as Ie,i as Lt,j as je,k as et,l as Fi,n as nt,o as Na,p as gt,q as ki,r as Wa}from"./chunk-HM5RIVQC.js";import{e as Br,h as qr}from"./chunk-DJW5LMRG.js";import{b as Er}from"./chunk-VOB6IBIW.js";import{c as Lr}from"./chunk-63B3IOWG.js";import{a as Rr}from"./chunk-6JJCXUHW.js";import{a as ot,c as Ga}from"./chunk-OLOKUDVI.js";import{ia as Ar}from"./chunk-IG66NQHW.js";import{D as _r,N as Cr,j as ka}from"./chunk-D2LVMNOU.js";import{a as n,b as w}from"./chunk-QGVBCWUY.js";import{n as Ir,r as Ui,t as ti}from"./chunk-HHDFN2GK.js";import{a as We,c as Pr,t as Dr}from"./chunk-47GHT6OF.js";import{a as m,b as x,f as ei}from"./chunk-VTHXE323.js";var Di={[Ie.BYTE]:1,[Ie.UNSIGNED_BYTE]:1,[Ie.SHORT]:2,[Ie.UNSIGNED_SHORT]:2,[Ie.HALF_FLOAT]:2,[Ie.INT]:4,[Ie.UNSIGNED_INT]:4,[Ie.FLOAT]:4};var ia=class{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(let i in t.vertex){let{data:r,attributes:o}=t.vertex[i],l=Ja.createVertex(e,Wa.STATIC_DRAW,r);this.vertexBuffers.set(i,{buffer:l,attributes:o})}for(let i in t.index){let{data:r}=t.index[i],o=Ja.createIndex(e,Wa.STATIC_DRAW,r);this.indexBuffers.set(i,{buffer:o})}for(let i of t.groups)this.groups.push(x(m({},i),{vertexArrays:new Map}));this.parts=t.parts}bind(e,t,i){this._boundPart=i;let{group:r}=this.parts[this._boundPart],o=this.groups[r];if(!o)throw new Error(`Missing group ${r}.`);let l=o.vertexArrays.get(t.stringHash);if(!l){let u=new Set(t.locations.keys()),p=o.index?this.indexBuffers.get(o.index)?.buffer:null,f=new Map,d=new Map;for(let[h,{buffer:b,attributes:S}]of this.vertexBuffers){let V=S.filter(z=>u.has(z.name));V.length>0&&(f.set(h,V),d.set(h,b))}l=new ns(e,t.locations,f,d,p),o.vertexArrays.set(t.stringHash,l)}e.bindVAO(l)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");let{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{primitive:o,index:l}=this.groups[r];if(l){let u=this.indexBuffers.get(l);if(!u)throw new Error(`Missing index buffer "${l}".`);let{indexType:p}=u.buffer;if(!p)throw new Error("Buffer type error.");e.drawElements(o,i,p,t*Di[p])}else e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(let{vertexArrays:e}of this.groups)for(let[t,i]of e)i.disposeVAOOnly();for(let{buffer:e}of this.vertexBuffers.values())e.dispose();for(let{buffer:e}of this.indexBuffers.values())e.dispose()}};var Gs={position:{type:Ie.SHORT,count:2}},aa=class a extends ia{static create(e,t){let i=[],{stride:r}=t;if(r==null){r=0;for(let[d,{count:h,type:b,offset:S}]of Object.entries(t.layout)){if(S!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=h*Di[b]}}let o=0;for(let[d,{count:h,offset:b,type:S,normalized:V}]of Object.entries(t.layout)){b!=null&&(o=b);let z=new Hr(d,h,S,o,r,V!=null&&V,0);i.push(z),o+=h*Di[S]}let l={primitive:t.primitive};t.index!=null&&(l.index="indexData");let{count:u}=t;if(u==null&&(u=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(u)!==u))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);let p={start:0,count:u,group:0,primitive:t.primitive},f={vertex:{vertexData:{data:t.vertex,attributes:i}},parts:[p],groups:[l]};return t.index!=null&&(f.index={indexData:{data:t.index}}),new a(e,f,t.layout)}static fromVertexStream(e,t){return a.create(e,{primitive:Hi.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:Gs})}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t,i=0){super.bind(e,t,i)}};var rr=class{get forceStaticPath(){return We("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return We("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return We("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!We("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return We("esri-cim-animations-freeze-time")!==!1}},pi=new rr;var $e=class extends C{};n([c(s)],$e.prototype,"globalTime",void 0),n([c(y)],$e.prototype,"animationTextureSize",void 0),n([c(X)],$e.prototype,"animationTexture",void 0),n([c(R)],$e.prototype,"toScreen",void 0),n([c(R)],$e.prototype,"toNdc",void 0),n([c(s)],$e.prototype,"mapRotation",void 0),n([c(s)],$e.prototype,"pixelRatio",void 0);function sr(a){let e=Y(12.9898),t=Y(78.233),i=Y(43758.5453),r=Fe(a,Pi(e,t)),o=Ke(r,Y(3.14));return Ut(_e(o).multiply(i))}function xe(a){return se(a,Y($r))}function Vs(a,e){return a.x.multiply(e.y).subtract(e.x.multiply(a.y))}function ws(a){return a.multiply(2).subtract(1)}function k(a,e){let t=Y(2**e);return Ke(Yi(a.divide(t)),Y(2))}function wt(a,e){return A(k(a,e),Y(.5))}function ra(a,e){return k(a,e+Wi)}function Fs(a,e){return k(a,e)}function Ts(a){let e=k(a.z,7),t=Y(1).subtract(e),i=a.xyz.subtract(cs(0,0,Y(128)));return t.multiply(a).add(e.multiply(i))}function Ft(a){let e=ds(.99609375,.0038909912109375,1519918441772461e-20,59371814131736755e-24);return Fe(a,e)}function or(a){return ue(ue(ue(a.x,a.y),a.z),a.w)}function mi(a){return new s(1).subtract(a)}function wn(a){return a.subtract(new s(1))}function Fn(a,e){return a.subtract(new s(e))}var Oe=class extends C{getVisualVariableData(e){if(!this._vvData){let t=this.getAttributeDataCoords(e);this._vvData=E(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){let t=Ts(e),i=this.size,r=Bt(t.x),o=Bt(t.y).multiply(Bt(256)),l=Bt(t.z).multiply(Bt(256)).multiply(Bt(256)),u=Y(r.add(o).add(l)),p=Ke(u,i),f=u.subtract(p).divide(i);this._uv=new y(p,f).add(.5).divide(i)}return this._uv}getFilterData(e){let t=this.getAttributeDataCoords(e);return E(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){let t=this.getAttributeDataCoords(e);return E(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){let t=this.getAttributeDataCoords(e);return E(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){let t=this.getAttributeDataCoords(e);return E(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){let t=this.getAttributeDataCoords(e);return E(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){let t=this.getAttributeDataCoords(e);return E(this.gpgpu,t).setDebugName("storage4")}getLocalTimeOrigin(e){let t=this.getAttributeDataCoords(e);return E(this.localTimeOrigin,t).x.setDebugName("storage5")}getFilterFlags(e){return We("webgl-ignores-sampler-precision")?gs(this.getFilterData(e).x.multiply(Y(255))):this.getFilterData(e).x.multiply(Y(255))}getLabelVisibility(e){let t=this.getFilterData(e).y.multiply(255);return new s(1).subtract(t)}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}};n([c(X)],Oe.prototype,"filterFlags",void 0),n([c(X)],Oe.prototype,"animation",void 0),n([c(X)],Oe.prototype,"gpgpu",void 0),n([c(X)],Oe.prototype,"localTimeOrigin",void 0),n([c(X)],Oe.prototype,"visualVariableData",void 0),n([c(X)],Oe.prototype,"dataDriven0",void 0),n([c(X)],Oe.prototype,"dataDriven1",void 0),n([c(X)],Oe.prototype,"dataDriven2",void 0),n([c(s)],Oe.prototype,"size",void 0);var ci=class extends C{};n([c(s)],ci.prototype,"activeReasons",void 0),n([c(s)],ci.prototype,"highlightAll",void 0);var Tt=class extends C{};n([c(y)],Tt.prototype,"position",void 0),n([c(s)],Tt.prototype,"distance",void 0),n([c(s)],Tt.prototype,"smallSymbolDistance",void 0),n([c(s)],Tt.prototype,"smallSymbolSizeThreshold",void 0);var fe=class extends C{};n([c(R)],fe.prototype,"displayViewScreenMat3",void 0),n([c(R)],fe.prototype,"displayViewMat3",void 0),n([c(R)],fe.prototype,"displayMat3",void 0),n([c(R)],fe.prototype,"viewMat3",void 0),n([c(R)],fe.prototype,"tileMat3",void 0),n([c(s)],fe.prototype,"displayZoomFactor",void 0),n([c(s)],fe.prototype,"requiredZoomFactor",void 0),n([c(y)],fe.prototype,"tileOffset",void 0),n([c(s)],fe.prototype,"currentScale",void 0),n([c(s)],fe.prototype,"currentZoom",void 0),n([c(s)],fe.prototype,"metersPerSRUnit",void 0),n([c(s)],fe.prototype,"rotation",void 0),n([c(s)],fe.prototype,"pixelRatio",void 0);var oe=class extends li{};n([g(0,T)],oe.prototype,"id",void 0),n([g(1,s)],oe.prototype,"bitset",void 0),n([g(2,y)],oe.prototype,"pos",void 0);var ie=class extends St{};n([g(14,y)],ie.prototype,"nextPos1",void 0),n([g(15,y)],ie.prototype,"nextPos2",void 0);var ae=class extends ta{},te=class extends ui{clip(e,t){let i=new s(0),r=this.storage.getFilterFlags(e);if(i=i.add(Y(2).multiply(Y(1).subtract(ra(r,0)))),this.inside?i=i.add(Y(2).multiply(Y(1).subtract(ra(r,1)))):this.outside?i=i.add(Y(2).multiply(ra(r,1))):this.highlight&&(i=i.add(Y(2).multiply(Y(1).subtract(this._checkHighlight(r))))),t!=null){let o=new s(1).subtract(W(t.x,this.view.currentZoom)),l=W(t.y,this.view.currentZoom);i=i.add(new s(2).multiply(o.add(l)))}return i}getFragmentOutput(e,t,i=new s(1/255)){let r=new Vt;return r.fragColor=this._maybeWriteHittest(t)??this._maybeHighlight(e,i)??e,r}_maybeHighlight(e,t){return this.highlight?new v(e.rgb,W(t,e.a)):null}_checkHighlight(e){let t=this._checkHighlightBit(e,0);for(let i=1;i<Wi;i++)t=t.add(this._checkHighlightBit(e,i));return W(new s(.1),t.add(this.highlight.highlightAll))}_checkHighlightBit(e,t){return Fs(e,t).multiply(k(this.highlight.activeReasons,t))}maybeRunHittest(e,t,i){if(this.hittestRequest==null)return null;let r=this.hittest(e,t,i),o=D(A(r,this.hittestRequest.distance),new s(2),new s(0)),l=this.storage.getAttributeDataCoords(e.id),u=ws(l);o=o.add(this.clip(e.id,e.zoomRange));let p=new v(new s(1/255),0,0,0);return{glPointSize:new s(1),glPosition:new v(u,o,1),color:p}}_maybeWriteHittest(e){return this.hittestRequest!=null?e.color:null}};n([Ce],te.prototype,"inside",void 0),n([Ce],te.prototype,"outside",void 0),n([_(ci)],te.prototype,"highlight",void 0),n([c(Oe)],te.prototype,"storage",void 0),n([c(fe)],te.prototype,"view",void 0),n([_(Tt)],te.prototype,"hittestRequest",void 0);var re=class extends C{};n([c(y)],re.prototype,"size",void 0),n([c(X)],re.prototype,"texture",void 0);var ve=class extends C{getColor(e,t,i){return ye([ni(xe(e),i),t],[qe(e,this.values.first()),this.colors.first()],[bt(e,this.values.last()),this.colors.last()],[!0,()=>{let r=this.values.findIndex(f=>A(f,e)),o=this.values.get(r),l=r.subtract(1),u=this.values.get(l),p=e.subtract(u).divide(o.subtract(u));return J(this.colors.get(l),this.colors.get(r),p)}])}};n([c(ee.ofType(v,8))],ve.prototype,"colors",void 0),n([c(ee.ofType(s,8))],ve.prototype,"values",void 0);var be=class extends C{getOpacity(e){return ye([xe(e),new s(1)],[qe(e,this.opacityValues.first()),this.opacities.first()],[bt(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{let t=this.opacityValues.findIndex(u=>A(u,e)),i=this.opacityValues.get(t),r=t.subtract(1),o=this.opacityValues.get(r),l=e.subtract(o).divide(i.subtract(o));return J(this.opacities.get(r),this.opacities.get(t),l)}])}};n([c(ee.ofType(s,8))],be.prototype,"opacities",void 0),n([c(ee.ofType(s,8))],be.prototype,"opacityValues",void 0);var lt=class extends C{getVVRotationMat4(e){return D(xe(e),si.identity(),()=>{let t=this.getNormalizedAngle(e).multiply(Ka),i=_e(t),r=Ze(t);return new si(r,i,0,0,i.multiply(new s(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return D(xe(e),R.identity(),()=>{let t=this.getNormalizedAngle(e).multiply(Ka),i=_e(t),r=Ze(t);return new R(r,i,0,i.multiply(new s(-1)),r,0,0,0,1)})}getNormalizedAngle(e){let t=se(this.rotationType,new s(Ti.Arithmatic));return D(t,new s(90).subtract(e),e)}};n([c(s)],lt.prototype,"rotationType",void 0);var Ae=class extends C{getSize(e,t){let i=this.minMaxValueAndSize.xy,r=this.minMaxValueAndSize.zw;return D(xe(e),t,()=>{let o=e.subtract(i.x).divide(i.y.subtract(i.x)),l=de(o,new s(0),new s(1));return r.x.add(l.multiply(r.y.subtract(r.x)))})}};n([c(v)],Ae.prototype,"minMaxValueAndSize",void 0);var Te=class extends C{getSizeForViewScale(e){return ye([qe(e,this.values.first()),this.sizes.first()],[bt(e,this.values.last()),this.sizes.last()],[!0,()=>{let t=this.values.findIndex(u=>A(u,e)),i=this.values.get(t),r=t.subtract(1),o=this.values.get(r),l=e.subtract(o).divide(i.subtract(o));return J(this.sizes.get(r),this.sizes.get(t),l)}])}};n([c(ee.ofType(s,8))],Te.prototype,"sizes",void 0),n([c(ee.ofType(s,8))],Te.prototype,"values",void 0);var ze=class extends C{getSize(e,t){let i=ye([xe(e),t],[qe(e,this.values.first()),this.sizes.first()],[bt(e,this.values.last()),this.sizes.last()],[!0,()=>{let r=this.values.findIndex(f=>A(f,e)),o=this.values.get(r),l=r.subtract(1),u=this.values.get(l),p=e.subtract(u).divide(o.subtract(u));return J(this.sizes.get(l),this.sizes.get(r),p)}]);return D(xe(i),t,i)}};n([c(ee.ofType(s,8))],ze.prototype,"sizes",void 0),n([c(ee.ofType(s,8))],ze.prototype,"values",void 0);var Re=class extends C{getSize(e,t){return D(xe(e),t,e.multiply(this.unitValueToPixelsRatio))}};n([c(s)],Re.prototype,"unitValueToPixelsRatio",void 0);function nr(a){return a.visualVariableSizeMinMaxValue!=null||a.visualVariableSizeScaleStops!=null||a.visualVariableSizeStops!=null||a.visualVariableSizeUnitValue!=null}function ut(a,e,t){if(nr(a)){let i=a.storage.getSizeValue(e);return a.visualVariableSizeMinMaxValue?.getSize(i,t)??a.visualVariableSizeScaleStops?.getSizeForViewScale(a.view.currentScale)??a.visualVariableSizeStops?.getSize(i,t)??a.visualVariableSizeUnitValue?.getSize(i,t)}return t}function rt(a,e,t,i=new Et(!1)){if(a.visualVariableColor==null)return t;let r=a.storage.getColorValue(e);return a.visualVariableColor.getColor(r,t,i)}function st(a,e){if(a.visualVariableOpacity==null)return new s(1);let t=a.storage.getOpacityValue(e);return a.visualVariableOpacity.getOpacity(t)}function sa(a,e){if(a.visualVariableRotation==null)return R.identity();let t=a.storage.getRotationValue(e);return a.visualVariableRotation.getVVRotationMat3(t)}function zs(a,e){if(a.visualVariableRotation==null)return new s(0);let t=a.storage.getRotationValue(e);return a.visualVariableRotation.getNormalizedAngle(t)}var di=class extends oe{};n([g(3,v)],di.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),n([g(4,y)],di.prototype,"zoomRange",void 0);var oa=class extends ae{},Le=class extends te{_getScreenPosition(e){let{pos:t,translation:i,rotation:r,scale:o,offset:l,id:u,vvScale:p}=e,f=zs(this,u).multiply(Math.PI/180),d=i.x.multiply(4/3),h=i.y.multiply(-1).multiply(4/3),b=_e(f),S=Ze(f),V=S.multiply(d).add(le(b).multiply(h)),z=b.multiply(d).add(S.multiply(h)),M=_e(r.subtract(f)),P=Ze(r.subtract(f)),O=new s(0),Q=new s(1),{pixelRatio:ne}=this.animationInfo,G=new R(Q,O,O,O,Q,O,V.multiply(ne),z.multiply(ne),Q),j=new R(P,M.multiply(-1),O,M,P,O,0,0,Q),$=o.multiply(p).multiply(ne).multiply(4/3),Z=j.multiply($),I=this.animationInfo.toScreen.multiply(new T(t,1)),wi=G.multiply(I).xy,Jt=Z.multiply(new T(l,0)).xy;return wi.add(Jt)}_clip(e,t){let i=super.clip(e,t),r=qe(this._getLocalTimeOrigin(e),new s(0));return pi.forceGlobalTimeOrigin||(i=i.add(ye([r,()=>new s(2)],[!0,()=>new s(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new T(e,1)).xy}_getEvalParams(e,t){let{globalTime:i,animationTextureSize:r,animationTexture:o}=this.animationInfo;return{globalTime:i,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:r,animationTexture:o,pixelDimensions:t}}_getColor(e,t){return D(se(t.isSDF,new s(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return E(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=E(this.mosaicInfo.texture,e),r=new s(.5).subtract(Ft(i)).multiply(t.distanceToPx).multiply(ji),o=de(new s(.5).subtract(r),new s(0),new s(1)),l=t.color.multiply(o),u=t.outlineSize.multiply(.5),p=tt(r).subtract(u),f=de(new s(.5).subtract(p),new s(0),new s(1)),d=t.outlineColor.multiply(f);return new s(1).subtract(d.a).multiply(l).add(d)}};function Ht(a,e,t){let i=a.add(new y(e,0)),r=E(t.animationTexture,i.add(.5).divide(t.animationTextureSize)).xy;return a=a.add(r),fs(m({animationPointer:a},t),v,null,o=>{let{out:l}=o;if(!l)throw new Error("out is null");return ss(x(m({},o),{out:l}))})}n([c(re)],Le.prototype,"mosaicInfo",void 0),n([c($e)],Le.prototype,"animationInfo",void 0),n([_(ve)],Le.prototype,"visualVariableColor",void 0),n([_(be)],Le.prototype,"visualVariableOpacity",void 0),n([_(Ae)],Le.prototype,"visualVariableSizeMinMaxValue",void 0),n([_(Te)],Le.prototype,"visualVariableSizeScaleStops",void 0),n([_(ze)],Le.prototype,"visualVariableSizeStops",void 0),n([_(Re)],Le.prototype,"visualVariableSizeUnitValue",void 0),n([_(lt)],Le.prototype,"visualVariableRotation",void 0);var pt;(function(a){a[a.transform=0]="transform",a[a.fromColor=1]="fromColor",a[a.toColor=2]="toColor",a[a.colorMix=3]="colorMix",a[a.toOpacity=4]="toOpacity",a[a.opacityMix=5]="opacityMix"})(pt||(pt={}));function Ns(a,e){return Fe(a,xs(e))}function fi(a,e,t){let i=t.subtract(e),r=Ns(a.subtract(e),i),o=de(r.divide(it(i)),new s(0),new s(1));return qt(a,e.add(o.multiply(t.subtract(e))))}function pe(a){let e=tt(a);return W(e.x.add(e.y).add(e.z),new s(1.05))}function me(a,e,t,i){let r=new R(t.x.multiply(i.y).subtract(i.x.multiply(t.y)),i.x.multiply(e.y).subtract(e.x.multiply(i.y)),e.x.multiply(t.y).subtract(t.x.multiply(e.y)),t.y.subtract(i.y),i.y.subtract(e.y),e.y.subtract(t.y),i.x.subtract(t.x),e.x.subtract(i.x),t.x.subtract(e.x)),o=e.x.multiply(t.y.subtract(i.y)),l=t.x.multiply(i.y.subtract(e.y)),u=i.x.multiply(e.y.subtract(t.y)),p=o.add(l).add(u);return new s(1).divide(p).multiply(r.multiply(new T(1,a)))}function Ws(a,e,t,i){return se(pe(me(a,e,t,i)),new s(1))}function kt(a,e,t,i){let r=t.subtract(e),o=i.subtract(e),l=Vs(r,o),u=ar(oi(l,new s(Kr)),A(l,new s(-.05)));return ye([ar(vs(u),Ws(a.xy,e,t,i)),new s(-1)],[!0,()=>{let p=fi(a,e,t),f=fi(a,t,i),d=fi(a,i,e);return at(at(p,f),d)}])}function Ue(a){return a.distance.add(1)}function hi(a,e,t){let{viewMat3:i,tileMat3:r}=a.view,o=i.multiply(r),l=o.multiply(new T(e.pos,1)),u=o.multiply(new T(t.nextPos1,1)),p=o.multiply(new T(t.nextPos2,1));return kt(a.hittestRequest.position,l.xy,u.xy,p.xy)}function Ms(a,e,t){return qt(a,t).subtract(e)}var Gt=class extends di{};n([g(5,y)],Gt.prototype,"offset",void 0),n([g(6,y)],Gt.prototype,"uv",void 0),n([g(7,v)],Gt.prototype,"sizing",void 0),n([g(8,s)],Gt.prototype,"angle",void 0);var Nt=class extends St{};n([g(12,y)],Nt.prototype,"offsetNextVertex1",void 0),n([g(13,y)],Nt.prototype,"offsetNextVertex2",void 0),n([g(14,y)],Nt.prototype,"textureUVNextVertex1",void 0),n([g(15,y)],Nt.prototype,"textureUVNextVertex2",void 0);var lr=class extends oa{};function mt(a,e,t,i){return e.multiply(a.x).add(t.multiply(a.y)).add(i.multiply(a.z))}var yi=class extends Le{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}_vertexPreamble(e){let{id:t,pos:i,offset:r,animationPointerAndBaseSizeAndReferenceSize:o,uv:l,sizing:u,angle:p}=e,f=o.xy,d=o.z,h=o.w,b=u.xy,S=u.z,V=k(e.bitset,Be.bitset.isStroke),z=u.w,M=k(e.bitset,Be.bitset.scaleSymbolsProportionally),P=this._getEvalParams(e,b),O=Ht(f,pt.transform,P),Q=ye([se(k(e.bitset,Be.bitset.isMapAligned),new s(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new s(0)]),ne=new ms(Ze(Q),_e(Q.multiply(-1)),_e(Q),Ze(Q)).multiply(O.xy),G=O.z.subtract(Q).subtract(p.multiply(ri)),j=O.w,$=k(e.bitset,Be.bitset.isSDF),Z=ut(this,t,new s(h)).divide(new s(h));return{baseSize:d,animationPointer:f,strokeWidth:S,isOutline:V,unscaledDistanceToPx:z,scaleSymbolsProportionally:M,isSDF:$,position:this._getScreenPosition({id:t,pos:i,offset:r,referenceSize:h,translation:ne,rotation:G,scale:j,vvScale:Z}),uv:l,evalParams:P,vvScale:Z,scale:j}}vertex(e,t){let{position:i,animationPointer:r,evalParams:o,isOutline:l,unscaledDistanceToPx:u,vvScale:p,uv:f,strokeWidth:d,scaleSymbolsProportionally:h,scale:b,isSDF:S,baseSize:V}=this._vertexPreamble(e),z=this._toNdc(i),M=Ht(r,pt.fromColor,o);M=new v(M.rgb.multiply(M.a),M.a);let P=Ht(r,pt.toColor,o);P=new v(P.rgb.multiply(P.a),P.a);let O=Ht(r,pt.colorMix,o);O=new v(O.rgb.multiply(O.a),O.a);let Q=Ht(r,pt.toOpacity,o).a,ne=Ht(r,pt.opacityMix,o).a,G=rt(this,e.id,M,ni(wt(e.bitset,Be.bitset.colorLocked),new Et(l))),j=J(G,P,O),$=st(this,e.id),Z=J($,Q,ne),I=j.multiply(Z),wi=this.clip(e.id,e.zoomRange),Jt=u.multiply(p);return m({glPosition:new v(z,wi,1),uv:f.divide(this.mosaicInfo.size),color:I.multiply(new s(1).subtract(l)),outlineColor:I.multiply(l),distanceToPx:Jt,strokeWidth:d.multiply(J(new s(1),b,h)),isOutline:l,isSDF:S},this.maybeRunHittest(e,t,{pos:e.pos,size:V,sizeCorrection:new s(1),isMapAligned:new s(1),vvRotationMat3:new R(1,0,0,0,1,0,0,0,1),placementMat3:new R(1,0,0,0,1,0,0,0,1),outlineSize:new s(1),distanceToPx:Jt,isSDF:S}))}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return pi.spotlightAnimatedSymbols&&(t=t.add(new v(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return D(oi(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){let{position:r,distance:o,smallSymbolDistance:l}=this.hittestRequest,u=o.subtract(l),{viewMat3:p,tileMat3:f}=this.view,d=p.multiply(f).multiply(new T(i.pos,1)).xy,h=i.size.multiply(.5);return qt(d,r).subtract(h).add(u)}_hittestMarker(e,t,i){let r=this._vertexPreamble(m({},e)).position,o=this._vertexPreamble(x(m({},e),{offset:t.offsetNextVertex1,uv:t.textureUVNextVertex1})).position,l=this._vertexPreamble(x(m({},e),{offset:t.offsetNextVertex2,uv:t.textureUVNextVertex2})).position,u=this.hittestRequest.position,p=this.hittestRequest.distance,f=kt(u,r,o,l);return D(A(f,p),f,this._hittestSamples(r,o,l,e,t,i))}_hittestSamples(e,t,i,r,o,l){let{outlineSize:u,isSDF:p,distanceToPx:f}=l,d=this.hittestRequest.position,h=this.hittestRequest.distance,b=me(d.add(new y(le(h),le(h))),e,t,i),S=me(d.add(new y(0,le(h))),e,t,i),V=me(d.add(new y(h,le(h))),e,t,i),z=me(d.add(new y(le(h),0)),e,t,i),M=me(d,e,t,i),P=me(d.add(new y(h,0)),e,t,i),O=me(d.add(new y(le(h),h)),e,t,i),Q=me(d.add(new y(0,h)),e,t,i),ne=me(d.add(new y(h,h)),e,t,i),G=r.uv.divide(this.mosaicInfo.size),j=o.textureUVNextVertex1.divide(this.mosaicInfo.size),$=o.textureUVNextVertex2.divide(this.mosaicInfo.size),Z={color:new v(1,1,1,1),outlineSize:u,outlineColor:new v(1,1,1,1),isSDF:p,distanceToPx:f},I=new s(0);return I=I.add(pe(b).multiply(this._getColor(mt(b,G,j,$),Z).a)),I=I.add(pe(S).multiply(this._getColor(mt(S,G,j,$),Z).a)),I=I.add(pe(V).multiply(this._getColor(mt(V,G,j,$),Z).a)),I=I.add(pe(z).multiply(this._getColor(mt(z,G,j,$),Z).a)),I=I.add(pe(M).multiply(this._getColor(mt(M,G,j,$),Z).a)),I=I.add(pe(P).multiply(this._getColor(mt(P,G,j,$),Z).a)),I=I.add(pe(O).multiply(this._getColor(mt(O,G,j,$),Z).a)),I=I.add(pe(Q).multiply(this._getColor(mt(Q,G,j,$),Z).a)),I=I.add(pe(ne).multiply(this._getColor(mt(ne,G,j,$),Z).a)),W(I,new s(.05)).multiply(Ue(this.hittestRequest))}};n([w(0,F(Gt)),w(1,F(Nt))],yi.prototype,"vertex",null),n([w(0,F(lr))],yi.prototype,"fragment",null);var q=class extends ps{constructor(){super(...arguments),this.symbologyPlane=ce.FILL,this._input=null}};var na=class extends q{render(e,t){let{context:i,painter:r}=e,{target:o}=t,{freezeGlobalTime:l}=pi,u=0,p=r.textureManager.animationStore.getTexture(i,u),f=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],d=Array.from(Br(er(),f)),h=Array.from(qr(er(),d,o.transforms.displayViewScreenMat3)),b=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,b.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0),animationInfo:{globalTime:l===!1?e.time/1e3:l,animationTextureSize:[p.descriptor.width,p.descriptor.height],animationTexture:{unit:6,texture:p},toScreen:h,toNdc:f,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio}}),defines:m({},B(e)),optionalAttributes:{zoomRange:!0},useComputeBuffer:!0}),r.setPipelineState(m({},N(e))),r.submitDraw(e,t),l===!1&&o.requestRender()}};var la=class extends na{constructor(){super(...arguments),this.type=H.AnimatedMarker,this.symbologyPlane=ce.MARKER,this.shaders={geometry:new yi}}};var ua=class extends li{};n([g(0,y)],ua.prototype,"pos",void 0);var ur=class extends ae{},pa=class extends C{};n([c(s)],pa.prototype,"dotSize",void 0);var gi=class extends C{};n([c(X)],gi.prototype,"locations",void 0),n([c(s)],gi.prototype,"pixelRatio",void 0),n([c(s)],gi.prototype,"tileZoomFactor",void 0);var js=1e-6,ct=class extends ui{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(e){let t=new R(1,0,0,0,-1,0,0,1,1).multiply(new T(e.pos.xy.divide(512),1)),i=E(this.draw.locations,t.xy),r=ue(this.instance.dotSize.divide(2),new s(1)),o=new s(0);o=o.add(W(i.a,new s(js)).multiply(2));let l=r.add(this.instance.dotSize),u=this.view.displayViewScreenMat3.multiply(new T(e.pos.add(.5),1)),p=new v(u.xy,o,1),f=this.instance.dotSize.divide(l),d=new s(-1).divide(r.divide(l));return l=l.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:p,glPointSize:l,color:i,ratio:f,invEdgeRatio:d}}fragment(e){let t=it(e.glPointCoord.subtract(.5)).multiply(2),i=Ji(new s(0),new s(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new Vt;return r.fragColor=e.color.multiply(i),r}};n([c(pa)],ct.prototype,"instance",void 0),n([c(gi)],ct.prototype,"draw",void 0),n([c(fe)],ct.prototype,"view",void 0),n([w(0,F(ua))],ct.prototype,"vertex",null),n([w(0,F(ur))],ct.prototype,"fragment",null);var ma=class extends oe{};n([g(3,s)],ma.prototype,"inverseArea",void 0);var xi=class extends C{};n([c(ee.ofType(v,2))],xi.prototype,"isActive",void 0),n([c(ee.ofType(v,8))],xi.prototype,"colors",void 0),n([c(s)],xi.prototype,"dotValue",void 0);var zt=class extends C{};n([c(X)],zt.prototype,"dotTexture0",void 0),n([c(X)],zt.prototype,"dotTexture1",void 0),n([c(s)],zt.prototype,"tileZoomFactor",void 0),n([c(s)],zt.prototype,"pixelRatio",void 0),n([c(s)],zt.prototype,"tileDotsOverArea",void 0);var dt=class extends te{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){let t=new R(2/512,0,0,0,-2/512,0,-1,1,1).multiply(new T(e.pos,1)),i=this.clip(e.id),r=new v(t.xy,i,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),l=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),u=this.draw.tileZoomFactor.multiply(512).divide(this.draw.pixelRatio),p=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),f=this._dotThreshold(l,this.instance.dotValue,this.draw.tileDotsOverArea),d=e.pos.add(.5).divide(u);return{glPosition:r,color:new v(0,0,0,0),textureCoords:d,thresholds0:p,thresholds1:f}}fragment(e){let t=new Vt,i=E(this.draw.dotTexture0,e.textureCoords),r=E(this.draw.dotTexture1,e.textureCoords),o=e.thresholds0.subtract(i),l=e.thresholds1.subtract(r),u,p=si.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),f=si.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){let d=W(new s(0),o),h=W(new s(0),l),b=Fe(d,o).add(Fe(h,l)),S=W(b,new s(0)),V=new s(1).subtract(S),z=b.add(S),M=o.multiply(d).divide(z),P=l.multiply(h).divide(z),O=p.multiply(M).add(f.multiply(P));u=V.multiply(O)}else{let d=ue(or(o),or(l)),h=W(d,new s(0)),b=new s(1).subtract(h),S=W(d,o),V=W(d,l),z=p.multiply(S).add(f.multiply(V));u=b.multiply(z)}return t.fragColor=u,t}hittest(e){return Ue(this.hittestRequest)}};n([Ce],dt.prototype,"blending",void 0),n([c(xi)],dt.prototype,"instance",void 0),n([c(zt)],dt.prototype,"draw",void 0),n([w(0,F(ma))],dt.prototype,"vertex",null),n([w(0,F(ae))],dt.prototype,"fragment",null);var Zs={pos:{count:2,type:Ie.UNSIGNED_SHORT}},ca=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){let t=512,i=512,r=new ii(t,i);r.samplingMode=et.NEAREST,r.wrapMode=Fi.CLAMP_TO_EDGE;let o=new ls(e,new Ki(ki.DEPTH_STENCIL,t,i));this._dotFBO=new $i(e,r,o)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){let t=512,i=t*t,r=2,o=new Int16Array(i*r);for(let l=0;l<t;l++)for(let u=0;u<t;u++)o[r*(u+l*t)]=u,o[r*(u+l*t)+1]=l;this._dotMesh=aa.create(e,{primitive:Hi.POINTS,vertex:o,count:i,layout:Zs})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){let r=new Pr(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){let r=new Float32Array(t*t*4);for(let l=0;l<r.length;l++)r[l]=i.getFloat();let o=new ii;return o.dataType=gt.FLOAT,o.samplingMode=et.NEAREST,o.width=t,o.height=t,new Gi(e,o,r)}};var Xe=class extends oe{};n([g(3,v)],Xe.prototype,"color",void 0),n([g(4,y)],Xe.prototype,"zoomRange",void 0);var Ve=class extends te{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){let i=st(this,e.id),r=rt(this,e.id,e.color).multiply(i),o=this.view.displayViewScreenMat3.multiply(new T(e.pos.xy,1)),l=this.clip(e.id,e.zoomRange);return m({glPosition:new v(o.xy,l,1),color:r},this.maybeRunHittest(e,t,null))}fragment(e){return this.getFragmentOutput(e.color,e,new s(0))}hittest(e,t){return hi(this,e,t)}};n([_(ve)],Ve.prototype,"visualVariableColor",void 0),n([_(be)],Ve.prototype,"visualVariableOpacity",void 0),n([w(0,F(Xe)),w(1,F(ie))],Ve.prototype,"vertex",null),n([w(0,F(ae))],Ve.prototype,"fragment",null);var da=class extends q{constructor(){super(...arguments),this.type=H.DotDensity,this.shaders={polygon:new dt,point:new ct,fill:new Ve},this._resources=new Map}render(e,t){Xi(e)||L(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){let{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:x(m({},U(e,t.target)),{visualVariableColor:null,visualVariableOpacity:null}),defines:m({},B(e)),optionalAttributes:{zoomRange:!1},useComputeBuffer:L(e)}),i.setPipelineState(N(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){let{context:i,painter:r,requiredLevel:o}=e,l=t.instance.getInput().uniforms,u=this._getOrCreateResourcesRecord(i),p=u.getDotDensityTextures(i,512,l.seed),f=1/2**(o-t.target.key.level),d=512,h=d*window.devicePixelRatio*d*window.devicePixelRatio,b=1/f*(1/f),S=l.dotScale?e.state.scale/l.dotScale:1,V=l.dotValue*S*b;r.setShader({shader:this.shaders.polygon,uniforms:x(m({},U(e,t.target)),{instance:{isActive:l.isActive,colors:l.colors,dotValue:Math.max(1,V)},draw:{dotTexture0:{unit:ja,texture:p[0]},dotTexture1:{unit:Gr,texture:p[1]},tileZoomFactor:f,pixelRatio:window.devicePixelRatio,tileDotsOverArea:h/(512*window.devicePixelRatio*512*window.devicePixelRatio)}}),defines:x(m({},B(e)),{blending:l.blending}),optionalAttributes:{},useComputeBuffer:!1});let z=i.getViewport();i.setViewport(0,0,512,512);let M=i.getBoundFramebufferObject(),P=u.getFBO(i);i.bindFramebuffer(P),i.setClearColor(0,0,0,0),i.clear(Rt.COLOR),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),r.submitDraw(e,t),i.bindFramebuffer(M),i.setViewport(z.x,z.y,z.width,z.height);let O=u.getFBO(i).colorTexture,Q={shader:this.shaders.point,uniforms:{view:us(e,t.target),instance:{dotSize:l.dotSize},draw:{locations:{unit:ja,texture:O},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:m({},B(e)),optionalAttributes:{},useComputeBuffer:!1};r.setPipelineState(N(e)),r.submitDrawMesh(i,Q,u.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new ca,this._resources.set(e,t)),t}};var He=class extends C{getPatternOffsetAtTileOrigin(e,t=new s(0),i=new s(1)){let r=new y(is).divide(e),o=e.multiply(Ut(this.maxIntsToLocalOrigin.multiply(r))).add(this.tileOffsetFromLocalOrigin).subtract(new s(.5).multiply(e));return o=new y(o.x.multiply(i).subtract(o.y.multiply(t)),o.x.multiply(t).add(o.y.multiply(i))),Ke(o,e)}};n([c(y)],He.prototype,"tileOffsetFromLocalOrigin",void 0),n([c(y)],He.prototype,"maxIntsToLocalOrigin",void 0);var ft=class extends Xe{};n([g(5,v)],ft.prototype,"tlbr",void 0),n([g(6,s)],ft.prototype,"width",void 0),n([g(7,s)],ft.prototype,"height",void 0),n([g(8,y)],ft.prototype,"offset",void 0),n([g(9,y)],ft.prototype,"scale",void 0),n([g(10,s)],ft.prototype,"angle",void 0);var pr=class extends ae{};function Ks(a,e,t,i,r){let o=se(k(r,Qr),Y(1)),l=Ft(new v(a,0));return D(o,ir(i.divide(e.x),t.divide(e.y),0,le(t.divide(e.x)),i.divide(e.y),0,sr(Pi(l,0)),sr(Pi(0,l)),1),ir(i.divide(e.x),t.divide(e.y),0,le(t.divide(e.x)),i.divide(e.y),0,0,0,1))}function mr(a,e){let t=a.view.requiredZoomFactor,i=new y(e.width,e.height),r=i.multiply(e.scale).multiply(t),o=e.angle.multiply(ri),l=_e(o),u=Ze(o),p=Ks(e.id,r,l,u,e.bitset),f=a.localTileOffset.getPatternOffsetAtTileOrigin(i,l,u),d=t.multiply(e.scale).multiply(e.offset.subtract(f)).divide(r),h=new T(e.pos,1),b=p.multiply(h).xy.subtract(d),S=e.tlbr.divide(a.mosaicInfo.size.xyxy),V=k(e.bitset,Zi);return a.visualVariableColor!=null&&(V=D(xe(a.storage.getColorValue(e.id)),new s(0),V)),{tileTextureCoord:b,tlbr:S,sampleAlphaOnly:V}}function cr(a,e){let t=Ke(e.tileTextureCoord,new s(1)),i=J(e.tlbr.xy,e.tlbr.zw,t),r=E(a.mosaicInfo.texture,i);return r=D(A(e.sampleAlphaOnly,new s(.5)),r.aaaa,r),e.color.multiply(r)}var Mt=class extends Ve{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(e,t){return m(m({},super.vertex(e,t)),mr(this,e))}fragment(e){let t=cr(this,e);return this.getFragmentOutput(t,e,new s(0))}};n([c(re)],Mt.prototype,"mosaicInfo",void 0),n([c(He)],Mt.prototype,"localTileOffset",void 0),n([w(0,F(ft)),w(1,F(ie))],Mt.prototype,"vertex",null),n([w(0,F(pr))],Mt.prototype,"fragment",null);var fa=class extends q{constructor(){super(...arguments),this.type=H.ComplexFill,this.shaders={geometry:new Mt}}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)}),defines:m({},B(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};function ke(a){let e=1/a;return{antialiasing:e,blur:0+e}}var Ee=class extends oe{};n([g(3,v)],Ee.prototype,"color",void 0),n([g(4,y)],Ee.prototype,"offset",void 0),n([g(5,y)],Ee.prototype,"normal",void 0),n([g(6,s)],Ee.prototype,"halfWidth",void 0),n([g(7,s)],Ee.prototype,"referenceHalfWidth",void 0),n([g(8,y)],Ee.prototype,"zoomRange",void 0);var Wt=class extends ae{},jt=class extends C{};function Ps(a){return ue(new s(Wr).multiply(W(a,new s(jr))),new s(1))}function Ii(a,e){let{halfWidth:t,normal:i}=a,r=Ps(t),o=it(i).multiply(t);return de(r.multiply(t.subtract(o)).divide(e.add(r).subtract(new s(1))),new s(0),new s(1))}function $s(a,e){let{id:t,halfWidth:i,referenceHalfWidth:r}=e;if(nr(a)){let o=new s(2).multiply(r),l=ut(a,t,o);return new s(.5).multiply(i.divide(ue(r,new s(Zr)))).multiply(l)}return i}function Zt(a,e){let{id:t,offset:i,pos:r,normal:o,zoomRange:l}=e,{displayViewScreenMat3:u,displayViewMat3:p}=a.view,f=rt(a,t,e.color),d=st(a,t),h=$s(a,e),b=new s(.5).multiply(a.antialiasingControls.antialiasing),S=ue(h.add(b),new s(.45)).add(new s(.1).multiply(b)),V=Ps(S).multiply(S).multiply(i),z=p.multiply(new T(V,new s(0))),M=u.multiply(new T(r,new s(1))).add(z),P=new s(2).multiply(W(h,new s(0))).add(a.clip(t,l)),O=new v(M.xy,P,1);return{color:f,opacity:d,halfWidth:S,normal:o,scaledOffset:V,scaledHalfWidth:h,glPosition:new v(O.xy,P,1)}}function Kt(a,e){let{opacity:t,color:i}=a,r=Ii(a,e);return t.multiply(i).multiply(r)}n([c(s)],jt.prototype,"antialiasing",void 0),n([c(s)],jt.prototype,"blur",void 0);var ge=class extends te{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){let i=Zt(this,e);return m(m({},i),this.maybeRunHittest(e,t,i.halfWidth))}fragment(e){let t=Kt(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,i){let{viewMat3:r,tileMat3:o}=this.view,l=r.multiply(o),u=l.multiply(new T(e.pos,1)),p=l.multiply(new T(t.nextPos1,1)),f=l.multiply(new T(t.nextPos2,1)),{distance:d,smallSymbolDistance:h,smallSymbolSizeThreshold:b}=this.hittestRequest,S=W(i,b.multiply(.5)).multiply(d.subtract(h)),V=this.hittestRequest.position;return at(fi(V,u.xy,p.xy),fi(V,u.xy,f.xy)).subtract(i).add(S)}};n([c(jt)],ge.prototype,"antialiasingControls",void 0),n([_(ve)],ge.prototype,"visualVariableColor",void 0),n([_(be)],ge.prototype,"visualVariableOpacity",void 0),n([_(Ae)],ge.prototype,"visualVariableSizeMinMaxValue",void 0),n([_(Te)],ge.prototype,"visualVariableSizeScaleStops",void 0),n([_(ze)],ge.prototype,"visualVariableSizeStops",void 0),n([_(Re)],ge.prototype,"visualVariableSizeUnitValue",void 0),n([w(0,F(Ee)),w(1,F(ie))],ge.prototype,"vertex",null),n([w(0,F(Wt))],ge.prototype,"fragment",null);var Qe=class extends oe{};n([g(3,y)],Qe.prototype,"offset",void 0),n([g(4,v)],Qe.prototype,"color",void 0),n([g(5,y)],Qe.prototype,"normal",void 0),n([g(6,s)],Qe.prototype,"halfWidth",void 0),n([g(7,s)],Qe.prototype,"referenceHalfWidth",void 0),n([g(8,y)],Qe.prototype,"zoomRange",void 0);var _i=class extends Wt{};function Ci(a,e,t){let{id:i,bitset:r}=e,o=k(r,Xr),l=A(o,new s(.5)),u=Zt(a,e),p=D(l,u.halfWidth,new s(0)),f=st(a,i),d=rt(a,i,e.color),h=D(l,e.color,d.multiply(f)),b=a.view.displayViewScreenMat3.multiply(new T(e.pos.xy,1)),S=a.clip(e.id),V=new v(b.xy,S,1),z=D(l,u.glPosition,V),M=t&&a.maybeRunHittest(e,t,l);return m({isOutline:o,color:h,opacity:new s(1),halfWidth:p,normal:u.normal,glPosition:z},M)}var Ge=class extends te{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};n([c(jt)],Ge.prototype,"antialiasingControls",void 0),n([_(ve)],Ge.prototype,"visualVariableColor",void 0),n([_(be)],Ge.prototype,"visualVariableOpacity",void 0),n([_(Ae)],Ge.prototype,"visualVariableSizeMinMaxValue",void 0),n([_(Te)],Ge.prototype,"visualVariableSizeScaleStops",void 0),n([_(ze)],Ge.prototype,"visualVariableSizeStops",void 0),n([_(Re)],Ge.prototype,"visualVariableSizeUnitValue",void 0);var Pt=class extends Ge{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(e,t){return Ci(this,e,t)}fragment(e){let{color:t,isOutline:i}=e,r=A(i,new s(.5)),o=Kt(e,this.antialiasingControls.blur),l=D(r,o,t),u=D(r,new s(1/255),new s(0));return this.getFragmentOutput(l,e,u)}hittest(e,t,i){return D(i,Ue(this.hittestRequest),hi(this,e,t))}};n([w(0,F(Qe)),w(1,F(ie))],Pt.prototype,"vertex",null),n([w(0,F(_i))],Pt.prototype,"fragment",null);var Oi=class extends Xe{};n([g(5,v)],Oi.prototype,"tlbr",void 0),n([g(6,s)],Oi.prototype,"inverseRasterizationScale",void 0);var dr=class extends ae{};function Xs(a){let e=new s(1),t=new s(0);return new R(e.divide(a.x),t.divide(a.y),0,le(t.divide(a.x)),e.divide(a.y),0,0,0,1)}function fr(a,e){let t=e.tlbr.xy,i=e.tlbr.zw,r=i.x.subtract(t.x),o=t.y.subtract(i.y),l=new y(r,o).multiply(e.inverseRasterizationScale),u=l.multiply(a.view.requiredZoomFactor),p=Xs(u),f=a.localTileOffset.getPatternOffsetAtTileOrigin(l).divide(u),d=new T(e.pos,1);return{tileTextureCoord:p.multiply(d).xy.subtract(f),tlbr:e.tlbr.divide(a.mosaicInfo.size.xyxy)}}function hr(a,e){let t=Ke(a.tileTextureCoord,new s(1)),i=J(a.tlbr.xy,a.tlbr.zw,t),r=E(e.texture,i);return a.color.multiply(r)}var Dt=class extends Ve{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(e,t){return m(m({},super.vertex(e,t)),fr(this,e))}fragment(e){let t=hr(e,this.mosaicInfo);return this.getFragmentOutput(t,e,new s(0))}};n([c(re)],Dt.prototype,"mosaicInfo",void 0),n([c(He)],Dt.prototype,"localTileOffset",void 0),n([w(0,F(Oi)),w(1,F(ie))],Dt.prototype,"vertex",null),n([w(0,F(dr))],Dt.prototype,"fragment",null);var Ai=class extends Qe{};n([g(9,v)],Ai.prototype,"tlbr",void 0),n([g(10,s)],Ai.prototype,"inverseRasterizationScale",void 0);var Ri=class extends _i{},It=class extends Pt{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(e,t){return m(m({},Ci(this,e,t)),fr(this,e))}fragment(e){let{isOutline:t}=e,i=A(t,new s(.5)),r=Kt(e,this.antialiasingControls.blur),o=hr(e,this.mosaicInfo),l=D(i,r,o),u=D(i,new s(1/255),new s(0));return this.getFragmentOutput(l,e,u)}};n([c(re)],It.prototype,"mosaicInfo",void 0),n([c(He)],It.prototype,"localTileOffset",void 0),n([w(0,F(Ai)),w(1,F(ie))],It.prototype,"vertex",null),n([w(0,F(Ri))],It.prototype,"fragment",null);var Ds=1/as,Ye=class extends oe{};n([g(3,v)],Ye.prototype,"color",void 0),n([g(4,v)],Ye.prototype,"tlbr",void 0),n([g(5,s)],Ye.prototype,"angle",void 0),n([g(6,s)],Ye.prototype,"aux1",void 0),n([g(7,s)],Ye.prototype,"aux2",void 0),n([g(8,y)],Ye.prototype,"aux3",void 0),n([g(9,y)],Ye.prototype,"aux4",void 0),n([g(10,y)],Ye.prototype,"zoomRange",void 0);var yr=class extends Ri{},_t=class extends Ge{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(e,t){let{aux1:i,aux2:r,aux3:o,aux4:l}=e,u=x(m({},e),{width:i,height:r,offset:o,scale:l.multiply(Ds)}),p=x(m({},e),{halfWidth:i,referenceHalfWidth:r,offset:o,normal:l.subtract(rs).multiply(Ds)}),f=Ci(this,p),d=mr(this,u),h=A(f.isOutline,new s(.5));return m(m(m({},f),d),this.maybeRunHittest(e,t,h))}fragment(e){let{isOutline:t}=e,i=A(t,new s(.5)),r=Kt(e,this.antialiasingControls.blur),o=cr(this,e),l=D(i,r,o),u=D(i,new s(1/255),new s(0));return this.getFragmentOutput(l,e,u)}hittest(e,t,i){return D(i,Ue(this.hittestRequest),hi(this,e,t))}};n([c(re)],_t.prototype,"mosaicInfo",void 0),n([c(He)],_t.prototype,"localTileOffset",void 0),n([w(0,F(Ye)),w(1,F(ie))],_t.prototype,"vertex",null),n([w(0,F(yr))],_t.prototype,"fragment",null);var ha=class extends q{constructor(){super(...arguments),this.type=H.ComplexOutlineFill,this.shaders={geometry:new _t}}render(e,t){let{context:i,painter:r,pixelRatio:o}=e,l=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),U(e,t.target)),{antialiasingControls:ke(o),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)}),defines:m({},B(e)),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};var ya=class extends q{constructor(){super(...arguments),this.type=H.Fill,this.shaders={geometry:new Ve}}render(e,t){let{painter:i}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:m(m({},K(e,t.target,r.uniforms)),U(e,t.target)),defines:B(e),optionalAttributes:r.optionalAttributes,useComputeBuffer:L(e)}),i.setPipelineState(N(e)),i.submitDraw(e,t)}};var $t=class extends Xe{};n([g(5,v)],$t.prototype,"tlbr",void 0),n([g(6,y)],$t.prototype,"relativePosition",void 0),n([g(7,s)],$t.prototype,"gradientMethod",void 0),n([g(8,y)],$t.prototype,"relativeGradientSize",void 0);var gr=class extends ae{},Xt=class extends Ve{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(e,t){let{tlbr:i,relativePosition:r,gradientMethod:o,relativeGradientSize:l}=e,u=D(wt(e.bitset,Ya.isAbsolute),this.view.displayZoomFactor,new s(1));return x(m({},super.vertex(e,t)),{tlbr:i,relativePosition:r,gradientMethod:o,gradientSize:l.multiply(u),isDiscrete:k(e.bitset,Ya.isDiscrete)})}fragment(e){let{tlbr:t,relativePosition:i,gradientMethod:r,gradientSize:o,isDiscrete:l}=e,u=D(A(l,new s(.5)),o.subtract(1),new y(0)),p=ye([se(r,new s(Qa.rectangular)),()=>{let S=tt(i).add(u).divide(o);return mi(ue(S.x,S.y))}],[se(r,new s(Qa.circular)),mi(ea(Fe(i,i)).add(u.x).divide(o.x))],[!0,mi(i.x.add(u.x).divide(o.x))]),f=new y(de(p,new s(0),new s(1)),.5),d=J(t.xy,t.zw,f).divide(this.mosaicInfo.size),h=E(this.mosaicInfo.texture,d),b=e.color.a;return this.getFragmentOutput(h.multiply(b),e,new s(0))}};n([c(re)],Xt.prototype,"mosaicInfo",void 0),n([w(0,F($t)),w(1,F(ie))],Xt.prototype,"vertex",null),n([w(0,F(gr))],Xt.prototype,"fragment",null);var ga=class extends q{constructor(){super(...arguments),this.type=H.GradientFill,this.shaders={geometry:new Xt},this.symbologyPlane=ce.FILL}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:m({},B(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};var xa=class extends q{constructor(){super(...arguments),this.type=H.OutlineFill,this.shaders={geometry:new Pt}}render(e,t){let{painter:i,pixelRatio:r}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),U(e,t.target)),{antialiasingControls:ke(r)}),defines:m({},B(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),i.setPipelineState(N(e)),i.submitDraw(e,t)}};var va=class extends q{constructor(){super(...arguments),this.type=H.PatternFill,this.shaders={geometry:new Dt}}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)}),defines:m({},B(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};var ba=class extends q{constructor(){super(...arguments),this.type=H.PatternOutlineFill,this.shaders={geometry:new It}}render(e,t){let{context:i,painter:r,pixelRatio:o}=e,l=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),U(e,t.target)),{antialiasingControls:ke(o),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)}),defines:m({},B(e)),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};var Li=class{constructor(e,t,i,r){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=r}};function Is(a,e){let{textureFloatLinear:t,colorBufferFloat:i}=a.capabilities,r=i?.textureFloat,o=i?.textureHalfFloat,l=i?.floatBlend,u=a.driverTest.floatBufferBlend.result;if(!r&&!o)throw new ti("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||o))throw new ti("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));let p=r&&l&&u,f=o,d=t,h=!!i?.R32F,b=!!i?.R16F;if(p&&d)return d||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new Li(gt.FLOAT,d?et.LINEAR:et.NEAREST,h?nt.RED:nt.RGBA,h?Na.R32F:nt.RGBA);if(f)return new Li(gt.HALF_FLOAT,et.LINEAR,b?nt.RED:nt.RGBA,b?Na.R16F:nt.RGBA);throw new ti("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}var md=new Li(gt.HALF_FLOAT,et.NEAREST,nt.RGBA,nt.RGBA);var Qs=()=>Ui.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"),Sa=class{destroy(){this._accumulateFramebuffer=ka(this._accumulateFramebuffer),this._resolveGradientTexture=ka(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){let t=Is(e,Qs());this._qualityProfile=x(m({},t),{defines:{usesHalfFloatPrecision:t.dataType!==gt.FLOAT}})}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){let{dataType:r,samplingMode:o,pixelFormat:l,internalFormat:u}=this.loadQualityProfile(e),p=new ii(t,i);p.pixelFormat=l,p.internalFormat=u,p.dataType=r,p.samplingMode=o,p.wrapMode=Fi.CLAMP_TO_EDGE;let f=new Ki(ki.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new $i(e,p,f)}else{let{width:r,height:o}=this._accumulateFramebuffer;r===t&&o===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){let r=new ii;r.wrapMode=Fi.CLAMP_TO_EDGE,this._resolveGradientTexture=new Gi(e,r),this._prevGradientHash=null}return this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t),this._resolveGradientTexture}};function Va(a){return a?.25:1}var wa=class extends oe{};n([g(5,y)],wa.prototype,"offset",void 0);var xr=class extends ae{},Ei=class extends C{};n([c(s)],Ei.prototype,"radius",void 0),n([c(s)],Ei.prototype,"isFieldActive",void 0);var Ct=class extends te{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(e){let{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,o=i.multiply(this.storage.getVVData(e.id).x).add(new s(1).subtract(i)),l=this.view.displayViewScreenMat3.multiply(new T(e.pos,1)).add(this.view.displayViewMat3.multiply(new T(r,0)).multiply(t)),u=this.clip(e.id);return m({glPosition:new v(l.xy,u,1),offset:r,fieldValue:o,color:new v(0)},this.maybeRunHittest(e,{},null))}fragment(e){let{offset:t,fieldValue:i}=e,r=it(t),o=W(r,new s(1)),l=new s(1).subtract(r.multiply(r)),u=l.multiply(l),p=o.multiply(u).multiply(i).multiply(new s(Va(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new v(p),e)}hittest(e){let{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new T(e.pos,1));return Ms(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};n([Ce],Ct.prototype,"usesHalfFloatPrecision",void 0),n([c(Ei)],Ct.prototype,"kernelControls",void 0),n([w(0,F(wa))],Ct.prototype,"vertex",null),n([w(0,F(xr))],Ct.prototype,"fragment",null);var Fa=class extends li{};n([g(0,y)],Fa.prototype,"position",void 0);var vr=class extends ta{},vi=class extends C{};n([c(X)],vi.prototype,"texture",void 0),n([c(y)],vi.prototype,"minAndInvRange",void 0),n([c(s)],vi.prototype,"normalization",void 0);var Ta=class extends C{};n([c(X)],Ta.prototype,"texture",void 0);var ht=class extends ui{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new v(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){let{accumulatedDensity:t,gradient:i}=this,r=E(t.texture,e.uv).r.divide(new s(Va(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);let o=E(i.texture,new y(r,.5)),l=new Vt;return l.fragColor=new v(o.rgb.multiply(o.a),o.a),l}};n([Ce],ht.prototype,"usesHalfFloatPrecision",void 0),n([c(vi)],ht.prototype,"accumulatedDensity",void 0),n([c(Ta)],ht.prototype,"gradient",void 0),n([w(0,F(Fa))],ht.prototype,"vertex",null),n([w(0,F(vr))],ht.prototype,"fragment",null);var za=class extends q{constructor(){super(...arguments),this.type=H.Heatmap,this.drawPhase=xt.MAP|xt.HITTEST|xt.DEBUG,this.shaders={accumulate:new Ct,resolve:new ht},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){let{context:i,painter:r,state:o}=e,l=t.instance.getInput(),{isFieldActive:u}=l.uniforms,p=this._getOrCreateResourcesRecord(i),f=p.loadQualityProfile(i);L(e)||this._bind(e,p,l),r.setShader({shader:this.shaders.accumulate,uniforms:x(m({},U(e,t.target)),{kernelControls:{radius:_s(l,o),isFieldActive:u?1:0}}),defines:m(m({},B(e)),f.defines),optionalAttributes:{},useComputeBuffer:L(e)});let d=L(e)?Js:Os;r.setPipelineState(d),r.submitDraw(e,t)}getStencilReference(e){return Cs(e)}renderResolvePass(e,t){if(L(e))return;let{context:i,painter:r}=e,o=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!o?.initialized)return;let{defines:l}=o.loadQualityProfile(i),{minDensity:u,maxDensity:p,radius:f}=t.getInput().uniforms,d=8,h=9,b=o.accumulateFramebuffer,S=o.resolveGradientTexture,V={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:d,texture:b.colorTexture},minAndInvRange:[u,1/(p-u)],normalization:3/(f*f*Math.PI)},gradient:{texture:{unit:h,texture:S}}},defines:l,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(b.colorTexture,d),i.bindTexture(S,h),r.setPipelineState(eo),r.submitDrawMesh(i,V,r.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Sa,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;let{context:r,state:o,pixelRatio:l}=e,u=r.getBoundFramebufferObject(),p=r.getViewport();this._prevFBO=u,this._prevViewport=p;let{gradient:f,gradientHash:d}=i.uniforms;t.ensureResolveGradientTexture(r,d,f);let{width:h,height:b}=p,S=Ys(_s(i,o),l),V=h*S,z=b*S,M=t.ensureAccumulateFBO(r,V,z);r.blitFramebuffer(u,M,0,0,u.width,u.height,0,0,M.width,M.height,Rt.STENCIL,et.NEAREST),r.bindFramebuffer(M),r.setViewport(0,0,M.width,M.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(Rt.COLOR),this._isBound=!0}};function Ys(a,e){let t=e>1.5?.25:.5;return a<1/(2*t)?1:t}function Cs(a){return a.key.level+1}var Os={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Cs,compare:Lt.GEQUAL,mask:255,op:{fail:je.KEEP,zFail:je.KEEP,zPass:je.REPLACE}}}},Js=x(m({},Os),{stencil:!1}),eo={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function _s(a,e){let{referenceScale:t,radius:i}=a.uniforms;return i*(t!==0?t/e.scale:1)}var to=360/254,we;(function(a){a[a.Color=0]="Color",a[a.Outline=1]="Outline",a[a.Halo=2]="Halo"})(we||(we={}));var Me=class extends oe{};n([g(3,v)],Me.prototype,"color",void 0),n([g(4,y)],Me.prototype,"offset",void 0),n([g(5,y)],Me.prototype,"textureUV",void 0),n([g(6,s)],Me.prototype,"fontSize",void 0),n([g(7,s)],Me.prototype,"referenceSize",void 0),n([g(8,v)],Me.prototype,"outlineColor",void 0),n([g(9,v)],Me.prototype,"haloColor",void 0),n([g(10,y)],Me.prototype,"outlineAndHaloSize",void 0),n([g(11,y)],Me.prototype,"zoomRange",void 0),n([g(12,s)],Me.prototype,"clipAngle",void 0),n([g(13,v)],Me.prototype,"referenceSymbol",void 0);var Bi=class extends St{};n([g(14,y)],Bi.prototype,"offsetNextVertex1",void 0),n([g(15,y)],Bi.prototype,"offsetNextVertex2",void 0);var br=class extends ae{},he=class extends te{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=we.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){let r=t.multiply(to),o=tt(this.view.rotation.subtract(r)),l=at(new s(360).subtract(o),o),u=new s(0),p=Yi(this.view.currentZoom.multiply(Za)).divide(Za),f=e.x,d=e.y,h=new s(1).subtract(W(f,p)).multiply(2),b=W(new s(90),l).multiply(2),S=new s(2).multiply(new s(1).subtract(W(p,d)));return u=u.add(i.multiply(h)),u=u.add(i.multiply(b)),u=u.add(S),u}vertex(e,t){let i=k(e.bitset,es),r=new s(1).subtract(i),o=e.fontSize,l=o.divide($a),u=this.textRenderPassType===we.Outline?e.outlineColor:this.textRenderPassType===we.Halo?e.haloColor:this._getVertexColor(e),p=this.isLabel?this.storage.getLabelVisibility(e.id):new s(1),f=this.isLabel?u.multiply(p):u,d=this.view.displayViewScreenMat3.multiply(new T(e.pos,1)),h=e.offset,b=new s(1),S=R.identity(),V=new y(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");let ne=e.referenceSymbol,G=ne.xy,j=ne.z,$=this._unpackDirection(ne.w),Z=ut(this,e.id,j).divide(2),I=$.multiply(Z.add(kr));V=G.add(I),h=h.add(V)}else b=ut(this,e.id,e.referenceSize).divide(e.referenceSize),o=o.multiply(b),l=l.multiply(b),h=h.multiply(b),S=sa(this,e.id),h=S.multiply(new T(h,0)).xy;let z=k(e.bitset,ts),M=this._getViewRotationMatrix(z).multiply(new T(h,0)),P=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,z):this.clip(e.id,e.zoomRange);P=this.isBackgroundPass?P.add(r.multiply(2)):P.add(i.multiply(2));let O=new s(0);if(this.textRenderPassType===we.Outline&&(P=P.add(D(se(e.outlineAndHaloSize.x,new s(0)),new s(2),new s(0))),O=new s(e.outlineAndHaloSize.x).divide(l).divide(Xa)),this.textRenderPassType===we.Halo){let ne=e.outlineAndHaloSize.x,G=new s(e.outlineAndHaloSize.y);P=P.add(D(se(G,new s(0)),new s(2),new s(0))),O=G.add(ne).divide(l).divide(Xa)}let Q=this.isLabel?ni(A(P,new s(1)),qe(p,new s(0))):new Et(!1);return m({glPosition:new v(d.xy.add(M.xy),P,1),color:f,size:l,textureUV:e.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new s(.105*$a).divide(o).divide(this.view.pixelRatio),outlineDistanceOffset:O},this.maybeRunHittest(e,t,{vvSizeAdjustment:b,vvRotation:S,labelOffset:V,labelClipped:Q}))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new s(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){let t=new s(.25),i=new s(1).subtract(t),r=E(this.mosaicInfo.texture,e.textureUV).a,o=i.subtract(e.outlineDistanceOffset);this.highlight&&(o=o.divide(2));let l=e.antialiasingWidth,u=Ji(o.subtract(l),o.add(l),r);return this.getFragmentOutput(e.color.multiply(u),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r,labelOffset:o,labelClipped:l}){let u,p,f;this.isLabel?(u=new T(e.offset.add(o),0),p=new T(t.offsetNextVertex1.add(o),0),f=new T(t.offsetNextVertex2.add(o),0)):(u=r.multiply(new T(e.offset.multiply(i),0)),p=r.multiply(new T(t.offsetNextVertex1.multiply(i),0)),f=r.multiply(new T(t.offsetNextVertex2.multiply(i),0)));let{viewMat3:d,tileMat3:h}=this.view,b=d.multiply(h).multiply(new T(e.pos,1)),S=b.add(h.multiply(u)).xy,V=b.add(h.multiply(p)).xy,z=b.add(h.multiply(f)).xy,M=kt(this.hittestRequest.position,S.xy,V.xy,z.xy);return this.isLabel?D(l,Ue(this.hittestRequest),M):M}_unpackDirection(e){let t=new Qi(e),i=hs(t,new Qi(2)),r=ys(t,new Qi(3));return new y(new s(i).subtract(1),new s(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){let i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new Et(!1))}if(this.visualVariableOpacity){let i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}};n([_(ve)],he.prototype,"visualVariableColor",void 0),n([_(be)],he.prototype,"visualVariableOpacity",void 0),n([_(lt)],he.prototype,"visualVariableRotation",void 0),n([_(Ae)],he.prototype,"visualVariableSizeMinMaxValue",void 0),n([_(Te)],he.prototype,"visualVariableSizeScaleStops",void 0),n([_(ze)],he.prototype,"visualVariableSizeStops",void 0),n([_(Re)],he.prototype,"visualVariableSizeUnitValue",void 0),n([c(re)],he.prototype,"mosaicInfo",void 0),n([Ce],he.prototype,"textRenderPassType",void 0),n([Ce],he.prototype,"isBackgroundPass",void 0),n([Ce],he.prototype,"isLabel",void 0),n([w(0,F(Me)),w(1,F(Bi))],he.prototype,"vertex",null),n([w(0,F(br))],he.prototype,"fragment",null);var Ma=class extends q{constructor(){super(...arguments),this.type=H.Label,this.shaders={geometry:new he},this.drawPhase=xt.LABEL|xt.LABEL_ALPHA|xt.HITTEST,this.symbologyPlane=ce.TEXT}render(e,t){let{context:i,painter:r}=e,o=B(e),l=m({},N(e)),u=t.instance.getInput(),p={shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,u.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:x(m({},o),{textRenderPassType:we.Color,isBackgroundPass:!0,isLabel:!0}),optionalAttributes:u.optionalAttributes,useComputeBuffer:L(e)};r.setPipelineState(l),r.setShader(p),r.submitDraw(e,t),r.setShader(x(m({},p),{defines:x(m({},o),{textRenderPassType:we.Halo,isBackgroundPass:!1,isLabel:!0})})),r.submitDraw(e,t),r.setShader(x(m({},p),{defines:x(m({},o),{textRenderPassType:we.Color,isBackgroundPass:!1,isLabel:!0})})),r.submitDraw(e,t)}};var Ot=class extends Ee{};n([g(9,s)],Ot.prototype,"accumulatedDistance",void 0),n([g(10,s)],Ot.prototype,"totalLength",void 0),n([g(11,s)],Ot.prototype,"gradientSize",void 0),n([g(12,y)],Ot.prototype,"segmentDirection",void 0),n([g(13,v)],Ot.prototype,"tlbr",void 0);var Pa=class extends C{};n([c(s)],Pa.prototype,"isColorPass",void 0);var Qt=class extends ge{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(e,t){let{totalLength:i,gradientSize:r,segmentDirection:o,tlbr:l}=e,u=Zt(this,e),p=k(e.bitset,zi.isAlongLine),f=i.divide(this.view.displayZoomFactor),d=D(wt(e.bitset,zi.isAbsoluteSize),()=>{let S=D(A(p,new s(.5)),f,u.halfWidth);return r.divide(S)},r),h=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Fe(o,u.scaledOffset)).divide(f),b=l.divide(this.mosaicInfo.size.xyxy);return m(x(m({},u),{tlbr:b,relativePositionAlongLine:h,relativeGradientSize:d,isAlongLine:k(e.bitset,zi.isAlongLine),isDiscrete:k(e.bitset,zi.isDiscrete)}),this.maybeRunHittest(e,t,u.halfWidth))}fragment(e){let{isAlongLine:t,isDiscrete:i,relativePositionAlongLine:r,relativeGradientSize:o,normal:l,tlbr:u}=e,p=Ii(e,this.antialiasingControls.blur),f=new s(.5).multiply(l.y).add(new s(.5)),d=D(A(t,new s(.5)),r,f),h=D(A(i,new s(.5)),o.subtract(1),new s(0)),b=mi(d.add(h).divide(o)),S=J(u.xy,u.zw,new y(de(b,new s(0),new s(1)),.5)),V=E(this.mosaicInfo.texture,S),z=e.opacity.multiply(p),M=this.getFragmentOutput(V.multiply(z),e),P=W(new s(.5),this.technique.isColorPass).multiply(We("gradient-depth-epsilon")),O=W(new s(0),l.y).multiply(new s(We("gradient-depth-bias")).subtract(P));return M.glFragDepth=de(it(l).add(O),new s(0),new s(1)),M}};n([c(re)],Qt.prototype,"mosaicInfo",void 0),n([c(Pa)],Qt.prototype,"technique",void 0),n([w(0,F(Ot)),w(1,F(ie))],Qt.prototype,"vertex",null);var Da=class extends q{constructor(){super(...arguments),this.type=H.GradientStroke,this.shaders={geometry:new Qt},this.symbologyPlane=ce.LINE}_getShaderOptions(e,t,i){let{context:r,painter:o,pixelRatio:l}=e,u=t.instance.getInput();return{shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,u.uniforms)),U(e,t.target)),{antialiasingControls:ke(l),mosaicInfo:o.textureManager.getMosaicInfo(r,t.textureKey),technique:{isColorPass:i}}),defines:m({},B(e)),optionalAttributes:u.optionalAttributes,useComputeBuffer:L(e)}}render(e,t){let{painter:i}=e;if(L(e)||Xi(e)){let l=N(e);return i.setPipelineState(l),i.setShader(this._getShaderOptions(e,t,1)),void i.submitDraw(e,t)}e.context.setClearDepth(1),e.context.clear(Rt.DEPTH);let r={color:!1,depth:{write:{zNear:0,zFar:1},test:Lt.LESS},stencil:{write:!1,test:{ref:l=>l.stencilRef,compare:Lt.EQUAL,mask:255,op:{fail:je.KEEP,zFail:je.KEEP,zPass:je.KEEP}}}};i.setShader(this._getShaderOptions(e,t,0)),i.setPipelineState(r),i.submitDraw(e,t);let o={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:Lt.LEQUAL},stencil:{write:!1,test:{ref:l=>l.stencilRef,compare:Lt.EQUAL,mask:255,op:{fail:je.KEEP,zFail:je.KEEP,zPass:je.KEEP}}}};i.setShader(this._getShaderOptions(e,t,1)),i.setPipelineState(o),i.submitDraw(e,t)}};var Ia=class extends q{constructor(){super(...arguments),this.type=H.Line,this.shaders={geometry:new ge},this.symbologyPlane=ce.LINE}render(e,t){let{painter:i,pixelRatio:r}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),U(e,t.target)),{antialiasingControls:ke(r)}),defines:m({},B(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),i.setPipelineState(N(e)),i.submitDraw(e,t)}};var At=class extends Ee{};n([g(9,s)],At.prototype,"accumulatedDistance",void 0),n([g(10,y)],At.prototype,"segmentDirection",void 0),n([g(11,s)],At.prototype,"offsetAlongLine",void 0),n([g(12,s)],At.prototype,"capType",void 0),n([g(13,v)],At.prototype,"tlbr",void 0);var bi=class extends ge{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(e,t){let i=k(e.bitset,Yr);return i.multiply(ue(t,new s(.25)).multiply(new s(2))).add(new s(1).subtract(i).multiply(ot(1)))}_getSDFAlpha(e){let{halfWidth:t,normal:i,tlbr:r,patternSize:o,accumulatedDistance:l,offsetAlongLine:u,dashToPx:p,capType:f}=e,d=o.x.divide(4).multiply(p),h=Ut(l.add(u).divide(d)),b=J(r.xy,r.zw,new y(h,.5)),S=Ft(E(this.mosaicInfo.texture,b)).multiply(2).subtract(1).multiply(64).multiply(p),V=i.y.multiply(t),z=ye([se(f,new s(1)),S.subtract(t)],[se(f,new s(2)),ea(bs(ue(S,new s(0)),new s(2)).add(V.multiply(V))).subtract(t)],[!0,S]),M=de(new s(.25).subtract(z),new s(0),new s(1));return new v(M)}_getPatternColor(e){let{halfWidth:t,normal:i,color:r,accumulatedDistance:o,patternSize:l,sampleAlphaOnly:u,tlbr:p}=e,f=l.y.multiply(new s(2).multiply(t).divide(l.x)),d=Ut(o.divide(f)),h=new s(.5).multiply(i.y).add(new s(.5)),b=J(p.xy,p.zw,new y(h,d)),S=E(this.mosaicInfo.texture,b);return this.visualVariableColor!=null&&(S=D(A(u,new s(.5)),new v(r.a),r)),S}vertex(e,t){let{segmentDirection:i,tlbr:r,bitset:o}=e,l=Zt(this,e),u=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Fe(i,l.scaledOffset)),p=new y(r.z.subtract(r.x),r.w.subtract(r.y)),f=r.divide(this.mosaicInfo.size.xyxy),d=k(o,Jr),h=k(o,Zi),b=D(A(d,new s(.5)),this._getDistanceRatio(e,l.scaledHalfWidth),new s(1));return m(x(m({},l),{tlbr:f,patternSize:p,accumulatedDistance:u,isSDF:d,sampleAlphaOnly:h,dashToPx:b,offsetAlongLine:e.offsetAlongLine,capType:e.capType}),this.maybeRunHittest(e,t,l.halfWidth))}fragment(e){let{color:t,opacity:i,isSDF:r}=e,o=Ii(e,this.antialiasingControls.blur),l=D(A(r,new s(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),u=t.multiply(i).multiply(o).multiply(l);return this.getFragmentOutput(u,e)}};n([c(re)],bi.prototype,"mosaicInfo",void 0),n([w(0,F(At)),w(1,F(ie))],bi.prototype,"vertex",null);var _a=class extends q{constructor(){super(...arguments),this.type=H.TexturedLine,this.shaders={geometry:new bi},this.symbologyPlane=ce.LINE}render(e,t){let{context:i,painter:r,pixelRatio:o}=e,l=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),U(e,t.target)),{antialiasingControls:ke(o),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:m({},B(e)),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};var Je=class extends oe{};n([g(3,v)],Je.prototype,"color",void 0),n([g(4,v)],Je.prototype,"outlineColor",void 0),n([g(5,y)],Je.prototype,"offset",void 0),n([g(6,y)],Je.prototype,"textureUV",void 0),n([g(7,v)],Je.prototype,"sizing",void 0),n([g(8,s)],Je.prototype,"placementAngle",void 0),n([g(9,s)],Je.prototype,"sdfDecodeCoeff",void 0),n([g(10,y)],Je.prototype,"zoomRange",void 0);var Yt=class extends St{};n([g(12,y)],Yt.prototype,"offsetNextVertex1",void 0),n([g(13,y)],Yt.prototype,"offsetNextVertex2",void 0),n([g(14,y)],Yt.prototype,"textureUVNextVertex1",void 0),n([g(15,y)],Yt.prototype,"textureUVNextVertex2",void 0);var Vr=class extends ae{};function yt(a,e,t,i){return e.multiply(a.x).add(t.multiply(a.y)).add(i.multiply(a.z))}function Sr(a){return a.multiply(a).divide(128)}var Pe=class extends te{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){let i=Sr(e.sizing.x),r=Sr(e.sizing.y),o=Sr(e.sizing.z),l=e.placementAngle,u=k(e.bitset,Be.bitset.isSDF),p=k(e.bitset,Be.bitset.isMapAligned),f=k(e.bitset,Be.bitset.scaleSymbolsProportionally),d=wt(e.bitset,Be.bitset.colorLocked),h=st(this,e.id),b=rt(this,e.id,e.color,d).multiply(h),S=this.view.displayViewScreenMat3.multiply(new T(e.pos.xy,1)),V=ut(this,e.id,o).divide(o),z=i.multiply(V),M=e.offset.xy.multiply(V),P=r.multiply(f.multiply(V.subtract(1)).add(1));P=at(P,ue(z.subtract(.99),new s(0)));let O=ue(P,new s(1)),Q=at(P,new s(1)),ne=R.fromRotation(l.multiply(ri)),G=sa(this,e.id),j=this._getViewRotationMatrix(p).multiply(G).multiply(ne).multiply(new T(M.xy,0)),$=this.clip(e.id,e.zoomRange),Z=new v(S.xy.add(j.xy),$,1),I=e.textureUV.divide(this.mosaicInfo.size),wi=e.outlineColor.multiply(Q),Jt=k(e.bitset,Be.bitset.overrideOutlineColor),Mr=e.sdfDecodeCoeff.multiply(z);return m({glPosition:Z,color:b,textureUV:I,outlineColor:wi,outlineSize:O,distanceToPx:Mr,isSDF:u,overrideOutlineColor:Jt},this.maybeRunHittest(e,t,{pos:e.pos,size:z,sizeCorrection:V,isMapAligned:p,vvRotationMat3:G,placementMat3:ne,outlineSize:O,distanceToPx:Mr,isSDF:u}))}fragment(e){let t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return D(oi(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new s(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){let t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new s(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return D(se(t.isSDF,new s(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return E(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=E(this.mosaicInfo.texture,e),r=new s(.5).subtract(Ft(i)).multiply(t.distanceToPx).multiply(ji),o=de(new s(.5).subtract(r),new s(0),new s(1)),l=t.color.multiply(o),u=t.outlineSize;this.highlight&&(u=ue(u,t.overrideOutlineColor.multiply(4)));let p=u.multiply(.5),f=tt(r).subtract(p),d=de(new s(.5).subtract(f),new s(0),new s(1)),h=J(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new s(1).subtract(h.a).multiply(l).add(h)}_hittestSmallMarker(e,t,i){let{position:r,distance:o,smallSymbolDistance:l}=this.hittestRequest,u=o.subtract(l),{viewMat3:p,tileMat3:f}=this.view,d=p.multiply(f).multiply(new T(i.pos,1)).xy,h=i.size.multiply(.5);return qt(d,r).subtract(h).add(u)}_hittestMarker(e,t,i){let{pos:r,sizeCorrection:o,isMapAligned:l}=i,u=new T(e.offset.multiply(o),0),p=new T(t.offsetNextVertex1.multiply(o),0),f=new T(t.offsetNextVertex2.multiply(o),0),{viewMat3:d,tileMat3:h}=this.view,b=d.multiply(h).multiply(new T(r,1)),S=this._getViewScreenMatrix(l).multiply(i.vvRotationMat3).multiply(i.placementMat3),V=b.add(S.multiply(u)).xy,z=b.add(S.multiply(p)).xy,M=b.add(S.multiply(f)).xy,P=this.hittestRequest.position,O=this.hittestRequest.distance,Q=kt(P,V,z,M);return D(A(Q,O),Q,this._hittestSamples(V,z,M,e,t,i))}_hittestSamples(e,t,i,r,o,l){let{outlineSize:u,isSDF:p,distanceToPx:f}=l,d=this.hittestRequest.position,h=this.hittestRequest.distance,b=me(d.add(new y(le(h),le(h))),e,t,i),S=me(d.add(new y(0,le(h))),e,t,i),V=me(d.add(new y(h,le(h))),e,t,i),z=me(d.add(new y(le(h),0)),e,t,i),M=me(d,e,t,i),P=me(d.add(new y(h,0)),e,t,i),O=me(d.add(new y(le(h),h)),e,t,i),Q=me(d.add(new y(0,h)),e,t,i),ne=me(d.add(new y(h,h)),e,t,i),G=r.textureUV.divide(this.mosaicInfo.size),j=o.textureUVNextVertex1.divide(this.mosaicInfo.size),$=o.textureUVNextVertex2.divide(this.mosaicInfo.size),Z={color:new v(1),outlineColor:new v(1),overrideOutlineColor:new s(1),outlineSize:u,distanceToPx:f,isSDF:p},I=new s(0);return I=I.add(pe(b).multiply(this._getColor(yt(b,G,j,$),Z).a)),I=I.add(pe(S).multiply(this._getColor(yt(S,G,j,$),Z).a)),I=I.add(pe(V).multiply(this._getColor(yt(V,G,j,$),Z).a)),I=I.add(pe(z).multiply(this._getColor(yt(z,G,j,$),Z).a)),I=I.add(pe(M).multiply(this._getColor(yt(M,G,j,$),Z).a)),I=I.add(pe(P).multiply(this._getColor(yt(P,G,j,$),Z).a)),I=I.add(pe(O).multiply(this._getColor(yt(O,G,j,$),Z).a)),I=I.add(pe(Q).multiply(this._getColor(yt(Q,G,j,$),Z).a)),I=I.add(pe(ne).multiply(this._getColor(yt(ne,G,j,$),Z).a)),W(I,new s(.05)).multiply(Ue(this.hittestRequest))}};n([_(ve)],Pe.prototype,"visualVariableColor",void 0),n([_(be)],Pe.prototype,"visualVariableOpacity",void 0),n([_(lt)],Pe.prototype,"visualVariableRotation",void 0),n([_(Ae)],Pe.prototype,"visualVariableSizeMinMaxValue",void 0),n([_(Te)],Pe.prototype,"visualVariableSizeScaleStops",void 0),n([_(ze)],Pe.prototype,"visualVariableSizeStops",void 0),n([_(Re)],Pe.prototype,"visualVariableSizeUnitValue",void 0),n([c(re)],Pe.prototype,"mosaicInfo",void 0),n([w(0,F(Je)),w(1,F(Yt))],Pe.prototype,"vertex",null),n([w(0,F(Vr))],Pe.prototype,"fragment",null);var Ca=class extends q{constructor(){super(...arguments),this.type=H.Marker,this.shaders={geometry:new Pe},this.symbologyPlane=ce.MARKER}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)}),defines:m({},B(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(N(e)),r.submitDraw(e,t)}};var Oa=class{constructor(){this.computeAttributes={}}get locationsMap(){let e=new Map;for(let t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([r,o])=>`${r}.${o}`).join("."),i=Ir(t);this._locationInfo={hash:i,stringHash:t,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(r=>`${r}.${e[r]}`).join(".")}.${Object.keys(i).filter(r=>i[r]).map(r=>`${r}_${i[r].toString()}`).join(".")}.${Object.keys(t).filter(r=>this.optionPropertyKeys.has(r)).join(".")}`}getProgram(e,t,i,r){let o="",l="";for(let u in i)if(i[u]){let p=typeof i[u]=="boolean"?`#define ${u}
`:`#define ${u} ${i[u]}
`;o+=p,l+=p}return o+=this.vertexShader,l+=this.fragmentShader,new Ss(o,l,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){let t=[];for(let i in this.required){let r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:As(r),uniformArrayLength:Rs(r)})}for(let i in e){let r=this.options[i];if(e[i])for(let o in r){let l=r[o];t.push({uniformHydrated:null,shaderModulePath:`${i}.${o}`,uniformName:o,uniformType:l.type,uniformArrayElementType:As(l),uniformArrayLength:Rs(l)})}}return t}},As=a=>a.type==="array"?a.elementType?.type:void 0,Rs=a=>a.type==="array"?a.size:void 0;var ro={hittestDist:s,hittestPos:y},so={filterFlags:X,animation:X,visualVariableData:X,dataDriven0:X,dataDriven1:X,dataDriven2:X,gpgpu:X,size:s},oo={displayViewScreenMat3:R,displayViewMat3:R,displayMat3:R,viewMat3:R,tileMat3:R,displayZoomFactor:s,requiredZoomFactor:s,tileOffset:y,currentScale:s,currentZoom:s,metersPerSRUnit:s},Aa=class extends Oa{constructor(){super(...arguments),this.vertexShader=tr("materials/pie/pie.vert"),this.fragmentShader=tr("materials/pie/pie.frag"),this.required=x(m(m({},so),oo),{outlineWidth:s,colors:ee,defaultColor:v,othersColor:v,outlineColor:v,donutRatio:s,sectorThreshold:s}),this.options={hittestUniforms:ro,visualVariableSizeMinMaxValue:{minMaxValueAndSize:v},visualVariableSizeScaleStops:{sizes:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8}),values:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8})},visualVariableSizeStops:{sizes:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8}),values:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8})},visualVariableSizeUnitValue:{unitValueToPixelsRatio:s},visualVariableOpacity:{opacities:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8}),opacityValues:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8})}},this.locations={pos:{index:0,type:y},id:{index:1,type:T},bitset:{index:2,type:s},offset:{index:3,type:y},texCoords:{index:4,type:y},size:{index:5,type:y},referenceSize:{index:6,type:s},zoomRange:{index:7,type:y}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors=x(m({},ee.ofType(v,e)),{type:"array",elementType:v,size:e})}};var Ra=class extends q{constructor(){super(...arguments),this.type=H.PieChart,this.shaders={geometry:new Aa},this.symbologyPlane=ce.MARKER}render(e,t){let{painter:i}=e,{instance:r,target:o}=t,l=this.shaders.geometry,u=r.getInput(),p=u.uniforms.numberOfFields,f=L(e),d=U(e,o),h=B(e);l.setNumberOfFields(p),i.setShader({shader:l,uniforms:x(m(m(m({},K(e,t.target,u.uniforms.shader)),d.storage),d.view),{hittestUniforms:d.hittestRequest?{hittestDist:d.hittestRequest?.distance,hittestPos:d.hittestRequest?.position}:null}),defines:x(m({VV_SIZE_MIN_MAX_VALUE:!!u.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!u.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!u.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!u.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!u.uniforms.shader.visualVariableOpacity,HITTEST:f,highlight:d.highlight?1:0},h),{numberOfFields:p}),optionalAttributes:{},useComputeBuffer:f}),i.setPipelineState(N(e)),i.submitDraw(e,t)}};var La=class extends q{constructor(){super(...arguments),this.type=H.Text,this.shaders={geometry:new he},this.symbologyPlane=ce.TEXT}render(e,t){let{context:i,painter:r}=e,o=B(e),l=t.instance.getInput(),u={shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),U(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:x(m({},o),{isBackgroundPass:!0,isLabel:!1,textRenderPassType:we.Color}),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)};r.setShader(u),r.setPipelineState(N(e)),r.submitDraw(e,t),r.setShader(x(m({},u),{defines:x(m({},o),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:we.Halo})})),r.submitDraw(e,t),r.setShader(x(m({},u),{defines:x(m({},o),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:we.Outline})})),r.submitDraw(e,t),r.setShader(x(m({},u),{defines:x(m({},o),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:we.Color})})),r.submitDraw(e,t)}};var De={fill:new ya,patternFill:new va,complexFill:new fa,gradientFill:new ga,outlineFill:new xa,patternOutlineFill:new ba,complexOutlineFill:new ha,marker:new Ca,pieChart:new Ra,line:new Ia,texturedLine:new _a,gradientStroke:new Da,text:new La,label:new Ma,heatmap:new za,dotDensity:new da,animatedMarker:new la};function Ty(){for(let a in De)De[a].startup()}function zy(a){for(let e in De)De[e].shutdown(a)}function qi(a,e){let t=a.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){let o=t[t.length-1];t.push(o)}return t}function Ls(a){if(!a)return[0,0,0,0];let{r:e,g:t,b:i,a:r}=a;return[e*(r/255),t*(r/255),i*(r/255),r]}var Ea=8,Es=Ea-2,Bs=()=>Ui.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Ba(a){return a.map(e=>no(e)?lo(e.clone()):e)}function no(a){return(a.type==="size"||a.type==="color"||a.type==="opacity")&&a.stops!=null}function lo(a){return a.stops=mo(a.type,a.stops??[]),a}function Si(a,e,t){return(1-t)*a+t*e}function uo(a,e){let[t,...i]=e,r=i.pop(),o=i[0].value,l=i[i.length-1].value,u=(l-o)/Es,p=[];for(let f=o;f<l;f+=u){let d=0;for(;f>=i[d].value;)d++;let h=i[d],b=e[d-1],S=f-b.value,V=h.value===b.value?1:S/(h.value-b.value);if(a==="color"){let z=i[d],M=e[d-1],P=z.color.clone();P.r=Si(M.color.r,P.r,V),P.g=Si(M.color.g,P.g,V),P.b=Si(M.color.b,P.b,V),P.a=Si(M.color.a,P.a,V),p.push({value:f,color:P,label:z.label})}else if(a==="size"){let z=i[d],M=e[d-1],P=Ga(z.size),O=Si(Ga(M.size),P,V);p.push({value:f,size:O,label:z.label})}else{let z=i[d],M=Si(e[d-1].opacity,z.opacity,V);p.push({value:f,opacity:M,label:z.label})}}return[t,...p,r]}function po(a){let[e,...t]=a,i=t.pop();for(;t.length>Es;){let r=0,o=0;for(let l=1;l<t.length;l++){let u=t[l-1],p=t[l],f=Math.abs(p.value-u.value);f>o&&(o=f,r=l)}t.splice(r,1)}return[e,...t,i]}function mo(a,e){return e.length<=Ea?e:(Bs().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${Ea}. Displayed stops will be simplified.`),e.length>2*Ea?uo(a,e):po(e))}function co(){let{supportsColorBufferFloat:a,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=ai();return a&&e||t}function Oy(a){if(!a)return!0;switch(a.type){case"dot-density":break;case"heatmap":if(!co()){let e=ai(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return Bs().errorOnce(new ti("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}var ho=1.25,qa=128,yo=128;function go(a){if(!a.stops?.length)return null;let e=a.stops.sort((o,l)=>o.value-l.value),t=qi(e,8),i=t.map(({value:o})=>o),r=t.map(({color:o})=>Ls(o));return{values:i,colors:r}}function xo(a){if(!a.stops?.length)return null;let e=a.stops.sort((i,r)=>i.value-r.value),t=qi(e,8);return{opacityValues:t.map(({value:i})=>i),opacities:t.map(({opacity:i})=>i)}}function vo(a){return{rotationType:a.rotationType==="geographic"?Ti.Geographic:Ti.Arithmatic}}function wr(a){if(!a.stops?.length)return null;if(a.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,r)=>{let o=i.statisticsByLevel.get(r.key.level),l=a.stops.map(p=>({value:p.useMaxValue?o?.get(a.field)?.maxValue??0:p.useMinValue?o?.get(a.field)?.minValue??0:p.value,size:p.size?ot(p.size):1e-30})).sort((p,f)=>p.value-f.value),u=qi(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};let e=a.stops.sort((i,r)=>i.value-r.value),t=qi(e,8);return{values:t.map(({value:i})=>i),sizes:t.map(({size:i})=>ot(i))}}function bo(a){return e=>{let{state:t}=e;return{unitValueToPixelsRatio:Ar(t.spatialReference)/Rr[a.valueUnit??"meters"]/t.resolution}}}function qs(a,e){let t=e.length;if(a<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(a<e[i].value){let r=(a-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function So(a){let{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=a;if(typeof i=="object"&&typeof r=="object")return(o,l)=>{let u=o.state.scale,p=ot(qs(u,i.stops)),f=ot(qs(u,r.stops));return{minMaxValueAndSize:[e,t,p,f]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,ot(i),ot(r)]}}var Vi={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Fr(a,e=yo,t=ho){if(a.visualVariableSizeMinMaxValue)return a.visualVariableSizeMinMaxValue instanceof Function?qa:Math.max(a.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(a.visualVariableSizeScaleStops){if(a.visualVariableSizeScaleStops instanceof Function)return qa;let i=a.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(a.visualVariableSizeStops){if(a.visualVariableSizeStops instanceof Function)return qa;let i=a.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return a.visualVariableSizeUnitValue?2*qa:0}function Gy(a){let e=m({},Vi);if(!a||!("visualVariables"in a)||!a.visualVariables)return e;for(let t of Ba(a.visualVariables))switch(t.type){case"color":e.visualVariableColor=go(t);break;case"opacity":e.visualVariableOpacity=xo(t);break;case"rotation":e.visualVariableRotation=vo(t);break;case"size":switch(Vo(t)){case"field-stops":e.visualVariableSizeStops=wr(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=wr(t):e.visualVariableSizeScaleStops=wr(t);break;case"min-max":e.visualVariableSizeMinMaxValue=So(t);break;case"unit-value":e.visualVariableSizeUnitValue=bo(t)}break}return e}function Vo(a){return typeof a.minDataValue=="number"&&typeof a.maxDataValue=="number"&&a.minSize!=null&&a.maxSize!=null?"min-max":a?.valueExpression==="$view.scale"&&Array.isArray(a.stops)?"scale-stops":a.field==null&&a?.valueExpression==="$view.scale"||!(Array.isArray(a.stops)||"levels"in a&&a.levels)?a.field!=null||a?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function Us(a){return!!(a.visualVariableSizeMinMaxValue||a.visualVariableSizeScaleStops||a.visualVariableSizeStops||a.visualVariableSizeUnitValue||a.visualVariableSizeOutlineScaleStops)}function jy(a){return!!a.visualVariableRotation}function wo(a){return a.minScale||a.maxScale?{minScale:a.minScale??0,maxScale:a.maxScale??0}:null}function Ne(a){if(a==null)return null;if(Array.isArray(a)){let[e,t,i,r]=a;return[e,t,i,255*r]}return typeof a=="string"?a:x(m({},a),{defaultValue:Ne(a?.defaultValue)})}function eg(a,e){return ei(this,null,function*(){let{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;yield Promise.all(Nr.fetchResources(a.symbol,t,[]));let o=i.analyzeSymbolReference(a,!1),l={scaleInfo:wo(a),scaleExpression:r},u=[];for(let p of o)switch(p.type){case"marker":u.push(...Fo(p,e,l));break;case"fill":u.push(...Do(p,e,l));break;case"gradientFill":u.push(..._o(p,e,l));break;case"line":u.push(...Oo(p,e,l));break;case"gradientStroke":u.push(...Lo(p,e,l));break;case"text":u.push(...Bo(p,e,l))}return u})}function Fo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r,l=a.isOutline?x(m({},Vi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return a.animationParams?To(o.ensureInstance(De.animatedMarker,{uniforms:l,optionalAttributes:{zoomRange:!0}}),a,Vi,t):zo(o.ensureInstance(De.marker,{uniforms:l,optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,i,t)}function To(a,e,t,i){return e.animationParams?[a.createMeshInfo({pixelDimensions:e.pixelDimensions,texelDimensions:e.texelDimensions,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:e.spriteRasterizationParam,animations:e.animationParams,scaleInfo:i.scaleInfo,scaleSymbolsProportionally:e.scaleSymbolsProportionally,strokeWidth:e.outlineWidth,isMapAligned:e.alignment===Lr.MAP,colorLocked:e.colorLocked,isStroke:e.isStroke,baseSize:e.baseSize,referenceSize:e.referenceSize,angleToLine:!!e.markerPlacement&&e.markerPlacement.placement&&"angleToLine"in e.markerPlacement.placement&&e.markerPlacement.placement.angleToLine,sizeRatio:e.sizeRatio})]:[]}function zo(a,e,t,{scaleInfo:i,scaleExpression:r}){let o=Us(t);return[a.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:Ne(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:Ne(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||Er.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:o,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:Fr(t)})]}function Mo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Po(o.ensureInstance(De.fill,{uniforms:{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,t)}function Po(a,e,{scaleInfo:t}){return[a.createMeshInfo({color:Ne(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Do(a,e,t){if(!a.spriteRasterizationParam)return Mo(a,e,t);let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Io(o.ensureInstance(De.complexFill,{uniforms:{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,i.visualVariableColor!=null,t)}function Io(a,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),o=e.sampleAlphaOnly&&!r,l=e.spriteRasterizationParam;return[a.createMeshInfo({color:Ne(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:o,scaleProportionally:l.resource.type==="CIMHatchFill",sprite:l,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function _o(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Co(o.ensureInstance(De.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,t)}function Co(a,e,{scaleInfo:t}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let i=e.spriteRasterizationParam;return[a.createMeshInfo({color:Ne(e.color)??[0,0,0,0],angle:e.angle,gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:i,scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Oo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r,l=a.isOutline?x(m({},Vi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},u={uniforms:l,optionalAttributes:{zoomRange:!!t.scaleInfo}},p=!!(l.visualVariableSizeMinMaxValue||l.visualVariableSizeScaleStops||l.visualVariableSizeStops||l.visualVariableSizeUnitValue);return a.spriteRasterizationParam?Ro(o.ensureInstance(De.texturedLine,u),a,p,t):Ao(o.ensureInstance(De.line,u),a,p,t)}function Tr(a,e,{scaleInfo:t}){return{color:Ne(a.color)??[0,0,0,0],width:a.width,referenceWidth:a.referenceWidth,capType:a.cap,joinType:a.join,miterLimit:a.miterLimit,scaleInfo:t,hasSizeVV:e,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null}}function Ao(a,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");let r=Tr(e,t,i);return[a.createMeshInfo(r)]}function Ro(a,e,t,i){let{spriteRasterizationParam:r,scaleDash:o,sampleAlphaOnly:l}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[a.createMeshInfo(x(m({},Tr(e,t,i)),{offsetAlongLine:e.offsetAlongLine??0,shouldScaleDash:o??!1,shouldSampleAlphaOnly:l,isSDF:r.resource.type!=="CIMPictureStroke"&&r.resource.type!=="CIMGradientStroke",sprite:r}))]}function Lo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Eo(o.ensureInstance(De.gradientStroke,{uniforms:a.isOutline?x(m({},Vi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:null,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,t)}function Eo(a,e,t){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let i=e.spriteRasterizationParam;return[a.createMeshInfo(x(m({},Tr(e,!1,t)),{gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}))]}function Bo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return qo(o.ensureInstance(De.text,{uniforms:{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),a,i,t)}function qo(a,e,t,{scaleInfo:i,scaleExpression:r}){return[a.createMeshInfo({boxBackgroundColor:Ne(e.backgroundColor),boxBorderLineColor:Ne(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:Ne(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:Ne(e.haloColor)??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:Ne(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:Fr(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}var zr=class{constructor(){this.type="override-batch",this.messages=[],this._resovler=Cr()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}},Hs=class{constructor(e){this.updateTracking=new os({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new Or({concurrency:1,process:t=>ei(this,null,function*(){if(t.type==="override-batch"){let i=this._nextOverrideBatch;if(i==null)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,yield this.process(i),void i.resolve()}return this.process(t)})})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}push(e){return ei(this,null,function*(){return _r(this.updateTracking.addPromise(this._doPush(e)))})}_doPush(e){return ei(this,null,function*(){let t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":return i?.type===e.type?void 0:t.push(e);case"override":case"edit":return this._pushOverride(e)}})}_pushOverride(e){return this._nextOverrideBatch==null&&(this._nextOverrideBatch=new zr,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}};function dg(a,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:ai().maxTextureSize},bindings:Ua(a)}}function fg(a,e){let t=ai();return{type:"multi",target:"feature",keyField:Ur,filters:e,capabilities:{maxTextureSize:t.maxTextureSize},bindings:{[Ni.TrackLine]:Ua(a.trackLines.renderer),[Ni.LatestObservation]:Ua(a.latestObservations.renderer),[Ni.PreviousObservation]:Ua(a.previousObservations.renderer)}}}function Ha(a){switch(a){case"opacity":return Mi.OPACITY;case"color":return Mi.COLOR;case"rotation":return Mi.ROTATION;case"size":return Mi.SIZE;default:return null}}function Ua(a){if(!a)return[];switch(a.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return ks(a);case"dot-density":return Uo(a);case"pie-chart":return Ho(a);case"heatmap":return ko(a)}}function Uo(a){let e=[];for(let t of a.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Ho(a){let e=ks(a),t=4;for(let i of a.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function ko({valueExpression:a,field:e}){return a||e?[{binding:0,expression:a,field:e}]:[]}function ks(a){return!("visualVariables"in a)||!a.visualVariables?.length?[]:Ba(a.visualVariables).map(e=>Zo(e)).filter(Dr)}function Go(a){return a.valueExpression==="$view.scale"?null:{binding:Ha(a.type),field:a.field,normalizationField:a.normalizationField,expression:a.valueExpression,valueRepresentation:a.valueRepresentation}}function No(a){return{binding:Ha(a.type),field:a.field,normalizationField:a.normalizationField,expression:a.valueExpression}}function Wo(a){return{binding:Ha(a.type),field:a.field,normalizationField:a.normalizationField,expression:a.valueExpression}}function jo(a){return{binding:Ha(a.type),expression:a.valueExpression,field:a.field}}function Zo(a){switch(a.type){case"size":return Go(a);case"color":return No(a);case"opacity":return Wo(a);case"rotation":return jo(a)}}export{pi as a,ws as b,mi as c,wn as d,Fn as e,ia as f,aa as g,De as h,Ty as i,zy as j,Ls as k,Oy as l,Vi as m,Fr as n,Gy as o,Us as p,jy as q,wo as r,eg as s,To as t,zo as u,Po as v,Io as w,Co as x,Ao as y,Ro as z,Eo as A,qo as B,dg as C,fg as D,ks as E,Hs as F};
