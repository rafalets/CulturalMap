import{a as le}from"./chunk-IQYLT45D.js";import{a as We,c as qe,d as E,e as C,f as v,g as V,h as S,k as R,l as ae}from"./chunk-UMFVIJYZ.js";import"./chunk-7AVL35LM.js";import"./chunk-HZW4TZLN.js";import"./chunk-BKBYZ6R7.js";import"./chunk-Y3QXXHTY.js";import{a as Fe,e as Ge,x as _e,z as te}from"./chunk-QPRTRAGG.js";import{B as je,q as re}from"./chunk-OZ3HM6MC.js";import{t as Be}from"./chunk-XUJMOYBO.js";import"./chunk-FCB5DYUJ.js";import"./chunk-3V2UIH2D.js";import"./chunk-VU5W7W6Y.js";import"./chunk-E56W4PK4.js";import"./chunk-IPGHBSHO.js";import"./chunk-XPXAET6Q.js";import"./chunk-2ILDS6SI.js";import"./chunk-FVILOOND.js";import{b as $e}from"./chunk-3ZX35QIC.js";import"./chunk-7PERXXHH.js";import{a as ke}from"./chunk-QYRRGSBK.js";import{a as Me}from"./chunk-5PVZ33WG.js";import"./chunk-ZMJUEIM7.js";import"./chunk-V7IMCFL4.js";import"./chunk-XD6QSICT.js";import"./chunk-FTOLVNUN.js";import"./chunk-EOLWCIYR.js";import"./chunk-YOMR2DCD.js";import"./chunk-KDF3RZ2K.js";import"./chunk-AFSNSPOG.js";import"./chunk-JEGXFID4.js";import"./chunk-SU5S5XU7.js";import{e as ge}from"./chunk-F6A6XWW4.js";import"./chunk-AESEF3B2.js";import"./chunk-74LTYPBC.js";import"./chunk-3BDL2KTL.js";import"./chunk-TGPGCQ44.js";import"./chunk-PWU2QHPV.js";import{p as Ve}from"./chunk-WUJRCGDY.js";import"./chunk-QPGCDGIN.js";import"./chunk-JH4RD366.js";import"./chunk-7Y6S2GNA.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-PTZYZULI.js";import"./chunk-KZKWOEFD.js";import"./chunk-LNVVFNTC.js";import{a as ee}from"./chunk-WDTJILD4.js";import{a as Re}from"./chunk-MAVVUPFJ.js";import"./chunk-BVXSAX5Q.js";import"./chunk-V2JYXY4D.js";import{a as Ne}from"./chunk-OOAI5LGC.js";import{c as De}from"./chunk-5TMYC5PF.js";import"./chunk-RCDSCJMH.js";import"./chunk-QJADLTFR.js";import{a as Pe}from"./chunk-IWPCZHB6.js";import{a as Ee}from"./chunk-2BIJFS64.js";import{c as Le,f as Ae}from"./chunk-SCKV27CX.js";import"./chunk-FXCL7YYQ.js";import"./chunk-HX2BGUTP.js";import"./chunk-XSTBHERR.js";import{a as Te}from"./chunk-S7QYPX7J.js";import{a as Oe}from"./chunk-KWZIB4M6.js";import"./chunk-YQPWWSMJ.js";import"./chunk-JEIB6WNP.js";import"./chunk-6JJCXUHW.js";import"./chunk-CVRJ6GOM.js";import"./chunk-X7QUUHRV.js";import"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-3HCMTURP.js";import"./chunk-VT67LWCR.js";import"./chunk-K27GONOJ.js";import"./chunk-6KRFVLII.js";import"./chunk-JR22Z7I2.js";import"./chunk-3QNSJ5HY.js";import"./chunk-UNVICPIE.js";import"./chunk-BGICKEJR.js";import"./chunk-TRZXSDYA.js";import{a as Ce}from"./chunk-OGS2SUK5.js";import"./chunk-TVHRLNTK.js";import"./chunk-JA3EMS2I.js";import"./chunk-HKHTIKVW.js";import"./chunk-XFESK2YB.js";import"./chunk-IJBTA53P.js";import"./chunk-ZHUXSQTN.js";import"./chunk-YLZWDFCJ.js";import"./chunk-TLMADEUL.js";import"./chunk-WNSGKHQ6.js";import"./chunk-J5MXC6AL.js";import"./chunk-OLOKUDVI.js";import"./chunk-RJWOVI3M.js";import"./chunk-R6GE4XRP.js";import"./chunk-MDL4XPLR.js";import"./chunk-ILKINAL7.js";import"./chunk-HVKMTRIC.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import"./chunk-NHSDW26F.js";import"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import"./chunk-WAGBL553.js";import"./chunk-WKJJQIBC.js";import"./chunk-VDADRLEF.js";import"./chunk-CNQVGGE6.js";import"./chunk-JGD7UKVF.js";import"./chunk-J372WZPB.js";import"./chunk-6XFS4U2F.js";import"./chunk-XPRVY6JT.js";import{h as Ie}from"./chunk-7N3ZKWML.js";import"./chunk-E62WHYYG.js";import"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import"./chunk-3SDSCSDJ.js";import{j as W}from"./chunk-I4M2OT5W.js";import"./chunk-NTVLK3P2.js";import"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-IXCTZWTQ.js";import"./chunk-6PN3I333.js";import"./chunk-ZTJLFKGG.js";import"./chunk-5TW726OD.js";import"./chunk-VGD3XLDH.js";import{a as Se}from"./chunk-LB5YQINJ.js";import"./chunk-EKMHQEJY.js";import"./chunk-VACZNAP3.js";import"./chunk-JKNCWG7E.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7IPIJKWU.js";import"./chunk-7R33MKVL.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import{F as oe}from"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import{d as D}from"./chunk-C7INQGWT.js";import{H as se}from"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{C as fe,M as xe,x as we}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import{a as T}from"./chunk-QGVBCWUY.js";import{r as ie,t as N}from"./chunk-HHDFN2GK.js";import"./chunk-47GHT6OF.js";import{a as B,b as ne,f as k}from"./chunk-VTHXE323.js";function Q(e){return e.endsWith("?")?e.slice(0,-1):e}function he(e){return e.filter(({coverageSubType:t})=>t==null||t===""||/^rectified(grid|dataset)/i.test(t))}function st(e){let t=v(e,"Service/name"),n=C(e,"Capability"),o=C(n,"GetCapabilities/Get/OnlineResource")?.getAttribute("xlink:href")??"",i=C(n,"DescribeCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",r=C(n,"GetCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",s={getCapabilities:Q(o),describeCoverage:Q(i),getCoverage:Q(r)},a=E(e,"CoverageOfferingBrief"),u=[];for(let l=0;l<a.length;l++){let p=a[l],m=v(p,"name"),c=E(p,"pos"),d=S(c[0]),g=S(c[1]),f=new W({xmin:d[0],ymin:d[1],xmax:g[0],ymax:g[1],spatialReference:{wkid:4326}});u.push({id:m,lonLatEnvelope:f})}return{name:t,onlineResources:s,coverages:u,gridCoverages:he(u),supportedVersions:["1.0.0"],version:"1.0.0"}}function Ue(e){let t={};for(let n=0;n<e.childNodes.length;n++){let o=e.childNodes[n];if(o.nodeType!==1)continue;let i=ae(o).toLowerCase();switch(i){case"title":case"abstract":t[i]=v(o);break;case"identifier":t.id=v(o);break;case"wgs84boundingbox":{let r=S(o,"LowerCorner"),s=S(o,"UpperCorner");t.lonLatEnvelope=new W({xmin:r[0],ymin:r[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(Ue(o))}}return t}function ze(e,t){if(e.coverageSummaries)for(let n=0;n<e.coverageSummaries.length;n++)e.coverageSummaries[n].abstract=e.coverageSummaries[n].abstract||e.abstract,e.coverageSummaries[n].lonLatEnvelope=e.coverageSummaries[n].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[n].title=e.coverageSummaries[n].title||e.title,ze(e.coverageSummaries[n],t);e.id!=null&&t.push(e)}function He(e){let t=C(e.querySelector("Operation[name=GetCapabilities]"),"Get")?.getAttribute("xlink:href")||"",n=C(e.querySelector("Operation[name=DescribeCoverage]"),"Get")?.getAttribute("xlink:href")||"",o=C(e.querySelector("Operation[name=GetCoverage]"),"Get")?.getAttribute("xlink:href")||"";return{getCapabilities:Q(t),describeCoverage:Q(n),getCoverage:Q(o)}}function ot(e){let t=v(e,"ServiceIdentification/Title"),n=V(e,"ServiceIdentification/ServiceTypeVersion"),o=He(C(e,"OperationsMetadata")),i=[],r=C(e,"Contents");for(let a=0;a<r.childNodes.length;a++){let u=r.childNodes[a];u.nodeType===1&&R(u,"CoverageSummary")&&ze(Ue(u),i)}let s=V(r,"SupportedFormat");return{name:t,onlineResources:o,coverages:i,gridCoverages:he(i),supportedVersions:n,supportedFormats:s,version:"1.1.0"}}function rt(e){let t=C(e,"ServiceIdentification"),n=v(t,"Title"),o=V(t,"ServiceTypeVersion"),i=V(t,"Profile"),r=He(C(e,"OperationsMetadata")),s=E(e,"Contents/CoverageSummary"),a=[];for(let l=0;l<s.length;l++){let p=s[l],m=v(p,"CoverageId"),c=C(p,"WGS84BoundingBox"),d;if(c){let f=S(c,"LowerCorner"),h=S(c,"UpperCorner");d=new W({xmin:f[0],ymin:f[1],xmax:h[0],ymax:h[1],spatialReference:{wkid:4326}})}let g=v(p,"CoverageSubtype")||"RectifiedGridCoverage";a.push({id:m,lonLatEnvelope:d,coverageSubType:g})}let u=C(e,"ServiceMetadata");return{name:n,supportedVersions:o,supportedFormats:V(u,"formatSupported"),supportedInterpolations:V(u,"interpolationSupported").concat(V(u,"InterpolationSupported")),onlineResources:r,profiles:i,coverages:a,gridCoverages:he(a),version:"2.0.1"}}function Ye(e){let t=null;typeof e=="string"?t=new DOMParser().parseFromString(e,"text/xml"):t=e;let n=t.documentElement.getAttribute("version"),o=n?.slice(0,3);return o!=null&&o<"2.1"}function Ze(e,t=null){let n=null;typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e;let o=n.documentElement.getAttribute("version");o==="1.0"?o="1.0.0":o==="1.1"&&(o="1.1.0");let i=o||t||"1.0.0",r=i.slice(0,3),s;if(r==="2.0")s=rt(n);else if(r==="1.1")s=ot(n);else{if(r!=="1.0")throw new N("wcsraster:parsecapabilities","the capabilities version is not supported");s=st(n)}return s.version=i,s}function ve(e){e.variables.forEach(t=>t.dimensions.forEach(n=>n.values??=_e(n)))}function at(e){return{requestResponseCRSs:V(e,"requestResponseCRSs").map(t=>t.split(":")[1]),nativeCRSs:V(e,"nativeCRSs").map(t=>t.split(":")[1])}}function Je(e,t){let n=V(e,t==="1.0.0"?"interpolationMethod":"InterpolationMethod"),o=t==="1.0.0"?e.getAttribute("default"):v(e,"InterpolationMethods/Default");return o!=null?[o].concat(n.filter(i=>i.toLowerCase()!==o.toLowerCase())):n}function pe(e){return e==null?["nearest"]:e.map(t=>{let n=t.toLowerCase();return n.includes("nearest")?"nearest":n.includes("linear")?"bilinear":n.includes("cubic")?"cubic":null}).filter(t=>!!t)}function lt(e){let t=E(e,"pos"),n=S(t[0]),o=S(t[1]);return new W({xmin:n[0],ymin:n[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:4326}})}function ye(e,t){let n=V(e,t);return n?.length&&n[0]!==""&&!isNaN(Number(n[0]))?n.map(o=>Number(o)):null}function ct(e){let t=S(e,"MinimumValue"),n=S(e,"MaximumValue");return t.length&&n.length?t.map((o,i)=>({min:o,max:n[i],avg:-1,stddev:-1})):null}function be(e){return e==null?null:e.every(t=>t===e[0])?e[0]:e}function pt(e){let t=[],n=E(e,"RangeSet"),o=[];for(let i=0;i<n.length;i++){let r=v(n[i],"name"),s=v(n[i],"label"),a=[],u=ye(n[i],"nullValues/singleValue"),l=E(n[i],"AxisDescription");for(let p=0;p<l.length;p++){let m=v(l[p],"name"),c=v(l[p],"label"),d=V(l[p],"singleValue");if(d.length===0){let g=v(l[p],"min"),f=v(l[p],"max"),h=Number(v(l[p],"res"))||1;if(g!==null&&f!==null)for(let y=parseInt(g,10);y<=parseInt(f,10);y+=h)d.push(y.toString())}m.toLowerCase()==="band"&&(o=d),a.push({name:m,label:c,values:d})}t.push({name:r,label:s,nullValues:u,axis:a})}return{rangeSet:t,bandNames:o}}function ut(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase(),n=["Y","M","D"],o=["H","M","S"],i=["Years","Months","Days","Hours","Minutes","Seconds"],r,s,a;return t.includes("PT")?(t=t.slice(2),a=o.findIndex(u=>t.includes(u)),r=i[3+a],s=parseFloat(t.slice(0,-1))):(t=t.slice(1),a=n.findIndex(u=>t.includes(u)),a>-1&&(r=i[a]),s=parseFloat(t.slice(0,-1))),{resolution:s,units:r}}function ce(e){let t=E(e,"timeposition");if(t.length>0){let o=[];for(let i=0;i<t.length;i++)o.push(new Date(v(t[i])));return{begin:o[0],end:o[o.length-1],values:o}}let n=C(e,"timePeriod")||C(e,"TimePeriod");return n?B({begin:new Date(v(n,"beginPosition")||v(n,"BeginPosition")),end:new Date(v(n,"endPosition")||v(n,"EndPosition"))},ut(v(n,"timeResolution")||v(n,"TimeResolution"))):null}function mt(e){let t=C(e,"spatialDomain"),n=C(t,"Envelope")||C(t,"EnvelopeWithTimePeriod"),o=n.getAttribute("srsName").split(":"),i=o[o.length-1],r=E(n,"pos"),s=S(r[0]),a=S(r[1]),u=parseInt(i,10),l=isNaN(u)?null:{wkid:u},p=new W({xmin:s[0],ymin:s[1],xmax:a[0],ymax:a[1],spatialReference:l}),m=C(t,"RectifiedGrid"),c=v(m,"low").split(" "),d=v(m,"high").split(" "),g=parseInt(d[0],10)-parseInt(c[0],10)+1,f=parseInt(d[1],10)-parseInt(c[1],10)+1,h=S(t,"origin/pos"),y=E(t,"offsetVector"),b={envelope:p,columns:g,rows:f,offset:{x:parseFloat(v(y[0]).split(" ")[0]),y:parseFloat(v(y[1]).split(" ")[1])},origin:{x:h[0],y:h[1]}},I=C(e,"temporalDomain")||C(e,"TemporalDomain");return{spatialDomain:b,temporalDomain:I?ce(I):null}}function dt(e){let t={version:"1.0"},n,o=[];for(let g=0;g<e.childNodes.length;g++){let f=e.childNodes[g];if(f.nodeType===1)if(R(f,"description"))t.description=v(f);else if(R(f,"name"))t.name=v(f);else if(R(f,"label"))t.label=v(f);else if(R(f,"supportedFormats"))t.supportedFormats=V(f,"formats");else if(R(f,"supportedCRSs"))t.supportedCRSs=at(f);else if(R(f,"supportedInterpolations"))t.supportedInterpolations=Je(f,"1.0.0");else if(R(f,"lonLatEnvelope"))t.lonLatEnvelope=lt(f);else if(R(f,"rangeSet")){let h=pt(f);t.rangeSet=h.rangeSet,o=h.bandNames;let y=h.rangeSet[0].nullValues;y?.length&&(n=be(y))}else R(f,"domainSet")&&(t.domainSet=mt(f))}let i=pe(t.supportedInterpolations),{name:r,description:s,label:a,lonLatEnvelope:u,supportedFormats:l}=t,{spatialDomain:p}=t.domainSet,m={x:Math.abs(p.offset.x),y:Math.abs(p.offset.y)},c=ft(t.domainSet),d=new re({width:p.columns,height:p.rows,pixelSize:m,pixelType:"unknown",extent:p.envelope,spatialReference:p.envelope.spatialReference,bandCount:o.length||1,noDataValue:n,multidimensionalInfo:c});return{id:r,title:t.name,description:s||a,lonLatEnvelope:u,rasterInfo:d,bandNames:o,supportedFormats:l,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function ft(e){if(!e.temporalDomain)return null;let{begin:t,end:n,values:o,units:i,resolution:r}=e.temporalDomain,s={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:o?.map(a=>a.getTime()),hasRegularIntervals:!o,interval:r,intervalUnit:i,extent:[t.getTime(),n.getTime()]}]}]};return ve(s),s}function gt(e,t){let n=[],o=E(e,"Field"),i,r=[];for(let s=0;s<o.length;s++){let a=v(o[s],"Identifier"),u=v(o[s],"Description"),l=v(o[s],"Definition"),p=v(o[s],"Abstract"),m=v(o[s],"Title"),c=ye(o[s],"NullValue"),d=C(o[s],"AllowedValues"),g=d?ct(d):null,f=Je(o[s],"1.1.0"),h=[],y=E(o[s],"Axis");for(let b=0;b<y.length;b++){let I=y[b].getAttribute("identifier"),w=v(y[b],"UOM"),A=v(y[b],"DataType"),F=V(y[b],"Key");t&&!I.toLowerCase().includes("band")||(r=F,i=c),h.push({identifier:I,uom:w,dataType:A,values:F,bandNoDataValues:i})}n.push({identifier:a,description:u,definition:l,abstract:p,title:m,supportedInterpolations:f,axis:h,nullValues:c,statistics:g})}return{rangeSet:n,bandNames:r,bandNoDataValues:i,statistics:n[0].statistics}}function ht(e,t){if(!t.temporalDomain)return null;let n=e.filter(i=>!i.identifier.toLowerCase().includes("field_1")&&!i.axis.some(r=>r.identifier.includes("band"))),o=[];if(n.length&&n.forEach(i=>{let r=i.axis.map(s=>{let a=s.values.map(l=>s.uom==="ISO8601"?(l=l.trim()).toLowerCase().includes("z")?new Date(l).getTime():new Date(l+"Z").getTime():parseFloat(l.trim())),u=[Math.min.apply(null,a),Math.max.apply(null,a)];return{name:s.identifier.trim(),description:"",field:s.identifier.trim(),unit:s.uom?s.uom.trim():"",hasRegularIntervals:!1,values:a,extent:u}});o.push({name:i.identifier.trim(),description:i.description?.trim()??"",unit:"",dimensions:r,statistics:i.statistics})}),t.temporalDomain){let{begin:i,end:r,values:s,units:a,resolution:u}=t.temporalDomain;o.some(l=>l.dimensions.some(p=>p.name.toLowerCase()==="stdtime"))||o.forEach(l=>{l.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:s?.map(p=>p.getTime()),hasRegularIntervals:!s,interval:u,intervalUnit:a,extent:[i.getTime(),r.getTime()]})})}if(o.length){let i={variables:o};return ve(i),i}return null}function vt(e){let t=C(e,"SpatialDomain"),n=C(t,"GridCRS"),o=v(n,"GridBaseCRS"),i=v(n,"GridOrigin"),r=i?.split(" ").map(y=>parseFloat(y))??[0,0],s=S(n,"GridOffsets"),a=E(t,"BoundingBox"),u,l,p,m;for(let y=0;y<a.length;y++){let b=a[y].getAttribute("crs")?.toLowerCase();if(b!=null){if(b.includes("imagecrs")){let I=S(a[y],"LowerCorner"),w=S(a[y],"UpperCorner");u=w[0]-I[0]+1,l=w[1]-I[1]+1}else if(b.indexOf("epsg")>0){let I=b.split(":");p=parseInt(I[I.length-1],10);let w=S(a[y],"LowerCorner"),A=S(a[y],"UpperCorner");m=new W({xmin:w[0],ymin:w[1],xmax:A[0],ymax:A[1],spatialReference:{wkid:p}})}}}let c=u>l,d=m.xmax-m.xmin>m.ymax-m.ymin,g=!1;le(p)&&(c===d?g=!1:(g=!0,m=new W({xmin:m.ymin,ymin:m.xmin,xmax:m.ymax,ymax:m.xmax,spatialReference:{wkid:p}})));let f={columns:u,rows:l,origin:{x:r[0],y:r[1]},offset:{x:s[0],y:s[s.length-1]},gridBaseCRS:o,envelope:m,useEPSGAxis:g},h=C(e,"temporalDomain")||C(e,"TemporalDomain");return{spatialDomain:f,temporalDomain:h?ce(h):null}}function yt(e,t){let n=[],o=[],i={supportedFormats:n,supportedCRSs:o,version:"1.1"},r,s,a=[];for(let y=0;y<e.childNodes.length;y++){let b=e.childNodes[y];if(b.nodeType!==1)continue;let I=ae(b).toLowerCase();switch(I){case"title":case"abstract":case"identifier":i[I]=v(b);break;case"supportedformat":{let w=v(b);n.includes(w)||n.push(w)}break;case"supportedcrs":{let w=v(b);o.includes(w)||o.push(w)}break;case"range":{let w=gt(b,!!i.domain?.temporalDomain);i.range=w.rangeSet,a=w.bandNames;let{bandNoDataValues:A}=w;A?.length&&(r=be(A)),s=w.statistics}break;case"domain":i.domain=vt(b)}}let u=pe(i.range[0].supportedInterpolations),{identifier:l,abstract:p,title:m,domain:c,range:d}=i,g={x:Math.abs(c.spatialDomain.offset.x),y:Math.abs(c.spatialDomain.offset.y)},f=ht(d,c);f&&(r=d[0].nullValues,r?.length===1&&(r=r[0]));let h=new re({width:c.spatialDomain.columns,height:c.spatialDomain.rows,pixelSize:g,pixelType:"unknown",extent:c.spatialDomain.envelope,spatialReference:c.spatialDomain.envelope.spatialReference,bandCount:a.length||1,noDataValue:r,statistics:s,multidimensionalInfo:f});return{id:l,title:i.title,description:p||m,bandNames:a,rasterInfo:h,supportedFormats:n,supportedInterpolations:u,coverageDescription:i,version:t,useEPSGAxis:c.spatialDomain.useEPSGAxis}}function bt(e){let t=C(e,"Envelope")||C(e,"EnvelopeWithTimePeriod"),n=t.getAttribute("srsName"),o=n.slice(n.lastIndexOf("/")+1),i=t.getAttribute("axisLabels").split(" ").map(f=>f.trim()).filter(f=>f.trim()!==""),r=S(t,"lowerCorner"),s=S(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].includes(i[0].toLowerCase()),u,l=parseInt(o,10),p=isNaN(l)?null:{wkid:l};u=new W(a?{xmin:r[0],ymin:r[1],xmax:s[0],ymax:s[1],spatialReference:p}:{xmin:r[1],ymin:r[0],xmax:s[1],ymax:s[0],spatialReference:p});let m={mins:r,maxs:s},c=t.getAttribute("uomLabels").trim().split(" "),d,g;if(R(t,"EnvelopeWithTimePeriod")){d=new Date(v(e,"beginPosition")||v(e,"BeginPosition")),g=new Date(v(e,"endPosition")||v(e,"EndPosition"));let f=c?.findIndex(h=>h?.toLowerCase()==="oledatetime");f>-1&&(c[f]="ISO8601")}return{envelope:u,axisLabels:i,uomLabels:c.length?c:null,envelopeAllDims:m,beginPosition:d,endPosition:g,isEastFirst:a}}function wt(e,t){let n=[],o=E(e,"DataRecord"),i=[],r,s=[];for(let a=0;a<o.length;a++){let u=E(o[a],"field"),l=[];for(let p=0;p<u.length;p++){let m=u[p].getAttribute("name"),c=v(u[p],"description")||"",d=C(u[p],"uom")?.getAttribute("code")||"",g=S(u[p],"interval"),f=ye(u[p],"nilValue")?.[0];t&&!m.toLowerCase().includes("band")||(i.push(m),g?.length&&(r=r||[],r.push({min:g[0],max:g[1],avg:-1,stddev:-1})),s.push(f)),l.push({name:m,description:c,uom:d,allowedValues:g,nilValue:f})}n.push(l)}return s.some(a=>a!=null)||(s=null),{rangeType:n,bandNames:i,bandStats:r,bandNoDataValues:s}}function xt(e){let t=1,n="",o=.01;return Math.abs(e-1/24)<1/24*o?n="Hours":Math.abs(e-1)<1*o?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-o&&e<31+o||Math.round(e/30)<12?n="Months":e>365-o&&e<366+o&&(n="Years"),{interval:t,intervalUnit:n}}function Ct(e,t,n){if(n.axisLabels.length<=2)return null;let o=[];for(let r=0;r<e.length;r++){let s=e[r];for(let a=0;a<s.length;a++)s[a].name.toLowerCase().includes("band")||o.push(s[a])}let i=[];if(o.length){let r=[];for(let s=2;s<n.axisLabels.length;s++){let a=t.uomLabels?.[s]?.trim()??"",u=n.axisLabels[s].toLowerCase().includes("time")||a.toLowerCase()==="iso8601"||a.toLowerCase()==="oledatetime",l,p;if(u){let c=xt(n.offset[s]);l=c.interval,p=c.intervalUnit}else l=n.offset[s],p=a;let m=[];u?(m.push(te(t.envelopeAllDims.mins[s])),m.push(te(t.envelopeAllDims.maxs[s]))):(m.push(t.envelopeAllDims.mins[s]),m.push(t.envelopeAllDims.maxs[s])),r.push({name:n.axisLabels[s].trim(),description:n.axisLabels[s].trim(),unit:u?"ISO8601":a,hasRegularIntervals:!0,extent:m,interval:l,intervalUnit:p})}if(o.forEach(s=>{let{allowedValues:a}=s,u=a?.length===2?[{min:a[0],max:a[1],avg:-1,stddev:-1}]:null;i.push({name:s.name.trim(),description:s.description?.trim()??"",unit:s.uom.trim(),statistics:u,dimensions:[...r]})}),i.length){let s={variables:i};return ve(s),s}}return null}function St(e,t){let n=C(e,"RectifiedGrid"),o=S(n,"low"),i=S(n,"high"),r=[];for(let h=0;h<o.length;h++)r.push(i[h]-o[h]+1);let s=v(n,"axisLabels").split(" "),a=S(n,"origin/pos"),u=E(n,"offsetVector"),l=[];for(let h=0;h<u.length;h++){let y=S(u[h]),b=y.findIndex(I=>I!==0);l[b]=y[b]}let p=["y","lat","latitude","north","nor","n","b"],m=!1;t?.length&&s?.length&&(m=[...t].sort((h,y)=>h<y?-1:1).join(",")===[...s].sort((h,y)=>h<y?-1:1).join(","));let c=m?s:t,d,g,f;return p.includes(c[0].toLowerCase())?(d=r[1],g=r[0],f={y:Math.abs(l[0]),x:Math.abs(l[1])}):(d=r[0],g=r[1],f={x:Math.abs(l[0]),y:Math.abs(l[1])}),{columns:d,rows:g,origin:a,offset:l,resolution:f,gridSamples:r,axisLabels:s,hasSameAxisLabelsAsBoundedBy:m}}function It(e){let t=C(e,"EarthObservation");if(!t)return null;let n=C(t,"phenomenonTime"),o=n?ce(n):null,i=C(t,"phenomenonTime"),r=i?ce(i):null,s=v(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList"),a=null;if(s){let u=s.split(" ").map(l=>l.trim()).filter(l=>l!=null&&l!=="").map(Number);if(u.length){let l=[];for(let p=0;p<u.length/2;p+=2)l.push(u[p],u[p+1]);a=new Ie({rings:[[l]]})}}return{observation:{phenomenonTime:o,resultTime:r,footprint:a,identifier:v(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:v(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:v(e,"metaDataProperty/EarthObservationMetaData/status")}}}function Tt(e){let t={version:"2.0"},n,o,i=[];for(let m=0;m<e.childNodes.length;m++){let c=e.childNodes[m];if(c.nodeType===1){if(R(c,"coverageId"))t.coverageId=v(c);else if(R(c,"ServiceParameters"))t.serviceParameters={supportedFormats:V(c,"nativeFormat")};else if(R(c,"boundedBy"))t.boundedBy=bt(c);else if(R(c,"rangeType")){let d=wt(c,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=d.rangeType,i=d.bandNames,n=d.bandStats;let{bandNoDataValues:g}=d;g?.length&&(o=be(g))}else if(R(c,"domainSet"))t.domainSet=St(c,t.boundedBy?.axisLabels);else if(R(c,"metadata")){let d=C(c,"EOMetadata");t.eoMetadata=d?It(d):null}}}let{coverageId:r,boundedBy:s,domainSet:a,rangeType:u,serviceParameters:l}=t,p=Ct(u,s,a);return!n&&p&&(n=p?.variables[0].statistics),p!=null&&(o=u[0][0].nilValue),{id:r,title:r,description:r,bandNames:i,rasterInfo:new re({width:a.columns,height:a.rows,pixelSize:a.resolution,pixelType:"unknown",extent:s.envelope,spatialReference:s.envelope.spatialReference,bandCount:i.length||1,statistics:n,noDataValue:o,multidimensionalInfo:p}),supportedFormats:l.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function Ke(e,t){let n=null;if(typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e,t==="1.0.0")return E(n,"CoverageOffering").map(i=>dt(i));let o=E(n,"CoverageDescription");return t==="1.1.0"||t==="1.1.1"||t==="1.1.2"?o.map(i=>yt(i,t)):o.map(i=>Tt(i))}function Xe(e,t){return k(this,null,function*(){let{version:n,customParameters:o,signal:i}=t??{},r=n?.startsWith("1.0")?"version":"acceptVersions",s=B({service:"WCS",request:"GetCapabilities",[r]:n},o);try{let{data:a}=yield oe(e,{query:s,responseType:"xml",signal:i});return t?.version||Ye(a)||(s[r]="2.0.1",{data:a}=yield oe(e,{query:s,responseType:"xml",signal:i})),Ze(a)}catch(a){throw fe(a)?a:new N("wcslayer:open","wcs capabilities is not valid or supported")}})}function ue(e,t){return k(this,null,function*(){let{coverageIds:n,version:o,customParameters:i,signal:r}=t,s=o.slice(0,3),a=s==="1.0"?"coverage":s==="1.1"?"identifiers":"coverageId",u=B({service:"WCS",request:"DescribeCoverage",version:o,[a]:n.join(",")},i);try{let{data:l}=yield oe(e,{query:u,responseType:"xml",signal:r});return Ke(l,o)}catch(l){throw fe(l)?l:new N("wcslayer:open","wcs coverage description is not valid or supported")}})}function et(e){let t=Lt(e);return t?{isMultipart:!0,data:t.boundary?Dt(e.data,t,0):null}:{isMultipart:!1,data:null}}function Dt(e,t,n=0){let o="--"+t.boundary,i=[];for(let h=0;h<o.length;h++)i.push(o.charCodeAt(h));let r=[],s=`
--`+t.boundary+"--";for(let h=0;h<s.length;h++)r.push(s.charCodeAt(h));let a=[10],u=[13,10],l=[],p=i.length,m=new Uint8Array(e,n),c=m.length-p,d=0,g=0;for(let h=0;h<c;h++){for(g=0;g<p&&m[h+g]===i[g];g++);if(g!==p)continue;let y=!1;if(d){let b=Qe(m.subarray(d,h),t);l.push(b),y=!!b.isValidImage}if(h+=p-1,m[h+1]===a[0]?h+=1:m[h+1]===u[0]&&m[h+2]===u[1]&&(h+=2),d=h+1,y)break}let f=r.length;for(let h=m.length-f-10;h<m.length-f;h++){for(g=0;g<f&&m[h+g]===r[g];g++);if(g===f){l.push(Qe(m.subarray(d,h),t));break}}return l}function Lt(e){let t=e.getHeader?.("Content-Type")?.split(";");if(!t||!(t[0].trim()??"").startsWith("multipart/"))return null;let n={boundary:"",start:"",type:""};for(let o=1;o<t.length;o++){let i=t[o].indexOf("=");if(i>0){let r=t[o].slice(0,i).trim(),s=t[o].slice(i+1).trim();n[r]=s.startsWith('"')?s.slice(1,-1):s}}return n}function Qe(e,t){let n=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split(`
`),o=Math.min(n.length,7),i={contentDisposition:"inline"},r=0;for(let s=0;s<o;s++)if(n[s].length<4)r=r+n[s].length+1;else if(n[s].slice(0,7).toLowerCase()==="content"){r=r+n[s].length+1;let a=n[s].indexOf(":");if(a===-1)continue;let u=n[s].slice(0,a).trim(),l=n[s].slice(a+1).trim();switch(u.toLowerCase()){case"content-type":i.contentType=l;break;case"content-description":i.contentDescription=l;break;case"content-transfer-encoding":i.contentTransferEncoding=l;break;case"content-id":i.contentID=l;break;case"content-disposition":i.contentDisposition=l;break;case"content-location":i.contentLocation=l}}else{if(i.contentDisposition.toLowerCase().includes("inline")&&n[s].length>=4&&i.contentType?.toLowerCase().indexOf("image")>-1){let a=!0,u=e.subarray(r,e.length);if(i.contentType.toLowerCase().indexOf("tif")>0){if(i.contentTransferEncoding==="base64"){let l="",p=u;for(let c=0;c<p.length;c+=65535){let d=p.subarray(c,c+65535>p.length-1?p.length-1:c+65535);l+=String.fromCharCode.apply(null,d)}let m=atob(l);u=new Uint8Array(m.length);for(let c=0;c<u.length;c++)u[c]=m.charCodeAt(c)}a=u[0]===73&&u[1]===73||u[0]===77&&u[1]===77}if(a){let l=u.buffer;i.contentTransferEncoding!=="base64"&&(l=new ArrayBuffer(e.length-r),u=new Uint8Array(l),u.set(e.subarray(r,e.length))),i.contentData=l,i.isValidImage=!0}break}if((t.start===""||i.contentID===t.start)&&i.contentType){if(i.contentType.includes("text")||i.contentType.includes("xml")){i.contentData=String.fromCharCode.apply(null,e.subarray(r,e.length));break}i.contentData=e.subarray(r,e.length)}}return i}var At=["nearest neighbor","bilinear","bicubic"],Et=["nearest","linear","cubic"],tt="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",Rt="response is not a supported multipart mediaType with inline tiff",Pt="response is base64 encoded which may impact layer display performance",Ot="server returns an exception",me=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]),Z=class extends We{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}fetchRawTile(i,r,s){return k(this,arguments,function*(e,t,n,o={}){if(this.isBlockOutside(e,t,n))return null;let{nativePixelSize:a,spatialReference:u}=this.rasterInfo,l=2**e,p=a.x*l,m=a.y*l,{blockWidth:c,blockHeight:d}=this.getBlockWidthHeight(e),{origin:g}=this.rasterInfo.storageInfo.tileInfo,f=this.getTileExtent({x:p,y:m},t,n,g,u,[c,d]),h=this.rasterInfo.extent,y=f.xmax>h.xmax,b=f.ymin<h.ymin,I=y||b,w=f,A=c,F=d;if(I&&(w=f.clone().intersection(h),w!=null&&(y&&(A=Math.floor((w.xmax-w.xmin)/p),w.xmax=w.xmin+p*A),b&&(F=Math.floor((w.ymax-w.ymin)/m),w.ymin=w.ymax-m*F))),w==null||A<=1||F<=1)return null;let M=yield this._getCoverage(w,A,F,l,o);if(!M)return null;let{coverageDescription:U}=this.coverageInfo,{noDataValue:H,multidimensionalInfo:K}=this.rasterInfo,{multidimensionalDefinition:z}=o,Y;if(K!=null&&z!=null&&z.length){let $=z[0].variableName;U.version==="2.0"?Y=U.rangeType[0].find(L=>L.name===$)?.nilValue:U.version==="1.1"&&(Y=U.range.find(L=>L.identifier===$)?.nullValues)}let J=Y??H,x=yield this.decodePixelBlock(M,{width:A,height:F,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(J)?J[0]:J,matchAllNoData:!0});if(x==null)return null;if(x&&(x.width!==A||x.height!==F))throw new N("wcsraster-fetch",`the response has unexpected dimension width: ${x.width}, height: {pixelBlock.height}`);return I?Be(x,{x:0,y:0},{width:d,height:d}):x})}_open(e){return k(this,null,function*(){let{customFetchParameters:t}=this.ioConfig,n=e?.signal,o=yield Xe(this.url,{version:t?.version??this.version,customParameters:t,signal:n});if(this.capabilities=o,!this.version){let c=o.version.slice(0,3);c==="2.0"||c==="1.1"||c==="1.0"?this.version=o.version:(c=o.supportedVersions.find(d=>d==="2.0.1")||o.supportedVersions.find(d=>d.slice(0,3)==="2.0")||o.supportedVersions.find(d=>d.slice(0,3)==="1.1")||o.supportedVersions.find(d=>d.slice(0,3)==="1.0")||"1.0.0",this.version=c)}let{version:i}=this;if(!me.has(i))throw new N("wcsraster-open",`unsupported WCS version ${i}`);let{gridCoverages:r}=o;if(!r.length)throw new N("wcsraster-open","cannot find rectified grid coverages");this.coverageId??=r[0].id;let{coverageId:s}=this,a=r.find(c=>c.id===s);if(a==null)throw new N("wcsraster-open",`the coverageId ${s} does not exist in capabilities`);let u=yield ue(this.url,{coverageIds:[s],version:i,customParameters:t,signal:n});if(this.coverageInfo=u[0],i.slice(0,3)==="2.0"){let{coverageInfo:c}=this;c.lonLatEnvelope=a.lonLatEnvelope,c.supportedInterpolations=pe(o.supportedInterpolations),this._patchDimensionValues201(s,n)}this.datasetName=this.coverageInfo.title;let{rasterInfo:l}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(l,512,512),this._set("rasterInfo",l),l.spatialReference==null)throw new N("wcsraster-open",`coverage without spatial reference is not supported: ${s}`);let{pixelType:p,bandCount:m}=yield this._getPixelTypeAndBandCount(n);l.pixelType=p,l.bandCount===1&&m>1&&(l.bandCount=m),this.updateTileInfo()})}_patchDimensionValues201(e,t){return k(this,null,function*(){let{coverageInfo:n}=this,o=n.rasterInfo.multidimensionalInfo?.variables,i=me.has("1.1.2")?"1.1.2":me.has("1.1.1")?"1.1.1":me.has("1.1.0")?"1.1.0":null,{customFetchParameters:r}=this.ioConfig;if(o&&i)try{let s=this.url.includes("/ImageServer/"),a=e.length>8&&e.startsWith("Coverage")&&s?e.slice(8):e,u=yield ue(this.url,{coverageIds:[a??e],version:i,customParameters:r,signal:t}).catch(()=>{if(a)return ue(this.url,{coverageIds:[e],version:i,customParameters:r,signal:t})}),l=u?.[0].rasterInfo.multidimensionalInfo?.variables;if(l)for(let p of o){let m=l.find(({name:c})=>c===p.name);if(m?.dimensions?.length)for(let c=p.dimensions.length-1;c>=0;c--){let d=p.dimensions[c],g=m.dimensions.find(({name:f})=>f===d.name);g?g.values&&g.extent?.join(",")===d.extent?.join(",")&&(p.dimensions[c]=ne(B({},d),{values:g.values})):s&&p.dimensions.splice(c,1)}}}catch{}})}_getPixelTypeAndBandCount(e){return k(this,null,function*(){let{pixelSize:t,extent:n,multidimensionalInfo:o}=this.rasterInfo,i=n.center,r=new W({xmin:i.x-t.x,xmax:i.x+t.x,ymin:i.y-t.y,ymax:i.y+t.y,spatialReference:n.spatialReference}),s=[];if(o!=null){let g=o.variables[0];s=[],g.dimensions.forEach(f=>{s.push(new Fe({variableName:g.name,dimensionName:f.name,values:f.hasRegularIntervals?f.extent?.[0]:f.values?.[0],isSlice:!0}))})}let{coverageDescription:a}=this.coverageInfo,u={interpolation:"nearest",multidimensionalDefinition:s,signal:e},{version:l}=a,{ioConfig:p}=this,m=l==="2.0"&&p.allowAnyMediaType==null||l==="1.1"&&p.use2GridOffsets==null,c;try{c=yield this._getCoverage(r,2,2,1,u,!0)}catch(g){if(!m)throw g;if(l==="1.1"){if(!g.details?.isResolutionMismatch)throw g;p.use2GridOffsets=!0}}if(!c&&m&&(l==="2.0"&&(p.allowAnyMediaType=!0),c=yield this._getCoverage(r,2,2,1,u),c&&ie.getLogger(this).warn("wcsraster:getcoverage",tt)),!c)throw new N("wcsraster-open","unable to determine pixel type");let d=yield this.decodePixelBlock(c,{width:2,height:2,planes:null,pixelType:null});if(d==null)throw new N("wcsraster-open","unable to determine pixel type");return{pixelType:d.pixelType,bandCount:d.getPlaneCount()??0}})}_getCoverage(e,t,n,o,i,r=!1){return k(this,null,function*(){let{coverageDescription:s}=this.coverageInfo,{version:a}=s,u=a==="2.0"?this._getCoverage201Parameters(e,t,n,o,i,s):a==="1.1"?this._getCoverage110Parameters(e,t,n,i,s):this._getCoverage100Parameters(e,t,n,i),l=a==="2.0"?yield this.request(this._constructWCS201Url(u),{signal:i.signal,responseType:"array-buffer"}):yield this.request(this.url,{query:u,signal:i.signal,responseType:"array-buffer"});if(a==="1.0")return l.data;if(a==="2.0"&&this.ioConfig.allowAnyMediaType!==!1&&je(l.data)==="tiff")return r&&(this.ioConfig.allowAnyMediaType=!0,ie.getLogger(this).warn("wcsraster:getcoverage",tt)),l.data;let p=et(l);if(p.isMultipart&&p.data){let g=p.data.find(f=>f.isValidImage);return r&&g?.contentTransferEncoding==="base64"&&ie.getLogger(this).warn("wcsraster:getcoverage",Pt),g?.contentData}let m=new Uint8Array(l.data,0,Math.min(l.data.byteLength,2e3)),c=String.fromCharCode.apply(null,m).toLowerCase().includes("exception"),d=c&&String.fromCharCode.apply(null,m).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");throw c?new N("wcsraster:getcoverage",Ot,{isResolutionMismatch:d}):new N("wcsraster:getcoverage",Rt)})}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?e==="nearest"?0:e==="bilinear"?1:e==="cubic"?2:0:0}_getCoverage100Parameters(e,t,n,o){let i=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,r=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find(g=>g.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:a,interpolation:u}=o,l=this._getInterpolationIndex(u),p=a?a.map(g=>this.coverageInfo.bandNames[g]):null,m=At[l],{multidimensionalDefinition:c}=o,d;if(c!=null&&this.rasterInfo.multidimensionalInfo!=null){let f=c.find(h=>h.dimensionName==="StdTime")?.values;f&&f.length>0&&(Array.isArray(f[0])&&(f=f[0]),d=f.map(h=>de(h)).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${r}`,bbox:i,width:t,height:n,time:d,interpolation:m,band:p?.join(",")}}_getCoverage110Parameters(e,t,n,o,i){let{multidimensionalDefinition:r,bandIds:s,interpolation:a}=o,u=e.spatialReference.wkid,l=`urn:ogc:def:crs:EPSG::${u}`,p=(this.coverageInfo.supportedFormats||[]).find(L=>L.toLowerCase().includes("tiff"))||"image/tiff",m=this._getInterpolationIndex(a),c=Et[m],d=a==null||this.coverageInfo.supportedInterpolations?.indexOf(a)===0,g=i.domain.spatialDomain,f=g.origin.x<=g.envelope.xmin&&g.origin.y<=g.envelope.ymin,h=e.width/t,y=e.height/n*(f?1:-1),b=f?[e.xmin,e.ymin]:[e.xmin,e.ymax],I=g.useEPSGAxis&&le(u),w=I?`${b[1]},${b[0]}`:`${b[0]},${b[1]}`,A=this.ioConfig.use2GridOffsets,F=I?A?`${y},${h}`:`${y},0,0,${h}`:A?`${h},${y}`:`${h},0,0,${y}`,M=h/2,U=e.xmin+M,H=e.xmax-M,K=Math.abs(y)/2,z=e.ymin+K,Y=e.ymax-K,J=I?`${z},${U},${Y},${H},${l}`:`${U},${z},${H},${Y},${l}`,x=i.range.find(L=>L.axis.some(_=>_.identifier.toLowerCase().includes("band"))),$,O=x&&c&&s?d?`${x.identifier}[${x.axis[0].identifier}[${s.join(",")}]]`:`${x.identifier}:${c}[${x.axis[0].identifier}[${s.join(",")}]]`:null;if(r!=null&&r.length)for(let L=0;L<r.length;L++){let _=r[L].values,G=r[L].dimensionName?.toLowerCase(),X=r[L].variableName?.toLowerCase(),j=i.range.find(q=>q.identifier.toLowerCase()===X);if(_.length>0){if(Array.isArray(_[0])&&(_=_[0]),G==="stdtime")$=_.map(q=>de(q)).join(",");else if(j){let q=j.axis.find(it=>it.identifier.toLowerCase()===G);q&&(O=d?j.identifier+"["+q.identifier+"["+_.join(",")+"]]":j.identifier+":"+c+"["+q.identifier+"["+_.join(",")+"]]")}}L===r.length-1&&j&&!O&&(O=d?j.identifier:j.identifier+":"+c)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:p,crs:`EPSG:${u}`,boundingbox:J,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:w,gridOffsets:F,gridBaseCRS:l,timeSequence:$,rangeSubset:O}}_getCoverage201Parameters(e,t,n,o,i,r){let{multidimensionalDefinition:s,interpolation:a}=i,u=this._getInterpolationIndex(a),l=null,{supportedInterpolations:p}=this.capabilities;if(p?.length)switch(u){case 0:l=p.find(x=>x.toLowerCase().includes("nearest"));break;case 1:l=p.find(x=>x.toLowerCase().includes("linear"));break;case 2:l=p.find(x=>x.toLowerCase().includes("cubic")||x.toLowerCase().includes("quadratic"))}let m=(this.coverageInfo.supportedFormats||[]).find(x=>x.toLowerCase().includes("tiff"))||"image/tiff",{bandNames:c}=this.coverageInfo,{boundedBy:d,domainSet:g,rangeType:f}=r,h=d.isEastFirst?0:1,y=1-h,{axisLabels:b}=d,I=b[h],w=b[y],A=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,F=A,M=[];M.push(`${I}(${e.xmin},${e.xmax})`),M.push(`${w}(${e.ymin},${e.ymax})`);let U=[];if(b.length>2)for(let x=2;x<b.length;x++){let $=g.origin[x];if(b[x].toLowerCase().includes("time")){let O=$.toString();d.uomLabels?.[x].toLowerCase().includes("ole")&&(U.push(b[x]),O=de($,!0)),M.push(b[x]+",http://www.opengis.net("+O+")")}else M.push(b[x]+",http://www.opengis.net("+$+")")}let H=null;if(s!=null&&s.length){let x=[];f.forEach(O=>O.forEach(L=>x.push(L.name)));let $=[];for(let O=0;O<s.length;O++){let L=b.find(G=>G===s[O].dimensionName),_=x.find(G=>G===s[O].variableName);if($.includes(_)||$.push(_),L){let G=s[O].values;if(G.length>0){Array.isArray(G[0])&&(G=G[0]);let X="";X=L.toLowerCase().includes("time")?G.map(q=>de(q)).join(","):G.join(",");let j=M.findIndex(q=>q.indexOf(L+",http://www.opengis.net")===0);j===-1&&M.push(L+",http://www.opengis.net("+X+")"),j===-1||M[j].includes("("+X+")")||M.splice(j,1,L+",http://www.opengis.net("+X+")")}}}$.length&&(H=$.join(","))}else c?.length>=2&&(H=(i.bandIds?i.bandIds.map(x=>c[x]):c).join(","));let K=M.join("&subset="),z=!r.domainSet.hasSameAxisLabelsAsBoundedBy&&this.ioConfig.allowScaleFactor!==!1,Y=z?null:`${I}(${t}),${w}(${n})`,J=z?1/o:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:H,interpolation:l,scaleSize:Y,scaleFactor:J,subset:K,format:m,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:A,subsettingcrs:F}}_constructWCS201Url(e){let t=B(B({},this.ioConfig.customFetchParameters),e),n=[];return Object.keys(t).forEach(o=>{let i=t[o];i!=null&&(o==="subset"?typeof i=="string"&&i.split("&subset=").forEach(r=>{r&&n.push(`subset=${encodeURIComponent(r)}`)}):n.push(`${o}=${encodeURIComponent(i)}`))}),`${encodeURI(this.url)}?${n.join("&")}`}};function de(e,t=!1){return(t?new Date(te(e)):new Date(e)).toISOString()}T([D({type:String,json:{write:!0}})],Z.prototype,"datasetFormat",void 0),T([D({readOnly:!0})],Z.prototype,"tileType",void 0),T([D({type:String,json:{write:!0}})],Z.prototype,"version",void 0),T([D({type:String,json:{write:!0}})],Z.prototype,"coverageId",void 0),T([D({readOnly:!0})],Z.prototype,"rasterId",null),Z=T([se("esri.layers.support.rasterDatasets.WCSRaster")],Z);var nt=Z;var Nt=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]),P=class extends De(Pe(Ee(Re(Me(qe($e(Ne(Te(Ce.ClonableMixin(Oe)))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=xe((t,n,o)=>k(this,null,function*(){let{save:i,saveAs:r}=yield import("./chunk-FKF4U6QM.js");switch(t){case ee.SAVE:return i(this,n);case ee.SAVE_AS:return r(this,o,n)}}))}normalizeCtorArgs(e,t){return typeof e=="string"?B({url:e},t):e}load(e){let t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(we).then(()=>this._openRaster(t))),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[Ge("Pixel Value")]}createPopupTemplate(e){return ke({fields:this.rasterFields,title:this.title},e)}save(e){return k(this,null,function*(){return this._debouncedSaveOperations(ee.SAVE,e)})}saveAs(e,t){return k(this,null,function*(){return this._debouncedSaveOperations(ee.SAVE_AS,t,e)})}_openRaster(e){return k(this,null,function*(){let t=new nt({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:ne(B({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters})});if(yield t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new N("wcs-layer:load","cannot load resources on "+this.url);let{rasterInfo:n}=t;n.noDataValue==null&&(n.noDataValue=this.noData),this._set("serviceRasterInfo",n),this._set("spatialReference",n.spatialReference),this.title==null&&this.setAtOrigin("title",t.datasetName,"service"),this.coverageId==null&&this.setAtOrigin("coverageId",t.coverageInfo.id,"service"),this.version==null&&t.version&&this.setAtOrigin("version",t.version,"service"),this.setAtOrigin("tileInfo",t.rasterInfo.storageInfo.tileInfo,"service");let{multidimensionalInfo:o}=n;if(o!=null){let i=o.variables[0].dimensions.find(({name:r})=>r==="StdTime");if(i){let r=i.extent?.[0]??i.values[0];Array.isArray(r)&&(r=r[0]);let s=i.extent?.[1]??i.values[i.values.length-1];Array.isArray(s)&&(s=s[1]);let a=Nt.has(i.intervalUnit?.toLowerCase())?i.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:r,end:s},timeZone:null,interval:a?{value:i.interval,unit:a}:null})}}this.raster=t,this._configDefaultSettings(),this.addHandles(Se(()=>this.customParameters,i=>this.raster.ioConfig.customFetchParameters=i))})}};T([D({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],P.prototype,"coverageId",void 0),T([D()],P.prototype,"coverageInfo",null),T([D({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],P.prototype,"version",void 0),T([D({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],P.prototype,"isReference",void 0),T([D({json:{read:!0,write:!0}})],P.prototype,"blendMode",void 0),T([D(Ae)],P.prototype,"legendEnabled",void 0),T([D({type:["show","hide"]})],P.prototype,"listMode",void 0),T([D()],P.prototype,"noData",void 0),T([D({type:["WCS"]})],P.prototype,"operationalLayerType",void 0),T([D()],P.prototype,"raster",void 0),T([D({readOnly:!0})],P.prototype,"type",void 0),T([D(Le)],P.prototype,"popupEnabled",void 0),T([D({type:Ve,json:{name:"popupInfo",write:!0}})],P.prototype,"popupTemplate",void 0),T([D({readOnly:!0})],P.prototype,"defaultPopupTemplate",null),T([D({readOnly:!0,type:[ge]})],P.prototype,"fields",void 0),T([D({readOnly:!0,type:[ge]})],P.prototype,"rasterFields",null),P=T([se("esri.layers.WCSLayer")],P);var Yn=P;export{Yn as default};
