import{d as O}from"./chunk-4KBVKETT.js";import{b as q}from"./chunk-EG4E2T2R.js";import{a as T}from"./chunk-J3BDQLVD.js";import{b as A}from"./chunk-BVXSAX5Q.js";import{a as I,e as b}from"./chunk-3SDSCSDJ.js";import{r as H}from"./chunk-IG66NQHW.js";import{L as N,d}from"./chunk-C7INQGWT.js";import{H as W}from"./chunk-WMHJC7XF.js";import{E as B,M as P,u as M,x as E}from"./chunk-D2LVMNOU.js";import{a as m}from"./chunk-QGVBCWUY.js";import{f as y}from"./chunk-VTHXE323.js";var k=Math.PI/180;function D(e){return e*k}function C(e,i){let a=D(i.rotation),t=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[o,n]=i.size;return e[0]=Math.round(n*s+o*t),e[1]=Math.round(n*t+o*s),e}function U(e,i,a,t){let[s,o]=i,[n,r]=t,l=.5*a;return e[0]=s-l*n,e[1]=o-l*r,e[2]=s+l*n,e[3]=o+l*r,e}var u=I(),c=[0,0],v=new T(0,0,0,0),S={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1},p=class extends N{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=S.hidpi,this.imageMaxWidth=S.imageMaxWidth,this.imageMaxHeight=S.imageMaxHeight,this.imageRotationSupported=S.imageRotationSupported,this.imageNormalizationSupported=S.imageNormalizationSupported,this.update=P((i,a)=>y(this,null,function*(){if(M(a),!i.stationary||this.destroyed)return;let t=i.state,s=H(t.spatialReference),o=this.hidpi?i.pixelRatio:1,n=t.worldScreenWidth>0,r=n&&this.imageNormalizationSupported&&t.worldScreenWidth<t.size[0],l=Math.round((this.imageMaxWidth??0)/o),f=Math.round((this.imageMaxHeight??0)/o);r?(c[0]=t.worldScreenWidth,c[1]=t.size[1]):this.imageRotationSupported?(c[0]=t.size[0],c[1]=t.size[1]):C(c,t);let w=Math.floor(c[0])>l||Math.floor(c[1])>f,_=s&&(t.extent.xmin<s.valid[0]||t.extent.xmax>s.valid[1]),R=!this.imageNormalizationSupported&&_,x=!w&&!R,V=this.imageRotationSupported?t.rotation:0,j=this.container.children.slice();if(x){let h=r?t.paddedViewState.center:t.center;this._imagePromise=this._singleExport(t,c,h,t.resolution,V,o,a)}else{let h=Math.min(l,f);n&&(h=Math.min(t.worldScreenWidth,h),h=Math.round(t.worldScreenWidth/Math.ceil(t.worldScreenWidth/h))),this._imagePromise=this._tiledExport(t,h,o,a)}try{let h=(yield this._imagePromise)??[];M(a);let z=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=h;for(let g of j)h.includes(g)||z.push(g.fadeOut().then(()=>{g.remove(),g.destroy()}));for(let g of h)z.push(g.fadeIn());yield Promise.all(z)}catch(h){this._imagePromise=null,E(h)}}),5e3),this.updateExports=P(i=>y(this,null,function*(){let a=[];for(let t of this.container.children){if(!t.visible||!t.stage)return;a.push(i(t).then(()=>{t.invalidateTexture(),t.requestRender()}))}this._imagePromise=B(a).then(()=>this._imagePromise=null),yield this._imagePromise}))}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&this._imagePromise!==null}_export(e,i,a,t,s,o){return y(this,null,function*(){let n=yield this.fetchSource(e,Math.floor(i*s),Math.floor(a*s),{rotation:t,pixelRatio:s,signal:o});M(o);let r=new O(null,!0);return r.x=e.xmin,r.y=e.ymax,r.resolution=e.width/i,r.rotation=t,r.pixelRatio=s,r.opacity=0,this.container.addChild(r),yield r.setSourceAsync(n,o),M(o),r})}_singleExport(e,i,a,t,s,o,n){return y(this,null,function*(){U(u,a,t,i);let r=b(u,e.spatialReference);return[yield this._export(r,i[0],i[1],s,o,n)]})}_tiledExport(e,i,a,t){let s=A.create({size:i,spatialReference:e.spatialReference,scales:[e.scale]}),o=new q(s),n=o.getTileCoverage(e);if(!n)return null;let r=[];return n.forEach((l,f,w,_)=>{v.set(l,f,w,0),o.getTileBounds(u,v);let R=b(u,e.spatialReference);r.push(this._export(R,i,i,0,a,t).then(x=>(_!==0&&(v.set(l,f,w,_),o.getTileBounds(u,v),x.x=u[0],x.y=u[3]),x)))}),Promise.all(r)}};m([d()],p.prototype,"_imagePromise",void 0),m([d()],p.prototype,"bitmaps",void 0),m([d()],p.prototype,"container",void 0),m([d()],p.prototype,"fetchSource",void 0),m([d()],p.prototype,"hidpi",void 0),m([d()],p.prototype,"imageMaxWidth",void 0),m([d()],p.prototype,"imageMaxHeight",void 0),m([d()],p.prototype,"imageRotationSupported",void 0),m([d()],p.prototype,"imageNormalizationSupported",void 0),m([d()],p.prototype,"requestUpdate",void 0),m([d()],p.prototype,"updating",null),p=m([W("esri.views.2d.layers.support.ExportStrategy")],p);var st=p;export{st as a};
