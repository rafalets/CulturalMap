import{a as D,b as C}from"./chunk-EWGQ3XHW.js";import{a as U}from"./chunk-2DUCS3UE.js";import{a as k}from"./chunk-UILAW2FP.js";import{a as M}from"./chunk-TVHRLNTK.js";import{a as j}from"./chunk-HVKMTRIC.js";import{c as F}from"./chunk-AZS4Q4RE.js";import{a as P}from"./chunk-QEBUS3TL.js";import{a as K}from"./chunk-WMQNRNIU.js";import{a as J}from"./chunk-EIPVFA6F.js";import{c as T}from"./chunk-ZTJLFKGG.js";import{b as w}from"./chunk-EKMHQEJY.js";import{a as N}from"./chunk-7R33MKVL.js";import{F as x}from"./chunk-E57FTRWF.js";import{H as _,h as S}from"./chunk-U4J5SECU.js";import{f as A}from"./chunk-7EG726PT.js";import{L as B,d as i}from"./chunk-C7INQGWT.js";import{H as b}from"./chunk-WMHJC7XF.js";import{i as $,u as v}from"./chunk-D2LVMNOU.js";import{a as o}from"./chunk-QGVBCWUY.js";import{b as R,d as L,r as I}from"./chunk-HHDFN2GK.js";import{a as h,b as g,f as d}from"./chunk-VTHXE323.js";var c=class extends B{constructor(e){super(e),this.apiKey=null,this.id=null,this.language=null,this.places=null,this.serviceUrl="https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2",this.worldview=null}get languageParameter(){let e=this.language,t=e==="local"||e==="global"?e:T(e??N())??"global";return t=t==="no"?"nb":t,t}};o([i()],c.prototype,"apiKey",void 0),o([i()],c.prototype,"id",void 0),o([i()],c.prototype,"language",void 0),o([i()],c.prototype,"places",void 0),o([i()],c.prototype,"serviceUrl",void 0),o([i()],c.prototype,"worldview",void 0),c=o([b("esri.support.BasemapStyle")],c);var q=c;var u,E=0,n=u=class extends A.JSONSupportMixin(P){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.style=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+E++,this.baseLayers=new w,this.referenceLayers=new w;let t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type==="elevation"&&I.getLogger(this).error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a basemap layer and will therefore be ignored.`)},s=r=>{r.parent=null};this.addHandles([this.baseLayers.on("after-add",r=>t(r.item)),this.referenceLayers.on("after-add",r=>t(r.item)),this.baseLayers.on("after-remove",r=>s(r.item)),this.referenceLayers.on("after-remove",r=>s(r.item))])}initialize(){this.when().catch(e=>{I.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){let e=this.baseLayers.toArray();for(let s of e)s.destroy();let t=this.referenceLayers.toArray();for(let s of t)s.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem=$(this.portalItem)}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=h({},e)).resourceInfo),e}set baseLayers(e){this._set("baseLayers",M(e,this._get("baseLayers")))}_writeBaseLayers(e,t,s){let r=[];e&&(s=g(h({},s),{layerContainerType:"basemap"}),this.baseLayers.forEach(a=>{let l=U(a,s.webmap?s.webmap.getLayerJSONFromResourceInfo(a):null,s);l!=null&&r.push(l)}),this.referenceLayers.forEach(a=>{let l=U(a,s.webmap?s.webmap.getLayerJSONFromResourceInfo(a):null,s);l!=null&&(a.type!=="scene"&&(l.isReference=!0),r.push(l))})),t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",M(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return k(this,e=>{e(this.baseLayers,this.referenceLayers)})}clone(){let e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map(t=>L(t)?t.clone():t),referenceLayers:this.referenceLayers.map(t=>L(t)?t.clone():t)};return this.loaded&&(e.loadStatus="loaded"),new u({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t?.origin||(t=h({origin:"web-map"},t)),super.write(e,t),!this.loaded&&this.resourceInfo?.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(s=>{let r=R(s);return r.url&&_(r.url)&&(r.url=`https:${r.url}`),r.templateUrl&&_(r.templateUrl)&&(r.templateUrl=`https:${r.templateUrl}`),r})),e}_loadFromSource(e){return d(this,null,function*(){let{resourceInfo:t,portalItem:s,style:r}=this;v(e);let a=[];if(t){let l=t.context?t.context.url:null;if(a.push(this._loadLayersFromJSON(t.data,l,e)),t.data.id&&!t.data.title){let m=t.data.id;a.push(D(m).then(p=>{p&&this.read({title:p},t.context)}))}}else s?a.push(this._loadFromItem(s,e)):r&&a.push(this._loadFromStylesService(r,e));yield Promise.all(a)})}_loadLayersFromJSON(e,t,s){return d(this,null,function*(){let r=this.resourceInfo?.context,a=this.portalItem?.portal||r?.portal||null,l=H[r?.origin||""]??"web-map",{populateOperationalLayers:m}=yield import("./chunk-ZASVD3VT.js"),p=[];if(v(s),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){let y={context:g(h({},r),{origin:l,url:t,portal:a,layerContainerType:"basemap"}),defaultLayerType:"DefaultTileLayer"},O=f=>l==="web-scene"&&f.layerType==="ArcGISSceneServiceLayer"||f.isReference,z=m(this.baseLayers,e.baseMapLayers.filter(f=>!O(f)),y);p.push(z);let W=m(this.referenceLayers,e.baseMapLayers.filter(O),y);p.push(W)}yield Promise.allSettled(p)})}_loadFromItem(e,t){return d(this,null,function*(){let s=yield e.load(t),r=yield s.fetchData("json",t),a=S(e.itemUrl??"");return this._set("resourceInfo",{data:r.baseMap??{},context:{origin:G[e.type||""]??"web-map",portal:e.portal||F.getDefault(),url:a}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||F.getDefault(),url:a}),this._loadLayersFromJSON(this.resourceInfo.data,a,t)})}_loadFromStylesService(e,t){return d(this,null,function*(){let s=e.serviceUrl.endsWith("/webmaps")?e.serviceUrl.slice(0,-8):e.serviceUrl,r=`${s}/styles/${e.id}/self`,a=`${s}/webmaps/${e.id}`,[l,m]=yield Promise.all([(yield x(r,{query:{token:e.apiKey},signal:t?.signal})).data,(yield x(a,{query:{language:e.languageParameter,places:e.places,worldview:e.worldview,token:e.apiKey},signal:t?.signal})).data]);this.thumbnailUrl??=l.thumbnailUrl;let p=S(a);if(this._set("resourceInfo",{data:m.baseMap??{},context:{origin:"web-map",url:p}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:m.spatialReference},this.resourceInfo.context),yield this._loadLayersFromJSON(this.resourceInfo.data,p,t),e.apiKey)for(let y of[...this.baseLayers,...this.referenceLayers])"apiKey"in y&&(y.apiKey=e.apiKey)})}static fromId(e){let t=C[e];return t?t.itemId?new u({portalItem:{id:t.itemId,portal:{url:"https://www.arcgis.com"}}}):u.fromJSON(t,{origin:t.is3d?"web-scene":"web-map"}):null}};o([i({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,s,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:w}},writer(e,t,s,r){this._writeBaseLayers(e,t,r)}}}}}})],n.prototype,"baseLayers",null),o([i({type:String,json:{origins:{"web-scene":{write:!0}}}})],n.prototype,"id",void 0),o([i({type:j})],n.prototype,"portalItem",void 0),o([i()],n.prototype,"referenceLayers",null),o([i({readOnly:!0})],n.prototype,"resourceInfo",void 0),o([i({type:K})],n.prototype,"spatialReference",void 0),o([i({type:q})],n.prototype,"style",void 0),o([i()],n.prototype,"thumbnailUrl",void 0),o([i({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],n.prototype,"title",void 0),o([J("title")],n.prototype,"writeTitle",null),n=u=o([b("esri.Basemap")],n);var G={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},H={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"},Oe=n;export{Oe as a};
