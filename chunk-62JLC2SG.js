import{$ as T,Y as g}from"./chunk-HKHTIKVW.js";import{b as x}from"./chunk-IJBTA53P.js";import{b as y}from"./chunk-EKMHQEJY.js";import{e as m}from"./chunk-JKNCWG7E.js";import{L as h,d as o}from"./chunk-C7INQGWT.js";import{H as f}from"./chunk-WMHJC7XF.js";import{a}from"./chunk-QGVBCWUY.js";import{a as d,f as u}from"./chunk-VTHXE323.js";var I="relationships/",F="expression/",r=class extends h{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){return this.expressionsUsedInTitle.length>0?this._get("_arcadeTask")||m(()=>x()):null}get featureUtilsPromise(){return this._get("featureUtilsPromise")??import("./chunk-RSQSY6J2.js").then(e=>this._featureUtils=e)}get calculatedExpressions(){let e=new y;if(!this.expressionsUsedInTitle.length)return e;if(!this._arcadeTask?.value){for(let t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(let t of this.expressionsUsedInTitle)try{let s=this._arcadeTask.value.arcade.parseScript(t.expression,["$layer","$map","$datastore"]);if(s.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:s,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(s,{vars:{$feature:"any"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){let e=this.effectivePopupTemplate?.title??"";return typeof e!="string"?[]:(e=e.toLowerCase(),this.effectivePopupTemplate?.expressionInfos?.filter(t=>e.includes(`{expression/${t.name.toLowerCase()}}`))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>e.invalid===!0)}get requiredFields(){let e=new Set;if(this._arcadeTask?.value&&!this.hasBadExpressions)for(let s of this.calculatedExpressions?.toArray()??[])try{let i=this._arcadeTask.value.arcade.extractFieldLiterals(s.syntax);for(let n of i){let p=n.split("."),l=this.fieldsIndex.get(p.at(-1)??"");l&&e.add(l.name)}}catch{}let t=this._extractFieldNames(this.workingTitle);for(let s of t){let i=this.fieldsIndex.get(s);i&&e.add(i.name)}return e}get titleFromDisplayField(){let e="";return this.displayField&&(e=this.fieldsIndex.get(this.displayField)?.name??""),e||(e=this.fieldsIndex.get(this.objectIdField)?.name??""),e?`{${e}}`:""}get workingTitle(){let e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:"";return e===""||e==null||this.hasBadExpressions||typeof e!="string"?this.titleFromDisplayField:e}getTitle(e,t,s){return u(this,null,function*(){try{let{attributes:i}=t,n=s?.timeZone??"system",[{substituteFieldsInLinksAndAttributes:p}]=yield Promise.all([this.featureUtilsPromise,this._arcadeTask?.promise]);if(s.fetchMissingFields&&(t=yield this._checkAndReQueryGraphic(e,t)),this.workingTitle&&this.fieldInfoMap){let l=this._createFormattedAttributes(e,t,n).global;return p({attributes:i,expressionAttributes:null,fieldInfoMap:this.fieldInfoMap,globalAttributes:l,layer:e,text:this.workingTitle})}return""}catch{}return""})}_checkAndReQueryGraphic(e,t){return u(this,null,function*(){let s=t.getObjectId();if(s==null)return t;if(!g(this.requiredFields,t)){let i=e.createQuery();i.where="1=1",i.outFields=[...this.requiredFields],i.objectIds=[s];let n=yield e.queryFeatures(i);if(n?.features.length===1)return n.features[0]}return t})}_createFieldInfoMap(e){let t=new Map;if(!e)return t;for(let s of e){if(!s.fieldName)continue;let i=this.fieldsIndex.get(s.fieldName),n=i?.name??s.fieldName;s.fieldName=n,t.set(n.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s="system"){let i=this.effectivePopupTemplate?.fieldInfos??[],n={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&this._arcadeTask?.value){let l=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(let c of this.calculatedExpressions)try{n[`expression/${c.name}`]=c.func({vars:{$feature:l}})}catch{}}let p=d(d({},t.attributes),n);return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:p,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return T(e).filter(t=>!(t.indexOf(I)===0||t.indexOf(F)===0))}};a([o({readOnly:!0})],r.prototype,"_arcadeTask",null),a([o()],r.prototype,"_featureUtils",void 0),a([o({readOnly:!0})],r.prototype,"featureUtilsPromise",null),a([o({readOnly:!0})],r.prototype,"calculatedExpressions",null),a([o()],r.prototype,"displayField",void 0),a([o()],r.prototype,"effectivePopupTemplate",void 0),a([o()],r.prototype,"expressionsUsedInTitle",null),a([o()],r.prototype,"fieldsIndex",void 0),a([o()],r.prototype,"fieldInfoMap",null),a([o()],r.prototype,"fields",void 0),a([o()],r.prototype,"objectIdField",void 0),a([o()],r.prototype,"requiredFields",null),r=a([f("esri.layers.support.TitleCreator")],r);var O=r;export{O as a};
