import{a as h,b as g,c as o,g as H}from"./chunk-LB5YQINJ.js";import{L as u,d as p}from"./chunk-C7INQGWT.js";import{H as m}from"./chunk-WMHJC7XF.js";import{b as _}from"./chunk-NJEWDTYF.js";import{a as i}from"./chunk-D2LVMNOU.js";import{a as l}from"./chunk-QGVBCWUY.js";var c=class extends u{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll()}add(e,t,s={}){return this._installWatch(e,t,s,h)}addWhen(e,t,s={}){return this._installWatch(e,t,s,g)}addOnCollectionChange(e,t,{initial:s=!1,final:n=!1}={}){let a=++this._handleId;return this.addHandles([o(e,"after-changes",this._createSyncUpdatingCallback(),H),o(e,"change",t,{onListenerAdd:s?d=>t({added:d.toArray(),removed:[]}):void 0,onListenerRemove:n?d=>t({added:[],removed:d.toArray()}):void 0})],a),i(()=>this.removeHandles(a))}addPromise(e){if(e==null)return e;let t=++this._handleId;this.addHandles(i(()=>{this._pendingPromises.delete(e)&&(this._pendingPromises.size!==0||this.hasHandles(r)||this._set("updating",!1))}),t),this._pendingPromises.add(e),this._set("updating",!0);let s=()=>this.removeHandles(t);return e.then(s,s),e}removeAll(){this._pendingPromises.clear(),this.removeAllHandles(),this._set("updating",!1)}_installWatch(e,t,s={},n){let a=++this._handleId;s.sync||this._installSyncUpdatingWatch(e,a);let d=n(e,t,s);return this.addHandles(d,a),i(()=>this.removeHandles(a))}_installSyncUpdatingWatch(e,t){let s=this._createSyncUpdatingCallback(),n=h(e,s,{sync:!0,equals:()=>!1});return this.addHandles(n,t),n}_createSyncUpdatingCallback(){return()=>{this.removeHandles(r),++this._scheduleHandleId;let e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this.addHandles(_(()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this.removeHandles(r))}),r)}}};l([p({readOnly:!0})],c.prototype,"updating",void 0),c=l([m("esri.core.support.UpdatingHandles")],c);var r=-42;export{c as a};
