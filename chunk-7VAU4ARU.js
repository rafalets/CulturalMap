import{a as ue}from"./chunk-HPI2P3AR.js";import{a as he}from"./chunk-7RNNFL2D.js";import"./chunk-W2RZ3RCQ.js";import{b as de}from"./chunk-2ZJT7DIL.js";import{a as ce}from"./chunk-S5AJRU4D.js";import"./chunk-DBKQFUY4.js";import"./chunk-NQFVVK5O.js";import"./chunk-ESGUJXGX.js";import"./chunk-X6GMII6M.js";import"./chunk-KQSP6CH6.js";import"./chunk-423EPWZ2.js";import{a as le}from"./chunk-MPSCABVQ.js";import"./chunk-RME3N3WY.js";import"./chunk-VZWPFXBV.js";import"./chunk-BYXBJQAS.js";import"./chunk-TTCWVZMG.js";import"./chunk-LVSL2E7G.js";import"./chunk-7VDGAO6V.js";import"./chunk-RW7NPOAD.js";import"./chunk-KZUZOO74.js";import"./chunk-WSIRBPY7.js";import"./chunk-BKA6DT3N.js";import"./chunk-WH5SLVE3.js";import"./chunk-ET5YWLZA.js";import"./chunk-WQQ6B254.js";import"./chunk-RVXFHI3X.js";import"./chunk-JXEAVWUK.js";import"./chunk-Y6FO2W3O.js";import"./chunk-X5QMXU27.js";import"./chunk-T3DGHEVR.js";import"./chunk-ZOOQQO74.js";import"./chunk-XAHD7XBV.js";import"./chunk-7NH66LUL.js";import"./chunk-G6C3YEMS.js";import"./chunk-R3ABULTC.js";import"./chunk-AKKUUEQK.js";import"./chunk-JLWYDAJB.js";import"./chunk-R2FEHFRM.js";import"./chunk-W5OI4BJ2.js";import{b as ne,e as ae,g as I}from"./chunk-JSS5IJOM.js";import"./chunk-YFINME5F.js";import"./chunk-7LF5QJDR.js";import"./chunk-FZ5X7HOK.js";import"./chunk-DHLVTH5U.js";import"./chunk-GK3RYCKG.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-3ZANJLLA.js";import"./chunk-PLIWVXAW.js";import"./chunk-7QY3BMVN.js";import"./chunk-WPDP647R.js";import"./chunk-4E4FE2IX.js";import"./chunk-5SSISWTF.js";import"./chunk-O4PKXMAM.js";import"./chunk-ONYJLWAD.js";import"./chunk-HBZAOVHW.js";import"./chunk-FYZRIMPP.js";import"./chunk-CKG2WYMF.js";import"./chunk-BA3KT2MW.js";import"./chunk-SP2CO3KX.js";import"./chunk-3V2UIH2D.js";import"./chunk-NKCIC566.js";import"./chunk-7LVUNMSI.js";import"./chunk-4H6RA546.js";import"./chunk-5K5ZHVX6.js";import"./chunk-SNPAQLOL.js";import"./chunk-SNL6C5QO.js";import"./chunk-7HLFOT25.js";import"./chunk-67ZC4UJG.js";import"./chunk-TZ5TEUYV.js";import"./chunk-WBPLJNRU.js";import"./chunk-R3KYOH5H.js";import{a as me,b as pe}from"./chunk-FTQ4RHIU.js";import"./chunk-EG4E2T2R.js";import"./chunk-3QCWBHPT.js";import"./chunk-4D3QHJI2.js";import"./chunk-E2J2V7JN.js";import"./chunk-7X55A7Q6.js";import"./chunk-HUWVQAJL.js";import"./chunk-J3BDQLVD.js";import"./chunk-X7BNFUFQ.js";import{e as oe}from"./chunk-NFWLUI2Z.js";import"./chunk-WRYEUJBQ.js";import"./chunk-DQOFEB5P.js";import"./chunk-37H4LYIE.js";import{i as se,k as G}from"./chunk-BUZBVNOM.js";import"./chunk-VYZHOYXV.js";import"./chunk-ICWXUNPZ.js";import"./chunk-EXXSZWI5.js";import"./chunk-XGP6WN73.js";import"./chunk-EBK2L6ZQ.js";import"./chunk-6T37AWU6.js";import"./chunk-XC4BCVYU.js";import"./chunk-XD6QSICT.js";import"./chunk-FTOLVNUN.js";import"./chunk-EOLWCIYR.js";import"./chunk-YOMR2DCD.js";import"./chunk-AFSNSPOG.js";import"./chunk-4AIH3WFI.js";import{l as re}from"./chunk-HM5RIVQC.js";import{a as te}from"./chunk-2FO7ARYZ.js";import"./chunk-DJW5LMRG.js";import{b as ie}from"./chunk-QXXXCEV5.js";import{a as ee}from"./chunk-7C6Z24SS.js";import"./chunk-5WKDXHVH.js";import"./chunk-SU5S5XU7.js";import"./chunk-B5LBE5HD.js";import"./chunk-F6A6XWW4.js";import"./chunk-AESEF3B2.js";import"./chunk-74LTYPBC.js";import"./chunk-3BDL2KTL.js";import"./chunk-TGPGCQ44.js";import"./chunk-PWU2QHPV.js";import"./chunk-WUJRCGDY.js";import"./chunk-QPGCDGIN.js";import"./chunk-JH4RD366.js";import"./chunk-7Y6S2GNA.js";import"./chunk-VOB6IBIW.js";import{h as M}from"./chunk-63B3IOWG.js";import"./chunk-PTZYZULI.js";import"./chunk-KZKWOEFD.js";import"./chunk-LNVVFNTC.js";import"./chunk-QJADLTFR.js";import"./chunk-YQPWWSMJ.js";import"./chunk-JEIB6WNP.js";import"./chunk-6JJCXUHW.js";import"./chunk-CVRJ6GOM.js";import"./chunk-X7QUUHRV.js";import"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-VT67LWCR.js";import"./chunk-K27GONOJ.js";import"./chunk-6KRFVLII.js";import"./chunk-JR22Z7I2.js";import"./chunk-3QNSJ5HY.js";import"./chunk-UNVICPIE.js";import"./chunk-BGICKEJR.js";import"./chunk-TRZXSDYA.js";import"./chunk-OGS2SUK5.js";import"./chunk-TVHRLNTK.js";import"./chunk-JA3EMS2I.js";import"./chunk-HKHTIKVW.js";import"./chunk-XFESK2YB.js";import"./chunk-IJBTA53P.js";import"./chunk-ZHUXSQTN.js";import"./chunk-YLZWDFCJ.js";import"./chunk-TLMADEUL.js";import"./chunk-WNSGKHQ6.js";import"./chunk-J5MXC6AL.js";import"./chunk-OLOKUDVI.js";import"./chunk-RJWOVI3M.js";import"./chunk-R6GE4XRP.js";import"./chunk-MDL4XPLR.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import"./chunk-NHSDW26F.js";import"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import"./chunk-WAGBL553.js";import"./chunk-WKJJQIBC.js";import"./chunk-VDADRLEF.js";import"./chunk-X5AA4JDN.js";import"./chunk-J372WZPB.js";import"./chunk-6XFS4U2F.js";import"./chunk-XPRVY6JT.js";import"./chunk-7N3ZKWML.js";import"./chunk-E62WHYYG.js";import"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import{a as $}from"./chunk-3SDSCSDJ.js";import{d as X,f as Y,j as Z}from"./chunk-I4M2OT5W.js";import"./chunk-NTVLK3P2.js";import"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-6PN3I333.js";import"./chunk-5TW726OD.js";import"./chunk-VGD3XLDH.js";import{a as d,b as K,c as P,h as v,i as C}from"./chunk-LB5YQINJ.js";import{b as J}from"./chunk-EKMHQEJY.js";import"./chunk-VACZNAP3.js";import"./chunk-JKNCWG7E.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7IPIJKWU.js";import"./chunk-7R33MKVL.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import{L,d as m,n as B}from"./chunk-C7INQGWT.js";import{H as c,c as j}from"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{C as N,j as O,r as w}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import{a as n}from"./chunk-QGVBCWUY.js";import{r as _,t as S}from"./chunk-HHDFN2GK.js";import"./chunk-47GHT6OF.js";import{a as W,b as Q,f as y}from"./chunk-VTHXE323.js";var fe=[1,1],g=ee(),ge={none:M.None,loop:M.Loop,oscillate:M.Oscillate};function xe(e){return e?Q(W({type:"CIMAnimatedSymbolProperties"},e),{playAnimation:e.playing,repeatType:e.repeatType?ge[e.repeatType]:void 0}):{type:"CIMAnimatedSymbolProperties"}}var A=class extends le{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=te(),this._handles=new B,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([d(()=>this.elementView.element.opacity,i=>this.opacity=i,v),d(()=>[this.elementView.coords],()=>{this.requestRender()},v),d(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._handles.remove("play"),this.texture=O(this.texture),this.requestRender()},v),K(()=>this.elementView.element.loaded,()=>{let i=this.elementView.element;this.ready(),ae(i)&&i.content!=null&&(this._handles.add([w(i.content,"play",()=>this.requestRender()),w(i.content,"loadeddata",()=>this.requestRender()),w(i.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in i.content?i.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([w(i.content,"seeked",()=>this.requestRender())]),this.requestRender())},v)]),t.element.load().catch(i=>{_.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new S("element-load-error","Element cannot be displayed",{element:t,error:i}))})}getMesh(t){throw new Error("Method not implemented.")}destroy(){this._handles.destroy(),this.texture=O(this.texture)}get textureSize(){return fe}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){let{context:i}=t,r=this.elementView.element.content;if(r!=null){let o=r instanceof HTMLImageElement,a=r instanceof HTMLVideoElement,s=o?r.naturalWidth:a?r.videoWidth:r.width,h=o?r.naturalHeight:a?r.videoHeight:r.height;if(this._updatePerspectiveTransform(s,h),this.texture)a&&(this.texture.setData(r),this.texture.generateMipmap(),"requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender());else{let l=new se;if(l.wrapMode=re.CLAMP_TO_EDGE,l.preMultiplyAlpha=!0,l.width=s,l.height=h,"getFrame"in r){let V=f=>{this.texture?this.texture.setData(f):this.texture=new G(i,l,f),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(he(r,xe(this.elementView.element.animationOptions),null,V),"play")}else this.texture=new G(i,l,r);this.texture.generateMipmap(),a&&("requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender())}}super.beforeRender(t)}_createTransforms(){return null}draw(t,i){this.isReady&&this.texture!=null?i.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:fe,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(t,i,r,o){let{coords:a,bounds:s}=this.elementView;if(a==null||s==null)return;let[h,l,V,f]=a.rings[0],we=this._vertices,{x:T,y:b}=t;we.set([l[0]-T,l[1]-b,h[0]-T,h[1]-b,V[0]-T,V[1]-b,f[0]-T,f[1]-b]);let q=i;if(o){let[H,,U]=s,{worldWidth:D,xBounds:ve}=o,[z,F]=ve;H<z&&U>z?q=D:U>F&&H<F&&(q=-D)}this.wrapAroundShift=q,this.isWrapAround=q!==0}_updatePerspectiveTransform(t,i){let r=this._vertices;ne(g,[0,0,t,0,0,i,t,i],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),ie(this.perspectiveTransform,g[6]/g[8]*t,g[7]/g[8]*i)}};var x=class extends L{constructor(e){super(e),this.editSourcePoints=!1}};n([m()],x.prototype,"editSourcePoints",void 0),x=n([c("esri.views.3d.layers.support.MediaLayerInteractionOptions.ReshapeOptions")],x);var u=class extends L{constructor(e){super(e),this.tool="transform",this.reshapeOptions=new x}};n([m()],u.prototype,"tool",void 0),n([m({type:x})],u.prototype,"reshapeOptions",void 0),u=n([c("esri.views.3d.layers.support.MediaLayerInteractionOptions")],u);var ye=e=>{let t=class extends e{constructor(...i){super(...i),this.layer=null,this.interactive=!1,this.interactionOptions=new u,this.selectedElement=null}highlight(i,r){throw new Error("missing implementation")}};return n([m()],t.prototype,"layer",void 0),n([m()],t.prototype,"interactive",void 0),n([m({type:u})],t.prototype,"interactionOptions",void 0),n([m()],t.prototype,"selectedElement",void 0),t=n([c("esri.views.layers.MediaLayerView")],t),t};var R=class extends de(ye(ce)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new J}initialize(){this.addHandles([d(()=>[this.interactive,this.suspended],()=>y(this,null,function*(){if(this.interactive&&!this._interaction){let{MediaLayerInteraction:e}=yield import("./chunk-COSJBIPK.js");this._interaction=new e({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)}),C),d(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},C),d(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},C)])}attach(){this.addAttachHandles([P(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),P(()=>this.layer.effectiveSource,"change",({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new ue,this.container.addChild(this._overlayContainer),this._fetchQueue=new me({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:oe.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new pe({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}hitTest(e,t){return y(this,null,function*(){let i=[],r=e.normalize(),o=[r.x,r.y];for(let{elementView:{normalizedCoords:a,element:s}}of this._elementReferences.values())a!=null&&X(a.rings,o)&&i.push({type:"media",element:s,layer:this.layer,mapPoint:e,sourcePoint:s.toSource(e)});return i.reverse()})}canResume(){return this.layer.source!=null&&super.canResume()}doRefresh(){return y(this,null,function*(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))})}_acquireTile(e){let t=new k(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{let[i,r]=e.setElements(t);this._referenceElements(e,i),this._dereferenceElements(e,r),this.requestUpdate()},t=>{N(t)||_.getLogger(this).error(t)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}_queryElements(e,t){return y(this,null,function*(){let i=this.layer.effectiveSource;if(i==null)return[];this.view.featuresTilingScheme.getTileBounds(p,e,!0);let r=new Z({xmin:p[0],ymin:p[1],xmax:p[2],ymax:p[3],spatialReference:this.view.spatialReference});return i.queryElements(r,t)})}_referenceElements(e,t){if(this.layer.source!=null)for(let i of t)this._referenceElement(e,i)}_referenceElement(e,t){j(this._elementReferences,t.uid,()=>{let i=new I({element:t,spatialReference:this.view.spatialReference}),r=new A(i);return this._overlayContainer.addChild(r),this.elements.add(t),this._updatingHandles.addPromise(t.load().catch(o=>{_.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new S("element-load-error","Element cannot be displayed",{element:t,error:o}))})),{debugGraphic:null,elementView:i,overlay:r,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(let i of t)this._dereferenceElement(e,i)}_dereferenceElement(e,t){let i=this._elementReferences.get(t.uid);i.tiles.delete(e),i.tiles.size||(this._overlayContainer.removeChild(i.overlay),i.overlay.destroy(),i.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(i.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){let r=t.elementView.normalizedCoords;if(r==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);let o=[],a=[];for(let s of this._tileStrategy.tiles){let h=_e(this.view.featuresTilingScheme,s,r);t.tiles.has(s)?h||a.push(s):h&&o.push(s)}for(let s of o)this._referenceElement(s,e);for(let s of a)this._dereferenceElement(s,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}let i=new I({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(i!=null)for(let r of this._tileStrategy.tiles)_e(this.view.featuresTilingScheme,r,i)&&this._referenceElement(r,e)}};n([m()],R.prototype,"layer",void 0),n([m({readOnly:!0})],R.prototype,"elements",void 0),R=n([c("esri.views.2d.layers.MediaLayerView2D")],R);var p=$(),E={xmin:0,ymin:0,xmax:0,ymax:0};function _e(e,t,i){return e.getTileBounds(p,t.key,!0),E.xmin=p[0],E.ymin=p[1],E.xmax=p[2],E.ymax=p[3],Y(E,i)}var k=class{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){let i=[],r=new Set(this.elements);this.elements=t;for(let o of t)r.has(o)?r.delete(o):i.push(o);return this.isReady=!0,[i,Array.from(r)]}destroy(){}},jr=R;export{jr as default};
