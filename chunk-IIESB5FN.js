import{e as Tt,j as Ft,k as Pt}from"./chunk-74UU2P3O.js";import{a as Et,c as Ot,d as Bt,e as Gt}from"./chunk-EISGDP6C.js";import{a as Ut}from"./chunk-H2ZYDNNL.js";import{a as Mt,e as kt}from"./chunk-K57Y3IIR.js";import{i as Nt,t as Ht}from"./chunk-G3YWARR2.js";import{c as Lt,d as Dt,e as jt}from"./chunk-DFTJYHYF.js";import"./chunk-MIOOILW6.js";import"./chunk-TTCWVZMG.js";import"./chunk-QA5EAWXI.js";import"./chunk-K2IZFVKY.js";import"./chunk-XAHD7XBV.js";import"./chunk-FWCA6KJ3.js";import{a as At}from"./chunk-S52JRLJC.js";import"./chunk-W5OI4BJ2.js";import"./chunk-N7XX6O7L.js";import"./chunk-ZWYEIB75.js";import{c as St}from"./chunk-WAIROH7D.js";import"./chunk-G27DRLGO.js";import"./chunk-7LF5QJDR.js";import"./chunk-DV32PZA3.js";import{a as vt,b as ee}from"./chunk-DJXUOLWY.js";import{b as K}from"./chunk-4MCLOZGW.js";import{a as xt,b as It,r as Te}from"./chunk-P64DWRJ7.js";import"./chunk-4MYROXQR.js";import"./chunk-L5JJXC3A.js";import"./chunk-NRQSFK4P.js";import"./chunk-J2SAHMG5.js";import"./chunk-PSNQ2KG3.js";import"./chunk-DBZKWPEX.js";import"./chunk-AYSSTKZP.js";import"./chunk-GAPCKNYR.js";import"./chunk-2IWALBQY.js";import"./chunk-BMQOGMDN.js";import{c as Rt}from"./chunk-KRE5JNQN.js";import"./chunk-WKFWO47P.js";import"./chunk-BHGFQO2D.js";import"./chunk-WXB3UZNT.js";import{c as Ct}from"./chunk-VOJIMLDZ.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-WPMNZVYJ.js";import"./chunk-7VWXQFPJ.js";import"./chunk-CSFAHB4Y.js";import"./chunk-AMISFAT3.js";import"./chunk-PTXLSCMJ.js";import"./chunk-FZ5X7HOK.js";import"./chunk-XXQKBDTN.js";import"./chunk-O2J7LFYY.js";import"./chunk-6DKBN3BZ.js";import"./chunk-WDRWH4L7.js";import"./chunk-3D4Y6BLC.js";import"./chunk-OTUHXNWB.js";import"./chunk-NBT2WTKD.js";import"./chunk-JLLOI4DS.js";import"./chunk-4MZNR6MW.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-Y34QJIHM.js";import"./chunk-PSIELDY2.js";import"./chunk-TKFJYNPE.js";import"./chunk-EG2DTURK.js";import"./chunk-SAHTKHGU.js";import"./chunk-7XYJRI7F.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-A5S42OSQ.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-DHLVTH5U.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-GK3RYCKG.js";import"./chunk-B564E6X6.js";import{b as M}from"./chunk-TBHSFWI7.js";import"./chunk-MEGSPQVO.js";import"./chunk-FSWSNKJD.js";import{a as k}from"./chunk-3AS27HNO.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import{a as y}from"./chunk-RWCIDBNQ.js";import"./chunk-2EW3SBKG.js";import"./chunk-FCB5DYUJ.js";import"./chunk-3ZANJLLA.js";import{c as gt}from"./chunk-RBPJGXZM.js";import{b as ft,c as pt}from"./chunk-E5HHKQF2.js";import{a as ht}from"./chunk-PLIWVXAW.js";import"./chunk-7QY3BMVN.js";import{a as et}from"./chunk-WPDP647R.js";import{a as j}from"./chunk-4E4FE2IX.js";import{a as X,d as Ze,e as A,f as Ke}from"./chunk-5SSISWTF.js";import"./chunk-K3Z3MI77.js";import"./chunk-4XPPVS7X.js";import"./chunk-O4PKXMAM.js";import"./chunk-2NH7HOKA.js";import{a as Ae}from"./chunk-ONYJLWAD.js";import{a as _t,d as yt}from"./chunk-TKZJUAKL.js";import"./chunk-EDAGF7R6.js";import{b as wt}from"./chunk-6EWMYOA7.js";import"./chunk-IDLNQPT7.js";import"./chunk-VRPEURU5.js";import"./chunk-B57IWIA2.js";import"./chunk-DDZ3KR2Q.js";import"./chunk-FYZRIMPP.js";import{b as $e}from"./chunk-SP2CO3KX.js";import"./chunk-C5DQZVZ7.js";import"./chunk-WH2SG675.js";import"./chunk-R3KYOH5H.js";import"./chunk-NFWLUI2Z.js";import"./chunk-WRYEUJBQ.js";import"./chunk-DQOFEB5P.js";import"./chunk-BUZBVNOM.js";import"./chunk-VYZHOYXV.js";import{a as bt}from"./chunk-VC7OIMIK.js";import"./chunk-NIYDRLW4.js";import{a as Z}from"./chunk-3Q427ME6.js";import"./chunk-3BZAI7HK.js";import"./chunk-LNYBTIG7.js";import"./chunk-525N4T6K.js";import{a as tt}from"./chunk-EBK2L6ZQ.js";import{c as Se}from"./chunk-6T37AWU6.js";import"./chunk-LPCVOXF2.js";import"./chunk-4AIH3WFI.js";import"./chunk-3G7BLSJZ.js";import"./chunk-HM5RIVQC.js";import"./chunk-SKMO433W.js";import"./chunk-2FO7ARYZ.js";import"./chunk-NOQEJXLK.js";import"./chunk-DJW5LMRG.js";import"./chunk-QXXXCEV5.js";import"./chunk-QMKRRCM3.js";import"./chunk-TCGGI7DC.js";import{a as T}from"./chunk-ALWV3RJ2.js";import"./chunk-7C6Z24SS.js";import"./chunk-5WKDXHVH.js";import"./chunk-B5LBE5HD.js";import"./chunk-F6A6XWW4.js";import"./chunk-AESEF3B2.js";import"./chunk-74LTYPBC.js";import"./chunk-3BDL2KTL.js";import"./chunk-TGPGCQ44.js";import"./chunk-PWU2QHPV.js";import"./chunk-WUJRCGDY.js";import"./chunk-QPGCDGIN.js";import{g as mt}from"./chunk-PTZYZULI.js";import"./chunk-KZKWOEFD.js";import"./chunk-LNVVFNTC.js";import"./chunk-NHQ2XIW3.js";import"./chunk-MBE3KZ4V.js";import"./chunk-EWGQ3XHW.js";import"./chunk-YQPWWSMJ.js";import"./chunk-JEIB6WNP.js";import"./chunk-6JJCXUHW.js";import"./chunk-CVRJ6GOM.js";import"./chunk-X7QUUHRV.js";import{a as it,c as ot,d as at,f as dt,i as lt}from"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-JR22Z7I2.js";import"./chunk-3QNSJ5HY.js";import{a as ct,b as ut}from"./chunk-UNVICPIE.js";import"./chunk-BGICKEJR.js";import{d as Je,e as Ye,u as Xe}from"./chunk-TRZXSDYA.js";import"./chunk-OGS2SUK5.js";import"./chunk-TVHRLNTK.js";import"./chunk-JA3EMS2I.js";import"./chunk-HKHTIKVW.js";import"./chunk-XFESK2YB.js";import"./chunk-IJBTA53P.js";import"./chunk-ZHUXSQTN.js";import"./chunk-YLZWDFCJ.js";import"./chunk-TLMADEUL.js";import"./chunk-WNSGKHQ6.js";import"./chunk-J5MXC6AL.js";import"./chunk-OLOKUDVI.js";import"./chunk-RJWOVI3M.js";import"./chunk-R6GE4XRP.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import{h as nt,t as st}from"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import{a as R,e as Re,i as ve}from"./chunk-NHSDW26F.js";import{g as rt}from"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import{a as Ie}from"./chunk-WAGBL553.js";import{a as Ue}from"./chunk-WKJJQIBC.js";import"./chunk-CNQVGGE6.js";import"./chunk-JGD7UKVF.js";import"./chunk-X5AA4JDN.js";import"./chunk-J372WZPB.js";import"./chunk-6XFS4U2F.js";import"./chunk-XPRVY6JT.js";import"./chunk-7N3ZKWML.js";import"./chunk-E62WHYYG.js";import"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import{d as Ve,e as Qe,m as We,q as qe}from"./chunk-3SDSCSDJ.js";import{j as ze}from"./chunk-I4M2OT5W.js";import"./chunk-NTVLK3P2.js";import{a as Ce}from"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-ZTJLFKGG.js";import"./chunk-5TW726OD.js";import"./chunk-VGD3XLDH.js";import{a as Ne,h as He}from"./chunk-LB5YQINJ.js";import"./chunk-EKMHQEJY.js";import{a as Y}from"./chunk-VACZNAP3.js";import"./chunk-JKNCWG7E.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7IPIJKWU.js";import"./chunk-7R33MKVL.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import{L as J,d as w}from"./chunk-C7INQGWT.js";import{H as x}from"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{C as ke,a as Le,m as je,t as xe,u as P}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import{a as g}from"./chunk-QGVBCWUY.js";import{t as De}from"./chunk-HHDFN2GK.js";import{a as D,t as Ge}from"./chunk-47GHT6OF.js";import{a as q,b as $,f as c}from"./chunk-VTHXE323.js";var b=class extends J{constructor(r){super(r),this._updatingCount=0,this._tileHandles=new Ie,this._wanted=new Ie}destroy(){for(let r of this._tileHandles.values())r.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){let{extent:r}=this;return r==null?null:Ve(r)}get _missingTiles(){let r=new Array,e=this._wanted;for(let t of this._tileHandles.values())e.has(t.id)&&!N(t)&&r.push(t);return r}onTileTreeChange(r){return c(this,null,function*(){++this._updatingCount;try{let{added:e,removed:t}=r,n=this._tileHandles,{_boundingRect:s}=this,i=s!=null?e.filter(d=>qe(s,d.extent)):e,o=this._wanted,a=new Array;for(let d of t){let{id:l}=d;if(o.delete(l),e.some(m=>F(m,d)||F(d,m)))continue;let u=n.get(l);u!=null&&a.push(this._removeTile(u))}for(let d of i)o.set(d.id,d),a.push(this._addTile(d));yield Promise.allSettled(a)}finally{--this._updatingCount}})}_removeTile(r){return c(this,null,function*(){this._tileHandles.delete(r.id),r.abort(),this._validate();let{tile:e}=r,t=new E(r.untilSettled(),e!=null?this.createRemoveTileCommand(e):null);r.nextEvent=null;let{command:n}=yield t.getCommand();n?.execute()})}_addTile(r){return c(this,null,function*(){let{_tileHandles:e}=this,t=e.get(r.id);if(t!=null)return!N(t)||t.tile.isComplete||(t.tile=t.tile.reset(),t.nextEvent=this._onTileLoad(t)),void(yield t.untilSettled());let n=new Me(r);this._tileHandles.set(n.id,n);let s=this.loadTile(r,n.signal);n.nextEvent=s;let i=yield s;if(n.aborted)throw xe();n.tile=i,Zt(n),n.nextEvent=this._onTileLoad(n),yield n.untilSettled()})}_onTileLoad(r){return c(this,null,function*(){let{_wanted:e,_tileHandles:t,_missingTiles:n}=this,s=r.descriptor,i=new Array,o=new Array,a=new Set;for(let l of t.values()){if(l===r)continue;let{descriptor:u,id:m}=l;if(e.has(m)||n.some(({descriptor:h})=>F(h,u)||F(u,h))){if(N(l)){if(F(s,u)){let h=l.tile;for(let p of h.objectIds())a.add(p)}if(F(u,s)){let h=r.tile,p=new Set(h.objectIds()),f=l.tile,_=f.exclude(p);l.tile=_;let I=AbortSignal.any([l.signal,r.signal]),C=l.untilSettled();i.push(new E(C,this.createRemoveTileCommand(f))),i.push(new E(C,this.createAddTileCommand(_,I),I)),o.push(l),this._validateRemoval(_,p)}}}else{l.abort(),t.delete(m);let{tile:h}=l;h!=null&&i.push(new E(l.untilSettled(),this.createRemoveTileCommand(h))),l.nextEvent=null}}a.size>0&&(r.tile=r.tile.exclude(a),this._validateRemoval(r.tile,a)),i.push(new E(r.untilSettled(),this.createAddTileCommand(r.tile,r.signal),r.signal)),o.push(r),this._validate();let d=this._joinCommands(i);for(let l of o)l.nextEvent=d;yield d})}_joinCommands(r){return c(this,null,function*(){let e=(yield Promise.allSettled(r.map(t=>c(this,null,function*(){return t.getCommand()})))).map(t=>t.status!=="fulfilled"||t.value.signal?.aborted?null:t.value.command).filter(Ge);e.length!==0&&e.reduce((t,n)=>(t.append(n),t)).execute()})}_validate(){if(!D("feature-pipeline-3d-test-validation"))return;let r=new Array;for(let e of this._tileHandles.values()){if(!N(e))continue;let{tile:t}=e,n=t.featureCount,s=new Uint32Array(n);t.readObjectIds(s),r.push({tile:t,objectIds:new Set(s)})}for(let e=0;e<r.length;++e){let{tile:t,objectIds:n}=r[e];for(let s=e+1;s<r.length;++s){let{tile:i,objectIds:o}=r[s];for(let a of o)if(n.has(a)){let d=F(i.descriptor,t.descriptor),l=F(t.descriptor,i.descriptor);throw new Error(`${t.descriptor.id} and ${i.descriptor.id} both contain ${a}. aInB: ${d}; bInA: ${l}`)}}}}_validateRemoval(r,e){if(D("feature-pipeline-3d-test-validation")){for(let t of r.objectIds())if(e.has(t))throw new Error(`Failed to remove ${t} from ${r.descriptor.id}!`)}}};function F({lij:[r,e,t]},{lij:[n,s,i]}){let o=n-r;return o>=0&&e===s>>o&&t===i>>o}g([w()],b.prototype,"updating",null),g([w({constructOnly:!0})],b.prototype,"loadTile",void 0),g([w({constructOnly:!0})],b.prototype,"createAddTileCommand",void 0),g([w({constructOnly:!0})],b.prototype,"createRemoveTileCommand",void 0),g([w()],b.prototype,"_updatingCount",void 0),g([w()],b.prototype,"extent",void 0),g([w()],b.prototype,"_boundingRect",null),g([w()],b.prototype,"_missingTiles",null),b=g([x("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],b);var Me=class{constructor(e){this.descriptor=e,this._controller=new AbortController,this._tile=Ue(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(e){this._tile.value=e}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}untilSettled(){return c(this,null,function*(){try{yield this.nextEvent}catch(e){ke(e)||console.error(e)}})}};function N(r){return r.tile!=null}function Zt(r){if(!N(r))throw new Error}var E=class{constructor(e,t,n){this.previousEventSettled=e,this.commandPromise=t,this.signal=n}getCommand(){return c(this,null,function*(){let{previousEventSettled:e,commandPromise:t,signal:n}=this,[s]=yield Promise.all([t,e]);if(n?.aborted)throw xe();return{command:s,signal:n}})}};var te=class r{constructor(e,t){this.tile=e,this._tileIndices=t}get id(){return this.tile.id}get featureCount(){return this._tileIndices?.length??this.tile.featureCount}get usedMemory(){return A+(this._tileIndices?.byteLength??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,t){let{_tileIndices:n,tile:s}=this;return s.readObjectIds(e,n,t)}readCoordinates(e,t){let{_tileIndices:n,tile:s}=this;return s.readCoordinates(e,n,t)}subset(e){let{_tileIndices:t,tile:n}=this;if(t==null)return new r(n,e);let s=new Uint32Array(e.length);for(let i=0;i<s.length;++i)s[i]=t[e[i]];return new r(n,s)}};var re=class{constructor(){this._tileToFeatureData=new Map}add(e){this._tileToFeatureData.set(e.tile,e)}remove(e){this._tileToFeatureData.delete(e)}get(e){return this._tileToFeatureData.get(e)}};var U=class{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return A+X}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new Fe(this._index,this._view,e)}},Fe=class extends U{constructor(e,t,n){super(e,t),this._geometryOverride=n}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return et(new j,this._geometryOverride,e.hasZ,e.hasM)}},ne=class{constructor(){this._tileBounds=new Map,this.events=new Y,this.featureAdapter=z.shared}get usedMemory(){return A+A*this._tileBounds.size}addTile(e){let{featureCount:t}=e;if(t===0)return;let n=new vt(9,i=>e.getBounds(i)),s=new Array;for(let i=0;i<t;++i)s[i]=i;n.load(s),this._tileBounds.set(e,n),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(let[t,n]of this._tileBounds)n.all(s=>e(new U(s,t)))}forEachInBounds(e,t){H.minX=e[0],H.minY=e[1],H.maxX=e[2],H.maxY=e[3];for(let[n,s]of this._tileBounds)s.search(H,i=>t(new U(i,n)))}forEachBounds(e,t){for(let n of e)t(n.getBoundingBox())}getFullExtent(e){let t=1/0,n=1/0,s=-1/0,i=-1/0;for(let o of this._tileBounds.values()){let{minX:a,minY:d,maxX:l,maxY:u}=o.toJSON();t=Math.min(t,a),n=Math.min(n,d),s=Math.min(s,l),i=Math.min(i,u)}return{xmin:t,ymin:n,xmax:s,ymax:i,spatialReference:e}}},z=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};z.shared=new z;var H=new ee;var se=class r{constructor(e,t,n=Kt(t)){this.descriptor=e,this._pages=t,this._addressTable=n;let s=Ke+t.reduce((a,{usedMemory:d})=>a+d,0),i=3*X,o=Ze(n);this.usedMemory=A+s+i+o,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===t.reduce((a,d)=>a+d.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){let{pageIndex:t,featurePageIndex:n}=this._translateIndex(e);return this._pages[t].getObjectId(n)}getAttribute(e,t){let{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getAttribute(s,t)}getAttributeAsTimestamp(e,t){let{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getAttributeAsTimestamp(s,t)}getAttributes(e){let{pageIndex:t,featurePageIndex:n}=this._translateIndex(e);return this._pages[t].getAttributes(n)}getCoordinates(e,t,n){let{pageIndex:s,featurePageIndex:i}=this._translateIndex(e);this._pages[s].getCoordinates(i,t,n)}getOptimizedGeometry(e){let{pageIndex:t,featurePageIndex:n}=this._translateIndex(e);return this._pages[t].getOptimizedGeometry(n)}getCentroid(e,t){let{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getCentroid(s,t)}getBounds(e){let{pageIndex:t,featurePageIndex:n}=this._translateIndex(e);return this._pages[t].getBounds(n)}getBoundingBox(e){let{pageIndex:t,featurePageIndex:n}=this._translateIndex(e);return this._pages[t].getBoundingBox(n)}readObjectIds(e,t=this._allFeatureIndices(),n=0){let s=n;for(let{page:i,indices:o}of this._batchPageIndices(t))s=i.readObjectIds(e,o,s);return s}readCoordinates(e,t=this._allFeatureIndices(),n=0){let s=n;for(let{page:i,indices:o}of this._batchPageIndices(t))s=i.readCoordinates(e,o,s);return s}*objectIds(e=this._allFeatureIndices()){for(let{page:t,indices:n}of this._batchPageIndices(e))for(let s of t.objectIds(n))yield s}exclude(e){if(e.size===0)return this;let{_addressTable:t,featureCount:n}=this,s=new Array;for(let i=0;i<n;++i){let o=this.getObjectId(i);e.has(o)||(s.push(t[2*i]),s.push(t[2*i+1]))}return new r(this.descriptor,this._pages,s)}reset(){let{isComplete:e,_pages:t}=this;return e?this:new r(this.descriptor,t)}*_allFeatureIndices(){let{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_translateIndex(e){let{_addressTable:t}=this;return{pageIndex:t[2*e],featurePageIndex:t[2*e+1]}}*_batchPageIndices(e){let t=new Array;{let s=0,i=new Array;for(let o of e){let{pageIndex:a,featurePageIndex:d}=this._translateIndex(o);s!==a&&(i.length!==0&&t.push({pageIndex:s,indices:i}),s=a,i=[]),i.push(d)}i.length!==0&&t.push({pageIndex:s,indices:i})}let{_pages:n}=this;for(let{pageIndex:s,indices:i}of t)yield{page:n[s],indices:i}}};function Kt(r){let e=r.reduce((s,{featureCount:i})=>s+i,0),t=new Array;if(e===0)return t;let n=r[0].featureCount;for(let s=0;s<e;++s)t[2*s]=Math.floor(s/n),t[2*s+1]=s%n;return t}var oe=class{constructor(e){this._reader=new ht(new Uint8Array(e),new DataView(e)),this._index=er(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){let{_index:{fieldsIndex:n,attributeIndices:s}}=this,i=n.get(t)?.index;if(i==null)return;let o=s[e*n.fields.length+i],a=this._reader;return a.move(o),ie(a)}getAttributeAsTimestamp(e,t){let n=this.getAttribute(e,t);return typeof n=="string"?new Date(n).getTime():typeof n=="number"||n==null?n:null}getAttributes(e){let{_index:{fieldsIndex:t,attributeIndices:n}}=this,s=e*t.fields.length,i=this._reader,o={};for(let a of t.fields){let d=n[s+a.index];i.move(d),o[a.name]=ie(i)}return o}getCoordinates(e,t,n=0){let s=this._reader,{transform:i,featureIndices:o}=this._index,{scale:a,translate:d}=i;s.move(o[e]),this._readCoordinates(a,d,t,n)}getOptimizedGeometry(e){let t=R();return this.getCoordinates(e,t),new j([],t)}getCentroid(e,{hasZ:t,hasM:n}){this.getCoordinates(e,B);let[s,i,o]=B,a=[s,i];return t&&(a[3]=o),n&&(a[t?4:3]=0),new j([],a)}getBounds(e){this.getCoordinates(e,B);let[t,n]=B,s=new ee;return s.minX=t,s.minY=n,s.maxX=t,s.maxY=n,s}getBoundingBox(e){this.getCoordinates(e,B);let[t,n,s]=B;return Ye(t,n,s,t,n,s)}readObjectIds(e,t=this._allFeatureIndices(),n=0){let s=this._reader,{objectIdFieldName:i,attributeIndices:o,fieldsIndex:a}=this._index,d=a.get(i).index,l=a.fields.length;for(let u of t){let m=o[u*l+d];s.move(m),e[n++]=ie(s)}return n}readCoordinates(e,t=this._allFeatureIndices(),n=0){let s=this._reader,{transform:i,featureIndices:o}=this._index,{scale:a,translate:d}=i;for(let l of t){let u=o[l];s.move(u),n=this._readCoordinates(a,d,e,n)}return n}*objectIds(e=this._allFeatureIndices()){let t=this._reader,{objectIdFieldName:n,attributeIndices:s,fieldsIndex:i}=this._index,o=i.get(n).index,a=i.fields.length;for(let d of e){let l=s[d*a+o];t.move(l),yield ie(t)}}*_allFeatureIndices(){let{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,n],[s,i,o],a,d){let m=this._reader,h=m.getLength(),p=m.pos()+h;for(;m.pos()<p&&m.next();)switch(m.tag()){case 2:{let f=m.getLength(),_=m.pos()+f;for(;m.pos()<_&&m.next();)m.tag()===3?(m.getUInt32(),a[d++]=s+e*m.getSInt64(),a[d++]=i+t*m.getSInt64(),a[d++]=o+n*m.getSInt64()):m.skip();break}default:m.skip()}return d}};function er(r){for(;r.next();){if(r.tag()===2)return tr(r.getMessage());r.skip()}ae()}function tr(r){for(;r.next();){if(r.tag()===1)return rr(r.getMessage());r.skip()}ae()}function rr(r){let u,m,h=!1,p=!1,f=0,_=new Array,I=new Array,C=new Array;for(;r.next();)switch(r.tag()){case 1:m=r.getString();break;case 7:r.getEnum()!==0&&ae();break;case 9:h=r.getBool()??!1;break;case 12:u=$e(r.processMessage(pt));break;case 13:{let v=r.processMessage(ft);v.index=f++,_.push(v);break}case 15:{I.push(r.pos());let v=r.getUInt32(),be=r.pos()+v;for(;r.pos()<be&&r.next();)r.tag()===1&&C.push(r.pos()),r.skip();break}case 10:p=r.getBool()??!1;break;default:r.skip()}let O=new tt(_);return u!=null&&p&&m!=null&&O.has(m)||ae(),{transform:u,exceededTransferLimit:h,fieldsIndex:O,objectIdFieldName:m,featureIndices:I,attributeIndices:C}}function ae(){let r=new De("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(r),r}function ie(r){let u=r.getLength(),m=r.pos()+u;for(;r.pos()<m&&r.next();)switch(r.tag()){case 1:return r.getString();case 2:return r.getFloat();case 3:return r.getDouble();case 4:return r.getSInt32();case 5:return r.getUInt32();case 6:return r.getInt64();case 7:return r.getUInt64();case 8:return r.getSInt64();case 9:return r.getBool();default:return r.skip(),null}return null}var B=R();var zt=8e3,nr=4,sr=4,de=class{constructor(e,t,n,s,i){this.spatialReference=e,this.url=n,this.objectIdField=s,this.capabilities=i;let{supportsMaxRecordCountFactor:o,maxRecordCount:a}=this.capabilities.query,d=o?nr:1,l=(a??zt)*d;this._pageSize=Math.min(zt,l);let u=t.clone();u.cacheHint=!0,u.resultType="tile",u.outSpatialReference=e,u.returnGeometry=!0,u.returnZ=!0,u.maxRecordCountFactor=d,u.num=this._pageSize,u.outFields=[s],this._baseQuery=u}fetch(e,t){return c(this,null,function*(){let{spatialReference:n}=this,s=Qe(e.extent,n),i=this._baseQuery.clone();i.geometry=s;let o=new Array,a=0,d=!1,l=1;for(;!d;){let u=[];for(let h=0;h<l;++h)u.push(this._fetchPage(i,a++,t));let m=yield Promise.all(u);P(t);for(let h of m){let p=h.featureCount!==0;d||=!h.exceededTransferLimit||!p,p&&o.push(h)}l=Math.min(l+1,sr)}return new se(e,o)})}_fetchPage(e,t,n){return c(this,null,function*(){let s=e.clone();s.start=t*this._pageSize;let i=(yield gt(this.url,s,{signal:n})).data;return P(n),new oe(i)})}};var le=class extends Rt{constructor(e=R()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}};var V=class extends Mt{constructor(r){super(r),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new le,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach(t=>e+=t.numElements/6),e}get usedMemory(){let r=0;return this._renderGeometries.forEach(e=>{r+=e.vao.usedMemory}),r}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((r,e)=>{this._produces.set(e,t=>t!==k.Highlight&&t!==k.ShadowHighlight&&r(t))})}destroy(){this._glMaterials.dispose();let r=this._renderGeometries.keys();for(let e of r)this.removeRenderGeometry(e)}acquireTechniques(r){let e=this.material;if(!e.shouldRender(r))return null;let{output:t,bind:n}=r;return!e.produces.get(n.slot)?.(t)||t===k.Highlight||t===k.ShadowHighlight?null:this._glMaterials.load(r.rctx,n.slot,t)?.beginSlot(n)}render(r,e){let t=this._renderGeometries;if(t.size===0)return;let{bind:n}=r,s=n.slot===Te.OCCLUDER_MATERIAL||n.slot===Te.TRANSPARENT_OCCLUDER_MATERIAL?n.slot:null,i=r.rctx;i.runAppleAmdDriverHelper(),i.bindTechnique(e,n,this.material.parameters);let o=e.program;for(let[a,d]of t)this._drawParameters.origin=d.localOrigin,o.bindDraw(n,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(d.vao),i.bindVAO(d.vao),i.setPipelineState(e.getPipeline(!1,s)),i.drawArrays(e.primitiveType,0,d.numElements)}initializeRenderContext(r,e){this._glMaterials=new Ft(this.material,r.materials),this._vaoCache=r.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,At(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(r,e,t){this.removeRenderGeometry(r);let n=this._vaoCache.newVao(e.data.byteLength);n.vertexBuffers.get("geometry").setSubData(new Uint8Array(e.data),0,0,e.data.byteLength);let s={localOrigin:t,vao:n,numElements:e.elementCount};return this._renderGeometries.set(r,s),s}removeRenderGeometry(r){let e=this._renderGeometries.get(r);e!=null&&(this._vaoCache.deleteVao(e.vao),this._renderGeometries.delete(r))}hasHighlightOptions(r){return!1}};g([w({constructOnly:!0})],V.prototype,"material",void 0),V=g([x("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],V);var ce=class{constructor(r){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=r.layerUid,this.view=r.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach(r=>r())}doLoad(r,e,t){return c(this,null,function*(){D("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(y.OBJECTANDLAYERIDCOLOR);let n=ir(d=>e(d),r),s=this.view._stage,i=n.getMaterials();s.addMany(i),this._addDisposeResource(()=>s.removeMany(i));let o=n.getTextures();s.addMany(o),this._addDisposeResource(()=>{o.forEach(d=>d.unload()),s.removeMany(o)}),yield Promise.all(o.map(d=>this.view._stage.schedule(()=>d.load(s.renderView.renderingContext),t))),P(t);let a=yield this._createLodRenderer(n,t);this._lodRendererResources={lodRenderer:a,materials:i,textures:o}})}addInstances(r){let e=this._lodRendererResources;if(e==null)return;let{featureIds:t,localTransforms:n,globalTransforms:s}=r,i=e.lodRenderer;if(i==null)return;let o=i.instanceData,a=t.length;for(let d=0;d<a;++d){let l=t[d],u=o.addInstance(),m=o.view,h=16*d;m.localTransform.copyFromTypedBuffer(u,n,h),m.globalTransform.copyFromTypedBuffer(u,s,h),o.updateModelTransform(u),o.setVisible(u,!0),this._featureIdToInstanceIndex.set(l,u)}}removeInstances(r){let e=this._lodRendererResources;if(e==null)return;let t=e.lodRenderer.instanceData,n=this._featureIdToInstanceIndex,s=r.length;for(let i=0;i<s;++i){let o=r[i],a=n.get(o);a!=null&&(t.removeInstance(a),n.delete(o))}}_addDisposeResource(r){this._disposeResourceHandles.push(r)}_createLodRenderer(r,e){return c(this,null,function*(){let t=this.view._stage,n={layerUid:this.layerUid,graphicUid:i=>1,notifyGraphicGeometryChanged:i=>1,notifyGraphicVisibilityChanged:i=>1},s=new Pt({symbol:r,optionalFields:this._optionalFields,metadata:n,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(s),s.destroy()}),yield t.addRenderPlugin(s,e),s})}};function ir(r,e){let t=e.levels.map(n=>{let s=n.components.map(i=>{let o=r(i.materialId);if(!or(o))throw new Error("LodRenderer only supports DefaultMaterial");let a=new Et(o,i.renderGeometryBuffer.data,i.renderGeometryBuffer.elementCount,i.boundingInfo);return new Ot(a)});return new Bt(s,n.minScreenSpaceRadius)});return new Gt(t)}function or(r){return r!=null&&"materialType"in r&&r.materialType==="default"}ce=g([x("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],ce);var Pe=class extends J{constructor(r){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=r.view,this.layerUid=r.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(r=>r.destroy())}executeRenderCommands(r){return c(this,null,function*(){for(let e of r)switch(e.id){case"create-material":yield this._createMaterial(e);break;case"create-direct-renderer":yield this._createDirectRenderer(e);break;case"add-direct-renderer-geometry":yield this._addDirectRendererGeometry(e),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":yield this._removeDirectRendererGeometry(e),this._updateFeatureCount();break;case"create-lod-renderer":yield this._createLodRenderer(e);break;case"add-lod-instances":yield this._addLodInstances(e),this._updateFeatureCount();break;case"remove-lod-instances":yield this._removeLodInstances(e),this._updateFeatureCount()}})}_updateFeatureCount(){let r=0;for(let e of this._directRenderers.values())r+=e.numFeatures;for(let e of this._lodRenderers.values())r+=e.numFeatures;this._set("totalFeatures",r)}get usedMemory(){let r=0;for(let e of this._directRenderers.values())r+=e.usedMemory;for(let e of this._lodRenderers.values())r+=e.usedMemory;return r}_createMaterial(r){return c(this,null,function*(){let{view:e}=this,{sharedSymbolResources:t}=e;if(t==null)throw new Error("No shared symbol resources found!");let{textures:n}=t,s=e.state.viewingMode===Z.Global,i=null;switch(r.type){case"default":i=ar(t,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:e._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},s);break;case"hud":{let[o,a]=Ee(n,s);this.addHandles([Le(()=>je(a))]),i=o}break;default:throw new Error(`unable to create unknown material type ${r.type}`)}this._materials.set(r.materialId,i)})}_getMaterial(r){return this._materials.get(r)}_createDirectRenderer(r){return c(this,null,function*(){let e=r.materialId,t=this._getMaterial(e);if(t==null)throw new Error(`material not found ${e}`);let{view:n}=this,s=new V({material:t});this._directRenderers.set(e,s),n._stage.addRenderPlugin(s),n._stage.renderView.renderer.updateHasFlags()})}_addDirectRendererGeometry(r){return c(this,null,function*(){let e=r.renderGeometryId,t=r.materialId;yield this._removeDirectRendererGeometry({renderGeometryId:e});let n=this._directRenderers.get(t);if(n==null)return void console.error("no renderer assigned to provided material");let s=n.addRenderGeometry(e,r.renderGeometryBuffer,r.localOrigin);this._renderGeometries.set(e,{renderGeometry:s,materialId:t}),this.view._stage.renderView.requestRender()})}_removeDirectRendererGeometry(r){return c(this,null,function*(){let e=r.renderGeometryId,t=this._renderGeometries.get(e);if(t==null)return;let n=t.materialId,s=this._directRenderers.get(n);s!=null?s.removeRenderGeometry(r.renderGeometryId):console.error("no renderer assigned to provided material")})}_createLodRenderer(r){return c(this,null,function*(){let e=new ce({view:this.view,layerUid:this.layerUid}),t=new AbortController,n=s=>this._getMaterial(s);yield e.doLoad(r.lodRenderGeometry,n,t.signal),this._lodRenderers.set(r.lodRendererId,e)})}_addLodInstances(r){return c(this,null,function*(){let e=this._lodRenderers.get(r.lodRendererId);if(e==null)throw new Error("no lod renderer assigned to provided lod renderer Id");e.addInstances(r.data)})}_removeLodInstances(r){return c(this,null,function*(){let e=this._lodRenderers.get(r.lodRendererId);if(e==null)throw new Error("no lod renderer assigned to provided lod renderer Id");e.removeInstances(r.featureIds)})}};function Ee(r,e){let t={anchorPosition:Tt.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:Lt},n=null;if(r!=null){let s=r.fromData("circle-icon",()=>jt("circle"));t.textureId=s.texture.id,t.textureIsSignedDistanceField=!0,t.sampleSignedDistanceFieldTexelCenter=Dt("circle")}return[new kt(t,e),n]}function ar(r,e,t){let n={usePBR:e.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:Ct,ambient:ve,diffuse:ve,hasSlicePlane:e.slicePlaneEnabled,castShadows:e.castShadows,offsetTransparentBackfaces:!e.isPrimitive};return dr(n),e.screenSizePerspectiveEnabled&&(n.screenSizePerspective=r.screenSizePerspectiveSettings),n.externalColor=mt,n.isInstanced=!0,new K(n,{spherical:t,doublePrecisionRequiresObfuscation:!0})}function dr(r){let e=r.opacity??1,t=e<1;return r.transparent=t,r.opacity=e,r.cullFace=t?Ae.None:Ae.Back,r}g([w({readOnly:!0})],Pe.prototype,"totalFeatures",void 0),Pe=g([x("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],Pe);var Q=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){let n=this._bufferWriter,s=null;if(e.transformation&&t)it(G,e.transformation),G[12]-=t[0],G[13]-=t[1],G[14]-=t[2],s=G;else{if(t)throw new Error("not implemented");e.transformation&&(s=e.transformation)}let i=null;s&&(dt(ue,G),at(ue,ue),i=ue);let o=e.attributes,a=n.elementCount(o),d=n.vertexBufferLayout.stride/4;a>Math.floor(lr/d)&&console.warn("geometry with very large number of elements encountered");let l=n.vertexBufferLayout.createBuffer(a);return n.write(s,i,o,e.objectAndLayerIdColor,l,0),{data:l.buffer,elementCount:a}}},G=T(),ue=T(),lr=16777216/4;var me=class{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){let t=this._context,n=t.generateId("material");switch(e){case"default":{let s=new K({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),i=new Q(s);t.registerRenderGeometryBufferWriter(n,i)}break;case"hud":{let s=Ee(null,this._context.globalViewingMode)[0],i=new Q(s);t.registerRenderGeometryBufferWriter(n,i)}}return this._commands.push({id:"create-material",type:e,materialId:n}),n}createDirectRenderer(e){let t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,n){let s=t.materialId,i=this._context.getRenderGeometryBufferWriter(s);if(i==null)throw new Error(`no bufferwriter found for material ${s}`);let o=i.createBuffer(t,n);this._transferables.add(o.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:s,renderGeometryBuffer:o,localOrigin:n})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){let t=this._context.generateId("lod-renderer"),n={levels:e.levels.map(s=>({components:s.components.map(i=>{let o=i.attributes.get(y.POSITION);if(!o||o.indices.length===0)throw new Error("positions attribute expected");let a=3,d=yt(o.indices.length/a),l=new It(d,a,o),u=this._context.getRenderGeometryBufferWriter(i.materialId);if(u==null)throw new Error("writer not found");let m=u.createBuffer(i,null);return this._transferables.add(m.data),{materialId:i.materialId,renderGeometryBuffer:m,boundingInfo:{bbMax:l.bbMax,bbMin:l.bbMin}}}),minScreenSpaceRadius:s.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:n}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}append(e){if(e._context!==this._context)throw new Error("Cannot append encoders from different contexts");let{_commands:t,_transferables:n}=this;for(let s of e._commands)t.push(s);for(let s of e._transferables)n.add(s)}dispatch(){return c(this,null,function*(){let e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),yield this._context.dispatchRenderCommands(e,t)})}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};var he=class{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=()=>c(this,null,function*(){}),this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===Z.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new me(this)}dispatchRenderCommands(e,t){return c(this,null,function*(){e.length!==0&&(yield this._dispatchRenderCommandsCallback(e,t))})}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}};var L=class{constructor(e,t){this._renderCommands=e,this._pipelineStateCommands=t}append(e){this.appendRenderCommands(e._renderCommands),this.appendPipelineStateCommands(e._pipelineStateCommands)}appendRenderCommands(e){this._renderCommands.append(e)}appendPipelineStateCommand(e){this._pipelineStateCommands.push(e)}appendPipelineStateCommands(e){let{_pipelineStateCommands:t}=this;for(let n of e)t.push(n)}execute(){for(let e of this._pipelineStateCommands)e();this._renderCommands.dispatch()}};function W(r,e){let{featureCount:t}=r;if(t===0)return new Uint32Array;let n=new Uint32Array(t);return r.readObjectIds(n),n}function Oe(r,e){let{featureCount:t}=r;if(t===0)return new Float64Array;let n=new Float64Array(3*t);return r.readCoordinates(n),n}function Vt(r,e){let{featureCount:t}=r;if(t===0)return new Float64Array;let n=Oe(r),s=e.viewSpatialReference,i=e.renderSpatialReference,o=new Float64Array(3*t);if(!rt(n,s,0,o,i,0,t))throw new Error("Failed to project coordinates");return o}function Qt(r,e){let t=e.viewSpatialReference,n=e.renderSpatialReference,{extent:s}=r,i=We(s),o=R();return bt([i[0],i[1],0],t,o,n),o}function fe(r){let e=new Map;for(let[t,n]of r)e.set(t,$(q({},n),{indices:_t(n.indices)}));return e}function qt(r,e){let t=(n,s,i=!1)=>({levels:n.map(o=>{let a=fe(s(o.tesselation));return i&&cr(a),{components:[{attributes:a,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(r){case"cone":return t(ur,n=>Ht(1,.5,n,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function cr(r){let e=r,t=e.get(y.POSITION).data,n=e.get(y.NORMAL).data;if(n){let s=Wt(r,y.NORMAL).data;for(let i=0;i<n.length;i+=3){let o=n[i+1];s[i+1]=-n[i+2],s[i+2]=o}}if(t){let s=Wt(r,y.POSITION).data;for(let i=0;i<t.length;i+=3){let o=t[i+1];s[i+1]=-t[i+2],s[i+2]=o}}}function Wt(r,e){let t=r.get(e);return t&&!t.exclusive&&(t=$(q({},t),{exclusive:!0,data:xt(t.data)}),r.set(e,t)),t}var ur=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];var ge=class{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}_load(){return c(this,null,function*(){let e=this._context.renderCommandContext.createEncoder(),t=e.createMaterial("default"),n=qt(this._primitive,t);this.lodRendererId=e.createLodRenderer(n),yield e.dispatch(),this._loaded=!0})}createAddCommand(e){return c(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");let{featureCount:n}=e;if(n===0)return t;let s=!0,i=Je(ut(this._primitive)),o=Re(Xe(i)),a=Re(ct(o,{isPrimitive:s,width:100,depth:null,height:null})),d=new Float64Array(16*n),l=new Float64Array(16*n),u=Oe(e,this._context);for(let p=0;p<n;++p){let f=p,_=u[3*p+0],I=u[3*p+1],C=u[3*p+2],O=this._computeGlobalTransform(_,I,C,this._context.viewSpatialReference,hr),v=this._computeLocalTransform(a,o,mr);this._writeMatrixToTypedBuffer(d,f,v),this._writeMatrixToTypedBuffer(l,f,O)}let m=W(e,this._context),h={featureIds:new Uint32Array(m),localTransforms:d,globalTransforms:l};return t.addLodInstances(this.lodRendererId,h),t})}createRemoveCommand(e){return c(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return t;let n=W(e,this._context);return t.removeLodInstances(this.lodRendererId,n),t})}_writeMatrixToTypedBuffer(e,t,n){let s=16*t;for(let i=0;i<16;i++)e[s++]=n[i]}_computeGlobalTransform(e,t,n,s,i){return pe[0]=e,pe[1]=t,pe[2]=n,wt(s,pe,i,this._context.renderSpatialReference),i}_computeLocalTransform(e,t,n){return ot(n),this._applyObjectScale(e,t,n),n}_applyObjectScale(e,t,n){let s=Nt(e,e,t,this._context.renderCoordsHelper.unitInMeters);s[0]===1&&s[1]===1&&s[2]===1||lt(n,n,s)}},pe=R(),mr=T(),hr=T();var _e=class{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}_load(){return c(this,null,function*(){let e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),yield e.dispatch(),this._loaded=!0})}createAddCommand(e){return c(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");let{featureCount:n,id:s}=e;if(n===0)return t;let i=Vt(e,this._context),o=Qt(e,this._context),a=new Float64Array([0,0,1]),d=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),u=new Float64Array([0,0,0,1]),m=new Float64Array([0,0]),h=new Float64Array([0]),p=new Uint32Array(n);for(let S=0;S<n;++S)p[S]=S;let f=new Uint32Array(n);for(let S=0;S<n;++S)f[S]=0;let _=new M(i,p,3,!0),I=new M(a,f,3,!0),C=new M(m,f,2,!0),O=new M(d,f,4,!0),v=new M(h,f,1,!0),be=new M(l,f,2,!0),Jt=new M(u,f,4,!0),Yt=[[y.POSITION,_],[y.NORMAL,I],[y.UV0,C],[y.COLOR,O],[y.ROTATION,v],[y.SIZE,be],[y.CENTEROFFSETANDDISTANCE,Jt]],Xt={attributes:fe(Yt),objectAndLayerIdColor:void 0,transformation:T(),materialId:this.materialId};return t.addDirectRendererGeometry(s,Xt,o),t})}createRemoveCommand(e){return c(this,null,function*(){let t=this._context.renderCommandContext.createEncoder();return t.removeDirectRendererGeometry(e.id),t})}};var ye=class{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}load(){return c(this,null,function*(){this._symbols[0]=new _e(this._context),this._symbols[1]=new ge(this._context)})}createAddCommand(e){return c(this,null,function*(){let t=this._partition(e),n=yield Promise.all(t.map(a=>c(this,[a],function*({index:i,features:o}){return yield(yield this._provisionSymbol(i))?.createAddCommand(o)}))),s=this._context.renderCommandContext.createEncoder();for(let i of n)i!=null&&s.append(i);return new L(s,[()=>{this._featureDataPartitioning.set(e,t)}])})}createRemoveCommand(e){return c(this,null,function*(){let{_featureDataPartitioning:t}=this,n=t.get(e),s=this._context.renderCommandContext.createEncoder();if(n==null)return new L(this._context.renderCommandContext.createEncoder(),[]);let i=yield Promise.all(n.map(d=>c(this,[d],function*({index:o,features:a}){return yield this._getLoadedSymbol(o)?.createRemoveCommand(a)})));for(let o of i)o!=null&&s.append(o);return new L(s,[()=>{t.delete(e)}])})}_provisionSymbol(e){return c(this,null,function*(){if(e==null)return null;let t=this._symbols[e];return t?(t.loaded||(yield t.load()),t):null})}_getLoadedSymbol(e){if(e==null)return null;let t=this._symbols[e];return t!=null&&t.loaded?t:null}_partition(e){let t=W(e,this._context);if(t==null)throw new Error("unable to fetch objectIds");let{featureCount:n}=e,s=[[],[]];for(let i=0;i<n;++i)s[t[i]%2].push(i);return s.map((i,o)=>new Be(o,e.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}},Be=class{constructor(e,t){this.index=e,this.features=t}};var we=class extends Y.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new re,this._featureStore=new ne,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}setup(u){return c(this,arguments,function*({viewSpatialReference:r,renderSpatialReference:e,viewingMode:t,baseQuery:n,url:s,objectIdField:i,capabilities:o,fieldsIndex:a,timeInfo:d,fullExtent:l}){let m=Ce.fromJSON(r),h=Ce.fromJSON(e);this._fetcher=new de(m,Se.fromJSON(n),s,i,o),this._queryEngine=new St({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:a,availableFields:[i],spatialReference:r,featureStore:this._featureStore,timeInfo:d}),this._renderer=new ye({viewSpatialReference:m,renderSpatialReference:h,renderCoordsHelper:Ut.create(t,h),renderCommandContext:new he({viewingMode:t,dispatchRenderCommandsCallback:(f,_)=>this.remoteClient.invoke("dispatchRenderCommands",f,{transferList:_})})}),this._defaultQueryJSON=new Se({outSpatialReference:m}).toJSON();let p=null;if(l!=null){let f=ze.fromJSON(l);yield st(f.spatialReference,m),p=nt(f,m)}return this._tileManager=new b({loadTile:(f,_)=>this._fetcher.fetch(f,_),createAddTileCommand:(f,_)=>this._createAddTileCommand(f,_),createRemoveTileCommand:f=>this._createRemoveTileCommand(f),extent:p}),this.addHandles(Ne(()=>this.updating,f=>{this.emit("notify-updating",{updating:f})}),He),yield this._renderer.load(),$t})}executeQuery(r,e){return c(this,null,function*(){return{result:yield this._queryEngine.executeQuery(this._ensureQuery(r),e)}})}executeQueryForIds(r,e){return c(this,null,function*(){let t=yield this._queryEngine.executeQueryForIdSet(this._ensureQuery(r),e);return{result:Array.from(t)}})}executeQueryForCount(r,e){return c(this,null,function*(){return{result:yield this._queryEngine.executeQueryForCount(this._ensureQuery(r),e)}})}executeQueryForExtent(r,e){return c(this,null,function*(){return{result:yield this._queryEngine.executeQueryForExtent(this._ensureQuery(r),e)}})}executeQueryForLatestObservations(r,e){return c(this,null,function*(){return{result:yield this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(r),e)}})}onTileTreeChange(r){return c(this,null,function*(){return yield this._tileManager.onTileTreeChange(r),$t})}_createAddTileCommand(r,e){return c(this,null,function*(){let t=new te(r),n=yield this._renderer.createAddCommand(t);return P(e),n.appendPipelineStateCommand(()=>{this._featureDataStore.add(t),this._featureStore.addTile(r)}),n})}_createRemoveTileCommand(r){return c(this,null,function*(){let e=this._featureStore,t=this._featureDataStore,n=this._renderer,s=t.get(r);if(s==null)return null;let i=yield n.createRemoveCommand(s);return i.appendPipelineStateCommand(()=>{t.remove(r),e.removeTile(r)}),i})}_ensureQuery(r){return r??this._defaultQueryJSON}};g([w()],we.prototype,"updating",null),we=g([x("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],we);var vi=we,$t={result:void 0};export{vi as default};
