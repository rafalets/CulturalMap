import{a as E,b as h,c as ie,d as ce,e as le}from"./chunk-T27YAKLG.js";import{a as pe}from"./chunk-LLZNUDKQ.js";import{a as X,b as Y}from"./chunk-KR22AETZ.js";import{a as j,b as x,d as K,f as Q,g as V}from"./chunk-446CI6X5.js";import{a as Z,b as ee,c as re,d as te,e as se,f as oe,g as ae,h as U,i as ne}from"./chunk-RDQOYLXB.js";import"./chunk-VLECDDLP.js";import"./chunk-HE4N5PN6.js";import"./chunk-QMKRRCM3.js";import"./chunk-TCGGI7DC.js";import"./chunk-ALWV3RJ2.js";import"./chunk-7C6Z24SS.js";import"./chunk-5WKDXHVH.js";import{d as $,e as G,h as J,l as W,m as _}from"./chunk-BBB7KLHV.js";import"./chunk-KZKWOEFD.js";import"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-NHSDW26F.js";import"./chunk-NTVLK3P2.js";import{a as H}from"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import{b as L}from"./chunk-SLAWDKDA.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import{F as f,w as z}from"./chunk-E57FTRWF.js";import{V as B,w as g}from"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import"./chunk-C7INQGWT.js";import"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{H as q,u as p,x as k}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import"./chunk-QGVBCWUY.js";import{r as O}from"./chunk-HHDFN2GK.js";import{a as S}from"./chunk-47GHT6OF.js";import{a as P,b as T,f as c}from"./chunk-VTHXE323.js";var me=1e6,ue=20*me,Se=2e9,je=3;function fe(n,a,i){return c(this,arguments,function*({data:e,name:t,description:r},s,o){let l=null;try{let u=g(s,"uploads"),y=g(u,"info"),{data:w}=yield f(y,{query:{f:"json"},responseType:"json"});p(o);let m=z(s),D=w.maxUploadFileSize*me,he=m?Se:D,I=m?Math.min(ue,D):ue;if(e.size>he)throw new Error("Data too large");let Pe=g(u,"register"),{data:N}=yield f(Pe,{query:{f:"json",itemName:xe(t),description:r},responseType:"json",method:"post"});if(p(o),!N.success)throw new Error("Registration failed");let{itemID:Te}=N.item;l=g(u,Te);let be=g(l,"uploadPart"),R=Math.ceil(e.size/I),b=new Array;for(let d=0;d<R;++d)b.push(e.slice(d*I,Math.min((d+1)*I,e.size)));let F=b.slice().reverse(),C=new Array,Fe=h(R,o?.onProgress,"uploadItem"),Ae=()=>c(this,null,function*(){for(;F.length!==0;){let d=b.length-F.length,A=F.pop(),v=new FormData,Ee=Fe.simulate(d,ce(A.size));try{v.append("f","json"),v.append("file",A),v.append("partId",`${d}`);let{data:Ie}=yield f(be,{timeout:0,body:v,responseType:"json",method:"post"});if(p(o),!Ie.success)throw new Error("Part upload failed")}finally{Ee.remove()}}});for(let d=0;d<je&&F.length!==0;++d)C.push(Ae());yield Promise.all(C);let ve=g(l,"commit"),{data:M}=yield f(ve,{query:{f:"json",parts:b.map((d,A)=>A).join(",")},responseType:"json",method:"post"});if(p(o),!M.success)throw new Error("Commit failed");return M.item}catch(u){if(l!=null){let y=g(l,"delete");yield f(y,{query:{f:"json"},responseType:"json",method:"post"})}throw u}})}function xe(e){return e.replaceAll("/","_").replaceAll("\\","_")}function br(e,t,r){return c(this,null,function*(){let s=e.length;if(!s)return r?.onProgress?.(1),[];let o=h(s,r?.onProgress,"uploadAssets");return Promise.all(e.map((n,a)=>Ue(n,t,T(P({},r),{onProgress:o.makeOnProgress(a)}))))})}function Ue(o,n,a){return c(this,arguments,function*(e,{layer:t,ongoingUploads:r},s){let i=r.get(e);if(i)return i;if(!Ke(t))throw new Z;if(De(e,t))return s?.onProgress?.(1),e;let l=Ne(e,t,s);r.set(e,l);try{yield l}finally{r.delete(e)}return e})}function De(e,t){let{parsedUrl:r}=t;return r!=null&&e.metadata.externalSources.some(s=>K(s,r))}function Ne(e,t,r){return c(this,null,function*(){let{metadata:s}=e,{displaySource:o}=s,n=de(o?.source,t,{checkForConversionRequired:S("enable-feature:georeferenced-uploads")}),a=n!=null?Re(n,t,r):s.externalSources.length>0?Ce(e,t,r):Me(e,t,r),i=yield a;return p(r),e.addExternalSources([i]),e})}function Re(e,t,r){return c(this,null,function*(){return{source:yield ge(e,t,r),original:!0,unitConversionDisabled:!0}})}function Ce(e,t,r){return c(this,null,function*(){let s=we(t),{externalSources:o}=e.metadata,n=ke(o,t);if(!n)throw new re;let a=h(E.uploadConvertibleSource,r?.onProgress,"uploadConvertibleSource"),i=yield ge(n,t,{onProgress:a.makeOnProgress("uploadEditSource")});e.addExternalSources([{source:i,original:!0}]);let l=n.reduce((y,{asset:w})=>w instanceof File?y+w.size:y,0),u=a.simulate("serviceAssetsToGlb",le(l));try{let{source:y,transform:w,origin:m}=yield Ge(i,t,s);return e.transform=w,m&&(e.metadata.georeferenced=!0,r?.useAssetOrigin&&(e.vertexSpace.origin=[m.x,m.y,m.z??0],e.spatialReference=m.spatialReference)),{source:y,unitConversionDisabled:!0}}finally{u.remove()}})}function Me(e,t,r){return c(this,null,function*(){let s=h(E.uploadLocalMesh,r?.onProgress,"uploadLocalMesh"),o=Oe(e,t,T(P({},r),{onProgress:s.makeOnProgress("meshToAssetBlob")}));return{source:yield ye([o],t,T(P({},r),{onProgress:s.makeOnProgress("uploadAssetBlobs")})),extent:e.extent.clone(),original:!0}})}function Oe(e,t,r){return c(this,null,function*(){let s=we(t),o=yield e.load(r),n=yield o.toBinaryGLTF({origin:o.origin,signal:r?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return p(r),{blob:new Blob([n],{type:"model/gltf-binary"}),assetName:`${L()}.glb`,assetType:s}})}function ke(e,t){for(let r of e){let s=de(r.source,t);if(s)return s}return null}function de(e,{infoFor3D:t},r={}){if(!e)return null;let{supportedFormats:s,editFormats:o}=t,n=V(e),a=new Array,i=_(t),l=W(t),u=!1;for(let y of n){let w=qe(y,s);if(!w)return null;let{assetType:m}=w;if(r.checkForConversionRequired&&(m===i||m===l))return null;o.includes(m)&&(u=!0),a.push(w)}return u?a:null}function qe(e,t){let r=Q(e,t);return r?{asset:e,assetType:r}:null}function ge(e,t,r){return c(this,null,function*(){return ye(e.map(s=>Be(s,r)),t,r)})}function ye(e,t,r){return c(this,null,function*(){let s=h(E.uploadAssetBlobs,r?.onProgress,"uploadAssetBlobs"),o=yield Le(e,t,T(P({},r),{onProgress:s.makeOnProgress("prepareAssetItems")}));p(r);let n=o.map(({item:i})=>i),{uploadResults:a}=yield He(n,t,T(P({},r),{onProgress:s.makeOnProgress("uploadAssetItems")}));return p(r),e.map((i,l)=>$e(o[l],a[l],t))})}function Be(e,t){return c(this,null,function*(){let{asset:r,assetType:s}=e;if(r instanceof File)return{blob:r,assetName:r.name,assetType:s};let o=yield r.toBlob(t);return p(t),{blob:o,assetName:r.assetName,assetType:s}})}function ze(e,t,r){return c(this,null,function*(){let{blob:s,assetType:o,assetName:n}=e,a=null;try{let i=yield fe({data:s,name:n},t.url,r);p(r),a={assetType:o,assetUploadId:i.itemID}}catch(i){k(i),Qe().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!a){let i=yield B(s);if(p(r),!i.isBase64)throw new te;a={assetType:o,assetData:i.data}}if(!a)throw new se;return{item:a,assetName:n}})}function Le(e,t,r){let s=h(e.length,r?.onProgress,"prepareAssetItems");return Promise.all(e.map((o,n)=>c(this,null,function*(){let a=ze(yield o,t,T(P({},r),{onProgress:s.makeOnProgress(n)}));return p(r),a})))}function He(e,t,r){return c(this,null,function*(){let s=ie(r?.onProgress);try{let o=yield f(g(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if(p(r),o.data.uploadResults.length!==e.length)throw new oe(e.length,o.data.uploadResults.length);return o.data}finally{s.remove()}})}function $e(e,t,r){let{success:s}=t;if(!s){let{error:u}=t;throw new ae(e.assetName,u)}let{assetHash:o}=t,{assetName:n,item:{assetType:a}}=e,{infoFor3D:{supportedFormats:i}}=r,l=G(a,i);if(!l)throw new U(a);return new j(n,l,[new x(`${r.parsedUrl.path}/assets/${o}`,o)])}function Ge(e,t,r){return c(this,null,function*(){let s=e.map(({assetName:n,parts:a})=>({assetName:n,assetHash:a[0].partHash})),o;try{let n=g(t.parsedUrl.path,"convert3D"),a=t.capabilities?.operations.supportsAsyncConvert3D;o=(yield(a?_e:We)(n,{query:{f:"json",assets:JSON.stringify(s),transportType:"esriTransportTypeUrl",targetFormat:r,async:a},responseType:"json",timeout:0})).data}catch{throw new ne}return Je(t,o)})}function Je(e,t){let r={source:t.assets.map(s=>{let o=$(s.contentType,e.infoFor3D.supportedFormats);if(!o)throw new U(o);return new j(s.assetName,s.contentType,[new x(s.assetURL,s.assetHash)])}),origin:void 0,transform:void 0};if(S("enable-feature:georeferenced-uploads")&&t.transform){if(r.transform=Y(t.transform),t.spatialReference){let s=H.fromJSON(t.spatialReference);r.origin=X(t.transform,s)}}else r.transform=pe(e.spatialReference);return r}function We(e,t){return f(e,t)}function _e(e,t){return c(this,null,function*(){let r=(yield f(e,t)).data.statusUrl;for(;;){let s=(yield f(r,{query:{f:"json"},responseType:"json"})).data;switch(s.status){case"Completed":return f(s.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(s.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}yield q(Ve)}})}function Ke(e){return!!e.infoFor3D&&!!e.url}function we({infoFor3D:e}){let t=J(e);if(!t)throw new ee;return t}function Qe(){return O.getLogger("esri.layers.graphics.sources.support.uploadAssets")}var Ve=1e3;export{br as uploadAssets};
