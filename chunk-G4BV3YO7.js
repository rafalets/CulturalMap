import{b as N}from"./chunk-QZT7QMTB.js";import{a as dt}from"./chunk-QW25UBG2.js";import{a as ct,b as E,c as Yt}from"./chunk-OSKPIRVE.js";import{a as Qt,b as ee}from"./chunk-2AZGC46B.js";import{a as Xt,c as te,d as oe}from"./chunk-HR4LHAHO.js";import{a as W}from"./chunk-3PSFVK5X.js";import{a as Jt}from"./chunk-A6AUN6JK.js";import{a as Bt}from"./chunk-OGTXAEI4.js";import{b as $t}from"./chunk-QXCWUIQ2.js";import{b as zt}from"./chunk-E6JHCD7G.js";import{a as st}from"./chunk-DIWV6SBV.js";import{a as Vt,b as qt,c as Nt,d as ht}from"./chunk-LK4L5XN7.js";import{a as lt}from"./chunk-BYX5KLGZ.js";import{n as Wt,p as Zt,t as Kt}from"./chunk-IOI3V6WL.js";import{e as $,h as V,j as pt,l as q}from"./chunk-IAM754TS.js";import{a as w}from"./chunk-DLMQHZTF.js";import{d as S}from"./chunk-5K5ZHVX6.js";import{a as jt}from"./chunk-7X55A7Q6.js";import{a as Ft}from"./chunk-ELQ6TEDY.js";import{e as xt,g as Ut,j as Lt,w as B}from"./chunk-WTJO2NGM.js";import{e as Rt,t as kt,z as L}from"./chunk-JR22Z7I2.js";import{b as Dt}from"./chunk-ZHUXSQTN.js";import{b as nt}from"./chunk-YLZWDFCJ.js";import{d as It}from"./chunk-TLMADEUL.js";import{m as Ct}from"./chunk-MDL4XPLR.js";import{c as Mt,g as At,h as j,r as Pt,t as Ht}from"./chunk-IB2IUO7T.js";import{a as rt}from"./chunk-E62WHYYG.js";import{N as Gt,p as Ot}from"./chunk-IG66NQHW.js";import{a as I,b as Tt,c as it,d as at,g as Et,i as U}from"./chunk-LB5YQINJ.js";import{b as ot}from"./chunk-EKMHQEJY.js";import{a as x}from"./chunk-VACZNAP3.js";import{e as St}from"./chunk-JKNCWG7E.js";import{L as bt,d as u}from"./chunk-C7INQGWT.js";import{H as k}from"./chunk-WMHJC7XF.js";import{B as wt,D as et,c as P,i as F,l as z,t as tt,u as Y,w as _t}from"./chunk-D2LVMNOU.js";import{a as h}from"./chunk-QGVBCWUY.js";import{r as vt,t as ft}from"./chunk-HHDFN2GK.js";import{a as v,b as M,f as g}from"./chunk-VTHXE323.js";function ae(t,e){return e==="freehandPolygon"||e==="freehandPolyline"?"freehand":t??(e==="rectangle"||e==="circle"?"hybrid":"click")}function re(t){switch(t){case"freehandPolygon":return"polygon";case"freehandPolyline":return"polyline";default:return t}}function _e(t){return!!t&&(t.type==="draw-2d"||t.type==="draw-3d")}var ie;(function(t){t[t.ForceCollapse=-1]="ForceCollapse",t[t.Low=0]="Low",t[t.Medium=10]="Medium",t[t.High=100]="High",t[t.Max=1e3]="Max"})(ie||(ie={}));function ne(t){return de(t).result}function de(t){if(t.graphic&&t.graphic.layer?.type!=="graphics")return{result:E.GRAPHICS_LAYER_MISSING};if(!t.operations)return{result:E.GEOMETRY_MISSING};if(Lt(t.elevationInfo))return{result:E.ELEVATION_MODE_UNSUPPORTED};let e=t.operations.data.type,o=t.operations.data.geometry;return e==="point"||e==="mesh"||e==="polyline"||e==="polygon"?{result:E.SUPPORTED,geometry:o}:{result:E.GEOMETRY_TYPE_UNSUPPORTED}}function se(t){if(t.layer?.type!=="graphics")return E.GRAPHICS_LAYER_MISSING;if(t.geometry==null)return E.GEOMETRY_MISSING;switch(t.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return E.SUPPORTED;default:return E.GEOMETRY_TYPE_UNSUPPORTED}let e=t.symbol!=null&&t.symbol.type==="point-3d"&&t.symbol.symbolLayers;return!e||!e.some(o=>o.type==="object")?E.SYMBOL_TYPE_UNSUPPORTED:xt(t)!=="on-the-ground"&&Ut(t)?E.ELEVATION_MODE_UNSUPPORTED:E.SUPPORTED}var A=class extends x.EventedMixin(bt){constructor(t){super(t),this.options=new N,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=R.MAIN}initialize(){this.addHandles([I(()=>{let{distance:t,touchSensitivityMultiplier:e,effectiveSelfEnabled:o,effectiveFeatureEnabled:i,effectiveGridEnabled:a}=this.options;return{selfEnabled:o,featureEnabled:i,gridEnabled:this.view.type==="2d"&&a,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:t,touchSensitivityMultiplier:e}},(t,e)=>{e&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=St(o=>this._updateEngines(t,e,o))},U),I(()=>this.options,t=>{for(let e of this._engines)e.options=t},Et)])}destroy(){this._loadTask?.abort(),this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach(t=>t.destroy()),this._engineCache.clear(),this._engines=[]}_updateEngines(t,e,o){return g(this,null,function*(){if(!t.viewReady)return void this._destroyEngines();e?.viewSpatialReference!==t.viewSpatialReference&&this._destroyEngines();let i=this._engineCache,a=yield Promise.allSettled([t.featureEnabled&&!i.has("feature")?this._createFeatureSnappingEngine(o):void 0,t.selfEnabled&&!i.has("self")?this._createSelfSnappingEngine(o):void 0,t.gridEnabled&&!i.has("grid")?this._createGridSnappingEngine(o):void 0]);if(o.aborted)for(let r of a)r.status==="fulfilled"&&r.value?.engine.destroy();else{for(let r of a)r.status==="fulfilled"&&r.value&&i.set(r.value.type,r.value.engine);this._engines=Array.from(i.values())}})}_createSelfSnappingEngine(t){return g(this,null,function*(){let{SelfSnappingEngine:e}=yield import("./chunk-CB7BBIA2.js");return Y(t),{type:"self",engine:new e({view:this.view,options:this.options})}})}_createGridSnappingEngine(t){return g(this,null,function*(){let{view:e}=this;if(e.type!=="2d")return;let{GridSnappingEngine:o}=yield import("./chunk-HWKDX7TB.js");return Y(t),{type:"grid",engine:new o({view:e,options:this.options})}})}_createFeatureSnappingEngine(t){return g(this,null,function*(){let{FeatureSnappingEngine:e}=yield import("./chunk-6GNTQ6HF.js");Y(t);let{view:o,options:i}=this,{spatialReference:a}=o;return{type:"feature",engine:new e({view:o,options:i,spatialReference:a})}})}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){let{distance:t,touchSensitivityMultiplier:e}=this.options,o=t*e;return o*o}snap(t){return me(t)?this._snapMultiPoint(t):this._snapSinglePoint(t)}update(t){let{point:e,context:o}=t;this._removeVisualization();let i=this._currentMainCandidate;if(i==null)return e;let a=this._selectUpdateInput(t);if(a==null)return e;let{spatialReference:r}=o,p=j(a,r);if(p==null)return e;let{view:n}=this,{elevationInfo:l,visualizer:s}=o,c=[],m=V(p,n,l),f=i.constraint.closestTo(m);if(!this._arePointsWithinScreenThreshold(m,f,o)||!yt(i,o.drawConstraints))return this._resetSnappingState(),e;i.targetPoint=$(f),c.push(...i.hints);for(let y of this._currentOtherActiveCandidates)yt(y,o.drawConstraints)&&(y.targetPoint=$(f),c.push(...y.hints));return s!=null&&this.addHandles(s.draw(c,{spatialReference:r,elevationInfo:ge(o),view:n,selfSnappingZ:o.selfSnappingZ}),ut),pt(f,n,e,o)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:t,scenePoint:e}){switch(this._currentSnappedType){case R.MAIN:return t;case R.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=R.MAIN}_removeVisualization(){this.removeHandles(ut)}_snapSinglePoint(i){return g(this,arguments,function*({point:t,context:e,signal:o}){let{view:a}=this,{elevationInfo:r}=e,p=V(t,a,r),n=yield this._fetchCandidates(p,q.ALL,e,o);return this._createSnapResult(p,R.MAIN,n,a,t,e,o)})}_snapMultiPoint(a){return g(this,arguments,function*({point:t,scenePoint:e,context:o,signal:i}){let{view:r}=this,{coordinateHelper:p,elevationInfo:n,spatialReference:l}=o;yield Ht(e.spatialReference,l);let s=j(e,l),c=V(s,r,n),m=yield this._fetchCandidates(c,q.FEATURE,o,i);if(m.length>0){let d=yield this._fetchCandidates(c,q.SELF,o,i);return this._createSnapResult(c,R.SCENE,[...m,...d],r,s,o,i)}let f=V(t,r,n),y=yield this._fetchCandidates(f,q.SELF,o,i);return this._createSnapResult(f,R.MAIN,y,r,{z:p.hasZ()&&t.hasZ?t.z??0:void 0,m:p.hasM()&&t.hasM?t.m??0:void 0},o,i)})}_fetchCandidates(t,e,o,i){return g(this,null,function*(){return(yield Promise.all(this._engines.map(a=>a.fetchCandidates(t,e,o,i)))).flat()})}_createSnapResult(t,e,o,i,a,r,p){return{get valid(){return!_t(p)},apply:()=>{let{spatialReference:n}=r,{snappedPoint:l,hints:s}=this._processCandidates(t,e,o,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(s,{spatialReference:n,elevationInfo:B,view:i,selfSnappingZ:r.selfSnappingZ}),ut),pt(l,i,a,r)}}}_processCandidates(t,e,o,i){if(o.length<1)return this.doneSnapping(),{snappedPoint:t,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Zt(t,o);let a=this._currentMainCandidate;if(a!=null){let r=ye(a,o);if(r>=0){if(!(o[r]instanceof W))return this._intersectWithOtherCandidates(r,o,t,e,i);if(this._arePointsWithinScreenThreshold(t,a.targetPoint,i))return this._updateSnappingCandidate(a,e,o,i)}}return this._intersectWithOtherCandidates(0,o,t,e,i)}_intersectWithOtherCandidates(t,e,o,i,a){let{coordinateHelper:r}=a,p=e[t],n=[];for(let l=0;l<e.length;++l){if(l===t)continue;let s=e[l],c=p.constraint.intersect(s.constraint);if(c)for(let m of c.closestPoints(p.targetPoint))n.push([new W($(m),p,s,s.isDraped),this._squaredScreenDistance(o,m,r)])}return n.length>0&&(n.sort((l,s)=>l[1]-s[1]),n[0][1]<this._squaredPointProximityThreshold(a.pointer))?this._updateSnappingCandidate(n[0][0],i,e,a):yt(p,a.drawConstraints)?this._updateSnappingCandidate(p,i,e,a):{snappedPoint:o,hints:[]}}_updateSnappingCandidate(t,e,o,i){this.doneSnapping(),this._currentMainCandidate=t,this._currentSnappedType=e;let a=this._currentMainCandidate.targetPoint,r=[];r.push(...t.hints);for(let p of o){if(t instanceof W){if(p.constraint.equals(t.first.constraint)||p.constraint.equals(t.second.constraint))continue}else if(p.constraint.equals(t.constraint))continue;let n=p.constraint.closestTo(a);this._squaredScreenDistance(n,a,i.coordinateHelper)<ue()&&(p.targetPoint=a,this._currentOtherActiveCandidates.push(p),r.push(...p.hints))}return{snappedPoint:a,hints:r}}_squaredPointProximityThreshold(t){return t==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(t,e,o){return this._squaredScreenDistance(t,e,o.coordinateHelper)<this._squaredPointProximityThreshold(o.pointer)}_squaredScreenDistance(t,e,o){return Wt(this._toScreen(t,o),this._toScreen(e,o))}_toScreen(t,e){return oe(t,e.spatialReference,B,this.view)}get test(){}},R;h([u({constructOnly:!0})],A.prototype,"view",void 0),h([u()],A.prototype,"options",void 0),h([u({readOnly:!0})],A.prototype,"updating",null),h([u()],A.prototype,"_loadTask",void 0),h([u()],A.prototype,"_engines",void 0),h([u()],A.prototype,"_squaredMouseProximityThreshold",null),h([u()],A.prototype,"_squaredTouchProximityThreshold",null),A=h([k("esri.views.interactive.snapping.SnappingManager")],A),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(R||(R={}));var ut="visualization-handle";function ue(){return lt.satisfiesConstraintScreenThreshold*lt.satisfiesConstraintScreenThreshold}function yt(t,e){return!e||e.direction==null&&e.distance==null||!(t instanceof Bt||t instanceof $t||t instanceof Jt||t instanceof Qt||t instanceof ee)&&(!(t instanceof Xt)||e.direction==null&&t.selfSnappingType===te.LastVertex)}function ye(t,e){return t instanceof W?mt(e,t.first)>=0&&mt(e,t.second)>=0?0:-1:mt(e,t)}function mt(t,e){let o=-1;for(let i=0;i<t.length;++i)if(e.constraint.equals(t[i].constraint)){o=i;break}return o}function me(t){return t.scenePoint!=null}function ge({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?B:e}var O=class extends x.EventedAccessor{constructor(t){super(t),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:this.activeComponent}return null}addToHistory(t){this.history.redo=[],this.history.undo.push(t)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this._reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}_reset(){this.activeComponent?.reset()}refreshComponent(){let t=this.activeComponent;t&&(t.type!=="box"&&t.type!=="reshape"&&t.type!=="graphic-mover"||t.refresh())}set undo(t){this._set("undo",()=>{this.canUndo()&&t()})}set redo(t){this._set("redo",()=>{this.canRedo()&&t()})}};h([u()],O.prototype,"activeComponent",void 0),h([u()],O.prototype,"cancelled",void 0),h([u()],O.prototype,"history",void 0),h([u()],O.prototype,"tool",null),h([u()],O.prototype,"type",void 0),h([u()],O.prototype,"canUndo",null),h([u()],O.prototype,"canRedo",null),h([u()],O.prototype,"onEnd",void 0),h([u()],O.prototype,"undo",null),h([u()],O.prototype,"redo",null),h([u()],O.prototype,"toggleTool",void 0),h([u()],O.prototype,"addToSelection",void 0),h([u()],O.prototype,"removeFromSelection",void 0),O=h([k("esri.widgets.Sketch.support.OperationHandle")],O);var Z=class extends O{};h([u()],Z.prototype,"activeComponent",void 0),Z=h([k("esri.widgets.Sketch.support.OperationHandle.CreateOperationHandle")],Z);var H=class extends O{};h([u()],H.prototype,"activeComponent",void 0),H=h([k("esri.widgets.Sketch.support.OperationHandle.UpdateOperationHandle")],H);var pe={defaultZ:0},K={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,highlightOptions:{enabled:!0},tool:"transform"},_=class extends x.EventedAccessor{constructor(t){super(t),this._defaultSnappingManager=null,this._updatingHandles=new jt,this._internalGraphicsLayer=new Ft({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandlesKey="viewHandles",this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new nt({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new Dt({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new It({color:[130,130,130,1],width:2}),this.meshSymbol=new kt({symbolLayers:new ot([new Rt])}),this.updateGraphics=new ot,this.updateOnGraphicClick=!0,this.creationMode="single",this.vertexSymbol=new nt({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.sketchOptions=new ht,this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._sketchContinuationFlag=!1,this._originalPopupEnabled=null,this.defaultCreateOptions=pe,this.defaultUpdateOptions=K,this.snappingOptions=t?.snappingManager?.options??t?.snappingOptions??new N}initialize(){this.addHandles([it(()=>this.view?.map?.layers,"change",t=>{t.removed.includes(this.layer)&&this.cancel()}),it(()=>this.layer?.graphics,"change",t=>{if(this._operationHandle!=null)for(let e of t.removed)this.updateGraphics.includes(e)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(e):this._operationHandle.cancel())}),I(()=>this.layer?.elevationInfo??null,t=>{t!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=t)},U),I(()=>this.view,t=>{this._defaultSnappingManager=F(this._defaultSnappingManager),t&&(this.snappingManager||(this._defaultSnappingManager=new A({view:t,options:this.snappingOptions})),t.type==="2d"?import("./chunk-EYMEMIHS.js"):t.type==="3d"&&(import("./chunk-ZOJWWDUO.js"),import("./chunk-BUUHZ2TG.js")))},U),I(()=>this.view?.spatialReference,(t,e)=>{t&&e&&!t.equals(e)&&this.cancel()})]),Kt(this)}destroy(){this.cancel(),this._removeDefaultLayer(),this._defaultSnappingManager=F(this._defaultSnappingManager),this._set("snappingManager",null),this._set("view",null),this._updatingHandles.destroy(),this.emit("destroy")}get updating(){return this._updatingHandles.updating||this.snappingManager!=null&&this.snappingManager.updating}get activeTool(){return this._operationHandle?.tool??null}get activeCreateToolDrawMode(){return this._operationHandle?.type==="create"&&this._operationHandle.activeComponent&&"mode"in this._operationHandle.activeComponent?this._operationHandle.activeComponent.mode:null}get activeTooltip(){let{activeComponent:t,destroyed:e}=this,o=!e&&t&&"tooltip"in t?t.tooltip:null;return o?.visible?o:null}get activeComponent(){return this._operationHandle?.activeComponent??null}get createGraphic(){return this.activeComponent==null||this.activeComponent.type!=="draw-3d"&&this.activeComponent.type!=="draw-2d"?this._get("createGraphic"):this.activeComponent.graphic}get defaultCreateOptions(){return this._get("defaultCreateOptions")}set defaultCreateOptions(t){this._set("defaultCreateOptions",v(v({},pe),t))}get defaultUpdateOptions(){return this._get("defaultUpdateOptions")}set defaultUpdateOptions(t){this._set("defaultUpdateOptions",M(v(v({},K),t),{reshapeOptions:v(v({},K.reshapeOptions),t?.reshapeOptions),highlightOptions:v(v({},K.highlightOptions),t?.highlightOptions)}))}get labelOptions(){return this.sketchOptions.labels}set labelOptions(t){this.sketchOptions.labels=t}get snappingOptions(){return this.snappingManager?.options??this._get("snappingOptions")}set snappingOptions(t){this._defaultSnappingManager!=null&&(this._defaultSnappingManager.options=t),this._set("snappingOptions",t)}get snappingManager(){return this._isOverridden("snappingManager")&&this._get("snappingManager"),this._defaultSnappingManager}set snappingManager(t){if(t)this._isOverridden("snappingManager")||(this._defaultSnappingManager=F(this._defaultSnappingManager)),this._override("snappingManager",t);else{let{view:e}=this;!this._defaultSnappingManager&&e&&(this._defaultSnappingManager=new A({options:this.snappingOptions,view:e})),this._clearOverride("snappingManager")}}get state(){let t=!(!this.view?.ready||!this.layer),e=this._operationHandle;return t&&e?"active":t?"ready":"disabled"}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(t){this.sketchOptions.tooltips=t}get valueOptions(){return this.sketchOptions.values}set valueOptions(t){this.sketchOptions.values=t}get view(){return this._get("view")}set view(t){let e=this._get("view");if(e){let{container:i,map:a}=e;i&&(e.cursor=null),a?.remove(this._internalGraphicsLayer),this.removeHandles(this._viewHandlesKey),this.cancel()}let o="view-ready";this.removeHandles(o),t&&this.addHandles(Tt(()=>t.ready,i=>{this.removeHandles(this._viewHandlesKey),i&&this.addHandles(this._generateViewHandles(t),this._viewHandlesKey)},U),o),this._set("view",t)}cancel(){this._moduleLoaderAbortController=z(this._moduleLoaderAbortController),this._viewReadyAbortController=z(this._viewReadyAbortController),this._sketchContinuationFlag=!0,this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){let{state:t,updateGraphics:e}=this;if(t==="active"&&e.length){let{activeTool:o,layer:i}=this,a=e.toArray();i.removeMany(a),this.cancel(),this._emitDeleteEvent({graphics:a,tool:o})}}duplicate(){if(this.state==="active"&&this.updateGraphics.length){let t=this.updateGraphics.map(e=>e.clone()).toArray();return this.layer.addMany(t),this.emit("duplicate",{graphics:t,type:"duplicate"}),t}return[]}create(t,e){return g(this,null,function*(){this.cancel(),yield this._waitViewReady();let{view:o,layer:i}=this;if(!o||this.state==="disabled")throw i||this._logMissingLayer(),tt();if(o.activeTool!=null&&(o.activeTool=null),!t)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");dt(o,this._internalGraphicsLayer);let a=yield this._updatingHandles.addPromise(this._setupCreateOperation(t,e));if(a==null||this.destroyed)return void o.map.remove(this._internalGraphicsLayer);let r=()=>{if(a===this._operationHandle){let p=this.createGraphic,n=this._operationHandle.cancelled;if(this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view?.map&&this.view.map.remove(this._internalGraphicsLayer),a.cancelled||p==null||i.add(p),this._sketchContinuationFlag=!1,this.emit("create",{graphic:p,state:n?"cancel":"complete",tool:t,toolEventInfo:null,type:"create"}),n||this._sketchContinuationFlag)return;let{creationMode:l}=this;if(l==="continuous"){if(e?.geometryToPlace)return;this._updatingHandles.addPromise(et(this.create(t,e)))}else l==="update"&&p&&this._updatingHandles.addPromise(et(this.update([p])))}};a.on("complete",r),this._operationHandle=a,o.ready&&o.focus()})}place(t,e){return g(this,null,function*(){return this.create("mesh",v({mode:"click",hasZ:t.hasZ,geometryToPlace:t},e))})}update(t,e){return g(this,null,function*(){this.cancel(),yield this._waitViewReady();let{layer:o,view:i,state:a}=this;if(!i||a==="disabled")throw o||this._logMissingLayer(),tt();i.activeTool!=null&&(i.activeTool=null);let r=Array.isArray(t)?t:[t];if(t==null||!r?.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(r.some(n=>n.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):n.geometry==null&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0)))return;let p=yield this._updatingHandles.addPromise(this._setupUpdateOperation(r,e));this.destroyed||p==null||T(p)||(dt(i,this._internalGraphicsLayer),this._setUpdateOperationHandle(p,e),this.emit("update",{graphics:r,state:"start",aborted:!1,tool:p.tool,toolEventInfo:null,type:"update"}))})}_updateSpatialReference(t){return g(this,null,function*(){let e=this.view;if(e){t=Array.isArray(t)?t:[t];for(let o of t)o.geometry==null||o.geometry.type==="mesh"||Ot(o.geometry.spatialReference,e.spatialReference)||(Pt(o.geometry.spatialReference,e.spatialReference)||Mt()||(yield At()),o.geometry=j(o.geometry,e.spatialReference))}else this._logMissingView()})}undo(){this.canUndo()&&this._operationHandle?.undo()}redo(){this.canRedo()&&this._operationHandle?.redo()}canUndo(){return!!this._operationHandle?.canUndo()}canRedo(){return!!this._operationHandle?.canRedo()}toggleUpdateTool(){this._operationHandle?.toggleTool()}_getFirstHit(t){return g(this,null,function*(){let e=this.view;if(!e)return this._logMissingView(),null;if(e.type==="2d"){let a=[];e.map.allLayers.forEach(p=>{p.type!=="vector-tile"&&p.type!=="imagery"||a.push(p)});let r=yield e.hitTest(t,{exclude:a});return zt(r.results)}let o=[e.map.ground];e.map.allLayers.forEach(a=>{Ct(a.type)&&o.push(a)});let i=yield e.hitTest(t,{exclude:o});if(i.results.length>0){let a=i.results[0];if(a!=null&&a.type==="graphic"&&a.graphic&&(!i.ground.mapPoint||e.map.ground.opacity<1||i.ground.distance-(a.distance??0)>-Math.min(3*i.ground.distance,e.viewingMode==="global"?Gt(e.renderCoordsHelper.spatialReference).radius/e.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY)))return a}return null})}_generateViewHandles(t){return[t.on("immediate-click",e=>g(this,null,function*(){let o=this.state==="active"&&this._operationHandle?.type==="create";this.state!=="disabled"&&!o&&this.updateOnGraphicClick&&(yield this._updatingHandles.addPromise(this._handleImmediateClick(e)))}),S.WIDGET)]}_handleImmediateClick(t){return g(this,null,function*(){let e=yield t.async(()=>this._getFirstHit(st(t))),o=null;if(e!=null){let i=e.graphic;this.updateGraphics.includes(i)||i.layer===this.layer?(t.stopPropagation(),o=i):this.view?.type!=="2d"||this._isComponentGraphic(i)||this.state!=="active"||this.cancel()}else this.state==="active"&&this.cancel();o==null||this.updateGraphics.includes(o)||(yield this.update([o],M(v({},this.defaultUpdateOptions),{reshapeOptions:v({},this.defaultUpdateOptions.reshapeOptions)})))})}_setupCreateOperation(t,e){return g(this,null,function*(){let o=this.view;if(!o)return this._logMissingView(),null;let i=v(v({hasZ:o.type==="3d"},this.defaultCreateOptions),e),a=yield this._setupDrawGraphicTool(t,o,i);return a==null?null:(o.tools.add(a),o.activeTool=a,this._setupCreateOperationHandle(a))})}_setupDrawGraphicTool(t,e,o){return g(this,null,function*(){if(t==="multipoint"&&e.type==="3d")return this._logError("sketch:create","Multipoint geometries are not supported in SceneView."),null;if(!e)return this._logMissingView(),null;let{cursor:i,defaultZ:a,hasZ:r,geometryToPlace:p,graphicProperties:n,mode:l,preserveAspectRatio:s}=o,c=ae(l,t),m=re(t),f=o?.optionsPerTool?.has(t)?o.optionsPerTool.get(t):{},y=f?.preserveAspectRatio??s??t!=="rectangle",d=v({centered:t!=="rectangle"&&!(t==="circle"&&!y),cursor:i,defaultZ:a,forceUniformSize:y,graphicProperties:M(v({},n),{attributes:v({},n?.attributes)}),geometryToPlace:p,geometryType:m,mode:c,graphicSymbol:this._getGraphicSymbolFromTool(t),hasZ:r,snappingManager:this.snappingManager,snapToScene:!1,view:e},f);return e.type==="2d"?this._makeDrawGraphicTool2D(d):this._makeDrawGraphicTool3D(d)})}_makeDrawGraphicTool2D(t){return g(this,null,function*(){let e=yield this._requireModule(import("./chunk-EYMEMIHS.js"));return T(e)||this.destroyed?null:new e.module.DrawGraphicTool2D(M(v({},t),{activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:fe(t.geometryType)?this.activeFillSymbol:null,sketchOptions:this.sketchOptions}))})}_makeDrawGraphicTool3D(t){return g(this,null,function*(){let e=yield this._requireModule(import("./chunk-ZOJWWDUO.js"));if(T(e)||this.destroyed)return null;let{elevationInfo:o}=this.layer;return new e.module.DrawGraphicTool3D(M(v({},t),{elevationInfo:o,snapToScene:!0,sketchOptions:this.sketchOptions}))})}_setupCreateOperationHandle(t){let e=this.view;if(!e)return this._logMissingView(),null;let o=null,i=t.forceUniformSize,a=t.centered,r=[e.on("key-down",n=>{if(n.key===w.pan)n.stopPropagation(),n.repeat||(t.enabled=!1);else if(n.key===w.complete)n.stopPropagation(),t.completeCreateOperation();else if(n.key!==w.vertexAdd||n.repeat)n.key===w.undo?(n.stopPropagation(),p.undo()):n.key===w.redo?(n.stopPropagation(),p.redo()):n.key!==w.constraint||t.geometryType!=="rectangle"&&t.geometryType!=="circle"||n.repeat?n.key===w.center&&(n.repeat||(t.centered=!a,n.stopPropagation())):(t.forceUniformSize=!i,n.stopPropagation());else{let l=t.drawOperation.geometryType;l!=="polyline"&&l!=="polygon"&&l!=="multipoint"||(n.stopPropagation(),t.drawOperation.commitStagedVertex())}},S.WIDGET),e.on("key-up",n=>{n.key===w.pan?t.enabled=!0:n.key!==w.constraint||t.geometryType!=="rectangle"&&t.geometryType!=="circle"?n.key===w.center&&(t.centered=a,n.stopPropagation()):(t.forceUniformSize=i,n.stopPropagation())},S.WIDGET),t.on("vertex-add",n=>{switch(o=o==null?"start":"active",n.operation){case"apply":this.emit("create",{graphic:t.graphic,state:o,tool:this.activeTool,toolEventInfo:n,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[t.graphic],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[t.graphic],tool:t.geometryType})}}),t.on("cursor-update",n=>{t.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:t.graphic,state:"active",tool:this.activeTool,toolEventInfo:{coordinates:n.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),t.on("vertex-remove",n=>{switch(n.operation){case"apply":this.emit("create",{graphic:t.graphic,state:"active",tool:this.activeTool,toolEventInfo:n,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[t.graphic],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[t.graphic],tool:t.geometryType})}}),t.on("complete",n=>{this._set("createGraphic",n.graphic),o="complete",n.aborted?p&&p.cancel():p&&p.complete()}),I(()=>this._getGraphicSymbolFromTool(t.geometryType),n=>{t.graphicSymbol=n})],p=new Z({activeComponent:t,tool:t.geometryType,type:"create",onEnd:()=>{P(r),e.tools?.remove(t)},undo:()=>{t.canUndo&&t.undo()},redo:()=>{t.canRedo&&t.redo()},canUndo:()=>t.canUndo,canRedo:()=>t.canRedo});return p}_getGraphicSymbolFromTool(t){switch(t){case"point":case"multipoint":return this.pointSymbol;case"polyline":case"freehandPolyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":case"freehandPolygon":return this.polygonSymbol;case"mesh":return this.meshSymbol}}_setupUpdateOperation(t,e){return g(this,null,function*(){let{layer:o,view:i}=this;if(!i)return this._logMissingView(),null;let a=M(v(v({},this.defaultUpdateOptions),e),{reshapeOptions:v(v({},this.defaultUpdateOptions.reshapeOptions),e?.reshapeOptions),highlightOptions:v(v({},this.defaultUpdateOptions.highlightOptions),e?.highlightOptions)}),r=a.tool??K.tool;for(let p of t)o.remove(p),o.add(p);if(i.type==="3d"){if(t.length===0)return null;switch(r){case"move":return this._setupMove3DOperation(t,a,i,r);case"reshape":return t.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupReshape3DOperation(t[0],a,i);case"transform":return this._setupGraphicTransform3DOperation(t,a,i)}}switch(r){case"move":return this._setupMove2DOperation(t,a,i);case"reshape":return t.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshape2DOperation(t,r,a,i);case"transform":if(t.length===1){let p=t[0].geometry?.type;p!=="point"&&p!=="multipoint"||(r="reshape")}return this._setupTransformOrReshape2DOperation(t,r,a,i)}})}_setupMove3DOperation(t,e,o,i,a=!1){return g(this,null,function*(){let r=yield this._requireModule(import("./chunk-ZOJWWDUO.js"));if(T(r))return r;let{ManipulatedObject3DGraphic:p,MoveTool3D:n}=r.module,l=new Map,s=()=>{l.forEach(y=>y.destroy()),l.clear()};for(let y of t){let d=new p({view:o,graphic:y}),G=Yt(d);if(G!==E.SUPPORTED)return s(),this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${ct(G)}).`),null;l.set(y,d)}let c=new n({view:o,enableZ:e.enableZ,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});o.tools.add(c),c.objects.addMany(Array.from(l.values())),a||this.updateGraphics.addMany(t);let m=[],f=new H({activeComponent:c,tool:i,type:"update",onEnd:()=>{P(m),X(o,c),s()},undo:()=>{he(this.view,c),J(f,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{Q(f,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:y=>{this.updateGraphics.push(y);let d=new p({view:o,graphic:y});l.set(y,d),c.objects.push(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[y],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:y=>{let d=this.updateGraphics.indexOf(y);if(f.history.undo.forEach(C=>C.updates.splice(d,1)),f.history.redo.forEach(C=>C.updates.splice(d,1)),this.updateGraphics.remove(y),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[y],type:"selection-change"},type:"update"}),this.updateGraphics.length===0)return void f.complete();let G=l.get(y);G&&(c.objects.remove(G),G.destroy(),l.delete(y))},toggleTool:()=>g(this,null,function*(){if(this.updateGraphics.length!==1||e.toggleToolOnClick===!1||i!=="transform")return;let y=this.updateGraphics.at(0),d=yield this._setupReshape3DOperation(y,e,o,!0);d&&!T(d)&&(f.onEnd(),f.destroy(),this._setUpdateOperationHandle(d,e))})});return m.push(...this._getHandlesForComponent(f,e),o.on("immediate-click",y=>this._getCommonUpdateOperationClickHandlers(f,y,e),S.WIDGET),o.on("key-down",y=>{this._getCommonUpdateOperationKeyDownHandlers(f,y)},S.WIDGET)),f})}_setupGraphicTransform3DOperation(t,e,o,i=!1){if(t.length===1&&se(t[0])===E.SUPPORTED){let a=t[0],r=a.geometry;if(r!=null&&(r.type==="point"||r.type==="mesh"))return this._setupPointTransform3DOperation(a,e,o);if(r!=null&&(r.type==="polygon"||r.type==="polyline"))return this._setupPolyTransform3DOperation(a,e,o,i)}return this._setupMove3DOperation(t,e,o,"transform",i)}_setupPointTransform3DOperation(t,e,o){return g(this,null,function*(){let i="transform",{enableRotation:a,enableScaling:r,enableZ:p}=e,n=yield this._requireModule(import("./chunk-ZOJWWDUO.js"));if(T(n))return n;let{TransformTool3D:l,ManipulatedObject3DGraphic:s}=n.module,c=new s({graphic:t,view:o}),m=new l({object:c,view:o,enableRotation:a,enableScaling:r,enableZ:p,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});o.tools.add(m),this.updateGraphics.add(t);let f=[],y=new H({activeComponent:m,tool:i,type:"update",onEnd:()=>{P(f),X(o,m),c.destroy()},undo:()=>{he(this.view,m),J(y,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{Q(y,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:d=>g(this,null,function*(){this.updateGraphics.add(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[d],removed:[],type:"selection-change"},type:"update"}),y.onEnd(),y.destroy();let G=yield this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);T(G)||this._setUpdateOperationHandle(G,e)}),removeFromSelection:d=>{this.updateGraphics.remove(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[d],type:"selection-change"},type:"update"}),y.complete()},toggleTool:()=>{}});return f.push(...this._getHandlesForComponent(y,e),o.on("immediate-click",d=>this._getCommonUpdateOperationClickHandlers(y,d,e),S.WIDGET),o.on("key-down",d=>{this._getCommonUpdateOperationKeyDownHandlers(y,d)},S.WIDGET)),y})}_setupPolyTransform3DOperation(t,e,o,i=!1){return g(this,null,function*(){let a="transform",{enableRotation:r,enableScaling:p,enableZ:n,preserveAspectRatio:l}=e,s=yield this._requireModule(import("./chunk-ZOJWWDUO.js"));if(T(s))return s;let{ManipulatedObject3DGraphic:c,ExtentTransformTool:m}=s.module,f=this.view?.inputManager?.isModifierKeyDown(w.constraint),y=new c({view:o,graphic:t}),d=new m({object:y,view:o,enableRotation:r,enableScaling:p,enableZ:n,preserveAspectRatio:!!l!=!!f,sketchOptions:this.sketchOptions});o.tools.add(d),i||this.updateGraphics.add(t);let G=[],C=new H({activeComponent:d,tool:a,type:"update",onEnd:()=>{P(G),X(o,d),y.destroy()},canUndo:()=>!d.destroyed&&d.canUndo,undo:()=>{d.destroyed||(d.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},canRedo:()=>!d.destroyed&&d.canRedo,redo:()=>{d.destroyed||(d.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},addToSelection:b=>g(this,null,function*(){this.updateGraphics.add(b),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[b],removed:[],type:"selection-change"},type:"update"}),C.onEnd(),C.destroy();let gt=yield this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);T(gt)||this._setUpdateOperationHandle(gt,e)}),removeFromSelection:b=>{this.updateGraphics.remove(b),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[b],type:"selection-change"},type:"update"}),C.complete()},toggleTool:()=>g(this,null,function*(){if(this.updateGraphics.length!==1||e.toggleToolOnClick===!1)return;let b=yield this._setupReshape3DOperation(t,e,o,!0);b&&!T(b)&&(C.onEnd(),C.destroy(),this._setUpdateOperationHandle(b,e))})});return G.push(...this._getHandlesForComponent(C,e),o.on("immediate-click",b=>this._getCommonUpdateOperationClickHandlers(C,b,e),S.WIDGET),o.on("key-down",b=>this._getCommonUpdateOperationKeyDownHandlers(C,b),S.WIDGET),o.on("key-down",b=>{b.key!==w.constraint||b.repeat||(d.preserveAspectRatio=!d.preserveAspectRatio,b.stopPropagation())},S.WIDGET),o.on("key-up",b=>{b.key===w.constraint&&(d.preserveAspectRatio=!d.preserveAspectRatio,b.stopPropagation())},S.WIDGET)),C})}_setupMove2DOperation(t,e,o){return g(this,null,function*(){let i="move";this.updateGraphics.addMany(t),yield this._updatingHandles.addPromise(this._updateSpatialReference(t));let a=yield this._getGraphicMover(t,e,o);if(T(a))return a;let r=new H({activeComponent:a,tool:i,type:"update",onEnd:()=>{this._displayDefaultCursor(),P(l),P(n),a.destroy(),this._internalGraphicsLayer?.removeMany([...this.updateGraphics.toArray()])},undo:()=>{let s=this.updateGraphics.toArray();J(r,s),r.refreshComponent(),this._emitUndoEvent({graphics:s,tool:i})},redo:()=>{let s=this.updateGraphics.toArray();Q(r,s),r.refreshComponent(),this._emitRedoEvent({graphics:s,tool:i})},addToSelection:s=>g(this,null,function*(){yield this._updatingHandles.addPromise(this._updateSpatialReference(s)),this.updateGraphics.push(s),a.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[s],removed:[],type:"selection-change"},type:"update"})}),removeFromSelection:s=>{let c=this.updateGraphics.indexOf(s);r.history.undo.forEach(f=>f.updates.splice(c,1)),r.history.redo.forEach(f=>f.updates.splice(c,1)),this.updateGraphics.remove(s);let m=this.updateGraphics.toArray();this.emit("update",{graphics:m,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[s],type:"selection-change"},type:"update"}),this.updateGraphics.length!==0?a.graphics=m:r.complete()}}),p=!1,n=[o.on("immediate-click",s=>this._getCommonUpdateOperationClickHandlers(r,s,e),S.WIDGET),o.on("key-down",s=>{this._getCommonUpdateOperationKeyDownHandlers(r,s),s.key!==w.constraint||s.repeat||(p=!0,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},S.WIDGET),o.on("key-up",s=>{s.key===w.constraint&&p&&(p=!1,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},S.WIDGET)],l=this._getHandlesForComponent(r,e);return r})}_setupReshape3DOperation(t,e,o,i=!1){return g(this,null,function*(){let a="reshape",r=yield this._requireModule(import("./chunk-ZOJWWDUO.js"));if(T(r))return r;let{ManipulatedObject3DGraphic:p,ReshapeTool3D:n}=r.module,l=new p({view:o,graphic:t}),s=ne(l);if(s!==E.SUPPORTED)return l.destroy(),this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${ct(s)}).`),null;let c=e.reshapeOptions,m=new n({view:o,object:l,enableZVertex:e.enableZ&&c?.vertexOperation==="move",enableZShape:e.enableZ&&c?.shapeOperation==="move",enableMoveObject:c?.shapeOperation==="move"||c?.shapeOperation==="move-xy",enableMidpoints:c?.edgeOperation==="split",enableEdgeOffset:c?.edgeOperation==="offset",snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});o.tools.add(m),i||this.updateGraphics.add(l.graphic);let f=[],y=new H({activeComponent:m,tool:a,type:"update",onEnd:()=>{P(f),X(o,m),l.destroy()},canUndo:()=>!m.destroyed&&m.canUndo,undo:()=>{m.destroyed||(m.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},canRedo:()=>!m.destroyed&&m.canRedo,redo:()=>{m.destroyed||(m.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},addToSelection:d=>g(this,null,function*(){this.updateGraphics.add(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[d],removed:[],type:"selection-change"},type:"update"}),y.onEnd(),y.destroy();let G=yield this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);T(G)||this._setUpdateOperationHandle(G,e)}),removeFromSelection:d=>{this.updateGraphics.remove(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[d],type:"selection-change"},type:"update"}),y.complete()},toggleTool:()=>g(this,null,function*(){if(e.toggleToolOnClick===!1)return;y.onEnd(),y.destroy();let d=yield this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),e,o,!0);T(d)||this._setUpdateOperationHandle(d,e)})});return f.push(...this._getHandlesForComponent(y,e),o.on("immediate-click",d=>this._getCommonUpdateOperationClickHandlers(y,d,e),S.WIDGET),o.on("key-down",d=>{this._getCommonUpdateOperationKeyDownHandlers(y,d)},S.WIDGET)),y})}_setupTransformOrReshape2DOperation(t,e,o,i){return g(this,null,function*(){this.updateGraphics.addMany(t),yield this._updatingHandles.addPromise(this._updateSpatialReference(t));let a=e==="transform"?yield this._getBox(t,o,i):yield this._getReshape(t,o,i);if(T(a))return a;let r=new H({activeComponent:a,type:"update",onEnd:()=>{P(n),P(p),r.activeComponent&&!r.activeComponent.destroyed&&r.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{J(r,this.updateGraphics.toArray()),r.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r.tool})},redo:()=>{Q(r,this.updateGraphics.toArray()),r.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r.tool})},addToSelection:l=>g(this,null,function*(){let s=r.activeComponent;if(s?.type==="reshape"){let c=[...this.updateGraphics,l];this.updateGraphics.removeAll(),r.onEnd(),r.destroy();let m=yield this._setupTransformOrReshape2DOperation(c,"transform",o,i);if(T(m))return;this._setUpdateOperationHandle(m,o)}else this.updateGraphics.add(l),s.graphics=this.updateGraphics.toArray(),s.refresh(),r.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[l],removed:[],type:"selection-change"},type:"update"})}),removeFromSelection:l=>g(this,null,function*(){let s=this.updateGraphics.indexOf(l);r.history.undo.forEach(m=>m.updates.splice(s,1)),r.history.redo.forEach(m=>m.updates.splice(s,1)),this.updateGraphics.remove(l);let c=this.updateGraphics.toArray();if(c.length===0)r.complete();else{let m=c[0].geometry;c.length!==1||m==null||m.type!=="point"&&m.type!=="multipoint"?r.activeComponent.graphics=c:r.toggleTool()}this.emit("update",{graphics:c,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[l],type:"selection-change"},type:"update"})}),toggleTool:()=>g(this,null,function*(){if(this.updateGraphics.length>1)return;let l=this.updateGraphics.at(0),s=l.geometry;if(s!=null&&(r.tool==="reshape"&&(s.type==="point"||s.type==="multipoint")||r.tool==="transform"&&s.type==="extent"))return;let c=null;r.tool==="transform"?c=yield this._getReshape([l],o,i):r.tool==="reshape"&&(c=yield this._getBox([l],o,i)),T(c)||(r.activeComponent?.destroy(),r.activeComponent=c,r.activeComponent&&(P(n),n=this._getHandlesForComponent(r,o)))})}),p=[i.on("immediate-click",l=>this._getCommonUpdateOperationClickHandlers(r,l,o),S.WIDGET),i.on("key-down",l=>{if(this._getCommonUpdateOperationKeyDownHandlers(r,l),l.key===w.constraint&&!l.repeat&&r){let s=r.activeComponent;s&&s.type==="box"&&(s.preserveAspectRatio=!s.preserveAspectRatio)}},S.WIDGET),i.on("key-up",l=>{if(l.key===w.constraint&&r){let s=r.activeComponent;s&&s.type==="box"&&(s.preserveAspectRatio=!s.preserveAspectRatio)}},S.WIDGET)],n=this._getHandlesForComponent(r,o);return r})}_getGraphicMover(t,e,o){return g(this,null,function*(){let{enableMoveAllGraphics:i,highlightOptions:a}=e,r=yield this._requireModule(import("./chunk-THNXA7WD.js"));return T(r)?r:new r.module.default({enableMoveAllGraphics:i,highlightsEnabled:!!a?.enabled,indicatorsEnabled:!1,graphics:t,view:o,callbacks:{onGraphicMoveStart:({dx:p,dy:n,graphic:l})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:p,dy:n,mover:l,type:"move-start"},type:"update"})},onGraphicMove:({dx:p,dy:n,graphic:l})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:p,dy:n,mover:l,type:"move"},type:"update"}),onGraphicMoveStop:({dx:p,dy:n,graphic:l})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:p,dy:n,mover:l,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})})}_getBox(t,e,o){return g(this,null,function*(){let{enableRotation:i,enableScaling:a,highlightOptions:r,preserveAspectRatio:p}=e,n=yield this._requireModule(import("./chunk-OGCX4CUZ.js"));if(T(n))return n;let l=this.view?.inputManager?.isModifierKeyDown(w.constraint);return new n.module.default({graphics:t,enableRotation:i,enableScaling:a,highlightsEnabled:!!r?.enabled,preserveAspectRatio:!!p!=!!l,layer:this._internalGraphicsLayer,view:o,sketchOptions:this.sketchOptions,callbacks:{onMoveStart:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onMove:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onMoveStop:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onScaleStart:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onScale:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onScaleStop:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onRotateStart:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onRotate:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"}),onRotateStop:s=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},s),type:"update"})}})})}_getReshape(t,e,o){return g(this,null,function*(){let i=e.reshapeOptions?.edgeOperation==="split",a=e.reshapeOptions?.shapeOperation==="move",r=!!e.highlightOptions?.enabled,p=yield this._requireModule(import("./chunk-EJR4ARZ5.js"));return T(p)?p:new p.module.default({enableMidpoints:i,enableMovement:a,graphic:t[0],highlightsEnabled:r,layer:this._internalGraphicsLayer,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions,view:o,callbacks:{onReshapeStart:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},n),type:"update"}),onReshape:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:v({},n),type:"update"}),onReshapeStop:({mover:n,type:l})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:n,type:l},type:"update"}),onMoveStart:({dx:n,dy:l,mover:s,type:c})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:n,dy:l,mover:s,type:c},type:"update"}),onMove:({dx:n,dy:l,mover:s,type:c})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:n,dy:l,mover:s,type:c},type:"update"}),onMoveStop:({dx:n,dy:l,mover:s,type:c})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:n,dy:l,mover:s,type:c},type:"update"}),onVertexAdd:({added:n,type:l,vertices:s})=>{let c=n.map(m=>rt(m.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:c,vertices:s,type:l},type:"update"})},onVertexRemove:({removed:n,type:l,vertices:s})=>{let c=n.map(m=>rt(m.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:c,vertices:s,type:l},type:"update"})}}})})}_getHandlesForComponent(t,e){let o=t.activeComponent;if(!o)return[];switch(o.type){case"graphic-mover":return[o.on("graphic-click",({graphic:i,viewEvent:a})=>{a.native?.shiftKey&&(a.stopPropagation(),t.removeFromSelection(i))}),o.on("graphic-move-start",i=>t.addToHistory(D(i.allGraphics)))];case"box":return[o.on("graphic-click",i=>this._onTransformOrReshape2DGraphicClick(t,e,i)),o.on("move-start",i=>t.addToHistory(D(i.graphics))),o.on("rotate-start",i=>t.addToHistory(D(i.graphics))),o.on("scale-start",i=>t.addToHistory(D(i.graphics)))];case"reshape":return[o.on("graphic-click",i=>this._onTransformOrReshape2DGraphicClick(t,e,i)),o.on("move-start",i=>t.addToHistory(D([i.mover]))),o.on("reshape-start",i=>t.addToHistory(D([i.graphic]))),o.on("vertex-add",i=>t.addToHistory(D([i.oldGraphic]))),o.on("vertex-remove",i=>t.addToHistory(D([i.oldGraphic])))];case"move-3d":return[o.events.on("record-undo",({updates:i})=>{t.addToHistory({updates:i})}),o.events.on("move-start",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:i.objects.length>0?i.objects[0].graphic:null,type:"move-start"},type:"update"})}),o.events.on("move",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:i.dx,dy:i.dy,mover:i.objects.length>0?i.objects[0].graphic:null,type:"move"},type:"update"})}),o.events.on("move-stop",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:i.objects.length>0?i.objects[0].graphic:null,type:"move-stop"},type:"update"})}),o.events.on("immediate-click",i=>{i.shiftKey?this._toggleSelection([i.object.graphic],t,e):t.toggleTool()})];case"transform-3d":return[o.events.on("record-undo",({updates:i})=>{t.addToHistory({updates:i})}),o.events.on("translate-start",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,dx:i.dxScreen,dy:i.dyScreen,type:"move-start"},type:"update"})}),o.events.on("translate-stop",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,dx:i.dxScreen,dy:i.dyScreen,type:"move-stop"},type:"update"})}),o.events.on("rotate-start",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,angle:i.angle,type:"rotate-start"},type:"update"})}),o.events.on("rotate-stop",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,angle:i.angle,type:"rotate-stop"},type:"update"})}),o.events.on("scale-start",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,xScale:i.xScale,yScale:i.yScale,type:"scale-start"},type:"update"})}),o.events.on("scale-stop",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,xScale:i.xScale,yScale:i.yScale,type:"scale-stop"},type:"update"})}),o.events.on("translate",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,dx:i.dxScreen,dy:i.dyScreen,type:"move"},type:"update"})}),o.events.on("rotate",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,angle:i.angle,type:"rotate"},type:"update"})}),o.events.on("scale",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:i.object.graphic,xScale:i.xScale,yScale:i.yScale,type:"scale"},type:"update"})}),o.events.on("immediate-click",i=>{i.shiftKey?this._toggleSelection([i.object.graphic],t,e):t.toggleTool()})];case"reshape-3d":return[o.events.on("reshape",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:M(v({},i),{mover:i.object.graphic}),type:"update"})}),o.events.on("move",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:M(v({},i),{mover:i.object.graphic}),type:"update"})}),o.events.on("vertex-add",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:i,type:"update"})}),o.events.on("vertex-remove",i=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:i,type:"update"})}),o.events.on("immediate-click",i=>{i.shiftKey?this._toggleSelection([i.object.graphic],t,e):t.toggleTool()})]}}_onTransformOrReshape2DGraphicClick(t,e,o){let{graphic:i,viewEvent:a}=o;return a.native?.shiftKey&&i.layer===this.layer?(a.stopPropagation(),t.removeFromSelection(i)):e.toggleToolOnClick?(a.stopPropagation(),t.toggleTool()):void 0}_setUpdateOperationHandle(t,e){this._operationHandle=t;let o=this.view?.map;this._disablePopup(e);let i=()=>{if(t===this._operationHandle){let a=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(e),this.emit("update",{graphics:a,state:"complete",aborted:t.cancelled,tool:r,toolEventInfo:null,type:"update"})}};t.on("complete",i)}_getCommonUpdateOperationClickHandlers(t,e,o){return g(this,null,function*(){let i=st(e),a=yield e.async(()=>this._getFirstHit(i));if(a==null)return void t.complete();if(e.native.shiftKey&&this._toggleSelection([a.graphic],t,o))return void e.stopPropagation();this.updateGraphics.includes(a.graphic)?e.stopPropagation():t.complete()})}_toggleSelection(t,e,o){let i=!!o.multipleSelectionEnabled;return t.some(a=>a!=null&&!(!i||a.layer!==this.layer)&&(this.updateGraphics.includes(a)?e.removeFromSelection(a):e.addToSelection(a),!0))}_getCommonUpdateOperationKeyDownHandlers(t,e){if(!t)return;let o=e.key;o===w.undo&&t.canUndo()?(e.stopPropagation(),t.undo()):o===w.redo&&t.canRedo()?(e.stopPropagation(),t.redo()):o===w.cancel?(e.stopPropagation(),t.cancel()):this.allowDeleteKey&&w.delete.includes(o)&&this._onDeleteKey(e)}_onDeleteKey(t){if(!this._operationHandle||this._operationHandle.type!=="update")return;let e=this.activeComponent,o=this.updateGraphics.toArray();e!=null&&(e.type!=="reshape"||o.length===1&&o[0].geometry?.type==="point")&&(t.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view?.map?.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=F(this._internalGraphicsLayer))}_isComponentGraphic(t){let{activeComponent:e}=this;return!(!t||e==null)&&(t.attributes?.esriSketchTool||e.type==="draw-2d"&&e.graphic===t||(e.type==="box"||e.type==="reshape")&&e.isUIGraphic(t))}_displayPointerCursor(){this.view?.container&&this.view.cursor!=="pointer"&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view?.container&&this.view.cursor!=="grabbing"&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view?.container&&this.view.cursor!==null&&(this.view.cursor=null)}_logError(t,e,o){vt.getLogger(this).error(new ft(t,e,o))}_requireModule(t){return g(this,null,function*(){let e=new AbortController;this._moduleLoaderAbortController=e;let o=yield t;return this._moduleLoaderAbortController!==e||e.signal.aborted?{requireError:"aborted"}:{module:o}})}_emitUndoEvent(t){this.emit("undo",M(v({},t),{type:"undo"}))}_emitRedoEvent(t){this.emit("redo",M(v({},t),{type:"redo"}))}_emitDeleteEvent(t){this.emit("delete",M(v({},t),{type:"delete"}))}get test(){}wait(){return at(()=>!this.updating)}_disablePopupEnabled(t){return this.view?.type!=="3d"||this.updateOnGraphicClick||(t?.toggleToolOnClick??!1)}_disablePopup(t){this._disablePopupEnabled(t)&&this.view&&this._originalPopupEnabled==null&&(this._originalPopupEnabled=this.view.popupEnabled,this.view.popupEnabled=!1)}_restorePopup(t){this._disablePopupEnabled(t)&&this.view&&this._originalPopupEnabled!=null&&(this.view.popupEnabled=this._originalPopupEnabled,this._originalPopupEnabled=null)}_waitViewReady(){return g(this,null,function*(){let t=this.view;t?(z(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,yield wt(at(()=>t?.ready),this._viewReadyAbortController.signal)):this._logMissingView()})}_logMissingView(){this._logError("sketch:missing-property",le("view"))}_logMissingLayer(){this._logError(ve,le("layer"))}};h([u()],_.prototype,"_defaultSnappingManager",void 0),h([u()],_.prototype,"updating",null),h([u({readOnly:!0})],_.prototype,"_updatingHandles",void 0),h([u()],_.prototype,"_operationHandle",void 0),h([u({readOnly:!0})],_.prototype,"activeTool",null),h([u({readOnly:!0})],_.prototype,"activeCreateToolDrawMode",null),h([u()],_.prototype,"activeTooltip",null),h([u({types:L})],_.prototype,"activeFillSymbol",void 0),h([u()],_.prototype,"activeLineSymbol",void 0),h([u()],_.prototype,"activeVertexSymbol",void 0),h([u()],_.prototype,"allowDeleteKey",void 0),h([u({readOnly:!0})],_.prototype,"createGraphic",null),h([u()],_.prototype,"defaultCreateOptions",null),h([u()],_.prototype,"defaultUpdateOptions",null),h([u({type:Vt,nonNullable:!0})],_.prototype,"labelOptions",null),h([u()],_.prototype,"layer",void 0),h([u({types:L})],_.prototype,"pointSymbol",void 0),h([u({types:L})],_.prototype,"polygonSymbol",void 0),h([u({types:L})],_.prototype,"polylineSymbol",void 0),h([u()],_.prototype,"meshSymbol",void 0),h([u({type:N,nonNullable:!0})],_.prototype,"snappingOptions",null),h([u()],_.prototype,"snappingManager",null),h([u({readOnly:!0})],_.prototype,"state",null),h([u({type:qt,nonNullable:!0})],_.prototype,"tooltipOptions",null),h([u({readOnly:!0})],_.prototype,"updateGraphics",void 0),h([u()],_.prototype,"updateOnGraphicClick",void 0),h([u()],_.prototype,"creationMode",void 0),h([u({type:Nt,nonNullable:!0})],_.prototype,"valueOptions",null),h([u({types:L})],_.prototype,"vertexSymbol",void 0),h([u({value:null})],_.prototype,"view",null),h([u({constructOnly:!0,type:ht})],_.prototype,"sketchOptions",void 0),_=h([k("esri.widgets.Sketch.SketchViewModel")],_);var ve="sketch:missing-property",le=t=>`Property '${t}' is missing on SketchViewModel.`;function fe(t){return t==="polygon"||t==="rectangle"||t==="circle"}function J(t,e){ce("undo",t.history.undo,t.history.redo,e)}function Q(t,e){ce("redo",t.history.redo,t.history.undo,e)}function ce(t,e,o,i){let a=e.pop();if(!a)return;let r=a.updates,p=[];i.forEach((n,l)=>{let s=r[l];s!=null&&("geometry"in s&&s.geometry!=null&&(p.push({geometry:n.geometry}),n.geometry=s.geometry),"symbol"in s&&s.symbol!=null&&(p.push({symbol:n.symbol}),n.symbol=s.symbol),"undo"in s&&(p.push(s),s[t](n)))}),o.push({updates:p})}function he(t,e){t!=null&&e.hasGrabbedManipulators&&(t.activeTool=null)}function D(t){return{updates:t.map(({geometry:e})=>e?.type==="mesh"?{geometry:e.cloneShallow()}:{geometry:e})}}function X(t,e){t.tools?.remove(e),e.destroyed||e.destroy()}function T(t){return"requireError"in t&&t.requireError==="aborted"}var ni=_;export{A as a,_e as b,ie as c,ni as d};
