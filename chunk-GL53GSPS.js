import{a as ct}from"./chunk-7X55A7Q6.js";import{b as pt}from"./chunk-7EKEC7JO.js";import{a as he,b as nt,c as ot,d as lt,f as dt,g as ut}from"./chunk-WX65JST5.js";import{a as I,b as me,c as fe}from"./chunk-6UPV5F42.js";import{a as ze}from"./chunk-6WHBFKHR.js";import{y as at}from"./chunk-VGCEVKYN.js";import{f as rt,h as st,i as it}from"./chunk-A2ZJFGPE.js";import{a as T,b as ce,c as y,d as W,f as Xe,g as Ye,h as et,j as tt,k as N}from"./chunk-ZQFOJVRP.js";import{a as pe}from"./chunk-PWU2QHPV.js";import{a as $e}from"./chunk-CVRJ6GOM.js";import{a as Be,b as H,c as Ke}from"./chunk-R6GE4XRP.js";import{b as $,g as j,h as We,q as Ze}from"./chunk-MDL4XPLR.js";import{h as Qe}from"./chunk-ILKINAL7.js";import{a as Ge}from"./chunk-HVKMTRIC.js";import{c as ye}from"./chunk-AZS4Q4RE.js";import{a as q}from"./chunk-QEBUS3TL.js";import{a as Pe}from"./chunk-WAGBL553.js";import{a as He}from"./chunk-XPRVY6JT.js";import{h as Je}from"./chunk-7N3ZKWML.js";import{i as ue}from"./chunk-QDTU3MWT.js";import{j as je}from"./chunk-I4M2OT5W.js";import{n as qe}from"./chunk-NTVLK3P2.js";import{a as de}from"./chunk-WMQNRNIU.js";import{a as V}from"./chunk-HD52PWPC.js";import{a as Ue}from"./chunk-EIPVFA6F.js";import{a as G,d as oe,i as Ne}from"./chunk-LB5YQINJ.js";import{b as L}from"./chunk-EKMHQEJY.js";import{a as xe}from"./chunk-VACZNAP3.js";import{b as le}from"./chunk-SLAWDKDA.js";import{a as Oe}from"./chunk-KTE5HCNJ.js";import{a as Ae}from"./chunk-WUA6PW3I.js";import{F as U,d as Z,s as De}from"./chunk-E57FTRWF.js";import{N as Ce,b as Fe,e as ke,v as ne,w as Re}from"./chunk-U4J5SECU.js";import{f as P}from"./chunk-7EG726PT.js";import{L as Le,d as l,x as Me}from"./chunk-C7INQGWT.js";import{H as E,c as x}from"./chunk-WMHJC7XF.js";import{M as ae,a as Ee,u as O,x as J}from"./chunk-D2LVMNOU.js";import{a as o}from"./chunk-QGVBCWUY.js";import{b as ie,k as _e,r as F,t as f}from"./chunk-HHDFN2GK.js";import{t as se}from"./chunk-47GHT6OF.js";import{a as c,b as g,f as p}from"./chunk-VTHXE323.js";function mt(e){return e.type==="feature"}function ft(e){return e.type==="group"}function ht(e){return e.type==="preset"}var yt=new Ae({"{acd53634-cbc7-44d5-bde9-692fa8d45850}":"autocomplete-freehand-polygons","{6f5fc612-d1ef-4d32-a2e1-18a1cb22331c}":"autocomplete-polygons","{09c6f589-a3ce-48ab-81bc-46965c58f264}":"circle","{bccf295a-9c64-4adc-903e-62d827c10ef7}":"create-points-along-line","{756cadf6-91e6-04b1-2938-e172a97af51c}":"create-structures","{ddbe4c0c-063f-8b60-b2da-b349a1e42e84}":"difference-polygon","{a5f4db5f-4a6b-29bd-1f32-9d81bf262c76}":"elevation-point-from-contour","{285ec4bb-60a8-7184-2088-5bee2149f2a4}":"elevation-point-from-dem","{28c04532-3daf-4d3d-b7be-a589c9c9a03e}":"ellipse","{0a7c16b9-1cfd-467f-8ece-6ba376192431}":"freehand","{af2dbf8f-280e-44db-8860-e399d0b30cf1}":"line","{bc485127-2ea2-4c8b-85ef-e8237959eb64}":"multipoint","{d304243a-5c3a-4ccc-b98b-93684b15fd83}":"parcel-seed","{2a8b3331-5238-4025-972e-452a69535b06}":"point","{d376f8e5-69e0-4273-9478-724e9e0d81ac}":"point-and-rotation","{93ce7077-f09e-455e-ade7-b7413cddc393}":"point-at-end-of-line","{8f79967b-66a0-4a1c-b884-f44bc7e26921}":"polygon","{a947ba80-1c29-4bcd-8672-1963b7b9dde0}":"radial-line","{6f0ed2cc-c099-4895-bd7e-beec2f78adbf}":"rectangle","{a281e635-0f22-47d4-a438-e4d29b920e22}":"regular-polygon","{5664cae4-c7de-432a-9933-9586bc15ed39}":"regular-polyline","{c5c42e29-44da-4a1c-8688-e02c07535bc3}":"right-angle-line","{ee16991b-6303-4a8a-9143-1914b2010c1a}":"right-angle-polygon","{7d3e17cf-30dd-4593-9bd8-0b2b8770f52a}":"split","{e00209dd-05c5-4424-be62-51581f9f811d}":"stream-line","{6c6970a7-5ca9-448c-9c7d-0d716cd2ac64}":"stream-polygon","{e22f7d98-007d-427c-8282-13704f7c84c3}":"trace","{6cf59352-8e14-402c-8f4c-ed72647f5e42}":"two-point-line"});var h=class extends P{constructor(e){super(e),this.type="feature",this.templateId=null,this.defaultTool=null,this.description=null,this.globalId="",this.hash="",this.layerIds=[],this.name="",this.subtypeCode=null,this.status=null,this.userIdentity=null,this.tags=[],this.visible=!0}readThumbnail(e){return e==null||e===""?null:{contentType:"png",imageData:e,height:64,width:64}}readDefaultTool(e){return e==null?null:yt.fromJSON(e.toLowerCase())}readLayerIds(e,t){return t.layerIds!=null?t.layerIds.split(",").map(r=>parseInt(r.trim(),10)):t.layerId!=null?[t.layerId]:[]}readTags(e,t){let r=t.tag;return r==null?[]:r.split(";").map(s=>s.trim())}};o([l()],h.prototype,"type",void 0),o([l({json:{read:!1,write:!1}})],h.prototype,"featureService",void 0),o([l()],h.prototype,"thumbnail",void 0),o([V("thumbnail")],h.prototype,"readThumbnail",null),o([l()],h.prototype,"templateId",void 0),o([l()],h.prototype,"defaultTool",void 0),o([V("defaultTool")],h.prototype,"readDefaultTool",null),o([l()],h.prototype,"description",void 0),o([l()],h.prototype,"globalId",void 0),o([l()],h.prototype,"hash",void 0),o([l()],h.prototype,"layerIds",void 0),o([V("layerIds",["layerIds","layerId"])],h.prototype,"readLayerIds",null),o([l()],h.prototype,"name",void 0),o([l({json:{name:"subtype"}})],h.prototype,"subtypeCode",void 0),o([l()],h.prototype,"status",void 0),o([l()],h.prototype,"userIdentity",void 0),o([l()],h.prototype,"tags",void 0),o([V("tags",["tag"])],h.prototype,"readTags",null),o([l()],h.prototype,"visible",void 0),h=o([E("esri.editing.sharedTemplates.SharedTemplateMetadata")],h);var gt=h;function vt(s){return p(this,arguments,function*({serviceUrl:e,query:t,requestOptions:r={}}){if(t.layers==null&&t.templateIds==null)throw new f("query-shared-templates:invalid-parameters","Must supply a value for either the 'layers' or the 'templateIds' parameters");let i=Re(e,"sharedTemplates","query"),a=c(c({f:"json"},r.query),t);a.layers&&(a.layers=ge(a.layers)),a.templateIds&&(a.templateIds=ge(a.templateIds)),a.tags&&(a.tags=ge(a.tags));let n=g(c({},r),{responseType:"json",query:a});return(yield U(i,n)).data.templates})}function ge(e){return Array.isArray(e)?e.join(","):""}function Q(e,t){let r=t.id;return{id:r,name:t.name,url:`${e}/${r}`,type:t.type||"Table"}}function Rt(e){return{data:Ct(e),sync:Nt(e),operations:Dt(e.capabilities,e),query:xt(e),editing:Ot(e)}}function Ct(e){return{isDataVersioned:I(e,"hasVersionedData",!1),isDataBranchVersioned:I(e,"hasBranchVersionedData",!1)}}function Dt(e,t){let r=e?e.toLowerCase().split(",").map(u=>u.trim()):[],s=r.includes("query"),i=r.includes("editing")&&!t.datesInUnknownTimezone,a=i&&r.includes("create"),n=i&&r.includes("delete"),d=i&&r.includes("update");return i&&!(a||n||d)&&(a=n=d=!0),{supportsAdd:a,supportsDelete:n,supportsEditing:i,supportsChangeTracking:r.includes("changetracking"),supportsQuery:s,supportsQueryDataElements:I(t,"supportsQueryDataElements",!1),supportsQueryDomains:I(t,"supportsQueryDomains",!1),supportsQueryContingentValues:I(t,"supportsQueryContingentValues",!1),supportsSync:r.includes("sync"),supportsUpdate:d}}function xt(e){return{maxRecordCountFactor:me(e,"maxRecordCountFactor",void 0),maxRecordCount:me(e,"maxRecordCount",void 0)}}function Ot(e){let t=e?.advancedEditingCapabilities;return{supportsAsyncApplyEdits:I(t,"supportsAsyncApplyEdits",!1),supportsGlobalId:I(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:I(t,"supportsReturnServiceEditsInSourceSR",!1),supportsSharedTemplates:I(e,"hasSharedTemplates",!1),supportsSplit:I(t,"supportsSplit",!1)}}function Nt(e){let t=e?.syncCapabilities,r=t?.supportedSyncDataOptions;return{supportsAsync:I(t,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~r),dimensions:!(2&~r),contingentValues:!(4&~r),attributeRules:!(8&~r),utilityNetworkSystem:!(16&~r),annotationFullModel:!(32&~r),include3DObjects:!(64&~r),utilityNetworkMissingLayers:!(128&~r),preserveTrueCurves:!(256&~r)}}}var v=class extends P.JSONSupportMixin($e.IdentifiableMixin(q)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(e,t){this.sourceJSON=e,super.read(e,t)}get utilityNetworkUrl(){if(this.sourceJSON){for(let e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`}return null}get versionManagementServiceUrl(){return this.sourceJSON?.hasBranchVersionedData&&!Fe(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,t){return(t.layers||[]).map(r=>{let{type:s,geometryType:i}=r;return g(c({},Q(this.url,r)),{type:s||"Feature Layer",geometryType:i})})}readTableInfos(e,t){return(t.tables||[]).map(r=>Q(this.url,r))}readCapabilities(e,t){return Rt(t)}get effectiveCapabilities(){let e=this.capabilities;if(!e)return null;let t=ie(e),{operations:r}=t;return this.userHasUpdateItemPrivileges?(r.supportsAdd=r.supportsDelete=r.supportsEditing=r.supportsQuery=r.supportsUpdate=!0,t):(this.userHasFullEditingPrivileges&&r.supportsEditing&&(r.supportsAdd=r.supportsDelete=r.supportsUpdate=!0),t)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then(()=>this._setUserPrivileges(e))),Promise.resolve(this)}fetchAllLayersAndTables(e){return p(this,null,function*(){return yield this.load(e),this._fetchLayersAndTablesPromise||=this._fetchLayersAndTables(this.url),O(e),this._fetchLayersAndTablesPromise})}applyEdits(e,t){return p(this,null,function*(){let r=null;try{let{results:s,edits:i,editedFeatures:a}=yield this._internalApplyEdits(e,t),n=u=>u.filter(m=>!m.error).map(ie),d=0;return s.map(u=>{r=tt(this.url,u.id,t?.gdbVersion,!0);let m={edits:i[d],addedFeatures:n(u.addFeatureResults),updatedFeatures:n(u.updateFeatureResults),deletedFeatures:n(u.deleteFeatureResults),addedAttachments:n(u.addAttachmentResults),updatedAttachments:n(u.updateAttachmentResults),deletedAttachments:n(u.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:u.editMoment?new Date(u.editMoment):null};d+=1,a.length>0&&(m.editedFeatures=a),r.resolve(m),r=null}),s}catch(s){throw r&&r.reject(s),s}})}querySharedTemplates(e){return p(this,null,function*(){let t=c({},e?.query);return t.layers==null&&t.templateIds==null&&(t.layers=this.layerInfos.map(r=>r.id)),(yield vt({serviceUrl:this.url,query:t,requestOptions:e?.requestOptions})).map(r=>{let s=gt.fromJSON(r);return s.featureService=this,s})})}_setUserPrivileges(e){return p(this,null,function*(){if(_e.userPrivilegesApplied)try{let{features:{fullEdit:t},content:{updateItem:r}}=yield this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",t),this._set("userHasUpdateItemPrivileges",r)}catch(t){J(t)}})}_fetchUserPrivileges(e,t){return p(this,null,function*(){if(!e)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let a,n,d;try{a=yield Ze(this.url,t)}catch(u){J(u)}try{let u=t!=null?t.signal:null;n=yield Z?.getCredential(`${a}/sharing`,{prompt:!1,signal:u})}catch(u){J(u)}if(!n)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(d=new Ge({id:e,portal:{url:a}}),yield d.load(t),d.portal.user)return Qe(d)}catch(u){J(u)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}})}_internalApplyEdits(e,t){return p(this,null,function*(){yield at(this.url);let r=t?.globalIdUsed??!1,s=de.fromJSON(this.sourceJSON.spatialReference),{edits:i,options:a}=yield this._processApplyEditsParams(e,t),n=yield Promise.all(i.map(S=>p(this,null,function*(){let te=S.addFeatures?.map(re=>he({spatialReference:s},re,null))??[],be=(yield Promise.all(te)).filter(se),we=be.length>0?be:null,Ft=S.updateFeatures?.map(re=>he({spatialReference:s},re,null))??[],Se=(yield Promise.all(Ft)).filter(se),Ie=Se.length>0?Se:null,Ve=ot(S.identifierFields,S.deleteFeatures,r),kt=Ve.length>0?Ve:null;ze(we,Ie,s);let D=yield nt(S.identifierFields,S),Te=null;return D&&(Te={adds:D.adds.length>0?D.adds:void 0,updates:D.updates.length>0?D.updates:void 0,deletes:D.deletes.length>0?D.deletes:void 0}),{id:S.id,adds:we,updates:Ie,deletes:kt,attachments:Te}}))),d={gdbVersion:a?.gdbVersion,rollbackOnFailure:!0,useGlobalIds:r,returnEditMoment:!0,honorSequenceOfEdits:a?.honorSequenceOfEdits,usePreviousEditMoment:a?.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};yield Xe(this.url,t?.gdbVersion,!0);let u=Ye(this.url,t?.gdbVersion||null);d.edits=JSON.stringify(n);let m=H(this.url),w=Be(m.query,{query:Ke(g(c({},d),{f:"json"})),method:"post"}),_;u&&(w.authMode="immediate",w.query.sessionId=T);try{_=yield U(this.url+"/applyEdits",w)}catch(S){if(!ut(S))throw S;w.authMode="immediate",_=yield U(this.url+"/applyEdits",w)}return g(c({},Pt(_)),{edits:i})})}_processApplyEditsParams(e,t){return p(this,null,function*(){let r=g(c({},t),{usingFeatureServiceEndpoint:!0});return{edits:yield Promise.all(e.map(s=>p(this,null,function*(){let i=this.effectiveCapabilities,a=s&&(s.addFeatures||s.updateFeatures||s.deleteFeatures),n=s&&(s.addAttachments||s.updateAttachments||s.deleteAttachments);if(it(s,i,r,!!a,!!n,"feature-service"),!i.data.isDataVersioned&&r?.gdbVersion)throw new f("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");let d=st(s,i,"feature-service");return g(c({},yield rt(d)),{id:s.id,identifierFields:s.identifierFields})}))),options:r}})}_fetchService(e,t){return p(this,null,function*(){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:H(e)});let r=yield U(e,c({responseType:"json",query:{f:"json"}},t));this.read(r.data,{url:H(e)})})}_fetchLayersAndTables(e){return p(this,null,function*(){let t=`${e}/layers`,r=yield U(t,{responseType:"json",query:{f:"json"}});return{layers:r.data.layers.map(s=>{let{type:i,geometryType:a}=s,n=Q(this.url,s),d=fe(s,n.url);return g(c({},n),{type:i||"Feature Layer",geometryType:a,capabilities:d})}),tables:r.data.tables.map(s=>{let i=Q(this.url,s),a=fe(s,i.url);return g(c({},i),{capabilities:a})})}})}};function Pt(e){let t=e.data,r=[];return{results:t.map(s=>{let i={addResults:s.addResults??[],updateResults:s.updateResults??[],deleteResults:s.deleteResults??[],attachments:s.attachments,editMoment:s.editMoment},a=lt(i),n=s.editedFeatures,d=n?.spatialReference?new de({wkid:n?.spatialReference.wkid,wkt:n?.spatialReference.wkt,latestWkid:n?.spatialReference.latestWkid,latestVcsWkid:n?.spatialReference.latestVcsWkid,vcsWkid:n?.spatialReference.vcsWkid}):null,u=n?dt(n,d):null;return u&&r.push({layerId:s.id,editedFeatures:u}),c({id:s.id,editedFeatures:u},a)}),editedFeatures:r}}o([l()],v.prototype,"url",void 0),o([l()],v.prototype,"sourceJSON",void 0),o([l()],v.prototype,"userHasFullEditingPrivileges",void 0),o([l()],v.prototype,"userHasUpdateItemPrivileges",void 0),o([l({readOnly:!0})],v.prototype,"utilityNetworkUrl",null),o([l({readOnly:!0})],v.prototype,"versionManagementServiceUrl",null),o([l()],v.prototype,"userTypeExtensions",void 0),o([l({json:{read:{source:["layers"]}}})],v.prototype,"layerInfos",void 0),o([V("layerInfos",["layers"])],v.prototype,"readLayerInfos",null),o([l({json:{read:{source:["tables"]}}})],v.prototype,"tableInfos",void 0),o([V("tableInfos",["tables"])],v.prototype,"readTableInfos",null),o([l({readOnly:!0,json:{read:{source:["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],v.prototype,"capabilities",void 0),o([V("capabilities",["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],v.prototype,"readCapabilities",null),o([l({readOnly:!0})],v.prototype,"effectiveCapabilities",null),v=o([E("esri.rest.featureService.FeatureService")],v);var bt=v;var b=class extends Le{constructor(e){super(e),this.layers=new L,this.lockType="none",this.tables=new L,this.versionInfo=null,this.versionService=null}get layersAndTables(){return new L([...this.layers.toArray(),...this.tables.toArray()])}updateLockType(){this.lockType=this.versionInfo?this.versionService.getLockType(this.versionInfo.versionIdentifier)??"none":"none"}get featureServiceVersion(){return this.featureService.sourceJSON?.currentVersion??0}};o([l({constructOnly:!0})],b.prototype,"canCreateVersion",void 0),o([l({constructOnly:!0})],b.prototype,"canEditVersionedData",void 0),o([l({constructOnly:!0})],b.prototype,"featureService",void 0),o([l({constructOnly:!0})],b.prototype,"layers",void 0),o([l()],b.prototype,"layersAndTables",null),o([l()],b.prototype,"lockType",void 0),o([l({constructOnly:!0})],b.prototype,"tables",void 0),o([l()],b.prototype,"versionInfo",void 0),o([l({constructOnly:!0})],b.prototype,"versionService",void 0),o([l()],b.prototype,"hasAdvancedEditingUserTypeExtension",void 0),o([l()],b.prototype,"loggedInServiceUser",void 0),o([l()],b.prototype,"featureServiceVersion",null),b=o([E("esri.undoredo.support.ServiceVersionInfo")],b);var z=class{constructor(t){this.moments=[],this.forwardMoments=[],this.moments.push(t)}push(t){return this.forwardMoments.length,this.moments.push(t)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;let t=this.moments.pop();return this.forwardMoments.push(t),t}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;let t=this.forwardMoments.pop();return this.moments.push(t),t}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}};var B=new WeakMap;function K(e){return!e.destroyed&&(B.has(e)||e.addHandles([G(()=>{let t=e.parent;return!(!t||!("type"in t))&&(t.type==="catalog-dynamic-group"||K(t))},t=>B.set(e,t),Ne),Ee(()=>B.delete(e))]),B.get(e))}var k=class{constructor(t){this.versionableItem=t,this.type="feature-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(t){this.versionableItem.gdbVersion=t}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(t){this.versionableItem.historicMoment=t}get featureServiceUrl(){let t=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(t,"$1")}};o([l({readOnly:!0})],k.prototype,"type",void 0),o([l()],k.prototype,"gdbVersion",null),o([l({type:Date})],k.prototype,"historicMoment",null),o([l({readOnly:!0})],k.prototype,"featureServiceUrl",null);var R=class{constructor(t){this.versionableItem=t,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(t){this.versionableItem.gdbVersion=t}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(t){this.versionableItem.historicMoment=t}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}};o([l({readOnly:!0})],R.prototype,"type",void 0),o([l()],R.prototype,"gdbVersion",null),o([l({type:Date})],R.prototype,"historicMoment",null),o([l({readOnly:!0})],R.prototype,"featureServiceUrl",null);var C=class{constructor(t){this.versionableItem=t,this.type="subtype-group-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(t){this.versionableItem.gdbVersion=t}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(t){this.versionableItem.historicMoment=t}get featureServiceUrl(){let t=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(t,"$1")}};o([l({readOnly:!0})],C.prototype,"type",void 0),o([l()],C.prototype,"gdbVersion",null),o([l({type:Date})],C.prototype,"historicMoment",null),o([l({readOnly:!0})],C.prototype,"featureServiceUrl",null);function wt(e){return"networkServiceUrl"in e?new R(e):e.type!=="feature"||K(e)?e.type!=="subtype-group"||K(e)?null:new C(e):new k(e)}function ve(e){let t=[];for(let r of e)if(r.type==="group"){let s=r,i=s.allTables.concat(s.allLayers);for(let a of i)if(a.type==="feature"||a.type==="subtype-group"){let n=wt(a);n&&t.push(n)}}else{let s=wt(r);s&&t.push(s)}return t}var M=class extends P.JSONSupportMixin(q){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=t=>!t||t===this.defaultVersionIdentifier.name,this._dateEquals=(t,r)=>!t&&!r||!(!t||!r)&&t.toISOString()===r.toISOString(),this._applyEditsHandler=t=>{let{serviceUrl:r,gdbVersion:s,result:i}=t;r===this._featureServiceUrl&&i.then(a=>{let n=a.historicMoment;n&&this._addMomentToVersionItem(s,n)})}}initialize(){this.url=Ce(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),y.has(this.url)||y.set(this.url,new Map);let e=(W.get(this.url)??0)+1;W.set(this.url,e),this.when().then(()=>this.addHandles(et(this._applyEditsHandler)),()=>{})}destroy(){let e=(W.get(this.url)??1)-1;W.set(this.url,e),e===0&&y.delete(this.url),ce.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}createVersion(e){return p(this,null,function*(){let[{createVersion:t},{default:r}]=yield Promise.all([import("./chunk-MVBMPB6D.js"),import("./chunk-7GJ567FQ.js")]),s=r.from(e);return t(this.url,s)})}deleteVersion(e){return p(this,null,function*(){let[{deleteVersion:t},{default:r}]=yield Promise.all([import("./chunk-XIIT72ZQ.js"),import("./chunk-TFAW7B3K.js")]),s;e.guid&&y.get(this.url)?.has(e.guid)&&(s=T??void 0);let i=new r({versionName:e.name,sessionId:s});return t(this.url,i)})}getVersionInfoExtended(e){return p(this,null,function*(){let{getVersion:t}=yield import("./chunk-C5QNOP5X.js");return t(this.url,e.guid)})}getVersionInfos(){return p(this,arguments,function*(e={}){let[{getVersionInfos:t},{default:r}]=yield Promise.all([import("./chunk-4DCOVGWK.js"),import("./chunk-OSPNZQNV.js")]),s=r.from(e);return t(this.url,s)})}reconcile(r){return p(this,arguments,function*(e,t={}){let[{reconcile:s},{default:i}]=yield Promise.all([import("./chunk-E33IR4Q6.js"),import("./chunk-WMX5ZMAQ.js")]),a=i.from(t);return a.sessionId=T,s(this.url,e.guid,a)})}post(e){return p(this,null,function*(){let[{post:t},{default:r}]=yield Promise.all([import("./chunk-5JQCSBPG.js"),import("./chunk-HN4G2VUE.js")]),s=r.from({sessionId:T});return t(this.url,e.guid,s)})}alterVersion(e,t){return p(this,null,function*(){let[{alterVersion:r},{default:s}]=yield Promise.all([import("./chunk-HB3QI6VW.js"),import("./chunk-A7WKVIRP.js")]),i=s.from(t);return r(this.url,e.guid,i)})}startReading(e){return p(this,null,function*(){return(yield this.startReadingWithResult(e)).success})}startReadingWithResult(e){return p(this,null,function*(){let{startReading:t}=yield import("./chunk-RAIOAXND.js"),r=yield t(this.url,e.guid,T);if(r.success){let s=yield this.getVersionInfoExtended(e),i=new Date(s.modifiedDate),a={name:s.versionIdentifier.name,moment:i,lockType:"read"};this._addOrUpdateItem(e.guid,a),N(this._featureServiceUrl,null,e.name,i)}return r})}stopReading(e){return p(this,null,function*(){return(yield this.stopReadingWithResult(e)).success})}stopReadingWithResult(e){return p(this,null,function*(){let{stopReading:t}=yield import("./chunk-3DBH3GQ3.js"),r=yield t(this.url,e.guid,T);return r.success&&(y.get(this.url)?.delete(e.guid),N(this._featureServiceUrl,null,e.name,null)),r})}startEditing(e){return p(this,null,function*(){return(yield this.startEditingWithResult(e)).success})}startEditingWithResult(e){return p(this,null,function*(){let{startEditing:t}=yield import("./chunk-QYDQBENP.js"),r=yield t(this.url,e.guid,T);if(r.success){let s=yield this.getVersionInfoExtended(e),i=new Date(s.modifiedDate),a=new z(i),n={name:e.name,moment:i,lockType:"edit",stack:a};this._addOrUpdateItem(e.guid,n),N(this._featureServiceUrl,null,e.name,i)}return r})}stopEditing(e,t){return p(this,null,function*(){return(yield this.stopEditingWithResult(e,t)).success})}stopEditingWithResult(e,t){return p(this,null,function*(){if(t){let i=y.get(this.url)?.get(e.guid);if(i?.stack?.canRedo()){let[{deleteForwardEdits:a},{default:n}]=yield Promise.all([import("./chunk-EFSOCNHH.js"),import("./chunk-WRDVC5YY.js")]),d=yield a(this.url,e.guid,new n({sessionId:T,moment:i.moment}));if(!d.success)return d}}let{stopEditing:r}=yield import("./chunk-4HGQQAXA.js"),s=yield r(this.url,e.guid,T,t);if(s.success){let i=yield this.getVersionInfoExtended(e),a=new Date(i.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:a,lockType:"read",editMomentStack:void 0}),N(this._featureServiceUrl,null,e.name,a)}return s})}getLockType(e){return y.get(this.url)?.get(e.guid)?.lockType??"none"}changeVersion(e,t,r){return p(this,null,function*(){if(r&&"name"in r&&!(yield this.getVersionInfoExtended(r)))throw new f("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this._changeVersionInternal(e,t,r)}else{let s;"layers"in e?(s=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach(i=>{this._featureServiceUrl.toLowerCase()===i.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(i,t,r)})):s=e;for(let i of s)if(i.type==="feature"||i.type==="subtype-group"){let a=/^(.*\/FeatureServer)\/\d+$/,n=i.url.replace(a,"$1");if(this._featureServiceUrl.toLowerCase()===n.toLowerCase()&&!this._changeVersionInternal(i,t,r))return!1}else if(i.type==="group"){let a=i.allTables.concat(i.allLayers);for(let n of a)if(n.type==="feature"||n.type==="subtype-group"){let d=/^(.*\/FeatureServer)\/\d+$/,u=n.url.replace(d,"$1");if(this._featureServiceUrl.toLowerCase()===u.toLowerCase()&&!this._changeVersionInternal(n,t,r))return!1}}}return!0})}changeVersionWithResult(e,t,r){return p(this,null,function*(){let s;if("layers"in e){let a=ve(e.allTables.concat(e.allLayers).filter(n=>n.type!=="group").toArray());e.utilityNetworks&&e.utilityNetworks.forEach(n=>{let d=ve([n]);a.push(...d)}),s=a}else s=e;if(r&&"name"in r&&!(yield this.getVersionInfoExtended(r))){let a=new Map;for(let n of s)a.set(n,{success:!1});return a}if(t&&"name"in t&&this.getLockType(t)!=="none"){let a=new Map;for(let n of s)a.set(n,{success:!1});return a}let i=new Map;for(let a of s)if(a)if(a.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){let n=this._changeVersionInternalWithResult(a,t,r);i.set(a,n)}else i.set(a,{success:!1});return i})}getVersionIdentifierFromName(e){return p(this,null,function*(){try{return(yield this.getVersionInfos({includeHidden:!0})).find(r=>r.versionIdentifier.name.toUpperCase()===e.toUpperCase())?.versionIdentifier||null}catch{return null}})}getVersionIdentifierFromGuid(e){return p(this,null,function*(){let{getVersion:t}=yield import("./chunk-C5QNOP5X.js");try{return(yield t(this.url,e)).versionIdentifier}catch{return null}})}canUndo(e){return!!y.get(this.url)?.get(e.guid)?.stack?.canUndo()}canRedo(e){return!!y.get(this.url)?.get(e.guid)?.stack?.canRedo()}undo(e){let t=y.get(this.url)?.get(e.guid),r=t?.stack?.undo()||void 0;if(t&&r){let s=t.stack.peek();N(this._featureServiceUrl,null,e.name,s),y.get(this.url)?.set(e.guid,g(c({},t),{moment:s}))}}redo(e){let t=y.get(this.url)?.get(e.guid),r=t?.stack?.redo()||void 0;t&&r&&(N(this._featureServiceUrl,null,e.name,r),y.get(this.url)?.set(e.guid,g(c({},t),{moment:r})))}_setUpData(e,t){let r=null,s=null,i=null,a=null,n=d=>{let u=y?.get(this.url)?.get(d.guid);i=d.name,a=u?.moment??null};if(e&&"name"in e){if(this.getLockType(e)!=="none")throw new f("version-management-service:version-locked","version is locked");r=e.name,s=null,t&&"name"in t?n(t):(i=this.defaultVersionIdentifier.name,a=t)}else r=this.defaultVersionIdentifier.name,s=e,t&&"name"in t?n(t):(i=this.defaultVersionIdentifier.name,a=t);return{fromVersionName:r,fromMoment:s,toVersionName:i,toMoment:a}}_changeVersionInternal(e,t,r){try{let{fromVersionName:s,fromMoment:i,toVersionName:a,toMoment:n}=this._setUpData(t,r);(this._isDefault(s)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,i)||s===e.gdbVersion&&this._dateEquals(e.historicMoment,i))&&(e.gdbVersion=a,e.historicMoment=n)}catch{return!1}return!0}_changeVersionInternalWithResult(e,t,r){try{let{fromVersionName:s,fromMoment:i,toVersionName:a,toMoment:n}=this._setUpData(t,r);return this._isDefault(s)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,i)||s===e.gdbVersion&&this._dateEquals(e.historicMoment,i)?(e.gdbVersion=a,e.historicMoment=n,{success:!0}):{success:!1}}catch{return{success:!1}}}_addMomentToVersionItem(e,t){let r=y.get(this.url);if(r)for(let[s,i]of r)i.name===e&&this._addToStack(s,t)}_addToStack(e,t){let r=y.get(this.url),s=r?.get(e);return!!s?.stack&&(qt(s.stack.peek(),t)&&s.stack.push(t),r.set(e,g(c({},s),{moment:t})),!0)}_addOrUpdateItem(e,t){let r=y.get(this.url),s=r?.get(e);return s?(r.set(e,c(c({},s),t)),!0):!(!t.name||!t.lockType)&&(r?.set(e,g(c({},t),{lockType:t.lockType})),!0)}_fetchService(e,t){return p(this,null,function*(){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:H(e)});let s=new ke(this.url).host;return void ce.set(s,this.defaultVersionIdentifier.name)}let r=yield U(e,c({responseType:"json",query:{f:"json"}},t));this.read(r.data)})}};function qt(e,t){return e?e.getTime()<t.getTime():!0}o([l()],M.prototype,"url",void 0),o([l()],M.prototype,"sourceJSON",void 0),o([l({type:String,json:{write:!0}})],M.prototype,"name",void 0),o([l({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],M.prototype,"defaultVersionIdentifier",void 0),o([V("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],M.prototype,"readDefaultVersionIdentifier",null),o([Ue("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],M.prototype,"writeDefaultVersionIdentifier",null),o([l({json:{write:!0}})],M.prototype,"capabilities",void 0),M=o([E("esri.versionManagement.VersionManagementService")],M);var St=M;function jt(e){return!e||e.trim().length===0}var It=new Map;function Vt(e){return x(It,e,()=>{let t=new A({view:e});return e.addHandles({remove(){It.delete(e),t.destroy()}}),t.load().catch(r=>{F.getLogger("esri.views.Services").error("Failed to load service metadata",r)}),t})}var A=class extends q.LoadableMixin(Oe.EsriPromiseMixin(xe.EventedAccessor)){constructor(e){super(e),this._updatingHandles=new ct,this.items=new L,this.tablesAndLayersLookup=new Pe,this.additionalLayers=new L,this._debouncedCheckAndUpdateServiceInfos=ae(()=>p(this,null,function*(){let t=[];for(let r of this.items){if(r.layersAndTables.length===0)continue;r.layersAndTables.getItemAt(0)?.gdbVersion!==r.versionInfo?.versionIdentifier.name&&t.push(r)}t.length!==0&&(yield oe(()=>!this.updating),yield this._updateVersionInfos(t))})),this._debouncedLayersChanged=ae(()=>p(this,null,function*(){let t=this._detectNewLayersAndTables();t.length!==0&&(yield oe(()=>!this._updatingHandles.updating),yield this._updatingHandles.addPromise(p(this,null,function*(){let r=new Set;for(let s of t)if(s.type==="feature"||s.type==="subtype-group"){if(!s.url)continue;let i=De(s.url).url.path,a=this._findServiceInfo(i);if(a)this.tablesAndLayersLookup.set(s,a),s.isTable?a.tables.push(s):a.layers.push(s);else if(!r.has(i))try{yield this._addServiceInfo(i,s)}catch(n){F.getLogger(this).error(`Failed to load feature service: ${i}`,n)}finally{r.add(i)}}})))})),this._processed=new Set}destroy(){this._set("view",null),this.items.removeAll(),this.tablesAndLayersLookup.clear()}load(e){return p(this,null,function*(){return O(e),this.addHandles([G(()=>this._allLayersAndTables,()=>{this._debouncedLayersChanged().catch(t=>{F.getLogger(this).warn("Failed to update service info",t)})}),G(()=>this.items.map(t=>t.layersAndTables.map(r=>r.gdbVersion??"").join(",")),()=>{this.checkAndUpdateServiceInfos().catch(t=>{F.getLogger(this).warn("Failed to update service info",t)})})]),this.addResolvingPromise(this._debouncedLayersChanged()),this})}get updating(){return this.loadStatus==="loading"||this._updatingHandles.updating}checkAndUpdateServiceInfos(){return this._debouncedCheckAndUpdateServiceInfos()}changeVersion(e,t,r){return this._updatingHandles.addPromise(p(this,null,function*(){yield this._changeVersionInternal(e,t,r)}))}createVersion(e){return this._updatingHandles.addPromise(p(this,null,function*(){let t=e.featureServerUrl,r=this._findServiceInfo(t);if(!r?.versionService)throw new f("services:no-version-management-service");let s=r.hasAdvancedEditingUserTypeExtension,i=r.loggedInServiceUser.toUpperCase(),a=jt(e.ownerName)?i:e.ownerName?.trim().toUpperCase();if(a!==i){if(r.featureServiceVersion<=11.1)throw new f("services:versioning-api-error");if(!s)throw new f("services:no-advanced-editing-user-type-extension")}if(a?.toUpperCase()==="SDE"&&e.versionName.toUpperCase()==="DEFAULT")throw new f("services:no-valid-version-name");if((yield r.versionService.getVersionInfos())?.find(u=>u.versionIdentifier.name.toUpperCase()===(a+"."+e.versionName).toUpperCase()||u.versionIdentifier.name.toUpperCase()===(i+"."+e.versionName).toUpperCase()))throw new f("services:no-valid-version-name");let n=yield r.versionService.createVersion({versionName:e.versionName,access:a!==i?"public":e.access,description:e.description});if(a!==i){let{guid:d,name:u}=n.versionIdentifier;yield r.versionService.alterVersion({guid:d,name:u},{ownerName:a,access:e.access})}e.switchToVersion&&(yield this._changeVersionInternal(t,n.versionIdentifier.name,n.versionIdentifier.guid)),this.emit("version-created",{versionIdentifier:n.versionIdentifier,versionManagementService:r.versionService})}))}deleteVersion(e,t,r){return this._updatingHandles.addPromise(p(this,null,function*(){let s=this._findServiceInfo(e);if(!s?.versionService)throw new f("services:no-version-management-service");if(s.featureServiceVersion<=11.1)throw new f("services:versioning-api-error");if(!s.hasAdvancedEditingUserTypeExtension)throw new f("services:no-advanced-editing-user-type-extension");let i={name:t,guid:r};(yield s.versionService.deleteVersion(i))&&(yield this._updateVersionInfo(s),this.emit("version-deleted",{versionIdentifier:i,versionManagementService:s.versionService}))}))}startEditing(e){return this._updatingHandles.addPromise(p(this,null,function*(){let t=this._findServiceInfo(e);if(!t?.versionService)throw new f("services:no-version-management-service");if(!t.hasAdvancedEditingUserTypeExtension)throw new f("services:no-advanced-editing-user-type-extension");let r=t.versionInfo?.versionIdentifier??{name:t.versionService.defaultVersionIdentifier.name,guid:t.versionService.defaultVersionIdentifier.guid},s=!0;(t.versionService.getLockType(r)!=="none"||(s=yield t.versionService.startReading(r),s))&&(s=yield t.versionService.startEditing(r),t.updateLockType())}))}finishEditing(e,t){return this._updatingHandles.addPromise(p(this,null,function*(){let r=this._findServiceInfo(e);if(!r?.versionService)throw new f("services:no-version-management-service");if(!r.hasAdvancedEditingUserTypeExtension)throw new f("services:no-advanced-editing-user-type-extension");let s=r.versionInfo?.versionIdentifier??{name:r.versionService.defaultVersionIdentifier.name,guid:r.versionService.defaultVersionIdentifier.guid},i=r.versionService.getLockType(s);if(i!=="none")return i==="read"?(yield r.versionService.stopReading(s),void r.updateLockType()):i==="edit"?(yield r.versionService.stopEditing(s,t),yield r.versionService.stopReading(s),void r.updateLockType()):void 0}))}_changeVersionInternal(e,t,r){return p(this,null,function*(){let s=this._findServiceInfo(e);if(!s?.versionService)throw new f("services:no-version-management-service");let i=s.versionInfo?.versionIdentifier??{name:s.versionService.defaultVersionIdentifier.name,guid:s.versionService.defaultVersionIdentifier.guid},a={name:t,guid:r};(yield s.versionService.changeVersion(this.view?.map,i,a))&&(yield this._updateVersionInfo(s))})}_updateVersionInfo(e){return p(this,null,function*(){let t=e.versionService;if(!t||e.layersAndTables.length===0)return;let r=e.layersAndTables.getItemAt(0)?.gdbVersion,s=r?yield t.getVersionIdentifierFromName(r):t.defaultVersionIdentifier;e.versionInfo=yield t.getVersionInfoExtended(s)})}_findServiceInfo(e){return this.items.find(t=>t.featureService.url===e)??null}_removeFeatureService(e){this.items.remove(e)}_findPortal(e){return p(this,null,function*(){let t=Z?.findServerInfo(e??"");if(!t?.owningSystemUrl)return null;let r=`${t.owningSystemUrl}/sharing/rest`,s=ye.getDefault();return s?.loaded&&ne(s.restUrl)===ne(r)?s:new ye({authMode:"immediate",url:t.owningSystemUrl}).load()})}_updateVersionInfos(e){return this._updatingHandles.addPromise(p(this,null,function*(){for(let t of e)yield this._updateVersionInfo(t).catch(r=>{F.getLogger(this).error("Failed to update version details",r)})}))}_addServiceInfo(e,t){return p(this,null,function*(){let r=new bt({url:e});yield r.load();let s=yield this._findPortal(e),i=s?.user?.username,a=!1;i&&(a=yield pt(s,i,"advediting"));let n=null;r.versionManagementServiceUrl&&(n=new St({url:r.versionManagementServiceUrl}),yield n.load());let d=t.isTable?[]:[t],u=t.isTable?[t]:[],m=new b({loggedInServiceUser:i??"",hasAdvancedEditingUserTypeExtension:a,versionInfo:null,lockType:"none",canEditVersionedData:!0,canCreateVersion:!0,featureService:r,versionService:n,layers:new L(d),tables:new L(u)});return n&&(yield this._updateVersionInfo(m)),this.items.push(m),this.tablesAndLayersLookup.set(t,m),t.isTable?m.tables.push(t):m.layers.push(t),m})}get _allLayersAndTables(){return[...this.view.map.allLayers,...this.view.map.allTables,...this.additionalLayers]}_detectNewLayersAndTables(){let e=new Set(this._allLayersAndTables),t=[];for(let r of e)r.type!=="feature"&&r.type!=="subtype-group"||this._processed.has(r)||t.push(r);for(let r of this._processed)if(!e.has(r)&&(j(r)||$(r))){let s=this.tablesAndLayersLookup.get(r);if(!s)continue;this.tablesAndLayersLookup.delete(r),r.isTable?s.tables.remove(r):s.layers.remove(r),s.layersAndTables.length===0&&this._removeFeatureService(s)}return this._processed=e,t}};o([l({constructOnly:!0})],A.prototype,"view",void 0),o([l()],A.prototype,"items",void 0),o([l()],A.prototype,"tablesAndLayersLookup",void 0),o([l()],A.prototype,"additionalLayers",void 0),o([l()],A.prototype,"updating",null),o([l()],A.prototype,"_allLayersAndTables",null),A=o([E("esri.undoredo.support.Services")],A);var Ht=()=>F.getLogger("esri.editing.templateUtils");function Qi(e){return e!=null&&"prototype"in e}function zi(e){return _t(e)&&!("definition"in e)}function X(e){return _t(e)&&"definition"in e}function _t(e){return e!=null&&"templateId"in e}function Bi(e){return X(e)&&e?.type==="feature"&&(e.definition==null||mt(e.definition))}function Ki(e){return X(e)&&e?.type==="group"&&(e.definition==null||ft(e.definition))}function Xi(e){return X(e)&&e?.type==="preset"&&(e.definition==null||ht(e.definition))}function Et(e){return X(e)&&e?.definition!=null}var Tt=e=>e==null||typeof e!="object"?[]:[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap(t=>t.templates):[]];function Yi(e,t,r){return p(this,null,function*(){if(t==null)return e.map(d=>({layer:d,templates:Tt(d)}));let s=yield Wt(e,t);O(r);let i=new Map,a=Array.from(s).map(d=>Jt({serviceInfo:d,out:i,signal:r,view:t})),n=yield Promise.allSettled(a);for(let d of n.filter(u=>u.status==="rejected"))Ht().warn("Failed to fetch shared templates for service. Will use standard templates if available.",d.reason);return e.map(d=>({layer:d,templates:i.get(d)??Tt(d)}))})}function Jt(s){return p(this,arguments,function*({serviceInfo:e,out:t,signal:r}){let{featureService:i,layersAndTables:a}=e,n=yield Gt({featureService:i,layers:a.toArray(),signal:r});O(r);for(let[d,u]of n.entries())if(u.length!==0)if(j(d)){let m=$t(u),w=[],_=m.get(1/0)??w;for(let S of d.sublayers){let te=m.get(S.subtypeCode)??w;t.set(S,[...te,..._])}}else t.set(d,u)})}function Gt(s){return p(this,arguments,function*({featureService:e,layers:t,signal:r}){if(!e.capabilities?.editing.supportsSharedTemplates)return new Map;let i=new Map(t.map(d=>[d.layerId,d])),a=yield e.querySharedTemplates({query:{layers:Array.from(i.keys())},requestOptions:{signal:r}}),n=new Map;for(let d of a)for(let u of d.layerIds)i.has(u)&&x(n,i.get(u),()=>[]).push(d);return n})}function Wt(e,t){return p(this,null,function*(){let r=yield Vt(t).load(),s=new Set;for(let i of e)Me(s,Zt(r,i));return yield Promise.all(Array.from(s).map(i=>i.featureService.load())),s})}function Zt(e,t){return We(t)&&t.parent?e.tablesAndLayersLookup.get(t.parent):$(t)?e.tablesAndLayersLookup.get(t):null}function $t(e){let t=new Map;for(let r of e)x(t,r.subtypeCode??1/0,()=>[]).push(r);return t}var ia=100;function Qt(e){return e.type==="point"}function aa(e){return e.type==="polygon"}function na(e){return e.type==="polyline"}function Mt(e){return!!e&&e.type==="radial"}function oa(e){let t=null;for(let r of e)if(r.graphic.geometry){let s=r.graphic.geometry,i=Qt(s)?new je({spatialReference:s.spatialReference,xmin:s.x,xmax:s.x,ymax:s.y,ymin:s.y}):s.extent;t=t==null?i?.clone():t.union(i.extent)}return t}function la(e){let t=new Map;for(let r of e)x(t,r.id,()=>({addFeatures:[],id:r.id,identifierFields:{globalIdField:r.layer.globalIdField,objectIdField:r.layer.objectIdField}})).addFeatures?.push(r.graphic);return[...t.values()]}function zt({edits:e,geometry:t,relationships:r,tag:s="",template:i}){if(Mt(t)){let u=t.geometry.clone();for(let m of u.paths)zt({geometry:new ue({spatialReference:u.spatialReference,paths:[m],hasZ:u.hasZ,hasM:u.hasM}),template:i,edits:e,relationships:r,tag:s});return}let{definition:a,layer:n}=i;t=Bt(t,n);let d=new pe({attributes:a.defaultValues?c({},a.defaultValues):{},geometry:t,sourceLayer:n});if(Ut(d,n),n.globalIdField&&(d.attributes[n.globalIdField]=le()),e.push({id:n.layerId,graphic:d,tag:s,layer:n}),a.relationships.length!==0)for(let u of a.relationships||[]){let m=u.template;if(u.relationshipMetadata==null||!Et(m))throw new f("shared-template:missing-relationship-metadata-or-definition","Relationship part must have metadata and a fully loaded template with definition");let{layer:w}=m,_=new pe({attributes:c({},a.defaultValues),sourceLayer:w});Ut(_,w),w.globalIdField&&(_.attributes[w.globalIdField]=le()),e.push({graphic:_,id:w.layerId,tag:"",layer:w}),r.push(g(c({},u.relationshipMetadata),{sourceGraphic:d,destinationGraphic:_}))}}function Bt(e,t){if(!e)return null;if(e.hasZ===t.hasZ&&e.hasM===t.hasM)return e;switch(e.type){case"point":return new qe(c(c({spatialReference:e.spatialReference,x:e.x,y:e.y},t.hasZ?e.hasZ?{z:e.z}:{z:Y(t)}:{}),t.hasM?e.hasM?{m:e.m}:{m:ee(t)??void 0}:{}));case"polygon":return new Je({spatialReference:e.spatialReference,rings:Lt(e.rings,t.hasZ,t.hasM,Y(t),ee(t),e.hasM?e.hasZ?3:2:-1,e.hasZ?2:-1),hasZ:t.hasZ,hasM:t.hasM});case"polyline":return new ue({spatialReference:e.spatialReference,paths:Lt(e.paths,t.hasZ,t.hasM,Y(t),ee(t),e.hasM?e.hasZ?3:2:-1,e.hasZ?2:-1),hasZ:t.hasZ,hasM:t.hasM});case"multipoint":return new He({spatialReference:e.spatialReference,hasZ:t.hasZ,hasM:t.hasM,points:At(e.points,t.hasZ,t.hasM,Y(t),ee(t),e.hasM?e.hasZ?3:2:-1,e.hasZ?2:-1)});default:return e}}function Lt(e,t,r,s,i,a,n){let d=[];for(let u of e)d.push(At(u,t,r,s,i,a,n));return d}function At(e,t,r,s,i,a,n){let d=[];for(let u of e){let m=[u[0],u[1]];t&&(m[2]=n>-1?u[2]:s),r&&(m[t?3:2]=a>-1?u[a]:i),d.push(m)}return d}function Y(e){return e.capabilities.editing?.zDefault??0}function ee(e){return e.capabilities.editing.supportsUpdateWithoutM?void 0:0}function Ut(e,t){j(t)&&(e.sourceLayer=t.findSublayerForFeature(e))}export{K as a,mt as b,yt as c,gt as d,bt as e,Vt as f,Qi as g,zi as h,X as i,_t as j,Bi as k,Ki as l,Xi as m,Et as n,Yi as o,ia as p,Qt as q,aa as r,na as s,Mt as t,oa as u,la as v,zt as w};
