import{d as H,g as S,n as W}from"./chunk-BKBYZ6R7.js";import{n as E}from"./chunk-NTVLK3P2.js";var _=class{constructor(n=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=n,this._interval=Math.min(n,e)}decreaseRefCount(n,e){let t=n+"/"+e,r=this._cachedBlocks;if(r.has(t)){let o=r.get(t);return o.refCount--,o.refCount<=0&&(r.delete(t),o.controller&&o.controller.abort()),o.refCount}return 0}getBlock(n,e){let t=n+"/"+e,r=this._cachedBlocks;if(r.has(t)){let o=r.get(t);return o.ts=Date.now(),o.refCount++,r.delete(t),r.set(t,o),o.block}return null}putBlock(n,e,t,r){let o=this._cachedBlocks,s=n+"/"+e;if(o.has(s)){let i=o.get(s);i.ts=Date.now(),i.refCount++}else o.set(s,{block:t,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(n,e){let t=this._cachedBlocks,r=n+"/"+e;t.has(r)&&t.delete(r)}updateMaxSize(n){this._size=n,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(this._timer!=null)return;let n=this._cachedBlocks;this._timer=setInterval(()=>{let e=Array.from(n),t=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=t-this._duration;r++)n.delete(e[r][0]);n.size===0&&this._clearTimer()},this._interval)}_trim(){let n=this._cachedBlocks;if(this._size===-1||this._size>=n.size)return;let e=Array.from(n);for(let t=0;t<e.length-this._size;t++)n.delete(e[t][0])}_clearTimer(){this._timer!=null&&(clearInterval(this._timer),this._timer=null)}};var u=new Map,h=new _;function Y(l,n){return n==null?l:`${l}?sliceId=${n}`}function Z(l,n){let e={extent:null,rasterInfo:n,cache:new Map},t=u.get(l);return t?(t.push(e),t.length-1):(u.set(l,[e]),0)}function ee(l,n){let e=u.get(l);e&&(e[n]=null,e.some(t=>t!=null)||u.delete(l))}function te(l,n,e){let t=u.get(l);if(!t)return n==null?h.decreaseRefCount(l,e):0;if(n==null||t[n]==null)return h.decreaseRefCount(l,e);let r=t[n]?.cache,o=r?.get(e);if(r&&o){if(o.refCount--,o.refCount===0){r.delete(e);for(let s=0;s<t.length;s++)t[s]?.cache.delete(e);o.controller&&o.controller.abort()}return o.refCount}return 0}function ne(l,n,e){let t=u.get(l);if(!t)return n==null?h.getBlock(l,e):null;if(n==null||t[n]==null){for(let o=0;o<t.length;o++){let s=t[o]?.cache.get(e);if(s)return s.refCount++,s.block}return h.getBlock(l,e)}let r=t[n]?.cache.get(e);if(r)return r.refCount++,r.block;for(let o=0;o<t.length;o++){if(o===n||!t[o])continue;let s=t[o]?.cache,i=s?.get(e);if(s&&i)return i.refCount++,s.set(e,i),i.block}return null}function oe(l,n,e,t,r=null){let o=u.get(l);if(!o)return void(n==null&&h.putBlock(l,e,t,r));if(n==null||o[n]==null)return void h.putBlock(l,e,t,r);let s={refCount:1,block:t,isResolved:!1,isRejected:!1,controller:r};t.then(()=>s.isResolved=!0).catch(()=>s.isRejected=!0),o[n]?.cache.set(e,s)}function re(l,n,e){let t=u.get(l);t?n!=null&&t[n]!=null?t[n]?.cache.delete(e):h.deleteBlock(l,e):n==null&&h.deleteBlock(l,e)}function O(l,n){let e=u.get(l);return e?e[n]??null:null}function le(l,n,e,t,r,o,s=null){let i=O(l,n);if(!i)return;let m=i.extent,{cache:p,rasterInfo:B}=i;if(m&&m.xmin===e.xmin&&m.xmax===e.xmax&&m.ymin===e.ymin&&m.ymax===e.ymax)return;t=t??0;let R=e.clone().normalize(),{spatialReference:M,transform:w}=B,v=new Set;for(let x=0;x<R.length;x++){let c=R[x];if(c.xmax-c.xmin<=t||c.ymax-c.ymin<=t)continue;let a=S(c,M,s);w!=null&&(a=w.inverseTransform(a));let A=new E({x:t,y:t,spatialReference:c.spatialReference});if(r==null&&!(r=H(A,M,c,s)))return;let{pyramidLevel:g,pyramidResolution:P,excessiveReading:F}=W(r,B,o||"closest");if(F)return;let{storageInfo:f}=B,{origin:b}=f,{x:z,y:I}=P,j=Math.max(0,Math.floor((a.xmin-b.x)/z)),T=Math.max(0,Math.floor((b.y-a.ymax)/I)),L=Math.ceil(a.width/z-.1),q=Math.ceil(a.height/I-.1),$=g>0?f.pyramidBlockWidth:f.blockWidth,D=g>0?f.pyramidBlockHeight:f.blockHeight,d=f.blockBoundary[g];if(!d)continue;let k=1,G=Math.max(d.minCol,Math.floor(j/$)-k),J=Math.max(d.minRow,Math.floor(T/D)-k),K=Math.min(d.maxCol,Math.floor((j+L-1)/$)+k),N=Math.min(d.maxRow,Math.floor((T+q-1)/D)+k);for(let y=J;y<=N;y++)for(let C=G;C<=K;C++)v.add(`${g}/${y}/${C}`)}p.forEach((x,c)=>{if(!v.has(c)){let a=p.get(c);(a==null||a.isResolved||a.isRejected)&&p.delete(c)}}),i.extent={xmin:e.xmin,ymin:e.ymin,xmax:e.xmax,ymax:e.ymax}}export{Y as a,Z as b,ee as c,te as d,ne as e,oe as f,re as g,le as h};
