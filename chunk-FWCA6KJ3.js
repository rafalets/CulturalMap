import{c as Z}from"./chunk-AYSSTKZP.js";import{a as X,b as Q,c as Te,g as x,i as D,k,n as Y}from"./chunk-3BZAI7HK.js";import{a as C}from"./chunk-LNYBTIG7.js";import{C as me,g as de,h as fe,m as R,o as _e,r as B}from"./chunk-SKMO433W.js";import{b as W,c as ce,d as H,m as z,p as U,w as le}from"./chunk-5WKDXHVH.js";import{c as g}from"./chunk-PTZYZULI.js";import{k as ue}from"./chunk-KZKWOEFD.js";import{f as ae,g as he}from"./chunk-7B2UKJ5N.js";import{a as O,c as _}from"./chunk-NHSDW26F.js";import{I as se}from"./chunk-WMHJC7XF.js";import{a as L}from"./chunk-3TQOUBNU.js";function q(n){return n?{ray:X(n.ray),c0:n.c0,c1:n.c1}:{ray:X(),c0:0,c1:Number.MAX_VALUE}}function Me(n,e=q()){return Te(n,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function We(n,e){return Oe(n,n.c0,e)}function Ue(n,e){return Oe(n,n.c1,e)}function Oe(n,e,t){return H(t,n.ray.origin,z(t,n.ray.direction,e))}var Xe=new C(()=>q());function ut(n){return n?[R(n[0]),R(n[1]),R(n[2]),R(n[3]),R(n[4]),R(n[5])]:[R(),R(),R(),R(),R(),R()]}function Be(){return[O(),O(),O(),O(),O(),O(),O(),O()]}function ct(n,e){for(let t=0;t<$;t++)_e(n[t],e[t]);return n}function lt(n,e,t,o=Ie){let r=he(fe.get(),e,n);ae(r,r);for(let i=0;i<Pe;++i){let h=ue(de.get(),je[i],r);ce(o[i],h[0]/h[3],h[1]/h[3],h[2]/h[3])}xe(t,o)}function xe(n,e){B(e[s.FAR_BOTTOM_LEFT],e[s.NEAR_BOTTOM_LEFT],e[s.NEAR_TOP_LEFT],n[N.LEFT]),B(e[s.NEAR_BOTTOM_RIGHT],e[s.FAR_BOTTOM_RIGHT],e[s.FAR_TOP_RIGHT],n[N.RIGHT]),B(e[s.FAR_BOTTOM_LEFT],e[s.FAR_BOTTOM_RIGHT],e[s.NEAR_BOTTOM_RIGHT],n[N.BOTTOM]),B(e[s.NEAR_TOP_LEFT],e[s.NEAR_TOP_RIGHT],e[s.FAR_TOP_RIGHT],n[N.TOP]),B(e[s.NEAR_BOTTOM_LEFT],e[s.NEAR_BOTTOM_RIGHT],e[s.NEAR_TOP_RIGHT],n[N.NEAR]),B(e[s.FAR_BOTTOM_RIGHT],e[s.FAR_BOTTOM_LEFT],e[s.FAR_TOP_LEFT],n[N.FAR])}function v(n,e){for(let t=0;t<$;t++){let o=n[t];if(o[0]*e[0]+o[1]*e[1]+o[2]*e[2]+o[3]>=e[3])return!1}return!0}function dt(n,e){for(let t=0;t<$;t++){let o=n[t];if(!me(o,e))return!1}return!0}var N,s;(function(n){n[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR"})(N||(N={})),function(n){n[n.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",n[n.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",n[n.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",n[n.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",n[n.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",n[n.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",n[n.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",n[n.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(s||(s={}));var ft={bottom:[s.FAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_LEFT,s.FAR_BOTTOM_LEFT],near:[s.NEAR_BOTTOM_LEFT,s.NEAR_BOTTOM_RIGHT,s.NEAR_TOP_RIGHT,s.NEAR_TOP_LEFT],far:[s.FAR_BOTTOM_RIGHT,s.FAR_BOTTOM_LEFT,s.FAR_TOP_LEFT,s.FAR_TOP_RIGHT],right:[s.NEAR_BOTTOM_RIGHT,s.FAR_BOTTOM_RIGHT,s.FAR_TOP_RIGHT,s.NEAR_TOP_RIGHT],left:[s.FAR_BOTTOM_LEFT,s.NEAR_BOTTOM_LEFT,s.NEAR_TOP_LEFT,s.FAR_TOP_LEFT],top:[s.FAR_TOP_LEFT,s.NEAR_TOP_LEFT,s.NEAR_TOP_RIGHT,s.FAR_TOP_RIGHT]},$=6,Pe=8,je=[g(-1,-1,-1,1),g(1,-1,-1,1),g(1,1,-1,1),g(-1,1,-1,1),g(-1,-1,1,1),g(1,-1,1,1),g(1,1,1,1),g(-1,1,1,1)],_t=new C(q),Ie=Be();var K=class n{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,t&&(t.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),t.maximumDepth!==void 0&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),re[0]=null,j.prune(),I.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);let o=l.acquire();for(let r=0;r<t;r++){let i=e[r];this._isDegenerate(i)?this._degenerateObjects.add(i):(o.init(this._root),this._add(i,o))}l.release(o)}remove(e,t=null){this._objectCount-=e.length;let o=l.acquire();for(let r of e){let i=t??D(this.objectToBoundingSphere(r),Ce);w(i[3])?(o.init(this._root),Le(r,i,o)):this._degenerateObjects.delete(r)}l.release(o),this._shrink()}update(e,t){if(!w(t[3])&&this._isDegenerate(e))return;let o=we(e);this.remove(o,t),this.add(o)}forEachAlongRay(e,t,o){let r=Q(e,t);P(this._root,i=>{if(!ze(r,i))return!1;let h=i.node;return h.terminals.forAll(c=>{this._intersectsObject(r,c)&&o(c)}),h.residents!==null&&h.residents.forAll(c=>{this._intersectsObject(r,c)&&o(c)}),!0})}forEachAlongRayWithVerticalOffset(e,t,o,r){let i=Q(e,t);P(this._root,h=>{if(!Ge(i,h,r))return!1;let c=h.node;return c.terminals.forAll(a=>{this._intersectsObjectWithOffset(i,a,r)&&o(a)}),c.residents!==null&&c.residents.forAll(a=>{this._intersectsObjectWithOffset(i,a,r)&&o(a)}),!0})}forEach(e){P(this._root,t=>{let o=t.node;return o.terminals.forAll(e),o.residents!==null&&o.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,o,r=()=>!0,i=1/0){let h=1/0,c=1/0,a=null,d=ee(e,t),m=u=>{if(--i,!r(u))return;let T=this.objectToBoundingSphere(u);if(!v(o,T))return;let F=M(e,t,T),G=F-T[3],f=F+T[3];G<h&&(h=G,c=f,a=u)};return Re(this._root,u=>{if(i<=0||!v(o,u.bounds)||(z(b,d,u.halfSize),H(b,b,u.bounds),M(e,t,b)>c))return!1;let T=u.node;return T.terminals.forAll(F=>m(F)),T.residents!==null&&T.residents.forAll(F=>m(F)),!0},e,t),a}forEachInDepthRange(e,t,o,r,i,h,c){let a=-1/0,d=1/0,m={setRange:f=>{o===n.DepthOrder.FRONT_TO_BACK?(a=Math.max(a,f.near),d=Math.min(d,f.far)):(a=Math.max(a,-f.far),d=Math.min(d,-f.near))}};m.setRange(r);let u=M(t,o,e),T=ee(t,o),F=ee(t,-o),G=f=>{if(!c(f))return;let S=this.objectToBoundingSphere(f),y=S,ie=M(t,o,y)-u,Se=ie-S[3],Ne=ie+S[3];Se>d||Ne<a||!v(h,S)||i(f,m)};Re(this._root,f=>{if(!v(h,f.bounds)||(z(b,T,f.halfSize),H(b,b,f.bounds),M(t,o,b)-u>d)||(z(b,F,f.halfSize),H(b,b,f.bounds),M(t,o,b)-u<a))return!1;let S=f.node;return S.terminals.forAll(y=>G(y)),S.residents!==null&&S.residents.forAll(y=>G(y)),!0},t,o)}forEachNode(e){P(this._root,t=>e(t.node,t.bounds,t.halfSize,t.depth))}forEachNeighbor(e,t){let o=k(t),r=t,i=a=>{let d=this.objectToBoundingSphere(a),m=k(d),u=o+m;return!(U(d,r)-u*u<=0)||e(a)},h=!0,c=a=>{h&&(h=i(a))};P(this._root,a=>{let d=k(a.bounds),m=o+d;if(U(a.bounds,r)-m*m>0)return!1;let u=a.node;return u.terminals.forAll(c),h&&u.residents!==null&&u.residents.forAll(c),h}),h&&this.forEachDegenerateObject(c)}_intersectsObject(e,t){let o=this.objectToBoundingSphere(t);return!(o[3]>0)||Y(o,e)}_intersectsObjectWithOffset(e,t,o){let r=this.objectToBoundingSphere(t);return!(r[3]>0)||Y(o.applyToBoundingSphere(r),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){let t=e.node.residents;e.node.residents=null;for(let o=0;o<t.length;o++){let r=l.acquire().init(e);this._add(t.at(o),r),l.release(r)}}_grow(e,t){if(t!==0&&(pe(e,t,o=>this.objectToBoundingSphere(o),E),w(E[3])&&!this._fitsInsideTree(E)))if(Fe(this._root.node))D(E,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{let o=this._rootBoundsForRootAsSubNode(E);this._placingRootViolatesMaxDepth(o)?this._rebuildTree(E,o):this._growRootAsSubNode(o),l.release(o)}}_rebuildTree(e,t){W(ne,t.bounds),ne[3]=t.halfSize,pe([e,ne],2,r=>r,oe);let o=l.acquire().init(this._root);this._root.initFrom(null,oe,oe[3]),this._root.increaseHalfSize(1.25),P(o,r=>(this.add(r.node.terminals.data,r.node.terminals.length),r.node.residents!==null&&this.add(r.node.residents.data,r.node.residents.length),!0)),l.release(o)}_placingRootViolatesMaxDepth(e){let t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E,o=0;return P(this._root,r=>(o=Math.max(o,r.depth),o+t<=this._maximumDepth)),o+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){let t=e[3],o=e,r=-1/0,i=this._root.bounds,h=this._root.halfSize;for(let a=0;a<3;a++){let d=i[a]-h-(o[a]-t),m=o[a]+t-(i[a]+h),u=Math.max(0,Math.ceil(d/(2*h))),T=Math.max(0,Math.ceil(m/(2*h)))+1,F=2**Math.ceil(Math.log(u+T)*Math.LOG2E);r=Math.max(r,F),V[a].min=u,V[a].max=T}for(let a=0;a<3;a++){let d=V[a].min,m=V[a].max,u=(r-(d+m))/2;d+=Math.ceil(u),m+=Math.floor(u);let T=i[a]-h-d*h*2;te[a]=T+(m+d)*h}let c=r*h;return te[3]=c*Ee,l.acquire().initFrom(null,te,c,0)}_growRootAsSubNode(e){let t=this._root.node;W(E,this._root.bounds),E[3]=this._root.halfSize,this._root.init(e),e.advanceTo(E,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){let e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null,t=this._root.node.children,o=0,r=0;for(;r<t.length&&e==null;)o=r++,e=t[o];for(;r<t.length;)if(t[r++])return-1;return o}_isDegenerate(e){return!w(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){let t=this._root.bounds,o=this._root.halfSize;return e[3]<=o&&e[0]>=t[0]-o&&e[0]<=t[0]+o&&e[1]>=t[1]-o&&e[1]<=t[1]+o&&e[2]>=t[2]-o&&e[2]<=t[2]+o}toJSON(){let{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:o}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:o,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(e){let t=e.children.map(i=>i?this._nodeToJSON(i):null),o=e.residents?.map(i=>this.objectToBoundingSphere(i)),r=e.terminals?.map(i=>this.objectToBoundingSphere(i));return{children:t,residents:o,terminals:r}}static fromJSON(e){let t=new n(o=>o,{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}},l=class n{constructor(){this.bounds=x(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,o,r=this.depth){return this.node=e??n.createEmptyNode(),t&&D(t,this.bounds),this.halfSize=o,this.depth=r,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*Ee}advance(e){let t=this.node.children[e];t||(t=n.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;let o=ge[e];return this.bounds[0]+=o[0]*this.halfSize,this.bounds[1]+=o[1]*this.halfSize,this.bounds[2]+=o[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,o=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!o)return t&&t(this,-1),!1;this.node.residents=null}let r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){let t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new L({shrink:!0}),residents:new L({shrink:!0})}}static acquire(){return n._pool.acquire()}static release(e){n._pool.release(e)}static clearPool(){n._pool.prune()}};function P(n,e){let t=l.acquire().init(n),o=[t];for(;o.length!==0;){if(t=o.pop(),e(t)&&!t.isLeaf())for(let r=0;r<t.node.children.length;r++)t.node.children[r]&&o.push(l.acquire().init(t).advance(r));l.release(t)}}function Re(n,e,t,o=K.DepthOrder.FRONT_TO_BACK){let r=l.acquire().init(n),i=[r];for(ve(t,o,be);i.length!==0;){if(r=i.pop(),e(r)&&!r.isLeaf())for(let h=7;h>=0;--h){let c=be[h];r.node.children[c]&&i.push(l.acquire().init(r).advance(c))}l.release(r)}}function Le(n,e,t){j.clear();let o=t.advanceTo(e,(r,i)=>{j.push(r.node),j.push(i)})?t.node.terminals:t.node.residents;if(o.removeUnordered(n),o.length===0)for(let r=j.length-2;r>=0&&He(j.data[r],j.data[r+1]);r-=2);}function He(n,e){return e>=0&&(n.children[e]=null),!!Fe(n)&&(n.residents===null&&(n.residents=new L({shrink:!0})),!0)}function ze(n,e){return J(e.bounds,2*-e.halfSize,p),J(e.bounds,2*e.halfSize,A),Z(n.origin,n.direction,p,A)}function Ge(n,e,t){return J(e.bounds,2*-e.halfSize,p),J(e.bounds,2*e.halfSize,A),t.applyToMinMax(p,A),Z(n.origin,n.direction,p,A)}function Fe(n){if(n.terminals.length!==0)return!1;if(n.residents!==null)return n.residents.length===0;for(let e=0;e<n.children.length;e++)if(n.children[e])return!1;return!0}function ye(n,e){n[0]=Math.min(n[0],e[0]-e[3]),n[1]=Math.min(n[1],e[1]-e[3]),n[2]=Math.min(n[2],e[2]-e[3])}function De(n,e){n[0]=Math.max(n[0],e[0]+e[3]),n[1]=Math.max(n[1],e[1]+e[3]),n[2]=Math.max(n[2],e[2]+e[3])}function J(n,e,t){t[0]=n[0]+e,t[1]=n[1]+e,t[2]=n[2]+e}function pe(n,e,t,o){if(e===1){let r=t(n[0]);D(r,o)}else{p[0]=1/0,p[1]=1/0,p[2]=1/0,A[0]=-1/0,A[1]=-1/0,A[2]=-1/0;for(let r=0;r<e;r++){let i=t(n[r]);w(i[3])&&(ye(p,i),De(A,i))}le(o,p,A,.5),o[3]=Math.max(A[0]-p[0],A[1]-p[1],A[2]-p[2])/2}}function ve(n,e,t){if(!I.length)for(let o=0;o<8;++o)I.push({index:0,distance:0});for(let o=0;o<8;++o){let r=ge[o];I.data[o].index=o,I.data[o].distance=M(n,e,r)}I.sort((o,r)=>o.distance-r.distance);for(let o=0;o<8;++o)t[o]=I.data[o].index}function ee(n,e){let t,o=1/0;for(let r=0;r<8;++r){let i=M(n,e,Ae[r]);i<o&&(o=i,t=Ae[r])}return t}function M(n,e,t){return e*(n[0]*t[0]+n[1]*t[1]+n[2]*t[2])}function w(n){return!isNaN(n)&&n!==-1/0&&n!==1/0&&n>0}l._pool=new se(l),function(n){var e;(e=n.DepthOrder||(n.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(K);var ge=[_(-1,-1,-1),_(1,-1,-1),_(-1,1,-1),_(1,1,-1),_(-1,-1,1),_(1,-1,1),_(-1,1,1),_(1,1,1)],Ae=[_(-1,-1,-1),_(-1,-1,1),_(-1,1,-1),_(-1,1,1),_(1,-1,-1),_(1,-1,1),_(1,1,-1),_(1,1,1)],Ee=Math.sqrt(3),re=[null];function we(n){return re[0]=n,re}var te=x(),b=O(),p=O(),A=O(),j=new L,Ce=x(),E=x(),ne=x(),oe=x(),V=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],I=new L,be=[0,0,0,0,0,0,0,0];export{q as a,Me as b,We as c,Ue as d,ut as e,ct as f,lt as g,dt as h,N as i,K as j};
