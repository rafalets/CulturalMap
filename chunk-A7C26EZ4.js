import{a as K}from"./chunk-AZKP3OCM.js";import{a as X}from"./chunk-S52JRLJC.js";import{e as R}from"./chunk-DBZKWPEX.js";import{a}from"./chunk-RWCIDBNQ.js";import{a as Ee}from"./chunk-Y7MZCJ2F.js";import{E as Ie,b as re,c as k,d as he,e as se,o as Ne,t as j,u as q,v as ne}from"./chunk-5WKDXHVH.js";import{a as E}from"./chunk-NHSDW26F.js";import{f as oe,i as de}from"./chunk-VOFKUGRY.js";import{a as U}from"./chunk-3TQOUBNU.js";import{c as me}from"./chunk-47GHT6OF.js";var Se=R().vec3f(a.POSITION).u16(a.COMPONENTINDEX).freeze(),Re=R().vec2u8(a.SIDENESS).freeze(),je=X(Re),H=R().vec3f(a.POSITION0).vec3f(a.POSITION1).vec2i16(a.NORMALCOMPRESSED).u16(a.COMPONENTINDEX).u8(a.VARIANTOFFSET,{glNormalized:!0}).u8(a.VARIANTSTROKE).u8(a.VARIANTEXTENSION,{glNormalized:!0}).freeze(),G=R().vec3f(a.POSITION0).vec3f(a.POSITION1).vec2i16(a.NORMALCOMPRESSED).vec2i16(a.NORMAL2COMPRESSED).u16(a.COMPONENTINDEX).u8(a.VARIANTOFFSET,{glNormalized:!0}).u8(a.VARIANTSTROKE).u8(a.VARIANTEXTENSION,{glNormalized:!0}).freeze(),qe=new Map([[a.POSITION0,0],[a.POSITION1,1],[a.COMPONENTINDEX,2],[a.VARIANTOFFSET,3],[a.VARIANTSTROKE,4],[a.VARIANTEXTENSION,5],[a.NORMALCOMPRESSED,6],[a.NORMAL2COMPRESSED,7],[a.SIDENESS,8]]);var J=class{constructor(){this.position0=E(),this.position1=E(),this.faceNormal0=E(),this.faceNormal1=E(),this.componentIndex=0,this.cosAngle=0}};var $=-1;function Ae(e,o,r){let n=e.vertices.position,c=e.vertices.componentIndex,f=N.position0,m=N.position1,d=N.faceNormal0,O=N.faceNormal1,{edges:i,normals:p}=Pe(e),I=i.length/4,A=o.allocate(I),M=0,z=I,w=r?.allocate(z),_=0,t=0,s=0;Q.length=0;for(let g=0;g<I;++g){let T=4*g;n.getVec(i.data[T],f),n.getVec(i.data[T+1],m);let D=Q.pushNew();D.index=4*g,D.length=Ne(f,m)}Q.sort((g,T)=>T.length-g.length);let l=new Array,u=new Array;Q.forAll(({length:g,index:T})=>{let D=i.data[T],Le=i.data[T+1],fe=i.data[T+2],pe=i.data[T+3],ge=pe===$;if(n.getVec(D,f),n.getVec(Le,m),ge){let y=3*fe;k(d,p.data[y],p.data[y+1],p.data[y+2]),re(O,d),N.componentIndex=c.get(D),N.cosAngle=q(d,O)}else{let y=3*fe;if(k(d,p.data[y],p.data[y+1],p.data[y+2]),y=3*pe,k(O,p.data[y],p.data[y+1],p.data[y+2]),N.componentIndex=c.get(D),N.cosAngle=q(d,O),Ve(N,Be))return;N.cosAngle<-.9999&&re(O,d)}t+=g,s++,ge||ve(N,be)?(o.write(A,M++,N),l.push(g)):Me(N,ye)&&(w&&r&&r.write(w,_++,N),u.push(g))});let S=new Float32Array(l.reverse()),x=new Float32Array(u.reverse()),L=w&&r?{instancesData:w.slice(0,_),lodInfo:{lengths:x}}:void 0;return{regular:{instancesData:A.slice(0,M),lodInfo:{lengths:S}},silhouette:L,averageEdgeLength:t/s}}function ve(e,o){return e.cosAngle<o}function Ve(e,o){return e.cosAngle>o}function Me(e,o){let r=de(e.cosAngle);return Ie(Oe,e.position1,e.position0),r*(q(ne(De,e.faceNormal0,e.faceNormal1),Oe)>0?-1:1)>o}function Pe(e){let o=e.faces.length/3,r=e.faces,n=e.neighbors,c=e.vertices.position;h.length=ae.length=0;for(let f=0;f<o;f++){let m=3*f,d=n[m],O=n[m+1],i=n[m+2],p=r[m],I=r[m+1],A=r[m+2];c.getVec(p,P),c.getVec(I,Y),c.getVec(A,Z),se(Y,Y,P),se(Z,Z,P),ne(P,Y,Z),j(P,P),ae.pushArray(P),(d===$||p<I)&&(h.push(p),h.push(I),h.push(f),h.push(d)),(O===$||I<A)&&(h.push(I),h.push(A),h.push(f),h.push(O)),(i===$||A<p)&&(h.push(A),h.push(p),h.push(f),h.push(i))}return{edges:h,normals:ae}}var ie=class{constructor(){this.index=0,this.length=0}},Q=new U({allocator:e=>e||new ie,deallocator:null}),h=new U({deallocator:null}),ae=new U({deallocator:null}),N=new J,De=E(),Oe=E(),P=E(),Y=E(),Z=E(),ye=oe(4),Be=Math.cos(ye),Ce=oe(35),be=Math.cos(Ce);function ce(e,o,r){let n=o/3,c=new Uint32Array(r+1),f=new Uint32Array(r+1),m=(t,s)=>{t<s?c[t+1]++:f[s+1]++};for(let t=0;t<n;t++){let s=e[3*t],l=e[3*t+1],u=e[3*t+2];m(s,l),m(l,u),m(u,s)}let d=0,O=0;for(let t=0;t<r;t++){let s=c[t+1],l=f[t+1];c[t+1]=d,f[t+1]=O,d+=s,O+=l}let i=new Uint32Array(6*n),p=c[r],I=(t,s,l)=>{if(t<s){let u=c[t+1]++;i[2*u]=s,i[2*u+1]=l}else{let u=f[s+1]++;i[2*p+2*u]=t,i[2*p+2*u+1]=l}};for(let t=0;t<n;t++){let s=e[3*t],l=e[3*t+1],u=e[3*t+2];I(s,l,t),I(l,u,t),I(u,s,t)}let A=(t,s)=>{let l=2*t,u=s-t;for(let S=1;S<u;S++){let x=i[l+2*S],L=i[l+2*S+1],g=S-1;for(;g>=0&&i[l+2*g]>x;g--)i[l+2*g+2]=i[l+2*g],i[l+2*g+3]=i[l+2*g+1];i[l+2*g+2]=x,i[l+2*g+3]=L}};for(let t=0;t<r;t++)A(c[t],c[t+1]),A(p+f[t],p+f[t+1]);let M=new Int32Array(3*n),z=(t,s)=>t===e[3*s]?0:t===e[3*s+1]?1:t===e[3*s+2]?2:-1,w=(t,s)=>{let l=z(t,s);M[3*s+l]=-1},_=(t,s,l,u)=>{let S=z(t,s);M[3*s+S]=u;let x=z(l,u);M[3*u+x]=s};for(let t=0;t<r;t++){let s=c[t],l=c[t+1],u=f[t],S=f[t+1];for(;s<l&&u<S;){let x=i[2*s],L=i[2*p+2*u];x===L?(_(t,i[2*s+1],L,i[2*p+2*u+1]),s++,u++):x<L?(w(t,i[2*s+1]),s++):(w(L,i[2*p+2*u+1]),u++)}for(;s<l;)w(t,i[2*s+1]),s++;for(;u<S;)w(i[2*p+2*u],i[2*p+2*u+1]),u++}return M}var ue=.7,te=class{updateSettings(o){this.settings=o,this._edgeHashFunction=o.reducedPrecision?We:Fe}write(o,r,n){ee.seed=this._edgeHashFunction(n);let c=ee.getIntRange(0,255),f=ee.getIntRange(0,this.settings.variants-1),m=ee.getFloat(),d=255*(.5*ze(-(1-Math.min(m/ue,1))+Math.max(0,m-ue)/(1-ue),1.2)+.5);o.position0.setVec(r,n.position0),o.position1.setVec(r,n.position1),o.componentIndex.set(r,n.componentIndex),o.variantOffset.set(r,c),o.variantStroke.set(r,f),o.variantExtension.set(r,d)}},v=new Float32Array(6),V=new Uint32Array(v.buffer),b=new Uint32Array(1);function Fe(e){return v[0]=e.position0[0],v[1]=e.position0[1],v[2]=e.position0[2],v[3]=e.position1[0],v[4]=e.position1[1],v[5]=e.position1[2],b[0]=31*(31*(31*(31*(31*(166811+V[0])+V[1])+V[2])+V[3])+V[4])+V[5],b[0]}function We(e){let o=v;o[0]=B(e.position0[0]),o[1]=B(e.position0[1]),o[2]=B(e.position0[2]),o[3]=B(e.position1[0]),o[4]=B(e.position1[1]),o[5]=B(e.position1[2]),b[0]=5381;for(let r=0;r<V.length;r++)b[0]=31*b[0]+V[r];return b[0]}var we=1e4;function B(e){return Math.round(e*we)/we}function ze(e,o){return Math.abs(e)**o*Math.sign(e)}var F=class{constructor(){this._commonWriter=new te}updateSettings(o){this._commonWriter.updateSettings(o)}allocate(o){return H.createBuffer(o)}write(o,r,n){this._commonWriter.write(o,r,n),he(C,n.faceNormal0,n.faceNormal1),j(C,C);let{typedBuffer:c,typedBufferStride:f}=o.normalCompressed;K(c,r,C[0],C[1],C[2],f)}};F.Layout=H,F.glLayout=X(H,1);var W=class{constructor(){this._commonWriter=new te}updateSettings(o){this._commonWriter.updateSettings(o)}allocate(o){return G.createBuffer(o)}write(o,r,n){this._commonWriter.write(o,r,n);{let{typedBuffer:c,typedBufferStride:f}=o.normalCompressed;K(c,r,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],f)}{let{typedBuffer:c,typedBufferStride:f}=o.normal2Compressed;K(c,r,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],f)}}};W.Layout=G,W.glLayout=X(G,1);var C=E(),ee=new me;function ht(e){let o=Xe(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return xe.updateSettings(e.writerSettings),Te.updateSettings(e.writerSettings),Ae(o,xe,Te)}function Xe(e,o,r,n){if(o){let m=ce(r,n,e.count);return new le(r,n,m,e)}let c=Ee(e.buffer,e.stride/4,{originalIndices:r,originalIndicesLength:n}),f=ce(c.indices,n,c.uniqueCount);return{faces:c.indices,facesLength:c.indices.length,neighbors:f,vertices:Se.createView(c.buffer)}}var le=class{constructor(o,r,n,c){this.faces=o,this.facesLength=r,this.neighbors=n,this.vertices=c}},xe=new F,Te=new W,Nt=R().vec3f(a.POSITION0).vec3f(a.POSITION1),It=R().vec3f(a.POSITION0).vec3f(a.POSITION1).u16(a.COMPONENTINDEX);export{Se as a,Ae as b,ht as c,Xe as d,Nt as e,It as f};
