import{b as j}from"./chunk-XSTBHERR.js";import{a as m}from"./chunk-CNQVGGE6.js";import{ga as R}from"./chunk-IG66NQHW.js";import{c as S}from"./chunk-WMHJC7XF.js";import{u as y}from"./chunk-D2LVMNOU.js";import{b as C,n as _}from"./chunk-HHDFN2GK.js";import{f as p}from"./chunk-VTHXE323.js";function G(s=!1,e){if(s){let{elevationInfo:t,alignPointsInFeatures:n}=e;return new z(t,n)}return new x}var x=class{alignCandidates(e,t,n){return p(this,null,function*(){return e})}notifyElevationSourceChange(){}},E=1024,z=class{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new m(E),this._cacheVersion=0}alignCandidates(e,t,n){return p(this,null,function*(){let o=this._elevationInfo;return o==null||o.mode!=="absolute-height"||o.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(F(e,t,o),e)})}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}_alignComputedElevationCandidates(e,t,n){return p(this,null,function*(){let o=new Map;for(let u of e)S(o,u.objectId,M).push(u);let[a,r,i]=this._prepareQuery(o,t),c=yield this._alignPointsInFeatures(a,n);if(y(n),i!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t,n);this._applyCacheAndResponse(a,c,r);let{drapedObjectIds:d,failedObjectIds:l}=c,h=[];for(let u of e){let{objectId:f}=u;d.has(f)&&u.type==="edge"&&(u.draped=!0),l.has(f)||h.push(u)}return h})}_prepareQuery(e,t){let n=[],o=[];for(let[a,r]of e){let i=[];for(let c of r)this._addToQueriesOrCachedResult(a,c.target,i,o),c.type==="edge"&&(this._addToQueriesOrCachedResult(a,c.start,i,o),this._addToQueriesOrCachedResult(a,c.end,i,o));i.length!==0&&n.push({objectId:a,points:i})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},o,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,o){let a=O(e,t),r=this._alignmentsCache.get(a);r==null?n.push(t):o.push(new I(t,r))}_applyCacheAndResponse(e,{elevations:t,drapedObjectIds:n,failedObjectIds:o},a){for(let c of a)c.apply();let r=0,i=this._alignmentsCache;for(let{objectId:c,points:d}of e.pointsInFeatures){if(o.has(c)){r+=d.length;continue}let l=!n.has(c);for(let h of d){let u=O(c,h),f=t[r++];h.z=f,l&&i.put(u,f,1)}}}},I=class{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}};function O(s,{x:e,y:t,z:n,spatialReference:o}){return`${s}-${e}-${t}-${n??0}}-wkid:${o?.wkid}`}function F(s,e,t){let{offset:n,unit:o}=t;if(n==null)return;let a=R(e),r=n*(j(o??"meters")/a);for(let i of s)switch(i.type){case"edge":i.start.z+=r,i.end.z+=r;continue;case"vertex":i.target.z+=r;continue}}function M(){return[]}var b=class{filter(e,t){return t}notifyElevationSourceChange(){}},w=class{filter(e,t){let{point:n,distance:o}=e,{z:a}=n;if(a==null||t.length===0)return t;let r=U(o),i=this._updateCandidatesTo3D(t,n,r).filter(Q);return i.sort(k),i}_updateCandidatesTo3D(e,t,n){for(let o of e)switch(o.type){case"edge":T(o,t,n);continue;case"vertex":P(o,t,n);continue}return e}};function Q(s){return s.distance<=1}function Y(s=!1){return s?new w:new b}function T(s,e,{x:t,y:n,z:o}){let{start:a,end:r,target:i}=s;s.draped||A(i,e,a,r);let c=(e.x-i.x)/t,d=(e.y-i.y)/n,l=(e.z-i.z)/o;s.distance=Math.sqrt(c*c+d*d+l*l)}function A(s,e,t,n){let o=n.x-t.x,a=n.y-t.y,r=n.z-t.z,i=o*o+a*a+r*r,c=(e.x-t.x)*o+(e.y-t.y)*a+r*(e.z-t.z),d=Math.min(1,Math.max(0,c/i)),l=t.x+o*d,h=t.y+a*d,u=t.z+r*d;s.x=l,s.y=h,s.z=u}function P(s,e,{x:t,y:n,z:o}){let{target:a}=s,r=(e.x-a.x)/t,i=(e.y-a.y)/n,c=(e.z-a.z)/o,d=Math.sqrt(r*r+i*i+c*c);s.distance=d}function U(s){return typeof s=="number"?{x:s,y:s,z:s}:s}function k(s,e){return s.distance-e.distance}function at(s=!1,e){return s?new $(e):new v}var v=class{fetch(){return p(this,null,function*(){return[]})}notifySymbologyChange(){}},q=1024,$=class{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new m(q),this._cacheVersion=0}fetch(e,t){return p(this,null,function*(){if(e.length===0)return[];let n=[],o=[],a=this._candidatesCache;for(let h of e){let u=V(h),f=a.get(u);if(f)for(let g of f)o.push(C(g));else n.push(h),a.put(u,[],1)}if(n.length===0)return o;let r=this._cacheVersion,{candidates:i,sourceCandidateIndices:c}=yield this._getSymbologyCandidates(n,t);if(y(t),r!==this._cacheVersion)return this.fetch(e,t);let d=[],{length:l}=i;for(let h=0;h<l;++h){let u=i[h],f=V(n[c[h]]),g=a.get(f);g.push(u),a.put(f,g,g.length),d.push(C(u))}return o.concat(d)})}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}};function V(s){switch(s.type){case"vertex":{let{objectId:e,target:t}=s,n=`${e}-vertex-${t.x}-${t.y}-${t.z??0}`;return _(n).toString()}case"edge":{let{objectId:e,start:t,end:n}=s,o=`${e}-edge-${t.x}-${t.y}-${t.z??0}-to-${n.x}-${n.y}-${n.z??0}`;return _(o).toString()}default:return""}}export{G as a,Y as b,at as c};
