import{b as _t}from"./chunk-T5WZVCEF.js";import{a as gt}from"./chunk-LUKGY62K.js";import{a as nt,b as pt}from"./chunk-SYWAMIWJ.js";import{a as lt}from"./chunk-WEHK3GDX.js";import{a as A}from"./chunk-BSGVTG6F.js";import"./chunk-QLRE7CF5.js";import{b as ht,c as mt,d as ct}from"./chunk-4KBVKETT.js";import{b as dt}from"./chunk-2ZJT7DIL.js";import{a as ut}from"./chunk-S5AJRU4D.js";import"./chunk-NQFVVK5O.js";import"./chunk-EXBVIJ5M.js";import{a as j}from"./chunk-ESGUJXGX.js";import"./chunk-O3ESJKNW.js";import"./chunk-X6GMII6M.js";import"./chunk-UDRQLOEB.js";import"./chunk-KQSP6CH6.js";import"./chunk-423EPWZ2.js";import"./chunk-MPSCABVQ.js";import{c as ot}from"./chunk-RME3N3WY.js";import"./chunk-VZWPFXBV.js";import"./chunk-BYXBJQAS.js";import"./chunk-TTCWVZMG.js";import"./chunk-RW7NPOAD.js";import"./chunk-WSIRBPY7.js";import"./chunk-BKA6DT3N.js";import"./chunk-WH5SLVE3.js";import"./chunk-ET5YWLZA.js";import"./chunk-WQQ6B254.js";import"./chunk-RVXFHI3X.js";import"./chunk-JXEAVWUK.js";import"./chunk-Y6FO2W3O.js";import"./chunk-T3DGHEVR.js";import"./chunk-ZOOQQO74.js";import"./chunk-XAHD7XBV.js";import"./chunk-7NH66LUL.js";import"./chunk-G6C3YEMS.js";import"./chunk-R3ABULTC.js";import"./chunk-JLWYDAJB.js";import"./chunk-R2FEHFRM.js";import"./chunk-W5OI4BJ2.js";import"./chunk-YFINME5F.js";import"./chunk-7LF5QJDR.js";import{d as it,l as at}from"./chunk-BKBYZ6R7.js";import{a as st,b as rt,d as R}from"./chunk-XBWYS7K7.js";import"./chunk-NOHUHVCW.js";import"./chunk-PTXLSCMJ.js";import"./chunk-FZ5X7HOK.js";import"./chunk-DHLVTH5U.js";import"./chunk-GK3RYCKG.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-3ZANJLLA.js";import"./chunk-7QY3BMVN.js";import"./chunk-WPDP647R.js";import"./chunk-4E4FE2IX.js";import"./chunk-5SSISWTF.js";import"./chunk-O4PKXMAM.js";import"./chunk-ONYJLWAD.js";import"./chunk-HBZAOVHW.js";import"./chunk-FYZRIMPP.js";import"./chunk-CKG2WYMF.js";import"./chunk-BA3KT2MW.js";import"./chunk-SP2CO3KX.js";import"./chunk-3V2UIH2D.js";import"./chunk-NKCIC566.js";import"./chunk-7LVUNMSI.js";import"./chunk-SNL6C5QO.js";import"./chunk-7HLFOT25.js";import"./chunk-67ZC4UJG.js";import"./chunk-R3KYOH5H.js";import"./chunk-3QCWBHPT.js";import"./chunk-4D3QHJI2.js";import"./chunk-E2J2V7JN.js";import"./chunk-7X55A7Q6.js";import"./chunk-HUWVQAJL.js";import"./chunk-J3BDQLVD.js";import"./chunk-X7BNFUFQ.js";import"./chunk-DQOFEB5P.js";import{c as k}from"./chunk-JMMCRVVF.js";import"./chunk-37H4LYIE.js";import{i as O,k as et}from"./chunk-BUZBVNOM.js";import"./chunk-VYZHOYXV.js";import"./chunk-ICWXUNPZ.js";import"./chunk-EUD3KSLO.js";import"./chunk-XGP6WN73.js";import"./chunk-DCKTHYU4.js";import"./chunk-525N4T6K.js";import"./chunk-EBK2L6ZQ.js";import"./chunk-ZMJUEIM7.js";import"./chunk-6T37AWU6.js";import"./chunk-XC4BCVYU.js";import"./chunk-V7IMCFL4.js";import"./chunk-XD6QSICT.js";import"./chunk-FTOLVNUN.js";import"./chunk-EOLWCIYR.js";import"./chunk-YOMR2DCD.js";import"./chunk-KDF3RZ2K.js";import"./chunk-AFSNSPOG.js";import"./chunk-4AIH3WFI.js";import"./chunk-JOGV3DWE.js";import{l as B,n as Z,p as tt,w as N}from"./chunk-HM5RIVQC.js";import"./chunk-2FO7ARYZ.js";import"./chunk-DJW5LMRG.js";import"./chunk-QXXXCEV5.js";import"./chunk-7C6Z24SS.js";import"./chunk-5WKDXHVH.js";import"./chunk-JEGXFID4.js";import"./chunk-SU5S5XU7.js";import"./chunk-B5LBE5HD.js";import"./chunk-F6A6XWW4.js";import"./chunk-AESEF3B2.js";import"./chunk-74LTYPBC.js";import"./chunk-3BDL2KTL.js";import"./chunk-TGPGCQ44.js";import"./chunk-PWU2QHPV.js";import"./chunk-WUJRCGDY.js";import"./chunk-QPGCDGIN.js";import"./chunk-JH4RD366.js";import"./chunk-7Y6S2GNA.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-PTZYZULI.js";import"./chunk-KZKWOEFD.js";import"./chunk-LNVVFNTC.js";import"./chunk-QJADLTFR.js";import"./chunk-YQPWWSMJ.js";import"./chunk-JEIB6WNP.js";import"./chunk-6JJCXUHW.js";import"./chunk-CVRJ6GOM.js";import"./chunk-X7QUUHRV.js";import"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-3HCMTURP.js";import"./chunk-VT67LWCR.js";import"./chunk-K27GONOJ.js";import"./chunk-6KRFVLII.js";import"./chunk-JR22Z7I2.js";import"./chunk-3QNSJ5HY.js";import"./chunk-UNVICPIE.js";import"./chunk-BGICKEJR.js";import"./chunk-TRZXSDYA.js";import"./chunk-OGS2SUK5.js";import"./chunk-TVHRLNTK.js";import"./chunk-JA3EMS2I.js";import"./chunk-HKHTIKVW.js";import"./chunk-XFESK2YB.js";import"./chunk-IJBTA53P.js";import"./chunk-ZHUXSQTN.js";import"./chunk-YLZWDFCJ.js";import"./chunk-TLMADEUL.js";import"./chunk-WNSGKHQ6.js";import"./chunk-J5MXC6AL.js";import"./chunk-OLOKUDVI.js";import"./chunk-RJWOVI3M.js";import{b as X}from"./chunk-R6GE4XRP.js";import"./chunk-MDL4XPLR.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import{g as $,h as D}from"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import"./chunk-NHSDW26F.js";import"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import"./chunk-WAGBL553.js";import"./chunk-WKJJQIBC.js";import"./chunk-VDADRLEF.js";import"./chunk-CNQVGGE6.js";import"./chunk-JGD7UKVF.js";import"./chunk-X5AA4JDN.js";import"./chunk-J372WZPB.js";import"./chunk-6XFS4U2F.js";import"./chunk-XPRVY6JT.js";import"./chunk-7N3ZKWML.js";import"./chunk-E62WHYYG.js";import"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import"./chunk-3SDSCSDJ.js";import{j as M}from"./chunk-I4M2OT5W.js";import{n as G}from"./chunk-NTVLK3P2.js";import{a as q}from"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-6PN3I333.js";import"./chunk-5TW726OD.js";import"./chunk-VGD3XLDH.js";import{a as Q}from"./chunk-LB5YQINJ.js";import{b as J}from"./chunk-EKMHQEJY.js";import"./chunk-VACZNAP3.js";import"./chunk-JKNCWG7E.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7IPIJKWU.js";import"./chunk-7R33MKVL.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import{F as Y,c as H}from"./chunk-E57FTRWF.js";import{i as E,j as W}from"./chunk-U4J5SECU.js";import{f as K}from"./chunk-7EG726PT.js";import{d as c}from"./chunk-C7INQGWT.js";import{H as T}from"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{i as I,l as F}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import{a as h}from"./chunk-QGVBCWUY.js";import"./chunk-HHDFN2GK.js";import"./chunk-47GHT6OF.js";import{a as P,f as g}from"./chunk-VTHXE323.js";var u=class extends K{constructor(){super(...arguments),this.id=0,this.rotation=0,this.href="",this.extent=new M}};h([c({nonNullable:!0,json:{write:!0}})],u.prototype,"id",void 0),h([c({nonNullable:!0,json:{write:!0}})],u.prototype,"rotation",void 0),h([c({nonNullable:!0,json:{write:!0}})],u.prototype,"href",void 0),h([c({type:M,nonNullable:!0,json:{write:!0}})],u.prototype,"extent",void 0),u=h([T("esri.layers.support.KMLMapImage")],u);var ft=(()=>{class t{constructor(e){if(this._ownsRctx=!1,e)this._ownsRctx=!1,this._rctx=e;else{if(t._instance)return t._instanceRefCount++,t._instance;t._instanceRefCount=1,t._instance=this,this._ownsRctx=!0;let a=document.createElement("canvas").getContext("webgl2");a.getExtension("OES_texture_float"),this._rctx=new pt(a,{})}let o={applyProjection:!0,bilinear:!1,bicubic:!1},s=nt("raster/reproject","raster/reproject",new Map([["a_position",0]]),o);this._program=this._rctx.programCache.acquire(s.shaders.vertexShader,s.shaders.fragmentShader,s.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new lt(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(e,o,s=!1){let a=D(e.extent,o),n=new G({x:(e.extent.xmax-e.extent.xmin)/e.texture.descriptor.width,y:(e.extent.ymax-e.extent.ymin)/e.texture.descriptor.height,spatialReference:e.extent.spatialReference}),{x:p,y:l}=it(n,o,e.extent),r=(p+l)/2,f=Math.round((a.xmax-a.xmin)/r),w=Math.round((a.ymax-a.ymin)/r);r=(a.width/f+a.height/w)/2;let U=new G({x:r,y:r,spatialReference:a.spatialReference}),y=at({projectedExtent:a,srcBufferExtent:e.extent,pixelSize:U,hasWrapAround:!0,spacing:[16,16]}),b=_t(this._rctx,y),V=new O(f,w);V.wrapMode=B.CLAMP_TO_EDGE;let m=new ot(this._rctx,V);this._rctx.bindFramebuffer(m),this._rctx.setViewport(0,0,f,w),this._rctx.useProgram(this._program),this._rctx.bindTexture(e.texture,0),this._rctx.bindTexture(b,1),this._quad.bind();let{width:v=0,height:C=0}=e.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",v,C),this._program.setUniform2fv("u_transformSpacing",y.spacing),this._program.setUniform2fv("u_transformGridSize",y.size),this._program.setUniform2f("u_targetImageSize",f,w),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),b.dispose(),s){let{width:S,height:x}=m,z=new ImageData(S??0,x??0);m.readPixels(0,0,S??0,x??0,Z.RGBA,tt.UNSIGNED_BYTE,z.data);let wt=m.detachColorTexture(N.COLOR_ATTACHMENT0);return m.dispose(),{texture:wt,extent:a,imageData:z}}let d=m.detachColorTexture(N.COLOR_ATTACHMENT0);return m.dispose(),{texture:d,extent:a}}reprojectBitmapData(e,o){let s=ht(e.bitmapData)?mt(e.bitmapData):e.bitmapData,a=new O;a.wrapMode=B.CLAMP_TO_EDGE,a.width=e.bitmapData.width,a.height=e.bitmapData.height;let n=new et(this._rctx,a,s),p=this.reprojectTexture({texture:n,extent:e.extent},o,!0);p.texture.dispose();let l=document.createElement("canvas"),r=p.imageData;return l.width=r.width,l.height=r.height,l.getContext("2d").putImageData(r,0,0),{bitmapData:l,extent:p.extent}}loadAndReprojectBitmapData(e,o,s){return g(this,null,function*(){let a=(yield Y(e,{responseType:"image"})).data,n=document.createElement("canvas");n.width=a.width,n.height=a.height;let p=n.getContext("2d");p.drawImage(a,0,0);let l=p.getImageData(0,0,n.width,n.height);if(o.spatialReference.equals(s))return{bitmapData:l,extent:o};let r=this.reprojectBitmapData({bitmapData:l,extent:o},s);return{bitmapData:r.bitmapData,extent:r.extent}})}destroy(){this._ownsRctx?(t._instanceRefCount--,t._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),t._instance=null)):(this._quad.dispose(),this._program.dispose())}}return t._instanceRefCount=0,t})();var L=class{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}},_=class extends dt(ut){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new gt,this._kmlVisualData=new L,this._fetchController=null,this.allVisiblePoints=new k,this.allVisiblePolylines=new k,this.allVisiblePolygons=new k,this.allVisibleMapImages=new J}hitTest(t,i){return g(this,null,function*(){let e=this.layer;return[this._pointsView?.hitTest(t),this._polylinesView?.hitTest(t),this._polygonsView?.hitTest(t)].flat().filter(Boolean).map(o=>(o.layer=e,o.sourceLayer=e,{type:"graphic",graphic:o,layer:e,mapPoint:t}))})}update(t){this._polygonsView&&this._polygonsView.processUpdate(t),this._polylinesView&&this._polylinesView.processUpdate(t),this._pointsView&&this._pointsView.processUpdate(t)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new j({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new A(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new j({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new A(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new j({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new A(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",t=>{t.added.forEach(i=>this._addMapImage(i)),t.removed.forEach(i=>this._removeMapImage(i))}),Q(()=>this.layer.visibleSublayers,t=>{for(let i of this._kmlVisualData.allSublayers.values())i.visibility=0;for(let i of t){let e=this._kmlVisualData.allSublayers.get(i.id);e&&(e.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new ft}detach(){this._fetchController=F(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=I(this._polygonsView),this._polylinesView=I(this._polylinesView),this._pointsView=I(this._pointsView),this._imageReprojector=I(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(t){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(t.href,t.extent,this.view.spatialReference).then(i=>{let e=new ct(i.bitmapData);e.x=i.extent.xmin,e.y=i.extent.ymax,e.resolution=i.extent.width/i.bitmapData.width,e.rotation=t.rotation,this._mapImageContainer.addChild(e),this._bitmapIndex.set(t,e)})}_getViewDependentUrl(t,i){return g(this,null,function*(){let{viewFormat:e,viewBoundScale:o,httpQuery:s}=t;if(e!=null){if(i==null)throw new Error("Loading this network link requires a view state.");let a;if(yield $(),o!=null&&o!==1){let d=new M(i.extent);d.expand(o),a=d}else a=i.extent;a=D(a,q.WGS84);let n=D(a,q.WebMercator),p=a.xmin,l=a.xmax,r=a.ymin,f=a.ymax,w=i.size[0]*i.pixelRatio,U=i.size[1]*i.pixelRatio,y=Math.max(n.width,n.height),b={"[bboxWest]":p.toString(),"[bboxEast]":l.toString(),"[bboxSouth]":r.toString(),"[bboxNorth]":f.toString(),"[lookatLon]":a.center.x.toString(),"[lookatLat]":a.center.y.toString(),"[lookatRange]":y.toString(),"[lookatTilt]":"0","[lookatHeading]":i.rotation.toString(),"[lookatTerrainLon]":a.center.x.toString(),"[lookatTerrainLat]":a.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":a.center.x.toString(),"[cameraLat]":a.center.y.toString(),"[cameraAlt]":y.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":w.toString(),"[vertPixels]":U.toString(),"[terrainEnabled]":"0","[clientVersion]":H,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},V=d=>{for(let S in d){let x;for(x in b)d[S]=d[S].replace(x,b[x])}},m=E(e);V(m);let v={};s!=null&&(v=E(s),V(v));let C=X(t.href);return C.query=P(P(P({},C.query),m),v),`${C.path}?${W(m)}`}return t.href})}_fetchService(t){return g(this,null,function*(){let i=new L;yield this._loadVisualData(this.layer.url,i,t),this._kmlVisualData=i,this._refreshCollections()})}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t))}_isSublayerVisible(t){let i=this._kmlVisualData.allSublayers.get(t);return!!i?.visibility&&(i.parentFolderId===-1||this._isSublayerVisible(i.parentFolderId))}_loadVisualData(t,i,e){return this._fetchParsedKML(t,e).then(o=>g(this,null,function*(){for(let s of o.sublayers){i.allSublayers.set(s.id,s);let a=s.points?yield R(s.points):[],n=s.polylines?yield R(s.polylines):[],p=s.polygons?yield R(s.polygons):[],l=s.mapImages?.map(r=>u.fromJSON(r))??[];if(i.allPoints.push(...a.map(r=>({item:r,sublayerId:s.id}))),i.allPolylines.push(...n.map(r=>({item:r,sublayerId:s.id}))),i.allPolygons.push(...p.map(r=>({item:r,sublayerId:s.id}))),i.allMapImages.push(...l.map(r=>({item:r,sublayerId:s.id}))),s.networkLink){let r=yield this._getViewDependentUrl(s.networkLink,this.view.state);yield this._loadVisualData(r,i,e)}}}))}_fetchParsedKML(t,i){return rt(t,this.layer.spatialReference,this.layer.refreshInterval,i).then(e=>st(e.data))}_removeMapImage(t){let i=this._bitmapIndex.get(t);i&&(this._mapImageContainer.removeChild(i),this._bitmapIndex.delete(t))}};h([c()],_.prototype,"_pointsView",void 0),h([c()],_.prototype,"_polylinesView",void 0),h([c()],_.prototype,"_polygonsView",void 0),h([c()],_.prototype,"updating",void 0),_=h([T("esri.views.2d.layers.KMLLayerView2D")],_);var ge=_;export{ge as default};
