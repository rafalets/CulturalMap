import{b as J,c as R}from"./chunk-I3S5R6UI.js";import{a as g,b as P,c as C,d as G,e as A,f as E,g as _,h as D,i as K}from"./chunk-ZZICVYEU.js";import{a as d}from"./chunk-FQTXYWH5.js";import"./chunk-KLXERNY4.js";import"./chunk-JVGM2LBA.js";import{o as F}from"./chunk-MDL4XPLR.js";import{b as U}from"./chunk-LDPKBMTU.js";import{d as M,e as p,f as L,g as f}from"./chunk-ILKINAL7.js";import"./chunk-HVKMTRIC.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import"./chunk-NHSDW26F.js";import"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import"./chunk-XPRVY6JT.js";import"./chunk-7N3ZKWML.js";import"./chunk-E62WHYYG.js";import"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import"./chunk-3SDSCSDJ.js";import"./chunk-I4M2OT5W.js";import"./chunk-NTVLK3P2.js";import"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7R33MKVL.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import{s as m}from"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import"./chunk-C7INQGWT.js";import"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import"./chunk-QGVBCWUY.js";import{t as y}from"./chunk-HHDFN2GK.js";import{i as x,j as N,t as $}from"./chunk-47GHT6OF.js";import{f as i}from"./chunk-VTHXE323.js";var T="Feature Service",S="feature-layer-utils",te=`${S}-save`,re=`${S}-save-as`,h=`${S}-saveall`,w=`${S}-saveall-as`;function I(e){return{isValid:F(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function v(e,a){let t=U(e,"portal-item");return a?.isTable&&(t.layerContainerType="tables"),t}function z(e){let a=v(e),t=v(e);return t.layerContainerType="tables",{forLayers:a,forTables:t}}function j(e){let a=[],t=[];for(let{layer:r,layerJSON:n}of e)r.isTable?t.push(n):a.push(n);return{layers:a,tables:t}}function q(e){return j([e])}function V(e,a){return i(this,null,function*(){return/\/\d+\/?$/.test(e.url)?q(a[0]):H(a,e)})}function H(e,a){return i(this,null,function*(){if(e.reverse(),!a)return j(e);let t=yield se(a,e);for(let r of e)Q(r.layer,r.layerJSON,t);return le(t,e),t})}function se(e,a){return i(this,null,function*(){let t=yield e.fetchData("json");if(oe(t))return t;t||={},ne(t);let{layer:{url:r,customParameters:n,apiKey:s}}=a[0];return yield ie(t,{url:r??"",customParameters:n,apiKey:s},a.map(o=>o.layer.layerId)),t})}function oe(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function ne(e){e.layers||=[],e.tables||=[]}function le(e,a){let t=[],r=[];for(let{layer:n}of a){let{isTable:s,layerId:o}=n;s?r.push(o):t.push(o)}Y(e.layers,t),Y(e.tables,r)}function Y(e,a){if(e.length<2)return;let t=[];for(let{id:r}of e)t.push(r);x(t.sort(k),a.slice().sort(k))&&e.sort((r,n)=>{let s=a.indexOf(r.id),o=a.indexOf(n.id);return s<o?-1:s>o?1:0})}function k(e,a){return e<a?-1:e>a?1:0}function ie(e,a,t){return i(this,null,function*(){let{url:r,customParameters:n,apiKey:s}=a,{serviceJSON:o,layersJSON:l}=yield J(r,{customParameters:n,apiKey:s}),c=B(e.layers,o.layers,t),u=B(e.tables,o.tables,t);e.layers=c.itemResources,e.tables=u.itemResources;let b=[...c.added,...u.added],ae=l?[...l.layers,...l.tables]:[];yield ce(e,b,r,ae)})}function B(e,a,t){let r=N(e,a,(s,o)=>s.id===o.id);e=e.filter(s=>!r.removed.some(o=>o.id===s.id));let n=r.added;return n.forEach(({id:s})=>{e.push({id:s})}),{itemResources:e,added:n.filter(({id:s})=>!t.includes(s))}}function ce(e,a,t,r){return i(this,null,function*(){let n=yield ue(a),s=a.map(({id:o,type:l})=>new(n.get(l))({url:t,layerId:o,sourceJSON:r.find(({id:c})=>c===o)}));yield Promise.allSettled(s.map(o=>o.load())),s.forEach(o=>{let{layerId:l,loaded:c,defaultPopupTemplate:u}=o;if(!c||u==null)return;let b={id:l,popupInfo:u.toJSON()};o.operationalLayerType!=="ArcGISFeatureLayer"&&(b.layerType=o.operationalLayerType),Q(o,b,e)})})}function ue(e){return i(this,null,function*(){let a=[];e.forEach(({type:n})=>{switch(R(n)){case"CatalogLayer":a.push(import("./chunk-UC6SUDCX.js").then(s=>s.default));break;case"FeatureLayer":a.push(import("./chunk-7UWKG2HI.js").then(s=>s.default));break;case"OrientedImageryLayer":a.push(import("./chunk-KPXQOMKJ.js").then(s=>s.default))}});let t=yield Promise.all(a),r=new Map;return e.forEach(({type:n},s)=>{r.set(n,t[s])}),r})}function Q(e,a,t){e.isTable?W(t.tables,a):W(t.layers,a)}function W(e,a){let t=e.findIndex(({id:r})=>r===a.id);t===-1?e.push(a):e[t]=a}function X(e,a){if(!e.length)throw new y(`${a}:missing-parameters`,"'layers' array should contain at least one feature layer")}function ye(e,a){let t=e.map(r=>r.portalItem.id);if(new Set(t).size>1)throw new y(`${a}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function Z(e,a){let t=e.map(r=>r.layerId);if(new Set(t).size!==t.length)throw new y(`${a}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}function fe(e){return i(this,null,function*(){X(e,h),yield Promise.all(e.map(a=>a.load()));for(let a of e)g(a,h,I),C({layer:a,itemType:T,errorNamePrefix:h});ye(e,h),Z(e,h)})}function O(e,a){let t=0,r=0,n=0;for(let{layerType:s}of[...a.layers,...a.tables])switch(s){case"OrientedImageryLayer":t++;break;case"SubtypeGroupLayer":r++;break;case"SubtypeGroupTable":n++}p(e,f.ORIENTED_IMAGERY_LAYER,t>0),p(e,f.SUBTYPE_GROUP_LAYER,r>0),p(e,f.SUBTYPE_GROUP_TABLE,n>0)}function ee(e,a,t){M(a,f.METADATA),p(a,f.MULTI_LAYER,e.length>1),p(a,f.SINGLE_LAYER,e.length===1),p(a,f.TABLE,t.tables.length>0&&t.layers.length===0),O(a,t)}function pe(e,a,t){return i(this,null,function*(){O(a,t)})}function me(e,a,t){return i(this,null,function*(){let{url:r,layerId:n,title:s,fullExtent:o,isTable:l}=e,c=m(r);a.url=(c?.serverType==="FeatureServer"?r:`${r}/${n}`)??null,a.title||=s,a.extent=null,l||o==null||(a.extent=yield L(o)),ee([e],a,t)})}function de(e,a){for(let s of e){let o=s.parsedUrl.path,l=m(o);if(!l?.url.path)throw new y(`${a}:invalid-parameters`,P(s,`has unsupported url pattern: ${o}`),{layer:s});let u=l?.serverType;if(u!=="FeatureServer"&&u!=="MapServer")throw new y(`${a}:invalid-parameters`,P(s,`has unsupported server type: ${u}`),{layer:s});if(u==="MapServer"&&e.length>1)throw new y(`${a}:invalid-parameters`,"Only one layer or table in a map service can be saved")}let t=m(e[0].parsedUrl.path),r=t?.url.path;if(!e.every(s=>m(s.parsedUrl.path)?.url.path===r))throw new y(`${a}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}function he(e){return i(this,null,function*(){X(e,w),yield Promise.all(e.map(a=>a.load()));for(let a of e)g(a,w,I);de(e,w),Z(e,w)})}function we(e,a){O(e,a),E(e)}function be(e,a,t){return i(this,null,function*(){let r=0;for(let{isTable:o}of e)o||r++;let n=e[0].parsedUrl.path,s=m(n);if(a.url=s?.serverType==="FeatureServer"?s.url.path:n,a.title||=s.title,a.extent=null,r>0){let o=e.map(l=>l.fullExtent).filter($).reduce((l,c)=>l.clone().union(c));o&&(a.extent=yield L(o))}ee(e,a,t),E(a)})}function xe(e,a){return i(this,null,function*(){return D({layer:e,itemType:T,validateLayer:I,createJSONContext:t=>v(t,e),createItemData:(t,r)=>V(r,[t]),errorNamePrefix:te,setItemProperties:pe},a)})}function Ne(e,a){return i(this,null,function*(){yield fe(e);let t=e[0].portalItem,r=z(t),n=yield Promise.all(e.map(o=>A(o,o.isTable?r.forTables:r.forLayers,a))),s=yield V(t,e.map((o,l)=>({layer:o,layerJSON:n[l]})));return we(t,s),yield t.update({data:s}),yield Promise.all(e.slice(1).map(o=>o.portalItem.reload())),d(r.forLayers),d(r.forTables),t.clone()})}function $e(e,a,t){return i(this,null,function*(){return K({layer:e,itemType:T,validateLayer:I,createJSONContext:r=>v(r,e),createItemData:(r,n)=>Promise.resolve(q(r)),errorNamePrefix:re,newItem:a,setItemProperties:me},t)})}function Fe(e,a,t){return i(this,null,function*(){yield he(e);let r=G({itemType:T,errorNamePrefix:w,newItem:a}),n=z(r),s=yield Promise.all(e.map(l=>A(l,l.isTable?n.forTables:n.forLayers,t))),o=yield H(e.map((l,c)=>({layer:l,layerJSON:s[c]})));yield be(e,r,o),yield _(r,o,t);for(let l of e)l.portalItem=r.clone();return d(n.forLayers),d(n.forTables),r})}export{xe as save,Ne as saveAll,Fe as saveAllAs,$e as saveAs};
