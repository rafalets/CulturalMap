import{a as ot,b as E}from"./chunk-L5JJXC3A.js";import{a as Z}from"./chunk-J2SAHMG5.js";import{a as C}from"./chunk-PSNQ2KG3.js";import{a as tt}from"./chunk-AYSSTKZP.js";import{a as et,b as rt}from"./chunk-3D4Y6BLC.js";import{a as O}from"./chunk-OTUHXNWB.js";import{a as L}from"./chunk-3AS27HNO.js";import{a as Y}from"./chunk-QXNVQZT7.js";import{h as f}from"./chunk-ONYJLWAD.js";import{h as at,i as st,k as _}from"./chunk-BUZBVNOM.js";import{k as d,l as P,n as c,z as m}from"./chunk-HM5RIVQC.js";import{a as J}from"./chunk-VACZNAP3.js";import{a as Q}from"./chunk-VDKRSX77.js";import{D as $}from"./chunk-E57FTRWF.js";import{A as j,z as b}from"./chunk-U4J5SECU.js";import{j as z,k,t as W,u as H,z as q}from"./chunk-D2LVMNOU.js";import{a as T}from"./chunk-QGVBCWUY.js";import{r as K,t as F}from"./chunk-HHDFN2GK.js";import{v as D,x}from"./chunk-47GHT6OF.js";import{a as U,f as u}from"./chunk-VTHXE323.js";function nt(){return it??=u(this,null,function*(){let r=yield import("./chunk-OWNS6KMM.js"),t=yield r.default({locateFile:e=>Q(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t}),it}var it;var h=null,B=null;function lt(){return u(this,null,function*(){return B==null&&(B=nt(),h=yield B),B})}function mt(r,t){if(h==null)return r.byteLength;let e=new h.BasisFile(new Uint8Array(r)),a=dt(e)?ut(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),a}function ht(r,t){if(h==null)return r.byteLength;let e=new h.KTX2File(new Uint8Array(r)),a=pt(e)?ut(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),a}function ut(r,t,e,a,s){let o=at(t?m.COMPRESSED_RGBA8_ETC2_EAC:m.COMPRESSED_RGB8_ETC2),i=s&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(e*a*o*i)}function dt(r){return r.getNumImages()>=1&&!r.isUASTC()}function pt(r){return r.getFaces()>=1&&r.isETC1S()}function ct(r,t,e){return u(this,null,function*(){h==null&&(h=yield lt());let a=new h.BasisFile(new Uint8Array(e));if(!dt(a))return null;a.startTranscoding();let s=gt(r,t,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(o,i)=>a.getImageTranscodedSizeInBytes(0,o,i),(o,i,n)=>a.transcodeImage(n,0,o,i,0,0));return a.close(),a.delete(),s})}function _t(r,t,e){return u(this,null,function*(){h==null&&(h=yield lt());let a=new h.KTX2File(new Uint8Array(e));if(!pt(a))return null;a.startTranscoding();let s=gt(r,t,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(o,i)=>a.getImageTranscodedSizeInBytes(o,0,0,i),(o,i,n)=>a.transcodeImage(n,o,0,0,i,0,-1,-1));return a.close(),a.delete(),s})}function gt(r,t,e,a,s,o,i,n){let{compressedTextureETC:l,compressedTextureS3TC:y}=r.capabilities,[A,S]=l?a?[C.ETC2_RGBA,m.COMPRESSED_RGBA8_ETC2_EAC]:[C.ETC1_RGB,m.COMPRESSED_RGB8_ETC2]:y?a?[C.BC3_RGBA,m.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[C.BC1_RGB,m.COMPRESSED_RGB_S3TC_DXT1_EXT]:[C.RGBA32,c.RGBA],w=t.hasMipmap?e:Math.min(1,e),g=[];for(let p=0;p<w;p++)g.push(new Uint8Array(i(p,A))),n(p,A,g[p]);return t.internalFormat=S,t.hasMipmap=g.length>1,t.samplingMode=t.hasMipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,t.width=s,t.height=o,new _(r,t,{type:"compressed",levels:g})}var N=()=>K.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Ct=542327876,Mt=131072,yt=4;function G(r){return r.charCodeAt(0)+(r.charCodeAt(1)<<8)+(r.charCodeAt(2)<<16)+(r.charCodeAt(3)<<24)}function wt(r){return String.fromCharCode(255&r,r>>8&255,r>>16&255,r>>24&255)}var It=G("DXT1"),Rt=G("DXT3"),St=G("DXT5"),Ft=31,Pt=0,Bt=1,Nt=2,vt=3,Ut=4,Ht=7,bt=20,Lt=21;function Tt(r,t,e){let a=Ot(e,t.hasMipmap??!1);if(a==null)throw new Error("DDS texture data is null");let{textureData:s,internalFormat:o,width:i,height:n}=a;return t.samplingMode=s.levels.length>1?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=o,t.width=i,t.height=n,new _(r,t,s)}function Ot(r,t){let e=new Int32Array(r.buffer,r.byteOffset,Ft);if(e[Pt]!==Ct)return N().error("Invalid magic number in DDS header"),null;if(!(e[bt]&yt))return N().error("Unsupported format, must contain a FourCC code"),null;let a=e[Lt],s,o;switch(a){case It:s=8,o=m.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Rt:s=16,o=m.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case St:s=16,o=m.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return N().error("Unsupported FourCC code:",wt(a)),null}let i=1,n=e[Ut],l=e[vt];(3&n||3&l)&&(N().warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,l=l+3&-4);let y=n,A=l,S,w;e[Nt]&Mt&&t!==!1&&(i=Math.max(1,e[Ht]));let g=r.byteOffset+e[Bt]+4,p=[];for(let X=0;X<i;++X)w=(n+3>>2)*(l+3>>2)*s,S=new Uint8Array(r.buffer,g,w),p.push(S),g+=w,n=Math.max(1,n>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:p},internalFormat:o,width:y,height:A}}var v=16;function ae(r){return Math.ceil(r/v)*v}function se(r){return Math.floor(r/v)*v}function ft(r,t){let o=r.width*r.height;if(o<4096)return r instanceof ImageData?At(r):r;let i=r.width,n=r.height;do i=Math.ceil(i/2),n=Math.ceil(n/2),o=i*n;while(o>1048576||t!=null&&(i>t||n>t));return V(r,i,n)}function Et(r,t){let e=Math.max(r.width,r.height);if(e<=t)return r;let a=t/e;return V(r,Math.round(r.width*a),Math.round(r.height*a))}function V(r,t,e){if(r instanceof ImageData)return V(At(r),t,e);let a=document.createElement("canvas");return a.width=t,a.height=e,a.getContext("2d").drawImage(r,0,0,a.width,a.height),a}function At(r){let t=document.createElement("canvas");t.width=r.width,t.height=r.height;let e=t.getContext("2d");if(e==null)throw new F("Failed to create 2d context from HTMLCanvasElement");return e.putImageData(r,0,0),t}var Dt=class extends et{constructor(t,e){super(),this._data=t,this.type=rt.Texture,this.events=new J,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this._parameters=U(U({},Vt),e),this._startPreload(t)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(t){t!=null&&(t instanceof HTMLVideoElement?(this.frameUpdate=e=>this._frameUpdate(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(b(t.src)||t.preload==="auto"&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";let e=!t.paused;if(t.src=t.src,e&&t.autoplay){let a=()=>{t.removeEventListener("canplay",a),t.play()};t.addEventListener("canplay",a)}}}_startPreloadImageElement(t){j(t.src)||b(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){let e=new st;return e.wrapMode=this._parameters.wrap??P.REPEAT,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||Gt(this._data,this._parameters)}load(t){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let e=this._data;return e==null?(this._glTexture=new _(t,this._createDescriptor(t),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):x(e)&&this._parameters.encoding===f.DDS_ENCODING?this._loadFromDDSData(t,e):D(e)&&this._parameters.encoding===f.DDS_ENCODING?this._loadFromDDSData(t,new Uint8Array(e)):(D(e)||x(e))&&this._parameters.encoding===f.KTX2_ENCODING?this._loadFromKTX2(t,e):(D(e)||x(e))&&this._parameters.encoding===f.BASIS_ENCODING?this._loadFromBasis(t,e):x(e)?this._loadFromPixelData(t,e):D(e)?this._loadFromPixelData(t,new Uint8Array(e)):null)}_frameUpdate(t,e){return this._glTexture==null||t.readyState<I.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=Tt(t,this._createDescriptor(t),e),this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>_t(t,this._createDescriptor(t),e).then(a=>(this._glTexture=a,a)))}_loadFromBasis(t,e){return this._loadAsync(()=>ct(t,this._createDescriptor(t),e).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(t,e){tt(this._parameters.width>0&&this._parameters.height>0);let a=this._createDescriptor(t);return a.pixelFormat=this._parameters.components===1?c.LUMINANCE:this._parameters.components===3?c.RGB:c.RGBA,a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new _(t,a,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(a=>u(this,null,function*(){let s=yield Z(e,{signal:a});return H(a),this._loadFromImage(t,s)}))}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(a=>u(this,null,function*(){let s=yield $(e,e.src,!1,a);return H(a),this._loadFromImage(t,s)}))}_loadFromVideoElement(t,e){return e.readyState>=I.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(a=>new Promise((s,o)=>{let i=()=>{e.removeEventListener("loadeddata",n),e.removeEventListener("error",l),k(y)},n=()=>{e.readyState>=I.HAVE_CURRENT_DATA&&(i(),s(this._loadFromImage(t,e)))},l=A=>{i(),o(A||new F("Failed to load video"))};e.addEventListener("loadeddata",n),e.addEventListener("error",l);let y=q(a,()=>l(W()))}))}_loadFromImage(t,e){let a=e;if(!(a instanceof HTMLVideoElement)){let{maxTextureSize:i}=t.parameters;a=this._parameters.downsampleUncompressed?ft(a,i):Et(a,i)}let s=xt(a);this._parameters.width=s.width,this._parameters.height=s.height;let o=this._createDescriptor(t);return o.pixelFormat=this._parameters.components===3?c.RGB:c.RGBA,o.width=s.width,o.height=s.height,o.shouldCompress=this._parameters.shouldCompress,this._glTexture=new _(t,o,a),this._glTexture}_loadAsync(t){let e=new AbortController;this._loadingController=e;let a=t(e.signal);this._loadingPromise=a;let s=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null)};return a.then(s,s),a}unload(){if(this._glTexture=z(this._glTexture),this._loadingController!=null){let t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function Gt(r,t){if(r==null)return 0;if(D(r)||x(r))return t.encoding===f.KTX2_ENCODING?ht(r,!!t.mipmap):t.encoding===f.BASIS_ENCODING?mt(r,!!t.mipmap):r.byteLength;let{width:e,height:a}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?xt(r):t;return(t.mipmap?4/3:1)*e*a*(t.components||4)||0}function xt(r){return r instanceof HTMLVideoElement?{width:r.videoWidth,height:r.videoHeight}:r}var I;(function(r){r[r.HAVE_NOTHING=0]="HAVE_NOTHING",r[r.HAVE_METADATA=1]="HAVE_METADATA",r[r.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",r[r.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",r[r.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(I||(I={}));var Vt={wrap:{s:P.REPEAT,t:P.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1,shouldCompress:!1};var M=class extends ot{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}};T([E()],M.prototype,"instancedDoublePrecision",void 0),T([E()],M.prototype,"hasModelTransformation",void 0);var R=class extends M{constructor(){super(...arguments),this.output=L.Color,this.oitPass=O.NONE,this.hasSlicePlane=!1,this.bindType=Y.Pass,this.writeDepth=!0}};T([E({count:L.COUNT})],R.prototype,"output",void 0),T([E({count:O.COUNT})],R.prototype,"oitPass",void 0),T([E()],R.prototype,"hasSlicePlane",void 0);export{ae as a,se as b,Dt as c,R as d};
