import{a as L}from"./chunk-VACZNAP3.js";import{c as H}from"./chunk-SLAWDKDA.js";import{F as _}from"./chunk-E57FTRWF.js";import{d as S}from"./chunk-C7INQGWT.js";import{H as U}from"./chunk-WMHJC7XF.js";import{N as A}from"./chunk-D2LVMNOU.js";import{a as I}from"./chunk-QGVBCWUY.js";import{b as u}from"./chunk-HHDFN2GK.js";import{f as y}from"./chunk-VTHXE323.js";var C=H(),M=new Map,k=new Map,G=new Map;function P(e,i,n){return y(this,null,function*(){if(!e||!n)return!1;if(!i)return!0;let s=new URL(e).host,r=M.get(s);if(!r){let t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");r=(yield _(t,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return r===i})}function z(e,i,n=!1){return y(this,null,function*(){if(!e||!i)return!0;let s=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=k.get(s)?.entries();if(r){for(let[t,a]of r)if(a.name===i){let d=!a.stack?.hasForwardEdits();if(!d&&n){let[{deleteForwardEdits:m},{default:h}]=yield Promise.all([import("./chunk-EFSOCNHH.js"),import("./chunk-WRDVC5YY.js")]),c=yield m(s,t,new h({sessionId:C,moment:a.moment}));return c.success&&a.stack?.clearForwardEdits(),c.success}return d}}return!0})}function R(e,i){if(!e)return!1;let n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=k.get(n)?.entries();if(s){for(let[r,t]of s)if(t.name===i)return t.lockType==="edit"}return!1}var F=new L.EventEmitter;function N(e){return F.on("apply-edits",new WeakRef(e))}function W(e){return F.on("update-moment",new WeakRef(e))}function re(e,i,n=null,s=!1){let r=A();return s=i==null||s,F.emit("apply-edits",{serviceUrl:e,layerId:i,gdbVersion:n,mayReceiveServiceEdits:s,result:r.promise}),r}function ne(e,i,n=null,s){F.emit("update-moment",{serviceUrl:e,layerId:i,gdbVersion:n,moment:s})}var x=Symbol();function oe(e){return e!=null&&typeof e=="object"&&x in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function v(e,i,n){let s=new URL(e).host,r=M.get(s),t=a=>!a||a===r;return t(i)&&t(n)||i===n}var ae=e=>{var i;let n=class extends e{constructor(...s){super(...s),this[i]=!0,this._applyEditsHandler=r=>{let{serviceUrl:t,layerId:a,gdbVersion:d,mayReceiveServiceEdits:m,result:h}=r,c=t===this.url,f=a!=null&&this.layerId!=null&&a===this.layerId,B=p(this),D=p(this)&&v(t,d,this.gdbVersion);if(!c||B&&!D||!f&&!m)return;let T=h.then(o=>{if(this.lastEditsEventDate=new Date,f&&(o.addedFeatures.length||o.updatedFeatures.length||o.deletedFeatures.length||o.addedAttachments.length||o.updatedAttachments.length||o.deletedAttachments.length))return this.emit("edits",u(o)),o;let E=o.editedFeatures?.find(({layerId:b})=>b===this.layerId);if(E){let{adds:b,updates:V,deletes:w}=E.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:V?V.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:u(o.editedFeatures),exceededTransferLimit:!1,historicMoment:u(o.historicMoment)};return this.emit("edits",j),j}let g={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:u(o.editedFeatures),exceededTransferLimit:!1,historicMoment:u(o.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,d,g.historicMoment)&&this.emit("edits",g),g}).then(o=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,d,o.historicMoment)&&(this.historicMoment=o.historicMoment),o));this.emit("apply-edits",{result:T})},this._updateMomentHandler=r=>{let{serviceUrl:t,gdbVersion:a,moment:d}=r,m=t===this.url,h=p(this),c=p(this)&&v(t,a,this.gdbVersion),f=p(this)&&!v(t,this.gdbVersion,null);m&&h&&c&&f&&"historicMoment"in this&&this.historicMoment!==d&&(this.historicMoment=d)},this.when().then(()=>{this.addHandles(N(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(s,r,t){return"historicMoment"in this&&this.historicMoment!==t&&R(s,r)}};return i=x,I([S()],n.prototype,"lastEditsEventDate",void 0),n=I([U("esri.layers.mixins.EditBusLayer")],n),n};export{C as a,M as b,k as c,G as d,P as e,z as f,R as g,N as h,W as i,re as j,ne as k,oe as l,v as m,ae as n};
