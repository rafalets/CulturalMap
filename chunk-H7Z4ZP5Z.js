import{a as C}from"./chunk-PSNQ2KG3.js";import{z as m}from"./chunk-HM5RIVQC.js";import{a as w}from"./chunk-VDKRSX77.js";import"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import"./chunk-C7INQGWT.js";import"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import"./chunk-QGVBCWUY.js";import"./chunk-HHDFN2GK.js";import"./chunk-47GHT6OF.js";import{f as c}from"./chunk-VTHXE323.js";function S(){return D??=c(this,null,function*(){let e=yield import("./chunk-K6E4RFVN.js"),r=yield e.default({locateFile:t=>w(`esri/libs/basisu/${t}`)});return r.initializeBasis(),r}),D}var D;function x(){return _??=c(this,null,function*(){return yield(yield import("./chunk-WIXBM2AL.js")).default({locateFile:r=>w(`esri/libs/dxtEncoder/${r}`)})}),_}var _;var X,R,u=null,E=null,h=class{constructor(r,t){this.internalFormat=r,this.compressedTexture=t}};function re(e){return c(this,null,function*(){let r=M(e.data,e.flipped);if(e.hasS3TC){E||(yield b());let t=new Uint8Array(r.length);E?.encode(new Uint8Array(r),e.width,e.height,t);let n=Q(t,!0),i=[t.buffer];return{result:new h(n?.internalFormat??null,n?.textureData??null),transferList:i}}if(e.hasETC){u||(yield B());let t=yield F(r,e.width,e.height,e.hasMipmap),n=t?yield G(t):null,i=n?.compressedTexture?.levels.map(l=>l.buffer)||[];return{result:new h(n?.internalFormat??null,n?.compressedTexture??null),transferList:i}}return{result:new h(null,null)}})}function B(){return c(this,null,function*(){u||(u=yield X??=S())})}function b(){return c(this,null,function*(){E||(E=yield R??=x())})}function F(e,r,t,n,i=255,l=0,s=!1,o=!1){return c(this,null,function*(){if(!u)return null;let a=new u.BasisEncoder;a.setPerceptual(!o),a.setCheckForAlpha(!0),a.setForceAlpha(!1),a.setRenormalize(o),a.setMipGen(n),a.setMipSRGB(!o),a.setCreateKTX2File(!0),a.setKTX2SRGBTransferFunc(!o),a.setQualityLevel(i),a.setCompressionLevel(l);let T=new Uint8Array(e.byteLength);a.setSliceSourceImage(0,new Uint8Array(e),r,t,s);let p=a.encode(T),f=new Uint8Array(T.buffer,0,p),d=new u.KTX2File(new Uint8Array(f));return d.isValid()?(a.delete(),f):(d.close(),d.delete(),a.delete(),null)})}function G(e){return c(this,null,function*(){if(!u)return new h(null,null);let r=new u.KTX2File(new Uint8Array(e));r.startTranscoding();let[t,n]=r.getHasAlpha()?[C.ETC2_RGBA,m.COMPRESSED_RGBA8_ETC2_EAC]:[C.ETC1_RGB,m.COMPRESSED_RGB8_ETC2],i=r.getLevels(),l=[];for(let s=0;s<i;s++)l.push(new Uint8Array(r.getImageTranscodedSizeInBytes(s,0,0,t))),r.transcodeImage(l[s],s,0,0,t,0,-1,-1);return r.close(),r.delete(),{internalFormat:n,compressedTexture:{type:"compressed",levels:l}}})}function M(e,r=!1){let t=new OffscreenCanvas(e.width,e.height),n=t.getContext("2d");return r&&n.scale(1,-1),n.drawImage(e,0,r?-e.height:0),n.getImageData(0,0,t.width,t.height).data}var U=31,O=1,v=2,I=3,K=4,L=7,P=21,k=131072;function g(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var z=g("DXT1"),$=g("DXT3"),H=g("DXT5");function Q(e,r){let t=new Int32Array(e.buffer,e.byteOffset,U),n,i;switch(t[P]){case z:n=8,i=m.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case $:n=16,i=m.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case H:n=16,i=m.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let l=1,s=t[K],o=t[I];(3&s||3&o)&&(s=s+3&-4,o=o+3&-4);let a=s,T=o,p,f;t[v]&k&&r!==!1&&(l=Math.max(1,t[L]));let d=e.byteOffset+t[O]+4,A=[];for(let y=0;y<l;++y)f=(s+3>>2)*(o+3>>2)*n,p=new Uint8Array(e.buffer,d,f),A.push(p),d+=f,s=Math.max(1,s>>1),o=Math.max(1,o>>1);return{textureData:{type:"compressed",levels:A},internalFormat:i,width:a,height:T}}export{h as TextureCompressionWorkerOutput,re as compress,F as compressRGBADataToKTX2,G as createTextureDataKTX2,B as initializeBasisEncoder,b as initializeDXTEncoder};
