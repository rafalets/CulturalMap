import{a as ze}from"./chunk-NOHUHVCW.js";import{b as U}from"./chunk-4MCLOZGW.js";import{e as J}from"./chunk-P64DWRJ7.js";import{c as X}from"./chunk-4MYROXQR.js";import{a as Ke}from"./chunk-J2SAHMG5.js";import{a as G}from"./chunk-DBZKWPEX.js";import{a as Qe,b as Ze,c as Je,d as Xe}from"./chunk-VOJIMLDZ.js";import{b as I}from"./chunk-TBHSFWI7.js";import{f as xe}from"./chunk-MEGSPQVO.js";import{a as B}from"./chunk-RWCIDBNQ.js";import{c as ve}from"./chunk-5SSISWTF.js";import{b as qe,d as Ge,e as $e}from"./chunk-MSPTOB4U.js";import{b as Z}from"./chunk-CU2BECSO.js";import{a as q,b as We,g as R}from"./chunk-ONYJLWAD.js";import{d as Ie}from"./chunk-TKZJUAKL.js";import{b as De,e as pe}from"./chunk-OI2D6VTT.js";import{b as Ne,d as je,f as me,i as fe}from"./chunk-XIZXEWWA.js";import{c as le,d as ce,o as Ce,p as Le,s as Ue,t as ke}from"./chunk-B57IWIA2.js";import{c as _e,d as He}from"./chunk-37H4LYIE.js";import{a as ae}from"./chunk-JOGV3DWE.js";import{l as de}from"./chunk-HM5RIVQC.js";import{f as Pe}from"./chunk-2FO7ARYZ.js";import{a as Ve,h as ue,q as Fe}from"./chunk-DJW5LMRG.js";import{a as Ee}from"./chunk-ALWV3RJ2.js";import{a as K,b as Q}from"./chunk-7C6Z24SS.js";import{a as Ae,e as Be,g as ne,t as Se,w as Oe,x as ie}from"./chunk-5WKDXHVH.js";import{f as Re}from"./chunk-7B2UKJ5N.js";import{b as Me}from"./chunk-QSMPW36A.js";import{D as H,l as L}from"./chunk-TRZXSDYA.js";import{f as se}from"./chunk-RJWOVI3M.js";import{a as z,e as oe}from"./chunk-NHSDW26F.js";import{r as re}from"./chunk-VOFKUGRY.js";import{c as te}from"./chunk-JKNCWG7E.js";import{F as we}from"./chunk-E57FTRWF.js";import{x as ee}from"./chunk-D2LVMNOU.js";import{r as Te,t as be}from"./chunk-HHDFN2GK.js";import{a as D,b as _,f as F}from"./chunk-VTHXE323.js";function k(r){if(r==null)return null;let e=r.offset!=null?r.offset:_e,s=r.rotation!=null?r.rotation:0,t=r.scale!=null?r.scale:He,c=Q(1,0,0,0,1,0,e[0],e[1],1),i=Q(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),a=Q(t[0],0,0,0,t[1],0,0,0,1),l=K();return ue(l,i,a),ue(l,c,l),l}var he=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},Y=class{constructor(e,s,t){this.name=e,this.lodThreshold=s,this.pivotOffset=t,this.stageResources=new he,this.numberOfVertices=0}};var S=()=>Te.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),ge=class{constructor(e,s,t){this.resource=e,this.textures=s,this.cachedMemory=t}};function Ye(r,e){return F(this,null,function*(){let s=yield or(r,e),t=yield ir(s.textureDefinitions??{},e),c=0;for(let i in t)if(t.hasOwnProperty(i)){let a=t[i];c+=a?.image?a.image.width*a.image.height*4:0}return new ge(s,t,c+ve(s))})}function or(r,e){return F(this,null,function*(){let s=e?.streamDataRequester;if(s)return sr(r,s,e);let t=yield te(we(r,e));if(t.ok===!0)return t.value.data;ee(t.error),er(t.error)})}function sr(r,e,s){return F(this,null,function*(){let t=yield te(e.request(r,"json",s));if(t.ok===!0)return t.value;ee(t.error),er(t.error.details.url)})}function er(r){throw new be("",`Request for object resource failed: ${r}`)}function ar(r){let e=r.params,s=e.topology,t=!0;switch(e.vertexAttributes||(S().warn("Geometry must specify vertex attributes"),t=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let i=e.faces;if(i){if(e.vertexAttributes)for(let a in e.vertexAttributes){let l=i[a];l?.values?(l.valueType!=null&&l.valueType!=="UInt32"&&(S().warn(`Unsupported indexed geometry indices type '${l.valueType}', only UInt32 is currently supported`),t=!1),l.valuesPerElement!=null&&l.valuesPerElement!==1&&(S().warn(`Unsupported indexed geometry values per element '${l.valuesPerElement}', only 1 is currently supported`),t=!1)):(S().warn(`Indexed geometry does not specify face indices for '${a}' attribute`),t=!1)}}else S().warn("Indexed geometries must specify faces"),t=!1;break}default:S().warn(`Unsupported topology '${s}'`),t=!1}r.params.material||(S().warn("Geometry requires material"),t=!1);let c=r.params.vertexAttributes;for(let i in c)c[i].values||(S().warn("Geometries with externally defined attributes are not yet supported"),t=!1);return t}function rr(r,e){let s=new Array,t=new Array,c=new Array,i=new ze,a=r.resource,l=ae.parse(a.version||"1.0","wosr");lr.validate(l);let o=a.model.name,n=a.model.geometries,u=a.materialDefinitions??{},m=r.textures,x=0,h=new Map;for(let p=0;p<n.length;p++){let g=n[p];if(!ar(g))continue;let T=ur(g),w=g.params.vertexAttributes,d=[],y=f=>{if(g.params.topology==="PerAttributeArray")return null;let v=g.params.faces;for(let b in v)if(b===f)return v[b].values;return null},j=w[B.POSITION],W=j.values.length/j.valuesPerElement;for(let f in w){let v=w[f],b=v.values,M=y(f)??Ie(W);d.push([f,new I(b,M,v.valuesPerElement,!0)])}let O=T.texture,A=m&&m[O];if(A&&!h.has(O)){let{image:f,parameters:v}=A,b=new X(f,v);t.push(b),h.set(O,b)}let $=h.get(O),C=$?$.id:void 0,P=T.material,E=i.get(P,O);if(E==null){let f=u[P.slice(P.lastIndexOf("/")+1)].params;f.transparency===1&&(f.transparency=0);let v=A&&A.alphaChannelUsage,b=f.transparency>0||v==="transparency"||v==="maskAndTransparency",M=A?tr(A.alphaChannelUsage):void 0,ye={ambient:oe(f.diffuse),diffuse:oe(f.diffuse),opacity:1-(f.transparency||0),transparent:b,textureAlphaMode:M,textureAlphaCutoff:.33,textureId:C,doubleSided:!0,cullFace:q.None,colorMixMode:f.externalColorMixMode||"tint",textureAlphaPremultiplied:A?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(ye,e.materialParameters),E=new U(ye,e),i.set(P,O,E)}c.push(E);let V=new J(E,d);x+=d.find(f=>f[0]===B.POSITION)?.[1]?.indices.length??0,s.push(V)}return{engineResources:[{name:o,stageResources:{textures:t,materials:c,geometries:s},pivotOffset:a.model.pivotOffset,numberOfVertices:x,lodThreshold:null}],referenceBoundingBox:nr(s)}}function nr(r){let e=H();return r.forEach(s=>{let t=s.boundingInfo;t!=null&&(L(e,t.bbMin),L(e,t.bbMax))}),e}function ir(r,e){return F(this,null,function*(){let s=new Array;for(let i in r){let a=r[i],l=a.images[0].data;if(!l){S().warn("Externally referenced texture data is not yet supported");continue}let o=a.encoding+";base64,"+l,n="/textureDefinitions/"+i,u=a.channels==="rgba"?a.alphaChannelUsage||"transparency":"none",m={noUnpackFlip:!0,wrap:{s:de.REPEAT,t:de.REPEAT},preMultiplyAlpha:tr(u)!==R.Opaque},x=e?.disableTextures?Promise.resolve(null):Ke(o,e);s.push(x.then(h=>({refId:n,image:h,parameters:m,alphaChannelUsage:u})))}let t=yield Promise.all(s),c={};for(let i of t)c[i.refId]=i;return c})}function tr(r){switch(r){case"mask":return R.Mask;case"maskAndTransparency":return R.MaskBlend;case"none":return R.Opaque;default:return R.Blend}}function ur(r){let e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}var lr=new ae(1,2,"wosr");function yt(r,e){return F(this,null,function*(){let s=cr(Me(r));if(s.fileType==="wosr"){let m=yield e.cache?e.cache.loadWOSR(s.url,e):Ye(s.url,e),{engineResources:x,referenceBoundingBox:h}=rr(m,e);return{lods:x,referenceBoundingBox:h,isEsriSymbolResource:!1,isWosr:!0}}let t;if(e.cache)t=yield e.cache.loadGLTF(s.url,e,!!e.usePBR);else{let{loadGLTF:m}=yield import("./chunk-IGKY6THP.js");t=yield m(new Ge(e.streamDataRequester),s.url,e,e.usePBR)}let c=t.model.meta?.ESRI_proxyEllipsoid,i=t.meta.isEsriSymbolResource&&c!=null&&t.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!t.customMeta.esriTreeRendering&&(t.customMeta.esriTreeRendering=!0,xr(t,c));let a=!!e.usePBR,l=t.meta.isEsriSymbolResource?{usePBR:a,isSchematic:!1,treeRendering:i,mrrFactors:Xe}:{usePBR:a,isSchematic:!1,treeRendering:!1,mrrFactors:Ze},o=_(D({},e.materialParameters),{treeRendering:i}),{engineResources:n,referenceBoundingBox:u}=mr(t,l,o,e,s.specifiedLodIndex);return{lods:n,referenceBoundingBox:u,isEsriSymbolResource:t.meta.isEsriSymbolResource,isWosr:!1}})}function cr(r){let e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function mr(r,e,s,t,c){let i=r.model,a=new Array,l=new Map,o=new Map,n=i.lods.length,u=H();return i.lods.forEach((m,x)=>{let h=t.skipHighLods===!0&&(n>1&&x===0||n>3&&x===1)||t.skipHighLods===!1&&c!=null&&x!==c;if(h&&x!==0)return;let p=new Y(m.name,m.lodThreshold,[0,0,0]);m.parts.forEach(g=>{let T=h?new U({},t):fr(i,g,p,e,s,l,o,t),{geometry:w,vertexCount:d}=pr(g,T??new U({},t)),y=w.boundingInfo;y!=null&&x===0&&(L(u,y.bbMin),L(u,y.bbMax)),T!=null&&(p.stageResources.geometries.push(w),p.numberOfVertices+=d)}),h||a.push(p)}),{engineResources:a,referenceBoundingBox:u}}function fr(r,e,s,t,c,i,a,l){let o=r.materials.get(e.material);if(o==null)return null;let{normal:n,color:u,texCoord0:m,tangent:x}=e.attributes,h=e.material+(n?"_normal":"")+(u?"_color":"")+(m?"_texCoord0":"")+(x?"_tangent":""),p=e.attributes.texCoord0!=null,g=e.attributes.normal!=null,T=dr(o.alphaMode);if(!i.has(h)){if(p){let V=(f,v=!1)=>{if(f!=null&&!a.has(f)){let b=r.textures.get(f);if(b){let M=b.data;a.set(f,new X(Z(M)?M.data:M,_(D({},b.parameters),{preMultiplyAlpha:!Z(M)&&v,encoding:Z(M)?M.encoding:void 0})))}}};V(o.colorTexture,T!==R.Opaque),V(o.normalTexture),V(o.occlusionTexture),V(o.emissiveTexture),V(o.metallicRoughnessTexture)}let d=1/se,y=o.color[0]**d,j=o.color[1]**d,W=o.color[2]**d,O=o.emissiveFactor[0]**d,A=o.emissiveFactor[1]**d,$=o.emissiveFactor[2]**d,C=o.colorTexture!=null&&p?a.get(o.colorTexture):null,P=Qe(o),E=o.normalTextureTransform?.scale!=null?o.normalTextureTransform?.scale:Pe;i.set(h,new U(D(_(D({},t),{transparent:T===R.Blend,customDepthTest:We.Lequal,textureAlphaMode:T,textureAlphaCutoff:o.alphaCutoff,diffuse:[y,j,W],ambient:[y,j,W],opacity:o.opacity,doubleSided:o.doubleSided,doubleSidedType:"winding-order",cullFace:o.doubleSided?q.None:q.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:g?xe.Attribute:xe.ScreenDerivative,castShadows:!0,receiveShadows:o.receiveShadows,receiveAmbientOcclusion:o.receiveAmbientOcclustion,textureId:C?.id,colorMixMode:o.colorMixMode,normalTextureId:o.normalTexture!=null&&p?a.get(o.normalTexture).id:void 0,textureAlphaPremultiplied:C!=null&&!!C.parameters.preMultiplyAlpha,occlusionTextureId:o.occlusionTexture!=null&&p?a.get(o.occlusionTexture).id:void 0,emissiveTextureId:o.emissiveTexture!=null&&p?a.get(o.emissiveTexture).id:void 0,metallicRoughnessTextureId:o.metallicRoughnessTexture!=null&&p?a.get(o.metallicRoughnessTexture).id:void 0,emissiveFactor:[O,A,$],mrrFactors:P?Je:[o.metallicFactor,o.roughnessFactor,t.mrrFactors[2]],isSchematic:P,colorTextureTransformMatrix:k(o.colorTextureTransform),normalTextureTransformMatrix:k(o.normalTextureTransform),scale:[E[0],E[1]],occlusionTextureTransformMatrix:k(o.occlusionTextureTransform),emissiveTextureTransformMatrix:k(o.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:k(o.metallicRoughnessTextureTransform)}),c),l))}let w=i.get(h);if(s.stageResources.materials.push(w),p){let d=y=>{y!=null&&s.stageResources.textures.push(a.get(y))};d(o.colorTexture),d(o.normalTexture),d(o.occlusionTexture),d(o.emissiveTexture),d(o.metallicRoughnessTexture)}return w}function pr(r,e){let s=r.attributes.position.count,t=$e(r.indices||s,r.primitiveType),c=G(3*s),{typedBuffer:i,typedBufferStride:a}=r.attributes.position;Ne(c,i,r.transform,3,a);let l=[[B.POSITION,new I(c,t,3,!0)]];if(r.attributes.normal!=null){let n=G(3*s),{typedBuffer:u,typedBufferStride:m}=r.attributes.normal;Fe(N,r.transform),je(n,u,N,3,m),re(N)&&fe(n,n),l.push([B.NORMAL,new I(n,t,3,!0)])}if(r.attributes.tangent!=null){let n=G(4*s),{typedBuffer:u,typedBufferStride:m}=r.attributes.tangent;Ve(N,r.transform),De(n,u,N,4,m),re(N)&&fe(n,n,4),l.push([B.TANGENT,new I(n,t,4,!0)])}if(r.attributes.texCoord0!=null){let n=G(2*s),{typedBuffer:u,typedBufferStride:m}=r.attributes.texCoord0;qe(n,u,2,m),l.push([B.UV0,new I(n,t,2,!0)])}let o=r.attributes.color;if(o!=null){let n=new Uint8Array(4*s);o.elementCount===4?o instanceof ce?pe(n,o,1,255):(o instanceof Le||o instanceof ke)&&pe(n,o,1/255,255):(n.fill(255),o instanceof le?me(n,o.typedBuffer,1,255,4,o.typedBufferStride):(r.attributes.color instanceof Ce||r.attributes.color instanceof Ue)&&me(n,o.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),l.push([B.COLOR,new I(n,t,4,!0)])}return{geometry:new J(e,l),vertexCount:s}}var N=K();function dr(r){switch(r){case"BLEND":return R.Blend;case"MASK":return R.Mask;case"OPAQUE":case null:case void 0:return R.Opaque}}function xr(r,e){for(let s=0;s<r.model.lods.length;++s){let t=r.model.lods[s];for(let c of t.parts){let i=c.attributes.normal;if(i==null)return;let a=c.attributes.position,l=a.count,o=z(),n=z(),u=z(),m=new Float32Array(4*l),x=new Float32Array(3*l),h=Re(Ee(),c.transform),p=0,g=0;for(let T=0;T<l;T++){a.getVec(T,n),i.getVec(T,o),ie(n,n,c.transform),Be(u,n,e.center),ne(u,u,e.radius);let w=u[2],d=Ae(u),y=Math.min(.45+.55*d*d,1)**se;ne(u,u,e.radius),h!==null&&ie(u,u,h),Se(u,u),s+1!==r.model.lods.length&&r.model.lods.length>1&&Oe(u,u,o,w>-1?.2:Math.min(-4*w-3.8,1)),x[p]=u[0],x[p+1]=u[1],x[p+2]=u[2],p+=3,m[g]=y,m[g+1]=y,m[g+2]=y,m[g+3]=1,g+=4}c.attributes.normal=new le(x),c.attributes.color=new ce(m)}}}export{k as a,yt as b,cr as c};
