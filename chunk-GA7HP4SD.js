import{a as $,b as B,r as V,s as w,t as y}from"./chunk-XJSVCMF4.js";import"./chunk-WGX2RQVH.js";import"./chunk-JBWK3TLM.js";import"./chunk-LJHD6PO5.js";import"./chunk-WAIROH7D.js";import"./chunk-G27DRLGO.js";import"./chunk-7LF5QJDR.js";import"./chunk-J74DFTDJ.js";import"./chunk-DV32PZA3.js";import"./chunk-GDMTHEAC.js";import"./chunk-DJXUOLWY.js";import{n as J}from"./chunk-CZJNVIO4.js";import"./chunk-WPDA2XSD.js";import"./chunk-HEMZVBIO.js";import"./chunk-PRXMA6HV.js";import"./chunk-2EW3SBKG.js";import"./chunk-FCB5DYUJ.js";import"./chunk-3ZANJLLA.js";import"./chunk-7QY3BMVN.js";import"./chunk-WPDP647R.js";import"./chunk-4E4FE2IX.js";import"./chunk-5SSISWTF.js";import"./chunk-TJSLQWS6.js";import"./chunk-K3Z3MI77.js";import"./chunk-4XPPVS7X.js";import"./chunk-O4PKXMAM.js";import"./chunk-FYZRIMPP.js";import"./chunk-SP2CO3KX.js";import"./chunk-C5DQZVZ7.js";import"./chunk-WH2SG675.js";import"./chunk-NFWLUI2Z.js";import"./chunk-WRYEUJBQ.js";import"./chunk-DQOFEB5P.js";import"./chunk-ELQ6TEDY.js";import"./chunk-JMMCRVVF.js";import"./chunk-IPGHBSHO.js";import"./chunk-XPXAET6Q.js";import"./chunk-QS52XG5C.js";import"./chunk-2KE2TI42.js";import"./chunk-RZU6EEB3.js";import"./chunk-EUD3KSLO.js";import"./chunk-2ILDS6SI.js";import"./chunk-FVILOOND.js";import{a as x}from"./chunk-J75YI66W.js";import"./chunk-5E3QY4A2.js";import"./chunk-JHANZXTD.js";import"./chunk-ISL7QCEH.js";import"./chunk-2EUOCJVM.js";import"./chunk-WYYRYCXY.js";import"./chunk-ODTAY6YM.js";import"./chunk-KCSRPDMA.js";import"./chunk-YVRSGFS3.js";import"./chunk-XX2QGXLG.js";import"./chunk-YNPFZOJD.js";import"./chunk-XGP6WN73.js";import"./chunk-3ZX35QIC.js";import"./chunk-7PERXXHH.js";import"./chunk-QYRRGSBK.js";import{a as H}from"./chunk-5PVZ33WG.js";import"./chunk-DCKTHYU4.js";import"./chunk-525N4T6K.js";import"./chunk-EBK2L6ZQ.js";import"./chunk-ZMJUEIM7.js";import"./chunk-VGCEVKYN.js";import"./chunk-6T37AWU6.js";import"./chunk-XC4BCVYU.js";import"./chunk-V7IMCFL4.js";import"./chunk-XD6QSICT.js";import"./chunk-FTOLVNUN.js";import"./chunk-EOLWCIYR.js";import"./chunk-YOMR2DCD.js";import"./chunk-KDF3RZ2K.js";import"./chunk-AFSNSPOG.js";import"./chunk-LPCVOXF2.js";import"./chunk-4AIH3WFI.js";import"./chunk-JOGV3DWE.js";import"./chunk-JEGXFID4.js";import"./chunk-SU5S5XU7.js";import"./chunk-E4VXIIFB.js";import"./chunk-B5LBE5HD.js";import"./chunk-F6A6XWW4.js";import"./chunk-AESEF3B2.js";import"./chunk-74LTYPBC.js";import"./chunk-3BDL2KTL.js";import"./chunk-TGPGCQ44.js";import"./chunk-PWU2QHPV.js";import"./chunk-WUJRCGDY.js";import"./chunk-QPGCDGIN.js";import"./chunk-7Y6S2GNA.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-PTZYZULI.js";import"./chunk-KZKWOEFD.js";import"./chunk-LNVVFNTC.js";import"./chunk-NHQ2XIW3.js";import"./chunk-MBE3KZ4V.js";import"./chunk-EWGQ3XHW.js";import{a as z}from"./chunk-MAVVUPFJ.js";import{a as K}from"./chunk-OOAI5LGC.js";import{c as O}from"./chunk-5TMYC5PF.js";import"./chunk-RCDSCJMH.js";import"./chunk-QJADLTFR.js";import{a as j}from"./chunk-IWPCZHB6.js";import{a as P}from"./chunk-2BIJFS64.js";import{e as U}from"./chunk-SCKV27CX.js";import"./chunk-FXCL7YYQ.js";import"./chunk-HX2BGUTP.js";import"./chunk-XSTBHERR.js";import{a as G}from"./chunk-S7QYPX7J.js";import{a as F}from"./chunk-KWZIB4M6.js";import"./chunk-YQPWWSMJ.js";import"./chunk-JEIB6WNP.js";import"./chunk-6JJCXUHW.js";import"./chunk-CVRJ6GOM.js";import"./chunk-X7QUUHRV.js";import"./chunk-7B2UKJ5N.js";import"./chunk-RSDQHAJX.js";import"./chunk-3HCMTURP.js";import"./chunk-VT67LWCR.js";import"./chunk-K27GONOJ.js";import"./chunk-6KRFVLII.js";import"./chunk-JR22Z7I2.js";import"./chunk-3QNSJ5HY.js";import"./chunk-UNVICPIE.js";import"./chunk-BGICKEJR.js";import"./chunk-TRZXSDYA.js";import"./chunk-OGS2SUK5.js";import"./chunk-TVHRLNTK.js";import"./chunk-JA3EMS2I.js";import"./chunk-HKHTIKVW.js";import"./chunk-XFESK2YB.js";import"./chunk-IJBTA53P.js";import"./chunk-ZHUXSQTN.js";import"./chunk-YLZWDFCJ.js";import"./chunk-TLMADEUL.js";import"./chunk-WNSGKHQ6.js";import"./chunk-J5MXC6AL.js";import"./chunk-OLOKUDVI.js";import"./chunk-RJWOVI3M.js";import"./chunk-R6GE4XRP.js";import"./chunk-MDL4XPLR.js";import"./chunk-ILKINAL7.js";import"./chunk-HVKMTRIC.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import"./chunk-NHSDW26F.js";import"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import"./chunk-WKJJQIBC.js";import"./chunk-VDADRLEF.js";import"./chunk-CNQVGGE6.js";import"./chunk-JGD7UKVF.js";import"./chunk-X5AA4JDN.js";import"./chunk-J372WZPB.js";import"./chunk-6XFS4U2F.js";import"./chunk-XPRVY6JT.js";import"./chunk-7N3ZKWML.js";import"./chunk-E62WHYYG.js";import"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import"./chunk-3SDSCSDJ.js";import"./chunk-I4M2OT5W.js";import"./chunk-NTVLK3P2.js";import"./chunk-WMQNRNIU.js";import{a as v}from"./chunk-HD52PWPC.js";import{a as I}from"./chunk-EIPVFA6F.js";import"./chunk-VOFKUGRY.js";import"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-IXCTZWTQ.js";import"./chunk-6PN3I333.js";import"./chunk-ZTJLFKGG.js";import"./chunk-5TW726OD.js";import"./chunk-VGD3XLDH.js";import{a as N,g as R}from"./chunk-LB5YQINJ.js";import{b as m}from"./chunk-EKMHQEJY.js";import"./chunk-VACZNAP3.js";import"./chunk-JKNCWG7E.js";import{a as k}from"./chunk-SLAWDKDA.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7IPIJKWU.js";import"./chunk-7R33MKVL.js";import"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import{h as E,i as g}from"./chunk-E57FTRWF.js";import{w as A,y as C}from"./chunk-U4J5SECU.js";import"./chunk-7EG726PT.js";import{d as n,o as h,q as S,r as D}from"./chunk-C7INQGWT.js";import{H as _,c as T}from"./chunk-WMHJC7XF.js";import"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{x as L}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import{a as r}from"./chunk-QGVBCWUY.js";import{r as f,t as u}from"./chunk-HHDFN2GK.js";import"./chunk-47GHT6OF.js";import{f as l}from"./chunk-VTHXE323.js";var o=class extends O(j(K(x(P(z(G(H(F)))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(m.ofType(y)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(m.ofType(y)),this.type="knowledge-graph",this.url=null,this.addHandles(N(()=>this.layers.concat(this.tables),(t,i)=>this._handleSublayersChange(t,i),R))}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}_doLoad(e){return l(this,null,function*(){try{yield this.loadFromPortal({supportedTypes:["Knowledge Graph Layer"]},e)}catch(t){L(t)}yield this._fetchMetadata(),yield this._initializeLayerProperties(),this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||(yield w(this))})}_fetchMetadata(){return l(this,null,function*(){if(!this.url)throw new u("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");let e=yield J(this.url);this.knowledgeGraph=e,this._forEachGraphType(t=>{t.name&&this._graphTypeLookup.set(t.name,t)})})}_initializeLayerProperties(){return l(this,null,function*(){this.originIdOf("inclusionModeDefinition")===h.USER?this._validateInclusionModeDefinition():yield this._initializeInclusionModeDefinition(),this._setMemberTypes(),this.dataManager=new V({knowledgeGraph:this.knowledgeGraph,inclusionModeDefinition:this.inclusionModeDefinition})})}_initializeInclusionModeDefinition(){return l(this,null,function*(){let e=this.definitionSetMap?yield $(this.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...this.layers.toArray(),...this.tables.toArray()].forEach(t=>{let i=this._graphTypeLookup.get(t.graphTypeName);i&&!e.namedTypeDefinitions.has(i.name)&&e.namedTypeDefinitions.set(i.name,{useAllData:!0})}),this.setAtOrigin("inclusionModeDefinition",e,D(this.originIdOf("definitionSetMap")))})}_validateInclusionModeDefinition(){let{inclusionModeDefinition:e}=this;if(!e)return;let{namedTypeDefinitions:t}=e;if(t?.size>0)t.forEach((i,a)=>{let s=this._graphTypeLookup.get(a);if(!s)return f.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void t.delete(a);s.type!=="relationship"&&s.type!=="entity"&&(f.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't properly modeled and will be removed`),t.delete(a))});else if(!e.generateAllSublayers)throw new u("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){let e=[],t=[],{inclusionModeDefinition:i}=this,a=i?.namedTypeDefinitions;!i||i.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],t=this.knowledgeGraph.dataModel?.relationshipTypes??[]):a&&a.size>0&&a.forEach((s,d)=>{let p=this._graphTypeLookup.get(d);switch(p?.type){case"relationship":t.push(p);break;case"entity":e.push(p)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=t}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(t=>{e(t)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_handleNewRecords(e){return l(this,null,function*(){let t=[];this.dataManager.addToLayer(e);for(let i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(let i of t){let a=this._graphTypeLookup.get(i);a&&(this._addSublayer(a),a.type==="entity"?this.dataManager.entityTypeNames.add(i):this.dataManager.relationshipTypeNames.add(i),this.dataManager.sublayerCaches.set(i,new Map))}yield w(this,t),this._refreshNamedTypes()})}_createSublayers(e,t,i){e.forEach(a=>{let s=this._createSublayer(a);i(s)&&t.push(s),this._updateSublayerCaches(a)})}_addSublayer(e){let t=this._createSublayer(e);return t.geometryType?this.layers.push(t):this.tables.push(t),t}_createSublayer(e){return new y({objectType:e,parentCompositeLayer:this,graphType:e.type})}_updateSublayers(e,t){t.forEach(i=>{i.parentCompositeLayer=this;let a=e.find(s=>s.type===i.graphType&&s.name===i.graphTypeName);a&&(i.objectType=a,this._updateSublayerCaches(a))})}_updateSublayerCaches(e){let t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}_saveUrlAsNewResource(e,t,i,a){e[t]="<pending>",i.pendingOperations.push(q(this.inclusionModeDefinition).then(s=>{let d=Q(a);e[t]=d.itemRelativeUrl,i.toAdd.push({resource:d,content:{type:"blob",blob:s},compress:!1,finish:p=>{this.definitionSetMap=p.url}})}))}_displaysAllRecords(e){for(let[,{useAllData:t}]of e.namedTypeDefinitions)if(!t)return!1;return!0}_handleSublayersChange(e,t){t&&(t.forEach(i=>{i.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(i=>{i.parent=this}),this.addHandles([e.on("after-add",({item:i})=>{i.parent=this}),e.on("after-remove",({item:i})=>{i.parent=null})],"sublayers-owner"))}_layersLoadedFromAuthoritativeItem(){let e=this.originIdOf("layers");return e>=h.PORTAL_ITEM&&e<h.USER}readDefinitionSetMap(e,t,i){return E(e,i)}writeDefinitionSetMap(e,t,i,a){let s=a?.portalItem,d=a?.resources,p=S(a?.origin);if(!s||!d||p==null)return void(e&&(t[i]=g(e,a)));let{inclusionModeDefinition:M}=this;if(!M||this._displaysAllRecords(M))return void(this.definitionSetMap=null);let c=this.originIdOf("inclusionModeDefinition");if(c===h.USER||this._namedTypesModified||p<c)this._saveUrlAsNewResource(t,i,d,s);else if(p===c&&e){let b=g(e,a);C(b)?this._saveUrlAsNewResource(t,i,d,s):t[i]=b}}set inclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("inclusionModeDefinition",e):f.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){let e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===h.DEFAULTS?this._createSublayers(e,this.layers,t=>!!t.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===h.DEFAULTS?this._createSublayers(e,this.tables,t=>!t.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,i)=>{let a=T(this.sublayerIdsCache,i,()=>new Set);t.members?.forEach(s=>{a.add(s.id)})})}addRecords(e){return l(this,null,function*(){yield this.load(),yield this._handleNewRecords(e)})}removeRecords(e){return l(this,null,function*(){yield this.load();let t=[];for(let i of e)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.members?.has(i.id)&&t.push(i);this.dataManager.removeFromLayer(t);for(let i of t)this.sublayerIdsCache.get(i.typeName)?.delete(i.id);return this._refreshNamedTypes(),t})}};r([n()],o.prototype,"dataManager",void 0),r([n({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],o.prototype,"definitionSetMap",void 0),r([v("definitionSetMap")],o.prototype,"readDefinitionSetMap",null),r([I("definitionSetMap")],o.prototype,"writeDefinitionSetMap",null),r([n()],o.prototype,"inclusionModeDefinition",null),r([n()],o.prototype,"knowledgeGraph",void 0),r([n({type:m.ofType(y),json:{write:{ignoreOrigin:!0}}})],o.prototype,"layers",void 0),r([n()],o.prototype,"memberEntityTypes",void 0),r([n()],o.prototype,"memberRelationshipTypes",void 0),r([n({type:["KnowledgeGraphLayer"]})],o.prototype,"operationalLayerType",void 0),r([n()],o.prototype,"sublayerIdsCache",void 0),r([n({type:m.ofType(y),json:{write:{ignoreOrigin:!0}}})],o.prototype,"tables",void 0),r([n({json:{read:!1}})],o.prototype,"type",void 0),r([n(U)],o.prototype,"url",void 0),o=r([_("esri.layers.KnowledgeGraphLayer")],o);var Ae=o;function q(e){return l(this,null,function*(){let t=yield B(e);return new Blob([t],{type:"application/x-protobuf"})})}function Q(e){let t=`definitionSetMap-${k()}.dat`,i=A("knowledgeGraphLayer",t);return e.resourceFromPath(i)}export{Ae as default};
