import{a as up}from"./chunk-LKFMQH27.js";import{a as Ls,d as Ni,e as ri,f as Vs,g as Ee,h as qa,i as Sp,k as Jr,l as Op,m as Ep,o as Gs}from"./chunk-7VHSEJ25.js";import"./chunk-M7JJUQ72.js";import{B as Je,a as mp,b as ki,d as ai,e as pa,f as ha,i as ce,l as Xa,m as Mp,o as oi}from"./chunk-TBX4IK4K.js";import{a as Rp,b as Ap,c as Dp}from"./chunk-S3LOMZBJ.js";import{a as eo,b as Tp}from"./chunk-RYFV266C.js";import{a as da}from"./chunk-227LXKYP.js";import{c as xp}from"./chunk-PSPSNLSW.js";import"./chunk-7N2BD2NB.js";import"./chunk-RZVJEXV6.js";import"./chunk-3VC7PBS6.js";import"./chunk-LYVHPFC2.js";import"./chunk-EJVEY5BL.js";import"./chunk-45D2EG5D.js";import"./chunk-E5JLMNB6.js";import{b as wp}from"./chunk-GDGGFCAO.js";import"./chunk-3XXBF5JT.js";import{a as Et,b as fp,c as gp,e as _p}from"./chunk-FKZYU3VD.js";import{a as vp,c as bp}from"./chunk-F6CTCIP4.js";import{b as yp}from"./chunk-QJC7O25K.js";import"./chunk-DJ5ZP6NM.js";import"./chunk-VZB227JA.js";import"./chunk-757YQ6CM.js";import"./chunk-7FS3ZJLK.js";import"./chunk-WJ6C4VZW.js";import{a as qc,b as Qc,c as lp,d as cp,e as pp}from"./chunk-GBK27SC6.js";import{A as op,B as sp,k as ei,l as he,m as Jc,n as Kc,p as ep,q as tp,r as ip,s as Ft,t as $e,u as ti,v as ii,w as js,x as ap,y as Fi,z as rp}from"./chunk-TVN7IBCP.js";import{a as Vc,c as Nc,e as Uc,f as Wr,g as Zc,h as Bc,i as Wc,j as Yr,k as Ps}from"./chunk-WHD5RQHG.js";import{d as Oe,f as qr,h as $c,i as Cs,l as ca,m as Hi}from"./chunk-ZEE52UAO.js";import{A as Ot,C as Xr,D as Yc,F as Xc,G as Is,H as na,I as la,j as Hc,l as Fc,t as Kt,u as kc,v as Ya,w as Zr,x as zi,y as Br}from"./chunk-BXUPDT4D.js";import{b as np}from"./chunk-J5F2KYSA.js";import"./chunk-B6OGPRTQ.js";import"./chunk-4OC4J3KU.js";import"./chunk-GOLGIJPD.js";import"./chunk-3K4PPROZ.js";import"./chunk-H2ZYDNNL.js";import{c as dc,d as mc,e as bc}from"./chunk-K57Y3IIR.js";import{A as Ur,f as Sc,q as Vi,s as Oc,u as Ba,v as Ec,w as wc,x as Nr,y as Se,z as Gi}from"./chunk-G3YWARR2.js";import{b as fc,c as gc,d as _c,e as vc}from"./chunk-DFTJYHYF.js";import{c as yc,d as xs,e as Mc}from"./chunk-MIOOILW6.js";import{a as uc}from"./chunk-TTCWVZMG.js";import"./chunk-QA5EAWXI.js";import"./chunk-K2IZFVKY.js";import"./chunk-XAHD7XBV.js";import{a as Gr,b as zr,c as Hr,d as Fr,h as kr}from"./chunk-FWCA6KJ3.js";import"./chunk-G6C3YEMS.js";import{a as hc}from"./chunk-S52JRLJC.js";import"./chunk-W5OI4BJ2.js";import"./chunk-ZWYEIB75.js";import"./chunk-XSALJEMC.js";import{a as sa}from"./chunk-6D3BMGGD.js";import"./chunk-HIB3F52F.js";import"./chunk-NOHUHVCW.js";import{B as rc,C as oc,D as Es,G as sc,I as nc,J as lc,e as Rr,f as Ql,g as $l,h as Cr,i as Jl,j as Kl,k as ec,l as tc,m as jr,o as Os,r as St,u as ic,x as ac}from"./chunk-P64DWRJ7.js";import{c as Bl,d as Vr}from"./chunk-4MYROXQR.js";import{a as Lr,b as ae}from"./chunk-L5JJXC3A.js";import"./chunk-NRQSFK4P.js";import"./chunk-J2SAHMG5.js";import"./chunk-PSNQ2KG3.js";import{e as Ua}from"./chunk-DBZKWPEX.js";import{a as xr}from"./chunk-AYSSTKZP.js";import{a as nt,b as lt,d as ws,g as pc}from"./chunk-WXB3UZNT.js";import"./chunk-VOJIMLDZ.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-WPMNZVYJ.js";import{a as Ar,d as ys,e as Wl,g as Dr}from"./chunk-7VWXQFPJ.js";import"./chunk-CSFAHB4Y.js";import"./chunk-AMISFAT3.js";import"./chunk-PTXLSCMJ.js";import{c as Za,d as ql,f as Ir,h as zt,i as Ht}from"./chunk-FZ5X7HOK.js";import"./chunk-XXQKBDTN.js";import"./chunk-O2J7LFYY.js";import"./chunk-6DKBN3BZ.js";import"./chunk-WDRWH4L7.js";import{b as Vt,h as Yl,j as Xl,k as O,l as Pr}from"./chunk-3D4Y6BLC.js";import{a as oa}from"./chunk-OTUHXNWB.js";import{b as cc}from"./chunk-NBT2WTKD.js";import"./chunk-JLLOI4DS.js";import"./chunk-4MZNR6MW.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import{a as Ms}from"./chunk-L7NOU4T2.js";import{a as $t,b as Li,d as Ss}from"./chunk-Y34QJIHM.js";import{a as Gt,b as aa,c as Nl,d as ra,e as Ul,g as ji,i as Zl}from"./chunk-PSIELDY2.js";import"./chunk-EG2DTURK.js";import"./chunk-7XYJRI7F.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-4XEE5PE3.js";import"./chunk-A5S42OSQ.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-DHLVTH5U.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-GK3RYCKG.js";import"./chunk-B564E6X6.js";import{b as ka}from"./chunk-TBHSFWI7.js";import"./chunk-FSWSNKJD.js";import{a as jl,e as gs,g as wr,h as Ci,i as Tr}from"./chunk-3AS27HNO.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-MVDZB4AK.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import{a as x}from"./chunk-RWCIDBNQ.js";import"./chunk-5SSISWTF.js";import"./chunk-2NH7HOKA.js";import{a as Q,c as ve}from"./chunk-ONYJLWAD.js";import"./chunk-7YU5I7BM.js";import"./chunk-HBZAOVHW.js";import"./chunk-Y7MZCJ2F.js";import"./chunk-TKZJUAKL.js";import"./chunk-EDAGF7R6.js";import{a as xl}from"./chunk-6EWMYOA7.js";import{b as vl}from"./chunk-IDLNQPT7.js";import"./chunk-VRPEURU5.js";import{a as Dl,c as Pl}from"./chunk-B57IWIA2.js";import"./chunk-JAPGPEA6.js";import"./chunk-UFTHBQFR.js";import"./chunk-KLXERNY4.js";import"./chunk-VU5W7W6Y.js";import{a as Rs,b as Kr}from"./chunk-OTO4USI3.js";import{b as hp,c as dp}from"./chunk-OSKPIRVE.js";import{a as $r}from"./chunk-DJ6TVMFM.js";import"./chunk-EG4FJL5O.js";import{b as E,c as le}from"./chunk-NSDBF4VB.js";import"./chunk-IL63CQ3W.js";import{d as Qe}from"./chunk-LK4L5XN7.js";import{a as qe}from"./chunk-BYX5KLGZ.js";import"./chunk-5IRLA4AM.js";import"./chunk-AVLSWJCG.js";import"./chunk-FKL22O54.js";import{q as Qr}from"./chunk-IOI3V6WL.js";import{f as Cc,i as As,k as jc,l as Lc,n as Ds}from"./chunk-IAM754TS.js";import{a as Gc,c as zc}from"./chunk-DLMQHZTF.js";import"./chunk-2XQT24NO.js";import"./chunk-PUWPAT3A.js";import{d as Ac,e as Dc,f as Pc,g as Ic}from"./chunk-Y4OUS3AZ.js";import"./chunk-CCGZQUKC.js";import"./chunk-5K5ZHVX6.js";import"./chunk-SNPAQLOL.js";import"./chunk-AA5W2OSC.js";import{b as Tc,d as xc,f as Rc,h as Wa,j as Re}from"./chunk-RXT2WPNA.js";import"./chunk-WBPLJNRU.js";import"./chunk-R3KYOH5H.js";import"./chunk-E2J2V7JN.js";import{a as Jt}from"./chunk-7X55A7Q6.js";import"./chunk-NFWLUI2Z.js";import"./chunk-WRYEUJBQ.js";import"./chunk-ELQ6TEDY.js";import"./chunk-JMMCRVVF.js";import{h as Ts}from"./chunk-IPGHBSHO.js";import"./chunk-XPXAET6Q.js";import"./chunk-BUZBVNOM.js";import"./chunk-VYZHOYXV.js";import{a as Xe}from"./chunk-VC7OIMIK.js";import{a as Ne}from"./chunk-NIYDRLW4.js";import{a as _s,b as Ll,c as Vl,f as Gl,h as zl,i as vs,k as Hl,l as ia,m as Fl,n as kl,w as Na,x as bs}from"./chunk-WTJO2NGM.js";import{a as Lt}from"./chunk-3Q427ME6.js";import{a as Mt,b as Fa,d as Er,e as fs}from"./chunk-3BZAI7HK.js";import"./chunk-LNYBTIG7.js";import{c as Fn,d as Jo}from"./chunk-EXXSZWI5.js";import"./chunk-YW3L7OMP.js";import"./chunk-RZU6EEB3.js";import"./chunk-6T37AWU6.js";import"./chunk-EOLWCIYR.js";import"./chunk-4AIH3WFI.js";import"./chunk-JOGV3DWE.js";import{a as za,b as Il,i as Ha,r as Cl}from"./chunk-HM5RIVQC.js";import{D as wl,a as Ol,e as hs,f as b,h as K,i as ds,m as bt,q as ke,y as yt}from"./chunk-SKMO433W.js";import{a as st,c as El}from"./chunk-2FO7ARYZ.js";import"./chunk-VLECDDLP.js";import{f as Sl}from"./chunk-HE4N5PN6.js";import{a as Tl}from"./chunk-NOQEJXLK.js";import{a as us}from"./chunk-DJW5LMRG.js";import{a as ms,b as Pi,c as Ii,d as Rl,g as Qt,j as Or,n as ta,q as Al}from"./chunk-QXXXCEV5.js";import{i as ps}from"./chunk-QMKRRCM3.js";import"./chunk-TCGGI7DC.js";import{a as re,c as bl,d as yl}from"./chunk-ALWV3RJ2.js";import{a as Ml}from"./chunk-7C6Z24SS.js";import{C as jt,D as gl,E as cs,G as _l,a as Ce,b as z,c as C,d as j,e as A,m as B,n as rt,o as ss,p as Sr,q as ns,r as fl,t as ie,u as Me,v as me,w as ot,x as Ct,y as ls}from"./chunk-5WKDXHVH.js";import"./chunk-B5LBE5HD.js";import"./chunk-F6A6XWW4.js";import"./chunk-AESEF3B2.js";import"./chunk-PWU2QHPV.js";import"./chunk-WUJRCGDY.js";import"./chunk-QPGCDGIN.js";import{g as dl,h as qt,i as ul,j as Ye,k as ml,l as te,m as rs,n as os}from"./chunk-JH4RD366.js";import"./chunk-7Y6S2GNA.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import{b as Mr,c as se,e as as}from"./chunk-PTZYZULI.js";import{a as _e,l as xe}from"./chunk-KZKWOEFD.js";import"./chunk-LNVVFNTC.js";import"./chunk-5TMYC5PF.js";import"./chunk-RCDSCJMH.js";import"./chunk-QJADLTFR.js";import"./chunk-IWPCZHB6.js";import"./chunk-FXCL7YYQ.js";import{a as yr}from"./chunk-HX2BGUTP.js";import"./chunk-XSTBHERR.js";import"./chunk-KWZIB4M6.js";import"./chunk-YQPWWSMJ.js";import"./chunk-JEIB6WNP.js";import"./chunk-6JJCXUHW.js";import{a as ol}from"./chunk-CVRJ6GOM.js";import"./chunk-X7QUUHRV.js";import{a as _r,b as pl,c as La,f as hl,g as Le,h as Va,i as It,j as es,k as Ga,m as ts,n as Ai,o as Di,p as vr,r as br,x as is}from"./chunk-7B2UKJ5N.js";import{a as cl}from"./chunk-RSDQHAJX.js";import"./chunk-K27GONOJ.js";import"./chunk-6KRFVLII.js";import"./chunk-JR22Z7I2.js";import"./chunk-3QNSJ5HY.js";import"./chunk-UNVICPIE.js";import"./chunk-BGICKEJR.js";import{D as rl,a as xi,d as el,m as gr,t as tl,y as il,z as al}from"./chunk-TRZXSDYA.js";import{a as Hn}from"./chunk-OGS2SUK5.js";import"./chunk-TVHRLNTK.js";import"./chunk-JA3EMS2I.js";import"./chunk-HKHTIKVW.js";import"./chunk-XFESK2YB.js";import"./chunk-IJBTA53P.js";import"./chunk-ZHUXSQTN.js";import"./chunk-YLZWDFCJ.js";import"./chunk-TLMADEUL.js";import"./chunk-WNSGKHQ6.js";import{a as U}from"./chunk-J5MXC6AL.js";import{f as ge,h as ja,i as Ti}from"./chunk-OLOKUDVI.js";import"./chunk-RJWOVI3M.js";import"./chunk-AZS4Q4RE.js";import"./chunk-QEBUS3TL.js";import{r as ll,v as Ri}from"./chunk-IB2IUO7T.js";import"./chunk-MS3KE2OO.js";import{a as g,b as We,c as G,h as ea}from"./chunk-NHSDW26F.js";import{f as sl,g as nl}from"./chunk-NMAGYK3Q.js";import"./chunk-GWBRHLNH.js";import{a as Ki}from"./chunk-WKJJQIBC.js";import"./chunk-VDADRLEF.js";import"./chunk-CNQVGGE6.js";import"./chunk-JGD7UKVF.js";import"./chunk-J372WZPB.js";import"./chunk-6XFS4U2F.js";import"./chunk-XPRVY6JT.js";import"./chunk-7N3ZKWML.js";import{i as $n}from"./chunk-E62WHYYG.js";import{i as Kn}from"./chunk-QDTU3MWT.js";import"./chunk-BCREO4Q5.js";import{o as Jn,p as fr}from"./chunk-3SDSCSDJ.js";import"./chunk-I4M2OT5W.js";import{n as Ie}from"./chunk-NTVLK3P2.js";import{a as Qn}from"./chunk-WMQNRNIU.js";import"./chunk-HD52PWPC.js";import"./chunk-EIPVFA6F.js";import{b as wi,f as ne,g as vt}from"./chunk-VOFKUGRY.js";import{N as Wn,ga as Yn,ia as Xn,ja as qn}from"./chunk-IG66NQHW.js";import"./chunk-ARRCN5K3.js";import"./chunk-MDSLION2.js";import"./chunk-7ZYPJJID.js";import"./chunk-UAKHZRKN.js";import"./chunk-HAHX77IL.js";import"./chunk-IXCTZWTQ.js";import"./chunk-6PN3I333.js";import{b as Un}from"./chunk-ZTJLFKGG.js";import"./chunk-5TW726OD.js";import"./chunk-VGD3XLDH.js";import{a as v,b as it,c as Xt,g as at,h as L,i as Pe}from"./chunk-LB5YQINJ.js";import{b as Bn}from"./chunk-EKMHQEJY.js";import{a as oe}from"./chunk-VACZNAP3.js";import{e as Zn}from"./chunk-JKNCWG7E.js";import"./chunk-SLAWDKDA.js";import"./chunk-KTE5HCNJ.js";import"./chunk-F7VRLFCB.js";import"./chunk-7IPIJKWU.js";import{c as Nn}from"./chunk-7R33MKVL.js";import{a as Ko}from"./chunk-ISSJ3A6Y.js";import"./chunk-VDKRSX77.js";import"./chunk-WUA6PW3I.js";import"./chunk-E57FTRWF.js";import"./chunk-U4J5SECU.js";import{f as kn}from"./chunk-7EG726PT.js";import{H as zn,L as Te,d,n as Yt}from"./chunk-C7INQGWT.js";import{H as D,f as $o}from"./chunk-WMHJC7XF.js";import{c as Gn}from"./chunk-NJEWDTYF.js";import"./chunk-N3SDOFND.js";import"./chunk-OVHPPCBL.js";import"./chunk-FNXQZPHT.js";import"./chunk-3TQOUBNU.js";import{a as H,b as Ca,d as J,e as mr,g as ye,i as N,j as Ln,k as tt,n as Vn}from"./chunk-D2LVMNOU.js";import"./chunk-SNFOAZZQ.js";import{a as p}from"./chunk-QGVBCWUY.js";import"./chunk-HHDFN2GK.js";import{a as dr,n as jn,t as ur}from"./chunk-47GHT6OF.js";import"./chunk-5RWLLGQU.js";import{a as y,b as R,c as Ei}from"./chunk-VTHXE323.js";var fd=3025,gd={default:15,far:25},Ue=class extends Te{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messageUnitsTask=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){this.addHandles([v(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(t=>Xt(()=>this.context?.editGeometryOperations,t,()=>this._update())),v(()=>this._colors,t=>this._updateStyle(t)),Nn(()=>this._refreshMessages()),H(()=>this._messageUnitsTask?.abort())]),this._refreshMessages()}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){}get _messagesUnits(){return this._messageUnitsTask?.value}get _edgeDistancePixels(){return gd[this.edgeDistance]}get _colors(){let t=this.context?.view.effectiveTheme.textColor??U.fromArray([255,255,255]);return{textColor:t,backgroundColor:Ye(qt(t,dl.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;let{context:t,stagedVertex:e}=this;if(!t)return this._destroyUnusedLabels();let{editGeometryOperations:i}=t,{components:a,geometry:r,coordinateHelper:o}=i.data;if(!r)return this._destroyUnusedLabels();let s=a.length;for(let n=0;n<s;++n){let l=_d(r,i,e,o,n);if(l.length<2||!vd(l,t.view,t.elevationInfo,o.spatialReference))continue;let c=s===1&&!$n(l),h=yd,u=Md;this.toScreenPointArray(t,l[0],h);for(let m=1;m<l.length;++m){let f=l[m-1],_=l[m];this.toScreenPointArray(t,_,u),this._addLabel(t,f,h,_,u,c),[h,u]=[u,h]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:e}){let i=this._nextLabelIndex,a=this._labelInfos;for(let r=0;r<i;++r){let{label:o}=a[r];o.textColor=t,o.backgroundColor=e}}_addLabel(t,e,i,a,r,o){let{label:s}=this._getOrCreateLabel(t);if(!this.visible||Or(i,r)<fd)return void(s.visible=!1);let{spatialReference:n}=t.editGeometryOperations.data,l=la(e,a,n),c=this._messagesUnits,h=Hc(t.view);s.text=c!=null&&l!=null?Fc(c,l,h):"",s.visible=!0;let u=r[0]-i[0],m=r[1]-i[1];o?Pi(ct,-m,u):Pi(ct,m,-u),ta(ct,ct),Qt(ct,ct,this._edgeDistancePixels),Al(Qa,i,r,.5),Ii(Qa,Qa,ct),s.position=[Qa[0],Qa[1]],Math.abs(ct[0])>Math.abs(ct[1])?s.anchor=ct[0]>0?"left":"right":s.anchor=-ct[1]<0?"top":"bottom"}_getOrCreateLabel(t){let e=this._labelInfos.length>this._nextLabelIndex,{textColor:i,backgroundColor:a}=this._colors;if(e){let s=this._labelInfos[this._nextLabelIndex++],{label:n}=s;return n.textColor=i,n.backgroundColor=a,s}let r=new up({anchor:"center",fontSize:8,textColor:i,backgroundColor:a});t.view.overlay?.items.add(r);let o={label:r};return this._labelInfos.push(o),this._nextLabelIndex=this._labelInfos.length,o}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){this.context?.view.overlay?.items.remove(t),t.destroy()}_refreshMessages(){this._messageUnitsTask?.abort(),this._messageUnitsTask=Zn(()=>Un("esri/core/t9n/Units"))}};function _d(t,e,i,a,r){let o=[];if(e.data.components[r].iterateVertices(l=>{o.push(a.toXYZ(l.pos,b.get()))}),r===0&&i!=null&&o.push(a.toXYZ(i,b.get())),o.length<2)return o;let s=o[0],n=o[o.length-1];return t.type==="polygon"&&o.length>2&&!gl(s,n)&&o.push(s),o}function vd(t,e,i,a){if(e.type==="2d")return!0;let r=qn(a)??1,o=Yn(a),s=n=>kl(e,n,a,i,Na)??0;for(let n=1;n<t.length;++n){let l=t[n-1],c=t[n],h=(c[0]-l[0])*r,u=(c[1]-l[1])*r,m=(s(c)-s(l))*o;if(Math.abs(m)/Math.sqrt(h*h+u*u)>bd)return!1}return!0}p([d()],Ue.prototype,"context",void 0),p([d()],Ue.prototype,"stagedVertex",void 0),p([d()],Ue.prototype,"visible",void 0),p([d()],Ue.prototype,"edgeDistance",void 0),p([d()],Ue.prototype,"updating",null),p([d()],Ue.prototype,"_messageUnitsTask",void 0),p([d()],Ue.prototype,"_messagesUnits",null),p([d()],Ue.prototype,"_edgeDistancePixels",null),p([d()],Ue.prototype,"_colors",null),Ue=p([D("esri.views.interactive.SegmentLabels")],Ue);var bd=ne(5),ct=st(),Qa=st(),yd=ge(),Md=ge();var ua=class extends Ue{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,r=ge()){let{spatialReference:o}=i.data.coordinateHelper;return $r(a,o,e,t,Pp),t.state.camera.projectToScreen(Pp,r),r}};ua=p([D("esri.views.3d.interactive.SegmentLabels3D")],ua);var Pp=g();var to=class{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=ki.Outline}destroy(){this._destroyResources()}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){this._renderGroup=e;let i=this._resources?.layerView;i&&(i.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?this._resources!=null&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?this._resources==null&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();let e=this._resourceFactory.createResources(),i=new Ui({view:this._resourceFactory.view,renderGroup:this._renderGroup}),a=this._resourceFactory.view.basemapTerrain?.overlayManager;this._resources={layerView:new Ui({view:this._resourceFactory.view,renderGroup:this._renderGroup}),external:e,geometriesAdded:!1},a&&(this._resources.drapeSourceRenderer=a.registerGeometryDrapeSource(i)),this._syncGeometriesToRenderer()}_destroyResources(){if(this._resources==null)return;this._ensureRenderGeometriesRemoved();let e=this._resourceFactory.view.basemapTerrain?.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){this._resources?.drapeSourceRenderer!=null&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,Ls.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){this._resources?.drapeSourceRenderer!=null&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,Ls.UPDATE),this._resources.geometriesAdded=!0))}},Ui=class extends ol.IdentifiableMixin(Te){constructor(t){super(t),this.drapeSourceType=mp.Features,this.updatePolicy=ai.SYNC,this.renderGroup=ki.Outline}};p([d({constructOnly:!0})],Ui.prototype,"view",void 0),p([d({readOnly:!0})],Ui.prototype,"drapeSourceType",void 0),p([d()],Ui.prototype,"renderGroup",void 0),Ui=p([D("esri.views.3d.interactive.visualElements.DrapedVisualElementResources")],Ui);var si=class{get isDecoration(){return this._isDecoration}set isDecoration(e){this._isDecoration=e}constructor(e){this._isDecoration=!1,this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e.view,this._handle=v(()=>e.view.ready,i=>{this._resourcesCreated&&(i?this._createResources():this._destroyResources())})}applyProperties(e){let i=!1;for(let a in e)a in this&&(a==="attached"?i=!!e[a]:this[a]=e[a]);this.attached=i}destroy(){this.attached=!1,this._handle.remove()}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources(),this.onAttachedChange(e))}onAttachedChange(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.updateVisibility(this.visible)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}};var io=class{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return this._resources!=null?this._resources.object:null}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();let e=this._resourceFactory.view._stage;if(this._resources==null||!e)return;let i=this._resources.object;this._resources.external.forEach(a=>{a.type!==Vt.Mesh&&a.type!==Vt.Line&&a.type!==Vt.Point||e.remove(a)}),i.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,i,this._resources.layer),this._resources.external.forEach(a=>{a.type!==Vt.Mesh&&a.type!==Vt.Line&&a.type!==Vt.Point||e.add(a)})}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();let e=this._resourceFactory,i=e.view,a=i._stage;if(!a)return;let r=new ha(a,{pickable:!1,updatePolicy:ai.SYNC}),o=new pa({castShadow:!1}),s=e.createResources(o,r);s.forEach(c=>{a.add(c),c.type===Vt.Texture&&c.load(a.renderView.renderingContext)}),a.add(o),r.add(o);let n=e.cameraChanged,l=n?v(()=>i.state.camera,c=>n(c),L):null;this._resources={layer:r,object:o,external:s,cameraHandle:l},this._syncVisible()}_destroyResources(){if(this._resources==null)return;let e=this._resourceFactory.view._stage;e&&(e.remove(this._resources.object),this._resources.layer.destroy(),this._resources.external.forEach(i=>{e.remove(i),i.type===Vt.Texture&&i.unload()})),this._resources.object.dispose(),this._resources.cameraHandle?.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncVisible(){this._resources!=null&&(this._resources.object.visible=this._visible)}};var wt=class extends si{constructor(e){super(e),this._isDraped=!1,this.object3dResources=new io(this.createObject3DResourceFactory(e.view)),this.drapedResources=new to(this.createDrapedResourceFactory(e.view)),this.isDraped=e.isDraped??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}};var ma=class extends lt{constructor(e,i){super(e,i,new nt(_p,()=>import("./chunk-MNF7LH2K.js")))}initializePipeline(e){switch(e.blitMode){case Et.None:case Et.Depth:return Ht({colorWrite:zt});case Et.Alpha:return Ht({blending:ql,colorWrite:zt});default:e.blitMode;case Et.PremultipliedAlpha:case Et.COUNT:return Ht({blending:Za,colorWrite:zt})}}};var ao=class{constructor(e,i=Et.None){this._techniques=e,this._parameters=new gp,this._configuration=new fp,this._configuration.blitMode=i,e.precompile(ma,this._configuration)}blit(e,i,a,r){e.bindFramebuffer(a.fbo),e.setClearColor(0,0,0,1),e.clear(za.COLOR),this._parameters.texture=i.getTexture();let o=this._techniques.get(ma,this._configuration);e.bindTechnique(o,r,this._parameters),e.screen.draw()}blend(e,i,a,r,o=1){this._configuration.hasOpacityFactor=o<1;let s=this._techniques.get(ma,this._configuration);return!!s.compiled&&(e.bindFramebuffer(a.fbo),this._parameters.texture=i.getTexture(),this._parameters.opacity=o,e.bindTechnique(s,r,this._parameters),e.screen.draw(),!0)}};var ro=class extends Ms{constructor(){super(...arguments),this.innerColor=G(1,1,1),this.innerWidth=1,this.glowColor=G(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=ne(6),this.pointDistanceOrigin=g(),this.pointDistanceTarget=g(),this.lineVerticalPlaneSegment=Gt(),this.intersectsLineSegment=Gt(),this.intersectsLineRadius=3,this.heightManifoldTarget=g(),this.lineStartWorld=g(),this.lineEndWorld=g()}},oo=class extends lt{constructor(e,i){super(e,i,new nt(bp,()=>import("./chunk-BO7MUJDS.js")))}};var so=class extends ro{constructor(){super(...arguments),this.origin=g()}},fa=class extends lt{constructor(e,i){super(e,i,new nt(yp,()=>import("./chunk-G7JJHYQI.js")),zs)}},zs=new Map([[x.START,0],[x.END,1],[x.EXTRUDE,2],[x.START_UP,3],[x.END_UP,4]]);var $a=class{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=g(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){let i=xi(3*e.length),a=0;for(let r of e)i[a++]=r[0],i[a++]=r[1],i[a++]=r[2];this.buffers=[i]}set buffers(e){if(this._buffers=e,this._buffers.length>0){let i=this._buffers[0],a=3*Math.floor(i.length/3/2);C(this._origin,i[a],i[a+1],i[a+2])}else C(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){let i=this._ensureVAO(e);i!=null&&(e.bindVAO(i),e.drawArrays(Il.TRIANGLES,0,this._count))}dispose(){this._vao!=null&&this._vao.dispose()}get _layout(){return this._renderCoordsHelper.viewingMode===Lt.Global?Ed:wd}_ensureVAO(e){return this._buffers==null?null:(this._vao??=this._createVAO(e,this._buffers),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,i){let a=this._createDataBuffer(i);return this._dirty=!1,new mc(e,zs,new Map([["data",hc(this._layout)]]),new Map([["data",uc.createVertex(e,Cl.STATIC_DRAW,a)]]))}_ensureVertexData(e,i){if(!this._dirty)return;let a=this._createDataBuffer(i);e.vertexBuffers.get("data")?.setData(a),this._dirty=!1}_createDataBuffer(e){let i=e.reduce((l,c)=>l+Ip(c),0);this._count=i;let a=this._layout.createBuffer(i),r=this._origin,o=0,s=0,n="startUp"in a?this._setUpVectors.bind(this,a):void 0;for(let l of e){for(let c=0;c<l.length;c+=3){let h=C(Cp,l[c],l[c+1],l[c+2]);c===0?s=this._renderCoordsHelper.getAltitude(h):this._renderCoordsHelper.setAltitude(h,s);let u=o+2*c;n?.(c,u,l,h);let m=A(Cp,h,r);if(c<l.length-3){for(let f=0;f<6;f++)a.start.setVec(u+f,m);a.extrude.setValues(u,0,-1),a.extrude.setValues(u+1,1,-1),a.extrude.setValues(u+2,1,1),a.extrude.setValues(u+3,0,-1),a.extrude.setValues(u+4,1,1),a.extrude.setValues(u+5,0,1)}if(c>0)for(let f=-6;f<0;f++)a.end.setVec(u+f,m)}o+=Ip(l)}return a.buffer}_setUpVectors(e,i,a,r,o){let s=this._renderCoordsHelper.worldUpAtPosition(o,Od);if(i<r.length-3)for(let n=0;n<6;n++)e.startUp.setVec(a+n,s);if(i>0)for(let n=-6;n<0;n++)e.endUp.setVec(a+n,s)}};function Ip(t){return 3*(2*(t.length/3-1))}var Od=g(),Cp=g(),Ed=Ua().vec3f(x.START).vec3f(x.END).vec2f(x.EXTRUDE).vec3f(x.START_UP).vec3f(x.END_UP),wd=Ua().vec3f(x.START).vec3f(x.END).vec2f(x.EXTRUDE);var kt=class extends Lr{constructor(){super(...arguments),this.contrastControlEnabled=!1,this.spherical=!1}};p([ae()],kt.prototype,"contrastControlEnabled",void 0),p([ae()],kt.prototype,"spherical",void 0);var ni=class extends kt{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1}};p([ae()],ni.prototype,"heightManifoldEnabled",void 0),p([ae()],ni.prototype,"pointDistanceEnabled",void 0),p([ae()],ni.prototype,"lineVerticalPlaneEnabled",void 0),p([ae()],ni.prototype,"intersectsLineEnabled",void 0);var li=class extends pc{constructor(t){super(t),this.produces=ws.LASERLINES,this.consumes={required:[ws.LASERLINES,"normals"]},this.requireGeometryDepth=!0,this._configuration=new ni,this._pathTechniqueConfiguration=new kt,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._passParameters=new so;let e=t.view._stage.renderView.techniques,i=new kt;i.contrastControlEnabled=t.contrastControlEnabled,e.precompile(fa,i)}initialize(){this._passParameters.renderCoordsHelper=this.view.renderCoordsHelper,this._pathTechniqueConfiguration.spherical=this.view.state.viewingMode===Lt.Global,this._pathTechniqueConfiguration.contrastControlEnabled=this.contrastControlEnabled,this._techniques.precompile(fa,this._pathTechniqueConfiguration),this._blit=new ao(this._techniques,Et.PremultipliedAlpha)}destroy(){this._pathVerticalPlaneData=Ln(this._pathVerticalPlaneData),this._blit=null}get _techniques(){return this.view._stage.renderView.techniques}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(t){this._heightManifoldEnabled!==t&&(this._heightManifoldEnabled=t,this.requestRender(ve.UPDATE))}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(t){z(this._passParameters.heightManifoldTarget,t),this.requestRender(ve.UPDATE)}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(t){t!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=t,this.requestRender(ve.UPDATE))}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(t){z(this._passParameters.pointDistanceTarget,t),this.requestRender(ve.UPDATE)}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(t){z(this._passParameters.pointDistanceOrigin,t),this.requestRender(ve.UPDATE)}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(t){t!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=t,this.requestRender(ve.UPDATE))}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){aa(t,this._passParameters.lineVerticalPlaneSegment),this.requestRender(ve.UPDATE)}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(t){t!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=t,this.requestRender(ve.UPDATE))}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(t){aa(t,this._passParameters.intersectsLineSegment),this.requestRender(ve.UPDATE)}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(t){t!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=t,this.requestRender(ve.UPDATE))}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(t){t!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=t,this._pathVerticalPlaneData!=null&&this.requestRender(ve.UPDATE))}set pathVerticalPlaneVertices(t){this._pathVerticalPlaneData==null&&(this._pathVerticalPlaneData=new $a(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=t,this.pathVerticalPlaneEnabled&&this.requestRender(ve.UPDATE)}set pathVerticalPlaneBuffers(t){this._pathVerticalPlaneData==null&&(this._pathVerticalPlaneData=new $a(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=t,this.pathVerticalPlaneEnabled&&this.requestRender(ve.UPDATE)}setParameters(t){Yl(this._passParameters,t)&&this.requestRender(ve.UPDATE)}precompile(){this._acquireTechnique()}render(t){let e=t.find(({name:s})=>s===this.produces);if(!this.bindParameters.decorations||this._blit==null)return e;let i=this.renderingContext,a=t.find(({name:s})=>s==="normals");this._passParameters.normals=a?.getTexture();let r=()=>{(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(),this.pathVerticalPlaneEnabled&&this._renderPath()};if(!this.contrastControlEnabled)return i.bindFramebuffer(e.fbo),r(),e;this._passParameters.colors=e.getTexture();let o=this.fboCache.acquire(e.fbo.width,e.fbo.height,"laser lines");return i.bindFramebuffer(o.fbo),i.setClearColor(0,0,0,0),i.clear(za.COLOR|za.DEPTH),r(),i.unbindTexture(e.getTexture()),this._blit.blend(i,o,e,this.bindParameters)||this.requestRender(ve.UPDATE),o.release(),e}_acquireTechnique(){return this._configuration.heightManifoldEnabled=this.heightManifoldEnabled,this._configuration.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._configuration.pointDistanceEnabled=this.pointDistanceEnabled,this._configuration.intersectsLineEnabled=this.intersectsLineEnabled,this._configuration.contrastControlEnabled=this.contrastControlEnabled,this._configuration.spherical=this.view.state.viewingMode===Lt.Global,this._techniques.get(oo,this._configuration)}_renderUnified(){if(!this._updatePassParameters())return;let t=this._acquireTechnique();if(t.compiled){let e=this.renderingContext;e.bindTechnique(t,this.bindParameters,this._passParameters),e.screen.draw()}else this.requestRender(ve.UPDATE)}_renderPath(){if(this._pathVerticalPlaneData==null)return;let t=this._techniques.get(fa,this._pathTechniqueConfiguration);if(t.compiled){let e=this.renderingContext;this._passParameters.origin=this._pathVerticalPlaneData.origin,e.bindTechnique(t,this.bindParameters,this._passParameters),this._pathVerticalPlaneData.draw(e)}else this.requestRender(ve.UPDATE)}_updatePassParameters(){if(!this._intersectsLineEnabled)return!0;let t=this.bindParameters.camera,e=this._passParameters;if(this._intersectsLineInfinite){if(zr(Fa(e.intersectsLineSegment.origin,e.intersectsLineSegment.vector),Ja),Ja.c0=-Number.MAX_VALUE,!kr(t.frustum,Ja))return!1;Hr(Ja,e.lineStartWorld),Fr(Ja,e.lineEndWorld)}else z(e.lineStartWorld,e.intersectsLineSegment.origin),j(e.lineEndWorld,e.intersectsLineSegment.origin,e.intersectsLineSegment.vector);return!0}get test(){}};p([d({constructOnly:!0})],li.prototype,"contrastControlEnabled",void 0),p([d({constructOnly:!0})],li.prototype,"isDecoration",void 0),p([d()],li.prototype,"produces",void 0),p([d()],li.prototype,"consumes",void 0),li=p([D("esri.views.3d.webgl-engine.effects.laserlines.LaserLineRenderer")],li);var Ja=Gr();var pt=class extends si{constructor(e){super(e),this._angleCutoff=vp,this._style={},this._heightManifoldTarget=g(),this._heightManifoldEnabled=!1,this._intersectsLine=Gt(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProperties(e)}get testData(){}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){e!=null?(z(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(e==null)return void(this.intersectsLine=null);let i=this.view.renderCoordsHelper.worldUpAtPosition(e,Td);this.intersectsLine=Nl(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){e!=null?(aa(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=e!=null?aa(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=e!=null?{origin:We(e.origin),target:e.target?We(e.target):null}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||this._pointDistanceLine!=null||this._pathVerticalPlaneBuffers!=null)?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){this._renderer==null&&(this._renderer=new li({view:this.view,contrastControlEnabled:!0,isDecoration:this.isDecoration}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff())}_syncStyle(){this._renderer!=null&&this._renderer.setParameters(this._style)}_syncAngleCutoff(){this._renderer?.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){this._renderer!=null&&(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){this._renderer!=null&&(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){this._renderer!=null&&(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){this._renderer!=null&&(this._renderer.pathVerticalPlaneEnabled=this._pathVerticalPlaneBuffers!=null&&this.visible,this._pathVerticalPlaneBuffers!=null&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){this._renderer!=null&&(this._renderer.lineVerticalPlaneEnabled=this._lineVerticalPlaneSegment!=null&&this.visible,this._lineVerticalPlaneSegment!=null&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){if(this._renderer==null)return;let e=this._pointDistanceLine,i=e!=null;this._renderer.pointDistanceEnabled=i&&e.target!=null&&this.visible,i&&(this._renderer.pointDistanceOrigin=e.origin,e.target!=null&&(this._renderer.pointDistanceTarget=e.target))}_disposeRenderer(){this._renderer!=null&&this.view._stage&&(this._renderer.destroy(),this._renderer=null)}},Td=g();var Tt=class extends wt{constructor(e){super(e),this._ray=Mt(),this._isWorldDown=!1,this._start=g(),this._end=G(1,0,0),this._width=1,this._color=se(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=se(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=je.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=O.OccludeAndTransparent,this._fadedExtensions=Gp,this._laserline=new pt({view:this.view,isDecoration:e.isDecoration}),this.applyProperties(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:i=>this._createObject3DResources(i),destroyResources:jp,recreateGeometry:(i,a)=>this._recreateObject3DGeometry(i,a),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:jp,recreateGeometry:i=>this._recreateDrapedGeometry(i)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,z(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),A(this._end,e,this._end),Er(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,jt(this._start,e)||(z(this._start,e),Er(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,jt(this._end,e)||(z(this._end,e),Er(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){xe(e,this._color)||(_e(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){xe(e,this._innerColor)||(_e(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){let i=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&xe(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?Mr(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===O.OccludeAndTransparentStencil?O.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??Gp,this.recreateGeometry()}_updateMaterial(){let{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){let i=new ce(this.materialParameters),a=new Array;return this._createObject3DGeometry(i,e,a),{material:i,geometries:a,forEach:r=>{r(i),a.forEach(r)}}}_recreateObject3DGeometry(e,i){e.geometries.length=0,this._createObject3DGeometry(e.material,i,e.geometries)}_createObject3DGeometry(e,i,a){let r=this._createGeometry(e);a.push(r),i.addGeometry(r),this._updateVerticesObject3D(i)}_createDrapedResources(){let e=new ce(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){let i=this._createGeometry(e);return this._updateVerticesDraped(i),new ri(i)}_createGeometry(e){let i=this.extensionType===je.FADED,a=i?[g(),g(),g(),g()]:[g(),g()];return Se(e,a,null,i?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{let e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){let i=this._lineSegment;this._updateVertexAttributesObject3D(e,i),this._laserline.intersectsLine=i}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===je.FADED?this._updateLineSegmentFinite(Lp):this._updateLineSegmentInfinite(this._extensionType,Lp)}_updateLineSegmentFinite(e){return ra(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){let a=this.view.state.camera;switch(zr(this._ray,ci),e){case je.LINE:ci.c0=-Number.MAX_VALUE;break;case je.RAY:case je.GROUND_RAY:{let s=this._ray.origin,n=this.view.elevationProvider.getElevation(s[0],s[1],s[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,l=this.view.renderCoordsHelper.getAltitude(s);this._isWorldDown&&l<n&&fl(ci.ray.direction,ci.ray.direction),this._extensionType===je.GROUND_RAY&&n!=null&&(ci.c1=Math.abs(l-n));break}}if(!kr(a.frustum,ci))return this._updateLineSegmentFinite(i);let r=Hr(ci,Zi),o=Fr(ci,xd);return ra(r,o,i)}_updateVertexAttributesObject3D(e,i){let a=e.geometries[0].getMutableAttribute(x.POSITION)?.data;if(!a)return;let r=0;for(let o of this._lineVertices(i))a[r++]=o[0],a[r++]=o[1],a[r++]=o[2];e.geometryVertexAttributeUpdated(e.geometries[0],x.POSITION)}_updateVertexAttributesDraped(e,i){let a=e.getMutableAttribute(x.POSITION)?.data;if(!a)return;let r=0;for(let o of this._lineVertices(i))a[r++]=o[0],a[r++]=o[1],a[r++]=Ni;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===je.FADED?(yield ji(e,-this.fadedExtensions.start,Zi),yield ji(e,0,Zi),yield ji(e,1,Zi),yield ji(e,1+this.fadedExtensions.end,Zi)):(yield ji(e,0,Zi),yield ji(e,1,Zi))}};function jp(t){t.geometries=[]}var ci=Gr(),Zi=g(),xd=g(),Lp=Gt(),je;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(je||(je={}));var Vp=1/3,Gp={start:Vp,end:Vp};var co=class extends wt{constructor(e){super(e),this._location=g(),this._direction=G(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=se(1,0,1,1),this._renderOccluded=O.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:i=>this._createObject3DResources(i),destroyResources:Ad,recreateGeometry:(i,a)=>this._recreateObject3DGeometry(i,a),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Dd,recreateGeometry:i=>this._recreateDrapedGeometry(i)}}get location(){return this._location}set location(e){jt(this._location,e)||(z(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){jt(this._direction,e)||(z(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){ie(this._direction,A(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){xe(e,this._color)||(_e(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){let i=new ce(this.materialParameters),a=new Array;return this._createObject3DGeometry(i,e,a),{material:i,geometries:a,forEach:r=>{r(i),a.forEach(r)}}}_recreateObject3DGeometry(e,i){e.geometries.length=0,this._createObject3DGeometry(e.material,i,e.geometries)}_createObject3DGeometry(e,i,a){let[r,o]=zp(e);i.addGeometry(r),i.addGeometry(o),a.push(r),a.push(o),this._updateVerticesObject3D(i)}_createDrapedResources(){let e=new ce(this.materialParameters),i=v(()=>this.view.state.contentPixelRatio,()=>this.drapedResources.recreateGeometry());return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:i}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){let i=zp(e);return this._updateVerticesDraped(i),i.map(a=>new ri(a))}_updateMaterial(){let{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{let e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){let i=this.view.state.camera;i.projectToScreen(this.location,lo),j(xt,this.location,this.direction),i.projectToScreen(xt,ga),ta(ga,Rl(ga,ga,lo)),this._updateVertexAttributesObject3D(i,e,0,lo,ga,1),this._updateVertexAttributesObject3D(i,e,1,lo,ga,-1)}_updateVertexAttributesObject3D(e,i,a,r,o,s){let n=i.geometries[a],l=n.getMutableAttribute(x.POSITION)?.data;if(!l)return;let{start:c,end:h}=Hp(o,r,s,this.offset,this.width,this.length);e.unprojectFromScreen(c,xt),l[0]=xt[0],l[1]=xt[1],l[2]=xt[2],e.unprojectFromScreen(h,xt),l[3]=xt[0],l[4]=xt[1],l[5]=xt[2],i.geometryVertexAttributeUpdated(n,x.POSITION)}_updateVerticesDraped(e){let{view:{basemapTerrain:{overlayManager:i},state:{contentPixelRatio:a}}}=this,{location:r,width:o,length:s,offset:n}=this,l=Pd;l.spatialReference=i.renderer.spatialReference,l.x=r[0],l.y=r[1];let c=this.view.overlayPixelSizeInMapUnits(l)*a,h=o*c,u=s*c,m=n*c;this._updateVertexAttributesDraped(e[0],h,u,m,-1),this._updateVertexAttributesDraped(e[1],h,u,m,1)}_updateVertexAttributesDraped(e,i,a,r,o){let s=e.getMutableAttribute(x.POSITION)?.data;if(!s)return;let{location:n,direction:l}=this,{start:c,end:h}=Hp(l,n,o,r,i,a);s[0]=c[0],s[1]=c[1],s[2]=Ni,s[3]=h[0],s[4]=h[1],s[5]=Ni,e.invalidateBoundingInfo()}};function zp(t){return[Se(t,[g(),g()]),Se(t,[g(),g()])]}function Hp(t,e,i,a,r,o){let s=Qt(Fp,Pi(Fp,t[1]*i,t[0]*-i),a+r/2),n=Ii(no,Ii(no,Ii(no,e,Qt(no,t,o/2)),s),s);return{start:n,end:Ii(kp,n,Qt(kp,t,-o))}}function Ad(t){t.geometries.length=0}function Dd(t){t.pixelRatioHandle.remove(),t.geometries=[]}var xt=g(),Fp=st(),no=st(),kp=st(),lo=ge(),ga=ge(),Pd=Ne(0,0,void 0,null);var pi=class extends si{constructor(e){super(e),this._resources=null,this._transform=re()}get object(){return this._resources!=null?this._resources.object:null}get transform(){return this._transform}set transform(e){_r(this._transform,e),this._resources!=null&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(this._resources==null)return;let e=this._resources.object,i=this.view._stage;i.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),e.visible=this.visible,i.addMany(e.geometries)}createResources(){this.destroyResources();let e=this.view._stage;if(!e)return;let i=new ha(e,{pickable:!1,updatePolicy:ai.SYNC}),a=new pa({castShadow:!1});a.transformation=this._transform,this.createExternalResources(),this.createGeometries(a),e.addMany(a.geometries),this.forEachExternalMaterial(r=>e.add(r)),e.add(a),i.add(a),a.visible=this.visible,this._resources={layer:i,object:a}}destroyResources(){let e=this.view._stage;this._resources!=null&&e&&(e.remove(this._resources.object),this._resources.layer.destroy(),this.forEachExternalMaterial(i=>{e.remove(i)}),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){this._resources!=null&&(this._resources.object.visible=e)}};var Bi=class extends pi{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=se(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=se(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){let i=this._preferredTextureSize;this._size=e,i<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){xe(e,this._color)||(_e(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){xe(e,this._outlineColor)||(_e(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material?.setParameters(this._materialParameters)}_updateSizeAttribute(){let e=this.object;if(e==null)return;let i=e.geometries[0];if(i==null)return;let a=i.getMutableAttribute(x.SIZE).data,r=this._geometrySize;a[0]=r,a[1]=r,e.geometryVertexAttributeUpdated(e.geometries[0],x.SIZE)}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:_c(this._primitive),distanceFieldBoundingBox:gc,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawAsLabel:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/fc}createExternalResources(){this._texture=vc(this._primitive,this._preferredTextureSize),this._material=new bc(this._materialParameters,this.view.state.viewingMode===Lt.Global);let e=this.view._stage;this._texture.load(e.renderView.renderingContext),e.add(this._texture)}destroyExternalResources(){this._texture&&(this.view._stage.remove(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){let i=this._createRenderGeometry();i!=null&&e.addGeometry(i)}forEachExternalMaterial(e){this._material&&e(this._material)}get _preferredTextureSize(){return wi(2*this._geometrySize,16,128)}calculateMapBounds(e){let i=this.object?.geometries[0];if(!i)return!1;let a=i.attributes.get(x.POSITION).data;return Xe(a,this.view.renderCoordsHelper.spatialReference,Np,this.view.spatialReference),gr(e,Np),!0}_createRenderGeometry(){let{geometry:e,_material:i}=this;if(e==null||i==null)return null;let{renderCoordsHelper:a,elevationProvider:r}=this.view,o=oi(e,r,Je.fromElevationInfo(this.elevationInfo),a),s=C(b.get(),e.x,e.y,o),n=b.get();Xe(s,e.spatialReference,n,a.spatialReference);let l=this._geometrySize;return Oc(i,{position:n,size:[l,l],centerOffsetAndDistance:[0,0,0,1]})}},Np=g();var po=class extends wt{constructor(e){super(e),this._maxSize=0,this._position=g(),this._up=g(),this._right=g(),this._renderOccluded=O.OccludeAndTransparent,this._color=se(1,0,0,1),this._outlineColor=se(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=O.Opaque,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:i=>this._createObject3DResources(i),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Id}}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){_e(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){_e(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){let i=this._outlineSize===0!=(e===0);this._outlineSize=e,i?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:i,next:a}){this._maxSize=Math.min(ss(i,e),ss(i,a))/3,ie(this._up,A(this._up,e,i)),ie(this._right,A(this._right,a,i)),z(this._position,i),this.recreateGeometry()}_createObject3DResources(e){let i=new Ee(this._quadMaterialParameters),a=this._outlineSize===0?void 0:new ce(this._outlineMaterialParameters);return this._createObject3DGeometries(e,i,a),{quadMaterial:i,outlineMaterial:a,forEach:r=>{r(i),a&&r(a)}}}_createObject3DGeometries(e,i,a){if(jt(this._up,ea)&&jt(this._right,ea))return;let r=this._createGeometries(i,a);for(let o of r)e.addGeometry(o);this._updateTransformObject3D(e)}_createDrapedResources(){let e=new Ee(this._quadMaterialParameters),i=this._outlineSize===0?void 0:new ce(this._outlineMaterialParameters),a=this._createGeometries(e,i).map(r=>new ri(r));return this._setTransformDraped(a),{quadMaterial:e,outlineMaterial:i,geometries:a,pixelRatioHandle:v(()=>this.view.state.contentPixelRatio,()=>this.drapedResources.recreateGeometry())}}_createGeometries(e,i){let{up:a,right:r,corner:o}=this._getVertices(),s=Cd(a,r,o,e);return i?[s,Se(i,[a,o,r])]:[s]}_getVertices(){let e=this._up,i=this._right,a=j(b.get(),e,i);return this.isDraped&&(e=z(b.get(),e),i=z(b.get(),i),e[2]=0,i[2]=0,a[2]=0),{up:e,right:i,corner:a}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(e=this.object3dResources.object){if(!e)return;let i=this.view.state.camera,a=this._size*i.computeScreenPixelSizeAt(this._position),r=Math.min(this._maxSize,a);Ai(hi,this._position),It(hi,hi,[r,r,r]),e.transformation=hi}_setTransformDraped(e){if(e.length===0)return;let{view:{basemapTerrain:{overlayManager:i},state:{contentPixelRatio:a}}}=this,{_position:r,_size:o}=this,s=z(b.get(),r);s[2]=Ni;let n=jd;n.spatialReference=i.renderer.spatialReference,n.x=s[0],n.y=s[1];let l=o*(this.view.overlayPixelSizeInMapUnits(n)*a),c=Math.min(this._maxSize,l);Ai(hi,s),It(hi,hi,[c,c,1]);for(let h of e)h.transformation=hi}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){this.object3dResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters),this.drapedResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){this.object3dResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters),this.drapedResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters)}};function Id(t){t.pixelRatioHandle.remove(),t.geometries=[]}function Cd(t,e,i,a){return new Rr(a,[[x.POSITION,new ka([0,0,0,...e,...t,...i],[0,1,2,1,2,3],3,!0)]])}var hi=re(),jd=Ne(0,0,void 0,null);var ht=class extends Vc{sortUniqueHints(e){return e.sort((i,a)=>(a instanceof Ds?a.length:0)-(i instanceof Ds?i.length:0))}visualizeIntersectionPoint(e,i){let{spatialReference:a,view:r}=i,o=Ka(i);return ye(new Bi({view:r,primitive:"circle",geometry:As(e.intersectionPoint,a),elevationInfo:e.isDraped?bs:Na,size:20,outlineSize:2,color:o.intersectionPointColor,outlineColor:o.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,i){let{view:a,spatialReference:r}=i,o=Ka(i),s=di(e.point,e.domain,i);return ye(new Bi({view:a,primitive:"circle",geometry:As(s,r),elevationInfo:ho(e),size:20,outlineSize:2,color:o.pointColor,outlineColor:o.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,i){let{view:a,spatialReference:r}=i,o=Ka(i),s=di(e.lineStart,e.domain,i),n=di(e.lineEnd,e.domain,i);return ye(Ld(e.type,s,n,r,ho(e),a,o,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){let{view:a,spatialReference:r}=i,o=Ka(i),{isDraped:s}=e,n=ho(e),l=di(e.lineStart,e.domain,i),c=di(e.lineEnd,e.domain,i),h=Wi(l,r,n,a,s),u=Wi(c,r,n,a,s),m=ot(u,h,u,.5),f=new co({view:a,attached:!1,offset:qe.parallelLineHintOffset,length:qe.parallelLineHintLength,width:qe.parallelLineHintWidth,color:o.parallelSignColor,location:m,renderOccluded:s?O.OccludeAndTransparent:O.Opaque,isDraped:s,renderGroup:ki.SnappingHint,isDecoration:!0});return f.setDirectionFromPoints(h,m),f.attached=!0,ye(f)}visualizeRightAngleQuad(e,i){let{view:a,spatialReference:r}=i,o=Ka(i),s=ho(e),{isDraped:n}=e,l=di(e.previousVertex,e.domain,i),c=di(e.centerVertex,e.domain,i),h=di(e.nextVertex,e.domain,i),u=Wi(l,r,s,a,n),m=Wi(c,r,s,a,n),f=Wi(h,r,s,a,n);return ye(new po({view:a,attached:!0,color:n?o.rightAngleColorDraped:o.rightAngleColor,renderOccluded:n?O.OccludeAndTransparent:O.Transparent,outlineRenderOccluded:n?O.OccludeAndTransparent:O.Opaque,outlineColor:o.rightAngleOutlineColor,outlineSize:qe.rightAngleHintOutlineSize,size:qe.rightAngleHintSize,isDraped:n,geometry:{previous:u,center:m,next:f},renderGroup:ki.SnappingHint,isDecoration:!0}))}};function Ka(t){let{effectiveTheme:e}=t.view,i=U.toUnitRGBA(e.accentColor),a=[0,0,0,0];return{intersectionPointColor:a,intersectionPointOutlineColor:i,pointColor:a,pointOutlineColor:i,lineColor:i,lineOutlineColor:void 0,parallelSignColor:i,rightAngleColor:i,rightAngleColorDraped:U.toUnitRGBA(Ye(e.accentColor,.5)),rightAngleOutlineColor:i}}function di(t,e,{selfSnappingZ:i,view:a,spatialReference:r}){return e&Lc.SELF&&Cc(t)&&i!=null?jc(t,i,a,r):t}function ho(t){return t.isDraped?bs:Na}function Ld(t,e,i,a,r,o,s,n=!1,l=!0,c=!0){let h=Wi(e,a,r,o,n),u=Wi(i,a,r,o,n),m=new Tt({view:o,extensionType:je.FADED,start:h,end:u,isDraped:n,color:s.lineColor,renderOccluded:n?O.OccludeAndTransparent:O.Opaque,renderGroup:ki.SnappingHint,isDecoration:!0});switch(t){case Qr.TARGET:m.width=qe.lineHintWidthTarget,m.fadedExtensions={start:0,end:qe.lineHintFadedExtensions};break;case Qr.REFERENCE_EXTENSION:m.width=qe.lineHintWidthReference,m.fadedExtensions={start:0,end:0};break;case Qr.REFERENCE:m.width=qe.lineHintWidthReference,m.fadedExtensions={start:l?qe.lineHintFadedExtensions:0,end:c?qe.lineHintFadedExtensions:0}}return m.attached=!0,m}function Wi(t,e,i,a,r){let o=g();if(r){let s=a.basemapTerrain.overlayManager.renderer.spatialReference;Xe(t,e,o,s)}else $r(t,e,i,a,o);return o}function _a(t){let e=t.graphic;return e?[v(()=>"visible"in t?t.visible:t.displaying,i=>{i&&e.notifyMeshTransformChanged({action:qa.EnableFastUpdates})},y({},Pe)),H(()=>e.notifyMeshTransformChanged({action:qa.DisableFastUpdates}))]:[]}var va=.3;function ya(t,e){e&&Object.assign(t,e)}var Hs=class{constructor(e){this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=O.Opaque,this.color=e.accent}},er=class{constructor(a){var r=a,{colors:e}=r,i=Ei(r,["colors"]);this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=e.accent,this.outlineColor=e.outline,this.renderOccluded=O.Opaque,this.hoverOutlineColor=e.selectedOutline,ya(this,i)}applyColor(e){this._apply(this.color,e)}applyOutline(e){this._apply(this.outlineColor,e)}applyHoverOutline(e){this._apply(this.hoverOutlineColor,e)}_apply(e,i){i.setParameters({color:te(e),renderOccluded:this.renderOccluded})}},Fs=class{constructor(a){var r=a,{colors:e}=r,i=Ei(r,["colors"]);this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.renderOccluded=O.Transparent,this.minSquaredEdgeLength=900,this.color=Ye(e.accent,.5),this.hoverColor=e.accent,ya(this,i)}applyColor(e){this._apply(this.color,e)}applyHover(e){this._apply(this.hoverColor,e)}_apply(e,i){i.setParameters({color:te(e),renderOccluded:this.renderOccluded})}},ks=class{constructor(e){this.vertex=new er({colors:e,color:e.accent,outlineColor:e.outline}),this.edge=new er({colors:e,color:ml(Ye(e.accent,2/3),.5),outlineColor:Ye(e.outline,.5),size:8,collisionPadding:8}),this.selected=new er({colors:e,color:e.selected,outlineColor:e.outline}),this.edgeOffset=new Fs({colors:e})}},tr=class{constructor(a){var r=a,{colors:e}=r,i=Ei(r,["colors"]);this.width=1.5,this.stipplePattern=Sp(3.3),this.falloff=0,this.innerWidth=1.5,this.renderOccluded=O.OccludeAndTransparent,this.color=e.selected,this.stippleOffColor=e.outline,this.innerColor=e.selected,ya(this,i)}apply(e){e.color=te(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=te(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=te(this.innerColor),e.renderOccluded=this.renderOccluded}},Ns=class{constructor(a){var r=a,{colors:e}=r,i=Ei(r,["colors"]);this.size=4,this.outlineSize=1,this.shape="square",this.color=e.selected,this.outlineColor=e.outline,ya(this,i)}apply(e){e.color=te(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=te(this.outlineColor),e.primitive=this.shape}},ba=class{constructor(a){var r=a,{colors:e}=r,i=Ei(r,["colors"]);this.innerWidth=1,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=va,this.globalAlphaContrastBoost=1.5,this.radius=3,this.innerColor=e.selected,this.glowColor=e.accent,this.heightFillColor=e.accent,ya(this,i)}apply(e,i=1){let a={glowColor:U.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:U.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i*this.glowColor.a,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=a:e.laserlineStyle=a}},Us=class{constructor(e){this.outline=new tr({colors:e,color:e.stippleOff,renderOccluded:O.OccludeAndTransparentStencil,stippleOffColor:e.stippleOn,innerWidth:0}),this.staged=new tr({colors:e,color:e.stippleOn,renderOccluded:O.OccludeAndTransparentStencil,innerColor:e.stagedSolid,stippleOffColor:e.stippleOff}),this.shadowStyle=new ba({colors:e,globalAlpha:va,glowColor:e.accent,glowFalloff:8,glowWidth:8,innerColor:e.selected,innerWidth:1})}},Zs=class{constructor(e){this.outline=new Ns({colors:e,color:e.selected,outlineColor:e.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new ba({colors:e,globalAlpha:va,glowColor:e.accent,glowFalloff:1.5,glowWidth:6,innerColor:e.selected,innerWidth:1,radius:2})}},Bs=class extends tr{constructor(a){var r=a,{colors:e}=r,i=Ei(r,["colors"]);super({colors:e}),this.extensionType=je.GROUND_RAY,ya(this,i)}},Ws=class{constructor(e){this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,this.lineObjects=new Us(e),this.pointObjects=new Zs(e),this.heightPlane=new ba({colors:e,globalAlpha:va,glowColor:e.accent,glowFalloff:8,glowWidth:8,innerColor:e.selected,innerWidth:1}),this.heightBox=new ba({colors:e,globalAlpha:va,glowColor:e.accent,glowFalloff:8,glowWidth:8,innerColor:e.selected,innerWidth:0,heightFillColor:e.accent}),this.zVerticalLine=new Bs({colors:e,color:Ye(e.accent,5*va/3),falloff:2,innerColor:Ye(e.selected,0),renderOccluded:O.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:je.GROUND_RAY})}},fe=class extends Te{constructor(t){super(t)}get colors(){let t=this.getTheme().accentColor,e=t.a;return{accent:t,contrast:qt(t),selected:U.fromArray([255,255,255,e]),selectedOutline:U.fromArray([255,255,255,e]),staged:U.fromArray([12,207,255,e]),stagedSolid:U.fromArray([12,207,255,1]),outline:U.fromArray([0,0,0,.5*e]),stippleOn:U.fromArray([255,255,255,1]),stippleOff:U.fromArray([0,0,0,.5])}}get visualElements(){return new Ws(this.colors)}get manipulators(){return new ks(this.colors)}get zManipulator(){return new Hs(this.colors)}};p([d()],fe.prototype,"colors",null),p([d()],fe.prototype,"visualElements",null),p([d()],fe.prototype,"manipulators",null),p([d()],fe.prototype,"zManipulator",null),p([d()],fe.prototype,"getTheme",void 0),fe=p([D("esri.views.3d.interactive.editingTools.settings")],fe);var Ve=class extends wt{constructor(e){super(e),this._attachmentOrigin=Ne(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new oe,this._geometry=null,this._width=1,this._color=se(1,0,1,1),this._innerWidth=0,this._innerColor=se(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=O.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=e.view.spatialReference,this._laserline=new pt({view:e.view,isDecoration:e.isDecoration}),this.applyProperties(e),this.attached=e.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:i=>this._createObject3DResources(i),destroyResources:Up,recreateGeometry:(i,a)=>{i.geometries.length=0,this._recreateGeometry(a,i.material,i.geometries)}}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Up,recreateGeometry:i=>{i.geometries=this._createRenderGeometriesDraped(i.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&this._laserlineStyle!=null&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(e){this._laserline.attached=this._laserlineAttached,e&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){xe(e,this._color)||(_e(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){xe(e,this._innerColor)||(_e(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){let i=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&xe(e,this._stippleOffColor)||(this._stippleOffColor=e?Mr(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;let e=this.object3dResources.resources?.geometries;if(!e||e.length===0)return null;C(Ma,0,0,0);let i=0;for(let a of e)a.computeAttachmentOrigin(Zp)&&(j(Ma,Ma,Zp),i++);return i===0?null:(B(Ma,Ma,1/i),this.view.renderCoordsHelper.fromRenderCoords(Ma,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){this.object3dResources.resources?.material.setParameters(this._materialParameters),this.drapedResources.resources?.material.setParameters(this._materialParameters)}get _isClosed(){return this.geometry!=null&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===O.OccludeAndTransparentStencil?O.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,i,a){this._createRenderGeometries(i,a);for(let r of a)e.addGeometry(r);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createObject3DResources(e){let i=new ce(this._materialParameters),a=new Array;return this._recreateGeometry(e,i,a),{material:i,geometries:a,forEach:r=>{r(i),a.forEach(r)}}}_createDrapedResources(){let e=new ce(this._materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){let{geometry:i,view:a}=this,r=a.basemapTerrain.spatialReference;return i==null||r==null?[]:Ep(i,r).lines.map(({position:o})=>{let s={overlayInfo:{spatialReference:r,renderCoordsHelper:a.renderCoordsHelper},attributeData:{position:o},removeDuplicateStartEnd:this._isClosed};return new ri(Jr(e,s))})}calculateMapBounds(e){if(this.object3dResources.resources==null)return!1;let i=this.view.renderCoordsHelper;for(let a of this.object3dResources.resources.geometries){let r=a.attributes.get(x.POSITION),o=xi(r.data.length);nl(r.data,i.spatialReference,0,o,this.view.spatialReference,0),gr(e,o)}return!0}_createRenderGeometries(e,i){let a=this.geometry;if(a==null)return;let r=Op(a,this.view.elevationProvider,this.view.renderCoordsHelper,Je.fromElevationInfo(this.elevationInfo??new yr({mode:Vl(a,null)}))),o=new Array;for(let{position:s,mapPositions:n}of r.lines){let l={mapPositions:n,attributeData:{position:s},removeDuplicateStartEnd:this._isClosed};i.push(Jr(e,l)),o.push(s)}this._laserline.pathVerticalPlane=o}};function Up(t){t.geometries=[]}var Zp=g(),Ma=g();function Bp(t,e,i,a,r){let o=xi(3*t.length),s=xi(o.length);t.forEach((c,h)=>{o[3*h]=c[0],o[3*h+1]=c[1],o[3*h+2]=c.length>2?c[2]:0});let n=Mp(o,e,0,s,0,o,0,o.length/3,i,a,r),l=n!=null;return{numVertices:t.length,position:o,mapPositions:s,projectionSuccess:l,sampledElevation:n}}var uo=class extends lt{constructor(e,i){super(e,i,new nt(wp,()=>import("./chunk-FYIIMITC.js")),Ys)}initializePipeline(e){let{oitPass:i,output:a,transparent:r,cullFace:o,shadingEnabled:s}=e,n=i===oa.NONE,l=i===oa.FrontFace;return Ht({blending:Ci(a)&&r?$l(i):null,culling:Ir(o),depthTest:{func:l?Ha.LESS:s?Ha.LEQUAL:Ha.LESS},depthWrite:Cr(e),drawBuffers:jr(i,a),colorWrite:zt,polygonOffset:n||l?null:Kl})}},Ys=new Map([[x.POSITION,0],[x.NORMAL,1],[x.OFFSET,2]]);var dt=class extends Vr{constructor(){super(...arguments),this.cullFace=Q.None,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=Ar.None,this.emissionSource=Dr.None,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}get discardInvisibleFragments(){return this.transparent}};p([ae({count:Q.COUNT})],dt.prototype,"cullFace",void 0),p([ae()],dt.prototype,"transparent",void 0),p([ae()],dt.prototype,"writeDepth",void 0),p([ae()],dt.prototype,"screenSizeEnabled",void 0),p([ae()],dt.prototype,"shadingEnabled",void 0),p([ae()],dt.prototype,"terrainDepthTest",void 0),p([ae()],dt.prototype,"cullAboveTerrain",void 0);var Yi=class extends Xl{constructor(e){super(e,qs),this._configuration=new dt,this.vertexAttributeLocations=Ys,this.supportsEdges=!0,this.produces=new Map([[St.OPAQUE_MATERIAL,i=>i===jl.Highlight||Tr(i)&&!this.parameters.transparent],[St.TRANSPARENT_MATERIAL,i=>Tr(i)&&this.parameters.transparent&&this.parameters.writeDepth],[St.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,i=>Tr(i)&&this.parameters.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,i){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.oitPass=i.oitPass,this._configuration.terrainDepthTest=i.terrainDepthTest&&Ci(e),this._configuration.cullAboveTerrain=i.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=cc}intersect(e,i,a,r,o,s){if(this.parameters.screenSizeEnabled){let n=e.attributes.get(x.OFFSET);Os(e,a,r,o,{applyToVertex:(c,h,u,m)=>{let f=C(Wp,n.data[3*m],n.data[3*m+1],n.data[3*m+2]),_=C(Vd,c,h,u);return B(f,f,this.parameters.screenSizeScale*a.camera.computeScreenPixelSizeAt(f)),j(_,_,f),[_[0],_[1],_[2]]},applyToAabb:c=>{let h=tl(c,Wp);return il(c,this.parameters.screenSizeScale*a.camera.computeScreenPixelSizeAt(h))}},s)}else Os(e,a,r,o,void 0,s)}createGLMaterial(e){return new Xs(e)}createBufferWriter(){return new Qs(this.parameters.screenSizeEnabled)}},Xs=class extends ys{beginSlot(e){return this.getTechnique(uo,e)}},qs=class extends Pr{constructor(){super(...arguments),this.color=se(1,1,1,1),this.shadingTint=se(0,0,0,.25),this.shadingDirection=ie(g(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=Q.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}get transparent(){return this.color[3]<1||this.forceTransparentMode}},Qs=class{constructor(e){this.screenSizeEnabled=e;let i=Ua().vec3f(x.POSITION).vec3f(x.NORMAL);this.screenSizeEnabled&&i.vec3f(x.OFFSET),this.vertexBufferLayout=i}elementCount(e){return e.get(x.POSITION).indices.length}write(e,i,a,r,o,s){if(rc(a,r,this.vertexBufferLayout,e,i,o,s),this.screenSizeEnabled){if(!a.has(x.OFFSET))throw new Error(`${x.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{let n=a.get(x.OFFSET);xr(n.size===3);let l=o.getField(x.OFFSET,Pl);if(!l)throw new Error("unable to acquire view for "+x.OFFSET);ac(n,i,l,s)}}}},Wp=g(),Vd=g();var ir=class extends pi{constructor(e){super(e),this.view=null,this._renderOccluded=O.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=as([1,127/255,0,1]),this._size=11,this._outlineColor=as([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){xe(e,this._color)||(_e(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){xe(e,this._outlineColor)||(_e(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){let e=this.vertices;if(e==null||e.length===0)return[];let i=.5,a=.5,r=Bp(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Je.fromElevationInfo(this.elevationInfo)),o=[],s=r.numVertices,n=r.position;for(let l=0;l<s;++l){let c=C(Gd,n[3*l],n[3*l+1],n[3*l+2]),h=Yp(this._vertexMaterial,i,c),u=Yp(this._vertexOutlineMaterial,a,c);o.push({vertexGeometry:h,vertexOutlineGeometry:u})}return o}createGeometries(e){let i=this._createRenderGeometries();for(let{vertexGeometry:a,vertexOutlineGeometry:r}of i)e.addGeometry(a),e.addGeometry(r)}createExternalResources(){this._vertexMaterial=new Yi(R(y({},this._vertexMaterialParameters),{writeDepth:!0,cullFace:Q.Back,screenSizeEnabled:!0})),this._vertexOutlineMaterial=new Yi(R(y({},this._vertexOutlineMaterialParameters),{forceTransparentMode:!0,writeDepth:!0,cullFace:Q.Front,screenSizeEnabled:!0,shadingEnabled:!1}))}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}},Gd=g();function Yp(t,e,i){return Vi(t,e,16,16,{offset:i})}var Xi=class extends qc{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new fe({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){let{mode:t,offset:e,unit:i}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new yr({mode:t,offset:e,unit:i})}normalizeCtorArgs(t){if(!t.elevationInfo){let e=t.hasZ??!0;return R(y({},t),{elevationInfo:Ll(e)})}return t}initializeGraphic(t){let{view:e}=this,i=this._createGraphicState=new Kr({graphic:t});return J([e.maskOccludee(t),e.trackGraphicState(i),v(()=>({element:this._outlineVisualElement,isDraped:i.isDraped}),({element:a,isDraped:r})=>{a&&(a.isDraped=r)},Pe),zn(()=>{Ya(this.tooltipInfos.mesh,this.geometryToPlace)}),this._setupLoadingIndicator(i),..._a(i)])}makeDrawOperation(){let{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new rp({view:this.view,manipulators:this.manipulators,geometryType:Qc(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new sp(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new op(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ht,segmentLabels:e?new ua:null,labelOptions:this.sketchOptions.labels,isDraped:this._createGraphicState?this._createGraphicState.isDraped:_s(this.hasZ,this.elevationInfo)==="on-the-ground",cursor:this.cursor,constraintsEnabled:!0})}onActiveVertexChanged(t){let{view:e}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[t],this._activeVertexVisualElement.recreate(),this._updateVerticalLineVisualElement(t),H();let i=this._settings,a=i.manipulators.vertex,r=new ir({view:e,spatialReference:e.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=r;let o=i.visualElements.zVerticalLine,s=new Tt({view:e,extensionType:o.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:O.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=s;let n=J([v(()=>i.visualElements.zVerticalLine,l=>l.apply(s),L),v(()=>({selectedColor:te(i.colors.selected),outlineColor:te(i.manipulators.vertex.outlineColor)}),({selectedColor:l,outlineColor:c})=>{r.color=l,r.outlineColor=c},L),H(()=>{this._activeVertexVisualElement=N(this._activeVertexVisualElement),this._verticalLineVisualElement=N(this._verticalLineVisualElement)})]);return r.attached=!0,this._updateVerticalLineVisualElement(t),n}_updateVerticalLineVisualElement(t){let e=this._verticalLineVisualElement;if(!e)return;let{renderCoordsHelper:i,elevationProvider:a}=this.view;C(Sa,t[0],t[1],t[2]),Xp.setFromElevationInfo(this.elevationInfo),Sa[2]=oi(Sa,a,Xp,i),i.toRenderCoords(Sa,this.view.spatialReference,Sa)?(e.setStartEndFromWorldDownAtLocation(Sa),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=t,H();let e=this.internalGraphicsLayer.elevationInfo,{view:i}=this,a=this._settings,r=new Ve({view:i,geometry:t,elevationInfo:e,isDraped:this._createGraphicState?this._createGraphicState.isDraped:_s(this.hasZ,e)==="on-the-ground",attached:!1,isDecoration:!0});this._outlineVisualElement=r;let o=J([v(()=>a.visualElements.lineObjects.outline,s=>s.apply(r),L),v(()=>a.visualElements.lineObjects.shadowStyle,s=>s.apply(r),L),H(()=>{this._outlineVisualElement=N(this._outlineVisualElement)})]);return r.attached=!0,r.laserlineEnabled=!0,o}onRegularVerticesChanged(t){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=t,H();let{view:e}=this,i=this._settings,a=i.manipulators.vertex,r=new ir({view:e,spatialReference:e.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0}),o=J([v(()=>({color:te(i.manipulators.vertex.color),outlineColor:te(i.manipulators.vertex.outlineColor)}),({color:s,outlineColor:n})=>{r.color=s,r.outlineColor=n},L),H(()=>{this._verticesVisualElement=N(this._verticesVisualElement)})]);return r.attached=!0,this._verticesVisualElement=r,o}updateGraphicGeometry(t){if(this.geometryType!=="mesh"||t?.type!=="point")super.updateGraphicGeometry(t);else{let e=this.geometryToPlace;e?.centerAt(t),Ya(this.tooltipInfos.mesh,e);let i=this._graphic;e&&i.geometry===e||(i.geometry=e)}}_setupLoadingIndicator(t){let{drawOperation:e}=this;if(!this.geometryToPlace)return e.loading=!1,null;e.loading=!0;let i=H(()=>{e.loading=!1}),a,r=()=>a&&cancelAnimationFrame(a);return J([it(()=>t.displaying,()=>{r(),a=requestAnimationFrame(()=>i.remove())},R(y({},Pe),{once:!0})),H(r),i])}};p([d({constructOnly:!0})],Xi.prototype,"elevationInfo",void 0),p([d({constructOnly:!0})],Xi.prototype,"geometryType",void 0),p([d()],Xi.prototype,"type",void 0),p([d({constructOnly:!0})],Xi.prototype,"view",void 0),Xi=p([D("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Xi);var Xp=new Je,Sa=g();function qp(t){let e=ar(t);return El(Math.cos(e),Math.sin(e))}function ar(t){if(t==null||t.type!=="polyline"&&t.type!=="polygon")return 0;let e=t.type==="polyline"?t.paths:t.rings,i=cl();for(let a of e)for(let r=0;r<a.length-1;r++){let o=a[r],s=a[r+1],n=o[0]-s[0],l=o[1]-s[1];if(n*n+l*l>i)return Math.atan2(s[1]-o[1],s[0]-o[0])}return 0}function Z(t){return t?.operations?.data.geometry}function ut(t,e){return zd(t?.data.coordinateHelper.hasZ(),e)}function zd(t,e){return!!t&&e.mode!=="on-the-ground"&&!zl(e)}function mo(t,e,i){function a(){let n=i(),l=n.sketchOptions.tooltips.effectiveEnabled?n.activeTooltipInfo:null;return R(y({},n),{activeTooltipInfo:l})}let r=!1;function o(n){r||(r=!0,n(),r=!1)}function s({activeTooltipInfo:n,sketchOptions:l,scaleRotateTransform:c}){o(()=>{n&&(n.sketchOptions=l,$s(n,e),Hd(n,c)),t.info=n})}return J([v(a,s,Pe),v(()=>{let n=a(),{activeTooltipInfo:l}=n;if(l)return{context:n,activeTooltipInfo:l,key:l.key,geometry:Z(e)}},(n,l)=>{n&&l&&l.key!==n.key&&o(()=>Qp(e,n.context))},at),e.on("committed",()=>{queueMicrotask(()=>s(a()))}),Br(t,{onBeforePaste:()=>{r=!0},onAfterPaste:()=>{Qp(e,a()),r=!1}})])}function Qp(t,{activeTooltipInfo:e,callbacks:i}){if(!e)return;i.onBeforeUpdate();let a=Z(t);switch(a?.type){case"mesh":rr(e,a.origin,t,i),"orientation"in e&&"scale"in e&&Ya(e,a,i);break;case"point":rr(e,a,t,i)}}function rr(t,e,i,a){let{dx:r,dy:o,dz:s}=Zr(t,e);r===0&&o===0&&s===0||(a.onMoveStart(),i.operations?.move(r,o,s,Oe.NEW_STEP),a.onMove(r,o,s),a.onMoveStop())}function $s(t,e){let i=Z(e),a=i?.type;if(!t||!i||a!=="mesh"&&a!=="point")return;let r=a==="mesh",o=r?i.origin:i;t.setLocationFromPoint(o),Js(t,o,e),t.type==="transform-mesh"&&r&&kc(t,i),t.clearInputValues()}function Js(t,e,i){t.elevation.actual=Yc(e),t.elevation.visible=!!i.operations?.data.coordinateHelper.hasZ(),t.elevation.readOnly=!1,t.elevation.showAsZ=!0}function Hd(t,e){if(t?.type!=="transform-point")return;if(!e)return t.orientation.actual=void 0,t.size.actual=void 0,t.orientation.visible=!1,void(t.size.visible=!1);let i=e.mode,{size:a,orientationClockwise:r}=e.adapter,{visualVariables:o}=t.sketchOptions.tooltips,s=o?.rotation,n=r!=null&&(i==null||i==="rotate"),l=s?.rotationType??"geographic";t.orientation.actual=n?xc(r,"radians",l):void 0,t.orientation.precision=$p(s?.valueType),t.orientation.visible=n;let c=o?.size,h=a!=null&&(i==null||i==="scale");t.size.actual=h?Tc(a,c?.unit??"meters"):void 0,t.size.precision=$p(c?.valueType),t.size.visible=h}function $p(t){switch(t){case"integer":case"long":return 0;default:return null}}function fo(t,e,i=Mt()){return ui(t,Ti(e),i),ie(i.direction,i.direction),i}function ui(t,e,i){return Jp(t,t.screenToRender(e,b.get()),i)}function Jp(t,e,i){let a=ms(b.get(),e);if(a[2]=0,!t.unprojectFromRenderScreen(a,i.origin))return null;let r=ms(b.get(),e);r[2]=1;let o=t.unprojectFromRenderScreen(r,b.get());return o==null?null:(A(i.direction,o,i.origin),i)}var W=class{constructor(e){this.metadata=void 0,this._camera=new dc,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=re(),this._worldFrame=null,this._renderLocation=g(),this._renderLocationDirty=!0,this._location=new Ie({x:0,y:0,z:0}),this._elevationAlignedLocation=new Ie,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=le.None,this._focused=!1,this.events=new oe.EventEmitter,this._screenLocation={screenPointArray:ge(),renderScreenPointArray:ja(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);let i=this.view.state?.camera;i&&this._camera.copyFrom(i)}destroy(){this._applyObjectTransform=Bd,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){return this.view?._stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),H(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){Kp(e)&&(this._screenLocationDirty=!0),_r(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=re()),kd(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){xs(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){xs(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){let e=this._elevation.override!=null?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=Mc(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,i){i?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(Kp(this._modelTransform)){let i=this._calculateModelTransformOffset(Zd);e=j(i,i,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,i){if(!this.available)return null;let a=Ti(e,Nd),r=this._getCollisionRadius(i),o=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Or(this.screenLocation.screenPointArray,a)<r*r)return this.screenLocation.renderScreenPointArray[2]+o;break;case"line":{let s=this.collisionType.paths,n=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(n,go),c=r*this.screenLocation.pixelSize,h=ui(this._camera,a,Ks);if(h==null)return null;for(let u of s){if(u.length===0)continue;let m=Ct(or,u[0],l);for(let f=1;f<u.length;f++){let _=Ct(ih,u[f],l),S=Zl(ra(m,_,eh),h);if(S!=null&&S<c*c){let w=j(b.get(),m,_);B(w,w,.5);let M=b.get();return this._camera.projectToRenderScreen(w,M),M[2]+o}z(m,_)}}break}case"disc":{let s=this.collisionType.direction,n=this.collisionType.offset??ea,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,go),h=r*this.screenLocation.pixelSize,u=ui(this._camera,a,Ks);if(u==null)return null;let m=us(th,c),f=ls(rh,s,m),_=Ct(oh,n,c);ke(_,f,_o);let S=ah;if(yt(_o,u,S)&&Sr(S,_)<h*h)return this.screenLocation.renderScreenPointArray[2]+o;break}case"ribbon":{let{paths:s,direction:n}=this.collisionType,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,go),h=r*this._camera.computeScreenPixelSizeAt(this.renderLocation),u=ui(this._camera,a,Ks);if(u==null)return null;let m=us(th,c),f=ls(rh,n,m),_=this._calculateModelTransformPosition(oh);ke(_,f,_o);let S=ah;if(!yt(_o,u,S))break;for(let w of s){if(w.length===0)continue;let M=Ct(or,w[0],c);for(let P=1;P<w.length;P++){let X=Ct(ih,w[P],c),$=Ul(ra(M,X,eh),S);if($!=null&&$<h*h){let k=j(b.get(),M,X);B(k,k,.5);let be=b.get();return this._camera.projectToRenderScreen(k,be),be[2]+o}z(M,X)}}break}default:this.collisionType}return null}attach(e={manipulator3D:{}}){let i=this._stage;if(!i)return;let a=e.manipulator3D;a.engineLayerId==null?(this._engineLayer=new ha(i,{pickable:!1,updatePolicy:ai.SYNC}),a.engineLayerId=this._engineLayer.id):i?.getObject&&(this._engineLayer=i.getObject(a.engineLayerId)),a.engineLayerReferences=(a.engineLayerReferences||0)+1,this._materialIdReferences=a.materialIdReferences,this._materialIdReferences==null&&(this._materialIdReferences=new Map,a.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),ll(this._location.spatialReference,this.view.spatialReference)||(this.location=new Ie({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){let i=e.manipulator3D;i.engineLayerReferences--;let a=i.engineLayerReferences===0;this._removeResourcesFromStage(),a&&(i.engineLayerId=null,N(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){Ri(this.location,sh,e.spatialReference)&&Jn(e.extent,sh)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(this.elevationInfo==null)return;let e=null,i=0,a=Hl(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":e=Xa(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":i=(Xa(this.view.elevationProvider,this.location,"ground")??0)+a;break;case"relative-to-scene":i=(Xa(this.view.elevationProvider,this.location,"scene")??0)+a;break;case"absolute-height":i=a}return i!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=i,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();let e=this._getWorldToScreenObjectScale(),i=go;if(this.autoScaleRenderObjects===!0){let s=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(s,i)}else this._calculateObjectTransform(e,i);let{objectsByState:a}=this._ensureEngineResources(),r=(this.focused?E.Focused:E.Unfocused)|(this.selected?E.Selected:E.Unselected),o=this._noDisplayCount>0;for(let{stateMask:s,objects:n}of a){if(o){for(let m of n)m.visible=!1;continue}let l=(s&E.All)!==E.None,c=(s&le.All)!==le.None,h=!l||(r&s)==(s&E.All),u=!c||(this.state&s)==(s&le.All);if(h&&u)for(let m of n)m.visible=!0,m.transformation=i;else for(let m of n)m.visible=!1}}_ensureEngineResources(){if(this._engineResources==null){let e=this._engineLayer,i=[],a=new Set;this.renderObjects.forEach(({geometry:{material:s}})=>{a.has(s)||(i.push(s),a.add(s))});let r=new Map;this._renderObjects.forEach(s=>{let n=new pa({castShadow:!1,geometries:[s.geometry]}),l=r.get(s.stateMask)||[];l.push(n),r.set(s.stateMask,l)});let o=[];r.forEach((s,n)=>o.push({stateMask:n,objects:s})),this._engineResources={objectsByState:o,layer:e,materials:i}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){let e=this._stage;if(this._engineResourcesAddedToStage||this._engineResources==null||!e)return;let{objectsByState:i,layer:a,materials:r}=this._engineResources;r.forEach(o=>{let s=this._materialIdReferences,n=s.get(o.id)||0;n===0&&e.add(o),s.set(o.id,n+1)}),i.forEach(({objects:o})=>{a.addMany(o),e.addMany(o)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){let e=this._stage;if(!this._engineResourcesAddedToStage||this._engineResources==null||!e)return;let{objectsByState:i,layer:a,materials:r}=this._engineResources;i.forEach(({objects:o})=>{a.removeMany(o),e.removeMany(o)}),r.forEach(o=>{let s=this._materialIdReferences,n=s.get(o.id);n===1?(e.remove(o),s.delete(o.id)):s.set(o.id,n-1)}),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,i){return e*(i?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){let i=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(i,Ud);return C(e,a[12],a[13],a[14])}_calculateModelTransformOffset(e){let i=this._calculateModelTransformPosition(e);return A(e,i,this.renderLocation)}_calculateObjectTransform(e,i){return pl(i,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Le(i,i,this._worldFrame),Le(i,i,this._modelTransform),i[12]+=this.renderLocation[0],i[13]+=this.renderLocation[1],i[14]+=this.renderLocation[2],i[15]=1,this._applyObjectTransform!=null&&this._applyObjectTransform(i),i}get test(){}};function Kp(t){return t[12]!==0||t[13]!==0||t[14]!==0}function kd(t,e,i){switch(t.viewingMode){case"local":return La(i),!0;case"global":{let a=Wn(t.renderCoordsHelper.spatialReference);return sl(e,0,or,0,a.radius),xl(ne(or[0]),ne(or[1]),i),!0}}}var Nd=ge(),eh=Gt(),Ks=Mt(),th=Ml(),Ud=re(),go=re(),_o=bt(),or=g(),ih=g(),ah=g(),rh=g(),oh=g(),Zd=g(),sh=new Ie({x:0,y:0,z:0,spatialReference:null}),Bd=()=>{};var Ge;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(Ge||(Ge={}));var I;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(I||(I={}));var Oa=class{constructor(){this.grabbingState=Ge.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=Ge.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,a)=>{if(a===I.TRANSLATE_Z&&(this.zManipulator=i),i instanceof W&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),this.firstGrabbedXY==null&&i.grabbing&&a===I.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=Ge.ANY,a){case I.TRANSLATE_Z:this.grabbingState|=Ge.Z;break;case I.TRANSLATE_XY:this.grabbingState|=Ge.XY}})}};function nh(t){let{object:e}=t,i=Wd(t),a=[i,Yd(t,i.visualElement)];return e.maskOccludee&&a.push(e.maskOccludee()),{visualElement:i.visualElement,remove:()=>Ca(a)}}function Wd(t){let{view:e,object:i}=t,a=Z(i),r=new Ve({view:e,geometry:en(a)?a:null,elevationInfo:i.elevationInfo,attached:!1,isDecoration:!0}),o=new fe({getTheme:()=>e.effectiveTheme}),s=()=>{r.attached=i.visible},n=J([v(()=>o.visualElements.lineObjects.outline,l=>l.apply(r),L),v(()=>o.visualElements.lineObjects.shadowStyle,l=>l.apply(r),L),v(()=>i.visible,s),v(()=>i.isDraped,l=>{r.isDraped=l},L),i.on("committed",()=>{let l=Z(i);r.geometry=en(l)?l:null}),ye(r)]);return s(),{visualElement:r,remove:()=>n.remove()}}function Yd(t,e){let{object:i,view:a}=t,r=[],o=i.elevationInfo,s=o.mode==="on-the-ground"||!o.offset&&o.mode!=="absolute-height",n=new Oa,l=new fe({getTheme:()=>a.effectiveTheme}),c=l.visualElements,h=new Tt({view:a,extensionType:c.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:O.OccludeAndTransparent,isDecoration:!0}),u=ne(c.heightPlaneAngleCutoff),m=new pt({view:a,attached:!1,angleCutoff:u,isDecoration:!0}),f=Ki(1);r.push(v(()=>({lineShadowStyle:l.visualElements.lineObjects.shadowStyle,pointShadowStyle:l.visualElements.pointObjects.shadowStyle,alpha:f.value}),({lineShadowStyle:P,pointShadowStyle:X,alpha:$})=>{P.apply(e,$),X.apply(h,$)},L));let _=Ki(1);r.push(v(()=>({heightPlane:l.visualElements.heightPlane,alpha:_.value}),({heightPlane:P,alpha:X})=>P.apply(m,X),L));let S=()=>{n.update(t);let P=Z(i);if(!i.visible||s&&(i.isDraped||!en(P)||!P.hasZ))return e.laserlineEnabled=!1,h.attached=!1,void(m.attached=!1);e.laserlineEnabled=!0;let X=n.grabbingState&Ge.XY?c.laserlineAlphaMultiplier:1;f.value=X;let $=n.grabbingState&Ge.Z?c.laserlineAlphaMultiplier:1;_.value=$,Xd(h,n),qd(t,e,m,n)};r.push(v(()=>l.visualElements.zVerticalLine,P=>P.apply(h),L)),r.push(i.on("committed",S),v(()=>i.visible,S),e.events.on("attachment-origin-changed",S),ye(h),ye(m));let w=[],M=()=>{Ca(w),w.length=0,t.forEachManipulator(P=>w.push(P.events.on("grab-changed",S))),t.forEachManipulator(P=>w.push(P.events.on("select-changed",S))),S()};return M(),r.push(t.onManipulatorsChanged(M),mr(()=>J(w))),J(r)}function Xd(t,e){let i=e.numSelected===1?e.firstSelected:e.numSelected>1&&e.firstGrabbedXY!=null?e.firstGrabbedXY:null;i!=null?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function qd(t,e,i,a){if(a.numSelected>0){C(qi,0,0,0);let r=0;t.forEachManipulator((o,s)=>{s===I.TRANSLATE_XY&&o.selected&&o instanceof W&&(j(qi,qi,o.renderLocation),r++)}),r>0?(i.heightManifoldTarget=B(qi,qi,1/r),i.attached=!0):i.attached=!1}else{let r=e.attachmentOrigin;r!=null&&t.view.renderCoordsHelper.toRenderCoords(r,qi)?(i.heightManifoldTarget=qi,i.attached=!0):i.attached=!1}}function en(t){return t!=null&&(t.type==="polygon"||t.type==="polyline")}var qi=g();function lh(t){let e=[],i=$d(t,e);return Qd(t,e,i),{visualElement:i,remove:()=>Ca(e)}}function Qd(t,e,i){let{view:a,object:r}=t,o=new fe({getTheme:()=>a.effectiveTheme}),s=new Tt({view:a,extensionType:o.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:O.OccludeAndTransparent,isDecoration:!0});e.push(v(()=>o.visualElements.zVerticalLine,M=>M.apply(s),L));let n=new pt({view:a,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),l=ne(o.visualElements.heightPlaneAngleCutoff),c=new pt({view:a,attached:!1,angleCutoff:l,isDecoration:!0}),h=r.elevationInfo,u=Je.fromElevationInfo(h),m=h.mode==="on-the-ground"||!h.offset&&h.mode!=="absolute-height",f=new Oa,_=Ki(1);e.push(v(()=>({heightPlane:o.visualElements.heightPlane,alpha:_.value}),({heightPlane:M,alpha:P})=>M.apply(c,P),L));let S=Ki(1);e.push(v(()=>({shadowStyle:o.visualElements.pointObjects.shadowStyle,alpha:S.value}),({shadowStyle:M,alpha:P})=>M.apply(n,P),L));let w=()=>{f.update(t);let M=tn(Z(r)),P=m&&(r.isDraped||M==null||!M.hasZ),X=!0;if(P||M==null)X=!1;else{vs(r.elevationInfo)&&(M=M.clone(),M.z=0);let ue=oi(M,a.elevationProvider,u,a.renderCoordsHelper);C(mt,M.x,M.y,ue),Xe(mt,M.spatialReference,mt,a.renderCoordsHelper.spatialReference),s.setStartEndFromWorldDownAtLocation(mt),n.intersectsWorldUpAtLocation=mt}let $=f.grabbingState&Ge.Z?o.visualElements.laserlineAlphaMultiplier:1;_.value=$;let k=rl(tu);!P&&r.visible&&i.calculateMapBounds(k)&&Xe(al(k,mt),a.spatialReference,mt,a.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=mt,c.attached=!0):c.attached=!1;let be=f.grabbingState&Ge.XY?o.visualElements.laserlineAlphaMultiplier:1;S.value=be;let V=X&&r.visible&&!P;n.attached=V,s.attached=V};e.push(v(()=>[r.visible,r.isDraped],w),r.on("committed",w)),t.forEachManipulator(M=>{e.push(M.events.on("grab-changed",w))}),e.push(ye(n)),e.push(ye(s)),e.push(ye(c)),w()}function $d(t,e){let{view:i,object:a}=t,r=new Bi({view:i,geometry:tn(Z(a)),elevationInfo:a.elevationInfo,isDecoration:!0});return Jd(t,r,e),e.push(ye(r)),r}function tn(t){return t==null?null:t.type==="point"?t:t.type==="mesh"?t.origin.clone():null}function Jd(t,e,i){let{view:a,object:r}=t,o=()=>{e.attached=r.visible},s=new fe({getTheme:()=>a.effectiveTheme});Kd(t,e,i),s.visualElements.pointObjects.outline.apply(e),i.push(v(()=>r.visible,o,L))}function Kd(t,e,i){let{view:a,object:r}=t,o=null,s=l=>{o!=null&&(o.remove(),o=null),r.isDraped&&l!=null&&(o=eu(a,l,()=>{e.geometry=l}))},n=()=>{let l=tn(Z(r));l!=null&&vs(r.elevationInfo)&&(l.z=0),s(l),e.geometry=l};i.push(r.on("committed",n),mr(()=>o)),n()}function eu(t,e,i){let a=t.elevationProvider.spatialReference;Tl(e,mt,a);let r=mt[0],o=mt[1];return t.elevationProvider.on("elevation-change",s=>{fr(s.extent,r,o)&&i()})}var mt=g(),tu=el();function mi(t){switch(Z(t.object)?.type){case"point":case"mesh":return lh(t);case"polygon":case"polyline":return nh(t);default:return null}}var vo=Math.ceil(46.666666666666664),fi=160,bo=.5,yo=24,Qi=9,ch=fi+30,an=fi+53,ph=60,hh=23,dh=5*Math.PI/12,uh=1*Math.PI/3,rn=10,on=.2,sn=30,nn=53,mh=.2,fh=.3,gh=200,_h=3,vh=1e6;var Ke=class{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}set renderLocation(e){this._forEachManipulator3D(i=>i.renderLocation=e)}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}get selected(){return this.someManipulator(e=>e.selected)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(a=>{!i&&e(a)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,a)=>{i instanceof W&&e(i,a)})}};var Mo=class extends Ke{constructor(){super(...arguments),this._interactive=!0}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e),this._updateManipulatorInteractivity()}_updateManipulatorInteractivity(){let e=!this.grabbing&&this._interactive;this.forEachManipulator(i=>{i.interactive=e||i.grabbing})}};var T=class{constructor(e,i=E.None){this.geometry=e,this.stateMask=i}};function $i(t,e){return Sh(t,()=>e)}function Mh(t){return Sh(t,e=>e.plane)}function Sh(t,e){let i=g(),a=g(),r=!1;return o=>{let s=e(o);if(o.action==="start"){let c=Ti(o.screenStart,hs.get()),h=ui(t.state.camera,c,yh);h!=null&&(r=yt(s,h,i))}if(!r)return null;let n=Ti(o.screenEnd,hs.get()),l=ui(t.state.camera,n,yh);return l==null?null:yt(s,l,a)?R(y({},o),{renderStart:i,renderEnd:a,plane:s,ray:l}):null}}function iu(t,e,i=0,a=null,r=null){let o=null;return s=>{if(s.action==="start"&&(o=t.sceneIntersectionHelper.intersectElevationFromScreen(ge(s.screenStart.x,s.screenStart.y),e,i,r),o!=null&&a!=null&&!Ri(o,o,a))||o==null)return null;let n=t.sceneIntersectionHelper.intersectElevationFromScreen(ge(s.screenEnd.x,s.screenEnd.y),e,i,r);return n!=null&&(a==null||Ri(n,n,a))?R(y({},s),{mapStart:o,mapEnd:n}):null}}function gi(t,e,i,a=null,r=null){return iu(t,i,ia(e,t,i),a,r)}function Oh(t,e,i,a){let r=i.toMap(t.screenStart);return r!=null?gi(e,r,i.elevationInfo,a):null}function au(t,e){let i=ou,a=su,r=bt();t.renderCoordsHelper.worldUpAtPosition(e,i);let o=me(r,i,A(a,e,t.state.camera.eye));return me(o,o,i),ke(e,o,r)}function So(t,e,i){let a=null,r=new ii;return r.next($i(t,au(t,e))).next(ru(t,e)).next(cn(t,i)).next(o=>{o.mapEnd.x=o.mapStart.x,o.mapEnd.y=o.mapStart.y,a=o}),o=>(a=null,r.execute(o),a)}function ru(t,e){let i=g(),a=Ce(e);t.renderCoordsHelper.worldUpAtPosition(e,i);let r=g(),o=g(),s=n=>(A(n,n,e),Ol(i,n,n),t.viewingMode==="global"&&Ce(n)*Math.sign(Me(i,n))<.001-a&&A(n,B(n,i,.001),e),j(n,n,e),n);return n=>(n.renderStart=s(z(r,n.renderStart)),n.renderEnd=s(z(o,n.renderEnd)),n)}function cn(t,e){let i=t.renderCoordsHelper;return a=>{let r=i.fromRenderCoords(a.renderStart,new Ie({spatialReference:e})),o=i.fromRenderCoords(a.renderEnd,new Ie({spatialReference:e}));return r!=null&&o!=null?R(y({},a),{mapStart:r,mapEnd:o}):null}}var bh;(function(t){t[t.GROUND=0]="GROUND",t[t.OTHER=1]="OTHER"})(bh||(bh={}));var g0=st(),ou=g(),su=g(),yh=Mt();function _i(t,e,i){let a=(r,o)=>{e({action:r,object:t,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY})};return i((r,o,s)=>(o.next(n=>(n.action==="start"&&a("start",n),n)).next(Kc(t)).next(n=>{switch(n.action){case"start":case"update":(n.translationX||n.translationY||n.translationZ)&&a("update",n);break;case"end":a("end",n)}return n}),{steps:o,cancel:s=s.next(tp(t)).next(n=>(a("end",{screenDeltaX:0,screenDeltaY:0}),n))}))}function Oo(t){if(t?.axis==null)return 1;let{mapStart:e,mapEnd:i,axis:a}=t,r=[i.x-e.x,i.y-e.y];return r[0]*a[0]+r[1]*a[1]>0?1:-1}var Eo=class extends Ke{constructor(e){super(),this._handles=new Yt,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=70,this._updateAfterDrag=!1,this.events=new oe,this._tool=e.tool,this._view=e.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e)}destroy(){this._handles=N(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(let{manipulator:i}of this._arrowManipulatorInfos)e(i,I.TRANSLATE_XY)}createManipulatedObjectDragPipeline(e,i,a){if(!i.operations)return H();let r=i.operations.data.spatialReference,o=i.graphic;return _i(i,a,s=>this.createDragPipeline((n,l,c,h,u)=>({steps:l,cancel:c}=e(n,l,c,h,u),s(n,l,c)),i.elevationInfo,r,o))}createDragPipeline(e,i,a,r){return J(this._arrowManipulatorInfos.map(({manipulator:o},s)=>he(o,(n,l,c,h,u)=>{let m=l.next(f=>R(y({},f),{manipulatorType:I.TRANSLATE_XY})).next(ti(this._view,n.elevationAlignedLocation)).next(gi(this._view,n.elevationAlignedLocation,i,a,r)).next(Jc(n.location,this.angle+(s+1)*Math.PI*.5)).next($e());e(n,m,c,h,u)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},a){let r=this._radius/70,o=54*r,s=o*Math.sqrt(3)/2,n=Gi(this._opaqueMaterial,s,o/2,o/2,.02);Ur(n,Ai(K.get(),C(b.get(),0,-s/3,0))),e.renderObjects=[new T(n,E.Focused),new T(n.instantiate({material:this._transparentMaterial}),E.Unfocused)],e.radius=s/3*2*1.2;let l=br(K.get(),a*Math.PI/2),c=Ai(K.get(),C(b.get(),0,100*r,0));Le(i,l,c)}_createManipulators(){for(let e=0;e<4;e++){let i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){let e=this.angle,i=vr(K.get(),e,G(0,0,1));if(i==null)return;let a=Di(K.get(),C(b.get(),this.displayScale,this.displayScale,this.displayScale)),r=Le(K.get(),a,i);for(let o of this._arrowManipulatorInfos){let s=Le(K.get(),r,o.transform);o.manipulator.modelTransform=s}}_createArrowManipulator(e){let i=new W({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:G(0,0,1)}}),a={manipulator:i,transform:re()};return this._updateArrowManipulator(a,e),this._handles.add(i.events.on("drag",r=>{this._updateAfterDrag&&r.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){let i=new Ee({cullFace:Q.Back,renderOccluded:O.Transparent,isDecoration:!0});return this._handles.add(v(()=>U.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=e,i.setParameters({color:a})},L)),i}get test(){}};var wo=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&this._lastDragEvent!=null&&this._next!=null){let i=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(a!=null){let r={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:e===!0?a:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(r)}}this._enabled=e}_snap(e){let i=this._view!=null?this._view.toMap(e,{exclude:[]}):null;return i!=null&&this._view!=null&&(i.z=ia(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(e,i){this._view=e,this._elevationInfo=i,this._lastDragEvent=null;let a=new ii;return this._next=a,[r=>{if(this._lastDragEvent=r.action!=="end"?y({},r):null,this._enabled){let o=this._snap(r.screenEnd);return o!=null?{action:r.action,mapStart:r.mapStart,mapEnd:o,screenStart:r.screenStart,screenEnd:r.screenEnd}:null}return{action:r.action,mapStart:r.mapStart,mapEnd:r.mapEnd,screenStart:r.screenStart,screenEnd:r.screenEnd}},a]}};var To=class extends Ke{constructor(e){super(),this._handles=new Yt,this._snapToScene=new wo,this._scale=1,this._radius=70,this._view=e.view,this._tool=e.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=N(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,I.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}get discManipulator(){return this._manipulator}createManipulatedObjectDragPipeline(e,i,a){if(!i.operations)return H();let r=i.graphic,o=i.elevationInfo,s=i.operations.data.spatialReference;return _i(i,a,n=>this.createDragPipeline((l,c,h,u,m)=>({steps:c,cancel:h}=e(l,c,h,u,m),n(l,c,h)),o,s,r))}createDragPipeline(e,i,a,r){let o=this._view;return he(this._manipulator,(s,n,l,c,h)=>{let u=n.next(ti(o,s.elevationAlignedLocation)).next(gi(o,s.elevationAlignedLocation,i,a,r)).next(...this._snapToScene.createDragEventPipelineStep(o,i)).next(m=>R(y({},m),{manipulatorType:I.TRANSLATE_XY})).next($e());e(s,u,l,c,h)})}_updateManipulatorTransform(){let e=Di(K.get(),C(b.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){let e=this._view;this._manipulator=new W({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:G(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){let e=Ec(this._discMaterial,.02,1,128,G(0,0,1),G(0,0,0));e.transformation=Di(re(),G(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new T(e,E.Focused),new T(e.instantiate({material:this._discMaterialTransparent}),E.Unfocused)],this._manipulator.radius=80*(this._radius/70)}_createMaterial(e=1){let i=new Ee({cullFace:Q.Back,renderOccluded:O.Transparent,isDecoration:!0});return this._handles.add(v(()=>U.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=e,i.setParameters({color:a})},L)),i}get test(){}};function ft(t,e=O.OccludeAndTransparent,i=!0){let a=rs(t),r=!(t[3]<1);return i?new Yi({color:a,writeDepth:r,cullFace:Q.Back,renderOccluded:e,isDecoration:!0}):new Ee({color:a,writeDepth:r,cullFace:Q.Back,renderOccluded:e,isDecoration:!0})}function Ea(t,e=O.OccludeAndTransparent){let i=rs(t);return new Ee({color:i,writeDepth:!0,cullFace:Q.Front,renderOccluded:e,isDecoration:!0})}var dn=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),Eh=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function xo(t,e,i,a){let r=A(b.get(),t,i),o=un(r,me(b.get(),a,r),i,K.get());hl(o,o);let s=Ct(b.get(),e,o);return Math.atan2(s[1],s[0])}function un(t,e,i,a){let r=ie(b.get(),t),o=ie(b.get(),e),s=me(b.get(),r,o);return a[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=0,a[4]=o[0],a[5]=o[1],a[6]=o[2],a[7]=0,a[8]=s[0],a[9]=s[1],a[10]=s[2],a[11]=0,a[12]=i[0],a[13]=i[1],a[14]=i[2],a[15]=1,a}function wh(t,e){let i=t.getViewForGraphic(e);return i!=null&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(e,t.spatialReference):null}function Ro(t,e){let i=e.origin;i==null?pu(t,Z(e)):t.elevationAlignedLocation=i}function pu(t,e){if(e==null)return;let i=e.type==="mesh"?e.origin:Sc(e);i!=null&&(t.location=yc(i))}var Ao=class extends Ke{constructor(e){super(),this._radius=70,this.events=new oe,this._tool=e.tool,this._view=e.view;let i=new fe({getTheme:()=>this._view.effectiveTheme});this._settings=i,e.radius!=null&&(this._radius=e.radius);let a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:ft(vi(a,1,.25),O.Occlude),materialFocused:ft(vi(a,1,0),O.Occlude),materialOccludedUnfocused:ft(vi(a,.7,0),i.zManipulator.renderOccluded),materialOccludedFocused:ft(vi(a,.85,0),i.zManipulator.renderOccluded)},this._themeHandle=v(()=>this._view.effectiveTheme.accentColor,r=>{let o=vi(r,1,.25),s=vi(r,1,0),n=vi(r,.7,0),l=vi(r,.85,0),{materialUnfocused:c,materialFocused:h,materialOccludedUnfocused:u,materialOccludedFocused:m}=this._materials;c.setParameters({color:o}),h.setParameters({color:s}),u.setParameters({color:n}),m.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(r=>this._tool.manipulators.add(r))}destroy(){this._themeHandle=tt(this._themeHandle),this._manipulator.applyObjectTransform=du,this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,I.TRANSLATE_Z)}createManipulatedObjectDragPipeline(e,i,a){if(!i.operations)return H();let r=i.operations.data.spatialReference;return _i(i,a,o=>this.createDragPipeline((s,n,l,c,h)=>({steps:n,cancel:l}=e(s,n,l,c,h),o(s,n,l)),r))}createDragPipeline(e,i){let a=this._view;return he(this._manipulator,(r,o,s,n,l)=>{let c=o.next(h=>R(y({},h),{manipulatorType:I.TRANSLATE_Z})).next(So(a,r.renderLocation,i)).next($e());e(r,c,s,n,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){let e=this._settings,i=this._radius/70,a=e.zManipulator.height*i,r=e.zManipulator.coneHeight*i,o=e.zManipulator.coneWidth*i,s=e.zManipulator.width*i,n=[G(0,0,0),G(0,0,a)],l=[G(0,0,0),G(0,0,a+r)],c=(()=>{let w=re();return Va(w,w,[0,0,a]),Ga(w,w,Math.PI/2),w})(),{materialUnfocused:h,materialFocused:u,materialOccludedUnfocused:m,materialOccludedFocused:f}=this._materials,_=wc(h,n,s/2,16,!1),S=Ba(h,r,o/2,16,!1);S.transformation=c,this._manipulator.renderObjects=[new T(S,E.Unfocused),new T(_,E.Unfocused),new T(S.instantiate({material:u}),E.Focused),new T(_.instantiate({material:u}),E.Focused),new T(S.instantiate({material:m}),E.Unfocused),new T(_.instantiate({material:m}),E.Unfocused),new T(S.instantiate({material:f}),E.Focused),new T(_.instantiate({material:f}),E.Focused)],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){let e=this._view,i=new W({view:e,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});i.applyObjectTransform=a=>{let r=e.state.camera,o=Th;e.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,o);let s=_l(r.eye,o),n=r.computeRenderPixelSizeAtDist(s),l=A(wa,o,r.eye);ie(l,l);let c=hu;e.renderCoordsHelper.worldUpAtPosition(Th,c);let h=Math.abs(Me(l,c)),u=me(wa,l,c),m=me(wa,u,c),f=wi(h,.01,1),_=1-Math.sqrt(1-f*f)/f/r.fullWidth,S=this._settings,w=this._radius/70,M=S.zManipulator.width*w;B(m,ie(m,m),(1/_-1)*s+n*M),a[12]-=wa[0],a[13]-=wa[1],a[14]-=wa[2]},this._manipulator=i,this._updateManipulator()}get test(){}};function vi(t,e,i){let a=ul(t,i);return a.a*=e,U.toUnitRGBA(a)}var Th=g(),wa=g(),hu=g(),du=()=>{};var et=class extends Mo{constructor(e){super(),this._handles=new Yt;let{tool:i,view:a,snapToScene:r,radius:o}=e;this._view=a,this.xyManipulation=new To({tool:i,view:a,snapToScene:r,radius:o}),this.xyAxisManipulation=new Eo({tool:i,view:a,radius:o}),this.zManipulation=new Ao({tool:i,view:a,radius:o}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(s=>this._handles.add(s.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createManipulatedObjectDragPipeline(e,i,a){return J([this.xyManipulation.createManipulatedObjectDragPipeline((r,o,s,n,l)=>e(Y.XY,r,o,s,n,l),i,a),this.xyAxisManipulation.createManipulatedObjectDragPipeline((r,o,s,n,l)=>e(Y.XY_AXIS,r,o,s,n,l),i,a),this.zManipulation.createManipulatedObjectDragPipeline((r,o,s,n,l)=>e(Y.Z,r,o,s,n,l),i,a)])}createDragPipeline(e,i,a,r){return J([this.xyManipulation.createDragPipeline((o,s,n,l,c)=>e(Y.XY,o,s,n,l,c),i,a,r),this.xyAxisManipulation.createDragPipeline((o,s,n,l,c)=>e(Y.XY_AXIS,o,s,n,l,c),i,a,r),this.zManipulation.createDragPipeline((o,s,n,l,c)=>e(Y.Z,o,s,n,l,c),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this.xyAxisManipulation.angle=e}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,I.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,I.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,I.TRANSLATE_Z))}get _xyAxisVisible(){let e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){let e=this.xyAxisManipulation,i=this.xyManipulation;if(dr("esri-mobile"))return;let a=[];i.forEachManipulator(o=>a.push(o)),e.forEachManipulator(o=>a.push(o));let r=()=>{let o=[];this._xyAxisVisible||e.forEachManipulator(s=>o.push(s.disableDisplay())),this._handles.remove(xh),this._handles.add(o,xh)};for(let o of a)this._handles.add(o.events.on("focus-changed",r));this._view.inputManager&&this._handles.add(it(()=>this._view.inputManager?.latestPointerType,r)),r()}static radiusForSymbol(e){let i=e!=null&&e.type==="point-3d"&&e.symbolLayers;return i&&i.some(a=>a.type==="icon")?vo:70}},xh="disable-xy-axis-display",Y;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(Y||(Y={}));var bi=class extends Ke{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._object=e.object,this._manipulator=this._object.createManipulator?.({selectable:!0,cursor:"move"}),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){this._manipulator&&e(this._manipulator,I.TRANSLATE_XY)}createManipulatedObjectDragPipeline(e){return _i(this._object,e,i=>this.createDragPipeline(i))}createDragPipeline(e){if(!this._manipulator)return H();let i=this._view;return he(this._manipulator,(a,r,o,s,n)=>{let l=this._object.operations?.data.spatialReference,c=r.next(h=>l?h:null).next(Oh(n,i,this._object,l)).next(Ft()).next($e());e(a,c,o,s,n)})}};var yi=class extends Ot{constructor(t){super(t),this.type="translate-xy",this.distance=Re}};p([d()],yi.prototype,"type",void 0),p([d()],yi.prototype,"distance",void 0),yi=p([D("esri.views.interactive.tooltip.infos.TranslateXYTooltipInfo")],yi);var Rt=class extends Ot{constructor(t){super(t),this.type="translate-z",this.distance=Re}clear(){this.distance=Re}};p([d()],Rt.prototype,"type",void 0),p([d()],Rt.prototype,"distance",void 0),Rt=p([D("esri.views.interactive.tooltip.infos.TranslateZTooltipInfo")],Rt);var Do=class{constructor(e){this.objects=e,this.type="move-start"}},Po=class{constructor(e,i,a){this.dx=e,this.dy=i,this.objects=a,this.type="move"}},sr=class{constructor(e){this.objects=e,this.type="move-stop"}},At=Symbol("manipulators"),Rh=Symbol("tooltips"),Be=class extends ei{constructor(t){super(t),this._infos=new Map,this.events=new oe,this.objects=new Bn,this.enableZ=!0,this.sketchOptions=new Qe,this.type="move-3d",this._latestTooltipInfo=null,this._translateTooltipInfo=null,this._translateXYTooltipInfo=null,this._translateZTooltipInfo=null,this._updatingHandles=new Jt,this._moveManipulation=null}initialize(){let{view:t}=this;this.tooltip=Kt(()=>({view:t,options:this.sketchOptions.tooltips})),this.addHandles([this.objects.on("change",i=>{i.removed.forEach(a=>this.removeHandles(a)),this._updateObjectInfos(i),this._setupFastTransformUpdates(i.added),this._refreshManipulators()}),this.objects.on("change",()=>this._connectTooltips())]);let e=this.objects.toArray();this._updateObjectInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this._connectTooltips(),this.finishToolCreation()}destroy(){this.tooltip=N(this.tooltip),this._moveManipulation=N(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}onInputEvent(t){if(!this.destroyed&&!zi(t,this.tooltip))return super.onInputEvent(t)}get updating(){return this._updatingHandles.updating}get _shouldShowMovePointTooltip(){let{objects:t}=this;if(t.length!==1)return!1;let e=Z(t.at(0))?.type;return e==="point"||e==="mesh"}get activeTooltipInfo(){return this._shouldShowMovePointTooltip?this._movePointTooltipInfo:this._latestTooltipInfo}reset(){}_updateObjectInfos({added:t,removed:e}){for(let i of t){if(dp(i)!==hp.SUPPORTED)continue;let a=new fn(i);this._infos.set(i,a)}for(let i of e)this._infos.delete(i)}_setupFastTransformUpdates(t){for(let e of t){let i=this._infos.get(e);this.addHandles(_a(i.object),e)}}_refreshManipulators(){if(this.removeHandles(At),this._moveManipulation=N(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;let t=Array.from(this._infos.values());this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(let e of t){let i=e.object;e.manipulationXY=new bi({tool:this,view:this.view,object:i}),e.manipulationXY.forEachManipulator(a=>{this.addHandles([a.events.on("immediate-click",r=>{this.events.emit("immediate-click",R(y({},r),{object:i})),r.stopPropagation()}),a.events.on("grab-changed",({action:r})=>{r==="start"?this._showTooltip(Y.XY):this._hideTooltip()})],At)}),this.addHandles(e.manipulationXY.createDragPipeline((a,r,o,s)=>this._buildDragEventPipeline(t,Y.XY,a,r,o,s)),At)}this._createMoveManipulation(t)}_createMoveManipulation(t){let e=new et({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?et.radiusForSymbol(t[0].object.graphic?.symbol):70});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(n=>{this.addHandles(n.events.on("immediate-click",l=>{let c=this.objects.at(0);!e.zManipulation.hasManipulator(n)&&this.objects.length===1&&c&&this.events.emit("immediate-click",R(y({},l),{object:c})),l.stopPropagation()}),At)});let i=n=>l=>{this.addHandles([l.events.on("focus-changed",({action:c})=>{c==="focus"?this._showTooltip(n):this._hideTooltip()}),l.events.on("grab-changed",()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=Re)})],At)};this._moveManipulation.xyManipulation.forEachManipulator(i(Y.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(Y.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(Y.Z));let a=()=>this._updateMoveManipulation(t);for(let n of t)this.addHandles([n.object.on("committed",a),v(()=>n.object.visible,a)],At);let r=t[t.length-1];this.addHandles(r.object.on("committed",()=>this._updateMoveManipulationAngle(r)),At);let{object:o}=r,{operations:s}=o;if(s){let n=o.graphic;this.addHandles(e.createDragPipeline((l,c,h,u,m)=>this._buildDragEventPipeline(t,l,c,h,u,m),o.elevationInfo,s.data.spatialReference,n),At)}this._updateMoveManipulationAngle(r)}_createVisualElements(t){for(let e of t){let i=e.object,a=mi({view:this.view,object:i,forEachManipulator:r=>{e.manipulationXY?.forEachManipulator(r),this._moveManipulation?.forEachManipulator(r)},onManipulatorsChanged:()=>H()});a!=null&&(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof Ve&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.object.isDraped||this._updateMoveManipulation(t)}),v(()=>e.object.isDraped,()=>this._updateMoveManipulation(t))],At),this.addHandles(a,At))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=ar(Z(t.object)))}_updateMoveManipulation(t){let e=Ne(0,0,0,this.view.spatialReference),i=0,a=!1,r=this._moveManipulation;if(r){for(let o of t){if(!o.object.visible)continue;this.enableZ&&ut(o.object.operations,o.object.elevationInfo)&&(a=!0);let s=o.geometryRepresentation instanceof Ve&&!o.object.isDraped?o.geometryRepresentation.attachmentOrigin:o.object.origin;if(s!=null){let{x:n,y:l,z:c}=s;e.x+=n,e.y+=l,c&&(e.z??=0,e.z+=c),i++}}i>0?(e.x/=i,e.y/=i,e.z??=0,e.z/=i,r.location=e,r.xyManipulation.available=!0,r.xyAxisManipulation.available=!0,r.zManipulation.available=a):r.available=!1}}_buildDragEventPipeline(t,e,i,a,r,o){let s=[],n=[],l=null,c=null,h=()=>{for(let u of s)u.dragging=!1;s.length=0,n.length=0,l=null,c=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(t.length===1&&e===Y.XY){let u=t[0].object;({steps:a,cancel:r}=this._buildSnappingPipelineSteps(u,u.elevationInfo,a,r,o))}return r=r.next(u=>c?.(u)).next(()=>(n.length&&this.events.emit("move-stop",new sr(n)),this.destroyed||h(),null)),{steps:a=a.next(u=>{if(u.action==="start"){s.length=0,n.length=0;for(let m of t)m.dragging||!m.manipulationXY?.hasManipulator(i)&&m.manipulationXY?.grabbing||(s.push(m),n.push(m.object),m.dragging=!0);if(n.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=ep(n),c=ip(n),this._emitRecordUndo(),this.events.emit("move-start",new Do(n)),this.destroyed))return null}return n.length!==0?u:null}).next(u=>l?.(u)).next(u=>(this._updateMoveTooltip(e,u),u)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){let m=this.view.toScreen(u.mapStart),f=this.view.toScreen(u.mapEnd);if(!m||!f)return null;let _=f.x-m.x,S=f.y-m.y;if(this.events.emit("move",new Po(_,S,n)),this.destroyed)return null}break;case"end":if(this.events.emit("move-stop",new sr(n)),this.destroyed)return null;h()}return null}),cancel:r}}_connectTooltips(){let t;if(this.removeHandles(Rh),this._shouldShowMovePointTooltip){let e=this.objects.at(0),{events:i}=this;this._movePointTooltipInfo??=new eo({viewType:this.view.type,sketchOptions:this.sketchOptions});let a={onBeforeUpdate:()=>this.endDrag(),onMoveStart:()=>{this._emitRecordUndo(),i.emit("move-start",new Do([e]))},onMove:()=>i.emit("move",new Po(0,0,[e])),onMoveStop:()=>i.emit("move-stop",new sr([e])),onRotateStart:()=>{},onRotate:()=>{},onRotateStop:()=>{},onScaleStart:()=>{},onScale:()=>{},onScaleStop:()=>{}};t=mo(this.tooltip,e,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this._movePointTooltipInfo,callbacks:a}))}else t=v(()=>this.sketchOptions.tooltips.effectiveEnabled?this._latestTooltipInfo:null,e=>{this.tooltip.info=e},Pe);this.addHandles(t,Rh)}_showTooltip(t){this._shouldShowMovePointTooltip||this._updateMoveTooltip(t)}_hideTooltip(){this._shouldShowMovePointTooltip||(this.tooltip?.clear(),this._latestTooltipInfo=null)}_updateMoveTooltip(t,e){if(this._shouldShowMovePointTooltip)return;let{sketchOptions:i}=this;switch(t){case Y.XY:this._latestTooltipInfo=this._translateTooltipInfo??=new da({sketchOptions:i}),mn(this._latestTooltipInfo,e,(a,r)=>na(a,r));break;case Y.XY_AXIS:this._latestTooltipInfo=this._translateXYTooltipInfo??=new yi({sketchOptions:i}),mn(this._latestTooltipInfo,e,(a,r)=>Wa(na(a,r),Oo(e)));break;case Y.Z:this._latestTooltipInfo=this._translateZTooltipInfo??=new Rt({sketchOptions:i}),mn(this._latestTooltipInfo,e,Xr)}this._latestTooltipInfo.sketchOptions=i}_emitRecordUndo(){let t=this.objects.toArray().map(e=>e.createUndoRecord?.()).filter(ur);t.length>0&&this.events.emit("record-undo",{updates:t})}_buildSnappingPipelineSteps(t,e,i,a,r){let o=Z(t);if(o==null||o.type!=="point"&&o.type!=="mesh")return{steps:i,cancel:a};let s=(o.type==="point"?o:o.origin).clone(),n=new Hi({elevationInfo:e,pointer:r,editGeometryOperations:ca.fromGeometry(s,this.view.state.viewingMode),visualizer:new ht,excludeFeature:t.graphic}),l=this.snappingManager,{snappingStep:c,cancelSnapping:h}=Fi({snappingContext:n,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(h),{steps:i=i.next(u=>(s.z=Fl(this.view,s,t.elevationInfo,{mode:"absolute-height",offset:0}),R(y({},u),{snapOrigin:n.coordinateHelper.pointToVector(s)}))).next(...c),cancel:a}}};p([d({constructOnly:!0,nonNullable:!0})],Be.prototype,"view",void 0),p([d()],Be.prototype,"objects",void 0),p([d({constructOnly:!0,nonNullable:!0})],Be.prototype,"enableZ",void 0),p([d({constructOnly:!0,type:Qe})],Be.prototype,"sketchOptions",void 0),p([d({constructOnly:!0})],Be.prototype,"snappingManager",void 0),p([d()],Be.prototype,"type",void 0),p([d()],Be.prototype,"updating",null),p([d()],Be.prototype,"_latestTooltipInfo",void 0),p([d()],Be.prototype,"_shouldShowMovePointTooltip",null),p([d()],Be.prototype,"activeTooltipInfo",null),Be=p([D("esri.views.3d.interactive.editingTools.move.MoveTool3D")],Be);var fn=class{constructor(e){this.object=e,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1}};function mn(t,e,i){if(e==null||e.action==="end")return void(t.distance=Re);let{mapStart:a,mapEnd:r}=e,o=i(a,r);t.distance=o??Re}function Io(t,e,i){let a=i.mode==="on-the-ground"?Cs.XY:Cs.XYZ;return new $c(t,a,e,0)}function gn(t,e,i){let a=g();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;let r=Ah(t,e,i.plane),o=Ah(t,e,i.edgeDirection);if(r==null||o==null)return null;let s=me(g(),r,o);return ke(a,s,bt())}function Ah(t,e,i){let a=Ne(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),r=g(),o=g();return t.renderCoordsHelper.toRenderCoords(e,r)&&t.renderCoordsHelper.toRenderCoords(a,o)?cs(o,r,o):null}function Dh(t,e,i){let a=t,r=cs(g(),e,i),o=me(g(),r,a),s=me(g(),r,o);return bl(r[0],r[1],r[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}function Ph(t,e,i){let a=i.projectToRenderScreen(t,ja()),r=i.projectToRenderScreen(e,ja());return a!=null&&r!=null?ns(A(a,a,r)):0}function _n(t,e,i,a){let{elevationInfo:r,operations:o}=i;if(!o||!t)return null;let s=a.manipulator.elevationAlignedLocation,n=ia(s,e,r),l=e.sceneIntersectionHelper.intersectElevationFromScreen(ge(t.x,t.y),r,n);return l&&Ri(l,l,o.data.spatialReference)?l:null}function Ih(t,e,i,{data:{coordinateHelper:a,spatialReference:r}}){let o=Rc(t,"meters"),s=Xn(r),n=Math.sign(o*i.selectedArrow),l=Ic(r),c=i.plane,h=a.pointToXYZ(e),u=g();rt(u,h,c,n*(uu/s));let m=o*i.selectedArrow/s;if(!l||!Xe(h,r,h,l)||!Xe(u,r,u,l))return m;let f=new Ac;if(Pc(f,h,u,l),Dc(u,h,f.azimuth,o,l),!Xe(u,l,u,r))return m;let _=u[0]-e.x,S=u[1]-e.y,w=Math.sqrt(_*_+S*S)*n,[M,P]=c,X=Math.sqrt(M*M+P*P);return X===0?0:w/X}var uu=10;var Nt=class extends Ot{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=Uc({lockable:!1}),this.area=Wc({visible:!1}),this.totalLength=Nc({visible:!1})}get allFields(){return[this.distance,this.area,this.totalLength]}};p([d()],Nt.prototype,"type",void 0),p([d()],Nt.prototype,"distance",void 0),p([d()],Nt.prototype,"area",void 0),p([d()],Nt.prototype,"totalLength",void 0),p([d()],Nt.prototype,"allFields",null),Nt=p([D("esri.views.interactive.tooltip.infos.ReshapeEdgeOffsetTooltipInfo")],Nt);function jh(t,e){let i=e?.type;return{edgeOffset:new Nt({sketchOptions:t,viewType:i}),movePoint:new eo({sketchOptions:t,viewType:i}),selectedVertex:new Tp({sketchOptions:t,viewType:i}),translate:new da({sketchOptions:t,viewType:i}),translateXY:new yi({sketchOptions:t,viewType:i}),translateZ:new Rt({sketchOptions:t,viewType:i})}}function Lh(t,e,i){function a(){let n=i(),l=n.sketchOptions.tooltips.effectiveEnabled?n.activeTooltipInfo:null;return R(y({},n),{activeTooltipInfo:l})}let r=!1;function o(n){r||(r=!0,n(),r=!1)}function s(n){o(()=>{fu(e,n),t.info=n.activeTooltipInfo})}return J([v(a,s,Pe),v(()=>{let n=a(),{activeTooltipInfo:l}=n;if(l&&"key"in l)return{context:n,activeTooltipInfo:l,key:l.key,geometry:Z(e)}},(n,l)=>{n&&l&&l.key!==n.key&&o(()=>Ch(e,n.context))},at),e.on("committed",()=>s(a())),Br(t,{onBeforePaste:()=>{r=!0},onAfterPaste:()=>{Ch(e,a()),r=!1}})])}function Ch(t,{activeTooltipInfo:e,selectedVertexManipulatorInfo:i,callbacks:a}){if(!e)return;a.onBeforeReshape();let r=Z(t);switch(r?.type){case"mesh":e.type==="move-point"&&rr(e,r.origin,t,a);break;case"point":e.type==="move-point"&&rr(e,r,t,a);break;case"polyline":case"polygon":e.type==="selected-vertex"&&mu(e,i,t,a)}}function mu(t,e,i,a){if(!e)return;let{dx:r,dy:o,dz:s}=Zr(t,e.manipulator.location);r===0&&o===0&&s===0||(a.onReshapeStart(),i.operations?.moveVertices([e.handle],r,o,s,Oe.NEW_STEP),a.onReshape(),a.onReshapeStop())}function fu(t,{activeTooltipInfo:e,selectedVertexManipulatorInfo:i,sketchOptions:a}){if(e)switch(e.sketchOptions=a,e?.type){case"move-point":$s(e,t);break;case"selected-vertex":gu(e,i,t)}}function gu(t,e,i){if(!t||t.type!=="selected-vertex")return;let a=e?.manipulator.location;t.setLocationFromPoint(a),Js(t,a,i);let r=i.operations?.data.geometry;switch(r?.type){case"polygon":t.geometryType="polygon",t.totalLength.visible=!1,t.area.actual=Ps(r);break;case"polyline":t.geometryType="polyline",t.totalLength.actual=Is(r),t.area.visible=!1}}function Vh(t,e,{sketchOptions:i,tooltipInfos:a}){let r=null;switch(t){case Y.XY:r=a.translate,vn(r,e,(o,s)=>na(o,s));break;case Y.XY_AXIS:r=a.translateXY,vn(r,e,(o,s)=>Wa(na(o,s),Oo(e)));break;case Y.Z:r=a.translateZ,vn(r,e,Xr)}return r.sketchOptions=i,r}function vn(t,e,i){if(e!=null&&e.action!=="end"){let{mapStart:a,mapEnd:r}=e,o=i(a,r);t.distance=o??Re}else t.distance=Re}function bn({operations:t},e,{sketchOptions:i,tooltipInfos:a}){let r=a.edgeOffset;if(r.distance.committed=null,e!=null&&e.signedDistance!=null&&e.action!=="end"&&t!=null){let s=t.data.coordinateHelper,{start:n,end:l}=e.operation.clampedStartAndEnd(e.mapEnd),c=la(n,l,s.spatialReference),h=Math.sign(e.signedDistance*e.operation.selectedArrow);r.distance.actual=c!=null?Wa(c,h):null}else r.distance.actual=Re;let o=t?.data.geometry;switch(r.area.actual=null,r.area.visible=!1,r.totalLength.actual=null,r.totalLength.visible=!1,o?.type){case"polygon":r.area.actual=Ps(o),r.area.visible=!0;break;case"polyline":r.totalLength.actual=Is(o),r.totalLength.visible=!0}return r.sketchOptions=i,r}var Gh=Symbol(),ee=class extends Te{get _operations(){return this.object.operations}constructor(t){super(t),this._selectedIndex=0,this._manipulatorHandles=new Yt,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=q.NONE,this._pendingEdgeOffsetInfo=null,this._updatingHandles=new Jt,this._recreatingManipulators=!1,this._settings=new fe({getTheme:()=>this.view.effectiveTheme}),this.events=new oe,this.activeTooltipInfo=null,this._vertexLaserLineVisualElement=null,this._tooltipCallbacks={onBeforeReshape:()=>this.tool.endDrag(),onReshapeStart:()=>this._updateEventState(q.RESHAPING),onReshape:()=>this.events.emit("reshape",{type:"reshape",object:this.object}),onReshapeStop:()=>this._updateEventState(q.NONE,{forceEnd:!0}),onMoveStart:()=>this._updateEventState(q.MOVING),onMove:()=>this.events.emit("move",{type:"move",object:this.object,dx:0,dy:0}),onMoveStop:()=>this._updateEventState(q.NONE,{forceEnd:!0})}}initialize(){let{view:t}=this,e=this._settings.manipulators,i=e.vertex;this.tooltipInfos=jh(this._sketchOptions,t),this._vertexManipulatorMaterial=ft(te(i.color),i.renderOccluded),this._vertexManipulatorOutlineMaterial=Ea(te(i.outlineColor),i.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Ea(te(i.hoverOutlineColor),i.renderOccluded);let a=e.edge;this._edgeManipulatorMaterial=ft(te(a.color),a.renderOccluded),this._edgeManipulatorOutlineMaterial=Ea(te(a.outlineColor),a.renderOccluded);let r=e.edgeOffset;this._edgeOffsetManipulatorMaterial=ft(te(r.color),r.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=ft(te(r.hoverColor),r.renderOccluded,!1);let o=e.selected;this._selectedManipulatorMaterial=ft(te(o.color),o.renderOccluded),this._selectedManipulatorOutlineMaterial=Ea(te(o.outlineColor),o.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Ea(te(o.hoverOutlineColor),o.renderOccluded),this.tooltip=Kt(()=>({view:t,options:this._sketchOptions.tooltips})),this.addHandles([v(()=>{let s=this._settings.manipulators;return{vertexSettings:s.vertex,edgeSettings:s.edge,edgeOffsetSettings:s.edgeOffset,selectedSettings:s.selected}},({vertexSettings:s,edgeSettings:n,edgeOffsetSettings:l,selectedSettings:c})=>{s.applyColor(this._vertexManipulatorMaterial),s.applyOutline(this._vertexManipulatorOutlineMaterial),s.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),n.applyColor(this._edgeManipulatorMaterial),n.applyOutline(this._edgeManipulatorOutlineMaterial),l.applyColor(this._edgeOffsetManipulatorMaterial),l.applyHover(this._edgeOffsetManipulatorHoverMaterial),c.applyColor(this._selectedManipulatorMaterial),c.applyOutline(this._selectedManipulatorOutlineMaterial),c.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)}),v(()=>this.object.visible,s=>{for(let n of this._manipulatorInfos)n.manipulator.available=s,Mn(n)&&(n.edgeManipulator.available=s)}),v(()=>this._numGrabbing+this._numDragging===0,s=>this._toggleAutoHideManipulators(s)),v(()=>({labels:this._segmentLabels,enabled:this._sketchOptions.labels.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:s,enabled:n,edgeOffsetEnabled:l})=>{s!=null&&(s.visible=n,s.edgeDistance=l?"far":"default")},L),Lh(this.tooltip,this.object,()=>this._tooltipsContext),v(()=>this.tooltip.mode,(s,n)=>{n==="input"&&s!=="input"&&this._resetTooltip()}),Xt(()=>this._operations,"vertex-update",s=>this._updateManipulatorPositions(s.vertices),{onListenerAdd:()=>this._recreateManipulators()}),Xt(()=>this._operations?.data,"change",s=>{s.operation!=="undo"&&s.operation!=="redo"||this._recreateManipulators()})])}destroy(){this._removeManipulators(),this._updatingHandles.destroy(),this._segmentLabels=N(this._segmentLabels),this.tooltip=N(this.tooltip)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get object(){return this.tool.object}get enableZShape(){return this.tool.enableZShape}get enableDeleteVertices(){return this.tool.enableDeleteVertices}get enableZVertex(){return this.tool.enableZVertex}get autoHideManipulators(){return this.tool.autoHideManipulators}get enableMoveObject(){return this.tool.enableMoveObject}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _sketchOptions(){return this.tool.sketchOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}enterInputModeIfAvailable(t){return t.type==="key-down"&&t.key===zc.enterInputMode&&(this.activeTooltipInfo?.type==="reshape-edge-offset"?this._enterInputModeDuringEdgeOffset(t):!!zi(t,this.tooltip)&&(this.tool.endDrag(),!0))}removeSelectedVertices(){let t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");return this._removeVertices(t),t.length}onManipulatorSelectionChanged(){this.events.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=N(this._moveManipulation),this._objectMoveManipulation=N(this._objectMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(this._operations==null)return;let e=this.object.elevationInfo;for(let i of this._operations.data.components){let a=t?.byComponentIndex.get(i.index);for(let r of i.vertices){let o=a?.has(r.index);this._createVertexOrEdgeManipulator(r,e,o)}for(let r of i.edges)this._createVertexOrEdgeManipulator(r,e)}this._createObjectMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return this._operations!=null&&this._operations.canRedo}get canUndo(){return this._operations!=null&&this._operations.canUndo}redo(){return this._operations?.redo()}undo(){return this.events.emit("undo"),this._operations?.undo()}_recreateManipulators(){if(!this._recreatingManipulators){if(this._recreatingManipulators=!0,this._removeManipulators(),this._resetTooltip(),this._operations&&this._segmentLabels?.context?.editGeometryOperations===this._operations||(this._segmentLabels=N(this._segmentLabels)),this._createManipulators(),!this._segmentLabels&&this._operations){let t=this._sketchOptions.labels;this._segmentLabels=new ua({context:{view:this.view,editGeometryOperations:this._operations,elevationInfo:this.object.elevationInfo,labelOptions:t},visible:t.enabled})}this._recreatingManipulators=!1}}_perObjectManipulatorDragAction(t,e){if(e.action==="end")return e;let i=0,a=[],r=this._manipulatorInfos.some(s=>s.type==="vertex"&&s.manipulator.selected),o=t===Ta.SELECTED_OR_ALL&&r;for(let s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.grabbing||o&&!s.manipulator.selected||a.push(s),i++);if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(q.MOVING),this.destroyed)return e;this.events.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,object:this.object})}else{if(this._updateEventState(q.RESHAPING),this.destroyed)return e;this.events.emit("reshape",{type:"reshape",object:this.object})}return e}_toggleAutoHideManipulators(t){this.autoHideManipulators&&(t?this.removeHandles(Gh):this.tool.manipulators.forEach(({manipulator:e})=>{let i=e.disableDisplay?.();i&&this.addHandles(i,Gh)}))}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((t,e)=>e.type==="vertex"&&e.manipulator.selected?t+1:t,0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(q.RESHAPING),this.destroyed)return;let{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;let r=[];for(let o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.selected&&!o.manipulator.grabbing||o===t.info)&&r.push(o);this._moveVertices(r,t,Oe.ACCUMULATE_STEPS),this.events.emit("reshape",{type:"reshape",object:this.object})}_updateEventState(t,e={}){if(t===this._reshapeEventState)return!1;switch(t){case q.NONE:if(!e.forceEnd&&(this._numGrabbing!==0||this._numDragging!==0))return!1;switch(this._reshapeEventState){case q.MOVING:this.events.emit("move",{type:"move-stop",dx:0,dy:0,object:this.object});break;case q.RESHAPING:this.events.emit("reshape",{type:"reshape-stop",object:this.object})}break;case q.MOVING:switch(this._reshapeEventState){case q.NONE:this.events.emit("move",{type:"move-start",dx:0,dy:0,object:this.object});break;case q.RESHAPING:this.events.emit("reshape",{type:"reshape-stop",object:this.object}),this.destroyed||this.events.emit("move",{type:"move-start",dx:0,dy:0,object:this.object})}break;case q.RESHAPING:switch(this._reshapeEventState){case q.NONE:this.events.emit("reshape",{type:"reshape-start",object:this.object});break;case q.MOVING:this.events.emit("move",{type:"move-stop",dx:0,dy:0,object:this.object}),this.destroyed||this.events.emit("reshape",{type:"reshape-start",object:this.object})}}if(this.destroyed)return!1;let i=this._reshapeEventState!==t;return this._reshapeEventState=t,i}_createObjectMoveManipulation(){let{tool:t,view:e,object:i,_operations:a}=this;if(a){if(this._objectMoveManipulation=new bi({tool:t,view:e,object:i}),this.enableMoveObject){let r=null;this._manipulatorHandles.add(this._objectMoveManipulation.createDragPipeline((o,s,n)=>{s.next(l=>this._trackNumDragging(l)).next(l=>(l.action==="start"&&(r=a.createUndoGroup()),l)).next(l=>this._perObjectManipulatorDragAction(Ta.ALL,l)).next(l=>(this._updateTranslateObjectTooltip(Y.XY,l),l)).next(l=>{l.action==="end"&&(this._resetTooltip(),r=tt(r))}),n.next(()=>this._onDragCancel(!0,()=>r=tt(r)))})),this._objectMoveManipulation.forEachManipulator(o=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(o,!1)))}else this._objectMoveManipulation.forEachManipulator(r=>{r.grabbable=!1,r.cursor=null});this._objectMoveManipulation.forEachManipulator(r=>this._manipulatorHandles.add(r.events.on("immediate-click",o=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.events.emit("immediate-click",R(y({},o),{object:this.object})),o.stopPropagation()})))}}_createMoveManipulation(t){let{object:e,tool:i,view:a,_operations:r}=this;if(!r)return;this._moveManipulation=new et({tool:i,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&ut(e.operations,e.elevationInfo),snapToScene:!1,radius:et.radiusForSymbol(e.graphic?.symbol)}),this._moveManipulation.forEachManipulator(n=>this.addHandles([n.events.on("immediate-click",l=>{this._moveManipulation.zManipulation.hasManipulator(n)||this._manipulatorInfos.some(c=>c.manipulator.selected)||this.events.emit("immediate-click",R(y({},l),{object:this.object})),l.stopPropagation()}),this._watchAndUpdateGrabState(n,!1)]));let o=n=>l=>{this.addHandles([l.events.on("focus-changed",({action:c})=>{c==="focus"?this._updateTranslateTooltip(n):this._resetTooltip()})])};this._moveManipulation.xyManipulation.forEachManipulator(o(Y.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(o(Y.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(o(Y.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};let s=r.data.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline((n,l,c,h,u)=>{let{snappingStep:m,cancelSnapping:f}=Fi({predicate:_=>!!_.info,snappingManager:i.snappingManager,snappingContext:new Hi({editGeometryOperations:r,elevationInfo:t,pointer:u,excludeFeature:e.graphic,visualizer:new ht}),updatingHandles:this._updatingHandles,useZ:!1});return h=h.next(_=>(this._onDragCancel(),_)).next(f),{steps:c=c.next(_=>this._trackNumDragging(_)).next(_=>{let S=this._manipulatorInfos.filter(w=>w.type==="vertex"&&w.manipulator.selected);return _.manipulatorType===I.TRANSLATE_XY&&S.length===1?R(y({},_),{info:S[0],snapOrigin:S[0].handle.pos}):_}).next(js(this.view,t,e.graphic??void 0)).next(...m).next(Ft()).next(_=>this._perObjectManipulatorDragAction(Ta.SELECTED_OR_ALL,_)).next(_=>(this._updateTranslateTooltip(n,_),_)),cancel:h}},t,s,e.graphic),v(()=>e.visible,()=>this._updateMoveManipulationPosition(),L),e.on("committed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),v(()=>e.isDraped,n=>{this._updateMoveManipulationPosition();let l="align-move-manipulation";n?this.addHandles(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),l):this.removeHandles(l)},L)])}_createVisualElements(){let{object:t,view:e}=this,i=mi({view:e,object:t,forEachManipulator:r=>{if(!this.destroyed&&!this._recreatingManipulators){this._objectMoveManipulation.forEachManipulator(r),this._moveManipulation.forEachManipulator(r);for(let o of this._manipulatorInfos)r(o.manipulator,I.TRANSLATE_XY)}},onManipulatorsChanged:r=>this.events.on("manipulators-changed",r)});i!=null&&(this._outlineVisualElement=i.visualElement instanceof Ve?i.visualElement:null);let a=this._outlineVisualElement;if(a!=null){let r=()=>{t.isDraped||this._updateMoveManipulationPosition()};this._manipulatorHandles.add(Xt(()=>a.events,"attachment-origin-changed",r,{onListenerAdd:r}))}this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=this.object.elevationInfo){let i=this.view,a=this._operations;if(t.component.vertices.length<=2||!a)return null;let r=a.data.spatialReference,o=this._settings.manipulators.edgeOffset,s=o.size/2,n=s+o.collisionPadding,l=s/n,c=l/2,h=l*Math.sqrt(3)/2,{height:u,offset:m}=o,f=this._edgeOffsetManipulatorMaterial;if(!this._edgeOffsetManipulatorGeometryInside){let $=Gi(f,h,c,c,u,m);this._edgeOffsetManipulatorGeometryInside=$}if(!this._edgeOffsetManipulatorGeometryOutside){let $=Gi(f,-h,c,c,u,-m);this._edgeOffsetManipulatorGeometryOutside=$}let _=[new T(this._edgeOffsetManipulatorGeometryInside.instantiate(),E.Unfocused),new T(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),E.Focused),new T(this._edgeOffsetManipulatorGeometryOutside.instantiate(),E.Unfocused),new T(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),E.Focused)],S=new W({view:i,renderObjects:_,elevationInfo:e.mode!=="on-the-ground"||Ts(this.object.graphic?.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:n,available:this.object.visible,collisionType:{type:"disc",direction:G(0,0,1)},collisionPriority:1,metadata:{deleting:!1},location:yn(r)}),w=new W({view:i,worldSized:!0,worldOriented:!1,available:this.object.visible,collisionPriority:-10,cursor:this.enableMoveObject?"move":"default",metadata:{deleting:!1},location:yn(r)}),M={manipulator:S,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:w,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(M,o.minSquaredEdgeLength);let P=()=>this._updateEdgeOffsetManipulator(M);P(),M.locationUpdateHandle=J([t.leftVertex,t.rightVertex].map($=>this._getManipulatorInfoFromHandle($)?.manipulator.events.on("location-update",P)));let X=$=>{this._manipulatorInfos.some(k=>k.manipulator.selected)?this._clearSelection():this.events.emit("immediate-click",R(y({},$),{object:this.object})),$.stopPropagation()};return this._manipulatorHandles.add([M.locationUpdateHandle,this._watchAndUpdateGrabState(S,!0),this._watchAndUpdateGrabState(w,!0),he(S,this._createEdgeOffsetPipeline(M,e,a)),he(w,this._createEdgePipeline(M,e,a)),w.events.on("immediate-click",X),S.events.on("immediate-click",X),S.events.on("focus-changed",()=>this._resetTooltip()),S.events.on("grab-changed",({screenPoint:$,action:k})=>{M.grabMapPoint=k==="start"?_n($,this.view,this.object,M):null})],S),this._manipulatorInfos.push(M),this.manipulators.addMany([S,w]),this.events.emit("manipulators-changed"),M}_autoHideEdgeOffsetManipulator(t,e){let i=t.manipulator,a=t.edgeManipulator,r=()=>{t.visibilityHandle=tt(t.visibilityHandle);let o=this._getManipulatorInfoFromHandle(t.handle.leftVertex),s=this._getManipulatorInfoFromHandle(t.handle.rightVertex),n=o!=null&&s!=null&&Ph(o.manipulator.renderLocation,s.manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||n)&&(i.grabbable=!n,a.grabbable=!n,t.visibilityHandle=J([i.disableDisplay(),H(()=>{i.grabbable=!0,a.grabbable=this.enableMoveObject})]))};this._manipulatorHandles.add([i.events.on("focus-changed",r),a.events.on("focus-changed",r),H(()=>{tt(t.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)})],i),r()}_updateEdgeOffsetManipulator(t){if(!this._operations)return;this._updateManipulatorPosition(t);let{coordinateHelper:e}=this._operations.data,i=gn(this.view,t.manipulator.elevationAlignedLocation,Io(e,t.handle,t.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),r=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(a==null||r==null)return;let o=a.manipulator.renderLocation,s=r.manipulator.renderLocation,n=i!=null?Dh(i,o,s):yl;t.manipulator.modelTransform=n,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=n;let l=Ce(A(Co,o,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgePipeline(t,e,i){return(a,r,o,s)=>{if(s==="touch")this._createEdgeOffsetPipeline(t,e,i)(a,r,o);else if(this.enableMoveObject){let n=this.object.graphic,l=i.data.spatialReference,{elevationAlignedLocation:c}=a;r.next(h=>this._trackNumDragging(h)).next(ti(this.view,c)).next(gi(this.view,c,e,l,n)).next($e()).next(Ft()).next(h=>this._perObjectManipulatorDragAction(Ta.ALL,h)).next(h=>(this._updateTranslateObjectTooltip(Y.XY,h),h)).next(h=>{h.action==="end"&&this._resetTooltip()}),o.next(()=>this._onDragCancel(!a.metadata.deleting))}}}_createEdgeOffsetPipeline(t,e,i){return(a,r,o)=>{let s=this._pendingEdgeOffsetInfo;if(s?.manipulatorInfo===t&&s.mode!=="drag")return void o.execute({action:"cancel"});this._clearSelection();let{initializeStep:n,cleanup:l}=this._initializeEdgeOffset(t,e,i,o),c=this._applyEdgeOffsetStep(t);r.next(h=>this._trackNumDragging(h)).next(ti(this.view,a.elevationAlignedLocation)).next(n).next(Mh(this.view)).next(cn(this.view,i.data.spatialReference)).next(Ft()).next(_u()).next(h=>this._pendingEdgeOffsetInfo?h:c(h)).next(h=>{h.action!=="end"||this._pendingEdgeOffsetInfo||l()}),o.next(()=>{this._exitEdgeOffsetInputMode(),a.metadata.deleting||(l(),this._onDragCancel())})}}_initializeEdgeOffset(t,e,i,a){let{view:r,object:o}=this,s=Io(i.data.coordinateHelper,t.handle,e),n=i.createUndoGroup(),l=gn(r,t.manipulator.elevationAlignedLocation,s),c;this._splitEdgesBeforeEdgeOffset(t,s),this._selectEdgeOffsetArrow(t,s);let h=()=>{this._cleanEdgeOffsetCollapsedEdges(t,i),c=tt(c)},u=this.events.on("undo",h);return c=J([this._initializeEdgeOffsetVisualElement(t,o,e,i),n,u,this._connectEdgeOffsetTooltip(t,s,i,()=>{a.execute({action:"cancel"})})]),{initializeStep:m=>s==null||l==null?(h(),null):R(y({},m),{operation:s,plane:l}),cleanup:h}}_initializeEdgeOffsetVisualElement(t,e,i,a){let r=()=>new Kn({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),o=new Ve({view:this.view,isDraped:e.isDraped,geometry:r(),elevationInfo:i,width:this._settings.visualElements.lineObjects.outline.width,attached:!1,isDecoration:!0}),s=J([v(()=>({color:this._accentColor,draped:e.isDraped}),({color:n,draped:l})=>{o.color=te(n),o.isDraped=l},Pe),e.on("committed",()=>{o.geometry=r()}),ye(o)]);return o.attached=!0,s}_applyEdgeOffsetStep(t){return e=>(this.destroyed||e.operation==null||!this._operations||(this._updateEventState(q.RESHAPING),e.signedDistance==null?this._resetTooltip():((e.mapDeltaX||e.mapDeltaY||e.mapDeltaZ)&&(this._offsetEdge(t,e.operation,e.signedDistance),this.events.emit("reshape",{type:"reshape",object:this.object})),this._updateEdgeOffsetTooltip(e))),e)}_cleanEdgeOffsetCollapsedEdges(t,e){let i=t.handle.leftVertex.leftEdge?.leftVertex,a=t.handle.leftVertex,r=t.handle.rightVertex.rightEdge?.rightVertex,o=t.handle.rightVertex,s=e.data.coordinateHelper,n=this.view.pixelSizeAt(s.vectorToDehydratedPoint(a.pos),s.spatialReference),l=[];if(i&&s.distance(i.pos,a.pos)<Fh){let c=this._getManipulatorInfoFromHandle(a);c!=null&&l.push(c)}if(s.distance(a.pos,o.pos)<n||r&&s.distance(r.pos,o.pos)<Fh){let c=this._getManipulatorInfoFromHandle(o);c!=null&&l.push(c)}l.length&&this._removeVertices(l)}_enterInputModeDuringEdgeOffset(t){let e=this._findActiveEdgeOffsetManipulatorInfo();return!!e&&!!zi(t,this.tooltip)&&(e.manipulator.dragging?(this._pendingEdgeOffsetInfo={manipulatorInfo:e,mode:"drag"},!0):(this._clearSelection(),this._pendingEdgeOffsetInfo={manipulatorInfo:e,mode:"hover"},this._connectEdgeOffsetTooltipOnHover(e),!0))}_exitEdgeOffsetInputMode(){this.tooltip&&(this._pendingEdgeOffsetInfo=null,this._resetTooltip(),this.tooltip.exitInputMode())}_findActiveEdgeOffsetManipulatorInfo(){return this._manipulatorInfos.filter(Mn).find(({manipulator:t})=>t.hovering||t.grabbing||t.dragging)}_connectEdgeOffsetTooltipOnHover(t){let{_operations:e,object:i}=this;if(!e)return;let{elevationInfo:a}=i,r=Io(e.data.coordinateHelper,t.handle,a);this._selectEdgeOffsetArrow(t,r),this.addHandles([this._initializeEdgeOffsetVisualElement(t,i,a,e),this._connectEdgeOffsetTooltip(t,r,e,()=>{this.removeHandles(r),this._exitEdgeOffsetInputMode()})],r)}_splitEdgesBeforeEdgeOffset(t,e){if(e.requiresSplitEdgeLeft){let i=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);i!=null&&this._splitEdgeManipulator(i,1)}if(e.requiresSplitEdgeRight){let i=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);i!=null&&this._splitEdgeManipulator(i,0)}}_selectEdgeOffsetArrow(t,e){let i=t.grabMapPoint??_n(this.view.inputManager?.latestPointerLocation,this.view,this.object,t);i&&e.selectArrowFromStartPoint(i)}_connectEdgeOffsetTooltip(t,e,i,a){let r=()=>this.tooltipInfos.edgeOffset.distance.actual,o=n=>{a(),queueMicrotask(()=>{this.view.focus();let l=i.createUndoGroup();this._tooltipCallbacks.onReshapeStart?.(),this._splitEdgesBeforeEdgeOffset(t,e),this._offsetEdge(t,e,Ih(n,t.manipulator.location,e,i)),this._tooltipCallbacks.onReshape?.(),this._tooltipCallbacks.onReshapeStop?.(),this._cleanEdgeOffsetCollapsedEdges(t,i),l.remove()})},s=()=>{let n=r();n!=null?o(n):a()};return J([it(()=>this.tooltip&&!this.tooltip.focused,()=>s(),at),this.tooltip.on("discard",a),this.tooltip.on("commit",n=>{n.type==="commit-and-exit"&&s()})])}_createVertexOrEdgeManipulator(t,e=this.object.elevationInfo,i=!1){let a=this.view,r=this._operations,o=this._settings;if(!r)return null;let s=r.data.type,n=r.data.spatialReference;if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){let{size:m,outlineSize:f}=zh(o.manipulators.vertex);this._vertexManipulatorGeometry=Vi(this._vertexManipulatorMaterial,m,16,16),this._vertexManipulatorOutlineGeometry=Vi(this._vertexManipulatorOutlineMaterial,f,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){let{size:m,outlineSize:f}=zh(o.manipulators.edge);this._edgeManipulatorGeometry=Vi(this._edgeManipulatorMaterial,m,16,16),this._edgeManipulatorOutlineGeometry=Vi(this._edgeManipulatorOutlineMaterial,f,16,16)}let l=s==="point"||s==="mesh"?[]:[new T(this._vertexManipulatorGeometry.instantiate(),gt.Vertex|E.Unselected),new T(this._vertexManipulatorOutlineGeometry.instantiate(),gt.Vertex|E.Unfocused|E.Unselected),new T(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),gt.Vertex|E.Focused|E.Unselected),new T(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),E.Selected),new T(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),E.Selected|E.Unfocused),new T(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),E.Selected|E.Focused)];this.enableMidpoints&&l.push(new T(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),gt.Edge|E.Focused|E.Unselected),new T(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),gt.Edge|E.Focused|E.Unselected),new T(this._edgeManipulatorGeometry.instantiate(),gt.Edge|E.Unfocused|E.Unselected),new T(this._edgeManipulatorOutlineGeometry.instantiate(),gt.Edge|E.Unfocused|E.Unselected));let c=new W({view:a,renderObjects:l,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:this.object.visible,metadata:{deleting:!1},location:yn(n)});c.selected=i,this._setTypeSpecificManipulatorSettings(c,t,e);let h=t.type==="edge"?{manipulator:c,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:c,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(h),this.manipulators.add(c),this._updateManipulatorPosition(h),h.type==="edge"){let m=[];for(let f of[h.handle.leftVertex,h.handle.rightVertex]){let _=this._getManipulatorInfoFromHandle(f);_!=null&&m.push(_.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(h)))}h.locationUpdateHandle=J(m),this._manipulatorHandles.add(h.locationUpdateHandle,c)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(c,!0),c);let u=he(c,(m,f,_,S)=>{let w=null,{snappingStep:M,cancelSnapping:P}=Fi({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Hi({editGeometryOperations:r,elevationInfo:e,pointer:S,excludeFeature:this.object.graphic,visualizer:new ht}),updatingHandles:this._updatingHandles,useZ:!1});_=_.next(k=>(this._onDragCancel(!m.metadata.deleting,()=>w=tt(w)),k)).next(P);let{elevationAlignedLocation:X}=m,$=this.object.graphic??void 0;f.next(k=>this._trackNumDragging(k)).next(k=>{if(k.action==="start"&&r&&(w=r.createUndoGroup()),h.type==="edge"){let be=this._splitEdgeManipulator(h);return R(y({},k),{info:be,snapOrigin:be.handle.pos})}return R(y({},k),{info:h,snapOrigin:h.handle.pos})}).next(ti(a,X)).next(gi(a,X,e,n,$)).next(js(a,e,$)).next(...M).next(Ft()).next(k=>{this._perVertexManipulatorDragAction(k),k.action==="end"&&(w=tt(w)),this._resetTooltip()})});return this._manipulatorHandles.add([u,c.events.on("immediate-click",m=>this._manipulatorClickCallback(m,h)),c.events.on("select-changed",()=>{h.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition(),this._resetTooltip()}),c.events.on("focus-changed",()=>{this._resetTooltip()})],c),this.events.emit("manipulators-changed"),h}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&this.undo(),this.tool.snappingManager?.doneSnapping(),this._resetTooltip(),this._reshapeEventState){case q.NONE:break;case q.MOVING:this.events.emit("move",{type:"move",dx:0,dy:0,object:this.object});break;case q.RESHAPING:this.events.emit("reshape",{type:"reshape",object:this.object})}e?.(),this.destroyed||this._updateEventState(q.NONE)}_setTypeSpecificManipulatorSettings(t,e,i){let a=this._settings;switch(e.type){case"vertex":{t.state=gt.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2;let{size:r,collisionPadding:o}=a.manipulators.vertex;t.radius=r/2+o,t.elevationInfo=i;let s=this._operations?.data.type;t.interactive=s!=null&&s!=="point"&&s!=="mesh";break}case"edge":{t.state=gt.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1;let{size:r,collisionPadding:o}=a.manipulators.edge;t.radius=r/2+o,t.elevationInfo=i.mode!=="on-the-ground"||Ts(this.object.graphic?.symbol)?{mode:"absolute-height",offset:0}:i;break}}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>{this._onGrabStateChanged(t,e,i.action,i.pointerType)})}_onGrabStateChanged(t,e,i,a="mouse"){if(!this._recreatingManipulators){if(i==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(q.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(r=>{let{manipulator:o}=r,s=this._operations?.data.type;o.interactive=o.grabbing||!this._numGrabbing&&s!=null&&s!=="point"&&s!=="mesh",Mn(r)&&(r.edgeManipulator.interactive=r.edgeManipulator.grabbing||!this._numGrabbing)}),this._objectMoveManipulation.forEachManipulator(r=>{r.interactive=r.grabbing||!this._numGrabbing}))}}_clearSelection(){for(let t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1);this._pendingEdgeOffsetInfo=null}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.events.emit("manipulators-changed"))}_removeManipulator(t){t!=null&&(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),jn(this._manipulatorInfos,t),this.events.emit("manipulators-changed"),this._resetTooltip())}_getManipulatorInfoFromHandle(t){if(t){for(let e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPositions(t){for(let e of t)this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e))}_updateManipulatorPosition(t){let e=this._operations;if(t!=null&&e){if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,nr),t.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){let i=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(i==null||a==null)return;let r=i.manipulator,o=a.manipulator;if(t.manipulator.elevationInfo?.mode==="on-the-ground"){let s=r.location,n=o.location,l=.5,c=s.x+l*(n.x-s.x),h=s.y+l*(n.y-s.y),u=s.hasZ&&n.hasZ?0:void 0;t.manipulator.location=Ne(c,h,u,e.data.spatialReference)}else ot(Co,r.renderLocation,o.renderLocation,.5),t.manipulator.renderLocation=Co}}}_splitEdgeManipulator(t,e=.5){let i=this._operations,a=i.splitEdge(t.handle,e).createdVertex;t.locationUpdateHandle=tt(t.locationUpdateHandle);let r=this.object.elevationInfo,o;this.enableEdgeOffset?(this._removeManipulator(t),o=this._createVertexOrEdgeManipulator(a)):(o=t,o.handle=a,o.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,r)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this._updateManipulatorPosition(o),this.enableEdgeOffset||this._resetTooltip(),this._updateSelection(t.manipulator);let s=this._updateEventState(q.RESHAPING),n=i.data.coordinateHelper.vectorToArray(o.handle.pos),l=i.data.components.indexOf(a.component);return this.events.emit("vertex-add",{type:"vertex-add",object:this.object,vertices:[{coordinates:n,componentIndex:l,vertexIndex:a.index}],added:n}),s&&this._updateEventState(q.NONE),o}_updateMoveManipulationPosition(){let t=C(Co,0,0,0),e=0,i=!1,a=null,r=null;for(let n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected?(e++,j(t,t,n.manipulator.renderLocation),a==null||n.selectedIndex>a.selectedIndex?(r=a,a=n):(r==null||n.selectedIndex>r.selectedIndex)&&(r=n)):i=!0);let o=this.object,s=this._operations?.data.geometry;if(e===0){let n=o.visible&&this.enableMoveObject;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n,this._moveManipulation.zManipulation.available=n&&this.enableZShape&&ut(this._operations,o.elevationInfo),this._moveManipulation.angle=ar(s),this._moveManipulation.radius=et.radiusForSymbol(o.graphic?.symbol)}else{let n=o.visible;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.zManipulation.available=n&&this.enableZVertex&&ut(this._operations,this.object.elevationInfo),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n&&e!==1;let l=0;if(a!=null){let c=a.handle.pos,h=r!=null?r.handle.pos:a.handle.leftEdge?.leftVertex?a.handle.leftEdge.leftVertex.pos:null,u=r==null&&a.handle.rightEdge?.rightVertex?a.handle.rightEdge.rightVertex.pos:null;h&&u?this._moveManipulation.xyAxisManipulation.available=!1:h?l=Hh(h,c):u&&(l=Hh(c,u))}this._moveManipulation.angle=l,this._moveManipulation.radius=vo}e!==0&&i?(B(t,t,1/e),nr.spatialReference=this._operations.data.spatialReference,nr.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,nr),this._moveManipulation.elevationAlignedLocation=nr):this._outlineVisualElement==null||this.object.isDraped||this._outlineVisualElement.attachmentOrigin==null?Ro(this._moveManipulation,this.object):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(t){let e=new Array,i=this._operations;if(i){for(let a of t){let r=a.handle.component;if(a.type==="vertex"&&i.canRemoveVertex(r)){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));let o=i.removeVertices([a.handle]),s=o.removedVertices?.[0].createdEdge;s?this._createVertexOrEdgeManipulator(s):this.enableEdgeOffset&&r.vertices.length<=2&&this._removeManipulator(this._getManipulatorInfoFromHandle(r.edges[0]))}}if(e.length>0){let a=e.map(o=>{let s=i.data.components.indexOf(o.component);return{coordinates:i.data.coordinateHelper.vectorToArray(o.pos),componentIndex:s,vertexIndex:o.index}}),r=this._updateEventState(q.RESHAPING);if(this.destroyed||(this.events.emit("vertex-remove",{type:"vertex-remove",object:this.object,removed:a.map(o=>o.coordinates),vertices:a}),this.destroyed)||r&&(this._updateEventState(q.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}}_moveVertices(t,e,i=e.action==="start"?Oe.NEW_STEP:Oe.ACCUMULATE_STEPS){let a=this._operations;if(a){t.length>0&&a.moveVertices(t.map(r=>r.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);for(let r of t)this._updateManipulatorPosition(r)}}_offsetEdge(t,e,i){if(!this._operations)return;let a=e.clone();a.distance=i,this._operations.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,this.enableDeleteVertices&&t.button===Rs.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Rs.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){this._defaultTooltipInfo!=null?this._resetTooltip():this._updateTranslateObjectTooltip(t,e)}_updateTranslateObjectTooltip(t,e){this._pendingEdgeOffsetInfo||(this.activeTooltipInfo=Vh(t,e,this._tooltipsContext))}_updateEdgeOffsetTooltip(t){this._pendingEdgeOffsetInfo||(this.activeTooltipInfo=bn(this.object,t,this._tooltipsContext))}_resetTooltip(){let t=this.activeTooltipInfo;if(this._pendingEdgeOffsetInfo&&t?.type==="reshape-edge-offset")return;let e=null;e=this._pendingEdgeOffsetInfo||this._findActiveEdgeOffsetManipulatorInfo()!=null?bn(this.object,null,this._tooltipsContext):this._defaultTooltipInfo,e!==t&&(t!=null&&e!=null&&this.tooltip.mode==="input"||(this.activeTooltipInfo=e))}get _defaultTooltipInfo(){switch(this._operations?.data.type){case"polyline":case"polygon":return this._selectedVertexManipulatorInfo?this.tooltipInfos.selectedVertex:null;case"point":case"mesh":return this.tooltipInfos.movePoint;default:return null}}get _selectedVertexManipulatorInfo(){let t=this._manipulatorInfos.filter(e=>e.type==="vertex"&&e.manipulator.selected);return t.length===1?t[0]:null}get _tooltipsContext(){return{sketchOptions:this._sketchOptions,tooltipInfos:this.tooltipInfos,activeTooltipInfo:this.activeTooltipInfo,selectedVertexManipulatorInfo:this._selectedVertexManipulatorInfo,callbacks:this._tooltipCallbacks}}get test(){}};function _u(){return t=>{let{operation:e,mapEnd:i}=t;return e==null||i==null?t:R(y({},t),{signedDistance:e.signedDistanceToPoint(i)})}}function zh(t){let e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}function Hh(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function yn(t){return new Ie({x:0,y:0,z:0,spatialReference:t})}function Mn(t){return t.type==="edge"&&"edgeManipulator"in t}p([d()],ee.prototype,"_numGrabbing",void 0),p([d()],ee.prototype,"_numDragging",void 0),p([d()],ee.prototype,"_pendingEdgeOffsetInfo",void 0),p([d()],ee.prototype,"_operations",null),p([d()],ee.prototype,"_segmentLabels",void 0),p([d({constructOnly:!0})],ee.prototype,"tool",void 0),p([d()],ee.prototype,"tooltip",void 0),p([d()],ee.prototype,"activeTooltipInfo",void 0),p([d({readOnly:!0})],ee.prototype,"updating",null),p([d()],ee.prototype,"manipulators",null),p([d()],ee.prototype,"view",null),p([d()],ee.prototype,"object",null),p([d()],ee.prototype,"enableZShape",null),p([d()],ee.prototype,"enableDeleteVertices",null),p([d()],ee.prototype,"enableZVertex",null),p([d()],ee.prototype,"autoHideManipulators",null),p([d()],ee.prototype,"enableMoveObject",null),p([d()],ee.prototype,"enableMidpoints",null),p([d()],ee.prototype,"enableEdgeOffset",null),p([d()],ee.prototype,"_sketchOptions",null),p([d()],ee.prototype,"_accentColor",null),p([d()],ee.prototype,"_tooltipsContext",null),ee=p([D("esri.views.3d.interactive.editingTools.reshape.ReshapeOperation")],ee);var nr=Ne(0,0,void 0,Qn.WGS84),Co=g(),Fh=1e-6,gt,q,Ta;(function(t){t.Vertex=le.Custom1,t.Edge=le.Custom2})(gt||(gt={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(q||(q={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Ta||(Ta={}));var de=class extends ei{constructor(t){super(t),this._reshapeOperation=null,this.events=new oe,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveObject=!0,this.enableDeleteVertices=!0,this.autoHideManipulators=!1,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.sketchOptions=new Qe,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){let t=this._reshapeOperation=new ee({tool:this});this.addHandles([t.events.on("reshape",e=>this.events.emit("reshape",e)),t.events.on("move",e=>this.events.emit("move",e)),t.events.on("vertex-add",e=>this.events.emit("vertex-add",e)),t.events.on("vertex-remove",e=>this.events.emit("vertex-remove",e)),t.events.on("immediate-click",e=>this.events.emit("immediate-click",R(y({},e),{object:this.object}))),this.view.on("pointer-down",["Shift"],e=>e.stopPropagation())]),this.finishToolCreation()}destroy(){this._reshapeOperation=N(this._reshapeOperation)}get updating(){return((this.object.updating??!1)||this._reshapeOperation?.updating)??!1}get activeTooltipInfo(){return this._reshapeOperation?.activeTooltipInfo??null}get tooltip(){return this._reshapeOperation?.tooltip??null}onManipulatorSelectionChanged(){this._reshapeOperation?.onManipulatorSelectionChanged()}get canUndo(){return this._reshapeOperation?.canUndo??!1}undo(){this.snappingManager?.doneSnapping(),this._reshapeOperation?.undo()}get canRedo(){return this._reshapeOperation?.canRedo??!1}redo(){this.snappingManager?.doneSnapping(),this._reshapeOperation?.redo()}onInputEvent(t){let e=this._reshapeOperation;e&&!e.enterInputModeIfAvailable(t)&&this.enableDeleteVertices&&t.type==="key-down"&&Gc.delete.includes(t.key)&&e.removeSelectedVertices()>0&&t.stopPropagation()}reset(){}};p([d()],de.prototype,"_reshapeOperation",void 0),p([d()],de.prototype,"view",void 0),p([d({constructOnly:!0})],de.prototype,"object",void 0),p([d()],de.prototype,"enableZShape",void 0),p([d()],de.prototype,"enableZVertex",void 0),p([d()],de.prototype,"enableMoveObject",void 0),p([d()],de.prototype,"enableDeleteVertices",void 0),p([d()],de.prototype,"autoHideManipulators",void 0),p([d()],de.prototype,"enableMidpoints",void 0),p([d()],de.prototype,"enableEdgeOffset",void 0),p([d()],de.prototype,"type",void 0),p([d({type:Qe})],de.prototype,"sketchOptions",void 0),p([d()],de.prototype,"snappingManager",void 0),p([d()],de.prototype,"updating",null),p([d()],de.prototype,"activeTooltipInfo",null),p([d()],de.prototype,"tooltip",null),p([d()],de.prototype,"automaticManipulatorSelection",void 0),de=p([D("esri.views.3d.interactive.editingTools.reshape.ReshapeTool3D")],de);var ze=class extends Te{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([it(()=>{let t=this._interactionState;return t&&t.angle!==t.previousAngle?{interactionState:t,angle:t.state.angle}:null},({interactionState:t})=>{this._updateMeshRotation(t)},at),it(()=>{let t=this._interactionState;return t&&t.scale!==t.previousScale?{interactionState:t,scale:t.state.scale}:null},({interactionState:t})=>{this._updateMeshSize(t)},at)])}get geometry(){let t=Z(this.object);return t?.type==="mesh"?t:null}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){let t=this.geometry?.transform;if(t==null)return this._interactionState?.angle??0;let e=t.rotation[2];return Math.abs(e)>.999999?ne(Sl(t.rotation))*Math.sign(e):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){let t=new Ut({angle:this.angle});this._interactionState=t;let e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return this.object.createUndoRecord()}_updateMeshRotation(t){let{geometry:e}=this;if(e==null)return;let{angle:i,previousAngle:a}=t;t.previousAngle=i;let r=vt(i-a);e.rotate(0,0,r)}_updateMeshSize(t){let{geometry:e}=this;if(e==null)return;let{scale:i,previousScale:a}=t;t.previousScale=i;let r=i/a;e.scale(r)}};p([d({constructOnly:!0})],ze.prototype,"object",void 0),p([d()],ze.prototype,"geometry",null),p([d({constructOnly:!0})],ze.prototype,"viewingMode",void 0),p([d()],ze.prototype,"initialAngle",null),p([d()],ze.prototype,"angle",null),p([d()],ze.prototype,"angleClockwise",null),p([d()],ze.prototype,"relativeAngle",null),p([d()],ze.prototype,"relativeAngleClockwise",null),p([d()],ze.prototype,"scale",null),p([d()],ze.prototype,"_interactionState",void 0),ze=p([D("esri.views.3d.interactive.editingTools.transform.ScaleRotateMeshAdapter")],ze);var Ut=class extends Te{get state(){let{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};p([d()],Ut.prototype,"angle",void 0),p([d()],Ut.prototype,"initialAngle",void 0),p([d()],Ut.prototype,"previousAngle",void 0),p([d()],Ut.prototype,"previousScale",void 0),p([d()],Ut.prototype,"scale",void 0),p([d()],Ut.prototype,"state",null),Ut=p([D("esri.views.3d.interactive.editingTools.transform.ScaleRotateMeshAdapter.InteractionState")],Ut);var pe=class extends Te{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(it(()=>this._interactionState!=null?this._interactionState.state:null,t=>{this._updateSymbol(t)},at))}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?vu(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}get size(){let t=this._sizeReferenceSymbolLayer;if(t==null)return null;let e=this.findLayerView(),i=this._graphicSymbol;if(e==null||i==null||i.type!=="point-3d")return null;let a=e.getSymbolLayerSize(i,t);if("size"in a&&a.size!=null)return a.size;let r=this.sizeAxis;return!("width"in a)||a.width==null||r!=null&&r!=="width"&&r!=="all"&&r!=="width-and-depth"?!("depth"in a)||t.depth==null||r!=null&&r!=="depth"&&r!=="all"&&r!=="width-and-depth"?!("height"in a)||t.height==null||r!=null&&r!=="height"&&r!=="all"?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){let t=this._graphicSymbol;return t==null||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){let t=this._graphicSymbol;return t==null||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&e.heading!=null)}get _graphicSymbol(){return this.graphic?.symbol!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){let t=this._graphicSymbol,e=this.findLayerView();if(this._interactionState!=null||t==null||e==null)return bu;let i=t.symbolLayers.map(n=>n.type==="object"?e.getSymbolLayerSize(t,n):null).toArray(),a=t.clone(),r=this.angle,o=new Zt({originalSymbol:a,angle:r,initialSizes:i});this._interactionState=o;let s=()=>{this._interactionState=null};return{state:o,done:s,cancel:()=>{this._graphicSymbol=a,s()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){let r=this._graphicSymbol;if(r==null||r.type!=="point-3d")return;let o=r.clone(),s=-vt(e-this.initialAngle),n=!1;this._forEachObjectSymbolLayerPair(i,o,(l,c,h)=>{let u=(l.heading??0)+s;c.heading!==u&&(c.heading=u,n=!0);let m=a[h];if(m!=null&&"width"in m){m.width=this.sizeFilter(m.width),m.height=this.sizeFilter(m.height),m.depth=this.sizeFilter(m.depth);let f=m.width*t;c.width!==f&&(c.width=f,n=!0);let _=m.depth*t;c.depth!==_&&(c.depth=_,n=!0);let S=m.height*t;c.height!==S&&(c.height=S,n=!0)}}),n&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((a,r)=>{let o=e.symbolLayers.at(r);a.type==="object"&&o.type==="object"&&i(a,o,r)})}};function vu(t){return-ne(t)}p([d()],pe.prototype,"initialAngle",null),p([d()],pe.prototype,"angle",null),p([d()],pe.prototype,"angleClockwise",null),p([d()],pe.prototype,"orientation",null),p([d()],pe.prototype,"orientationClockwise",null),p([d()],pe.prototype,"relativeAngle",null),p([d()],pe.prototype,"relativeAngleClockwise",null),p([d()],pe.prototype,"scale",null),p([d()],pe.prototype,"size",null),p([d()],pe.prototype,"sizeAxis",void 0),p([d({constructOnly:!0})],pe.prototype,"graphic",void 0),p([d()],pe.prototype,"_interactionState",void 0),p([d({constructOnly:!0})],pe.prototype,"findLayerView",void 0),p([d({constructOnly:!0})],pe.prototype,"sizeFilter",void 0),p([d()],pe.prototype,"_sizeReferenceSymbolLayer",null),p([d()],pe.prototype,"_orientationReferenceSymbolLayer",null),p([d()],pe.prototype,"_graphicSymbol",null),pe=p([D("esri.views.3d.interactive.editingTools.transform.ScaleRotateObjectSymbol3DAdapter")],pe);var bu={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}},Zt=class extends Te{get state(){let{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:r}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:r}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}};p([d()],Zt.prototype,"originalSymbol",void 0),p([d()],Zt.prototype,"angle",void 0),p([d()],Zt.prototype,"initialAngle",void 0),p([d()],Zt.prototype,"initialSizes",void 0),p([d()],Zt.prototype,"scale",void 0),p([d()],Zt.prototype,"state",null),Zt=p([D("esri.views.3d.interactive.editingTools.transform.ScaleRotateObjectSymbol3DAdapter.InteractionState")],Zt);var F;(function(t){t.ScaleIn=le.Custom2,t.ScaleOut=le.Custom3,t.RotateLeft=le.Custom4,t.RotateRight=le.Custom5,t.Unlocked=le.Custom7,t.DelayedFocused=le.Custom8,t.TouchInput=le.Custom12})(F||(F={}));var Dt=class extends Te{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}get updating(){return!!this._activeAnimation}constructor(t){super(t),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=gh,this.events=new oe,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>this._scaleRotateDragData?.mode==="scale"?this.adapter.scale:1}initialize(){this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([v(()=>{let{adapter:t}=this;return[t.angle,t.scale]},()=>this._updateManipulatorTransform())])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null}startAnimation(t){this.cancelActiveAnimation(),t.start();let e=Gn({update:({deltaTime:i})=>{t.update(i)&&this.cancelActiveAnimation()}});this._activeAnimation=R(y({},t),{frameTask:e})}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=N(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,I.SCALE_ROTATE)}_createManipulator(){let t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);let e=this.tool.object,i=he(t,(a,r,o)=>{this._scaleRotateDragData=null;let s=this.adapter.startInteraction(),n={mode:"none",origin:We(a.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=n,this._updateDragState();let l=b.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,l),r.next($i(this.tool.view,ke(a.renderLocation,l,bt()))).next(c=>{let h=c.plane,u=xo(c.renderStart,c.renderEnd,n.origin,h),m=Fn.shortestSignedDiff(n.angle,u);n.angleDir=wi(n.angleDir+m,-.3,fh),n.angle=u;let f=yu(n,c),_=f-this.adapter.scale;if(n.scaleDir=wi(n.scaleDir+_,-.2,mh),this._onScaleChanged(),n.mode==="none"){let S=this.mode||Mu(c,c.plane,n.origin,this.tool.view.state.camera);if(S!=null){switch(S){case"rotate":this.tool.events.emit("rotate-start",{object:e,angle:0}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]});break;case"scale":this.tool.events.emit("scale-start",{object:e,xScale:1,yScale:1}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]})}n.mode=S}}switch(n.mode){case"rotate":s.state.angle=n.initialAngle+u;break;case"scale":s.state.scale=f,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),c.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.events.emit("rotate",{object:e,angle:vt(n.angle)});break;case"scale":this.tool.events.emit("scale",{object:e,xScale:f,yScale:f})}break;case"end":switch(n.mode){case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:vt(n.angle)});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:f,yScale:f})}}return c.action==="end"&&(this.startAnimation(kh(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),s.done()),c}),o.next(()=>{if(s.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:0});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:1,yScale:1})}this.startAnimation(kh(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}})});this.addHandles([i,t.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(Su(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),t.events.on("immediate-click",a=>{a.stopPropagation()}),v(()=>this.tool.object.visible,a=>this._ringManipulator.available=a,L)])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(F.DelayedFocused,this.getFocused())}_updateDragState(){if(this._ringManipulator.updateStateEnabled(F.Unlocked,!(this._scaleRotateDragData!=null&&this._scaleRotateDragData?.mode!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(F.ScaleIn|F.ScaleOut,!1),this._ringManipulator.updateStateEnabled(F.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(F.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(F.RotateLeft|F.RotateRight,!1),this._ringManipulator.updateStateEnabled(F.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(F.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(F.ScaleIn|F.ScaleOut|F.RotateLeft|F.RotateRight,!1)}_updateManipulatorTransform(){let t=vr(K.get(),this.adapter.angle,G(0,0,1));if(t==null)return;let e=this.getScale(),i=Di(K.get(),C(b.get(),e,e,e));this._ringManipulator.modelTransform=Le(K.get(),i,t)}_createRingManipulator(){let t=(V,ue,De)=>{let Bt=[],Wt=Math.ceil(128*(ue-V)/(2*Math.PI));for(let we=0;we<Wt+1;we++){let Ia=V+we*(ue-V)/Wt;Bt.push(G(De*Math.cos(Ia),De*Math.sin(Ia),0))}return Bt},e=V=>t(0,2*Math.PI,V),i=V=>[[-V/2,0],[V/2,0],[V/2,bo/2],[-V/2,bo/2]],a=this._createMaterial(1),r=(V,ue,De=a)=>Nr(De,i(ue),V,[],[],!1),o=e(fi),s=r(o,yo),n={left:new Array,right:new Array},l=[];for(let V=0;V<2;V++){let ue=V*Math.PI-Math.PI/4,De=Math.PI/2-dh,Bt=ue+De,Wt=ue+Math.PI/2-De,we=t(Bt,Wt,ch),Ia=r(we,Qi);l.push(we),l.push(t(Bt,Wt,an-yo/2)),n.left.push(Ia),n.right.push(Ia.instantiate());for(let Qo=0;Qo<2;Qo++){let In=Qo===0,Fe=re();if(In){It(Fe,Fe,[1,-1,1]),es(Fe,Fe,-Bt,[0,0,1]);let Oi=Math.round(on*(we.length-1));Fe[12]=we[Oi][0],Fe[13]=we[Oi][1],Fe[14]=we[Oi][2]}else{es(Fe,Fe,Wt,[0,0,1]);let Oi=Math.round((1-on)*(we.length-1));Fe[12]=we[Oi][0],Fe[13]=we[Oi][1],Fe[14]=we[Oi][2]}let Cn=Gi(a,ph,0,hh,bo);Ur(Cn,Fe),(In?n.left:n.right).push(Cn)}}let c=[];for(let V=0;V<2;V++){let ue=V*Math.PI-Math.PI/4,De=Math.PI/2-uh,Bt=ue+De,Wt=ue+Math.PI/2-De,we=t(Bt,Wt,an);c.push(r(we,Qi))}let h=this._createMaterial(.66),u=this._createMaterial(.5),m=this._createMaterial(.33),f=e(fi+sn),_=e(fi+nn),S=r(f,Qi,h),w=r(_,Qi,m),M=e(fi-sn),P=e(fi-nn),X=r(M,Qi,h),$=r(P,Qi,m),k=[new T(s,F.DelayedFocused),new T(s.instantiate({material:u}),E.None)];this.mode&&this.mode!=="scale"||(k=k.concat([...c.map(V=>new T(V,F.DelayedFocused|F.Unlocked)),new T(S,F.DelayedFocused|F.ScaleIn),new T(w,F.DelayedFocused|F.ScaleIn),new T(X,F.DelayedFocused|F.ScaleOut),new T($,F.DelayedFocused|F.ScaleOut)])),this.mode&&this.mode!=="rotate"||(k=k.concat([...n.right.map(V=>new T(V.instantiate(),F.DelayedFocused|F.Unlocked)),...n.left.map(V=>new T(V,F.DelayedFocused|F.RotateLeft)),...n.right.map(V=>new T(V,F.DelayedFocused|F.RotateRight))]));let be=[o,...l];return new W({view:this.tool.view,renderObjects:k,autoScaleRenderObjects:!1,worldOriented:!0,radius:yo,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:this.tool.object.elevationInfo,collisionType:{type:"ribbon",paths:be,direction:G(0,0,1)}})}_createMaterial(t){let e=new Ee({cullFace:Q.Back,renderOccluded:O.Transparent,isDecoration:!0});return this.addHandles(v(()=>os(this.tool.view.effectiveTheme.accentColor,t),i=>e.setParameters({color:i}),L)),e}get test(){}};function yu(t,e){let i=A(b.get(),e.renderStart,t.origin),a=A(b.get(),e.renderEnd,t.origin),r=Ce(i),o=Ce(a);return r===0?0:o/r}function Mu(t,e,i,a){let{renderStart:r,renderEnd:o}=t,s=jo(r,a,b.get()),n=jo(o,a,b.get());if(Sr(s,n)<rn*rn)return null;let l=A(b.get(),r,i),c=me(b.get(),l,e),h=r,u=j(b.get(),h,c),m=jo(i,a,b.get()),f=s,_=jo(u,a,b.get()),S=A(b.get(),_,f),w=A(b.get(),s,m),M=Fa(f,S),P=Fa(m,w);return fs(M,n)<fs(P,n)?"rotate":"scale"}function jo(t,e,i){return e.projectToScreen(t,Sn),C(i,Sn[0],Sn[1],0)}var xa;function kh(t,e){let i=null,a=1,r=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=r,e()},update:o=>(a+=((a+1)/2-a)*Math.min(o*_h,1),e(),Math.abs(a-1)<.01?xa.STOP:xa.CONTINUE),destroy:()=>{i&&(t.getScale=i),e()}}}function Su(t,e,i){let a=0,r=null,o=()=>!1;return{start:()=>{r=t.getFocused,t.getFocused=o,a=0,e()},update:s=>(a+=s,!r?.()||a>=i.delayMs?xa.STOP:xa.CONTINUE),destroy:()=>{r&&(t.getFocused=r),e()}}}p([d({constructOnly:!0})],Dt.prototype,"tool",void 0),p([d({constructOnly:!0})],Dt.prototype,"adapter",void 0),p([d({constructOnly:!0})],Dt.prototype,"sketchOptions",void 0),p([d()],Dt.prototype,"mode",void 0),p([d()],Dt.prototype,"_activeAnimation",void 0),p([d()],Dt.prototype,"updating",null),Dt=p([D("esri.views.3d.interactive.editingTools.transform.ScaleRotateTransform")],Dt),function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(xa||(xa={}));var Sn=ge();var Ra=class extends Yr(Ot){constructor(t){super(t),this.type="transform-mesh",this.orientation=Wr(),this.scale=Bc(),this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get key(){return{longitude:this.longitude.actual,latitude:this.latitude.actual,x:this.x.actual,y:this.y.actual,elevation:this.elevation.actual,geographic:this.geographic,orientation:this.orientation.actual,scale:this.scale.actual}}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};p([d()],Ra.prototype,"key",null),p([d()],Ra.prototype,"allFields",null),Ra=p([D("esri.views.interactive.tooltip.infos.TransformMeshTooltipInfo")],Ra);var lr=class extends Yr(Ot){constructor(t){super(t),this.type="transform-point",this.orientation=Wr({readOnly:!0}),this.size=Zc({readOnly:!0}),this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.size]}};p([d()],lr.prototype,"allFields",null),lr=p([D("esri.views.interactive.tooltip.infos.TransformPointTooltipInfo")],lr);var He=class extends ei{constructor(t){super(t),this.events=new oe,this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.sketchOptions=new Qe,this.type="transform-3d",this._updatingHandles=new Jt,this._scaleRotate=null}initialize(){let{events:t,object:e,view:i}=this;this.tooltip=Kt(()=>({view:i,options:this.sketchOptions.tooltips})),this._moveManipulation=new et({tool:this,view:i,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&ut(e.operations,e.elevationInfo),radius:et.radiusForSymbol(e.graphic?.symbol)}),this._moveManipulation.forEachManipulator(l=>this.addHandles(l.events.on("immediate-click",c=>{t.emit("immediate-click",R(y({},c),{object:this.object})),c.stopPropagation()})));let a=e.elevationInfo;if(this._moveManipulation.elevationInfo=a,this.addHandles(_a(e)),this._moveManipulation.createManipulatedObjectDragPipeline((l,c,h,u,m)=>{if(l===Y.XY){let{snappingStep:f,cancelSnapping:_}=Fi({snappingContext:new Hi({elevationInfo:a,pointer:m,editGeometryOperations:ca.fromGeometry(new Ie({spatialReference:e.operations?.data.spatialReference}),i.state.viewingMode),visualizer:new ht,excludeFeature:e.graphic}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});u=u.next(_),h=h.next(ap(this.view,a)).next(...f)}return{steps:h,cancel:u}},e,l=>{let{action:c,object:h,dxScreen:u,dyScreen:m}=l,f={object:h,dxScreen:u,dyScreen:m};switch(c){case"start":this._emitRecordUndo(),t.emit("translate-start",f);break;case"update":t.emit("translate",f);break;case"end":t.emit("translate-stop",f)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(v(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){let l=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Dt({tool:this,mode:l,adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.addHandles([mi({view:this.view,object:e,forEachManipulator:l=>this._forEachManipulator(l),onManipulatorsChanged:()=>H()}),e.on("committed",()=>this._onGeometryChanged()),this._hideManipulatorsForObjectState(),v(()=>i.scale,()=>this._updateMoveAngle())].filter(ur)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(l=>{l instanceof W&&this.addHandles(l.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))});let r=i?.type,{sketchOptions:o}=this;this._meshTooltipInfo=new Ra({viewType:r,sketchOptions:o}),this._pointTooltipInfo=new lr({viewType:r,sketchOptions:o});let s={object:e,dxScreen:0,dyScreen:0},n={onBeforeUpdate:()=>this.endDrag(),onMoveStart:()=>{this._emitRecordUndo(),t.emit("translate-start",y({},s))},onMove:()=>t.emit("translate",y({},s)),onMoveStop:()=>t.emit("translate-stop",y({},s)),onRotateStart:l=>{this._emitRecordUndo(),t.emit("rotate-start",{object:e,angle:l})},onRotate:l=>t.emit("rotate",{object:e,angle:l}),onRotateStop:l=>t.emit("rotate-stop",{object:e,angle:l}),onScaleStart:(l,c)=>{this._emitRecordUndo(),t.emit("scale-start",{object:e,xScale:l,yScale:c})},onScale:(l,c)=>t.emit("scale",{object:e,xScale:l,yScale:c}),onScaleStop:(l,c)=>t.emit("scale-stop",{object:e,xScale:l,yScale:c})};this.addHandles(mo(this.tooltip,this.object,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this.activeTooltipInfo,callbacks:n,scaleRotateTransform:this._scaleRotate}))),this.finishToolCreation()}destroy(){this.tooltip.destroy(),this._moveManipulation.destroy(),this._scaleRotate=N(this._scaleRotate),this._scaleRotateAdapter=N(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("object",null)}onInputEvent(t){if(!this.destroyed&&!zi(t,this.tooltip))return super.onInputEvent(t)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return Z(this.object)?.type==="mesh"?new ze({object:this.object,viewingMode:this.view.state.viewingMode}):new pe({graphic:this.object.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find(e=>e.layer===this.object.graphic?.layer),sizeAxis:this.sketchOptions?.tooltips?.visualVariables?.size?.axis??null})}_forEachManipulator(t){this._moveManipulation?.forEachManipulator(t),this._scaleRotate?.forEachManipulator(t)}_hideManipulatorsForObjectState(){return v(()=>this.object.visible,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&ut(this.object.operations,this.object.elevationInfo)})}_emitRecordUndo(){this.events.emit("record-undo",{updates:[this.object.createUndoRecord()]})}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}get activeTooltipInfo(){return Z(this.object)?.type==="mesh"?this._meshTooltipInfo:this._pointTooltipInfo}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){let{view:t}=this,e=t.state.viewingMode===Lt.Local||t.scale<vh;this._moveManipulation.angle=e?this._scaleRotateAdapter.angle:0}_onGeometryChanged(){Ro(this,this.object)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){}};p([d({constructOnly:!0,nonNullable:!0})],He.prototype,"view",void 0),p([d({constructOnly:!0,nonNullable:!0})],He.prototype,"object",void 0),p([d({constructOnly:!0,nonNullable:!0})],He.prototype,"enableZ",void 0),p([d()],He.prototype,"enableRotation",void 0),p([d()],He.prototype,"enableScaling",void 0),p([d({constructOnly:!0,type:Qe})],He.prototype,"sketchOptions",void 0),p([d({value:!1})],He.prototype,"snapToScene",null),p([d({constructOnly:!0})],He.prototype,"snappingManager",void 0),p([d({readOnly:!0})],He.prototype,"type",void 0),p([d({readOnly:!0})],He.prototype,"updating",null),p([d()],He.prototype,"activeTooltipInfo",null),He=p([D("esri.views.3d.interactive.editingTools.transform.TransformTool3D")],He);var Mi=class extends Hn.ClonableMixin(kn){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&Vn(this.position,t.position)&&this.width===t.width&&this.height===t.height}};p([d({readOnly:!0,json:{read:!1,write:!0}})],Mi.prototype,"type",void 0),p([d({type:Ie}),sa()],Mi.prototype,"position",void 0),p([d({type:Number,nonNullable:!0,range:{min:0,max:360}}),sa(),Ko(t=>Jo.normalize($o(t),0,!0))],Mi.prototype,"heading",void 0),p([d({type:Number,nonNullable:!0,range:{min:0,max:360}}),sa(),Ko(t=>Jo.normalize($o(t),0,!0))],Mi.prototype,"tilt",void 0),p([d({type:Number,nonNullable:!0}),sa()],Mi.prototype,"width",void 0),p([d({type:Number,nonNullable:!0}),sa()],Mi.prototype,"height",void 0),Mi=p([D("esri.analysis.SlicePlane")],Mi);var Ou=se(0,0,0,.04);var OD=dr("mac")?"Meta":"Control";var Nh=2,Uh=1.15,Zh=1.15;var Eu=Math.cos(ne(45)),wu=Math.cos(ne(5));var Bh=3,On=11,Lo=22.5,cr=40,Wh=48,Yh=2.25,Xh=4,En=1,qh=.3,Qh=6,$h=4;var zD=re();var xu=new Lr;function td(t,e){return un(t.basis1,t.basis2,t.origin,e)}function id(t,e,i,a){let r=e.worldUpAtPosition(t.origin,b.get()),o=b.get();switch(i){case Aa.HEADING:z(o,r);break;case Aa.TILT:z(o,t.basis1)}return ke(t.origin,o,a)}function ad(t,e,i,a){let r=Ce(a.basis1),o=Ce(a.basis2),s=rd(a),n=Vo(a),l=C(b.get(),0,0,0);j(l,B(b.get(),a.basis1,e.direction[0]),B(b.get(),a.basis2,e.direction[1])),j(l,a.origin,l);let c=0,h=1;if(Ji(e))e.direction[0]===1&&e.direction[1]===-1?c=ed:e.direction[0]===1&&e.direction[1]===1?c=Math.PI:e.direction[0]===-1&&e.direction[1]===1&&(c=3*Math.PI/2),h=n;else{let m=e.direction[0]!==0?1:2;c=m===1?ed:0,h=(m===1?o:r)-s}let u=br(K.get(),c);It(u,u,C(b.get(),h,h,h)),Le(u,i,u),u[12]=0,u[13]=0,u[14]=0,t.modelTransform=u,t.renderLocation=l}var Jh;function rd(t){let e=Ce(t.basis1),i=Ce(t.basis2);return qh*Math.min(e,i)}function Vo(t){return rd(t)}function Ji(t){return t.direction[0]!==0&&t.direction[1]!==0}(function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"})(Jh||(Jh={}));var Pt=le.Custom1,Aa,Kh;(function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"})(Aa||(Aa={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(Kh||(Kh={}));var pr=le.Custom2,v1=Mt(),ed=Math.PI/2,Da=le.Custom1,Go=le.Custom2;var hr;(function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(hr||(hr={}));var zo=class extends W{constructor(e,i){let a=new ce({width:1,renderOccluded:O.OccludeAndTransparent,isDecoration:!0}),r=new Ee({cullFace:Q.Back,renderOccluded:O.Opaque,isDecoration:!0}),o=new Ee({cullFace:Q.Back,renderOccluded:O.Opaque,isDecoration:!0}),s=new Ee({cullFace:Q.Back,renderOccluded:O.Opaque,isDecoration:!0}),n=new Ee({writeDepth:!1,cullFace:Q.Front,renderOccluded:O.Transparent,isDecoration:!0});super(y({view:e},Ru({offsetMode:i,tubeMaterial:r,tipMaterial:o,capMaterial:s,outlineMaterial:n,calloutMaterial:a}))),this._themeHandle=v(()=>e.effectiveTheme.accentColor,l=>{let c=qt(l),h=U.toUnitRGBA(l),u=U.toUnitRGBA(c),m=U.toUnitRGBA(U.blendColors(c,l,.4)),f=U.toUnitRGBA(U.blendColors(c,l,.14));a.setParameters({color:h}),r.setParameters({color:f}),o.setParameters({color:u}),s.setParameters({color:m}),n.setParameters({color:h})},L)}destroy(){this._themeHandle.remove(),super.destroy()}};function Ru({offsetMode:t,tubeMaterial:e,tipMaterial:i,capMaterial:a,outlineMaterial:r,calloutMaterial:o}){let s=t===hr.CENTER_ON_CALLOUT?cr:0,n=[G(s,0,-24),G(s,0,Wh/2)],l=Du(n),c=od({vertices:n,padding:0,materials:{tube:e,tip:i,cap:a}}),h=od({vertices:n,padding:Yh,materials:{tube:r,tip:r,cap:r}}),u=Se(o,[[s,0,0],[s-cr,0,0]]),m=Se(o,[[s,0,0],[s-cr,0,0]]);return{renderObjects:[...c.normal.map(f=>new T(f,E.Unfocused|Pt)),...h.normal.map(f=>new T(f,E.Unfocused|Pt)),new T(u,E.Unfocused|Pt|pr),...c.focused.map(f=>new T(f,E.Focused|Pt)),...h.focused.map(f=>new T(f,E.Focused|Pt)),new T(m,E.Focused|Pt|pr)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[l]},collisionPriority:1,radius:On,state:Pt}}function od({vertices:t,padding:e,materials:i}){let a=r=>{let o=t.slice(),s=A(b.get(),o[0],o[1]);ie(s,s);let n=A(b.get(),o[o.length-1],o[o.length-2]);if(ie(n,n),e>0){let V=B(g(),n,-e);o[o.length-1]=j(V,V,o[o.length-1]);let ue=B(g(),s,-e);o[0]=j(ue,ue,o[0])}let l=r?Zh:1,c=Lo*l,h=On*l,u=La(K.get());if(e>0){let V=c/4,ue=C(b.get(),0,V,0),De=1+e/V;Va(u,u,ue),It(u,u,C(b.get(),De,De,De)),Va(u,u,B(ue,ue,-1/De))}let m=La(re()),f=G(0,1,0),_=is(re(),ps(ds.get(),f,n));_[12]=o[o.length-1][0],_[13]=o[o.length-1][1],_[14]=o[o.length-1][2],Le(_,_,u);let S=i.tube,w=Au(Bh*(r?Uh:1)+e,o,S);w.transformation=m;let M=[w],P=i.tip,X=Ba(P,c,h,24,!1,!1,!0);X.transformation=_,M.push(X);let $=i.cap,k=Ba($,c,h,24,!1,!0,!1);k.transformation=_,M.push(k);let be=is(re(),ps(ds.get(),f,s));return be[12]=o[0][0],be[13]=o[0][1],be[14]=o[0][2],Le(be,be,u),M.push(X.instantiate({transformation:be})),M.push(k.instantiate({transformation:be})),M};return{normal:a(!1),focused:a(!0)}}function Au(t,e,i){let a=[];for(let o=0;o<12;o++){let s=o/12*2*Math.PI;a.push([Math.cos(s)*t,Math.sin(s)*t])}return Nr(i,a,e,[],[],!1)}function Du(t,e){let i=A(g(),t[t.length-1],t[t.length-2]);ie(i,i),B(i,i,Lo),j(i,i,t[t.length-1]);{let a=A(g(),t[0],t[1]);return ie(a,a),B(a,a,Lo),j(a,a,t[0]),[a,...t,i]}}var Ho=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(e,i){this._tool=e,this._bounds=i,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;let a=this._tool,r=a.view;this.moveXYObjectManipulation=new bi({view:r,tool:a,object:this._object}),a.addHandles(this._createMoveXYObjectDragPipeline()),this.moveZManipulator=new zo(r,hr.CENTER_ON_CALLOUT),this.moveZManipulator.state|=pr,a.manipulators.add(this.moveZManipulator),a.addHandles(this._createMoveZDragPipeline()),a.addHandles(a.events.on("translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))}destroy(){this.moveXYObjectManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(e){this.moveXYObjectManipulation.forEachManipulator(e),e(this.moveZManipulator,I.TRANSLATE_Z)}updateManipulators(e,i){let a=this.moveZManipulator,r=ts(K.get(),e,Math.PI);r[12]=0,r[13]=0,r[14]=0,a.modelTransform=r,a.renderLocation=A(b.get(),i.origin,i.basis1)}getUpdatedTooltipInfo(){return this.moveXYObjectManipulation.grabbing||this.moveXYObjectManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){let e=this._tool,i=this._moveXYTooltipInfo??=new da({sketchOptions:e.sketchOptions});if(this.moveXYObjectManipulation.dragging){let a=this._bounds,r=a.mapBoundsStart.origin,o=a.mapBounds.origin,{renderSpatialReference:s}=e.view;if(!s)return null;let n=la(r,o,s);if(n==null)return null;i.distance=n}else i.distance=Re;return i}_computeMoveZTooltipInfo(){let e=this._tool,i=this._moveZTooltipInfo??=new Rt({sketchOptions:e.sketchOptions});if(this.moveZManipulator.dragging){let a=this._bounds,r=a.mapBoundsStart.origin,o=a.mapBounds.origin,{renderSpatialReference:s}=e.view;if(!s)return null;let n=Xc(r,o,s);if(n==null)return null;i.distance=n}else i.distance=Re;return i}_createMoveXYObjectDragPipeline(){return this.moveXYObjectManipulation.createDragPipeline((e,i,a)=>this._buildMoveDragPipeline(i,a))}_createMoveZDragPipeline(){if(!this._operations)return H();let e=this._operations.data.spatialReference;return he(this.moveZManipulator,(i,a,r)=>{let o=We(i.renderLocation),s=a.next(So(this._tool.view,o,e)).next($e());this._buildMoveDragPipeline(s,r)})}_buildMoveDragPipeline(e,i){let{_tool:a,_object:r}=this;e.next(o=>(o.action==="start"&&(a.inputState={type:"move"},this._bounds.backupMapBounds(),a.events.emit("translate-start",{object:r,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY})),o)).next(Ft()).next(this._updateGeometry()).next(o=>{let s={object:r,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY};switch(o.action){case"start":case"update":(o.mapEnd.x-o.mapStart.x||o.mapEnd.y-o.mapStart.y||(o.mapEnd.z??0)-(o.mapStart.z??0))&&a.events.emit("translate",s);break;case"end":a.inputState=null,a.events.emit("translate-stop",s)}return o}),i.next(()=>{a.inputState!=null&&a.events.emit("translate-stop",{object:r,dxScreen:0,dyScreen:0}),a.cancel()})}_updateGeometry(){let e=this._tool;return i=>{if(e.inputState==null||e.inputState.type!=="move")return i;let a=i.action==="start"?Oe.NEW_STEP:Oe.ACCUMULATE_STEPS;if(this._operations){let r=this._operations.move(i.mapDeltaX,i.mapDeltaY,i.mapDeltaZ,a);this._bounds.updateMapBoundsFromOperation(r)}return i}}};var Pu="theme-style";function sd(t,e){return Lu(ju(Iu(Cu(t),e)),e.size)}function Iu(t,{accentColor:e,contrastColor:i}){let a=e.toHex(),r=e.a,o=i.toHex(),s=i.a,n=t.getElementsByTagNameNS("http://www.w3.org/2000/svg","style").namedItem(Pu);return n&&(n.innerHTML=`
      .contrast-fill { fill: ${o}; fill-opacity: ${s}; }
      .contrast-stroke { stroke: ${o}; stroke-opacity: ${s};  }
      .accent-fill { fill: ${a}; fill-opacity: ${r}; }
      .accent-stroke { stroke: ${a}; stroke-opacity:  ${r}; }`),t}function Cu(t){let e=t.split(",")[1],i=atob(e);return new DOMParser().parseFromString(i,"image/svg+xml")}function ju(t){let e=new XMLSerializer().serializeToString(t);return`data:image/svg+xml;base64,${btoa(e)}`}function Lu(t,e){let i=new Image(e,e);return i.src=t,i}var nd="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgZmlsbD0ibm9uZSIgdmVyc2lvbj0iMi4wIj48c3R5bGUgaWQ9InRoZW1lLXN0eWxlIj4uY29udHJhc3QtZmlsbHtmaWxsOiNmZmZ9LmNvbnRyYXN0LXN0cm9rZXtzdHJva2U6I2ZmZn0uYWNjZW50LWZpbGx7ZmlsbDojZmY3ZjAwO2ZpbGwtb3BhY2l0eTouNX08L3N0eWxlPjxwYXRoIGQ9Ik0yOCAwYTI4IDI4IDAgMSAxIDAgNTYgMjggMjggMCAwIDEgMC01NiIgY2xhc3M9ImFjY2VudC1maWxsIi8+PHBhdGggc3Ryb2tlLXdpZHRoPSI0Ljk5IiBkPSJNMjAuMDUgNDAuODZhMTUuMDUgMTUuMDUgMCAwIDAgMTcuMTQtMS41IDE1LjA1IDE1LjA1IDAgMCAwIDQuNDctMTYuNjUgMTUuMDUgMTUuMDUgMCAwIDAtMjIuNzItNy4xNSAxNS4wNSAxNS4wNSAwIDAgMC01LjUgNy4xNSIgY2xhc3M9ImNvbnRyYXN0LXN0cm9rZSIvPjxwYXRoIGQ9Im0xMC45NyAzNS41NyA1LjM4IDEyLjA3IDcuNzktMTMuNDd6IiBjbGFzcz0iY29udHJhc3QtZmlsbCIvPjwvc3ZnPg==";var ld=64;function cd(t,e){let{accentColor:i,contrastColor:a,preMultiplyAlpha:r}=e;return t.fromData(`heading-rotate:[accent:${i},contrast:${a},size:${ld}]`,()=>new Bl(sd(nd,{accentColor:i,contrastColor:a,size:ld}),{mipmap:!0,reloadable:!0,preMultiplyAlpha:r}))}var Fo=class extends lt{constructor(e,i){super(e,i,new nt(xp,()=>import("./chunk-BLUULPWG.js")),wn)}_getPipelineState(e,i){let{oitPass:a,output:r,hasOccludees:o,enableOffset:s,cullFace:n}=e,l=a===oa.NONE,c=a===oa.FrontFace;return Ht({blending:Ci(r)?l?Za:Ql(a):null,culling:Ir(n),depthTest:{func:tc(a)},depthWrite:Cr(e),drawBuffers:jr(a,r),colorWrite:zt,stencilWrite:o?sc:null,stencilTest:o?i?lc:nc:null,polygonOffset:l||c?null:ec(s)})}initializePipeline(e){return this._occludeePipeline=this._getPipelineState(e,!0),this._getPipelineState(e,!1)}getPipeline(e){return e?this._occludeePipeline:super.getPipeline()}},wn=new Map([[x.POSITION,0],[x.UV0,2],[x.PERSPECTIVEDIVIDE,3]]);var _t=class extends Vr{constructor(){super(...arguments),this.cullFace=Q.None,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.perspectiveInterpolation=!0,this.textureCoordinateType=Ar.None,this.emissionSource=Dr.None,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};p([ae({count:Q.COUNT})],_t.prototype,"cullFace",void 0),p([ae()],_t.prototype,"enableOffset",void 0),p([ae()],_t.prototype,"writeDepth",void 0),p([ae()],_t.prototype,"hasOccludees",void 0),p([ae()],_t.prototype,"terrainDepthTest",void 0),p([ae()],_t.prototype,"cullAboveTerrain",void 0),p([ae()],_t.prototype,"perspectiveInterpolation",void 0);var ko=class extends Vs{constructor(e){super(e,Rn),this._configuration=new _t,this.vertexAttributeLocations=wn,this.supportsEdges=!0,this.produces=new Map([[St.OPAQUE_MATERIAL,i=>gs(i)],[St.TRANSPARENT_MATERIAL,i=>wr(i)&&this.parameters.writeDepth],[St.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,i=>wr(i)&&!this.parameters.writeDepth],[St.DRAPED_MATERIAL,i=>wr(i)||gs(i)]])}getConfiguration(e,i){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=i.hasOccludees,this._configuration.oitPass=i.oitPass,this._configuration.enableOffset=i.camera.relativeElevation<Jl,this._configuration.terrainDepthTest=i.terrainDepthTest,this._configuration.cullAboveTerrain=i.cullAboveTerrain,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}get visible(){return!0}createGLMaterial(e){return new Tn(e)}createBufferWriter(){let e=Gs.clone();return this.parameters.perspectiveInterpolation&&e.f32(x.PERSPECTIVEDIVIDE),new xn(e)}},Tn=class extends Wl{constructor(e){super(y(y({},e),e.material.parameters))}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.getTechnique(Fo,e)}},xn=class extends Es{write(e,i,a,r,o,s){for(let n of this.vertexBufferLayout.fields.keys()){let l=a.get(n);if(l)if(n===x.PERSPECTIVEDIVIDE){xr(l.size===1);let c=o.getField(n,Dl);c&&ic(l,c,s)}else oc(n,l,e,i,o,s)}}},Rn=class extends Pr{constructor(e){super(),this.textureId=e,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=Q.None,this.opacity=1,this.perspectiveInterpolation=!1}};var No=class extends W{constructor(e,i){let a=new ko({writeDepth:!1,renderOccluded:O.Opaque,isDecoration:!0}),r=dn.calloutWidth,o=new ce({width:r,renderOccluded:O.OccludeAndTransparent,isDecoration:!0});super(y({view:e},Vu({imageMaterial:a,calloutMaterial:o}))),this._currentTexture=null,this._themeHandle=v(()=>e.effectiveTheme.accentColor,s=>{let n=Ye(s,.5),l=qt(s),c=this._currentTexture,h=i(n,l);a.setParameters({textureId:h.texture.id}),o.setParameters({color:U.toUnitRGBA(s)}),this._currentTexture=h,c?.release()},L)}destroy(){this._themeHandle.remove(),this._currentTexture?.release(),super.destroy()}};function Vu({imageMaterial:t,calloutMaterial:e}){let{focusMultiplier:i,calloutLength:a,discRadius:r}=dn,o=r*i,s=(h,u)=>{let m=[0,1,2,2,3,0];return new Rr(u,[[x.POSITION,new ka([a-h,-h,0,a+h,-h,0,a+h,h,0,a-h,h,0],m,3,!0)],[x.UV0,new ka([0,0,1,0,1,1,0,1],m,2,!0)]])},n=Se(e,[[0,0,0],[a-r,0,0]]),l=Se(e,[[0,0,0],[a-o,0,0]]),c=Pt;return{autoScaleRenderObjects:!1,collisionPriority:1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},focusMultiplier:i,radius:r,renderObjects:[new T(s(r,t),E.Unfocused|c),new T(n,E.Unfocused|c),new T(s(o,t),E.Focused|c),new T(l,E.Focused|c)],state:c}}var Uo=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(e,i,a){this._tool=e,this._bounds=i,this._snapRotation=a,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;let r=this._tool,o=r.view,s=!o._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this.rotateManipulator=new No(o,(n,l)=>cd(o.textures,{accentColor:n,contrastColor:l,preMultiplyAlpha:s})),r.addHandles([this.rotateManipulator.events.on("grab-changed",n=>this._onGrabChanged(n)),this._createRotateDragPipeline(this.rotateManipulator)]),r.manipulators.add(this.rotateManipulator),r.addHandles([r.events.on("rotate-start",n=>this._startAngle=n.angle),r.events.on("rotate",n=>this._endAngle=n.angle),r.events.on("rotate-stop",()=>{this._startAngle=0,this._endAngle=0})])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(e){e(this.rotateManipulator,I.ROTATE)}updateManipulators(e,i){let a=this._bounds.mapBounds.plane[2]<0?Math.PI:0,r=Ga(K.get(),e,a);r[12]=0,r[13]=0,r[14]=0,this.rotateManipulator.modelTransform=r,this.rotateManipulator.renderLocation=j(b.get(),i.origin,i.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){let e=this._rotateTooltipInfo??=new Rp({sketchOptions:this._tool.sketchOptions});return e.angle=this._startAngle-this._endAngle,e}_onGrabChanged({action:e,screenPoint:i}){let a=this._tool,r=this._bounds;if(e!=="start"||!i)return;let o=id(r.displayBounds,a.view.renderCoordsHelper,Aa.HEADING,bt()),s=fo(a.view.state.camera,i);yt(o,s,b.get())&&(r.backupMapBounds(),a.inputState={type:"rotate",rotatePlane:o})}_createRotateDragPipeline(e){let{_tool:i,_object:a}=this;return he(e,(r,o,s)=>{let n=i.inputState;n!=null&&(o.next(l=>(l.action==="start"&&i.events.emit("rotate-start",{object:a,angle:0}),l)).next($i(i.view,n.rotatePlane)).next(this._renderPlaneToAngle()).next(...this._snapRotation()).next(this._updateGeometry()).next(l=>{let c={object:a,angle:vt(l.rotateAngle)};switch(l.action){case"start":case"update":i.events.emit("rotate",c);break;case"end":i.inputState=null,i.events.emit("rotate-stop",c)}return l}),s.next(()=>{i.inputState!=null&&i.events.emit("rotate-stop",{object:a,angle:0}),i.cancel()}))})}_renderPlaneToAngle(){return e=>{let i=xo(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,e.plane);return R(y({},e),{rotateAngle:i})}}_updateGeometry(){let e=this._bounds;return i=>{let a=z(g(),e.mapBoundsStart.origin),r=i.action==="start"?Oe.NEW_STEP:Oe.ACCUMULATE_STEPS;if(this._operations){let o=this._operations.rotate(a,i.rotateAngle,r,qr.REPLACE);Li(e.mapBoundsStart,e.mapBounds),e.updateMapBoundsFromOperation(o)}return i}}};var Zo=class extends W{constructor(e,i){let a=Ji(i),r=a?Xh:En,o=r*Nh,s=En,n={renderOccluded:O.OccludeAndTransparent,isDecoration:!0},l=new ce(R(y({},n),{width:r})),c=new ce(R(y({},n),{width:o})),h=new ce(R(y({},n),{width:s}));super(y(y({view:e},Eh),Gu({isCorner:a,unfocusedMaterial:l,focusedMaterial:c,outlineMaterial:h}))),this._themeHandle=v(()=>e.effectiveTheme.accentColor,u=>{let m=U.toUnitRGBA(u);l.setParameters({color:m}),c.setParameters({color:m}),h.setParameters({color:m})},L)}destroy(){this._themeHandle.remove(),super.destroy()}};function Gu({isCorner:t,unfocusedMaterial:e,focusedMaterial:i,outlineMaterial:a}){let r=t?[G(1,0,0),G(0,0,0),G(0,1,0)]:[G(1,0,0),G(-1,0,0)];return{renderObjects:[new T(Se(e,r),E.Unfocused|Da),new T(Se(i,r),E.Focused|Da),new T(Se(a,r),Go)],collisionType:{type:"line",paths:[r]},radius:t?Qh:$h,state:Da}}var Wo=class{constructor(e,i){this._tool=e,this.mapBounds=$t(),this.mapBoundsStart=$t(),this.displayBounds=$t(),e.addHandles(Xt(()=>e.object,"modified-externally",()=>this._resetMapBounds(),{onListenerAdd:()=>this._resetMapBounds()})),this._onDisplayBoundsChanged=i}get displayBoundsMargin(){let{view:e,object:i}=this._tool,a=Z(i),r=e.pointsOfInterest?.centerOnSurfaceFrequent.location??a?.extent?.center;return r?zu*e.pixelSizeAt(r):0}backupMapBounds(){Li(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged?.()}updateMapBoundsFromOperation(e){lp(e,this.mapBounds),this.updateDisplayBounds()}updateMapBoundsFromOperationInverse(e){cp(e,this.mapBounds),this.updateDisplayBounds()}_resetMapBounds(){this._calculateMapBounds(),this.updateDisplayBounds()}_calculateMapBounds(){let{view:e,attachmentOrigin:i,object:a}=this._tool,r=a.operations?.data;if(!r)return;let o=r.geometry;this.spatialReference=o.spatialReference;let s=qp(o);Qt(s,s,-1);let n=i?e.pixelSizeAt(i,o.spatialReference):0,l=Hu*n,c=r.coordinateHelper.hasZ()&&a.elevationInfo.mode!=="on-the-ground";pp(s,r,l,this.mapBounds,c)}_calculateDisplayBounds(){let{view:e,attachmentOrigin:i}=this._tool,a=i?.z??oi(this.mapBounds.origin,e.elevationProvider,Je.fromElevationInfo(this._tool.object.elevationInfo),e.renderCoordsHelper);Fu(this.mapBounds,a??0,e.renderCoordsHelper,this.spatialReference,this.displayBoundsMargin,this.displayBounds)}},zu=10,Hu=80;function Fu(t,e,i,a,r=0,o){o||(o=$t());let s=b.get();j(s,t.origin,t.basis1),j(s,s,t.basis2),i.toRenderCoords(s,a,s);let n=b.get();j(n,t.origin,t.basis1),A(n,n,t.basis2),i.toRenderCoords(n,a,n);let l=b.get();A(l,t.origin,t.basis1),A(l,l,t.basis2),i.toRenderCoords(l,a,l);let c=b.get();A(c,t.origin,t.basis1),j(c,c,t.basis2),i.toRenderCoords(c,a,c),j(o.origin,s,n),j(o.origin,o.origin,l),j(o.origin,o.origin,c),B(o.origin,o.origin,.25),A(s,s,o.origin),A(n,n,o.origin),A(l,l,o.origin),A(c,c,o.origin);let h=ot(b.get(),s,n,.5),u=ot(b.get(),l,c,.5);B(u,u,-1),ot(o.basis1,h,u,.5);let m=ot(b.get(),s,c,.5),f=ot(b.get(),n,l,.5);B(f,f,-1),ot(o.basis2,m,f,.5);let _=me(b.get(),o.basis1,o.basis2);me(o.basis2,_,o.basis1),ie(o.basis1,o.basis1);let S=Math.max(Math.abs(Me(o.basis1,s)),Math.abs(Me(o.basis1,n)),Math.abs(Me(o.basis1,l)),Math.abs(Me(o.basis1,c)));ie(o.basis2,o.basis2);let w=Math.max(Math.abs(Me(o.basis2,s)),Math.abs(Me(o.basis2,n)),Math.abs(Me(o.basis2,l)),Math.abs(Me(o.basis2,c)));B(o.basis1,o.basis1,S+r),B(o.basis2,o.basis2,w+r);let M=z(b.get(),t.origin);return M[2]=e,i.toRenderCoords(M,a,M),ke(M,_,o.plane),wl(o.plane,o.origin,o.origin),Ss(o),o}function pd(t,e,i){return A(Pa,A(Pa,t.origin,t.basis1),t.basis2),rt(Bo,Pa,t.basis1,2),rt(Dn,Bo,t.basis2,2),rt(An,Pa,t.basis2,2),Pa[2]=Bo[2]=Dn[2]=An[2]=e,Ap({topLeft:An,topRight:Dn,bottomRight:Bo,bottomLeft:Pa,spatialReference:i})}var An=g(),Dn=g(),Bo=g(),Pa=g();var Yo=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}get zMax(){if(!this._zMaxDirty||!this._operations)return this._zMax;let e=this._operations.data;if(e.geometry.hasZ){let i=e.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(let a of e.components)for(let r of a.vertices){let o=i.getZ(r.pos)??0;this._zMax=Math.max(o,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(e,i,a){this._tool=e,this._bounds=i,this._preserveAspectRatioStep=a,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._displayBoundsStart=$t(),this._displayBoundsMarginStart=0,this._zMax=0,this._zMaxDirty=!0;let r=this._tool,o=r.view;this.resizeManipulators=this._resizeHandles.map(s=>{let n=new Zo(o,s);return r.addHandles([n.events.on("grab-changed",l=>this._onGrabChanged(l)),this._createResizeDragPipeline(n,s)]),n}),r.manipulators.addMany(this.resizeManipulators),this._operations&&r.addHandles(this._operations.data.on("change",()=>{r.inputState?.type!=="resize"&&(this._zMaxDirty=!0)}))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){this.resizeManipulators.forEach(i=>e(i,I.SCALE))}updateManipulators(e,i){this.resizeManipulators.forEach((a,r)=>{ad(a,this._resizeHandles[r],e,i)})}getUpdatedTooltipInfo(){if(!this.resizeManipulators.some(a=>a.focused))return null;let e=this._tooltipInfo??=new Dp({sketchOptions:this._tool.sketchOptions}),i=pd(this._bounds.mapBounds,this.zMax,this._bounds.spatialReference);return i&&(e.xSize=i.xSize,e.ySize=i.ySize),this.resizeManipulators.some(a=>a.dragging)||(e.xScale=1,e.yScale=1),e}_onGrabChanged({action:e,screenPoint:i}){let a=this._tool,r=this._bounds;if(e!=="start"||!i)return;let o=fo(a.view.state.camera,i);yt(r.displayBounds.plane,o,b.get())&&(r.backupMapBounds(),Li(r.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=r.displayBoundsMargin,a.inputState={type:"resize"})}_createResizeDragPipeline(e,i){let{_tool:a,_object:r}=this;return he(e,(o,s,n)=>{a.inputState!=null&&(s.next(l=>(l.action==="start"&&a.events.emit("scale-start",{object:r,xScale:1,yScale:1}),R(y({},l),{handle:i}))).next($i(a.view,this._displayBoundsStart.plane)).next(this._renderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._updateGeometry()).next(l=>{let c=this._tooltipInfo;c&&(c.xScale=l.factor1,c.yScale=l.factor2);let h={object:r,xScale:l.factor1,yScale:l.factor2};switch(l.action){case"start":case"update":a.events.emit("scale",h);break;case"end":a.inputState=null,a.events.emit("scale-stop",h)}return l}),n.next(()=>{a.inputState!=null&&a.events.emit("scale-stop",{object:r,xScale:1,yScale:1}),a.cancel()}))})}_renderPlaneToFactors(){let e=this._bounds;return i=>{let a=this._displayBoundsStart,r=i.handle.direction,o=e.displayBoundsMargin,s=this._displayBoundsMarginStart,n=z(b.get(),a.origin);rt(n,n,a.basis1,-r[0]),rt(n,n,a.basis2,-r[1]);let l=A(b.get(),i.renderEnd,n),c=A(b.get(),i.renderStart,n),h=Ji(i.handle),u=Vo(a),m=Vo(e.displayBounds)/u,f=(_,S)=>{if(_===0)return 1;let w=Ce(S),M=.5*_*Me(S,l)/w,P=M<0?-1:1;h&&(M+=(w-.5*_*Me(S,c)/w)*P*m);let X=w<1.5*s?1:hd;return w=Math.max(w-s,hd),P>0&&(M-=o),P*Math.max(P*(M/w),X)};return R(y({},i),{factor1:f(r[0],a.basis1),factor2:f(r[1],a.basis2)})}}_updateGeometry(){let e=this._bounds;return i=>{let a=z(g(),e.mapBoundsStart.origin);rt(a,a,e.mapBoundsStart.basis1,-i.handle.direction[0]),rt(a,a,e.mapBoundsStart.basis2,-i.handle.direction[1]);let r=Pi(st(),e.mapBoundsStart.basis1[0],e.mapBoundsStart.basis1[1]);ta(r,r);let o=i.action==="start"?Oe.NEW_STEP:Oe.ACCUMULATE_STEPS;if(this._operations){let s=this._operations.scale(a,r,i.factor1,i.factor2,o,qr.REPLACE);Li(e.mapBoundsStart,e.mapBounds),e.updateMapBoundsFromOperation(s)}return i}}},hd=1e-6;var Xo=class{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&this._lastDragEvent!=null&&this._next!=null){let i=R(y({},this._lastDragEvent),{action:"update"});e&&dd(i),this._next.execute(i)}this._enabled=e}createDragEventPipelineStep(){this._lastDragEvent=null;let e=new ii;return this._next=e,[i=>(this._lastDragEvent=i.action!=="end"?y({},i):null,this._enabled&&dd(i),i),e]}get test(){}};function dd(t){let e=Ji(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}var qo=class{constructor(){this._lastDragEvent=null,this._next=null,this.incrementRadians=ne(5),this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&this._lastDragEvent!=null&&this._next!=null){let i=R(y({},this._lastDragEvent),{action:"update"});e&&this._adjustRotation(i),this._next.execute(i)}this._enabled=e}createDragEventPipelineStep(){this._lastDragEvent=null;let e=new ii;return this._next=e,[i=>(this._lastDragEvent=i.action!=="end"?y({},i):null,this._enabled&&this._adjustRotation(i),i),e]}_adjustRotation(e){e.rotateAngle=Math.round(e.rotateAngle/this.incrementRadians)*this.incrementRadians}};var Ae=class extends ei{get updating(){return!!this.object.updating}constructor(t){super(t),this.events=new oe,this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.sketchOptions=new Qe,this._preserveAspectRatio=new Xo,this._snapRotation=new qo,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){let{view:t,object:e}=this,i=this._bounds=new Wo(this,()=>this._updateManipulators());this._extentMove=new Ho(this,i),this._extentScale=new Yo(this,i,()=>this._preserveAspectRatio.createDragEventPipelineStep()),this._extentRotate=new Uo(this,i,()=>this._snapRotation.createDragEventPipelineStep()),this.addHandles([v(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,I.TRANSLATE_Z)),v(()=>this.enableScaling,()=>this._extentScale.forEachManipulator(s=>this._updateManipulatorAvailability(s,I.SCALE))),v(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,I.ROTATE))]),this._updateManipulators(),this._updateAllManipulatorAvailability();let a=mi({view:t,object:e,forEachManipulator:s=>this._forEachManipulator(s),onManipulatorsChanged:()=>H()});if(a!=null){let{visualElement:s}=a;s instanceof Ve&&(this._outlineVisualElement=s,this.addHandles(s.events.on("attachment-origin-changed",()=>this._bounds.updateDisplayBounds()))),this.addHandles(a)}this.addHandles([e.on("committed",()=>this._onGeometryChanged()),v(()=>this.object.visible,()=>this._updateAllManipulatorAvailability()),v(()=>this.object.isDraped,()=>this._graphicDrapedChanged(),L),v(()=>t.pointsOfInterest?.centerOnSurfaceFrequent.location,()=>i.updateDisplayBounds())]);let r=s=>{this.addHandles(s.events.on("grab-changed",()=>{this.grabbing=s.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(r);let o=(s,n)=>{this.addHandles(s.events.on("immediate-click",l=>{n===I.TRANSLATE_XY&&this.events.emit("immediate-click",R(y({},l),{object:e})),l.stopPropagation()}))};this._forEachManipulator(o),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this.tooltip.destroy(),this._set("view",null),this._set("object",null)}_initializeTooltip(){let{view:t}=this;this.tooltip=Kt(()=>({view:t,options:this.sketchOptions.tooltips}));let e=()=>{this.tooltip.info=this._getUpdatedTooltipInfo()};this.addHandles([v(()=>this.sketchOptions.tooltips.effectiveEnabled,e),v(()=>this.preserveAspectRatio,e)]),this._forEachManipulator(i=>{this.addHandles([i.events.on(["focus-changed","grab-changed"],e),i.events.on("drag",a=>{a.action==="cancel"?this.tooltip.clear():e()})])})}_getUpdatedTooltipInfo(){return this.sketchOptions.tooltips.effectiveEnabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(ud),this._bounds.updateDisplayBounds(),this.object.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",t=>{this._attachmentOrigin!=null&&fr(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()}),ud)}_updateManipulators(){if(!this.visible)return;let t=this._bounds.displayBounds,e=td(t,K.get());this._extentMove.updateManipulators(e,t),this._extentScale.updateManipulators(e,t),this._extentRotate.updateManipulators(e,t)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){let i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof W){let a=this.object.visible,r=this.enableZ&&ut(this.object.operations,this.object.elevationInfo);switch(e){case I.ROTATE:t.available=a&&this.enableRotation;break;case I.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||r),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?Da:Go;break;case I.TRANSLATE_Z:t.available=a&&r;break;default:t.available=a}}}_forEachManipulator(t){this._extentMove.forEachManipulator(t),this._extentScale.forEachManipulator(t),this._extentRotate.forEachManipulator(t)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get snapRotation(){return this._snapRotation.enabled}set snapRotation(t){this._snapRotation.enabled=t,this._set("snapRotation",t)}get attachmentOrigin(){let t=this.object.isDraped?null:this._outlineVisualElement?.attachmentOrigin;return this._attachmentOrigin=t??this.object.origin??Z(this.object)?.extent?.center,this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){let t=this.object.operations?.undo();t&&this._bounds.updateMapBoundsFromOperationInverse(t)}this.inputState=null}get canUndo(){return!!this.object.operations?.canUndo}undo(){if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){let t=this.object.operations?.undo();t&&this._bounds.updateMapBoundsFromOperationInverse(t)}}get canRedo(){return!!this.object.operations?.canRedo}redo(){if(this.canRedo){let t=this.object.operations?.redo();t&&this._bounds.updateMapBoundsFromOperation(t)}}get test(){}};p([d()],Ae.prototype,"updating",null),p([d({constructOnly:!0,nonNullable:!0})],Ae.prototype,"view",void 0),p([d({constructOnly:!0,nonNullable:!0})],Ae.prototype,"object",void 0),p([d()],Ae.prototype,"enableZ",void 0),p([d()],Ae.prototype,"enableScaling",void 0),p([d()],Ae.prototype,"enableRotation",void 0),p([d({constructOnly:!0,type:Qe})],Ae.prototype,"sketchOptions",void 0),p([d()],Ae.prototype,"preserveAspectRatio",null),p([d()],Ae.prototype,"snapRotation",null),p([d()],Ae.prototype,"grabbing",void 0),p([d()],Ae.prototype,"inputState",void 0),p([d({readOnly:!0})],Ae.prototype,"type",void 0),p([d()],Ae.prototype,"tooltip",void 0),Ae=p([D("esri.views.3d.interactive.editingTools.transform.ExtentTransformTool")],Ae);var ud="draped-elevation-changes";function md(t){return t!=null&&t.type==="mesh"?ku(t):Nu(t)}function ku(t){return vl(t.vertexSpace)?Uu(t,t.transform,t.vertexSpace):Zu(t)}function Nu(t){let e=t,i=null;return{undo(a){i=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=i}}}function Uu(t,e,i){let a=e?.clone(),r=We(i.origin),o=null,s=null;return{undo:()=>{o=t.transform?.clone(),s=We(i.origin),t.transform=a,t.vertexSpace.origin=r},redo:()=>{a=t.transform?.clone(),r=We(i.origin),t.transform=o,t.vertexSpace.origin=s}}}function Zu(t){let e,i=t.vertexAttributes.clonePositional();return{undo:()=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i},redo:()=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e}}}var Pn=Symbol(),Si=class extends oe.EventedAccessor{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}get elevationInfo(){return Gl(this.graphic)}get visible(){return this._graphicState.displaying}get isDraped(){return this._graphicState.isDraped}get origin(){return wh(this.view,this.graphic)}constructor(t){super(t),this._updatingHandles=new Jt}destroy(){this._operations=N(this._operations),this._updatingHandles.destroy()}initialize(){this._graphicState=new Kr({graphic:this.graphic}),this._graphicState.on("changed",()=>this.emit("committed")),this.addHandles(this.view.trackGraphicState(this._graphicState)),this.addHandles(this._updatingHandles.add(()=>this.graphic.geometry,t=>{let e=this._operations?.data.geometry;if(t!==e){if(!t||t?.type==="multipoint"||t?.type==="extent")return N(this._operations),this.removeHandles(Pn),void(this._operations=null);if(this._operations?.trySetGeometry(t))this.emit("modified-externally");else{N(this._operations),this.removeHandles(Pn);let i=ca.fromGeometry(t,this.view.state.viewingMode);this._operations=i,this.addHandles(i.data.on("change",()=>this.graphic.geometry=i.data.geometry),Pn)}}},Pe))}createManipulator(t){return new np(y({view:this.view,graphic:this.graphic},t))}maskOccludee(){return this.view.maskOccludee(this.graphic)}endInteraction(){this.graphic.geometry?.type==="mesh"&&this.graphic.notifyMeshTransformChanged({action:qa.UpdateFastLocalOrigin})}toMap(t){return this.view.toMap(t,{include:[this.graphic]})}createUndoRecord(){let{graphic:{geometry:t}}=this;return md(t)}};p([d({constructOnly:!0})],Si.prototype,"view",void 0),p([d({constructOnly:!0})],Si.prototype,"graphic",void 0),p([d()],Si.prototype,"_operations",void 0),p([d()],Si.prototype,"operations",null),p([d()],Si.prototype,"updating",null),Si=p([D("esri.views.3d.interactive.editingTools.ManipulatedObject3DGraphic")],Si);export{Xi as DrawGraphicTool3D,Ae as ExtentTransformTool,Si as ManipulatedObject3DGraphic,Be as MoveTool3D,de as ReshapeTool3D,He as TransformTool3D};
