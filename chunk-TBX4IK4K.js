import{a as hr,b as mr,c as dr,e as fr}from"./chunk-3VC7PBS6.js";import{b as ur}from"./chunk-LYVHPFC2.js";import{D as Ce,a as or,b as lr}from"./chunk-G3YWARR2.js";import{c as cr}from"./chunk-MIOOILW6.js";import{i as pe,j as nr}from"./chunk-FWCA6KJ3.js";import{E as Kt,F as Ze,G as Ye,H as er,I as tr,J as qe,K as rr,L as ir,c as Vt,d as Wt,e as Gt,g as Jt,h as Zt,j as Yt,l as qt,m as Xt,r as j}from"./chunk-P64DWRJ7.js";import{e as zt}from"./chunk-DBZKWPEX.js";import{a as wt,f as Mt}from"./chunk-AYSSTKZP.js";import{a as Qt,b as $t}from"./chunk-WXB3UZNT.js";import{d as kt}from"./chunk-7VWXQFPJ.js";import{d as Je,h as xe,i as fe}from"./chunk-FZ5X7HOK.js";import{a as Re,b as ie,j as Ht,k as X,v as sr}from"./chunk-3D4Y6BLC.js";import{a as He}from"./chunk-OTUHXNWB.js";import{b as Xe}from"./chunk-NBT2WTKD.js";import{a as ke,d as Ie,e as Bt,j as Ft}from"./chunk-PSIELDY2.js";import{a as Se}from"./chunk-B564E6X6.js";import{b as jt}from"./chunk-TBHSFWI7.js";import{a as Y,e as Nt,f as Ut,h as q,n as ze,o as Dt}from"./chunk-3AS27HNO.js";import{a as h,b as Lt}from"./chunk-RWCIDBNQ.js";import{f as Ct}from"./chunk-ONYJLWAD.js";import{b as It}from"./chunk-6EWMYOA7.js";import{g as Pt}from"./chunk-3BZAI7HK.js";import{b as Ge,x as de}from"./chunk-HM5RIVQC.js";import{G as M,j as Rt,m as he,r as me}from"./chunk-SKMO433W.js";import{a as xt}from"./chunk-QXXXCEV5.js";import{a as re,d as St}from"./chunk-ALWV3RJ2.js";import{C as yt,a as vt,b as V,c as U,d as te,e as Z,m as ye,o as ue,u as We,w as At,x as D}from"./chunk-5WKDXHVH.js";import{c as Ot,g as bt}from"./chunk-PTZYZULI.js";import{a as Tt,b as Et}from"./chunk-XSTBHERR.js";import{E as _t,a as ce,g as Ve}from"./chunk-7B2UKJ5N.js";import{b as ar}from"./chunk-IJBTA53P.js";import{h as J}from"./chunk-OLOKUDVI.js";import{a as _,c as oe}from"./chunk-NHSDW26F.js";import{g as le}from"./chunk-NMAGYK3Q.js";import{b as Ae}from"./chunk-VOFKUGRY.js";import{a as gt}from"./chunk-VACZNAP3.js";import{F as pt,n as mt}from"./chunk-C7INQGWT.js";import{a as Fe}from"./chunk-3TQOUBNU.js";import{i as dt,u as ft}from"./chunk-D2LVMNOU.js";import{r as ve}from"./chunk-HHDFN2GK.js";import{f as ht}from"./chunk-VTHXE323.js";var ge;(function(r){r[r.ASYNC=0]="ASYNC",r[r.SYNC=1]="SYNC"})(ge||(ge={}));var pr,gr,_r;(function(r){r[r.RasterImage=0]="RasterImage",r[r.Features=1]="Features"})(pr||(pr={})),function(r){r[r.MapLayer=0]="MapLayer",r[r.ViewLayer=1]="ViewLayer",r[r.Outline=2]="Outline",r[r.SnappingHint=3]="SnappingHint"}(gr||(gr={})),function(r){r[r.WithRasterImage=0]="WithRasterImage",r[r.WithoutRasterImage=1]="WithoutRasterImage"}(_r||(_r={}));var Pe=class extends Re{get geometries(){return this._geometries}get transformation(){return this._transformation??St}set transformation(e){this._transformation=ce(this._transformation??re(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?ce(this._shaderTransformation??re(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=ie.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Le),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){wt(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){let t=this._geometries.splice(e,1)[0];t&&(this._emit("geometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,i=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:i}),Lt(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(let t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){let e=new Wt;for(let t of this._geometries)t.occludees=or(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(let t of this._geometries)t.occludees=lr(t.occludees,e);this._emit("occlusionChanged",this)}highlight(e){let t=new Vt(e);for(let i of this._geometries)i.addHighlight(t);return this._emit("highlightChanged",this),t}removeHighlight(e){for(let t of this._geometries)t.removeHighlight(e);this._emit("highlightChanged",this)}removeStateID(e){e.channel===Ct.Highlight?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return Ve(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=re()){return Ve(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Ne,this._validateBoundingVolume(this._bvWorldSpace,_e.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Ne,this._validateBoundingVolume(this._bvObjectSpace,_e.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){let i=t===_e.ObjectSpace;for(let a of this._geometries){let s=a.boundingInfo;s&&wr(s,e,i?a.transformation:this.getCombinedShaderTransformation(a))}At(e.bounds,e.min,e.max,.5);for(let a of this._geometries){let s=a.boundingInfo;if(s==null)continue;let l=i?a.transformation:this.getCombinedShaderTransformation(a),o=Rt(l);D(Tr,s.center,l);let n=ue(Tr,e.bounds),c=s.radius*o;e.bounds[3]=Math.max(e.bounds[3],n+c)}}_invalidateBoundingVolume(){let e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){}},Le=class{constructor(){this.min=oe(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=oe(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},Ne=class extends Le{constructor(){super(...arguments),this.bounds=Pt()}};function wr(r,e,t){let i=r.bbMin,a=r.bbMax;if(_t(t)){let s=U(Mr,t[12],t[13],t[14]);te(N,i,s),te(B,a,s);for(let l=0;l<3;++l)e.min[l]=Math.min(e.min[l],N[l]),e.max[l]=Math.max(e.max[l],B[l])}else if(D(N,i,t),yt(i,a))for(let s=0;s<3;++s)e.min[s]=Math.min(e.min[s],N[s]),e.max[s]=Math.max(e.max[s],N[s]);else{D(B,a,t);for(let s=0;s<3;++s)e.min[s]=Math.min(e.min[s],N[s],B[s]),e.max[s]=Math.max(e.max[s],N[s],B[s]);for(let s=0;s<3;++s){V(N,i),V(B,a),N[s]=a[s],B[s]=i[s],D(N,N,t),D(B,B,t);for(let l=0;l<3;++l)e.min[l]=Math.min(e.min[l],N[l],B[l]),e.max[l]=Math.max(e.max[l],N[l],B[l])}}}var Mr=_(),N=_(),B=_(),Tr=_(),_e;(function(r){r[r.WorldSpace=0]="WorldSpace",r[r.ObjectSpace=1]="ObjectSpace"})(_e||(_e={}));var Ue=class extends $t{constructor(e,t){super(e,t,new Qt(fr,()=>import("./chunk-ULXXCJOG.js")),Qe),this.primitiveType=t.wireframe?Ge.LINES:Ge.TRIANGLE_STRIP}_makePipelineState(e,t){let{oitPass:i,output:a,hasOccludees:s,hasPolygonOffset:l}=e,o=i===He.NONE,n=i===He.FrontFace;return fe({blending:q(a)?Jt(i):null,depthTest:{func:qt(i)},depthWrite:Zt(e),drawBuffers:a===Y.Depth?{buffers:[de.NONE]}:Xt(i,a),colorWrite:xe,stencilWrite:s?Ye:null,stencilTest:s?t?qe:tr:null,polygonOffset:o||n?l?Er:null:Yt})}initializePipeline(e){if(e.occluder){let t=e.hasPolygonOffset?Er:null;this._occluderPipelineTransparent=fe({blending:Je,polygonOffset:t,depthTest:Ze,depthWrite:null,colorWrite:xe,stencilWrite:null,stencilTest:ir,drawBuffers:e.output===Y.Depth?{buffers:[de.NONE]}:null}),this._occluderPipelineOpaque=fe({blending:Je,polygonOffset:t,depthTest:Ze,depthWrite:null,colorWrite:xe,stencilWrite:er,stencilTest:rr,drawBuffers:e.output===Y.Depth?{buffers:[de.NONE]}:null}),this._occluderPipelineMaskWrite=fe({blending:null,polygonOffset:t,depthTest:Kt,depthWrite:null,colorWrite:null,stencilWrite:Ye,stencilTest:qe,drawBuffers:e.output===Y.Depth?{buffers:[de.NONE]}:null})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case j.TRANSPARENT_OCCLUDER_MATERIAL:return this._occluderPipelineTransparent??super.getPipeline();case j.OCCLUDER_MATERIAL:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}},Er={factor:0,units:-4},Qe=new Map([[h.POSITION,0],[h.PREVPOSITION,1],[h.NEXTPOSITION,2],[h.SUBDIVISIONFACTOR,3],[h.UV0,4],[h.COLOR,5],[h.COLORFEATUREATTRIBUTE,5],[h.SIZE,6],[h.SIZEFEATUREATTRIBUTE,6],[h.OPACITYFEATUREATTRIBUTE,7],[h.OBJECTANDLAYERIDCOLOR,8]]);var P;(function(r){r[r.LEFT_JOIN_START=-2]="LEFT_JOIN_START",r[r.LEFT_JOIN_END=-1]="LEFT_JOIN_END",r[r.LEFT_CAP_START=-4]="LEFT_CAP_START",r[r.LEFT_CAP_END=-5]="LEFT_CAP_END",r[r.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",r[r.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",r[r.RIGHT_CAP_START=4]="RIGHT_CAP_START",r[r.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(P||(P={}));var De=class extends Ht{constructor(e){super(e,st),this._configuration=new mr,this.vertexAttributeLocations=Qe,this.produces=new Map([[j.OPAQUE_MATERIAL,t=>Nt(t)||q(t)&&this.parameters.renderOccluded===X.OccludeAndTransparentStencil],[j.OPAQUE_MATERIAL_WITHOUT_NORMALS,t=>Dt(t)],[j.OCCLUDER_MATERIAL,t=>ze(t)&&this.parameters.renderOccluded===X.OccludeAndTransparentStencil],[j.TRANSPARENT_OCCLUDER_MATERIAL,t=>ze(t)&&this.parameters.renderOccluded===X.OccludeAndTransparentStencil],[j.TRANSPARENT_MATERIAL,t=>q(t)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==X.OccludeAndTransparentStencil],[j.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,t=>q(t)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==X.OccludeAndTransparentStencil],[j.DRAPED_MATERIAL,t=>Ut(t)]])}getConfiguration(e,t){this._configuration.output=e,this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===j.DRAPED_MATERIAL;let i=this.parameters.stipplePattern!=null&&e!==Y.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Br(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===X.OccludeAndTransparentStencil,this._configuration.terrainDepthTest=t.terrainDepthTest&&q(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration}get visible(){return this.parameters.color[3]>=Xe||this.parameters.stipplePattern!=null&&(this.parameters.stippleOffColor?.[3]??0)>Xe}intersectDraped({attributes:e,screenToWorldRatio:t},i,a,s,l,o){if(!a.options.selectionMode)return;let n=e.get(h.SIZE),c=this.parameters.width;if(this.parameters.vvSize){let x=e.get(h.SIZEFEATUREATTRIBUTE).data[0];c*=Ae(this.parameters.vvSize.offset[0]+x*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n&&(c*=n.data[0]);let u=s[0],m=s[1],d=(c/2+4)*t,f=Number.MAX_VALUE,b=0,E=e.get(h.POSITION).data,y=nt(this.parameters,e)?E.length-2:E.length-5;for(let x=0;x<y;x+=3){let T=E[x],w=E[x+1],g=(x+3)%E.length,L=u-T,C=m-w,p=E[g]-T,k=E[g+1]-w,A=Ae((p*L+k*C)/(p*p+k*k),0,1),ee=p*A-L,S=k*A-C,H=ee*ee+S*S;H<f&&(f=H,b=x/3)}f<d*d&&l(o.dist,o.normal,b,!1)}intersect(e,t,i,a,s,l){if(!i.options.selectionMode||!e.visible)return;if(!Mt(t))return void ve.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");let o=e.attributes,n=o.get(h.POSITION).data,c=this.parameters.width;if(this.parameters.vvSize){let T=o.get(h.SIZEFEATUREATTRIBUTE).data[0];c*=Ae(this.parameters.vvSize.offset[0]+T*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o.has(h.SIZE)&&(c*=o.get(h.SIZE).data[0]);let u=i.camera,m=Fr;xt(m,i.point);let d=c*u.pixelRatio/2+4*u.pixelRatio;U(Te[0],m[0]-d,m[1]+d,0),U(Te[1],m[0]+d,m[1]+d,0),U(Te[2],m[0]+d,m[1]-d,0),U(Te[3],m[0]-d,m[1]-d,0);for(let T=0;T<4;T++)if(!u.unprojectFromRenderScreen(Te[T],z[T]))return;me(u.eye,z[0],z[1],Ke),me(u.eye,z[1],z[2],et),me(u.eye,z[2],z[3],tt),me(u.eye,z[3],z[0],rt);let f=Number.MAX_VALUE,b=0,E=nt(this.parameters,o)?n.length-2:n.length-5;for(let T=0;T<E;T+=3){R[0]=n[T]+t[12],R[1]=n[T+1]+t[13],R[2]=n[T+2]+t[14];let w=(T+3)%n.length;if(I[0]=n[w]+t[12],I[1]=n[w+1]+t[13],I[2]=n[w+2]+t[14],M(Ke,R)<0&&M(Ke,I)<0||M(et,R)<0&&M(et,I)<0||M(tt,R)<0&&M(tt,I)<0||M(rt,R)<0&&M(rt,I)<0)continue;if(u.projectToRenderScreen(R,$),u.projectToRenderScreen(I,K),$[2]<0&&K[2]>0){Z(W,R,I);let L=u.frustum,C=-M(L[pe.NEAR],R)/We(W,L[pe.NEAR]);ye(W,W,C),te(R,R,W),u.projectToRenderScreen(R,$)}else if($[2]>0&&K[2]<0){Z(W,I,R);let L=u.frustum,C=-M(L[pe.NEAR],I)/We(W,L[pe.NEAR]);ye(W,W,C),te(I,I,W),u.projectToRenderScreen(I,K)}else if($[2]<0&&K[2]<0)continue;$[2]=0,K[2]=0;let g=Bt(Ie($,K,vr),m);g<f&&(f=g,V(Or,R),V(br,I),b=T/3)}let y=i.rayBegin,x=i.rayEnd;if(f<d*d){let T=Number.MAX_VALUE;if(Ft(Ie(Or,br,vr),Ie(y,x,Vr),Q)){Z(Q,Q,y);let w=vt(Q);ye(Q,Q,1/w),T=w/ue(y,x)}l(T,Q,b,!1)}}get _layout(){let e=zt().vec3f(h.POSITION).vec3f(h.PREVPOSITION).vec3f(h.NEXTPOSITION).f32(h.SUBDIVISIONFACTOR).vec2f(h.UV0);return this.parameters.vvSize?e.f32(h.SIZEFEATUREATTRIBUTE):e.f32(h.SIZE),this.parameters.vvColor?e.f32(h.COLORFEATUREATTRIBUTE):e.vec4f(h.COLOR),this.parameters.vvOpacity&&e.f32(h.OPACITYFEATUREATTRIBUTE),Se()&&e.vec4u8(h.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new at(this._layout,this.parameters)}createGLMaterial(e){return new it(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}},it=class extends kt{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){let t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(Ue,e)}},st=class extends sr{constructor(){super(...arguments),this.width=0,this.color=bt,this.join="miter",this.cap=hr.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1}get transparent(){return this.color[3]<1||this.stipplePattern!=null&&(this.stippleOffColor?.[3]??0)<1}},at=class{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t,this.numJoinSubdivisions=0;let i=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=dr+i}}_isClosed(e){return nt(this._parameters,e)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){let i=e.get(h.POSITION).indices.length/2+1,a=this._isClosed(e),s=a?2:2*2;return s+=((a?i:i-1)-(a?0:1))*(2*this.numJoinSubdivisions+4),s+=2,this._parameters.wireframe&&(s=2+4*(s-2)),s}write(e,t,i,a,s,l){let o=Wr,n=Gr,c=zr,u=i.get(h.POSITION),m=u.indices,d=u.data.length/3,f=i.get(h.DISTANCETOSTART)?.data;m&&m.length!==2*(d-1)&&console.warn("RibbonLineMaterial does not support indices");let b=i.get(h.SIZEFEATUREATTRIBUTE)?.data[0]??i.get(h.SIZE)?.data[0]??1,E=[1,1,1,1],y=0,x=this.vertexBufferLayout.fields.has(h.COLORFEATUREATTRIBUTE);x?y=i.get(h.COLORFEATUREATTRIBUTE).data[0]:i.has(h.COLOR)&&(E=i.get(h.COLOR).data);let T=this.vertexBufferLayout.fields.has(h.OPACITYFEATUREATTRIBUTE),w=T?i.get(h.OPACITYFEATUREATTRIBUTE).data[0]:0,g=new Float32Array(s.buffer),L=Se()?new Uint8Array(s.buffer):null,C=this.vertexBufferLayout.stride/4,p=l*C,k=p,A=0,ee=f?(O,F,G)=>A=f[G]:(O,F,G)=>A+=ue(O,F),S=(O,F,G,ne,Oe,Dr,jr)=>{if(g[p++]=F[0],g[p++]=F[1],g[p++]=F[2],g[p++]=O[0],g[p++]=O[1],g[p++]=O[2],g[p++]=G[0],g[p++]=G[1],g[p++]=G[2],g[p++]=ne,g[p++]=jr,g[p++]=Oe,g[p++]=b,x)g[p++]=y;else{let be=Math.min(4*Dr,E.length-4);g[p++]=E[be],g[p++]=E[be+1],g[p++]=E[be+2],g[p++]=E[be+3]}T&&(g[p++]=w),Se()&&(a&&(L[4*p]=a[0],L[4*p+1]=a[1],L[4*p+2]=a[2],L[4*p+3]=a[3]),p++)};p+=C,U(n,u.data[0],u.data[1],u.data[2]),e&&D(n,n,e);let H=this._isClosed(i);if(H){let O=u.data.length-3;U(o,u.data[O],u.data[O+1],u.data[O+2]),e&&D(o,o,e)}else U(c,u.data[3],u.data[4],u.data[5]),e&&D(c,c,e),S(n,n,c,1,P.LEFT_CAP_START,0,0),S(n,n,c,1,P.RIGHT_CAP_START,0,0),V(o,n),V(n,c);let Be=H?0:1,ae=H?d:d-1;for(let O=Be;O<ae;O++){let F=(O+1)%d*3;U(c,u.data[F],u.data[F+1],u.data[F+2]),e&&D(c,c,e),ee(o,n,O),S(o,n,c,0,P.LEFT_JOIN_END,O,A),S(o,n,c,0,P.RIGHT_JOIN_END,O,A);let G=this.numJoinSubdivisions;for(let ne=0;ne<G;++ne){let Oe=(ne+1)/(G+1);S(o,n,c,Oe,P.LEFT_JOIN_END,O,A),S(o,n,c,Oe,P.RIGHT_JOIN_END,O,A)}S(o,n,c,1,P.LEFT_JOIN_START,O,A),S(o,n,c,1,P.RIGHT_JOIN_START,O,A),V(o,n),V(n,c)}H?(U(c,u.data[3],u.data[4],u.data[5]),e&&D(c,c,e),A=ee(o,n,ae),S(o,n,c,0,P.LEFT_JOIN_END,Be,A),S(o,n,c,0,P.RIGHT_JOIN_END,Be,A)):(A=ee(o,n,ae),S(o,n,n,0,P.LEFT_CAP_END,ae,A),S(o,n,n,0,P.RIGHT_CAP_END,ae,A)),$e(g,k+C,g,k,C),p=$e(g,p-C,g,p,C),this._parameters.wireframe&&this._addWireframeVertices(s,k,p,C)}_addWireframeVertices(e,t,i,a){let s=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),l=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t),o=0,n=c=>o=$e(l,c,s,o,a);for(let c=0;c<l.length-1;c+=2*a)n(c),n(c+2*a),n(c+1*a),n(c+2*a),n(c+1*a),n(c+3*a)}};function $e(r,e,t,i,a){for(let s=0;s<a;s++)t[i++]=r[e++];return i}function nt(r,e){return r.isClosed?e.get(h.POSITION).indices.length>2:!1}function Br(r){return r.anchor===ur.Tip&&r.hideOnShortSegments&&r.placement==="begin-end"&&r.worldSpace}var R=_(),I=_(),W=_(),Q=_(),Fr=_(),$=J(),K=J(),Or=_(),br=_(),vr=ke(),Vr=ke(),Wr=_(),Gr=_(),zr=_(),Te=[J(),J(),J(),J()],z=[_(),_(),_(),_()],Ke=he(),et=he(),tt=he(),rt=he();var Ar=class{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}};function ot(r){return"array"in r}function Ee(r,e,t="ground"){if(Ce(e))return r.getElevation(e.x,e.y,e.z||0,e.spatialReference,t);if(ot(e)){let i=e.offset;return r.getElevation(e.array[i++],e.array[i++],e.array[i]||0,e.spatialReference??r.spatialReference,t)}return r.getElevation(e[0],e[1],e[2]||0,r.spatialReference,t)}function ds(r,e,t,i,a,s,l,o,n,c,u){let m=Xr[u.mode],d,f,b=0;if(le(r,e,t,i,n.spatialReference,a,o))return m?.requiresAlignment(u)?(b=m.applyElevationAlignmentBuffer(i,a,s,l,o,n,c,u),d=s,f=l):(d=i,f=a),le(d,n.spatialReference,f,s,c.spatialReference,l,o)?b:void 0}function yr(r,e,t,i,a){let s=(Ce(r)?r.z:ot(r)?r.array[r.offset+2]:r[2])||0;switch(t.mode){case"on-the-ground":{let l=Ee(e,r,"ground")??0;return a.verticalDistanceToGround=0,a.sampledElevation=l,void(a.z=l)}case"relative-to-ground":{let l=Ee(e,r,"ground")??0,o=t.geometryZWithOffset(s,i);return a.verticalDistanceToGround=o,a.sampledElevation=l,void(a.z=o+l)}case"relative-to-scene":{let l=Ee(e,r,"scene")??0,o=t.geometryZWithOffset(s,i);return a.verticalDistanceToGround=o,a.sampledElevation=l,void(a.z=o+l)}case"absolute-height":{let l=t.geometryZWithOffset(s,i),o=Ee(e,r,"ground")??0;return a.verticalDistanceToGround=l-o,a.sampledElevation=o,void(a.z=l)}default:return void(a.z=0)}}function fs(r,e,t,i){return yr(r,e,t,i,se),se.z}function ps(r,e,t){return e==="on-the-ground"&&t==="on-the-ground"?r.staysOnTheGround:e===t||e!=="on-the-ground"&&t!=="on-the-ground"?e==null||t==null?r.definedChanged:ct.UPDATE:r.onTheGroundChanged}function gs(r){return r==="relative-to-ground"||r==="relative-to-scene"}function _s(r){return r!=="absolute-height"}function Ts(r,e,t,i,a){yr(e,t,a,i,se),kr(r,se.verticalDistanceToGround);let s=se.sampledElevation,l=ce(Qr,r.transformation);return je[0]=e.x,je[1]=e.y,je[2]=se.z,It(e.spatialReference,je,l,i.spatialReference)?r.transformation=l:console.warn("Could not locate symbol object properly, it might be misplaced"),s}function kr(r,e){for(let t=0;t<r.geometries.length;++t){let i=r.geometries[t].getMutableAttribute(h.CENTEROFFSETANDDISTANCE);i&&i.data[3]!==e&&(i.data[3]=e,r.geometryVertexAttributeUpdated(r.geometries[t],h.CENTEROFFSETANDDISTANCE))}}function Hr(r,e,t,i,a,s){let l=0,o=s.spatialReference;e*=3,i*=3;for(let n=0;n<a;++n){let c=r[e],u=r[e+1],m=r[e+2],d=s.getElevation(c,u,m,o,"ground")??0;l+=d,t[i]=c,t[i+1]=u,t[i+2]=d,e+=3,i+=3}return l/a}function Jr(r,e,t,i,a,s,l,o){let n=0,c=o.calculateOffsetRenderUnits(l),u=o.featureExpressionInfoContext,m=s.spatialReference;e*=3,i*=3;for(let d=0;d<a;++d){let f=r[e],b=r[e+1],E=r[e+2],y=s.getElevation(f,b,E,m,"ground")??0;n+=y,t[i]=f,t[i+1]=b,t[i+2]=u==null?E+y+c:y+c,e+=3,i+=3}return n/a}function Zr(r,e,t,i,a,s,l,o){let n=0,c=o.calculateOffsetRenderUnits(l),u=o.featureExpressionInfoContext,m=s.spatialReference;e*=3,i*=3;for(let d=0;d<a;++d){let f=r[e],b=r[e+1],E=r[e+2],y=s.getElevation(f,b,E,m,"scene")??0;n+=y,t[i]=f,t[i+1]=b,t[i+2]=u==null?E+y+c:y+c,e+=3,i+=3}return n/a}function Yr(r){let e=r.meterUnitOffset,t=r.featureExpressionInfoContext;return e!==0||t!=null}function qr(r,e,t,i,a,s,l,o){let n=o.calculateOffsetRenderUnits(l),c=o.featureExpressionInfoContext;e*=3,i*=3;for(let u=0;u<a;++u){let m=r[e],d=r[e+1],f=r[e+2];t[i]=m,t[i+1]=d,t[i+2]=c==null?f+n:n,e+=3,i+=3}return 0}var lt=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},ct;(function(r){r[r.NONE=0]="NONE",r[r.UPDATE=1]="UPDATE",r[r.RECREATE=2]="RECREATE"})(ct||(ct={}));var Xr={"absolute-height":{applyElevationAlignmentBuffer:qr,requiresAlignment:Yr},"on-the-ground":{applyElevationAlignmentBuffer:Hr,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Jr,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:Zr,requiresAlignment:()=>!0}},Qr=re(),se=new lt,je=_();var $r=()=>ve.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Sr(r){return{cachedResult:r.cachedResult,arcade:r.arcade?{func:r.arcade.func,context:r.arcade.modules.arcadeUtils.createExecContext(null,{sr:r.arcade.context.spatialReference}),modules:r.arcade.modules}:null}}function ys(r,e,t,i){return ht(this,null,function*(){let a=r?.expression;if(typeof a!="string")return null;let s=Kr(a);if(s!=null)return{cachedResult:s};let l=yield ar();ft(t);let o=l.arcadeUtils,n=o.createSyntaxTree(a);return o.dependsOnView(n)?(i?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(n),context:o.createExecContext(null,{sr:e}),modules:l}}})}function Rr(r,e,t){return r.arcadeUtils.createFeature(e.attributes,e.geometry,t)}function Ir(r,e){if(r!=null&&!Cr(r)){if(!e||!r.arcade)return void $r().errorOncePerTick("Arcade support required but not provided");let t=e;t._geometry&&(t._geometry=cr(t._geometry)),r.arcade.modules.arcadeUtils.updateExecContext(r.arcade.context,e)}}function xr(r){if(r!=null){if(Cr(r))return r.cachedResult;let e=r.arcade,t=e?.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof t!="number"&&(r.cachedResult=0,t=0),t}return 0}function Ss(r,e=!1){let t=r?.featureExpressionInfo,i=t?.expression;return e||i==="0"||(t=null),t??null}var Rs={cachedResult:0};function Cr(r){return r.cachedResult!=null}function Kr(r){return r==="0"?0:null}var Pr=class r{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=Et(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){let i=this.calculateOffsetRenderUnits(t);return this.featureExpressionInfoContext!=null?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset,i=this.featureExpressionInfoContext;return i!=null&&(t+=xr(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=Tt(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,i){if(e==null)return void(this._featureExpressionInfoContext=null);let a=e?.arcade;a&&t!=null&&i!=null?(this._featureExpressionInfoContext=Sr(e),Ir(this._featureExpressionInfoContext,Rr(a.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){let t=new r;return e!=null&&t.setFromElevationInfo(e),t}};var Lr=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var we=class extends Re{constructor(e,t,i=""){super(),this.stage=e,this.apiLayerUid=i,this.type=ie.Layer,this.events=new gt,this.visible=!0,this.sliceable=!1,this._objectsAdded=new Fe,this._handles=new mt,this._objects=new Fe,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??ge.ASYNC,this._disableOctree=t?.disableOctree??!1,e.add(this);for(let a of Lr)this._handles.add(this.events.on(a,s=>e.handleEvent(a,s)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),this._octree!=null&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(let t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),this._octree!=null&&this._objectsAdded.pushArray(e)}removeMany(e){let t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),t.length!==0){for(let i of t)i.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),this._octree!=null){for(let i=0;i<t.length;)this._objectsAdded.removeUnordered(t[i])?(t[i]=t[t.length-1],t.length-=1):++i;this._octree.remove(t)}}}sync(){this.updatePolicy!==ge.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new nr(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=dt(this._octree),this._objectsAdded.clear()}};var ut=class{constructor(e,t){this.vec3=e,this.id=t}};function Me(r,e,t,i){return new ut(oe(r,e,t),i)}var Hs={stableRendering:!1},Nr={rootOrigin:null};var Ur=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+pt(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){let t=this._origins.get(this._rootOriginId);if(t==null){let u=Nr.rootOrigin;if(u!=null)return this._origins.set(this._rootOriginId,Me(u[0],u[1],u[2],this._rootOriginId)),this.getOrigin(e);let m=Me(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,m),m}let i=this._gridSize,a=Math.round(e[0]/i),s=Math.round(e[1]/i),l=Math.round(e[2]/i),o=`${a}/${s}/${l}`,n=this._origins.get(o),c=.5*i;if(Z(v,e,t.vec3),v[0]=Math.abs(v[0]),v[1]=Math.abs(v[1]),v[2]=Math.abs(v[2]),v[0]<c&&v[1]<c&&v[2]<c){if(n){let u=Math.max(...v);if(Z(v,e,n.vec3),v[0]=Math.abs(v[0]),v[1]=Math.abs(v[1]),v[2]=Math.abs(v[2]),Math.max(...v)<u)return n}return t}return n||(n=Me(a*i,s*i,l*i,o),this._origins.set(o,n)),n}_drawOriginBox(e,t=Ot(1,1,0,1)){let i=window.view,a=i._stage,s=t.toString();if(!this._objects.has(s)){this._material=new De({width:2,color:t}),a.add(this._material);let f=new we(a,{pickable:!1}),b=new Pe({castShadow:!1});a.add(b),f.add(b),this._objects.set(s,b)}let l=this._objects.get(s),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],n=o.length,c=new Array(3*n),u=new Array,m=.5*this._gridSize;for(let f=0;f<n;f++)c[3*f]=e[0]+(1&o[f]?m:-m),c[3*f+1]=e[1]+(2&o[f]?m:-m),c[3*f+2]=e[2]+(4&o[f]?m:-m),f>0&&u.push(f-1,f);le(c,this._originSR,0,c,i.renderSpatialReference,0,n);let d=new Gt(this._material,[[h.POSITION,new jt(c,u,3,!0)]],null,ie.Line);a.add(d),l.addGeometry(d)}get test(){}},v=_();export{pr as a,gr as b,_r as c,ge as d,Pe as e,we as f,Me as g,Hs as h,De as i,Ur as j,Ar as k,Ee as l,ds as m,yr as n,fs as o,ps as p,gs as q,_s as r,Ts as s,kr as t,lt as u,ct as v,ys as w,Rr as x,Ir as y,Ss as z,Rs as A,Pr as B};
