import{a as Ae,b as bt}from"./chunk-G27DRLGO.js";import{a as de,b as Z,c as U,d as ee,e as Ve,f as Ee,g as Rt,h as At}from"./chunk-7LF5QJDR.js";import{c as Vt}from"./chunk-DV32PZA3.js";import{b as ce,c as lt,d as Te,e as ve,f as ut,g as ct,h as ht,i as dt,j as mt,k as ft,l as pt,n as yt,o as gt,p as he,q as xt}from"./chunk-2EW3SBKG.js";import{m as rt}from"./chunk-3ZANJLLA.js";import{a as Ft}from"./chunk-K3Z3MI77.js";import{b as St,c as It,d as Tt,e as vt}from"./chunk-4XPPVS7X.js";import{a as be,b as k,c as _t,e as O,f as wt,g as Re,i as G}from"./chunk-O4PKXMAM.js";import{a as Se}from"./chunk-SP2CO3KX.js";import{a as et}from"./chunk-C5DQZVZ7.js";import{f as ze}from"./chunk-NFWLUI2Z.js";import{a as nt}from"./chunk-EBK2L6ZQ.js";import{a as Ie}from"./chunk-AESEF3B2.js";import{a as Xe,e as Ke}from"./chunk-LNVVFNTC.js";import{a as ue}from"./chunk-JEIB6WNP.js";import{C as st,K as at,d as tt,j as it}from"./chunk-TRZXSDYA.js";import{K as fe,L as Be,M as te,N as ie,O as L}from"./chunk-HKHTIKVW.js";import{b as me}from"./chunk-IJBTA53P.js";import{l as ot}from"./chunk-IB2IUO7T.js";import{c as Le,d as $e}from"./chunk-7N3ZKWML.js";import{b as We,g as we,h as Ye}from"./chunk-QDTU3MWT.js";import{a as Je,c as _e}from"./chunk-3SDSCSDJ.js";import{F as Y,ia as le,p as Q}from"./chunk-IG66NQHW.js";import{f as Ue}from"./chunk-7EG726PT.js";import{i as He,k as Fe,u as ke,v as z}from"./chunk-D2LVMNOU.js";import{b as W,t as E}from"./chunk-HHDFN2GK.js";import{l as Ze,m as je}from"./chunk-47GHT6OF.js";import{a as A,b as B,c as oe,f as m}from"./chunk-VTHXE323.js";var zt=new et(50,500),se="unsupported-query",Bt=" as ",Qe=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeBigInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),De=new Set(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]),kt=new Set(["esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID",...Qe,...De]);function Ce(l,e,t={}){let i=q(e,l);if(!i){let a=zt.getError(e,l);throw new E(se,"invalid SQL expression",{expression:e,error:a})}let s=t.expressionName||"expression";if(t.validateStandardized&&!i.isStandardized)throw new E(se,`${s} is not standard`,{expression:e});if(t.validateAggregate&&!i.isAggregate)throw new E(se,`${s} does not contain a valid aggregate function`,{expression:e});return i.fieldNames}function Qt(l,e,t,i){if(!t)return!0;let s="where clause";return P(l,e,Ce(l,t,{validateStandardized:!0,expressionName:s}),{expressionName:s,query:i}),!0}function Dt(l,e,t,i,s){if(!t)return!0;let a="having clause",r=Ce(l,t,{validateAggregate:!0,expressionName:a});if(P(l,e,r,{expressionName:a,query:s}),!q(t,l)?.getExpressions().every(u=>{let{aggregateType:c,field:h}=u,d=l.get(h)?.name;return i.some(f=>{let{onStatisticField:g,statisticType:p}=f;return l.get(g)?.name===d&&p.toLowerCase().trim()===c})}))throw new E(se,"expressions in having clause should also exist in outStatistics",{having:t});return!0}function q(l,e){return l?zt.get(l,e):null}function qe(l){return/\((.*?)\)/.test(l)?l:l.split(Bt)[0]}function Ct(l){return l.split(Bt)[1]}function P(l,e,t,i={}){let s=new Map;if(Ut(s,l,e,i.allowedFieldTypes??kt,t),s.size){let a=i.expressionName??"expression";throw new E(se,`${a} contains invalid or missing fields`,{errors:Array.from(s.values()),query:i.query})}}function Ut(l,e,t,i,s){let a=s.includes("*")?[...t,...s.filter(r=>r!=="*")]:s;for(let r of a)if(e.get(r))Et(l,e,t,i,r);else try{let n=Ce(e,qe(r),{validateStandardized:!0});for(let o of n)Et(l,e,t,i,o)}catch(n){l.set(r,{type:"expression-error",expression:r,error:n})}}function Et(l,e,t,i,s){let a=e.get(s);a?t.has(a.name)?i!=="all"&&i?.has(a.type)===!1&&l.set(s,{type:"invalid-type",fieldName:a.name,fieldType:Ie.fromJSON(a.type),allowedFieldTypes:Array.from(i,r=>Ie.fromJSON(r))}):l.set(s,{type:"missing-field",fieldName:a.name}):l.set(s,{type:"invalid-field",fieldName:s})}var Lt=5,pe=class{constructor(){this._storage=new Map,this._purgeInterval=Lt,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;let e=1e3*this._purgeInterval,t=performance.now()-e;for(let[i,s]of this._storage){if(!(s.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(i)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new Pe(t)),this._scheduleSweep()}get(e){let t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??=setTimeout(this._sweep,1e3*this._purgeInterval))}get test(){}},$t=0,Pe=class{constructor(e){this.items=e,this.time=performance.now(),this.id=$t++}};var j=class{constructor(e,t,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues??!1,this.fieldsIndex=i,this.featureAdapter=t;let s=e.outFields;if(s&&!s.includes("*")){this.outFields=s;let a=0;for(let r of s){let n=qe(r),o=this.fieldsIndex.get(n),u=o?null:q(n,i),c=o?o.name:Ct(r)||"FIELD_EXP_"+a++;this._fieldDataCache.set(r,{alias:c,clause:u})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(t=>this.getAttributes(t)),this._returnDistinctMap.size):e.length}getAttributes(e){let t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,i){let s=i?i.name:t,a=null;return this._fieldDataCache.has(s)?a=this._fieldDataCache.get(s)?.clause:i||(a=q(t,this.fieldsIndex),this._fieldDataCache.set(s,{alias:s,clause:a})),i?this.featureAdapter.getAttribute(e,s):a?.calculateValue(e,this.featureAdapter)}getDataValues(e,t,i=!0){let s=t.normalizationType,a=t.normalizationTotal,r=this.fieldsIndex.get(t.field),n=te(r)||ie(r),o=L(r);return e.map(u=>{let c=t.field&&this.getFieldValue(u,t.field,this.fieldsIndex.get(t.field));if(t.field2?(c=`${ce(c)}${t.fieldDelimiter}${ce(this.getFieldValue(u,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(c=`${c}${t.fieldDelimiter}${ce(this.getFieldValue(u,t.field3,this.fieldsIndex.get(t.field3)))}`)):typeof c=="string"&&i&&(n?c=c?new Date(c).getTime():null:o&&(c=c?Vt(c):null)),s&&Number.isFinite(c)){let h=s==="field"&&t.normalizationField?this.getFieldValue(u,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;c=ft(c,s,h,a)}return c})}getExpressionValues(e,t,i,s,a){return m(this,null,function*(){let{arcadeUtils:r}=yield me(),n=r.hasGeometryOperations(t);n&&(yield r.enableGeometryOperations());let o=r.createFunction(t),u=r.getViewInfo(i),c={fields:this.fieldsIndex.fields};return e.map(h=>{let d={attributes:this.featureAdapter.getAttributes(h),layer:c,geometry:n?B(A({},Z(s.geometryType,s.hasZ,s.hasM,this.featureAdapter.getGeometry(h))),{spatialReference:i?.spatialReference}):null},f=r.createExecContext(d,u,a);return r.executeFunction(o,f)})})}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:q(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testFeature(e,this.featureAdapter)??!1}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:q(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testSet(e,this.featureAdapter)??!1}_processAttributesForOutFields(e){let t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);let i={};for(let s of t){let{alias:a,clause:r}=this._fieldDataCache.get(s);i[a]=r?r.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,a)}return i}_processAttributesForDistinctValues(e){if(e==null||!this.returnDistinctValues)return e;let t=this.outFields,i=[];if(t)for(let r of t){let{alias:n}=this._fieldDataCache.get(r);i.push(e[n])}else for(let r in e)i.push(e[r]);let s=`${(t||["*"]).join(",")}=${i.join(",")}`,a=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++a),a>1?null:e}};var X="bin",V=class{constructor(e,t,i){this.items=e,this.query=t,this.geometryType=i.geometryType,this.hasM=i.hasM,this.hasZ=i.hasZ,this.fieldsIndex=i.fieldsIndex,this.objectIdField=i.objectIdField,this.spatialReference=i.spatialReference,this.featureAdapter=i.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){let e=new j(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);let{groupByFieldsForStatistics:t,having:i,outStatistics:s}=this.query;if(!t?.length)return 1;let r=new Map,n=new Map,o=new Set;for(let u of s){let{statisticType:c}=u,h=c!=="exceedslimit"?u.onStatisticField:void 0;if(!n.has(h)){let f=[];for(let g of t){let p=this._getAttributeValues(e,g,this.items,r);f.push(p)}n.set(h,this._calculateUniqueValues(f,this.items,e.returnDistinctValues))}let d=n.get(h);for(let f in d){let{data:g,items:p}=d[f],y=g.join(",");i&&!e.validateItems(p,i)||o.add(y)}}return o.size}createQueryResponse(){return m(this,null,function*(){let e;if(this.query.outStatistics?e=this.query.outStatistics.some(t=>t.statisticType==="exceedslimit")?this._createExceedsLimitQueryResponse():yield this._createStatisticsQueryResponse(this.query,this.items):e=this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){let t=this.query.geometry;Y(this.query.outSR)&&!Q(t.spatialReference,this.query.outSR)?e.queryGeometry=U(A({spatialReference:this.query.outSR},k(t,t.spatialReference,this.query.outSR))):e.queryGeometry=U(A({spatialReference:this.query.outSR},t))}return e})}createSnappingResponse(e,t){let i=this.featureAdapter,s=qt(this.hasZ,this.hasM),{point:a,mode:r}=e,n=typeof e.distance=="number"?e.distance:e.distance.x,o=typeof e.distance=="number"?e.distance:e.distance.y,u={candidates:[]},c=this.geometryType==="esriGeometryPolygon",h=this.geometryType==="esriGeometryPolyline"||this.geometryType==="esriGeometryPoint",d=this._getPointCreator(r,this.spatialReference,t),f=new ye(null,0),g=new ye(null,0),p={x:0,y:0,z:0};for(let y of this.items){let F=i.getGeometry(y);if(F==null)continue;let{coords:I}=F,v=F.isPoint?Wt:F.lengths;if(f.coords=I,g.coords=I,e.returnEdge){let w=0;for(let x=0;x<v.length;x++){let S=v[x],_=w;for(let T=0;T<S;T++,w+=s){if(!c&&T===S-1)continue;let R=f;R.coordsIndex=w;let b=g;b.coordsIndex=T===S-1?_:w+s;let D=p;if(!Jt(p,a,R,b))continue;let C=(a.x-D.x)/n,H=(a.y-D.y)/o,ae=C*C+H*H;ae<=1&&u.candidates.push(bt(i.getObjectId(y),d(D),Math.sqrt(ae),d(R),d(b)))}}}if(e.vertexMode==="all"){let w=0;for(let x=0;x<v.length;x++){let S=v[x],_=w,T=g;T.coordsIndex=_;for(let R=0;R<S;R++,w+=s){let b=f;if(b.coordsIndex=w,c&&R===S-1&&b.x===T.x&&b.y===T.y)continue;let D=(a.x-b.x)/n,C=(a.y-b.y)/o,H=D*D+C*C;H<=1&&u.candidates.push(Ae(i.getObjectId(y),d(b),Math.sqrt(H)))}}}else if(h&&e.vertexMode==="ends"){let w=0,x=[];for(let S=0;S<v.length;S++){x.push(w);let _=v[S];w+=_*s,!c&&_>1&&x.push(w-s)}for(let S of x){let _=f;_.coordsIndex=S;let T=(a.x-_.x)/n,R=(a.y-_.y)/o,b=T*T+R*R;b<=1&&u.candidates.push(Ae(i.getObjectId(y),d(_),Math.sqrt(b)))}}}return u.candidates.sort((y,F)=>y.distance-F.distance),u}_getPointCreator(e,t,i){let s=i==null||Q(t,i)?n=>n:n=>k(n,t,i),{hasZ:a}=this,r=0;return e==="3d"?a?({x:n,y:o,z:u})=>s({x:n,y:o,z:u}):({x:n,y:o})=>s({x:n,y:o,z:r}):({x:n,y:o})=>s({x:n,y:o})}createSummaryStatisticsResponse(e){return m(this,null,function*(){let{field:t,valueExpression:i,normalizationField:s,normalizationType:a,normalizationTotal:r,minValue:n,maxValue:o,scale:u,timeZone:c,outStatisticTypes:h}=e,d=this.fieldsIndex.get(t),f=Be(d)||te(d)||ie(d),g=yield this._getDataValues({field:t,valueExpression:i,normalizationField:s,normalizationType:a,normalizationTotal:r,scale:u,timeZone:c},this.items),p=lt({normalizationType:a,normalizationField:s,minValue:n,maxValue:o}),y={value:.5,fieldType:d?.type},F=fe(d)?Te({values:g,supportsNullCount:p,percentileParams:y,outStatisticTypes:h}):ve({values:g,minValue:n,maxValue:o,useSampleStdDev:!a,supportsNullCount:p,percentileParams:y,outStatisticTypes:h});return ht(F,h,f)})}createUniqueValuesResponse(e){return m(this,null,function*(){let{field:t,valueExpression:i,domains:s,returnAllCodedValues:a,scale:r,timeZone:n}=e,o=yield this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:i,scale:r,timeZone:n},this.items,!1),u=dt(o);return mt(u,s,a,e.fieldDelimiter)})}createClassBreaksResponse(e){return m(this,null,function*(){let{field:t,valueExpression:i,normalizationField:s,normalizationType:a,normalizationTotal:r,classificationMethod:n,standardDeviationInterval:o,minValue:u,maxValue:c,numClasses:h,scale:d,timeZone:f}=e,g=yield this._getDataValues({field:t,valueExpression:i,normalizationField:s,normalizationType:a,normalizationTotal:r,scale:d,timeZone:f},this.items),p=pt(g,{field:t,normalizationField:s,normalizationType:a,normalizationTotal:r,classificationMethod:n,standardDeviationInterval:o,minValue:u,maxValue:c,numClasses:h});return yt(p,n)})}createHistogramResponse(e){return m(this,null,function*(){let{field:t,valueExpression:i,normalizationField:s,normalizationType:a,normalizationTotal:r,classificationMethod:n,standardDeviationInterval:o,minValue:u,maxValue:c,numBins:h,scale:d,timeZone:f}=e,g=yield this._getDataValues({field:t,valueExpression:i,normalizationField:s,normalizationType:a,normalizationTotal:r,scale:d,timeZone:f},this.items);return gt(g,{field:t,normalizationField:s,normalizationType:a,normalizationTotal:r,classificationMethod:n,standardDeviationInterval:o,minValue:u,maxValue:c,numBins:h})})}_sortFeatures(e,t,i){if(e.length>1&&t?.length)for(let s of t.slice().reverse()){let a=s.split(" "),r=a[0],n=this.fieldsIndex.get(r),o=!!a[1]&&a[1].toLowerCase()==="desc",u=ct(n?.type,o);e.sort((c,h)=>{let d=i(c,r,n),f=i(h,r,n);return u(d,f)})}}_createFeatureQueryResponse(e){let{items:t,geometryType:i,hasM:s,hasZ:a,objectIdField:r,spatialReference:n}=this,{outFields:o,outSR:u,quantizationParameters:c,resultRecordCount:h,resultOffset:d,returnZ:f,returnM:g}=e,p=h!=null&&t.length>(d||0)+h,y=o&&(o.includes("*")?[...this.fieldsIndex.fields]:o.map(F=>this.fieldsIndex.get(F)));return{exceededTransferLimit:p,features:this._createFeatures(e,t),fields:y,geometryType:i,hasM:s&&g,hasZ:a&&f,objectIdFieldName:r,spatialReference:U(u||n),transform:c&&Se(c)||null}}_createFeatures(e,t){let i=new j(e,this.featureAdapter,this.fieldsIndex),{hasM:s,hasZ:a}=this,{orderByFields:r,quantizationParameters:n,returnGeometry:o,returnCentroid:u,maxAllowableOffset:c,resultOffset:h,resultRecordCount:d,returnZ:f=!1,returnM:g=!1}=e,p=a&&f,y=s&&g,F=[],I=0,v=[...t];if(this._sortFeatures(v,r,(x,S,_)=>i.getFieldValue(x,S,_)),this.geometryType&&(o||u)){let x=Se(n)??void 0,S=this.geometryType==="esriGeometryPolygon"||this.geometryType==="esriGeometryPolyline";if(o&&!u)for(let _ of v){let T=this.featureAdapter.getGeometry(_),R={attributes:i.getAttributes(_),geometry:Z(this.geometryType,this.hasZ,this.hasM,T,c,x,p,y)};S&&T&&!R.geometry&&(R.centroid=de(this,this.featureAdapter.getCentroid(_,this),x)),F[I++]=R}else if(!o&&u)for(let _ of v)F[I++]={attributes:i.getAttributes(_),centroid:de(this,this.featureAdapter.getCentroid(_,this),x)};else for(let _ of v)F[I++]={attributes:i.getAttributes(_),centroid:de(this,this.featureAdapter.getCentroid(_,this),x),geometry:Z(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(_),c,x,p,y)}}else for(let x of v){let S=i.getAttributes(x);S&&(F[I++]={attributes:S})}let w=h||0;if(d!=null){let x=w+d;F=F.slice(w,Math.min(F.length,x))}return F}_createExceedsLimitQueryResponse(){let e=!1,t=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY;for(let a of this.query.outStatistics??[])if(a.statisticType==="exceedslimit"){t=a.maxPointCount!=null?a.maxPointCount:Number.POSITIVE_INFINITY,i=a.maxRecordCount!=null?a.maxRecordCount:Number.POSITIVE_INFINITY,s=a.maxVertexCount!=null?a.maxVertexCount:Number.POSITIVE_INFINITY;break}if(this.geometryType==="esriGeometryPoint")e=this.items.length>t;else if(this.items.length>i)e=!0;else{let a=qt(this.hasZ,this.hasM),r=this.featureAdapter;e=this.items.reduce((n,o)=>{let u=r.getGeometry(o);return n+(u!=null&&u.coords.length||0)},0)/a>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}_createStatisticsQueryResponse(s,a){return m(this,arguments,function*(e,t,i={attributes:{}}){let r=[],n=new Map,o=new Map,u=new Map,c=new Map,h=new j(e,this.featureAdapter,this.fieldsIndex),d=e.outStatistics,{groupByFieldsForStatistics:f,having:g,orderByFields:p,resultRecordCount:y}=e,F=f?.length,I=!!F,v=I?f[0]:null,w=I&&!this.fieldsIndex.get(v);for(let S of d??[]){let{outStatisticFieldName:_,statisticType:T}=S,R=S,b=T!=="exceedslimit"?S.onStatisticField:void 0,D=T==="percentile_disc"||T==="percentile_cont",C=T==="EnvelopeAggregate"||T==="CentroidAggregate"||T==="ConvexHullAggregate",H=I&&F===1&&(b===v||w)&&T==="count";if(I){if(!u.has(b)){let re=[];for(let xe of f){let ne=this._getAttributeValues(h,xe,t,n);re.push(ne)}u.set(b,this._calculateUniqueValues(re,t,!C&&h.returnDistinctValues))}let M=u.get(b);if(!M)continue;let ge=Object.keys(M);for(let re of ge){let{count:xe,data:ne,items:Ne,itemPositions:Zt}=M[re],Oe=ne.join(",");if(!g||h.validateItems(Ne,g)){let J=c.get(Oe)||{attributes:{}};if(C){J.aggregateGeometries||(J.aggregateGeometries={});let{aggregateGeometries:N,outStatisticFieldName:K}=yield this._getAggregateGeometry(R,Ne);J.aggregateGeometries[K]=N}else{let N=null;if(H)N=xe;else{let K=this._getAttributeValues(h,b,t,n),Ge=Zt.map(Ht=>K[Ht]);N=D&&"statisticParameters"in R?this._getPercentileValue(R,Ge):this._getStatisticValue(R,Ge,null,h.returnDistinctValues)}J.attributes[_]=N}let jt=0;f.forEach((N,K)=>J.attributes[this.fieldsIndex.get(N)?N:"EXPR_"+ ++jt]=ne[K]),c.set(Oe,J)}}}else if(C){i.aggregateGeometries||(i.aggregateGeometries={});let{aggregateGeometries:M,outStatisticFieldName:ge}=yield this._getAggregateGeometry(R,t);i.aggregateGeometries[ge]=M}else{let M=this._getAttributeValues(h,b,t,n);i.attributes[_]=D&&"statisticParameters"in R?this._getPercentileValue(R,M):this._getStatisticValue(R,M,o,h.returnDistinctValues)}let ae=T!=="min"&&T!=="max"||!fe(this.fieldsIndex.get(b))&&!this._isAnyDateField(b)?null:this.fieldsIndex.get(b)?.type;r.push({name:_,alias:_,type:ae||"esriFieldTypeDouble"})}let x=I?Array.from(c.values()):[i];return this._sortFeatures(x,p,(S,_)=>S.attributes[_]),y&&(x.length=Math.min(y,x.length)),{fields:r,features:x}})}_isAnyDateField(e){let t=this.fieldsIndex.get(e);return Be(t)||te(t)||ie(t)||L(t)}_getAggregateGeometry(e,t){return m(this,null,function*(){let{convexHull:i,union:s}=yield import("./chunk-FOYQ56X5.js"),{statisticType:a,outStatisticFieldName:r}=e,{featureAdapter:n,spatialReference:o,geometryType:u,hasZ:c,hasM:h}=this,d=t.map(p=>Z(u,c,h,n.getGeometry(p))),f=i(o,d,!0)[0],g={aggregateGeometries:null,outStatisticFieldName:null};if(a==="EnvelopeAggregate"){let p=f?Ye(f):we(s(o,d));g.aggregateGeometries=B(A({},p),{spatialReference:o}),g.outStatisticFieldName=r||"extent"}else if(a==="CentroidAggregate"){let p=f?$e(f):Le(we(s(o,d)));g.aggregateGeometries={x:p[0],y:p[1],spatialReference:o},g.outStatisticFieldName=r||"centroid"}else a==="ConvexHullAggregate"&&(g.aggregateGeometries=f,g.outStatisticFieldName=r||"convexHull");return g})}_getStatisticValue(e,t,i,s){let{onStatisticField:a,statisticType:r}=e,n=null;return n=i?.has(a)?i.get(a):fe(this.fieldsIndex.get(a))||this._isAnyDateField(a)?Te({values:t,returnDistinct:s}):ve({values:s?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),i&&i.set(a,n),n[r==="var"?"variance":r]}_getPercentileValue(e,t){let{onStatisticField:i,statisticParameters:s,statisticType:a}=e,{value:r,orderBy:n}=s,o=this.fieldsIndex.get(i);return ut(t,{value:r,orderBy:n,fieldType:o?.type,isDiscrete:a==="percentile_disc"})}_getAttributeValues(e,t,i,s){if(s.has(t))return s.get(t);let a=this.fieldsIndex.get(t),r=i.map(n=>e.getFieldValue(n,t,a));return s.set(t,r),r}_calculateUniqueValues(e,t,i){let s={},a=t.length;for(let r=0;r<a;r++){let n=t[r],o=[];for(let c of e)o.push(c[r]);let u=o.join(",");s[u]==null?s[u]={count:1,data:o,items:[n],itemPositions:[r]}:(i||s[u].count++,s[u].items.push(n),s[u].itemPositions.push(r))}return s}_getDataValues(e,t,i=!0){return m(this,null,function*(){let s=new j(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:a,scale:r,timeZone:n}=e;return a?s.getExpressionValues(t,a,{viewingMode:"map",scale:r,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},n):s.getDataValues(t,W(e),i)})}_calculateHistogramBins(e,t,i){return m(this,null,function*(){if(t.min==null&&t.max==null)return[];let s=t.intervals,a=t.min??0,r=t.max??0,n=s.map(([o,u])=>({minValue:o,maxValue:u,count:0,items:[]}));for(let o=0;o<e.length;o++){let u=e[o],c=i[o];if(u!=null&&u>=a&&u<=r){let h=xt(s,u);h>-1&&(n[h].count++,n[h].items.push(c))}}return n})}createQueryBinsResponse(e){return m(this,null,function*(){let t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);let{value:i,outAlias:s,valueType:a}=t,r=[],n=[{name:s??i,alias:s??i,type:a??"esriFieldTypeString"},{name:X,alias:X,type:"esriFieldTypeInteger"}],o=new j(e,this.featureAdapter,this.fieldsIndex),u=new Map,c=[...this.items];this._sortFeatures(c,[i],(f,g,p)=>o.getFieldValue(f,g,p));let h=this._getAttributeValues(o,i,c,u),d=this._calculateUniqueValues([h],c,o.returnDistinctValues);for(let f in d){let{items:g}=d[f],p=yield this._createBinsResponse(e,g);if(r.push(...p.features.map(y=>B(A({},y),{attributes:B(A({},y.attributes),{[s??i]:f})}))),p.fields)for(let y of p.fields)n.some(F=>F.name===y.name)||n.push(y)}return{fields:n,features:r}})}_createBinsResponse(e,t){return m(this,null,function*(){let i=e.bin;switch(t=t??this.items,i.type){case"autoIntervalBin":return this._createAutoIntervalBinsResponse(St.fromJSON(i),e,t);case"dateBin":return this._createDateBinsResponse(It.fromJSON(i),e,t);case"fixedBoundariesBin":return this._createFixedBoundariesBinsResponse(Tt.fromJSON(i),e,t);case"fixedIntervalBin":return this._createFixedIntervalBinsResponse(vt.fromJSON(i),e,t)}})}_createAutoIntervalBinsResponse(e,t,i){return m(this,null,function*(){let{field:s,normalizationField:a,numBins:r,normalizationType:n,normalizationTotal:o,start:u,end:c}=e,h=yield this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},i),d=he(h,{field:s,normalizationField:a,normalizationType:n,normalizationTotal:o,numBins:r,minValue:G(u,!1),maxValue:G(c,!1)}),f=yield this._calculateHistogramBins(h,d,i);return this._createFeaturesFromHistogramBins(f,t)})}_createDateBinsResponse(e,t,i){return m(this,null,function*(){let{field:s,interval:a,start:r,end:n}=e,o=a.unit,u=o==="quarters"?3*ue.months:ue[o],c=a.value*u/ue.milliseconds,h=yield this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},i),d=L(this.fieldsIndex.get(s)),f=he(h,{field:s,classificationMethod:"defined-interval",definedInterval:c,minValue:G(r,d),maxValue:G(n,d)},!0),g=yield this._calculateHistogramBins(h,f,i);return this._createFeaturesFromHistogramBins(g,t)})}_createFixedBoundariesBinsResponse(e,t,i){return m(this,null,function*(){let{field:s}=e,a=yield this._getDataValues({field:s,timeZone:t.outTimeReference?.ianaTimeZone},i),r=L(this.fieldsIndex.get(s)),n=e.boundaries.map(h=>G(h,r)).sort((h,d)=>h-d),o=[];for(let h=0;h<n.length-1;h++)o.push([n[h],n[h+1]]);let u={intervals:o,min:n.at(0),max:n.at(-1)},c=yield this._calculateHistogramBins(a,u,i);return this._createFeaturesFromHistogramBins(c,t)})}_createFixedIntervalBinsResponse(e,t,i){return m(this,null,function*(){let{field:s,interval:a,start:r,end:n}=e,o=yield this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},i),u=L(this.fieldsIndex.get(s)),c=he(o,{field:s,classificationMethod:"defined-interval",definedInterval:a,minValue:G(r,u),maxValue:G(n,u)},!0),h=yield this._calculateHistogramBins(o,c,i);return this._createFeaturesFromHistogramBins(h,t)})}_createFeaturesFromHistogramBins(e,t){return m(this,null,function*(){let{upperBoundaryAlias:i,lowerBoundaryAlias:s}=t,a=s||"lowerBoundary",r=i||"upperBoundary",n=[],o=[{name:a,alias:a,type:"esriFieldTypeDouble"},{name:r,alias:r,type:"esriFieldTypeDouble"}],u=t.bin?.stackBy?.value,c=t.bin?.stackBy?.outAlias;u&&o.push({name:X,alias:X,type:"esriFieldTypeInteger"},{name:c??u,alias:c??u,type:"esriFieldTypeString"});let h=0;for(let d of e){let{minValue:f,maxValue:g,items:p}=d,y={attributes:{}},F;if(y.attributes[a]=f,y.attributes[r]=g,u?(F=yield this._createStatisticsQueryResponse(B(A({},t),{groupByFieldsForStatistics:[u],orderByFields:[u]}),p),y.attributes[X]=++h,t.bin.jsonStyle==="flat"?n.push(...F.features.map(x=>{var S=x,{attributes:_}=S,T=_,{EXPR_1:I}=T,v=oe(T,["EXPR_1"]),w=oe(S,["attributes"]);return B(A({},w),{attributes:A(c??I?B(A({},v),{[c??I]:I}):A({},v),y.attributes)})})):(y.stackedAttributes=F.features.map(w=>{var{attributes:x}=w,S=x,{EXPR_1:I}=S,v=oe(S,["EXPR_1"]);return c??I?B(A({},v),{[c??I]:I}):v}),n.push(y))):(t.bin?.splitBy&&(y.attributes[X]=++h),F=yield this._createStatisticsQueryResponse(t,p,y),n.push(y)),F.fields)for(let I of F.fields)o.some(v=>v.name===I.name)||o.push(I)}return t.binOrder==="desc"&&n.reverse(),{fields:o,features:n}})}};function Jt(l,e,t,i){let s=i.x-t.x,a=i.y-t.y,r=e.x-t.x,n=e.y-t.y,o=s*s+a*a;if(o===0)return!1;let u=r*s+n*a,c=Math.min(1,Math.max(0,u/o));return l.x=t.x+s*c,l.y=t.y+a*c,!0}function qt(l,e){return l?e?4:3:e?3:2}var ye=class{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}},Wt=[1];var $="unsupported-query";function Pt(l,e){return m(this,null,function*(){let t=l.bin;if(!t.onField&&!t.onExpression?.value||t.type==="autoIntervalBin"&&t.parameters.numberOfBins==null||t.type==="dateBin"&&(t.parameters.number==null||t.parameters.unit==null)||t.type==="fixedBoundariesBin"&&t.parameters.boundaries==null||t.type==="fixedIntervalBin"&&t.parameters.interval==null)throw new E($,"Unsupported query options",{query:l});return Me(l,e)})}function Me(a,r){return m(this,arguments,function*(l,{fieldsIndex:e,geometryType:t,spatialReference:i,availableFields:s}){if(l.geometryPrecision!=null||l.multipatchOption&&l.multipatchOption!=="xyFootprint"||l.pixelSize||l.relationParam||l.text)throw new E($,"Unsupported query options",{query:l});return Mt(e,s,l),Xt(e,s,l),Promise.all([Ve(l,t,i),be(i,l.outSR)]).then(()=>l)})}function Mt(l,e,t){let{outFields:i,orderByFields:s,returnDistinctValues:a,outStatistics:r}=t,n=r?r.map(o=>o.outStatisticFieldName&&o.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(s&&s.length>0){let o=" asc",u=" desc",c=s.map(h=>{let d=h.toLowerCase();return d.includes(o)?d.split(o)[0]:d.includes(u)?d.split(u)[0]:h}).filter(h=>!n.includes(h));P(l,e,c,{expressionName:"orderByFields",query:t})}if(i&&i.length>0)P(l,e,i,{expressionName:"outFields",query:t,allowedFieldTypes:"all"});else if(a)throw new E($,"outFields should be specified for returnDistinctValues",{query:t});Qt(l,e,t.where,t)}var Yt=new Set([...Qe,...De]);function Xt(l,e,t){let{outStatistics:i,groupByFieldsForStatistics:s,having:a}=t,r=s?.length,n=i?.length;if(a){if(!r||!n)throw new E($,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:t});Dt(l,e,a,i,t)}if(n){if(!ei(i))return;let o=i.map(u=>u.onStatisticField).filter(Boolean);P(l,e,o,{expressionName:"onStatisticFields",query:t}),r&&P(l,e,s,{expressionName:"groupByFieldsForStatistics",query:t});for(let u of i){let{onStatisticField:c,statisticType:h}=u;if((h==="percentile_disc"||h==="percentile_cont")&&"statisticParameters"in u){let{statisticParameters:d}=u;if(!d)throw new E($,"statisticParameters should be set for percentile type",{definition:u,query:t})}else l.get(c)&&h!=="count"&&h!=="min"&&h!=="max"&&P(l,e,[c],{expressionName:`outStatistics with '${h}' statistic type`,allowedFieldTypes:Yt,query:t})}}}function Nt(r,n,o){return m(this,arguments,function*(l,e,{fieldsIndex:t,geometryType:i,spatialReference:s,availableFields:a}){if(l.geometryPrecision!=null||l.multipatchOption||l.pixelSize||l.relationParam||l.text||l.outStatistics||l.groupByFieldsForStatistics||l.having||l.orderByFields)throw new E($,"Unsupported query options",{query:l});return Mt(t,a,l),Promise.all([Kt(t,a,e,l),Ve(l,i,s),be(s,l.outSR)]).then(()=>l)})}function Kt(l,e,t,i){return m(this,null,function*(){let s=[];if(t.valueExpression){let{arcadeUtils:a}=yield me();s=a.extractFieldNames(t.valueExpression)}if(t.field&&s.push(t.field),t.field2&&s.push(t.field2),t.field3&&s.push(t.field3),t.normalizationField&&s.push(t.normalizationField),!s.length&&!t.valueExpression)throw new E($,"field or valueExpression is required",{params:t});P(l,e,s,{expressionName:"statistics",query:i})})}function ei(l){return l!=null&&l.every(e=>e.statisticType!=="exceedslimit")}var ti="unsupported-query";var Ot=class{constructor(e){this._changeHandle=null,this.capabilities={query:Ft},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new pe,this.timeInfo=e.timeInfo,this._changeHandle=this.featureStore.events.on("changed",()=>this._clearCache()),this.fieldsIndex=Ue.isSerializable(e.fieldsIndex)?e.fieldsIndex:nt.fromJSON(e.fieldsIndex),!e.availableFields||e.availableFields.length===1&&e.availableFields[0]==="*"?this.availableFields=new Set(this.fieldsIndex.fields.map(t=>t.name)):this.availableFields=new Set(e.availableFields.map(t=>this.fieldsIndex.get(t)?.name).filter(t=>t!=null)),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}destroy(){this._changeHandle=Fe(this._changeHandle),this._frameTask=Fe(this._frameTask),this._clearCache(),He(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}executeQuery(e,t){return m(this,null,function*(){let i=z(t);try{return yield(yield this._executeQuery(e,{},i)).createQueryResponse()}catch(s){if(s!==O)throw s;return new V([],e,this).createQueryResponse()}})}executeQueryForCount(){return m(this,arguments,function*(e={},t){let i=z(t);try{return(yield this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null},i)).createQueryResponseForCount()}catch(s){if(s!==O)throw s;return 0}})}executeQueryForExtent(e,t){return m(this,null,function*(){let i=z(t),s=e.outSR;try{let a=yield this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},i),r=a.size;return r?{count:r,extent:yield this._getBounds(a.items,a.spatialReference,s||this.spatialReference)}:{count:0,extent:null}}catch(a){if(a===O)return{count:0,extent:null};throw a}})}executeQueryForIds(e,t){return m(this,null,function*(){return this.executeQueryForIdSet(e,t).then(i=>Array.from(i))})}executeQueryForIdSet(e,t){return m(this,null,function*(){let i=z(t);try{let s=yield this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},i),a=s.items,r=new Set;return yield this.reschedule(()=>{for(let n of a)r.add(s.featureAdapter.getObjectId(n))},i),r}catch(s){if(s===O)return new Set;throw s}})}executeQueryForLatestObservations(e,t){return m(this,null,function*(){let i=z(t);if(!this.timeInfo?.trackIdField)throw new E(ti,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});try{let s=yield this._executeQuery(e,{},i);return yield this.reschedule(()=>this._filterLatest(s),i),yield s.createQueryResponse()}catch(s){if(s!==O)throw s;return new V([],e,this).createQueryResponse()}})}executeAttributeBinsQuery(e,t){return m(this,null,function*(){let i=z(t),s;e=W(e);try{e=yield this.schedule(()=>wt(e,this.definitionExpression,this.spatialReference),i),e=yield this.reschedule(()=>Pt(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),i);let a=yield this.reschedule(()=>this._executeSceneFilterQuery(e,i),i);s=yield this.reschedule(()=>this._executeGeometryQuery(e,a,i),i),yield this.reschedule(()=>this._executeAggregateIdsQuery(s),i),yield this.reschedule(()=>this.executeObjectIdsQuery(s),i),yield this.reschedule(()=>this.executeTimeQuery(s),i),yield this.reschedule(()=>this.executeAttributesQuery(s),i)}catch(a){if(a!==O)throw a;s=new V([],e,this)}return s.createQueryBinsResponse(e)})}executeQueryForSummaryStatistics(){return m(this,arguments,function*(e={},t,i){let s=z(i),{field:a,normalizationField:r,valueExpression:n}=t;return(yield this._executeQueryForStatistics(e,{field:a,normalizationField:r,valueExpression:n},s)).createSummaryStatisticsResponse(t)})}executeQueryForUniqueValues(){return m(this,arguments,function*(e={},t,i){let s=z(i),{field:a,field2:r,field3:n,valueExpression:o}=t;return(yield this._executeQueryForStatistics(e,{field:a,field2:r,field3:n,valueExpression:o},s)).createUniqueValuesResponse(t)})}executeQueryForClassBreaks(){return m(this,arguments,function*(e={},t,i){let s=z(i),{field:a,normalizationField:r,valueExpression:n}=t;return(yield this._executeQueryForStatistics(e,{field:a,normalizationField:r,valueExpression:n},s)).createClassBreaksResponse(t)})}executeQueryForHistogram(){return m(this,arguments,function*(e={},t,i){let s=z(i),{field:a,normalizationField:r,valueExpression:n}=t;return(yield this._executeQueryForStatistics(e,{field:a,normalizationField:r,valueExpression:n},s)).createHistogramResponse(t)})}fetchRecomputedExtents(e){return m(this,null,function*(){let t=z(e);this._timeExtentPromise||=Rt(this.timeInfo,this.featureStore);let[i,s]=yield Promise.all([this._getFullExtent(),this._timeExtentPromise]);return ke(t),{fullExtent:i,timeExtent:s}})}_getBounds(e,t,i){return m(this,null,function*(){let s=st(tt(),at);yield this.featureStore.forEachBounds(e,n=>it(s,n));let a={xmin:s[0],ymin:s[1],xmax:s[3],ymax:s[4],spatialReference:U(this.spatialReference)};this.hasZ&&isFinite(s[2])&&isFinite(s[5])&&(a.zmin=s[2],a.zmax=s[5],a.hasZ=!0);let r=k(a,t,i);if(r.spatialReference=U(i),r.xmax-r.xmin==0){let n=le(r.spatialReference);r.xmin-=n,r.xmax+=n}if(r.ymax-r.ymin==0){let n=le(r.spatialReference);r.ymin-=n,r.ymax+=n}if(this.hasZ&&r.zmin!=null&&r.zmax!=null&&r.zmax-r.zmin==0){let n=le(r.spatialReference);r.zmin-=n,r.zmax+=n}return r})}_getFullExtent(){return this._fullExtentPromise||="getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(e=>this._getBounds(e,this.spatialReference,this.spatialReference)),this._fullExtentPromise}schedule(e,t){return m(this,null,function*(){return this._frameTask?.schedule(e,t)??e(ze)})}reschedule(e,t){return m(this,null,function*(){return this._frameTask?.reschedule(e,t)??e(ze)})}_getAllFeaturesQueryEngineResult(e){return m(this,null,function*(){return new V(yield this._getAllFeatures(),e,this)})}_getAllFeatures(){return m(this,null,function*(){if(this._allFeaturesPromise==null){let i=[];this._allFeaturesPromise=m(this,null,function*(){return yield this.featureStore.forEach(s=>i.push(s))}).then(()=>i)}let e=this._allFeaturesPromise,t=yield e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()})}_executeQuery(e,t,i){return m(this,null,function*(){e=W(e),e=yield this.schedule(()=>Re(e,this.definitionExpression,this.spatialReference),i),e=yield this.reschedule(()=>Me(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),i),e=A(A({},e),t);let s=yield this.reschedule(()=>this._executeSceneFilterQuery(e,i),i),a=yield this.reschedule(()=>this._executeGeometryQuery(e,s,i),i);return yield this.reschedule(()=>this._executeAggregateIdsQuery(a),i),yield this.reschedule(()=>this.executeObjectIdsQuery(a),i),yield this.reschedule(()=>this.executeTimeQuery(a),i),yield this.reschedule(()=>this.executeAttributesQuery(a),i),a})}_executeSceneFilterQuery(e,t){return m(this,null,function*(){if(e.sceneFilter==null)return null;let{outSR:i,returnGeometry:s,returnCentroid:a}=e,r=this.featureStore.featureSpatialReference,n=e.sceneFilter.geometry,o=r==null||Q(r,n.spatialReference)?n:k(n,r);if(!o)return null;let u=s||a,c=Y(i)&&!Q(this.spatialReference,i)&&u?p=>m(this,null,function*(){return this._project(p,i)}):p=>p,h=this.featureAdapter,d=yield this.reschedule(()=>this.searchFeatures(Gt(o)),t);if(e.sceneFilter.spatialRelationship==="disjoint"){if(!d.length)return null;let p=new Set;for(let I of d)p.add(h.getObjectId(I));let y=yield this.reschedule(()=>this._getAllFeatures(),t),F=yield this.reschedule(()=>m(this,null,function*(){let I=yield ee("esriSpatialRelDisjoint",o,this.geometryType,this.hasZ,this.hasM),v=x=>!p.has(h.getObjectId(x))||I(h.getGeometry(x)),w=yield this.runSpatialFilter(y,v,t);return new V(w,e,this)}),t);return c(F)}if(!d.length)return new V([],e,this);if(this._canExecuteSinglePass(o,e))return c(new V(d,e,this));let f=yield ee("esriSpatialRelContains",o,this.geometryType,this.hasZ,this.hasM),g=yield this.runSpatialFilter(d,p=>f(h.getGeometry(p)),t);return c(new V(g,e,this))})}_executeGeometryQuery(e,t,i){return m(this,null,function*(){if(t!=null&&t.items.length===0)return t;let{geometry:s,outSR:a,returnGeometry:r,returnCentroid:n}=e,o=t?null:this._getCacheKey(e),u=o?this._cache.get(o):null;if(u)return new V(u,e,this);let c=Y(a)&&!Q(this.spatialReference,a),h=r||n,d=w=>m(this,null,function*(){return c&&h&&(yield this._project(w,a)),o&&this._cache.put(o,w.items),w}),f=this.featureStore.featureSpatialReference,g=!s||f==null||Q(f,s.spatialReference)?s:k(s,f);if(!g)return d(t??(yield this._getAllFeaturesQueryEngineResult(e)));let p=this.featureAdapter,y=yield this.reschedule(()=>this.searchFeatures(Gt(s)),i),F=e.spatialRel??"esriSpatialRelIntersects";if(F==="esriSpatialRelDisjoint"){if(!y.length)return d(t??(yield this._getAllFeaturesQueryEngineResult(e)));let w=new Set;for(let _ of y)w.add(p.getObjectId(_));let x=t!=null?t.items:yield this.reschedule(()=>this._getAllFeatures(),i),S=yield this.reschedule(()=>m(this,null,function*(){let _=yield ee(F,g,this.geometryType,this.hasZ,this.hasM),T=b=>!w.has(p.getObjectId(b))||_(p.getGeometry(b)),R=yield this.runSpatialFilter(x,T,i);return new V(R,e,this)}),i);return d(S)}if(t!=null){let w=new Ze;y=y.filter(x=>je(t.items,x,t.items.length,w)>=0)}if(!y.length){let w=new V([],e,this);return o&&this._cache.put(o,w.items),w}if(this._canExecuteSinglePass(g,e))return d(new V(y,e,this));let I=yield ee(F,g,this.geometryType,this.hasZ,this.hasM),v=yield this.runSpatialFilter(y,w=>I(p.getGeometry(w)),i);return d(new V(v,e,this))})}_executeAggregateIdsQuery(e){if(e.items.length===0||!e.query.aggregateIds?.length||this.aggregateAdapter==null)return;let t=new Set;for(let s of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(s).forEach(a=>t.add(a));let i=this.featureAdapter.getObjectId;e.items=e.items.filter(s=>t.has(i(s)))}executeObjectIdsQuery(e){if(e.items.length===0||!e.query.objectIds?.length)return;let t=new Set(e.query.objectIds),i=this.featureAdapter.getObjectId;e.items=e.items.filter(s=>t.has(i(s)))}executeTimeQuery(e){if(e.items.length===0)return;let t=At(this.timeInfo,e.query.timeExtent,this.featureAdapter);t!=null&&(e.items=e.items.filter(t))}executeAttributesQuery(e){if(e.items.length===0)return;let t=q(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter(i=>t.testFeature(i,this.featureAdapter))}}runSpatialFilter(e,t,i){return m(this,null,function*(){if(!t)return e;if(this._frameTask==null)return e.filter(n=>t(n));let s=0,a=new Array,r=n=>m(this,null,function*(){for(;s<e.length;){let o=e[s++];t(o)&&(a.push(o),n.madeProgress()),n.done&&(yield this.reschedule(u=>r(u),i))}});return this.reschedule(n=>r(n),i).then(()=>a)})}_filterLatest(e){let{trackIdField:t,startTimeField:i,endTimeField:s}=this.timeInfo,a=s||i,r=new Map,n=this.featureAdapter.getAttribute;for(let o of e.items){let u=n(o,t),c=n(o,a),h=r.get(u);(!h||c>n(h,a))&&r.set(u,o)}e.items=Array.from(r.values())}_getCacheKey(e){let{geometry:t,spatialRel:i,returnGeometry:s,returnCentroid:a,outSR:r,resultType:n,cacheHint:o}=e;if(n!=="tile"&&!o)return null;let u=s||a;return Y(r)&&!Q(this.spatialReference,r)&&u?JSON.stringify([t,i,r]):JSON.stringify([t,i])}_canExecuteSinglePass(e,t){let{spatialRel:i}=t;return Ee(e)&&(i==="esriSpatialRelEnvelopeIntersects"||this.geometryType==="esriGeometryPoint"&&(i==="esriSpatialRelIntersects"||i==="esriSpatialRelContains"))}_project(e,t){return m(this,null,function*(){if(!t||Q(this.spatialReference,t))return e;let i=this.featureAdapter,s;try{let r=yield this._getFullExtent();s=ot(this.spatialReference,t,r)}catch{}let a=yield _t(e.items.map(r=>Z(this.geometryType,this.hasZ,this.hasM,i.getGeometry(r))),this.spatialReference,t,s);return e.items=a.map((r,n)=>i.cloneWithGeometry(e.items[n],rt(r,this.hasZ,this.hasM))),e})}searchFeatures(e){return m(this,null,function*(){let t=new Set;yield Promise.all(e.map(s=>this.featureStore.forEachInBounds(s,a=>t.add(a))));let i=Array.from(t.values());return t.clear(),i})}_executeQueryForStatistics(e,t,i){return m(this,null,function*(){e=W(e);try{e=yield this.schedule(()=>Re(e,this.definitionExpression,this.spatialReference),i),e=yield this.reschedule(()=>Nt(e,t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),i);let s=yield this.reschedule(()=>this._executeSceneFilterQuery(e,i),i),a=yield this.reschedule(()=>this._executeGeometryQuery(e,s,i),i);return yield this.reschedule(()=>this._executeAggregateIdsQuery(a),i),yield this.reschedule(()=>this.executeObjectIdsQuery(a),i),yield this.reschedule(()=>this.executeTimeQuery(a),i),yield this.reschedule(()=>this.executeAttributesQuery(a),i),a}catch(s){if(s!==O)throw s;return new V([],e,this)}})}get test(){}};function Gt(l){if(Ee(l)){if(Xe(l))return[_e(Math.min(l.xmin,l.xmax),Math.min(l.ymin,l.ymax),Math.max(l.xmin,l.xmax),Math.max(l.ymin,l.ymax))];if(Ke(l))return l.rings.map(e=>_e(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1])))}return[We(Je(),l)]}export{V as a,Me as b,Ot as c,Gt as d};
