import{a as Ri}from"./chunk-HYDGCQTC.js";import{a as ht}from"./chunk-QAJCY744.js";import{a as qe,b as gi,c as bi,d as Si,e as Ci,f as K,g as Ei}from"./chunk-MUJBU3Y2.js";import{a as Ii}from"./chunk-67ZC4UJG.js";import{h as ui,i as fi}from"./chunk-EY7OVTAY.js";import{a as hi}from"./chunk-YO56ZRXD.js";import{a as vi,b as Li,c as _i,d as wi}from"./chunk-3XU3H6IS.js";import{a as Ee,b as ri,c as mi}from"./chunk-PMOAKYXH.js";import{a as ke}from"./chunk-FHBFWDFD.js";import{a as mt,b as di,c as pi,d as yi}from"./chunk-5X2QFKFJ.js";import{d as ai,e as li,g as ni,h as pt,i as oi,j as ci,k as yt}from"./chunk-YYA5WIRF.js";import{a as ii}from"./chunk-LFET65NO.js";import{a as dt}from"./chunk-E56W4PK4.js";import{h as ti,n as We}from"./chunk-IPGHBSHO.js";import{c as ei}from"./chunk-XPXAET6Q.js";import{a as Yt}from"./chunk-EUD3KSLO.js";import{b as Kt}from"./chunk-WYYRYCXY.js";import{f as Xt,g as De}from"./chunk-XD6QSICT.js";import{c as Zt}from"./chunk-RCDSCJMH.js";import{_ as si}from"./chunk-HKHTIKVW.js";import{a as Jt}from"./chunk-XFESK2YB.js";import{b as ct}from"./chunk-ZHUXSQTN.js";import{b as Ce}from"./chunk-YLZWDFCJ.js";import{a as ee}from"./chunk-J5MXC6AL.js";import{a as q,b as jt}from"./chunk-OLOKUDVI.js";import{b as Qt}from"./chunk-MDL4XPLR.js";import{c as Gt,d as T,e as le}from"./chunk-7ZYPJJID.js";import{b as qt,g as o}from"./chunk-UAKHZRKN.js";import{g as Ue}from"./chunk-HAHX77IL.js";import{a as ae}from"./chunk-IXCTZWTQ.js";import{b as He}from"./chunk-6PN3I333.js";import{b as Ut}from"./chunk-ZTJLFKGG.js";import{a as V,b as nt,c as Se,d as Wt,h as W}from"./chunk-LB5YQINJ.js";import{b as Te}from"./chunk-EKMHQEJY.js";import{c as Ht}from"./chunk-7R33MKVL.js";import{a as Pt}from"./chunk-ISSJ3A6Y.js";import{a as Bt}from"./chunk-WUA6PW3I.js";import{F as ot,g as Nt}from"./chunk-E57FTRWF.js";import{S as Ot}from"./chunk-U4J5SECU.js";import{L as Ne,b as At,d as y,o as we}from"./chunk-C7INQGWT.js";import{H as x}from"./chunk-WMHJC7XF.js";import{M as Mt}from"./chunk-D2LVMNOU.js";import{a as d}from"./chunk-QGVBCWUY.js";import{o as kt,r as U}from"./chunk-HHDFN2GK.js";import{a as Dt,t as _e}from"./chunk-47GHT6OF.js";import{a as O,c as lt,f as w}from"./chunk-VTHXE323.js";function xi(e,t,i){let r=e.effectiveClusterRenderer;if(!r||!("visualVariables"in r)||!r.visualVariables)return null;let s=r.visualVariables.find(h=>h.type==="size");if(!("stops"in s)||!s.stops)return null;let a=s.stops.find(h=>h.useMinValue),l=s.stops.find(h=>h.useMaxValue);if(a==null||l==null)return null;let c=i.featuresTilingScheme.getClosestInfoForScale(i.scale).level,n=s.field,p=t.getDisplayStatistics(c,n);return p?new De({field:s.field,minSize:e.clusterMinSize,minDataValue:p.minValue,maxSize:e.clusterMaxSize,maxDataValue:p.maxValue}):null}function Vi(e){let i=Math.floor(Math.log10(Math.abs(e)))+1,r=i<4||i>6?4:i,s=1e6,a=Math.abs(e)>=s?"compact":"standard";return He(e,{notation:a,minimumSignificantDigits:2,maximumSignificantDigits:r})}var zi=16,rs="https://utility.arcgis.com/sharing/tools/legend",as="esri.layers.ImageryLayer",ls="esri.layers.ImageryTileLayer",ns="esri.layers.WCSLayer",Ge=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,os=new Bt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),je=new Ce({size:6,outline:{color:[128,128,128,.5],width:.5}}),cs=new ct({style:"solid"});function gt(e){return e.type==="flow"}function Ti(e){return e.type==="vector-field"}function Di(e){return e.type==="raster-colormap"}function ki(e){return e.type==="raster-stretch"}function Ai(e){return e.type==="raster-shaded-relief"}function xe(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function ne(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function oe(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function Mi(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function ds(e){return bt(e)||vt(e)||Lt(e)||ps(e)}function ps(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function bt(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function vt(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function Lt(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Pi(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function Bi(e){return e.declaredClass==="esri.renderers.PieChartRenderer"}function ys(e,t){return xe(e)||ne(e)||oe(e)||Mi(e)||Pi(e)||Bi(e)?t.type==="2d"||Ri(e):ki(e)||Di(e)||Ai(e)||bt(e)||vt(e)||Lt(e)||Ti(e)||gt(e)}function ms(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function ut(e){return e.declaredClass==="esri.layers.SubtypeGroupLayer"}function hs(e){return e.declaredClass==="esri.layers.VoxelLayer"}function us(e){return e.declaredClass==="esri.layers.WMSLayer"}function fs(e){return e.declaredClass==="esri.layers.WMTSLayer"}function ft(e){return e.declaredClass==="esri.layers.MapImageLayer"}function $i(e){return e.declaredClass==="esri.layers.TileLayer"}function Ie(e){return e.declaredClass===as}function Je(e){return e.declaredClass===ls}function gs(e){return e.declaredClass===ns}function bs(e){return e.type==="stretch-ramp"}function vs(e){return("authoringInfo"in e?e?.authoringInfo:null)?.type==="univariate-color-size"}function Ls(e){let t="authoringInfo"in e?e?.authoringInfo:null;return t?.type==="univariate-color-size"&&t?.univariateTheme==="above-and-below"}function Fi(e){return"sublayers"in e}function X(e,t){return w(this,null,function*(){let i=yield Ut("esri/widgets/Legend/t9n/Legend");return e!=="previewTemplateAriaLabel"||t||(e="previewAriaLabel"),ae(i[e],{label:t})})}function _s(e,t){let{field:i,field2:r,field3:s,fieldDelimiter:a,valueExpression:l}=e;if(!i)return null;let c=!i&&!l||!r&&!s?[t]:t?.toString().split(a||""),n=i?{[i]:c?.[0]}:null;return n&&(r&&(n[r]=c?.[1]),s&&(n[s]=c?.[2])),n}var ws=new Ce({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}}),Re={},A=class extends Ne{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this._layerDefinitionExpression=null,this._layerDefinitionExpressionClause=null,this._layerDisplayFilterId=null,this._layerDisplayFilterClause=null,this.children=new Te,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){let e=()=>this.notifyChange("ready");this.addHandles([Se(()=>this.children,"change",t=>{let{added:i,removed:r}=t;i.forEach(s=>{let a=`activeLayerInfo-ready-watcher-${s.layer.uid}`;this.addHandles(V(()=>s.ready,e,W),a)}),r.forEach(s=>this.removeHandles(s.layer.uid)),e()})]),this.keepCacheOnDestroy||(Re={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Re=null),this._layerDefinitionExpressionClause=null}get effectList(){let e=this.layer,t=null;return"effect"in e&&e.effect&&(t=new Ii,t.effect=e.effect,t.endTransition(),t.scale=this.scale),t}get opacity(){let e=this.layer.opacity,t=this.parent?.opacity,i=this.layer.parent,r=i&&"uid"in i?this._getParentLayerOpacity(i):null;return t!=null?t*e:r!=null?r*e:e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){let e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if(e.featureReduction.type==="cluster")return!0;if(e.featureReduction.type==="binning"&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?!!("displayFilterInfo"in e&&e.displayFilterInfo&&oe(e.renderer))||this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}buildLegendElementsForFeatureCollections(e){return w(this,null,function*(){if(!(!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView())))return this.legendElements=[],void this.notifyChange("ready");let t=Array.from(e,i=>{if(Qt(i))return this._getRendererLegendElements(i.renderer,{title:i.title});if(i.featureSet?.features.length){let r=i.layerDefinition,s=r?.drawingInfo,a=s&&Yt(s.renderer),l=os.read(r.geometryType);return a?this._getRendererLegendElements(a,{title:i.name,geometryType:l}):(U.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{let i=[],r=yield Promise.allSettled(t);for(let s of r)if(s.status==="fulfilled")for(let a of s.value??[])i.push(a);this.legendElements=i,this.notifyChange("ready")}catch(i){U.getLogger(this).warn("error while building legend for layer!",i)}})}buildLegendElementsForRenderer(e){return w(this,null,function*(){try{let t=!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView());this.legendElements=t?yield this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){U.getLogger(this).warn("error while building legend for layer!",t)}})}buildLegendElementsForFeatureReduction(e){return w(this,null,function*(){try{let t=!this.hideLayersNotInCurrentView||(yield this._isLayerInCurrentView());this.legendElements=t?yield this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(t){U.getLogger(this).warn("error while building legend for layer!",t)}})}buildLegendElementsForTools(){return w(this,null,function*(){let e=this.layer;if(hs(e))this._constructLegendElementsForVoxelLayer();else if(fs(e))this._constructLegendElementsForWMTSlayer();else if(us(e))yield this._constructLegendElementsForWMSSublayers();else if(ms(e))yield this._constructLegendElementsForBuildingSceneLayer();else if(ft(e)||$i(e)||ut(e))yield this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let t="default";if(Ie(e)&&(t=(e?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")),Je(e)||e.type==="link-chart")return;yield this._getLegendLayers(`${e.uid}-${t}`).then(i=>w(this,null,function*(){this.legendElements=[],this.notifyChange("ready");let r=i.map(s=>w(this,null,function*(){if(Ie(e)){let l=V(()=>[e.rasterFunction,e.bandIds],()=>Mt(()=>w(this,null,function*(){Re.default=null,e.renderer?yield this.buildLegendElementsForRenderer(e.renderer):yield this.buildLegendElementsForTools()}))());this.addHandles(l,"imageryLayers-watcher")}let a=this._generateSymbolTableElementForLegendLayer(s);a?.infos.length&&(Ie(e)&&(a.title=e.title),this.legendElements.push(a)),this.notifyChange("ready")}));yield Promise.allSettled(r)})).catch(i=>{U.getLogger(this).warn("Request to server for legend has failed!",i)})}})}_isLayerInCurrentView(){return w(this,null,function*(){let e=this.layer,t=this.layerView,i=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!i&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;yield Wt(()=>!t.updating);let r=i?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return r?(r.geometry=this.view.extent,(i?"queryFeatureCount"in t&&(yield t.queryFeatureCount(r)):"queryFeatureCount"in e&&(yield e.queryFeatureCount(r)))!==0):!0})}_getParentLayerOpacity(e){let t=1,i=e.parent;return i&&"uid"in i&&(t=this._getParentLayerOpacity(i)),e.opacity*t}_isGroupActive(){return this.children.some(e=>e.ready)}_isRendererScaleDriven(e){if(e.type==="dot-density")return!0;let t="valueExpression"in e?e.valueExpression:null;return Ge.test(t)?!0:!!("visualVariables"in e?e.visualVariables:null)?.some(r=>this._isScaleDrivenSizeVariable(r))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case"simple":return this._isScaleDrivenSymbol(e.symbol);case"class-breaks":return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some(t=>this._isScaleDrivenSymbol(t.symbol));case"unique-value":return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some(t=>this._isScaleDrivenSymbol(t.symbol))}return!1}_isScaleDrivenSymbol(e){if(e?.type==="cim"){let{primitiveOverrides:t,minScale:i,maxScale:r}=e.data,s=t?.some(a=>/\$view\.scale/.test(a.valueExpressionInfo?.expression||""))??!1;return i!=null||r!=null||s}return!1}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;let t=e,i=t.minSize,r=t.maxSize;return!(typeof i!="object"||!i||!this._isScaleDrivenSizeVariable(i))||!(typeof r!="object"||!r||!this._isScaleDrivenSizeVariable(r))||Ge.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(i=>this._isLayerScaleDriven(i));let t=e.parent;if(e.loaded===!1&&t&&ft(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(let i of t.sourceJSON.layers??[])if(i.id===e.source.mapLayerId&&(i.minScale>0||i.maxScale>0))return!0}return!1}_constructLegendElementsForVoxelLayer(){return w(this,null,function*(){this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");let e=this.layer;this.addHandles(V(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),"voxel-current-variable"),this.addHandles(V(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");let t=e.getVariableStyle(null),i=[];if(t){if(t.uniqueValues?.length){let a=[];t.uniqueValues.forEach(l=>{l.enabled&&a.push({label:l.label||`${l.value}`,value:l.value,symbol:new ct({color:l.color,outline:null})})}),a.length&&i.push({type:"symbol-table",title:t.label,infos:a})}else if(t.transferFunction){let{colorStops:a,stretchRange:l}=t.transferFunction,c=a.toArray().reverse(),n=l.map((h,m)=>`${m===0?ai:li} ${Vi(h)}`).reverse(),p=c.map(h=>({color:h.color,value:null,label:null}));p[0].label=n[0],p[p.length-1].label=n[1],i.push({type:"color-ramp",title:t.label,infos:p,preview:K(c.map(h=>h.color),{ariaLabel:yield X("previewColorRampAriaLabel")})})}}let r=e.opacity,s=i.reduce((a,l)=>[...a,...this._getAllInfos(l)],[]).filter(a=>!!a?.symbol).map(a=>this._getSymbolPreview(a,r));yield Promise.allSettled(s),this.legendElements=i,this.notifyChange("ready")})}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");let e=this.layer.activeLayer;this.addHandles(V(()=>{let{layer:i}=this;return i&&"activeLayer"in i&&i.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");let t=e.styleId?e.styles?.find(({id:i})=>i===e.styleId)?.legendUrl:void 0;t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}]),this.notifyChange("ready")}_constructLegendElementsForWMSSublayers(){return w(this,null,function*(){this.legendElements=[],this.removeHandles("wms-sublayers-watcher");let e=this.layer,t=null;(e.customParameters||e.customLayerParameters)&&(t=O(O({},e.customParameters),e.customLayerParameters)),this.addHandles(V(()=>{let{layer:i}=this;return i&&"sublayers"in i&&i.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=yield this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")})}_generateLegendElementsForWMSSublayers(e,t){return w(this,null,function*(){let i=this.layer,r=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");let s=this.sublayerIds?.map(l=>i.findSublayerById(l))?.filter(_e)??[],a=s.length?s:e.toArray();for(let l of a){let c=V(()=>[l.title,l.visible,l.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(c,"wms-sublayers-watcher"),!this.respectLayerVisibility||l.visible&&l.legendEnabled){let n=yield this._generateSymbolTableElementForWMSSublayer(l,t);n?.infos.length&&r.unshift(n)}}return r})}_generateSymbolTableElementForWMSSublayer(e,t){return w(this,null,function*(){if(!e.legendUrl&&e.sublayers){let i=(yield this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(r=>r);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendUrl(e,t)})}_generateSymbolTableElementForLegendUrl(e,t){return w(this,null,function*(){let i=e.legendUrl;if(!i)return;let r={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};t&&(i=Ot(i,t));let s=null,a=e.layer?.opacity;try{s=(yield ot(i,{responseType:"image"})).data,s&&(s.style.opacity=a)}catch{}return r.infos.push({src:i,preview:s,opacity:a}),r})}_getLegendLayers(e,t){let i=Re&&Re[e];return i?Promise.resolve(i):this._legendRequest(t).then(r=>{let s=r.layers;return Re[e]=s,s})}_legendRequest(e){let t=this.layer,i={f:"json",dynamicLayers:e};if(Ie(t)){let s=t.exportImageServiceParameters.rasterFunction;if(s&&(i.renderingRule=JSON.stringify(s.functionDefinition?.toJSON()||s.toJSON())),t.bandIds&&(i.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){let{raster:a,viewId:l,customParameters:c}=t;i=O(O({raster:a,viewId:l},i),c)}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&+t.version>=10.01){let s=r.indexOf("?");s>-1?r=r.slice(0,s)+"/legend"+r.slice(s):r+="/legend"}else{let s=r.toLowerCase().indexOf("/rest/"),a=s===-1?r:r.slice(0,s)+r.slice(s+5);r=rs+"?soapUrl="+encodeURI(a)+"&returnbytes=true"}return ot(r,{query:i}).then(s=>s.data)}_constructLegendElementsForBuildingSceneLayer(){return w(this,null,function*(){this.legendElements=[],this.removeHandles("sublayers-watcher");let e=this.layer;this.addHandles(V(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){U.getLogger(this).warn("Request to server for legend has failed!",t)}})}_generateLegendElementsForBuildingSublayers(e,t){return w(this,null,function*(){let i=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");let r=e.toArray();for(let s of r){let a=V(()=>["renderer"in s&&s.renderer,s.opacity,s.title,s.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(a,"sublayers-watcher"),!this.respectLayerVisibility||s.visible){let l=s?.opacity!=null?s.opacity:null,c=l!=null?l*t:t;if(s.type==="building-group"){let n={type:"symbol-table",title:s.title,infos:[]},p=yield this._generateLegendElementsForBuildingSublayers(s.sublayers,c);n.infos.push(...p),i=[n,...i]}else s.renderer&&(i=[...yield this._getRendererLegendElements(s.renderer,{title:s.title,opacity:c,sublayer:s}),...i])}}return i.filter(s=>!!s&&(!("infos"in s)||!s.infos||s.infos.length>0))})}_constructLegendElementsForSublayers(){return w(this,null,function*(){this.legendElements=[],this.removeHandles("sublayers-watcher");let e=this.layer;if(ft(e)||$i(e)||ut(e)){this.addHandles(V(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){U.getLogger(this).warn("Request to server for legend has failed!",t)}}})}_generateLegendElementsForSublayers(e,t,i){return w(this,null,function*(){let r=this.layer,s=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let a=e.toArray();!i&&this.sublayerIds&&this.sublayerIds.length&&(a=ut(r)?this.sublayerIds.map(l=>r.findSublayerForSubtypeCode(l)).filter(_e):this.sublayerIds.map(l=>r.findSublayerById(l)).filter(_e));for(let l of a){let c=V(()=>[l.renderer,l.opacity,l.title,l.visible,l.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this.addHandles(c,"sublayers-watcher"),!this.respectLayerVisibility||l.visible&&l.legendEnabled&&this._isSublayerInScale(l)){let n=l?.opacity!=null?l.opacity:null,p=n!=null?n*t:t,h=!Fi(l)||l.originIdOf("renderer")>we.SERVICE&&!l.sublayers;if(l.renderer&&h)yield l.load(),s=[...yield this._getRendererLegendElements(l.renderer,{title:l.title,opacity:p,sublayer:l}),...s];else if(Fi(l)){let m=yield this._generateSymbolTableElementForSublayer(l,p,i);m&&s.unshift(m)}}}return s.filter(l=>!!l&&(!("infos"in l)||!l.infos||l.infos.length>0))})}_generateSymbolTableElementForSublayer(e,t,i){return w(this,null,function*(){if(!i){i=new Map;let s=this.layer,a=e.source,l=null;if(!(!a||a.type==="map-layer"&&a.mapLayerId===e.id&&(!a.gdbVersion||a.gdbVersion===("gdbVersion"in s&&s.gdbVersion)))||e.originIdOf("renderer")>we.SERVICE||e.originIdOf("labelingInfo")>we.SERVICE||e.originIdOf("labelsVisible")>we.SERVICE){let n=new ii({layer:this.layer});l=n.hasDynamicLayers?n.dynamicLayers:null,n.destroy()}let c=l||`${s.uid}-default`;(yield this._getLegendLayers(c,l)).forEach(n=>i.set(n.layerId,n))}let r=i.get(e.id);if((!r||r?.subLayerIds&&r.defaultVisibility)&&e.sublayers){let s=yield this._generateLegendElementsForSublayers(e.sublayers,t,i);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendLayer(r,e,t)})}_generateSymbolTableElementForLegendLayer(e,t,i){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;let r=t?.renderer,s=t?.title||e.layerName;if(r&&(!t||t?.originIdOf("renderer")>we.SERVICE)){let c=t?.title||this._getRendererTitle(r,t);c&&(s&&typeof c!="string"&&"title"in c&&(c.title=s),s=c)}let a={type:"symbol-table",title:s,legendType:e.legendType||null,infos:[]},l=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(c=>{let n={type:"symbol-table",title:c.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(l.filter(p=>p.groupId===c.id),e.layerId,i)};n.infos?.length>0&&a.infos.push(n)}):a.infos=this._generateSymbolTableElementInfosForLegendLayer(l,e.layerId,i),a.infos.length>0?a:null}_generateSymbolTableElementInfosForLegendLayer(e,t,i){return e.map(r=>{let s=r.url;if(r.imageData&&r.imageData.length>0)s=`data:image/png;base64,${r.imageData}`;else{if(s.indexOf("http")===0)return null;s=Nt(`${this.layer.url}/${t}/images/${s}`)}return{label:r.label,src:s,opacity:i??this.opacity,width:r.width,height:r.height}}).filter(_e)}_isSublayerInScale(e){let t=e.minScale||0,i=e.maxScale||0;return!(t>0&&t<this.scale||i>this.scale)}_isLegendLayerInScale(e,t){let i=t||this.layer,r=null,s=null,a=!0;return!i.minScale&&i.minScale!==0||!i.maxScale&&i.maxScale!==0?(e.minScale===0&&i.tileInfo&&(r=i.tileInfo.lods[0].scale),e.maxScale===0&&i.tileInfo&&(s=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(r=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,s=Math.max(i.maxScale,e.maxScale)),(r>0&&r<this.scale||s>this.scale)&&(a=!1),a}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&+this.layer.version<10.1||e.length===0)return e;let i=t.renderer,r=e.some(l=>l.values),s=0,a=null;return r&&e.some((l,c)=>(l.values||(s=c,a=l,a.label||(a.label="others")),a!=null)),i?i.type==="unique-value"?a&&(e.splice(s,1),e.push(a)):i.type==="class-breaks"&&(a&&e.splice(s,1),i.legendOptions?.order||e.reverse(),a&&e.push(a)):a&&(e.splice(s,1),e.push(a)),e}_getRendererLegendElements(i){return w(this,arguments,function*(e,t={}){if(!ys(e,this.view))return U.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(ds(e))return this._constructPointCloudRendererLegendElements(e,t);if(Pi(e))return this._constructDotDensityRendererLegendElements(e);let r=yield this._loadRenderer(e);return Bi(r)?this._constructPieChartRendererLegendElements(r):this._constructRendererLegendElements(r,t)})}_getLegendElementsForFeatureReduction(e){return w(this,null,function*(){let t=null;return e.type==="binning"?t=e.renderer:e.type==="cluster"&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]})}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}_constructPointCloudRendererLegendElements(i){return w(this,arguments,function*(e,t={}){let r=t.title,s=[],a=null,l=null;if(bt(e))a={type:"symbol-table",title:r||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(n=>{a.infos.unshift({label:n.label||n.minValue+" - "+n.maxValue,value:[n.minValue,n.maxValue],symbol:this._getAppliedCloneSymbol(je,n.color)})});else if(vt(e)){let n=e.stops,p=null;if(n?.length&&(n.length===1&&(p=n[0].color),!p)){let m=n[0].value,_=n[n.length-1].value;m!=null&&_!=null&&(p=pi(m+(_-m)/2,n))}a={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(je,p||je.color)}]};let h=di(e.stops??[])??[];l={type:"color-ramp",title:r||this._getPointCloudRendererTitle(e),infos:h,preview:K(h.map(m=>m.color),{ariaLabel:yield X("previewColorRampAriaLabel")})}}else Lt(e)&&(a={type:"symbol-table",title:r||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(n=>{a.infos.push({label:n.label||n.values.join(", "),value:n.values.join(", "),symbol:this._getAppliedCloneSymbol(je,n.color)})}));a?.infos.length&&s.push(a),l?.infos.length&&s.push(l);let c=s.reduce((n,p)=>[...n,...p.infos??[]],[]).filter(n=>!!n.symbol).map(n=>this._getSymbolPreview(n,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return yield Promise.allSettled(c),s})}_getElementInfoForDotDensity(e,t){return w(this,null,function*(){let{color:i,label:r,valueExpressionTitle:s}=t,{backgroundColor:a,outline:l,dotSize:c}=e,n=this.effectList,p=n?.effects.map(P=>P.toJSON()),h=Zt(p),m=yield X("previewTemplateAriaLabel",r||s),_=c+"-"+i+"-"+a+"-"+(l&&JSON.stringify(l.toJSON()))+"-"+h,v=this._dotDensityUrlCache,R=v.has(_)?v.get(_):Si(e,i,{ariaLabel:m});v.set(_,R);let $={shape:{type:"image",x:0,y:0,width:R.width,height:R.height,src:R.src},fill:null,stroke:null,offset:[0,0]},D=fi([[$]],[R.width,R.height],{effectView:this.effectList,ariaLabel:m});return{opacity:1,src:R.src,preview:D,width:R.width,height:R.height}})}_constructDotDensityRendererLegendElements(e){return w(this,null,function*(){let t=e.calculateDotValue(this.view.scale),i=e.legendOptions?.unit,r={type:"symbol-table",title:{value:t&&Math.round(t),unit:i||""},infos:[]};for(let s of e.attributes){let a=yield this._getElementInfoForDotDensity(e,s);a.label=s.label||s.valueExpressionTitle||s.field,r.infos.push(a)}return[r]})}_constructPieChartRendererLegendElements(e){return w(this,null,function*(){let t=this.layer.opacity,i=[],r=null,s=e.outline;e.attributes.forEach(n=>{let p=new Ce({color:n.color,outline:s}),h=n.label||n.valueExpressionTitle||n.field;i.push({label:h,symbol:p})});let a=i.length?[...i]:[];if(e.othersCategory?.color&&e.othersCategory?.threshold!==0){let n=new Ce({color:e.othersCategory.color,outline:s});r=e.othersCategory.label||"Other",i.push({label:r,symbol:n})}if(e.defaultColor?.a){let n=new Ce({color:e.defaultColor,outline:s});i.push({label:e.defaultLabel,symbol:n})}let l=(yield this._getVisualVariableLegendElements(e,this.layer))||[];if(i.length){l.unshift({type:"symbol-table",title:null,infos:i});let n=a.filter(h=>h.label!==r).map(h=>h.symbol.color).filter(Boolean),p=Ci(n,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:s,ariaLabel:yield X("previewPieChartAriaLabel")});l.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:i,preview:p})}let c=l.reduce((n,p)=>[...n,...this._getAllInfos(p)],[]).filter(n=>!!n?.symbol&&!n?.preview).map(n=>this._getSymbolPreview(n,t,{effectList:this.effectList}));return yield Promise.allSettled(c),l})}_getWhereClause(e,t,i){return w(this,null,function*(){let r=yield Jt(e,i),s=yield si(t,i),a=new Set(s.map(c=>c.toLowerCase()));return r?.fieldNames.map(c=>c.toLowerCase())?.some(c=>!a.has(c))?null:r})}_processDefinitionExpression(e,t){return w(this,null,function*(){if(!("definitionExpression"in e))return;let i=e.definitionExpression;i&&this.respectLayerDefinitionExpression?this._layerDefinitionExpression!==i&&(this._layerDefinitionExpressionClause=yield this._getWhereClause(i,t,e.fieldsIndex)):this._layerDefinitionExpressionClause=null,this._layerDefinitionExpression=i})}_processDisplayFilter(e,t){return w(this,null,function*(){if(!("displayFilterInfo"in e))return;let i=e.displayFilterInfo?Kt(e.displayFilterInfo,this.view):null;return i?.where?this._layerDisplayFilterId!==i?.id&&(this._layerDisplayFilterClause=yield this._getWhereClause(i.where,t,e.fieldsIndex)):this._layerDisplayFilterClause=null,this._layerDisplayFilterId=i?.id,i})}_constructRendererLegendElements(i){return w(this,arguments,function*(e,t={}){let{title:r,sublayer:s}=t,a=s||this.layer,l=yt(e),c=null;oe(e)&&(yield this._processDefinitionExpression(a,e),c=yield this._processDisplayFilter(a,e)),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;let n=(yield this._getVisualVariableLegendElements(e,a))||[],p={type:"symbol-table",title:r||this._getRendererTitle(e,a),infos:[]},h=null,m=!1,_=new Set;if(gt(e)&&!this._hasSizeRamp){let f=yield oi(e);p.infos.push({label:null,symbol:f})}else if(vs(e)){let f=r,b=Ls(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",S=n.findIndex(H=>H.type==="color-ramp"),I=S!==-1?n.splice(S,1)[0]:null,L=n.findIndex(H=>H.type==="size-ramp"),F=L!==-1?n.splice(L,1)[0]:null,k=[];I&&(f=I.title,k.push(I)),F&&(f=F.title,k.push(F)),k.length>0&&n.push({type:b,title:f,infos:k})}else if(Mi(e)){let f=mi(e);n.push({type:"heatmap-ramp",title:r||this._getRendererTitle(e,a),infos:f,preview:K(f.map(b=>b.color),{effectList:this.effectList,ariaLabel:yield X("previewColorRampAriaLabel")})})}else if(oe(e)){let f=e.authoringInfo;if(f&&f.type==="relationship"){let{numClasses:b,field1:S,field2:I}=f,L=f.focus;if(b&&S&&I){let F=[S,I],k=bi(L)||0;for(let re of F){let{field:Y,normalizationField:Z,label:$e}=re,Be=$e||{field:this._getFieldAlias(Y,a),normField:Z&&this._getFieldAlias(Z,a)},ve=ws.clone();ve.angle=k,p.infos.push({label:Be,symbol:ve}),_.add(ve),k+=90}let H=gi({focus:L,numClasses:b,infos:e.uniqueValueInfos??[]});n.unshift(H)}}else if(Ie(this.layer)||Je(this.layer))e.uniqueValueInfos?.forEach(b=>{b.symbol&&this._checkClausesForUVR(e,b.value)&&p.infos.push({label:b.label||b.value,value:b.value,symbol:b.symbol})});else{let{field:b,field2:S,field3:I,fieldDelimiter:L,valueExpression:F,defaultSymbol:k}=e,H=!(!b&&!F||!S&&!I),re=this._layerDisplayFilterClause?c?.title:null,Y=[];if(e.uniqueValueGroups?.forEach(Z=>{let $e={type:"symbol-table",title:re||Z.heading,infos:[]};Z.classes?.forEach(Be=>{let{symbol:ve,values:ss}=Be;if(ve){let st=[],Vt=[];for(let Le of ss??[]){let{value:$t,value2:Ft,value3:Tt}=Le,Fe=[],Oe=[];(b||F)&&(Fe.push($t),Oe.push(this._getDomainName(b,$t,a))),S&&(Fe.push(Ft),Oe.push(this._getDomainName(S,Ft,a))),I&&(Fe.push(Tt),Oe.push(this._getDomainName(I,Tt,a))),st.push(H?Fe.join(L||""):Fe[0]),Vt.push(Oe.join(" - "))}let zt=st.join(", "),rt=Be.label;if(!rt){let Le=Vt.filter(Boolean);rt=Le.length?Le.join(", "):zt}let at=ve.clone();at.type==="cim"&&l&&vi(at,{innerDotSize:.5*zi,outerRingSize:zi}),st.some(Le=>this._checkClausesForUVR(e,Le))&&$e.infos.push({label:rt,value:zt,symbol:at})}}),$e.infos.length&&Y.push($e)}),Y.length){let Z=Y[0];Y.length===1&&"title"in Z&&!Z.title?p.infos.push(...Z.infos??[]):(k&&(Y.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:k}]}),m=!0),p.infos.push(...Y)),r||e.legendOptions?.title||e.valueExpressionTitle||(p.title=null)}}e.defaultSymbol&&!m&&(p.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),m=!0)}else if(ne(e)){if(!l){if(h=this._isUnclassedRenderer(e),!h||!this._hasSizeRamp){let f=e.classBreakInfos.filter(({symbol:S})=>S),b=e.legendOptions?.order==="ascending-values";for(let{label:S,minValue:I,maxValue:L,symbol:F}of f){let k={label:S||(h?null:`${I} - ${L}`),value:[I,L],symbol:F};b?p.infos.push(k):p.infos.unshift(k)}h&&(p.title=null),this._updateInfosForClassedSizeRenderer(e,p.infos)}e.defaultSymbol&&!h&&(p.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),m=!0)}}else if(ki(e))if(Je(this.layer)||gs(this.layer)){let f=yield this._constructTileImageryStretchRendererElements(e);bs(f)?n.push(f):p.infos=f}else{let f=this.layer,b,S;e.customStatistics?.length&&({min:b,max:S}=e.customStatistics[0]);let I=[],L=f.serviceRasterInfo;if(f.rasterFunction)try{L=yield f.generateRasterInfo(f.rasterFunction)}catch{}let F=dt(L.pixelType);if(L.bandCount===1){let k=f.bandIds?.[0]||0;b=b??(L.statistics?L.statistics[k].min:F[0]),S=S??(L.statistics?L.statistics[k].max:F[1]),b||S?n.push(yield this._getStretchLegendElements(e,{min:b,max:S})):this._getServerSideLegend()}else if(f.bandIds&&f.bandIds.length===1)b=b??(L.statistics?L.statistics[f.bandIds[0]].min:F[0]),S=S??(L.statistics?L.statistics[f.bandIds[0]].max:F[1]),b||S?n.push(yield this._getStretchLegendElements(e,{min:b,max:S})):this._getServerSideLegend();else if(L.bandCount>=3){let{bandInfos:k}=L,{bandIds:H}=f;k.length>=L.bandCount?H?.length===3?(I=H.map(re=>k[re].name),p.infos=this._createSymbolTableElementMultiBand(I)):f.format==="lerc"?(I=[0,1,2].map(re=>k[re].name),p.infos=this._createSymbolTableElementMultiBand(I)):this._getServerSideLegend():f.format==="lerc"?(I=["band1","band2","band3"],p.infos=this._createSymbolTableElementMultiBand(I)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(Di(e))e.colormapInfos.forEach(f=>{p.infos.push({label:f.label,value:f.value,symbol:this._getAppliedCloneSymbol(cs,f.color)})});else if(xe(e)){let f=e.symbol;switch(t.geometryType){case"point":f="pointSymbol"in a?a.pointSymbol:null;break;case"polyline":f="lineSymbol"in a?a.lineSymbol:null;break;case"polygon":f="polygonSymbol"in a?a.polygonSymbol:null}let b=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&b&&p.infos.push({label:e.label,symbol:f})}else if(Ti(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),p.title=e.attributeField;let f=e.getClassBreakInfos();f?.length?f.forEach(b=>{p.infos.push({label:b.minValue+" - "+b.maxValue,symbol:b.symbol})}):p.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else Ai(e)&&n.push(yield this._getStretchLegendElements(e,{min:0,max:255}));let v=e.defaultSymbol;!v||m||xe(e)||h&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||n.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:v}]}),p.infos.length&&n.unshift(p);let R=t.opacity==null?this.opacity:t.opacity,$=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),D=Ie(this.layer)||Je(this.layer),P=n.reduce((f,b)=>[...f,...this._getAllInfos(b)],[]).filter(f=>!!f?.symbol).filter(f=>{if(f.symbol.type==="cim"){let{minScale:b,maxScale:S}=f.symbol.data;if(b&&b<this.scale||S&&S>this.scale)return!1}return!0}).map(f=>this._getSymbolPreview(f,R,{isDefault:f.symbol===v,applyScaleDrivenSize:!_.has(f.symbol),symbolConfig:{isTall:$,isSquareFill:D},effectList:_.has(f.symbol)?null:this.effectList}));return e=null,yield Promise.allSettled(P),n})}_checkClausesForUVR(e,t){let i=_s(e,t);return!i||(!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature(i))&&(!this._layerDisplayFilterClause||this._layerDisplayFilterClause.testFeature(i))}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){let t=e?.infos;return t?t.reduce((i,r)=>i.concat(this._getAllInfos(r)),[]):[e]}_constructTileImageryStretchRendererElements(e){return w(this,null,function*(){let t=this.layer,i=t.symbolizer.rasterInfo??t.raster.rasterInfo,r,s,a=e?.customStatistics?.length?e.customStatistics:i?.statistics;if(a)({min:r,max:s}=a[0]);else{let c=dt(i.pixelType);r=c[0],s=c[1]}if(t.hasStandardTime()&&(r=t.getStandardTimeValue(r),s=t.getStandardTimeValue(s)),i.bandCount===1||t.bandIds?.length===1)return this._getStretchLegendElements(e,{min:r,max:s});let l=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(i.bandCount,3)).keys())).map(c=>i.bandInfos[c].name);return l.length<3?l.push(l[1]):l.length>3&&l.splice(3),this._createSymbolTableElementMultiBand(l)})}_getStretchLegendElements(e,t){return w(this,null,function*(){let i=e.colorRamp,r=yi(i,t);return{type:"stretch-ramp",title:"",infos:r,preview:K(r.map(s=>s.color),{ariaLabel:yield X("previewColorRampAriaLabel")})}})}_getClusterSymbol(){let e=this.layer,t="featureReduction"in e&&e.featureReduction,i=t&&"symbol"in t&&t.renderer;return i&&i?.authoringInfo?.isAutoGenerated!==!0?null:t&&"symbol"in t?t.symbol:null}_getSizeLegendElement(e,t,i,r){return w(this,null,function*(){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:yield wi(i,t,yield pt(i),this.scale,this.view,r,this._hasClusterSizeVariable?this._getClusterSymbol():null)}})}_createSymbolTableElementMultiBand(e){let t=[],i=["red","green","blue"];return e.forEach((r,s)=>{t.push({label:{colorName:i[s],bandName:r},src:ni[s],opacity:this.opacity??1})}),t}_updateInfosForClassedSizeRenderer(e,t){let i=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",r=e.classBreakInfos.some(s=>ti(s.symbol));if(i&&r){let s=Li,a=_i,l=e.classBreakInfos.length,c=(s-a)/(l>1?l-1:l);t.forEach((n,p)=>{n.size=s-c*p})}}_isTallSymbol(e){let t=!1,i=!1;if(e)for(let r=0;r<e.length&&(!t||!i);r++){let s=e[r];s.type==="size"&&(s.axis==="height"&&(t=!0),s.axis==="width-and-depth"&&(i=!0))}return t&&i}_getSymbolPreview(e,t,i){return w(this,null,function*(){let r=!i?.isDefault&&e.size==null&&this._hasSizeRamp?jt(hi.size):e.size;if(this._scaleDrivenSizeVariable&&i?.applyScaleDrivenSize){let{getSize:a}=yield import("./chunk-P2RJV47D.js");r=a(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}let s=!i?.isDefault&&this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!i?.applyScaleDrivenSize);return Ei(e.symbol,{size:r,opacity:t,scale:!1,symbolConfig:i?.symbolConfig,effectView:i?.effectList,style:"legend",cimOptions:{allowScalingUp:s,viewParams:this.isScaleDriven?{viewingMode:this.view?.type==="2d"?"map":this.view?.viewingMode,scale:this.view?.scale}:null},ariaLabel:e.label&&typeof e.label!="string"?null:yield X("previewTemplateAriaLabel",e.label)}).then(a=>(e.preview=a,e)).catch(()=>(e.preview=null,e))})}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;let t="renderer"in this.layer?this.layer.renderer:null,i=e.renderer?.clone()||t?.clone(),r=xi(e,this.layerView,this.view);if(r&&i!=null&&"visualVariables"in i&&!i.visualVariables?.some(a=>a.type==="size"&&a.target!=="outline"&&!Ge.test(a.valueExpression))){if("clusterMinSize"in e&&"clusterMaxSize"in e){let{clusterMinSize:l,clusterMaxSize:c}=e;r.legendOptions=new Xt({showLegend:l!==c})}let a=i.visualVariables||[];i.visualVariables=a.concat([r]),this._hasClusterSizeVariable=!0}return i}_loadRenderer(e){return w(this,null,function*(){let t=[],i=e.clone(),r=yield pt(i);if(ne(i)||oe(i)){let s=(i.classBreakInfos||i.uniqueValueInfos).map(a=>this._fetchSymbol(a.symbol,r).then(l=>{a.symbol=l}).catch(()=>{a.symbol=null}));Array.prototype.push.apply(t,s)}return t.push(this._fetchSymbol(i.symbol||i.defaultSymbol,i.defaultSymbol?null:r).then(s=>{this._applySymbolToRenderer(i,s,xe(i))}).catch(()=>{this._applySymbolToRenderer(i,null,xe(i))})),yield Promise.allSettled(t),i})}_applySymbolToRenderer(e,t,i){i?e.symbol=t:e.defaultSymbol=t}_fetchSymbol(e,t){return w(this,null,function*(){if(!e)throw new Error;if(e.type==="web-style"){let i=this._webStyleSymbolCache;try{let r=yield this.view.type==="2d"?e.fetchCIMSymbol({cache:i}):e.fetchSymbol({cache:i});return this._getAppliedCloneSymbol(r,t)}catch{throw U.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)})}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;let i=e.clone(),r=t&&t.toRgba();return i.type.includes("3d")?this._applyColorTo3dSymbol(i,r):i.type==="cim"?ei(i,t):i.color&&(i.color=new ee(r||i.color)),i}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(i=>{i&&(i.material||(i.material={}),i.material.color=new ee(t))})}_getVisualVariableLegendElements(e,t){return w(this,null,function*(){if(!("visualVariables"in e)||e.type==="vector-field")return null;let i=e.visualVariables??[],r=[],s=[],a=[],l=yt(e);if(l?.sizeStops?.length===2&&(ne(e)||oe(e))){let[m,_]=l.sizeStops;s.push(new De({field:l.field??void 0,normalizationField:l.normalizationField,minSize:m.size,maxSize:_.size,minDataValue:m.value,maxDataValue:_.value}))}for(let m of i)m.type==="color"?r.push(m):m.type==="size"?s.push(m):m.type==="opacity"&&a.push(m);let c=[...r,...s,...a],n,p;if(r.length===0&&ne(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){let m=e.classBreakInfos[0];n=m&&m.symbol}if(r.length===0&&xe(e)&&(n=e.symbol),n)if(n.type.includes("3d")){let m=n.symbolLayers.at(0);m.type==="water"?m.color!=null&&(p=m.color):m.material?.color!=null&&(p=m.material.color)}else n.url||(p=n.color);let h=this.effectList;return(yield Promise.all(c.map(m=>w(this,null,function*(){if(!m.legendOptions||m.legendOptions.showLegend!==!1){let _=gt(e)?m.field:this._getRampTitle(m,t),v=null,R=ci(t,m,this.view.timeZone);if(m.type==="color"){let $=(yield mt(m,null,R))??[];v={type:"color-ramp",title:_,infos:$,preview:K($.map(D=>D.color),{effectList:h,ariaLabel:yield X("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=$.length>0)}else if(m.type==="size"&&m.target!=="outline")Ge.test(m.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=m):(v=yield this._getSizeLegendElement(_,m,e,R),this._hasSizeRamp||(this._hasSizeRamp=!(v.infos==null||!v.infos.length)));else if(m.type==="opacity"){let $=(yield mt(m,p,R))??[];v={type:"opacity-ramp",title:_,infos:$,preview:K($.map(D=>D.color),{effectList:h,ariaLabel:yield X("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=$.length>0)}return v?.infos?v:null}})))).filter(_e)})}_getDomainName(e,t,i){if(e&&typeof e!="function"){let r="getField"in i&&i.getField?.(e),s=r&&"getFieldDomain"in i&&i.getFieldDomain?i.getFieldDomain(r.name,{excludeImpliedDomains:Dt("esri-widget-legacy-field-domain-calculation")}):null;return s?.type==="coded-value"?s.getName(t):null}return null}_getClusterTitle(e){let t=this.layer,i=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){let r=t.featureReduction,s="popupTemplate"in r&&r.popupTemplate,a=s&&s.fieldInfos;if(a){for(let l of a)if(l.fieldName===i)return i==="cluster_count"?l.label||{showCount:!0}:l.label}}return{showCount:!0}}_getRampTitle(e,t){let i=e.field,r=e.normalizationField,s=!1,a=!1,l=!1,c=null;i=typeof i=="function"?null:i,r=typeof r=="function"?null:r;let n=e.legendOptions?.title;if(n!=null)c=n;else if(e.valueExpressionTitle)c=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo?.visualVariables){let p=t.renderer.authoringInfo.visualVariables;for(let h=0;h<p.length;h++){let m=p[h];if(m.type==="color"){if(m.style==="ratio"){s=!0;break}if(m.style==="percent"){a=!0;break}if(m.style==="percent-of-total"){l=!0;break}}}}c={field:i&&this._getFieldAlias(i,t),normField:r&&this._getFieldAlias(r,t),ratio:s,ratioPercent:a,ratioPercentTotal:l}}return c}_getRendererTitle(e,t){let i=e;if(i.legendOptions?.title)return i.legendOptions.title;if(i.valueExpressionTitle)return i.valueExpressionTitle;let r=i.field,s=null,a=null;if(ne(i)&&(s=i.normalizationField,a=i.normalizationType==="percent-of-total"),r=typeof r=="function"?null:r,s=typeof s=="function"?null:s,oe(i)){let{field2:c,field3:n,fieldDelimiter:p}=i,h=r&&this._getFieldAlias(r,t);return c&&(h=`<${h}>${p}<${this._getFieldAlias(c,t)}>`,n&&(h=`${h}${p}<${this._getFieldAlias(n,t)}>`)),h}let l=null;return(r||s)&&(l={field:r&&this._getFieldAlias(r,t),normField:s&&this._getFieldAlias(s,t),normByPct:a}),l}_getFieldAlias(e,t){let s=("popupTemplate"in t?t.popupTemplate:null)?.fieldInfos?.find(h=>e===h.fieldName),a=null;"getField"in t&&t.getField?a=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(a=t.fieldsIndex.get(e));let l=null,c="featureReduction"in t&&t.featureReduction;c&&(s??="popupTemplate"in c?c.popupTemplate?.fieldInfos?.find(h=>e?.toLowerCase()===h.fieldName?.toLowerCase()):void 0,"fields"in c&&c.fields&&(l=c.fields.find(h=>h.name?.toLowerCase()===e?.toLowerCase())));let n=s||a||l,p=null;return n&&(p=s?.label||a?.alias||l?.alias||"name"in n&&n.name||"fieldName"in n&&n.fieldName||null),p}_isUnclassedRenderer(e){let t=e.visualVariables,i=!1;return ne(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(i=e.field?t.some(r=>!(!r||e.field!==r.field||(e.normalizationField||r.normalizationField)&&e.normalizationField!==r.normalizationField)):!!t.length),i}};d([y()],A.prototype,"children",void 0),d([y({readOnly:!0})],A.prototype,"effectList",null),d([y()],A.prototype,"layerView",void 0),d([y()],A.prototype,"layer",void 0),d([y()],A.prototype,"legendElements",void 0),d([y({readOnly:!0})],A.prototype,"opacity",null),d([y()],A.prototype,"parent",void 0),d([y({readOnly:!0,dependsOn:[]})],A.prototype,"ready",null),d([y()],A.prototype,"hideLayersNotInCurrentView",void 0),d([y()],A.prototype,"keepCacheOnDestroy",void 0),d([y()],A.prototype,"respectLayerDefinitionExpression",void 0),d([y()],A.prototype,"respectLayerVisibility",void 0),d([y({readOnly:!0})],A.prototype,"scale",null),d([y()],A.prototype,"sublayerIds",void 0),d([y({readOnly:!0})],A.prototype,"isScaleDriven",null),d([y()],A.prototype,"title",void 0),d([y({readOnly:!0,dependsOn:["ready"],value:0})],A.prototype,"version",null),d([y()],A.prototype,"view",void 0),A=d([x("esri.widgets.Legend.support.ActiveLayerInfo")],A);var _t=A;var ce={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},Oi=Te.ofType(_t),Ss=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CatalogLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.ParquetLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.catalog.CatalogFootprintLayer","esri.layers.catalog.CatalogDynamicGroupLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer","esri.layers.KnowledgeGraphLayer"]),Ni="view.basemapView.baseLayerViews",Hi="view.groundView.layerViews",Ui="view.basemapView.referenceLayerViews",Cs=[Ni,Hi,"view.layerViews",Ui],B=class extends Ne{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Te,this.activeLayerInfos=new Oi,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(V(()=>this.view,()=>this._viewHandles(),W),ce.view),this.addHandles(Ht(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(ce.state),this.view&&this.addHandles(V(()=>this.state,()=>this._stateHandles(),W),ce.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([ce.allLayerViews,ce.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);let t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t?.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){let{view:e}=this;if(!e)return;let{allLayerViews:t}=e;t.length&&this._refresh(),this.addHandles(t.on("change",i=>this._allLayerViewsChangeHandle(i)),ce.allLayerViews),this.addHandles(V(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),ce.legendProperties)}_allLayerViewsChangeHandle(e){e.moved.length?this._propertiesChangeHandle():(e.removed.forEach(t=>this._destroyViewActiveLayerInfo(t.uid)),this._refresh())}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){let t=this.view;if(e.length<2||!t)return;let i=[];e.forEach(s=>{if(!s.parent){let a=s.layer.parent,l=a&&"uid"in a&&this._layerViewByLayerId[a.uid],c=l&&this._activeLayerInfosByLayerViewId[l.uid];c&&e.includes(c)&&(i.push(s),s.parent=c,c.children.add(s),this._sortActiveLayerInfos(c.children))}}),e.removeMany(i);let r={};t.allLayerViews.forEach((s,a)=>r[s.layer.uid]=a),e.sort((s,a)=>{let l=r[s.layer.uid]||0;return(r[a.layer.uid]||0)-l})}_generateLayerViews(){let e=[];return Cs.filter(this._filterLayerViews,this).map(t=>At(this,t)).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){let t=!this.basemapLegendVisible&&(e===Ni||e===Ui),i=!this.groundLegendVisible&&e===Hi;return!t&&!i}_collectLayerViews(e,t){let i=r=>(r&&r.forEach(s=>{t.push(s),i(s[e])}),t);return i}_filterLayerViewsByLayerInfos(e){let t=this.layerInfos;return!t||!t.length||t.some(i=>this._hasLayerInfo(i,e))}_hasLayerInfo(e,t){let i=this._isLayerUIDMatching(e.layer,t.layer.uid);return i&&(this._layerInfosByLayerViewId[t.uid]=e),i}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(i=>this._isLayerUIDMatching(i,t))}_isLayerViewSupported(e){return!!Ss.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(V(()=>[e.legendEnabled,e.layer?.legendEnabled],()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}_buildActiveLayerInfo(e){let t=e.layer,i=e.uid,r=this._layerInfosByLayerViewId[i],s=this._activeLayerInfosByLayerViewId[i];if(!s){let l=r?.title!==void 0&&r.layer.uid===t.uid;s=new _t({layer:t,layerView:e,title:l?r.title:t.title,view:this.view??void 0,respectLayerDefinitionExpression:this.respectLayerDefinitionExpression,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:r?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[i]=s}let a=t.parent&&"uid"in t.parent?this._layerViewByLayerId[t.parent?.uid]:null;if(s.parent=this._activeLayerInfosByLayerViewId[a?.uid],!this.hasHandles(i)){let l=[V(()=>t.title,c=>this._titleHandle(c,s)),V(()=>[t.opacity,"renderer"in t&&t.renderer,"pointSymbol"in t&&t.pointSymbol,"lineSymbol"in t&&t.lineSymbol,"polygonSymbol"in t&&t.polygonSymbol],()=>this._constructLegendElements(s)),nt(()=>this.view?.stationary===!0,()=>this._scaleHandle(s),W),V(()=>e.layer?ht(e.layer,e.view):null,()=>this._constructLegendElements(s)),V(()=>e.updating,()=>{e.layer!=null&&ht(e.layer,e.view)!=null&&this._constructLegendElements(s)}),V(()=>"effect"in t&&t.effect,()=>this._constructLegendElements(s)),nt(()=>this.view?.timeZone,()=>this._constructLegendElements(s),W)];if(this.respectLayerVisibility){let c=V(()=>e.legendEnabled,p=>this._legendEnabledHandle(p,s)),n=V(()=>t.legendEnabled,p=>this._legendEnabledHandle(p,s));l.push(c,n)}if(this.respectLayerDefinitionExpression&&"definitionExpression"in t){let c=V(()=>[t.definitionExpression,this.respectLayerDefinitionExpression],()=>{s.respectLayerDefinitionExpression=this.respectLayerDefinitionExpression,this._constructLegendElements(s)});l.push(c)}this.addHandles(l,i)}s.isScaleDriven||this._constructLegendElements(s),this._addActiveLayerInfo(s)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){let{layerView:t,layer:i}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){let r=e.parent;if(r)r.children.includes(e)||r.children.push(e),this._sortActiveLayerInfos(r.children);else{let s=this.layerInfos?.some(l=>l.layer.uid===i.uid),a=i.parent;a&&"uid"in a&&this._layerViewByLayerId[a.uid]&&!s?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){let s=[];this._activeLayerInfosWithNoParent.forEach(a=>{let l=a.layer.parent,c=l&&"uid"in l?this._layerViewByLayerId[l?.uid]:null,n=this._activeLayerInfosByLayerViewId[c?.uid];n&&(s.push(a),a.parent=n)}),s.length&&(this._activeLayerInfosWithNoParent.removeMany(s),s.forEach(a=>this._addActiveLayerInfo(a)))}}}_removeActiveLayerInfo(e){let t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){let t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"featureReduction"in t&&t.featureReduction&&"renderer"in t.featureReduction&&(t.featureReduction.type==="binning"||t.featureReduction.type==="cluster")&&(!this.view||t.featureReduction.maxScale<=this.view.scale)?e.buildLegendElementsForFeatureReduction(t.featureReduction):"renderer"in t&&t.renderer&&!("sublayers"in t)?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url&&t.type!=="catalog"&&t.type!=="knowledge-graph"?e.buildLegendElementsForTools():e.children.forEach(i=>this._constructLegendElements(i))}};d([y({type:Oi})],B.prototype,"activeLayerInfos",void 0),d([y()],B.prototype,"basemapLegendVisible",void 0),d([y()],B.prototype,"groundLegendVisible",void 0),d([y()],B.prototype,"hideLayersNotInCurrentView",void 0),d([y()],B.prototype,"keepCacheOnDestroy",void 0),d([y()],B.prototype,"respectLayerDefinitionExpression",void 0),d([y()],B.prototype,"respectLayerVisibility",void 0),d([y()],B.prototype,"layerInfos",void 0),d([y({readOnly:!0})],B.prototype,"state",null),d([y()],B.prototype,"view",void 0),B=d([x("esri.widgets.Legend.LegendViewModel")],B);var Wi=B;var C="esri-legend--card",Ve="esri-legend",u={activated:`${C}__carousel-indicator--activated`,base:C,stacked:`${Ve}--stacked`,carouselTitle:`${C}__carousel-title`,indicator:`${C}__carousel-indicator`,intervalSeparator:`${C}__interval-separator`,imageryLayerStretchedImage:`${C}__imagery-layer-image--stretched`,imageLabel:`${C}__image-label`,layerCaption:`${C}__layer-caption`,labelElement:`${C}__label-element`,layerRow:`${C}__layer-row`,labelCell:`${C}__label-cell`,message:`${C}__message`,rampLabel:`${C}__ramp-label`,section:`${C}__section`,relationshipSection:`${C}__relationship-section`,serviceCaptionText:`${C}__service-caption-text`,serviceContent:`${C}__service-content`,service:`${C}__service`,groupLayer:`${C}__group-layer`,groupLayerChild:`${C}__group-layer-child`,symbol:`${C}__symbol`,sizeRampRow:`${C}__size-ramp-row`,symbolRow:`${C}__symbol-row`,symbolCell:`${C}__symbol-cell`,carousel:`${C}__carousel`,carouselItem:`${C}__carousel-item`,indicatorContainer:`${C}__carousel-indicator-container`,intervalSeparatorsContainer:`${C}__interval-separators-container`,relationshipLabelContainer:`${C}__relationship-label-container`,labelContainer:`${C}__label-container`,serviceCaptionContainer:`${C}__service-caption-container`,symbolContainer:`${C}__symbol-container`,colorRampContainer:`${C}__color-ramp-container`,sizeRampContainer:`${C}__size-ramp-container`,sizeRampPreview:`${C}__size-ramp-preview`,pieChartRampPreview:`${C}__pie-chart-ramp-preview`,rampContainer:`${Ve}__ramps`,sizeRampHorizontal:`${Ve}__size-ramp--horizontal`,rampLabelsContainer:`${Ve}__ramp-labels`,layerInfo:`${Ve}__layer-cell ${Ve}__layer-cell--info`,univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card"};function Es(e,t){return t}function z(e){let t=this;e.appendChild(t)}function G(e,t,i){if(!t)return;if(typeof t=="number")return t;if(typeof t=="string")return kt(t);if("value"in t||"unit"in t)return ae(e.dotValue,t);if("colorName"in t&&"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:void 0;let r=null;return Es(t,i)?r=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:wt(t,i)&&(r=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),r?ae(r==="showField"?"{field}":e[r],{field:t.field,normField:t.normField}):void 0}function wt(e,t){return!t}function Qe(e,t){return!!(t&&t==="Stretched"&&"version"in e&&typeof e.version=="number"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}function qi(e,t){return e.label?t[e.label]+": "+(typeof e.value=="string"?e.value:He(e.value??0,{style:"decimal",notation:e.value?.toString().toLowerCase().includes("e")?"scientific":"standard"})):""}function Ze(e,t,i){switch(t){case"heatmap-ramp":return i[e.label]||e.label;case"stretch-ramp":return qi(e,i);default:return e.label}}function Ke(e,t){if(!e.title||typeof e.title=="string")return e.title;let i=e.type==="color-ramp"||e.type==="opacity-ramp",r=e.title,s=G(t,r,i);return wt(r,i)&&r.title?`${r.title} (${s})`:s}var Is=25,Rs=25,xs=100,de=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.legendElement=null,this.opacity=1}render(){let e=this.legendElement.infos.slice().reverse();return o("div",{class:this.classes(u.layerRow,u.colorRampContainer)},this._renderRampLabel(e[0]),o("div",{class:u.symbolContainer},this._renderPreview(e),this._renderMiddleStopRampLabel(e)),this._renderRampLabel(e.at(-1)))}_renderPreview(e){let{opacity:t}=this,i=this.legendElement.type==="heatmap-ramp",r=e.length-1,s=Rs,a=r>2&&!i?Is*r:xs,l=a+20,c=10,n=[[{shape:{type:"path",path:`M0 ${s/2} L${c} 0 L${c} ${s} Z`},fill:e[0].color,stroke:{width:0}},{shape:{type:"rect",x:c,y:0,width:a,height:s},fill:{type:"linear",x1:c,y1:0,x2:a+c,y2:0,colors:e.map((m,_)=>({color:m.color,offset:i&&"ratio"in m?m.ratio:_/r}))},stroke:{width:0}},{shape:{type:"path",path:`M${a+c} 0 L${l} ${s/2} L${a+c} ${s} Z`},fill:e[e.length-1].color,stroke:{width:0}}]],p=ui(n,l,s),h={filter:We(this.effectList)??void 0,opacity:t==null?void 0:`${t}`};return o("div",{styles:h},p)}_renderMiddleStopRampLabel(e){let t=e.length%2!=0?e[e.length/2|0]:null;return t?o("div",{class:u.intervalSeparatorsContainer},o("div",{class:u.intervalSeparator},"|"),this._renderRampLabel(t)):null}_renderRampLabel(e){return o("div",{class:u.rampLabel},Ze(e,this.legendElement.type,this.messages))}};d([y()],de.prototype,"effectList",void 0),d([y()],de.prototype,"legendElement",void 0),d([y()],de.prototype,"messages",void 0),d([y()],de.prototype,"opacity",void 0),de=d([x("esri.widgets.Legend.styles.card.ColorRamp")],de);var Gi=de;var Vs="#ddd",ze=window.devicePixelRatio;function zs(e){if(!e)return;if(e.type.includes("3d")){if(!e.symbolLayers?.length)return;let i=e.symbolLayers.at(-1),r=i.resource?.primitive;return r==="circle"||r==="cross"||r==="kite"||r==="sphere"||r==="cube"||r==="diamond"}let t=e.style;return t==="circle"||t==="diamond"||t==="cross"}function $s(e){if(e){if(e.type.includes("3d")){if(!e.symbolLayers?.length)return;let t=e.symbolLayers.at(-1),i=t?.resource?.primitive;return i==="triangle"||i==="cone"||i==="tetrahedron"}return e.style==="triangle"}}var pe=class extends T{constructor(e,t){super(e,t),this.hasIndicators=!1,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,hasIndicators:t,opacity:i}=this,r=e.infos,_=r.at(0),{label:s}=_,a=lt(_,["label"]),v=r.at(-1),{label:l}=v,c=lt(v,["label"]),n=a.preview,p=c.preview,h={"flex-direction":t?"column":"row-reverse"};n&&(n=n.cloneNode(!0),n.style.display="flex"),p&&(p=p.cloneNode(!0),p.style.display="flex");let m={opacity:i!=null?`${i}`:""};return o("div",{class:this.classes(u.layerRow,{[u.sizeRampRow]:t})},o("div",{class:u.rampLabel},t?s:l),o("div",{class:u.sizeRampContainer,styles:h},o("div",{afterCreate:z,bind:n,class:u.sizeRampPreview,styles:m}),this._renderSizeRampLines(e),o("div",{afterCreate:z,bind:p,class:u.sizeRampContainer,styles:m})),o("div",{class:u.rampLabel},t?l:s))}_renderSizeRampLines(e){let t=e.infos,i=t[0],r=t.at(-1),s=i.symbol,a=this.hasIndicators,l=q(i.size+i.outlineSize)*ze,c=q(r.size+r.outlineSize)*ze,n=a?l:l+50*ze,p=a?l/2+50*ze:l,h=$s(s),m=zs(s),_=document.createElement("canvas");_.width=n,_.height=p,_.style.width=_.width/ze+"px",_.style.height=_.height/ze+"px";let v=_.getContext("2d");if(a){v.beginPath();let R=0,$=0,D=n/2-c/2,P=p;v.moveTo(R,$),v.lineTo(D,P);let f=n,b=0,S=n/2+c/2,I=p;v.moveTo(f,b),v.lineTo(S,I)}else{v.beginPath();let R=0,$=p/2-c/2,D=n;v.moveTo(R,$),v.lineTo(D,0);let f=0,b=p/2+c/2,S=n,I=p;v.moveTo(f,b),v.lineTo(S,I)}return v.strokeStyle=Vs,v.stroke(),o("div",{afterCreate:z,bind:_,styles:a?{display:"flex",marginTop:`-${h?0:m?l/2:0}px`,marginBottom:`-${h?c:m?c/2:0}px`}:{display:"flex",marginRight:`-${h?0:m?l/2:0}px`,marginLeft:`-${h?0:m?c/2:0}px`}})}};d([y()],pe.prototype,"hasIndicators",void 0),d([y()],pe.prototype,"legendElement",void 0),d([y()],pe.prototype,"messages",void 0),d([y()],pe.prototype,"opacity",void 0),pe=d([x("esri.widgets.Legend.styles.card.SizeRamp")],pe);var ji=pe;var Fs=qt(),Ji=10,St=20,Xe=10,Ct=20,Et={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Ts(e="vertical"){let t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?o("svg",{height:"4",width:"10"},o("line",{style:t,x1:"0",x2:"10",y1:"2",y2:"2"})):o("svg",{height:"10",width:"10"},o("line",{style:t,x1:"5",x2:"5",y1:"0",y2:"10"}))}function Ds(e,t="vertical"){let i=document.createElement("div");return i.style.height=`${St}px`,i.className=Et.univariateAboveAndBelowSymbol,e!=null&&(i.style.opacity=e.toString()),Fs.append(i,Ts.bind(null,t)),i}function Qi(e,t,i="vertical",r){e.infos.forEach((s,a)=>{if(r&&a===2)s.preview=Ds(t,i);else{let l=q(s.size)+(i==="horizontal"?Ct:Xe),c=s.preview,n=c?.tagName.toLowerCase()==="div",p=n?c:document.createElement("div");p.className=Et.univariateAboveAndBelowSymbol,i==="horizontal"?p.style.width=`${l}px`:p.style.height=`${l}px`,!n&&c&&p.appendChild(c),s.preview=p}})}function te(e,t="classic"){let i=e.infos;return t==="classic"?(q(i[0].size)+Xe)/2:(q(i[0].size)-q(i[i.length-1].size))/2}function j(e,t){if(!e)return null;let i=e.infos.map(s=>s.color),r=K(t.type==="full"?i:t.type==="above"?i.slice(0,3):i.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList,ariaLabel:t.ariaLabel});return r.className=Et.colorRamp,t.opacity!=null&&(r.style.opacity=t.opacity.toString()),r}function Ae(e,t,i,r="vertical"){let s=0,a=e.infos,l=Math.floor(a.length/2),c=t==="full"||t==="above"?0:l,n=t==="full"||t==="below"?a.length-1:l;for(let p=c;p<=n;p++)i&&p===l?s+=r==="horizontal"?Ji:St:s+=q(a[p].size)+(r==="horizontal"?Ct:Xe);return Math.round(s)}function J(e,t,i,r="vertical"){let s=Ae(e,t,i,r),a=e.infos,l=Math.floor(a.length/2),c=t==="full"||t==="above"?0:l,n=t==="full"||t==="below"?a.length-1:l,p=t==="full"?a[c].size+a[n].size:t==="above"?a[c].size:a[n].size,h=i?r==="vertical"?St:Ji:0,m=r==="vertical"?Xe*(t==="full"?2:1):Ct*(t==="full"?2:1);return Math.round(s-(q(p)/2+h/2+m/2))}function Ye(e,t,i="vertical"){let r=e.infos,s=r.find(({type:l})=>l==="size-ramp"),a=r.find(({type:l})=>l==="color-ramp");return s&&(s=O({},s),s.infos=[...s.infos],Qi(s,t,i,!0)),a&&(a=O({},a),a.infos=[...a.infos]),i==="horizontal"&&(s?.infos.reverse(),a?.infos.reverse()),{sizeRampElement:s,colorRampElement:a}}function et(e,t="vertical"){let i=e.infos,r=i.find(({type:a})=>a==="size-ramp"),s=i.find(({type:a})=>a==="color-ramp");return r&&(r=O({},r),r.infos=[...r.infos],Qi(r,null,t,!1)),s&&(s=O({},s),s.infos=[...s.infos]),t==="horizontal"&&(r?.infos.reverse(),s?.infos.reverse()),{sizeRampElement:r,colorRampElement:s}}var Me={marginLeft:"3px"},ie={display:"table-cell",verticalAlign:"middle"},tt={display:"flex",alignItems:"flex-start"};var ye=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,effectList:i,key:r}=this,{sizeRampElement:s,colorRampElement:a}=Ye(e,t,"horizontal");if(!s)return null;let l=Ae(s,"full",!0,"horizontal"),c=J(s,"above",!0,"horizontal"),n=J(s,"below",!0,"horizontal"),p=12,h=this.messages?.previewColorRampAriaLabel,m=j(a,{width:c,height:p,rampAlignment:"horizontal",opacity:t,type:"above",effectList:i,ariaLabel:h}),_=j(a,{width:n,height:p,rampAlignment:"horizontal",opacity:t,type:"below",effectList:i,ariaLabel:h}),v=te(s,"card"),R=s.infos.map(I=>I.label),$=R.length-1,D=R.map((I,L)=>L===0||L===$?o("div",{key:L},I):null),P={display:"flex",flexDirection:"column"},f={display:"flex",flexDirection:"row"},b={marginTop:"3px",display:"flex"};Ue(this.container)?b.marginRight=`${v}px`:b.marginLeft=`${v}px`;let S={width:`${l}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return o("div",{class:u.layerRow,key:`${r}-container`,styles:P},o("div",{class:this.classes(u.symbolContainer,u.sizeRampHorizontal),styles:f},s.infos.map((I,L)=>o("div",{afterCreate:z,bind:I.preview,class:u.symbol,key:L}))),m?o("div",{class:u.univariateAboveAndBelowColorRamp,key:"color-ramp-preview",styles:b},o("div",{afterCreate:z,bind:m}),o("div",{afterCreate:z,bind:_})):null,o("div",{class:u.layerInfo},o("div",{class:u.rampLabelsContainer,styles:S},D)))}};d([y()],ye.prototype,"effectList",void 0),d([y()],ye.prototype,"legendElement",void 0),d([y()],ye.prototype,"messages",void 0),d([y()],ye.prototype,"opacity",void 0),ye=d([x("esri.widgets.Legend.styles.card.UnivariateAboveAndBelowRamp")],ye);var Zi=ye;var me=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,effectList:i,key:r}=this,{sizeRampElement:s,colorRampElement:a}=et(e,"horizontal");if(!s)return null;let l=Ae(s,"full",!1,"horizontal"),c=J(s,"full",!1,"horizontal"),n=j(a,{width:c,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:i,ariaLabel:this.messages?.previewColorRampAriaLabel}),p=te(s,"card"),h=s.infos.length-1,m=s.infos.map((D,P)=>P===0||P===h?o("div",{key:P},D.label):null),_={display:"flex",flexDirection:"column"},v={display:"flex",flexDirection:"row"},R={marginTop:"3px",display:"flex"};Ue(this.container)?R.marginRight=`${p}px`:R.marginLeft=`${p}px`;let $={width:`${l}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return o("div",{class:u.layerRow,key:`${r}-container`,styles:_},o("div",{class:this.classes(u.symbolContainer,u.sizeRampHorizontal),styles:v},s.infos.map((D,P)=>o("div",{afterCreate:z,bind:D.preview,class:u.symbol,key:P}))),o("div",{class:u.univariateAboveAndBelowColorRamp,key:"color-ramp-preview",styles:R},o("div",{afterCreate:z,bind:n})),o("div",{class:u.layerInfo},o("div",{class:u.rampLabelsContainer,styles:$},m)))}};d([y()],me.prototype,"effectList",void 0),d([y()],me.prototype,"legendElement",void 0),d([y()],me.prototype,"messages",void 0),d([y()],me.prototype,"opacity",void 0),me=d([x("esri.widgets.Legend.styles.card.UnivariateColorSizeRamp")],me);var Ki=me;var It,N=It=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.hasIndicators=!1,this.headingLevel=3,this.isChild=!1,this.legendElement=null}render(){let e=this._renderLegendElement(),t=Ke(this.legendElement,this.messages),i=this.hasIndicators&&!this.isChild?o("div",null,o(Ee,{class:u.carouselTitle,level:this.headingLevel},this.activeLayerInfo.title),o(Ee,{class:u.layerCaption,level:ri(this.headingLevel)},t)):t?o(Ee,{class:u.layerCaption,level:this.headingLevel},t):null;return o("section",{"aria-labelledby":this.key,class:u.section,id:`${this.key}-panel`,key:this.key,role:"tabpanel",tabIndex:0},i,e)}_renderLegendElement(){switch(this.legendElement.type){case"symbol-table":return this._renderSymbolTable(this.legendElement);case"size-ramp":return o(ji,{hasIndicators:this.hasIndicators,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case"color-ramp":case"opacity-ramp":case"heatmap-ramp":case"stretch-ramp":return o(Gi,{effectList:this.effectList,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case"relationship-ramp":return qe(this.legendElement,this.id,{opacity:this.layer.opacity,effectList:this.effectList,ariaLabel:this.messages.previewRelationshipRampAriaLabel,key:this.key});case"pie-chart-ramp":return o("div",{afterCreate:z,bind:this.legendElement.preview,class:u.pieChartRampPreview,key:`${this.key}-preview`});case"univariate-above-and-below-ramp":return o(Zi,{effectList:this.effectList,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case"univariate-color-size-ramp":return o(Ki,{effectList:this.effectList,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});default:return null}}_renderSymbolTable(e){let t=e.infos.map(a=>this._renderElementInfo(a,e.legendType)).filter(Boolean);if(!t.length)return null;let i=this.activeLayerInfo.legendElements.some(({type:a})=>a==="relationship-ramp"),r=t[0]?.properties?.classes?.[u.symbolRow],s={[u.labelContainer]:!r&&!i,[u.relationshipLabelContainer]:i};return o("div",{class:this.classes(s)},t)}_renderElementInfo(e,t){let{layer:i}=this,r="label"in e?e.label:null,s=`${this.key}-${r}`;if("type"in e&&e.type)return o(It,{activeLayerInfo:this.activeLayerInfo,effectList:this.effectList,hasIndicators:this.hasIndicators,headingLevel:this.headingLevel,isChild:!0,key:s,layer:i,legendElement:e,messages:this.messages});if(!("preview"in e&&e.preview||"src"in e&&e.src))return null;let a=Qe(i,t),l=G(this.messages,r,!1)||"";if("src"in e&&e.src)return o("div",{class:u.layerRow,key:`${s}-row`},this._renderImage(e,i,a),o("div",{class:u.imageLabel},l));if("symbol"in e&&e.preview){if(!e.symbol?.type.includes("simple-fill")){if(!e.label)return o("div",{afterCreate:z,bind:e.preview,key:`${s}-row`});let c={[u.symbolCell]:this.hasIndicators};return o("div",{class:this.classes(u.layerRow,{[u.symbolRow]:this.hasIndicators}),key:`${s}-row`},o("div",{afterCreate:z,bind:e.preview,class:this.classes(c)}),o("div",{class:this.classes(u.imageLabel,{[u.labelCell]:this.hasIndicators})},l))}return o("div",{class:u.layerRow,key:`${s}-row`},o("div",{class:u.labelElement,styles:this._getBackgroundStyles(e)},l))}return null}_getBackgroundStyles(e){let t=e.symbol,i=t.color,r=!!i?.a,s="outline"in t?t.outline:null,a=!!s?.color?.a,l=new ee(r&&i?[i.r,i.g,i.b,i.a*this.layer.opacity]:[255,255,255,0]),c=a&&s.color?new ee([s.color.r,s.color.g,s.color.b,s.color.a*this.layer.opacity]):new ee([255,255,255,0]),n=e.symbol.color?.isBright??!0,p=n?"black":"white",h=n?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)";return{background:r?l.toCss(!0):"none",color:p,textShadow:`-1px -1px 0 ${h},
                  1px -1px 0 ${h},
                  -1px 1px 0 ${h},
                  1px 1px 0 ${h}`,border:a?`1px solid ${c.toCss(!0)}`:"none",filter:We(this.effectList)??void 0}}_renderImage(e,t,i){let{label:r,src:s,opacity:a}=e,l={[u.imageryLayerStretchedImage]:i,[u.symbol]:!i},c={opacity:`${a??t.opacity}`},n=G(this.messages,r,!1);return o("img",{alt:n,"aria-label":n,border:0,class:this.classes(l),height:e.height,src:s,styles:c,width:e.width})}};d([y()],N.prototype,"activeLayerInfo",void 0),d([y()],N.prototype,"effectList",void 0),d([y()],N.prototype,"hasIndicators",void 0),d([y()],N.prototype,"headingLevel",void 0),d([y()],N.prototype,"isChild",void 0),d([y()],N.prototype,"layer",void 0),d([y()],N.prototype,"legendElement",void 0),d([y()],N.prototype,"messages",void 0),N=It=d([x("esri.widgets.Legend.styles.card.LegendElement")],N);var Rt=N;var ks=768,Q=class extends T{constructor(e,t){super(e,t),this._hasIndicators=!1,this.activeLayerInfos=null,this.headingLevel=3,this.layout="stack",this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}loadDependencies(){return Gt({carousel:()=>import("./chunk-F5CAASXI.js"),"carousel-item":()=>import("./chunk-WW5SO3E7.js")})}render(){this._hasIndicators=this.layout==="auto"&&this.view&&this.view.container.clientWidth<=ks||this.layout==="stack";let e=this._hasIndicators?this._renderCarousel():this._renderLayers(),t={[u.stacked]:this._hasIndicators};return o("div",{class:this.classes(u.base,t)},e||o("div",{class:u.message},this.messages.noLegend))}_renderCarousel(){let e=[],t=this.activeLayerInfos;if(t)for(let i of t)this._renderSections(i,e);return e?.length?o("calcite-carousel",{class:u.carousel,label:this.messages.carousel},e.map((i,r)=>o("calcite-carousel-item",{class:u.carouselItem,key:r,label:ae(this.messagesCommon.pagination.pageText,{index:r+1,total:e.length})},i))):null}_renderLayers(){let e=this.activeLayerInfos,t=e?.toArray()?.map(i=>this._renderLegendForLayer(i)).filter(Boolean);return t?.length?t:null}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){let t=e.children.toArray().map(this._renderLegendForLayer,this);return o("section",{class:this.classes(u.service,u.groupLayer),key:e.layer.uid},o("div",{class:u.serviceCaptionContainer},e.title),t)}return this._renderLegendElementsForLayer(e)}_renderLegendElementsForLayer(e){let t=e.legendElements?.filter(Boolean);if(!t?.length)return null;let i=t.map(s=>o(Rt,{activeLayerInfo:e,effectList:e.effectList,hasIndicators:this._hasIndicators,headingLevel:this.headingLevel,isChild:!1,key:`${e.layer.uid}-${s.type}`,layer:e.layer,legendElement:s,messages:this.messages})),r={[u.groupLayerChild]:!!e.parent};return o("section",{class:this.classes(u.service,r),key:e.layer.uid},o("div",{class:u.serviceCaptionContainer},o("div",{class:u.serviceCaptionText},e.title)),o("div",{class:u.serviceContent},i))}_renderSections(e,t){if(!e.ready)return;if(e.children.length)for(let r of e.children)this._renderSections(r,t);let i=e.legendElements;if(i?.length)for(let r of i){let s=o(Rt,{activeLayerInfo:e,effectList:e.effectList,hasIndicators:this._hasIndicators,headingLevel:this.headingLevel,isChild:!1,key:`${e.layer.uid}-${r.type}`,layer:e.layer,legendElement:r,messages:this.messages});s&&t.push(s)}}};d([y()],Q.prototype,"activeLayerInfos",void 0),d([y()],Q.prototype,"headingLevel",void 0),d([y()],Q.prototype,"layout",void 0),d([y(),le("esri/widgets/Legend/t9n/Legend")],Q.prototype,"messages",void 0),d([y(),le("esri/t9n/common")],Q.prototype,"messagesCommon",void 0),d([y({readOnly:!0})],Q.prototype,"type",void 0),d([y()],Q.prototype,"view",void 0),Q=d([x("esri.widgets.Legend.styles.card.CardView")],Q);var it=Q;var E="esri-legend",g={service:`${E}__service`,label:`${E}__service-label`,layer:`${E}__layer`,groupLayer:`${E}__group-layer`,groupLayerChild:`${E}__group-layer-child`,layerTable:`${E}__layer-table`,layerTableSizeRamp:`${E}__layer-table--size-ramp`,layerChildTable:`${E}__layer-child-table`,layerCaption:`${E}__layer-caption`,layerBody:`${E}__layer-body`,layerRow:`${E}__layer-row`,layerCell:`${E}__layer-cell`,layerInfo:`${E}__layer-cell ${E}__layer-cell--info`,imageryLayerStretchedImage:`${E}__imagery-layer-image--stretched`,imageryLayerCellStretched:`${E}__imagery-layer-cell--stretched`,imageryLayerInfoStretched:`${E}__imagery-layer-info--stretched`,symbolContainer:`${E}__layer-cell ${E}__layer-cell--symbols`,symbol:`${E}__symbol`,rampContainer:`${E}__ramps`,sizeRamp:`${E}__size-ramp`,colorRamp:`${E}__color-ramp`,opacityRamp:`${E}__opacity-ramp`,borderlessRamp:`${E}__borderless-ramp`,rampTick:`${E}__ramp-tick`,rampFirstTick:`${E}__ramp-tick-first`,rampLastTick:`${E}__ramp-tick-last`,rampLabelsContainer:`${E}__ramp-labels`,rampLabel:`${E}__ramp-label`,message:`${E}__message`,univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label"};var As=24,he=class extends T{constructor(e,t){super(e,t),this.legendElement=null,this.opacity=1}get _preview(){let e=this.legendElement.preview;if(!e)return null;let t=this.legendElement.type==="opacity-ramp"?g.opacityRamp:"";return e.className=`${g.colorRamp} ${t}`,this.opacity!=null&&(e.style.opacity=this.opacity.toString()),e}render(){let{legendElement:e,_preview:t}=this;if(!t)return null;let i={width:`${As}px`},r={height:t.style.height};return o("div",{class:g.layerRow,key:`${this.key}-row`},o("div",{class:g.symbolContainer,styles:i},o("div",{afterCreate:z,bind:t,class:g.rampContainer})),o("div",{class:g.layerInfo},o("div",{class:g.rampLabelsContainer,styles:r},e.infos.map((s,a)=>this._renderRampLabel(s,a,e.type)))))}_renderRampLabel(e,t,i){return o("div",{class:e.label?g.rampLabel:void 0,key:`${this.key}-stop-${e.label??t}-label`},Ze(e,i,this.messages))}};d([y()],he.prototype,"_preview",null),d([y()],he.prototype,"legendElement",void 0),d([y()],he.prototype,"messages",void 0),d([y()],he.prototype,"opacity",void 0),he=d([x("esri.widgets.Legend.styles.classic.ColorRamp")],he);var Xi=he;var Pe=class extends T{constructor(e,t){super(e,t),this.legendElement=null}render(){let e=this.legendElement.infos.map(t=>this._renderRow(t)).filter(Boolean);return e.length?o("div",{class:g.layerBody},e):null}_renderRow(e){return e.preview?o("div",{class:g.layerRow,key:`${this.key}-${e.label}-row`},o("div",{class:this.classes(g.symbolContainer,g.sizeRamp)},o("div",{afterCreate:z,bind:e.preview,class:g.symbol})),o("div",{class:g.layerInfo},G(this.messages,e.label,!1)||"")):null}};d([y()],Pe.prototype,"legendElement",void 0),d([y()],Pe.prototype,"messages",void 0),Pe=d([x("esri.widgets.Legend.styles.classic.SizeRamp")],Pe);var Yi=Pe;var ue=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,effectList:i,key:r}=this,{sizeRampElement:s,colorRampElement:a}=Ye(e,t);if(!s)return null;let l=this.messages.previewColorRampAriaLabel,c=J(s,"above",!0),n=J(s,"below",!0),p=12,h=j(a,{width:p,height:c,rampAlignment:"vertical",opacity:t,type:"above",effectList:i,ariaLabel:l}),m=j(a,{width:p,height:n,rampAlignment:"vertical",opacity:t,type:"below",effectList:i,ariaLabel:l}),_=te(s),v=s.infos.map(L=>L.label),R=v.map((L,F)=>F===0?o("div",{class:L?h?g.univariateAboveAndBelowLabel:g.rampLabel:void 0,key:`${r}-color-ramp-above-label-${L??F}`},L):F===2?o("div",null):null),$=v.length-1,D=Math.floor(v.length/2),P=v.map((L,F)=>F===D||F===$?o("div",{class:L?h?g.univariateAboveAndBelowLabel:g.rampLabel:void 0,key:`${r}-color-ramp-below-label-${L??F}`},L):null),f={display:"table-cell",verticalAlign:"middle"},b={marginTop:`${_}px`},S={height:`${c}px`},I={height:`${n}px`};return o("div",{key:`${r}-container`,styles:tt},o("div",{class:g.layerBody},s.infos.map((L,F)=>o("div",{class:this.classes(g.layerRow,g.sizeRamp),key:`${r}-row-${F}`},o("div",{afterCreate:z,bind:L.preview,class:g.symbol,styles:f}),h||F%2!=0?null:o("div",{class:g.layerInfo},v[F])))),h?o("div",{styles:b},o("div",{styles:Me},o("div",{styles:ie},o("div",{afterCreate:z,bind:h,class:g.rampContainer})),o("div",{styles:ie},o("div",{class:g.rampLabelsContainer,styles:S},R))),o("div",{styles:Me},o("div",{styles:ie},o("div",{afterCreate:z,bind:m,class:g.rampContainer})),o("div",{styles:ie},o("div",{class:g.rampLabelsContainer,styles:I},P)))):null)}};d([y()],ue.prototype,"effectList",void 0),d([y()],ue.prototype,"legendElement",void 0),d([y()],ue.prototype,"messages",void 0),d([y()],ue.prototype,"opacity",void 0),ue=d([x("esri.widgets.Legend.styles.classic.UnivariateAboveAndBelowRamp")],ue);var es=ue;var fe=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,effectList:i,key:r}=this,{sizeRampElement:s,colorRampElement:a}=et(e);if(!s)return null;let l=te(s),c=12,n=J(s,"full",!1),p=j(a,{width:c,height:n,rampAlignment:"vertical",opacity:t,type:"full",effectList:i,ariaLabel:this.messages?.previewColorRampAriaLabel}),h=s.infos.length-1,m=s.infos.map(($,D)=>D===0||D===h?o("div",{class:$.label?a?g.univariateAboveAndBelowLabel:g.rampLabel:void 0,key:`${r}-color-ramp-label-${$.label??D}`},$.label):null),_={display:"table-cell",verticalAlign:"middle"},v={marginTop:`${l}px`},R={height:`${n}px`};return o("div",{key:`${r}-container`,styles:tt},o("div",{class:g.layerBody},s.infos.map(($,D)=>o("div",{class:this.classes(g.layerRow,g.sizeRamp),key:`${r}-row-${D}`},o("div",{afterCreate:z,bind:$.preview,class:g.symbol,styles:_})))),o("div",{styles:v},o("div",{styles:Me},o("div",{styles:ie},o("div",{afterCreate:z,bind:p,class:g.rampContainer})),o("div",{styles:ie},o("div",{class:g.rampLabelsContainer,styles:R},m)))))}};d([y()],fe.prototype,"effectList",void 0),d([y()],fe.prototype,"legendElement",void 0),d([y()],fe.prototype,"messages",void 0),d([y()],fe.prototype,"opacity",void 0),fe=d([x("esri.widgets.Legend.styles.classic.UnivariateColorSizeRamp")],fe);var ts=fe;var xt,se=xt=class extends T{constructor(e,t){super(e,t),this.effectList=null,this.isChild=!1,this.legendElement=null}render(){let e=this._renderLegendElement(),t=Ke(this.legendElement,this.messages),i=this.isChild?g.layerChildTable:g.layerTable,r=t?o("div",{class:g.layerCaption},t):null,s={[g.layerTableSizeRamp]:this.legendElement.type==="size-ramp"||!this.isChild};return o("section",{class:this.classes(i,s),key:`${this.key}-table`},r,e)}_renderLegendElement(){switch(this.legendElement.type){case"symbol-table":return this._renderSymbolTable(this.legendElement);case"size-ramp":return o(Yi,{key:this.key,legendElement:this.legendElement,messages:this.messages});case"color-ramp":case"opacity-ramp":case"heatmap-ramp":case"stretch-ramp":return o(Xi,{key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case"relationship-ramp":return qe(this.legendElement,this.id,{opacity:this.layer.opacity,effectList:this.effectList,ariaLabel:this.messages.previewRelationshipRampAriaLabel,key:this.key});case"pie-chart-ramp":return o("div",{afterCreate:z,bind:this.legendElement.preview,key:`${this.key}-preview`});case"univariate-above-and-below-ramp":return o(es,{effectList:this.effectList,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case"univariate-color-size-ramp":return o(ts,{effectList:this.effectList,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});default:return null}}_renderSymbolTable(e){let t=e.infos.map(i=>this._renderElementInfo(i,e.legendType)).filter(Boolean);return t.length?o("div",{class:g.layerBody},t):null}_renderElementInfo(e,t){let{layer:i}=this,r="label"in e?e.label:null,s=`${this.key}-${r}`;if("type"in e&&e.type)return o(xt,{effectList:this.effectList,isChild:!0,key:s,layer:i,legendElement:e,messages:this.messages});if(!("preview"in e&&e.preview||"src"in e&&e.src))return null;let a=Qe(i,t),l={[g.imageryLayerInfoStretched]:a},c={[g.imageryLayerInfoStretched]:a};return o("div",{class:g.layerRow,key:`${s}-row`},o("div",{class:this.classes(g.symbolContainer,c)},this._renderPreview(e,a)),o("div",{class:this.classes(g.layerInfo,l)},G(this.messages,r,!1)||""))}_renderPreview(e,t){let{layer:i}=this;return"preview"in e&&e.preview?o("div",{afterCreate:z,bind:e.preview,class:g.symbol}):"src"in e&&e.src?this._renderImage(e,i,t):null}_renderImage(e,t,i){let{label:r,src:s,opacity:a}=e,l={[g.imageryLayerStretchedImage]:i,[g.symbol]:!i},c={opacity:`${a??t.opacity}`},n=G(this.messages,r,!1);return o("img",{alt:n,"aria-label":n,border:0,class:this.classes(l),height:e.height,src:s,styles:c,width:e.width})}};d([y()],se.prototype,"effectList",void 0),d([y()],se.prototype,"isChild",void 0),d([y()],se.prototype,"layer",void 0),d([y()],se.prototype,"legendElement",void 0),d([y()],se.prototype,"messages",void 0),se=xt=d([x("esri.widgets.Legend.styles.classic.LegendElement")],se);var is=se;var Ms=`${E}__`,ge=class extends T{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){let e=this.activeLayerInfos,t=e?.toArray().map(i=>this._renderLegendForLayer(i)).filter(Boolean);return t?.length?o("section",null,t):o("div",{class:g.message,key:"no-legend"},this.messages.noLegend)}_renderLegendForLayer(e,t){if(!e.ready)return null;let i=`${e.layer.uid}-version-${e.version}`,r=`${Ms}${t?`${t}-`:""}${i}`,s=e.title?Ee({level:this.headingLevel,class:this.classes(ke.heading,g.label)},e.title):null;if(e.children.length){let a=e.children.toArray().map(l=>this._renderLegendForLayer(l,i));return o("section",{class:this.classes(g.service,g.groupLayer),key:r},s,a)}return this._renderLegendElementsForLayer(e,s,r)}_renderLegendElementsForLayer(e,t,i){let r=e.legendElements?.filter(Boolean);if(!r?.length)return null;let s=r.map(l=>o(is,{effectList:e.effectList,isChild:!1,key:`${i}-${l.type}`,layer:e.layer,legendElement:l,messages:this.messages})),a={[g.groupLayerChild]:!!e.parent};return o("section",{class:this.classes(g.service,a),key:i},t,o("div",{class:g.layer},s))}};d([y()],ge.prototype,"activeLayerInfos",void 0),d([y()],ge.prototype,"headingLevel",void 0),d([y(),le("esri/widgets/Legend/t9n/Legend")],ge.prototype,"messages",void 0),d([y({readOnly:!0})],ge.prototype,"type",void 0),ge=d([x("esri.widgets.Legend.styles.classic.ClassicView")],ge);var be=ge;var Ps={base:"esri-legend"},M=class extends T{constructor(e,t){super(e,t),this.headingLevel=3,this.messages=null,this.style=new be,this.viewModel=new Wi}initialize(){this.addHandles([Se(()=>this.view,"resize",()=>this.scheduleRender()),Se(()=>this.activeLayerInfos,"change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),V(()=>this.headingLevel,e=>{let{style:t}=this;t&&(t.headingLevel=e)}),V(()=>this.style,(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)},W)])}get activeLayerInfos(){return this.viewModel.activeLayerInfos}set activeLayerInfos(e){this.viewModel.activeLayerInfos=e}get basemapLegendVisible(){return this.viewModel.basemapLegendVisible}set basemapLegendVisible(e){this.viewModel.basemapLegendVisible=e}get groundLegendVisible(){return this.viewModel.groundLegendVisible}set groundLegendVisible(e){this.viewModel.groundLegendVisible=e}get hideLayersNotInCurrentView(){return this.viewModel.hideLayersNotInCurrentView}set hideLayersNotInCurrentView(e){this.viewModel.hideLayersNotInCurrentView=e}get keepCacheOnDestroy(){return this.viewModel.keepCacheOnDestroy}set keepCacheOnDestroy(e){this.viewModel.keepCacheOnDestroy=e}get respectLayerDefinitionExpression(){return this.viewModel.respectLayerDefinitionExpression}set respectLayerDefinitionExpression(e){this.viewModel.respectLayerDefinitionExpression=e}get respectLayerVisibility(){return this.viewModel.respectLayerVisibility}set respectLayerVisibility(e){this.viewModel.respectLayerVisibility=e}get icon(){return"legend"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}castStyle(e){if(e instanceof it||e instanceof be)return e;if(typeof e=="string")return e==="card"?new it:new be;if(e&&typeof e.type=="string"){let t=O({},e);return delete t.type,e.type==="card"?new it(t):new be(t)}return new be}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){return o("div",{class:this.classes(Ps.base,ke.widget,this.style instanceof be?ke.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){e.forEach(t=>{this.removeHandles(`version_${t.layer.uid}`),this._renderOnActiveLayerInfoChange(t)}),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){let t=V(()=>e.version,()=>this.scheduleRender());this.addHandles(t,`version_${e.layer.uid}`);let i=Se(()=>e.children,"change",()=>e.children.forEach(r=>this._renderOnActiveLayerInfoChange(r)),W);this.addHandles(i,`version_${e.layer.uid}`),e.children.forEach(r=>this._renderOnActiveLayerInfoChange(r))}};d([y()],M.prototype,"activeLayerInfos",null),d([y()],M.prototype,"basemapLegendVisible",null),d([y()],M.prototype,"groundLegendVisible",null),d([y()],M.prototype,"headingLevel",void 0),d([y()],M.prototype,"hideLayersNotInCurrentView",null),d([y()],M.prototype,"keepCacheOnDestroy",null),d([y()],M.prototype,"respectLayerDefinitionExpression",null),d([y()],M.prototype,"respectLayerVisibility",null),d([y()],M.prototype,"icon",null),d([y()],M.prototype,"label",null),d([y()],M.prototype,"layerInfos",null),d([y(),le("esri/widgets/Legend/t9n/Legend")],M.prototype,"messages",void 0),d([y()],M.prototype,"style",void 0),d([Pt("style")],M.prototype,"castStyle",null),d([y()],M.prototype,"view",null),d([y()],M.prototype,"viewModel",void 0),M=d([x("esri.widgets.Legend")],M);var yc=M;export{yc as a};
